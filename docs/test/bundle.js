(()=>{var Ed=Object.create;var rn=Object.defineProperty;var Td=Object.getOwnPropertyDescriptor;var Ad=Object.getOwnPropertyNames;var Sd=Object.getPrototypeOf,Md=Object.prototype.hasOwnProperty;var ls=Math.pow;var hs=(r,e)=>()=>(r&&(e=r(r=0)),e);var $=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Rd=(r,e)=>{for(var t in e)rn(r,t,{get:e[t],enumerable:!0})},cs=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ad(e))!Md.call(r,n)&&n!==t&&rn(r,n,{get:()=>e[n],enumerable:!(i=Td(e,n))||i.enumerable});return r};var He=(r,e,t)=>(t=r!=null?Ed(Sd(r)):{},cs(e||!r||!r.__esModule?rn(t,"default",{value:r,enumerable:!0}):t,r)),xd=r=>cs(rn({},"__esModule",{value:!0}),r);var S,v=hs(()=>{S={}});var Co=$((M0,ds)=>{v();ds.exports=1e-6});var Io=$((R0,ps)=>{v();ps.exports=Cd;function Cd(){var r=new Float32Array(3);return r[0]=0,r[1]=0,r[2]=0,r}});var vs=$((x0,_s)=>{v();_s.exports=Id;function Id(r){var e=new Float32Array(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}});var Do=$((P0,ms)=>{v();ms.exports=Dd;function Dd(r,e,t){var i=new Float32Array(3);return i[0]=r,i[1]=e,i[2]=t,i}});var Oo=$((C0,gs)=>{v();gs.exports=Od;function Od(r,e){var t=e[0],i=e[1],n=e[2],o=t*t+i*i+n*n;return o>0&&(o=1/Math.sqrt(o),r[0]=e[0]*o,r[1]=e[1]*o,r[2]=e[2]*o),r}});var Fo=$((I0,ys)=>{v();ys.exports=Fd;function Fd(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}});var As=$((D0,Ts)=>{v();Ts.exports=Ld;var bs=Do(),Es=Oo(),wd=Fo();function Ld(r,e){var t=bs(r[0],r[1],r[2]),i=bs(e[0],e[1],e[2]);Es(t,t),Es(i,i);var n=wd(t,i);return n>1?0:Math.acos(n)}});var Ms=$((O0,Ss)=>{v();Ss.exports=Bd;function Bd(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r}});var xs=$((F0,Rs)=>{v();Rs.exports=Nd;function Nd(r,e,t,i){return r[0]=e,r[1]=t,r[2]=i,r}});var Cs=$((w0,Ps)=>{v();Ps.exports=Ud;var wo=Co();function Ud(r,e){var t=r[0],i=r[1],n=r[2],o=e[0],a=e[1],s=e[2];return Math.abs(t-o)<=wo*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(i-a)<=wo*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(n-s)<=wo*Math.max(1,Math.abs(n),Math.abs(s))}});var Ds=$((L0,Is)=>{v();Is.exports=kd;function kd(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}});var Fs=$((B0,Os)=>{v();Os.exports=Vd;function Vd(r,e,t){return r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r}});var Lo=$((N0,ws)=>{v();ws.exports=Wd;function Wd(r,e,t){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r}});var Bs=$((U0,Ls)=>{v();Ls.exports=Lo()});var Bo=$((k0,Ns)=>{v();Ns.exports=Gd;function Gd(r,e,t){return r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r}});var ks=$((V0,Us)=>{v();Us.exports=Bo()});var No=$((W0,Vs)=>{v();Vs.exports=zd;function zd(r,e,t){return r[0]=e[0]/t[0],r[1]=e[1]/t[1],r[2]=e[2]/t[2],r}});var Gs=$((G0,Ws)=>{v();Ws.exports=No()});var Xs=$((z0,zs)=>{v();zs.exports=Xd;function Xd(r,e,t){return r[0]=Math.min(e[0],t[0]),r[1]=Math.min(e[1],t[1]),r[2]=Math.min(e[2],t[2]),r}});var Ks=$((X0,Hs)=>{v();Hs.exports=Hd;function Hd(r,e,t){return r[0]=Math.max(e[0],t[0]),r[1]=Math.max(e[1],t[1]),r[2]=Math.max(e[2],t[2]),r}});var Ys=$((H0,js)=>{v();js.exports=Kd;function Kd(r,e){return r[0]=Math.floor(e[0]),r[1]=Math.floor(e[1]),r[2]=Math.floor(e[2]),r}});var Zs=$((K0,qs)=>{v();qs.exports=jd;function jd(r,e){return r[0]=Math.ceil(e[0]),r[1]=Math.ceil(e[1]),r[2]=Math.ceil(e[2]),r}});var Js=$((j0,Qs)=>{v();Qs.exports=Yd;function Yd(r,e){return r[0]=Math.round(e[0]),r[1]=Math.round(e[1]),r[2]=Math.round(e[2]),r}});var ef=$((Y0,$s)=>{v();$s.exports=qd;function qd(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}});var rf=$((q0,tf)=>{v();tf.exports=Zd;function Zd(r,e,t,i){return r[0]=e[0]+t[0]*i,r[1]=e[1]+t[1]*i,r[2]=e[2]+t[2]*i,r}});var Uo=$((Z0,nf)=>{v();nf.exports=Qd;function Qd(r,e){var t=e[0]-r[0],i=e[1]-r[1],n=e[2]-r[2];return Math.sqrt(t*t+i*i+n*n)}});var af=$((Q0,of)=>{v();of.exports=Uo()});var ko=$((J0,sf)=>{v();sf.exports=Jd;function Jd(r,e){var t=e[0]-r[0],i=e[1]-r[1],n=e[2]-r[2];return t*t+i*i+n*n}});var uf=$(($0,ff)=>{v();ff.exports=ko()});var Vo=$((eb,lf)=>{v();lf.exports=$d;function $d(r){var e=r[0],t=r[1],i=r[2];return Math.sqrt(e*e+t*t+i*i)}});var cf=$((tb,hf)=>{v();hf.exports=Vo()});var Wo=$((rb,df)=>{v();df.exports=ep;function ep(r){var e=r[0],t=r[1],i=r[2];return e*e+t*t+i*i}});var _f=$((ib,pf)=>{v();pf.exports=Wo()});var mf=$((nb,vf)=>{v();vf.exports=tp;function tp(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}});var yf=$((ob,gf)=>{v();gf.exports=rp;function rp(r,e){return r[0]=1/e[0],r[1]=1/e[1],r[2]=1/e[2],r}});var Ef=$((ab,bf)=>{v();bf.exports=ip;function ip(r,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],s=t[1],f=t[2];return r[0]=n*f-o*s,r[1]=o*a-i*f,r[2]=i*s-n*a,r}});var Af=$((sb,Tf)=>{v();Tf.exports=np;function np(r,e,t,i){var n=e[0],o=e[1],a=e[2];return r[0]=n+i*(t[0]-n),r[1]=o+i*(t[1]-o),r[2]=a+i*(t[2]-a),r}});var Mf=$((fb,Sf)=>{v();Sf.exports=op;function op(r,e){e=e||1;var t=Math.random()*2*Math.PI,i=Math.random()*2-1,n=Math.sqrt(1-i*i)*e;return r[0]=Math.cos(t)*n,r[1]=Math.sin(t)*n,r[2]=i*e,r}});var xf=$((ub,Rf)=>{v();Rf.exports=ap;function ap(r,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,r[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,r[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,r[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,r}});var Cf=$((lb,Pf)=>{v();Pf.exports=sp;function sp(r,e,t){var i=e[0],n=e[1],o=e[2];return r[0]=i*t[0]+n*t[3]+o*t[6],r[1]=i*t[1]+n*t[4]+o*t[7],r[2]=i*t[2]+n*t[5]+o*t[8],r}});var Df=$((hb,If)=>{v();If.exports=fp;function fp(r,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],s=t[1],f=t[2],u=t[3],l=u*i+s*o-f*n,h=u*n+f*i-a*o,c=u*o+a*n-s*i,p=-a*i-s*n-f*o;return r[0]=l*u+p*-a+h*-f-c*-s,r[1]=h*u+p*-s+c*-a-l*-f,r[2]=c*u+p*-f+l*-s-h*-a,r}});var Ff=$((cb,Of)=>{v();Of.exports=up;function up(r,e,t,i){var n=t[1],o=t[2],a=e[1]-n,s=e[2]-o,f=Math.sin(i),u=Math.cos(i);return r[0]=e[0],r[1]=n+a*u-s*f,r[2]=o+a*f+s*u,r}});var Lf=$((db,wf)=>{v();wf.exports=lp;function lp(r,e,t,i){var n=t[0],o=t[2],a=e[0]-n,s=e[2]-o,f=Math.sin(i),u=Math.cos(i);return r[0]=n+s*f+a*u,r[1]=e[1],r[2]=o+s*u-a*f,r}});var Nf=$((pb,Bf)=>{v();Bf.exports=hp;function hp(r,e,t,i){var n=t[0],o=t[1],a=e[0]-n,s=e[1]-o,f=Math.sin(i),u=Math.cos(i);return r[0]=n+a*u-s*f,r[1]=o+a*f+s*u,r[2]=e[2],r}});var kf=$((_b,Uf)=>{v();Uf.exports=cp;var ur=Io()();function cp(r,e,t,i,n,o){var a,s;for(e||(e=3),t||(t=0),i?s=Math.min(i*e+t,r.length):s=r.length,a=t;a<s;a+=e)ur[0]=r[a],ur[1]=r[a+1],ur[2]=r[a+2],n(ur,ur,o),r[a]=ur[0],r[a+1]=ur[1],r[a+2]=ur[2];return r}});var Tt=$((vb,Vf)=>{v();Vf.exports={EPSILON:Co(),create:Io(),clone:vs(),angle:As(),fromValues:Do(),copy:Ms(),set:xs(),equals:Cs(),exactEquals:Ds(),add:Fs(),subtract:Lo(),sub:Bs(),multiply:Bo(),mul:ks(),divide:No(),div:Gs(),min:Xs(),max:Ks(),floor:Ys(),ceil:Zs(),round:Js(),scale:ef(),scaleAndAdd:rf(),distance:Uo(),dist:af(),squaredDistance:ko(),sqrDist:uf(),length:Vo(),len:cf(),squaredLength:Wo(),sqrLen:_f(),negate:mf(),inverse:yf(),normalize:Oo(),dot:Fo(),cross:Ef(),lerp:Af(),random:Mf(),transformMat4:xf(),transformMat3:Cf(),transformQuat:Df(),rotateX:Ff(),rotateY:Lf(),rotateZ:Nf(),forEach:kf()}});var Gf=$((mb,Wf)=>{"use strict";v();function dp(r){for(var e=new Array(r),t=0;t<r;++t)e[t]=t;return e}Wf.exports=dp});var Hf=$((gb,Xf)=>{v();Xf.exports=function(r){return r!=null&&(zf(r)||pp(r)||!!r._isBuffer)};function zf(r){return!!r.constructor&&typeof r.constructor.isBuffer=="function"&&r.constructor.isBuffer(r)}function pp(r){return typeof r.readFloatLE=="function"&&typeof r.slice=="function"&&zf(r.slice(0,0))}});var on=$((yb,Kf)=>{v();var _p=Gf(),vp=Hf(),mp=typeof Float64Array!="undefined";function gp(r,e){return r[0]-e[0]}function yp(){var r=this.stride,e=new Array(r.length),t;for(t=0;t<e.length;++t)e[t]=[Math.abs(r[t]),t];e.sort(gp);var i=new Array(e.length);for(t=0;t<i.length;++t)i[t]=e[t][1];return i}function bp(r,e){var t=["View",e,"d",r].join("");e<0&&(t="View_Nil"+r);var i=r==="generic";if(e===-1){var n="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+r+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}",m=new Function(n);return m()}else if(e===0){var n="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+r+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(i?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(i?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}",m=new Function("TrivialArray",n);return m(nn[r][0])}var n=["'use strict'"],o=_p(e),a=o.map(function(_){return"i"+_}),s="this.offset+"+o.map(function(_){return"this.stride["+_+"]*i"+_}).join("+"),f=o.map(function(_){return"b"+_}).join(","),u=o.map(function(_){return"c"+_}).join(",");n.push("function "+t+"(a,"+f+","+u+",d){this.data=a","this.shape=["+f+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+r+"'","proto.dimension="+e),n.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+o.map(function(_){return"this.shape["+_+"]"}).join("*"),"}})"),e===1?n.push("proto.order=[0]"):(n.push("Object.defineProperty(proto,'order',{get:"),e<4?(n.push("function "+t+"_order(){"),e===2?n.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):e===3&&n.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):n.push("ORDER})")),n.push("proto.set=function "+t+"_set("+a.join(",")+",v){"),i?n.push("return this.data.set("+s+",v)}"):n.push("return this.data["+s+"]=v}"),n.push("proto.get=function "+t+"_get("+a.join(",")+"){"),i?n.push("return this.data.get("+s+")}"):n.push("return this.data["+s+"]}"),n.push("proto.index=function "+t+"_index(",a.join(),"){return "+s+"}"),n.push("proto.hi=function "+t+"_hi("+a.join(",")+"){return new "+t+"(this.data,"+o.map(function(_){return["(typeof i",_,"!=='number'||i",_,"<0)?this.shape[",_,"]:i",_,"|0"].join("")}).join(",")+","+o.map(function(_){return"this.stride["+_+"]"}).join(",")+",this.offset)}");var l=o.map(function(_){return"a"+_+"=this.shape["+_+"]"}),h=o.map(function(_){return"c"+_+"=this.stride["+_+"]"});n.push("proto.lo=function "+t+"_lo("+a.join(",")+"){var b=this.offset,d=0,"+l.join(",")+","+h.join(","));for(var c=0;c<e;++c)n.push("if(typeof i"+c+"==='number'&&i"+c+">=0){d=i"+c+"|0;b+=c"+c+"*d;a"+c+"-=d}");n.push("return new "+t+"(this.data,"+o.map(function(_){return"a"+_}).join(",")+","+o.map(function(_){return"c"+_}).join(",")+",b)}"),n.push("proto.step=function "+t+"_step("+a.join(",")+"){var "+o.map(function(_){return"a"+_+"=this.shape["+_+"]"}).join(",")+","+o.map(function(_){return"b"+_+"=this.stride["+_+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var c=0;c<e;++c)n.push("if(typeof i"+c+"==='number'){d=i"+c+"|0;if(d<0){c+=b"+c+"*(a"+c+"-1);a"+c+"=ceil(-a"+c+"/d)}else{a"+c+"=ceil(a"+c+"/d)}b"+c+"*=d}");n.push("return new "+t+"(this.data,"+o.map(function(_){return"a"+_}).join(",")+","+o.map(function(_){return"b"+_}).join(",")+",c)}");for(var p=new Array(e),d=new Array(e),c=0;c<e;++c)p[c]="a[i"+c+"]",d[c]="b[i"+c+"]";n.push("proto.transpose=function "+t+"_transpose("+a+"){"+a.map(function(_,y){return _+"=("+_+"===undefined?"+y+":"+_+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+p.join(",")+","+d.join(",")+",this.offset)}"),n.push("proto.pick=function "+t+"_pick("+a+"){var a=[],b=[],c=this.offset");for(var c=0;c<e;++c)n.push("if(typeof i"+c+"==='number'&&i"+c+">=0){c=(c+this.stride["+c+"]*i"+c+")|0}else{a.push(this.shape["+c+"]);b.push(this.stride["+c+"])}");n.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),n.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+o.map(function(_){return"shape["+_+"]"}).join(",")+","+o.map(function(_){return"stride["+_+"]"}).join(",")+",offset)}");var m=new Function("CTOR_LIST","ORDER",n.join(`
`));return m(nn[r],yp)}function Ep(r){if(vp(r))return"buffer";if(mp)switch(Object.prototype.toString.call(r)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(r)?"array":"generic"}var nn={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function Tp(r,e,t,i){if(r===void 0){var u=nn.array[0];return u([])}else typeof r=="number"&&(r=[r]);e===void 0&&(e=[r.length]);var n=e.length;if(t===void 0){t=new Array(n);for(var o=n-1,a=1;o>=0;--o)t[o]=a,a*=e[o]}if(i===void 0){i=0;for(var o=0;o<n;++o)t[o]<0&&(i-=(e[o]-1)*t[o])}for(var s=Ep(r),f=nn[s];f.length<=n+1;)f.push(bp(s,f.length-1));var u=f[n+1];return u(r,e,t,i)}Kf.exports=Tp});var Mi=$((bb,Go)=>{"use strict";v();var Xr=typeof Reflect=="object"?Reflect:null,jf=Xr&&typeof Xr.apply=="function"?Xr.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},an;Xr&&typeof Xr.ownKeys=="function"?an=Xr.ownKeys:Object.getOwnPropertySymbols?an=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:an=function(e){return Object.getOwnPropertyNames(e)};function Ap(r){console&&console.warn&&console.warn(r)}var qf=Number.isNaN||function(e){return e!==e};function Ce(){Ce.init.call(this)}Go.exports=Ce;Go.exports.once=xp;Ce.EventEmitter=Ce;Ce.prototype._events=void 0;Ce.prototype._eventsCount=0;Ce.prototype._maxListeners=void 0;var Yf=10;function sn(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(Ce,"defaultMaxListeners",{enumerable:!0,get:function(){return Yf},set:function(r){if(typeof r!="number"||r<0||qf(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Yf=r}});Ce.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Ce.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||qf(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Zf(r){return r._maxListeners===void 0?Ce.defaultMaxListeners:r._maxListeners}Ce.prototype.getMaxListeners=function(){return Zf(this)};Ce.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=e==="error",o=this._events;if(o!==void 0)n=n&&o.error===void 0;else if(!n)return!1;if(n){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var s=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw s.context=a,s}var f=o[e];if(f===void 0)return!1;if(typeof f=="function")jf(f,this,t);else for(var u=f.length,l=tu(f,u),i=0;i<u;++i)jf(l[i],this,t);return!0};function Qf(r,e,t,i){var n,o,a;if(sn(t),o=r._events,o===void 0?(o=r._events=Object.create(null),r._eventsCount=0):(o.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),o=r._events),a=o[e]),a===void 0)a=o[e]=t,++r._eventsCount;else if(typeof a=="function"?a=o[e]=i?[t,a]:[a,t]:i?a.unshift(t):a.push(t),n=Zf(r),n>0&&a.length>n&&!a.warned){a.warned=!0;var s=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");s.name="MaxListenersExceededWarning",s.emitter=r,s.type=e,s.count=a.length,Ap(s)}return r}Ce.prototype.addListener=function(e,t){return Qf(this,e,t,!1)};Ce.prototype.on=Ce.prototype.addListener;Ce.prototype.prependListener=function(e,t){return Qf(this,e,t,!0)};function Sp(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Jf(r,e,t){var i={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},n=Sp.bind(i);return n.listener=t,i.wrapFn=n,n}Ce.prototype.once=function(e,t){return sn(t),this.on(e,Jf(this,e,t)),this};Ce.prototype.prependOnceListener=function(e,t){return sn(t),this.prependListener(e,Jf(this,e,t)),this};Ce.prototype.removeListener=function(e,t){var i,n,o,a,s;if(sn(t),n=this._events,n===void 0)return this;if(i=n[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(o=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){s=i[a].listener,o=a;break}if(o<0)return this;o===0?i.shift():Mp(i,o),i.length===1&&(n[e]=i[0]),n.removeListener!==void 0&&this.emit("removeListener",e,s||t)}return this};Ce.prototype.off=Ce.prototype.removeListener;Ce.prototype.removeAllListeners=function(e){var t,i,n;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var o=Object.keys(i),a;for(n=0;n<o.length;++n)a=o[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function $f(r,e,t){var i=r._events;if(i===void 0)return[];var n=i[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?Rp(n):tu(n,n.length)}Ce.prototype.listeners=function(e){return $f(this,e,!0)};Ce.prototype.rawListeners=function(e){return $f(this,e,!1)};Ce.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):eu.call(r,e)};Ce.prototype.listenerCount=eu;function eu(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}Ce.prototype.eventNames=function(){return this._eventsCount>0?an(this._events):[]};function tu(r,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=r[i];return t}function Mp(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Rp(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function xp(r,e){return new Promise(function(t,i){function n(a){r.removeListener(e,o),i(a)}function o(){typeof r.removeListener=="function"&&r.removeListener("error",n),t([].slice.call(arguments))}ru(r,e,o,{once:!0}),e!=="error"&&Pp(r,n,{once:!0})})}function Pp(r,e,t){typeof r.on=="function"&&ru(r,"error",e,t)}function ru(r,e,t,i){if(typeof r.on=="function")i.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function n(o){i.once&&r.removeEventListener(e,n),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var nu=$((Eb,iu)=>{"use strict";v();function Cp(r,e,t,i,n,o,a,s,f,u){for(var l=0,h=Math.floor,c=h(e)|0,p=h(t)|0,d=h(i)|0,m=n>0?1:-1,_=o>0?1:-1,y=a>0?1:-1,g=Math.abs(1/n),T=Math.abs(1/o),A=Math.abs(1/a),M=m>0?c+1-e:e-c,C=_>0?p+1-t:t-p,P=y>0?d+1-i:i-d,R=g<1/0?g*M:1/0,F=T<1/0?T*C:1/0,I=A<1/0?A*P:1/0,D=-1;l<=s;){var V=r(c,p,d);if(V)return f&&(f[0]=e+l*n,f[1]=t+l*o,f[2]=i+l*a),u&&(u[0]=u[1]=u[2]=0,D===0&&(u[0]=-m),D===1&&(u[1]=-_),D===2&&(u[2]=-y)),V;R<F?R<I?(c+=m,l=R,R+=g,D=0):(d+=y,l=I,I+=A,D=2):F<I?(p+=_,l=F,F+=T,D=1):(d+=y,l=I,I+=A,D=2)}return f&&(f[0]=e+l*n,f[1]=t+l*o,f[2]=i+l*a),u&&(u[0]=u[1]=u[2]=0),0}function Ip(r,e,t,i,n,o){var a=+e[0],s=+e[1],f=+e[2],u=+t[0],l=+t[1],h=+t[2],c=Math.sqrt(u*u+l*l+h*h);if(c===0)throw new Error("Can't raycast along a zero vector");return u/=c,l/=c,h/=c,typeof i=="undefined"?i=64:i=+i,Cp(r,a,s,f,u,l,h,i,n,o)}iu.exports=Ip});var dn=$((Ib,cu)=>{v();cu.exports=Hr;var et=Tt();function Hr(r,e){if(!(this instanceof Hr))return new Hr(r,e);var t=et.create();et.add(t,r,e),this.base=et.min(et.create(),r,t),this.vec=et.clone(e),this.max=et.max(et.create(),r,t),this.mag=et.length(this.vec)}var jp=Hr,dt=jp.prototype;dt.width=function(){return this.vec[0]};dt.height=function(){return this.vec[1]};dt.depth=function(){return this.vec[2]};dt.x0=function(){return this.base[0]};dt.y0=function(){return this.base[1]};dt.z0=function(){return this.base[2]};dt.x1=function(){return this.max[0]};dt.y1=function(){return this.max[1]};dt.z1=function(){return this.max[2]};dt.translate=function(r){return et.add(this.max,this.max,r),et.add(this.base,this.base,r),this};dt.setPosition=function(r){return et.add(this.max,r,this.vec),et.copy(this.base,r),this};dt.expand=function(r){var e=et.create(),t=et.create();return et.max(e,r.max,this.max),et.min(t,r.base,this.base),et.subtract(e,e,t),new Hr(t,e)};dt.intersects=function(r){return!(r.base[0]>this.max[0]||r.base[1]>this.max[1]||r.base[2]>this.max[2]||r.max[0]<this.base[0]||r.max[1]<this.base[1]||r.max[2]<this.base[2])};dt.touches=function(r){var e=this.union(r);return e!==null&&(e.width()==0||e.height()==0||e.depth()==0)};dt.union=function(r){if(!this.intersects(r))return null;var e=Math.max(r.base[0],this.base[0]),t=Math.max(r.base[1],this.base[1]),i=Math.max(r.base[2],this.base[2]),n=Math.min(r.max[0],this.max[0]),o=Math.min(r.max[1],this.max[1]),a=Math.min(r.max[2],this.max[2]);return new Hr([e,t,i],[n-e,o-t,a-i])}});var Ko=$((Db,du)=>{"use strict";v();var Yp=[],qp=[],Zp=[],Qp=[],Jp=[],$p=[],e_=[],t_=[],r_=[],i_=[],n_=[],o_=[];function a_(r,e,t,i,n,o){var a=Yp,s=qp,f=Zp,u=Qp,l=Jp,h=$p,c=t_,p=Math.floor,d=0,m=0,_=0,y=0,g=0;if(A(),_===0)return 0;for(y=P();m<=_;){if(M(y)){var T=C();if(T)return d}y=P()}for(d+=_,g=0;g<3;g++)i[g]+=t[g],n[g]+=t[g];return d;function A(){if(m=0,_=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),_!==0)for(var I=0;I<3;I++){var D=t[I]>=0;u[I]=D?1:-1;var V=D?n[I]:i[I];a[I]=D?i[I]:n[I],s[I]=R(V,u[I]),f[I]=F(a[I],u[I]),c[I]=t[I]/_,l[I]=Math.abs(1/c[I]);var k=D?s[I]+1-V:V-s[I];h[I]=l[I]<1/0?l[I]*k:1/0}}function M(I){for(var D=u[0],V=I===0?s[0]:f[0],k=s[0]+D,w=u[1],G=I===1?s[1]:f[1],K=s[1]+w,j=u[2],W=I===2?s[2]:f[2],z=s[2]+j,oe=V;oe!=k;oe+=D)for(var be=G;be!=K;be+=w)for(var Pe=W;Pe!=z;Pe+=j)if(r(oe,be,Pe))return!0;return!1}function C(){d+=m;var I=u[y],D=m/_,V=n_;for(g=0;g<3;g++){var k=t[g]*D;i[g]+=k,n[g]+=k,V[g]=t[g]-k}I>0?n[y]=Math.round(n[y]):i[y]=Math.round(i[y]);var w=e(d,y,I,V);if(w)return!0;for(g=0;g<3;g++)t[g]=V[g];return A(),_===0}function P(){var I=h[0]<h[1]?h[0]<h[2]?0:2:h[1]<h[2]?1:2,D=h[I]-m;for(m=h[I],s[I]+=u[I],h[I]+=l[I],g=0;g<3;g++)a[g]+=D*c[g],f[g]=F(a[g],u[g]);return I}function R(I,D){return p(I-D*o)}function F(I,D){return p(I+D*o)}}function s_(r,e,t,i,n,o){for(var a=e_,s=r_,f=i_,u=o_,l=0;l<3;l++)a[l]=+t[l],f[l]=+e.max[l],s[l]=+e.base[l];o||(o=1e-10);var h=a_(r,i,a,s,f,o);if(!n){for(l=0;l<3;l++)u[l]=t[l]>0?f[l]-e.max[l]:s[l]-e.base[l];e.translate(u)}return h}du.exports=s_});var mu=$((wb,vu)=>{v();vu.exports=class{constructor(){this.list=[],this.hash={},this._map={},this._pendingRemovals=[]}add(e,t){if(typeof this._map[e]=="number"){var i=this._map[e];this.hash[e]=t,this.list[i]=t}else this._map[e]=this.list.length,this.hash[e]=t,this.list.push(t)}remove(e){var t=this._map[e];this.hash[e]=null,this.list[t]=null,this._pendingRemovals.push(e)}dispose(){this.list=null,this.hash=null,this._map=null,this._pendingRemovals.length=0}flush(){for(var e=0;e<this._pendingRemovals.length;e++){var t=this._pendingRemovals[e];this.hash[t]===null&&c_(this,t)}this._pendingRemovals.length=0}};function c_(r,e){var t=r._map[e];if(delete r.hash[e],delete r._map[e],t===r.list.length-1)r.list.pop();else{var i=r.list.pop();if(r.list[t]=i,i===null||i[0]===null){var n=r.list.length;for(var o in r._map)if(r._map[o]===n){r._map[o]=t;return}}else{var a=i.__id||i[0].__id;r._map[a]=t}}}});var yu=$((Lb,gu)=>{v();gu.exports=p_;var d_=mu();function p_(){var r=this;this.components={},this.comps=this.components;var e=this.components,t=1,i={},n=[],o=[],a={timeout:!1,removals:[],multiComps:[]};this._storage=i,this._systems=n,this._renderSystems=o,this.createEntity=function(d){var m=t++;return Array.isArray(d)&&d.forEach(_=>r.addComponent(m,_)),m},this.deleteEntity=function(d){return Object.keys(i).forEach(m=>{var _=i[m];_.hash[d]&&s(d,m)}),r},this.createComponent=function(d){if(!d)throw"Missing component definition";var m=d.name;if(!m)throw"Component definition must have a name property.";if(typeof m!="string")throw"Component name must be a string.";if(m==="")throw"Component name must be a non-empty string.";if(i[m])throw`Component ${m} already exists.`;var _={};return _.name=m,_.multi=!!d.multi,_.order=isNaN(d.order)?99:d.order,_.state=d.state||{},_.onAdd=d.onAdd||null,_.onRemove=d.onRemove||null,_.system=d.system||null,_.renderSystem=d.renderSystem||null,e[m]=_,i[m]=new d_,i[m]._pendingMultiCleanup=!1,i[m]._multiCleanupIDs=_.multi?[]:null,_.system&&(n.push(m),n.sort((y,g)=>e[y].order-e[g].order)),_.renderSystem&&(o.push(m),o.sort((y,g)=>e[y].order-e[g].order)),m},this.deleteComponent=function(d){var m=i[d];if(!m)throw`Unknown component: ${d}`;m.flush(),m.list.forEach(g=>{if(!!g){var T=g.__id||g[0].__id;s(T,d)}});var _=n.indexOf(d),y=o.indexOf(d);return _>-1&&n.splice(_,1),y>-1&&o.splice(y,1),i[d].dispose(),delete i[d],delete e[d],r},this.addComponent=function(d,m,_){var y=e[m],g=i[m];if(!g)throw`Unknown component: ${m}.`;if(g.hash[d]&&!y.multi)throw`Entity ${d} already has component: ${m}.`;var T=Object.assign({},{__id:d},y.state,_);if(T.__id=d,y.multi){var A=g.hash[d];A||(A=[],g.add(d,A)),A.push(T)}else g.add(d,T);return y.onAdd&&y.onAdd(d,T),this},this.hasComponent=function(d,m){var _=i[m];if(!_)throw`Unknown component: ${m}.`;return!!_.hash[d]},this.removeComponent=function(d,m){var _=i[m];if(!_)throw`Unknown component: ${m}.`;return s(d,m),r},this.getState=function(d,m){var _=i[m];if(!_)throw`Unknown component: ${m}.`;return _.hash[d]},this.getStatesList=function(d){var m=i[d];if(!m)throw`Unknown component: ${d}.`;return h(m),m.list},this.getStateAccessor=function(d){if(!i[d])throw`Unknown component: ${d}.`;var m=i[d].hash;return _=>m[_]},this.getComponentAccessor=function(d){if(!i[d])throw`Unknown component: ${d}.`;var m=i[d].hash;return _=>!!m[_]},this.tick=function(d){h();for(var m=0;m<n.length;m++){var _=n[m],y=e[_],g=i[_];y.system(d,g.list),h()}return r},this.render=function(d){h();for(var m=0;m<o.length;m++){var _=o[m],y=e[_],g=i[_];y.renderSystem(d,g.list),h()}return r},this.removeMultiComponent=function(d,m,_){var y=e[m],g=i[m];if(!g)throw`Unknown component: ${m}.`;if(!y.multi)throw"removeMultiComponent called on non-multi component";return f(d,y,g,_),r};function s(d,m){var _=e[m],y=i[m],g=y.hash[d];!g||(y.remove(d),_.onRemove&&(_.multi?(g.forEach(T=>{T&&_.onRemove(d,T)}),g.length=0):_.onRemove(d,g)),a.removals.push(y),u())}function f(d,m,_,y){var g=_.hash[d];if(!!g){var T=g[y];!T||(g[y]=null,m.onRemove&&m.onRemove(d,T),a.multiComps.push({entID:d,data:_}),u())}}function u(){a.timeout||(a.timeout=!0,setTimeout(l,1))}function l(){a.timeout=!1,h()}function h(){a.multiComps.length&&c(a.multiComps),a.removals.length&&p(a.removals)}function c(d){for(var m=0;m<d.length;m++){var{entID:_,data:y}=d[m],g=y.hash[_];if(!!g){for(var T=0;T<g.length;T++)g[T]||(g.splice(T,1),T--);g.length===0&&(y.remove(_),a.removals.push(y))}}d.length=0}function p(d){for(var m=0;m<d.length;m++){var _=d[m];_.flush()}d.length=0}}});var mn=$(ke=>{"use strict";v();var Qo=32;ke.INT_BITS=Qo;ke.INT_MAX=2147483647;ke.INT_MIN=-1<<Qo-1;ke.sign=function(r){return(r>0)-(r<0)};ke.abs=function(r){var e=r>>Qo-1;return(r^e)-e};ke.min=function(r,e){return e^(r^e)&-(r<e)};ke.max=function(r,e){return r^(r^e)&-(r<e)};ke.isPow2=function(r){return!(r&r-1)&&!!r};ke.log2=function(r){var e,t;return e=(r>65535)<<4,r>>>=e,t=(r>255)<<3,r>>>=t,e|=t,t=(r>15)<<2,r>>>=t,e|=t,t=(r>3)<<1,r>>>=t,e|=t,e|r>>1};ke.log10=function(r){return r>=1e9?9:r>=1e8?8:r>=1e7?7:r>=1e6?6:r>=1e5?5:r>=1e4?4:r>=1e3?3:r>=100?2:r>=10?1:0};ke.popCount=function(r){return r=r-(r>>>1&1431655765),r=(r&858993459)+(r>>>2&858993459),(r+(r>>>4)&252645135)*16843009>>>24};function Su(r){var e=32;return r&=-r,r&&e--,r&65535&&(e-=16),r&16711935&&(e-=8),r&252645135&&(e-=4),r&858993459&&(e-=2),r&1431655765&&(e-=1),e}ke.countTrailingZeros=Su;ke.nextPow2=function(r){return r+=r===0,--r,r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r+1};ke.prevPow2=function(r){return r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r-(r>>>1)};ke.parity=function(r){return r^=r>>>16,r^=r>>>8,r^=r>>>4,r&=15,27030>>>r&1};var Pi=new Array(256);(function(r){for(var e=0;e<256;++e){var t=e,i=e,n=7;for(t>>>=1;t;t>>>=1)i<<=1,i|=t&1,--n;r[e]=i<<n&255}})(Pi);ke.reverse=function(r){return Pi[r&255]<<24|Pi[r>>>8&255]<<16|Pi[r>>>16&255]<<8|Pi[r>>>24&255]};ke.interleave2=function(r,e){return r&=65535,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,r|e<<1};ke.deinterleave2=function(r,e){return r=r>>>e&1431655765,r=(r|r>>>1)&858993459,r=(r|r>>>2)&252645135,r=(r|r>>>4)&16711935,r=(r|r>>>16)&65535,r<<16>>16};ke.interleave3=function(r,e,t){return r&=1023,r=(r|r<<16)&4278190335,r=(r|r<<8)&251719695,r=(r|r<<4)&3272356035,r=(r|r<<2)&1227133513,e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,r|=e<<1,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,r|t<<2};ke.deinterleave3=function(r,e){return r=r>>>e&1227133513,r=(r|r>>>2)&3272356035,r=(r|r>>>4)&251719695,r=(r|r>>>8)&4278190335,r=(r|r>>>16)&1023,r<<22>>22};ke.nextCombination=function(r){var e=r|r-1;return e+1|(~e&-~e)-1>>>Su(r)+1}});var xu=$((kb,Ru)=>{"use strict";v();function Mu(r,e,t){var i=r[t]|0;if(i<=0)return[];var n=new Array(i),o;if(t===r.length-1)for(o=0;o<i;++o)n[o]=e;else for(o=0;o<i;++o)n[o]=Mu(r,e,t+1);return n}function __(r,e){var t,i;for(t=new Array(r),i=0;i<r;++i)t[i]=e;return t}function v_(r,e){switch(typeof e=="undefined"&&(e=0),typeof r){case"number":if(r>0)return __(r|0,e);break;case"object":if(typeof r.length=="number")return Mu(r,e,0);break}return[]}Ru.exports=v_});var Cu=$((Vb,Pu)=>{v();Pu.exports=function(e){return e!=null&&e.constructor!=null&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}});var yn=$(Se=>{"use strict";v();var jr=mn(),Rt=xu(),m_=Cu();S.__TYPEDARRAY_POOL||(S.__TYPEDARRAY_POOL={UINT8:Rt([32,0]),UINT16:Rt([32,0]),UINT32:Rt([32,0]),INT8:Rt([32,0]),INT16:Rt([32,0]),INT32:Rt([32,0]),FLOAT:Rt([32,0]),DOUBLE:Rt([32,0]),DATA:Rt([32,0]),UINT8C:Rt([32,0]),BUFFER:Rt([32,0])});var g_=typeof Uint8ClampedArray!="undefined",_t=S.__TYPEDARRAY_POOL;_t.UINT8C||(_t.UINT8C=Rt([32,0]));_t.BUFFER||(_t.BUFFER=Rt([32,0]));var gn=_t.DATA,Jo=_t.BUFFER;Se.free=function(e){if(m_(e))Jo[jr.log2(e.length)].push(e);else{if(Object.prototype.toString.call(e)!=="[object ArrayBuffer]"&&(e=e.buffer),!e)return;var t=e.length||e.byteLength,i=jr.log2(t)|0;gn[i].push(e)}};function Iu(r){if(!!r){var e=r.length||r.byteLength,t=jr.log2(e);gn[t].push(r)}}function y_(r){Iu(r.buffer)}Se.freeUint8=Se.freeUint16=Se.freeUint32=Se.freeInt8=Se.freeInt16=Se.freeInt32=Se.freeFloat32=Se.freeFloat=Se.freeFloat64=Se.freeDouble=Se.freeUint8Clamped=Se.freeDataView=y_;Se.freeArrayBuffer=Iu;Se.freeBuffer=function(e){Jo[jr.log2(e.length)].push(e)};Se.malloc=function(e,t){if(t===void 0||t==="arraybuffer")return Ct(e);switch(t){case"uint8":return $o(e);case"uint16":return Du(e);case"uint32":return Ou(e);case"int8":return Fu(e);case"int16":return wu(e);case"int32":return Lu(e);case"float":case"float32":return Bu(e);case"double":case"float64":return Nu(e);case"uint8_clamped":return Uu(e);case"buffer":throw"Buffer not supported";case"data":case"dataview":return ku(e);default:return null}return null};function Ct(e){var e=jr.nextPow2(e),t=jr.log2(e),i=gn[t];return i.length>0?i.pop():new ArrayBuffer(e)}Se.mallocArrayBuffer=Ct;function $o(r){return new Uint8Array(Ct(r),0,r)}Se.mallocUint8=$o;function Du(r){return new Uint16Array(Ct(2*r),0,r)}Se.mallocUint16=Du;function Ou(r){return new Uint32Array(Ct(4*r),0,r)}Se.mallocUint32=Ou;function Fu(r){return new Int8Array(Ct(r),0,r)}Se.mallocInt8=Fu;function wu(r){return new Int16Array(Ct(2*r),0,r)}Se.mallocInt16=wu;function Lu(r){return new Int32Array(Ct(4*r),0,r)}Se.mallocInt32=Lu;function Bu(r){return new Float32Array(Ct(4*r),0,r)}Se.mallocFloat32=Se.mallocFloat=Bu;function Nu(r){return new Float64Array(Ct(8*r),0,r)}Se.mallocFloat64=Se.mallocDouble=Nu;function Uu(r){return g_?new Uint8ClampedArray(Ct(r),0,r):$o(r)}Se.mallocUint8Clamped=Uu;function ku(r){return new DataView(Ct(r),0,r)}Se.mallocDataView=ku;Se.clearCache=function(){for(var e=0;e<32;++e)_t.UINT8[e].length=0,_t.UINT16[e].length=0,_t.UINT32[e].length=0,_t.INT8[e].length=0,_t.INT16[e].length=0,_t.INT32[e].length=0,_t.FLOAT[e].length=0,_t.DOUBLE[e].length=0,_t.UINT8C[e].length=0,gn[e].length=0,Jo[e].length=0}});var Xu=$((Gb,zu)=>{"use strict";v();zu.exports=b_;var En=32;function b_(r,e){e<=4*En?Tn(0,e-1,r):An(0,e-1,r)}function Tn(r,e,t){for(var i=2*(r+1),n=r+1;n<=e;++n){for(var o=t[i++],a=t[i++],s=n,f=i-2;s-- >r;){var u=t[f-2],l=t[f-1];if(u<o)break;if(u===o&&l<a)break;t[f]=u,t[f+1]=l,f-=2}t[f]=o,t[f+1]=a}}function Vu(r,e,t){r*=2,e*=2;var i=t[r],n=t[r+1];t[r]=t[e],t[r+1]=t[e+1],t[e]=i,t[e+1]=n}function Wu(r,e,t){r*=2,e*=2,t[r]=t[e],t[r+1]=t[e+1]}function E_(r,e,t,i){r*=2,e*=2,t*=2;var n=i[r],o=i[r+1];i[r]=i[e],i[r+1]=i[e+1],i[e]=i[t],i[e+1]=i[t+1],i[t]=n,i[t+1]=o}function Gu(r,e,t,i,n){r*=2,e*=2,n[r]=n[e],n[e]=t,n[r+1]=n[e+1],n[e+1]=i}function Qt(r,e,t){r*=2,e*=2;var i=t[r],n=t[e];return i<n?!1:i===n?t[r+1]>t[e+1]:!0}function bn(r,e,t,i){r*=2;var n=i[r];return n<e?!0:n===e?i[r+1]<t:!1}function An(r,e,t){var i=(e-r+1)/6|0,n=r+i,o=e-i,a=r+e>>1,s=a-i,f=a+i,u=n,l=s,h=a,c=f,p=o,d=r+1,m=e-1,_=0;Qt(u,l,t)&&(_=u,u=l,l=_),Qt(c,p,t)&&(_=c,c=p,p=_),Qt(u,h,t)&&(_=u,u=h,h=_),Qt(l,h,t)&&(_=l,l=h,h=_),Qt(u,c,t)&&(_=u,u=c,c=_),Qt(h,c,t)&&(_=h,h=c,c=_),Qt(l,p,t)&&(_=l,l=p,p=_),Qt(l,h,t)&&(_=l,l=h,h=_),Qt(c,p,t)&&(_=c,c=p,p=_);for(var y=t[2*l],g=t[2*l+1],T=t[2*c],A=t[2*c+1],M=2*u,C=2*h,P=2*p,R=2*n,F=2*a,I=2*o,D=0;D<2;++D){var V=t[M+D],k=t[C+D],w=t[P+D];t[R+D]=V,t[F+D]=k,t[I+D]=w}Wu(s,r,t),Wu(f,e,t);for(var G=d;G<=m;++G)if(bn(G,y,g,t))G!==d&&Vu(G,d,t),++d;else if(!bn(G,T,A,t))for(;;)if(bn(m,T,A,t)){bn(m,y,g,t)?(E_(G,d,m,t),++d,--m):(Vu(G,m,t),--m);break}else{if(--m<G)break;continue}Gu(r,d-1,y,g,t),Gu(e,m+1,T,A,t),d-2-r<=En?Tn(r,d-2,t):An(r,d-2,t),e-(m+2)<=En?Tn(m+2,e,t):An(m+2,e,t),m-d<=En?Tn(d,m,t):An(d,m,t)}});var ea=$((zb,Hu)=>{"use strict";v();Hu.exports={init:A_,sweepBipartite:S_,sweepComplete:M_,scanBipartite:R_,scanComplete:x_};var We=yn(),T_=mn(),Sn=Xu(),xt=1<<28,Sr=1024,tt=We.mallocInt32(Sr),Jt=We.mallocInt32(Sr),$t=We.mallocInt32(Sr),Ar=We.mallocInt32(Sr),Yr=We.mallocInt32(Sr),Ci=We.mallocInt32(Sr),ce=We.mallocDouble(Sr*8);function A_(r){var e=T_.nextPow2(r);tt.length<e&&(We.free(tt),tt=We.mallocInt32(e)),Jt.length<e&&(We.free(Jt),Jt=We.mallocInt32(e)),$t.length<e&&(We.free($t),$t=We.mallocInt32(e)),Ar.length<e&&(We.free(Ar),Ar=We.mallocInt32(e)),Yr.length<e&&(We.free(Yr),Yr=We.mallocInt32(e)),Ci.length<e&&(We.free(Ci),Ci=We.mallocInt32(e));var t=8*e;ce.length<t&&(We.free(ce),ce=We.mallocDouble(t))}function qr(r,e,t,i){var n=e[i],o=r[t-1];r[n]=o,e[o]=n}function Zr(r,e,t,i){r[t]=i,e[i]=t}function S_(r,e,t,i,n,o,a,s,f,u){for(var l=0,h=2*r,c=r-1,p=h-1,d=t;d<i;++d){var m=o[d],_=h*d;ce[l++]=n[_+c],ce[l++]=-(m+1),ce[l++]=n[_+p],ce[l++]=m}for(var d=a;d<s;++d){var m=u[d]+xt,y=h*d;ce[l++]=f[y+c],ce[l++]=-m,ce[l++]=f[y+p],ce[l++]=m}var g=l>>>1;Sn(ce,g);for(var T=0,A=0,d=0;d<g;++d){var M=ce[2*d+1]|0;if(M>=xt)M=M-xt|0,qr($t,Ar,A--,M);else if(M>=0)qr(tt,Jt,T--,M);else if(M<=-xt){M=-M-xt|0;for(var C=0;C<T;++C){var P=e(tt[C],M);if(P!==void 0)return P}Zr($t,Ar,A++,M)}else{M=-M-1|0;for(var C=0;C<A;++C){var P=e(M,$t[C]);if(P!==void 0)return P}Zr(tt,Jt,T++,M)}}}function M_(r,e,t,i,n,o,a,s,f,u){for(var l=0,h=2*r,c=r-1,p=h-1,d=t;d<i;++d){var m=o[d]+1<<1,_=h*d;ce[l++]=n[_+c],ce[l++]=-m,ce[l++]=n[_+p],ce[l++]=m}for(var d=a;d<s;++d){var m=u[d]+1<<1,y=h*d;ce[l++]=f[y+c],ce[l++]=-m|1,ce[l++]=f[y+p],ce[l++]=m|1}var g=l>>>1;Sn(ce,g);for(var T=0,A=0,M=0,d=0;d<g;++d){var C=ce[2*d+1]|0,P=C&1;if(d<g-1&&C>>1===ce[2*d+3]>>1&&(P=2,d+=1),C<0){for(var R=-(C>>1)-1,F=0;F<M;++F){var I=e(Yr[F],R);if(I!==void 0)return I}if(P!==0)for(var F=0;F<T;++F){var I=e(tt[F],R);if(I!==void 0)return I}if(P!==1)for(var F=0;F<A;++F){var I=e($t[F],R);if(I!==void 0)return I}P===0?Zr(tt,Jt,T++,R):P===1?Zr($t,Ar,A++,R):P===2&&Zr(Yr,Ci,M++,R)}else{var R=(C>>1)-1;P===0?qr(tt,Jt,T--,R):P===1?qr($t,Ar,A--,R):P===2&&qr(Yr,Ci,M--,R)}}}function R_(r,e,t,i,n,o,a,s,f,u,l,h){var c=0,p=2*r,d=e,m=e+r,_=1,y=1;i?y=xt:_=xt;for(var g=n;g<o;++g){var T=g+_,A=p*g;ce[c++]=a[A+d],ce[c++]=-T,ce[c++]=a[A+m],ce[c++]=T}for(var g=f;g<u;++g){var T=g+y,M=p*g;ce[c++]=l[M+d],ce[c++]=-T}var C=c>>>1;Sn(ce,C);for(var P=0,g=0;g<C;++g){var R=ce[2*g+1]|0;if(R<0){var T=-R,F=!1;if(T>=xt?(F=!i,T-=xt):(F=!!i,T-=1),F)Zr(tt,Jt,P++,T);else{var I=h[T],D=p*T,V=l[D+e+1],k=l[D+e+1+r];e:for(var w=0;w<P;++w){var G=tt[w],K=p*G;if(!(k<a[K+e+1]||a[K+e+1+r]<V)){for(var j=e+2;j<r;++j)if(l[D+j+r]<a[K+j]||a[K+j+r]<l[D+j])continue e;var W=s[G],z;if(i?z=t(I,W):z=t(W,I),z!==void 0)return z}}}}else qr(tt,Jt,P--,R-_)}}function x_(r,e,t,i,n,o,a,s,f,u,l){for(var h=0,c=2*r,p=e,d=e+r,m=i;m<n;++m){var _=m+xt,y=c*m;ce[h++]=o[y+p],ce[h++]=-_,ce[h++]=o[y+d],ce[h++]=_}for(var m=s;m<f;++m){var _=m+1,g=c*m;ce[h++]=u[g+p],ce[h++]=-_}var T=h>>>1;Sn(ce,T);for(var A=0,m=0;m<T;++m){var M=ce[2*m+1]|0;if(M<0){var _=-M;if(_>=xt)tt[A++]=_-xt;else{_-=1;var C=l[_],P=c*_,R=u[P+e+1],F=u[P+e+1+r];e:for(var I=0;I<A;++I){var D=tt[I],V=a[D];if(V===C)break;var k=c*D;if(!(F<o[k+e+1]||o[k+e+1+r]<R)){for(var w=e+2;w<r;++w)if(u[P+w+r]<o[k+w]||o[k+w+r]<u[P+w])continue e;var G=t(V,C);if(G!==void 0)return G}}}}else{for(var _=M-xt,I=A-1;I>=0;--I)if(tt[I]===_){for(var w=I+1;w<A;++w)tt[w-1]=tt[w];break}--A}}}});var Zu=$(sa=>{"use strict";v();var Mr="d",$r="ax",Ku="vv",ta="fp",Ii="es",Mn="rs",oa="re",Di="rb",ju="ri",Qr="rp",Rn="bs",aa="be",Oi="bb",Yu="bi",Jr="bp",ra="rv",ia="Q",na=[Mr,$r,Ku,Mn,oa,Di,ju,Rn,aa,Oi,Yu];function P_(r,e,t){var i="bruteForce"+(r?"Red":"Blue")+(e?"Flip":"")+(t?"Full":""),n=["function ",i,"(",na.join(),"){","var ",Ii,"=2*",Mr,";"],o="for(var i="+Mn+","+Qr+"="+Ii+"*"+Mn+";i<"+oa+";++i,"+Qr+"+="+Ii+"){var x0="+Di+"["+$r+"+"+Qr+"],x1="+Di+"["+$r+"+"+Qr+"+"+Mr+"],xi="+ju+"[i];",a="for(var j="+Rn+","+Jr+"="+Ii+"*"+Rn+";j<"+aa+";++j,"+Jr+"+="+Ii+"){var y0="+Oi+"["+$r+"+"+Jr+"],"+(t?"y1="+Oi+"["+$r+"+"+Jr+"+"+Mr+"],":"")+"yi="+Yu+"[j];";return r?n.push(o,ia,":",a):n.push(a,ia,":",o),t?n.push("if(y1<x0||x1<y0)continue;"):e?n.push("if(y0<=x0||x1<y0)continue;"):n.push("if(y0<x0||x1<y0)continue;"),n.push("for(var k="+$r+"+1;k<"+Mr+";++k){var r0="+Di+"[k+"+Qr+"],r1="+Di+"[k+"+Mr+"+"+Qr+"],b0="+Oi+"[k+"+Jr+"],b1="+Oi+"[k+"+Mr+"+"+Jr+"];if(r1<b0||b1<r0)continue "+ia+";}var "+ra+"="+Ku+"("),e?n.push("yi,xi"):n.push("xi,yi"),n.push(");if("+ra+"!==void 0)return "+ra+";}}}"),{name:i,code:n.join("")}}function qu(r){var e="bruteForce"+(r?"Full":"Partial"),t=[],i=na.slice();r||i.splice(3,0,ta);var n=["function "+e+"("+i.join()+"){"];function o(f,u){var l=P_(f,u,r);t.push(l.code),n.push("return "+l.name+"("+na.join()+");")}n.push("if("+oa+"-"+Mn+">"+aa+"-"+Rn+"){"),r?(o(!0,!1),n.push("}else{"),o(!1,!1)):(n.push("if("+ta+"){"),o(!0,!0),n.push("}else{"),o(!0,!1),n.push("}}else{if("+ta+"){"),o(!1,!0),n.push("}else{"),o(!1,!1),n.push("}")),n.push("}}return "+e);var a=t.join("")+n.join(""),s=new Function(a);return s()}sa.partial=qu(!1);sa.full=qu(!0)});var fa=$((Hb,Qu)=>{"use strict";v();Qu.exports=I_;var C_="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function I_(r,e){var t="abcdef".split("").concat(e),i=[];return r.indexOf("lo")>=0&&i.push("lo=e[k+n]"),r.indexOf("hi")>=0&&i.push("hi=e[k+o]"),t.push(C_.replace("_",i.join()).replace("$",r)),Function.apply(void 0,t)}});var el=$((Kb,$u)=>{"use strict";v();$u.exports=w_;var D_=fa(),Ju=D_("lo<p0",["p0"]),O_=8;function F_(r,e,t,i,n,o){for(var a=2*r,s=a*(t+1)+e,f=t+1;f<i;++f,s+=a)for(var u=n[s],l=f,h=a*(f-1);l>t&&n[h+e]>u;--l,h-=a){for(var c=h,p=h+a,d=0;d<a;++d,++c,++p){var m=n[c];n[c]=n[p],n[p]=m}var _=o[l];o[l]=o[l-1],o[l-1]=_}}function w_(r,e,t,i,n,o){if(i<=t+1)return t;for(var a=t,s=i,f=i+t>>>1,u=2*r,l=f,h=n[u*f+e];a<s;){if(s-a<O_){F_(r,e,a,s,n,o),h=n[u*f+e];break}var c=s-a,p=Math.random()*c+a|0,d=n[u*p+e],m=Math.random()*c+a|0,_=n[u*m+e],y=Math.random()*c+a|0,g=n[u*y+e];d<=_?g>=_?(l=m,h=_):d>=g?(l=p,h=d):(l=y,h=g):_>=g?(l=m,h=_):g>=d?(l=p,h=d):(l=y,h=g);for(var M=u*(s-1),C=u*l,T=0;T<u;++T,++M,++C){var A=n[M];n[M]=n[C],n[C]=A}var P=o[s-1];o[s-1]=o[l],o[l]=P,l=Ju(r,e,a,s-1,n,o,h);for(var M=u*(s-1),C=u*l,T=0;T<u;++T,++M,++C){var A=n[M];n[M]=n[C],n[C]=A}var P=o[s-1];if(o[s-1]=o[l],o[l]=P,f<l){for(s=l-1;a<s&&n[u*(s-1)+e]===h;)s-=1;s+=1}else if(l<f)for(a=l+1;a<s&&n[u*a+e]===h;)a+=1;else break}return Ju(r,e,t,f,n,o,n[u*f+e])}});var sl=$((jb,al)=>{"use strict";v();al.exports=j_;var ei=yn(),ua=mn(),nl=Zu(),L_=nl.partial,B_=nl.full,lr=ea(),N_=el(),ti=fa(),tl=128,U_=1<<22,k_=1<<22,V_=ti("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),rl=ti("lo===p0",["p0"]),W_=ti("lo<p0",["p0"]),G_=ti("hi<=p0",["p0"]),il=ti("lo<=p0&&p0<=hi",["p0"]),z_=ti("lo<p0&&p0<=hi",["p0"]),la=6,ha=2,ol=1024,vt=ei.mallocInt32(ol),Rr=ei.mallocDouble(ol);function X_(r,e){var t=8*ua.log2(e+1)*(r+1)|0,i=ua.nextPow2(la*t);vt.length<i&&(ei.free(vt),vt=ei.mallocInt32(i));var n=ua.nextPow2(ha*t);Rr.length<n&&(ei.free(Rr),Rr=ei.mallocDouble(n))}function Ft(r,e,t,i,n,o,a,s,f){var u=la*r;vt[u]=e,vt[u+1]=t,vt[u+2]=i,vt[u+3]=n,vt[u+4]=o,vt[u+5]=a;var l=ha*r;Rr[l]=s,Rr[l+1]=f}function H_(r,e,t,i,n,o,a,s,f,u,l){var h=2*r,c=f*h,p=u[c+e];e:for(var d=n,m=n*h;d<o;++d,m+=h){var _=a[m+e],y=a[m+e+r];if(!(p<_||y<p)&&!(i&&p===_)){for(var g=s[d],T=e+1;T<r;++T){var _=a[m+T],y=a[m+T+r],A=u[c+T],M=u[c+T+r];if(y<A||M<_)continue e}var C;if(i?C=t(l,g):C=t(g,l),C!==void 0)return C}}}function K_(r,e,t,i,n,o,a,s,f,u){var l=2*r,h=s*l,c=f[h+e];e:for(var p=i,d=i*l;p<n;++p,d+=l){var m=a[p];if(m!==u){var _=o[d+e],y=o[d+e+r];if(!(c<_||y<c)){for(var g=e+1;g<r;++g){var _=o[d+g],y=o[d+g+r],T=f[h+g],A=f[h+g+r];if(y<T||A<_)continue e}var M=t(m,u);if(M!==void 0)return M}}}}function j_(r,e,t,i,n,o,a,s,f){X_(r,i+a);var u=0,l=2*r,h;for(Ft(u++,0,0,i,0,a,t?16:0,-1/0,1/0),t||Ft(u++,0,0,a,0,i,1,-1/0,1/0);u>0;){u-=1;var c=u*la,p=vt[c],d=vt[c+1],m=vt[c+2],_=vt[c+3],y=vt[c+4],g=vt[c+5],T=u*ha,A=Rr[T],M=Rr[T+1],C=g&1,P=!!(g&16),R=n,F=o,I=s,D=f;if(C&&(R=s,F=f,I=n,D=o),!(g&2&&(m=W_(r,p,d,m,R,F,M),d>=m))&&!(g&4&&(d=G_(r,p,d,m,R,F,A),d>=m))){var V=m-d,k=y-_;if(P){if(r*V*(V+k)<k_){if(h=lr.scanComplete(r,p,e,d,m,R,F,_,y,I,D),h!==void 0)return h;continue}}else if(r*Math.min(V,k)<tl){if(h=L_(r,p,e,C,d,m,R,F,_,y,I,D),h!==void 0)return h;continue}else if(r*V*k<U_){if(h=lr.scanBipartite(r,p,e,C,d,m,R,F,_,y,I,D),h!==void 0)return h;continue}var w=V_(r,p,d,m,R,F,A,M);if(d<w)if(r*(w-d)<tl){if(h=B_(r,p+1,e,d,w,R,F,_,y,I,D),h!==void 0)return h}else if(p===r-2){if(C?h=lr.sweepBipartite(r,e,_,y,I,D,d,w,R,F):h=lr.sweepBipartite(r,e,d,w,R,F,_,y,I,D),h!==void 0)return h}else Ft(u++,p+1,d,w,_,y,C,-1/0,1/0),Ft(u++,p+1,_,y,d,w,C^1,-1/0,1/0);if(w<m){var G=N_(r,p,_,y,I,D),K=I[l*G+p],j=rl(r,p,G,y,I,D,K);if(j<y&&Ft(u++,p,w,m,j,y,(C|4)+(P?16:0),K,M),_<G&&Ft(u++,p,w,m,_,G,(C|2)+(P?16:0),A,K),G+1===j){if(P?h=K_(r,p,e,w,m,R,F,G,I,D[G]):h=H_(r,p,e,C,w,m,R,F,G,I,D[G]),h!==void 0)return h}else if(G<j){var W;if(P){if(W=il(r,p,w,m,R,F,K),w<W){var z=rl(r,p,w,W,R,F,K);if(p===r-2){if(w<z&&(h=lr.sweepComplete(r,e,w,z,R,F,G,j,I,D),h!==void 0)||z<W&&(h=lr.sweepBipartite(r,e,z,W,R,F,G,j,I,D),h!==void 0))return h}else w<z&&Ft(u++,p+1,w,z,G,j,16,-1/0,1/0),z<W&&(Ft(u++,p+1,z,W,G,j,0,-1/0,1/0),Ft(u++,p+1,G,j,z,W,1,-1/0,1/0))}}else C?W=z_(r,p,w,m,R,F,K):W=il(r,p,w,m,R,F,K),w<W&&(p===r-2?C?h=lr.sweepBipartite(r,e,G,j,I,D,w,W,R,F):h=lr.sweepBipartite(r,e,w,W,R,F,G,j,I,D):(Ft(u++,p+1,w,W,G,j,C,-1/0,1/0),Ft(u++,p+1,G,j,w,W,C^1,-1/0,1/0)))}}}}}});var hl=$((Yb,ll)=>{"use strict";v();ll.exports=J_;var hr=yn(),xn=ea(),Y_=sl();function q_(r,e){for(var t=0;t<r;++t)if(!(e[t]<=e[t+r]))return!0;return!1}function fl(r,e,t,i){for(var n=0,o=0,a=0,s=r.length;a<s;++a){var f=r[a];if(!q_(e,f)){for(var u=0;u<2*e;++u)t[n++]=f[u];i[o++]=a}}return o}function Pn(r,e,t,i){var n=r.length,o=e.length;if(!(n<=0||o<=0)){var a=r[0].length>>>1;if(!(a<=0)){var s,f=hr.mallocDouble(2*a*n),u=hr.mallocInt32(n);if(n=fl(r,a,f,u),n>0){if(a===1&&i)xn.init(n),s=xn.sweepComplete(a,t,0,n,f,u,0,n,f,u);else{var l=hr.mallocDouble(2*a*o),h=hr.mallocInt32(o);o=fl(e,a,l,h),o>0&&(xn.init(n+o),a===1?s=xn.sweepBipartite(a,t,0,n,f,u,0,o,l,h):s=Y_(a,t,i,n,f,u,o,l,h),hr.free(l),hr.free(h))}hr.free(f),hr.free(u)}return s}}}var Fi;function ul(r,e){Fi.push([r,e])}function Z_(r){return Fi=[],Pn(r,r,ul,!0),Fi}function Q_(r,e){return Fi=[],Pn(r,e,ul,!1),Fi}function J_(r,e,t){var i;switch(arguments.length){case 1:return Z_(r);case 2:return typeof e=="function"?Pn(r,r,e,!0):Q_(r,e);case 3:return Pn(r,e,t,!1);default:throw new Error("box-intersect: Invalid arguments")}}});var Gl=$((cE,Dn)=>{v();var El,Tl,Al,Sl,Ml,Rl,xl,Pl,Cl,Cn,ca,Il,Dl,Ol,ri,Fl,wl,Ll,Bl,Nl,Ul,kl,Vl,Wl,In;(function(r){var e=typeof S=="object"?S:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(i){r(t(e,t(i)))}):typeof Dn=="object"&&typeof Dn.exports=="object"?r(t(e,t(Dn.exports))):r(t(e));function t(i,n){return i!==e&&(typeof Object.create=="function"?Object.defineProperty(i,"__esModule",{value:!0}):i.__esModule=!0),function(o,a){return i[o]=n?n(o,a):a}}})(function(r){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])};El=function(i,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(i,n);function o(){this.constructor=i}i.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},Tl=Object.assign||function(i){for(var n,o=1,a=arguments.length;o<a;o++){n=arguments[o];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])}return i},Al=function(i,n){var o={};for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&n.indexOf(a)<0&&(o[a]=i[a]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,a=Object.getOwnPropertySymbols(i);s<a.length;s++)n.indexOf(a[s])<0&&Object.prototype.propertyIsEnumerable.call(i,a[s])&&(o[a[s]]=i[a[s]]);return o},Sl=function(i,n,o,a){var s=arguments.length,f=s<3?n:a===null?a=Object.getOwnPropertyDescriptor(n,o):a,u;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")f=Reflect.decorate(i,n,o,a);else for(var l=i.length-1;l>=0;l--)(u=i[l])&&(f=(s<3?u(f):s>3?u(n,o,f):u(n,o))||f);return s>3&&f&&Object.defineProperty(n,o,f),f},Ml=function(i,n){return function(o,a){n(o,a,i)}},Rl=function(i,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,n)},xl=function(i,n,o,a){function s(f){return f instanceof o?f:new o(function(u){u(f)})}return new(o||(o=Promise))(function(f,u){function l(p){try{c(a.next(p))}catch(d){u(d)}}function h(p){try{c(a.throw(p))}catch(d){u(d)}}function c(p){p.done?f(p.value):s(p.value).then(l,h)}c((a=a.apply(i,n||[])).next())})},Pl=function(i,n){var o={label:0,sent:function(){if(f[0]&1)throw f[1];return f[1]},trys:[],ops:[]},a,s,f,u;return u={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function l(c){return function(p){return h([c,p])}}function h(c){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,s&&(f=c[0]&2?s.return:c[0]?s.throw||((f=s.return)&&f.call(s),0):s.next)&&!(f=f.call(s,c[1])).done)return f;switch(s=0,f&&(c=[c[0]&2,f.value]),c[0]){case 0:case 1:f=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,s=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(f=o.trys,!(f=f.length>0&&f[f.length-1])&&(c[0]===6||c[0]===2)){o=0;continue}if(c[0]===3&&(!f||c[1]>f[0]&&c[1]<f[3])){o.label=c[1];break}if(c[0]===6&&o.label<f[1]){o.label=f[1],f=c;break}if(f&&o.label<f[2]){o.label=f[2],o.ops.push(c);break}f[2]&&o.ops.pop(),o.trys.pop();continue}c=n.call(i,o)}catch(p){c=[6,p],s=0}finally{a=f=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}},Cl=function(i,n){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(n,o)&&In(n,i,o)},In=Object.create?function(i,n,o,a){a===void 0&&(a=o);var s=Object.getOwnPropertyDescriptor(n,o);(!s||("get"in s?!n.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return n[o]}}),Object.defineProperty(i,a,s)}:function(i,n,o,a){a===void 0&&(a=o),i[a]=n[o]},Cn=function(i){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&i[n],a=0;if(o)return o.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&a>=i.length&&(i=void 0),{value:i&&i[a++],done:!i}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},ca=function(i,n){var o=typeof Symbol=="function"&&i[Symbol.iterator];if(!o)return i;var a=o.call(i),s,f=[],u;try{for(;(n===void 0||n-- >0)&&!(s=a.next()).done;)f.push(s.value)}catch(l){u={error:l}}finally{try{s&&!s.done&&(o=a.return)&&o.call(a)}finally{if(u)throw u.error}}return f},Il=function(){for(var i=[],n=0;n<arguments.length;n++)i=i.concat(ca(arguments[n]));return i},Dl=function(){for(var i=0,n=0,o=arguments.length;n<o;n++)i+=arguments[n].length;for(var a=Array(i),s=0,n=0;n<o;n++)for(var f=arguments[n],u=0,l=f.length;u<l;u++,s++)a[s]=f[u];return a},Ol=function(i,n,o){if(o||arguments.length===2)for(var a=0,s=n.length,f;a<s;a++)(f||!(a in n))&&(f||(f=Array.prototype.slice.call(n,0,a)),f[a]=n[a]);return i.concat(f||Array.prototype.slice.call(n))},ri=function(i){return this instanceof ri?(this.v=i,this):new ri(i)},Fl=function(i,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=o.apply(i,n||[]),s,f=[];return s={},u("next"),u("throw"),u("return"),s[Symbol.asyncIterator]=function(){return this},s;function u(m){a[m]&&(s[m]=function(_){return new Promise(function(y,g){f.push([m,_,y,g])>1||l(m,_)})})}function l(m,_){try{h(a[m](_))}catch(y){d(f[0][3],y)}}function h(m){m.value instanceof ri?Promise.resolve(m.value.v).then(c,p):d(f[0][2],m)}function c(m){l("next",m)}function p(m){l("throw",m)}function d(m,_){m(_),f.shift(),f.length&&l(f[0][0],f[0][1])}},wl=function(i){var n,o;return n={},a("next"),a("throw",function(s){throw s}),a("return"),n[Symbol.iterator]=function(){return this},n;function a(s,f){n[s]=i[s]?function(u){return(o=!o)?{value:ri(i[s](u)),done:s==="return"}:f?f(u):u}:f}},Ll=function(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=i[Symbol.asyncIterator],o;return n?n.call(i):(i=typeof Cn=="function"?Cn(i):i[Symbol.iterator](),o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o);function a(f){o[f]=i[f]&&function(u){return new Promise(function(l,h){u=i[f](u),s(l,h,u.done,u.value)})}}function s(f,u,l,h){Promise.resolve(h).then(function(c){f({value:c,done:l})},u)}},Bl=function(i,n){return Object.defineProperty?Object.defineProperty(i,"raw",{value:n}):i.raw=n,i};var t=Object.create?function(i,n){Object.defineProperty(i,"default",{enumerable:!0,value:n})}:function(i,n){i.default=n};Nl=function(i){if(i&&i.__esModule)return i;var n={};if(i!=null)for(var o in i)o!=="default"&&Object.prototype.hasOwnProperty.call(i,o)&&In(n,i,o);return t(n,i),n},Ul=function(i){return i&&i.__esModule?i:{default:i}},kl=function(i,n,o,a){if(o==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?i!==n||!a:!n.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?a:o==="a"?a.call(i):a?a.value:n.get(i)},Vl=function(i,n,o,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?i!==n||!s:!n.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(i,o):s?s.value=o:n.set(i,o),o},Wl=function(i,n){if(n===null||typeof n!="object"&&typeof n!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof i=="function"?n===i:i.has(n)},r("__extends",El),r("__assign",Tl),r("__rest",Al),r("__decorate",Sl),r("__param",Ml),r("__metadata",Rl),r("__awaiter",xl),r("__generator",Pl),r("__exportStar",Cl),r("__createBinding",In),r("__values",Cn),r("__read",ca),r("__spread",Il),r("__spreadArrays",Dl),r("__spreadArray",Ol),r("__await",ri),r("__asyncGenerator",Fl),r("__asyncDelegator",wl),r("__asyncValues",Ll),r("__makeTemplateObject",Bl),r("__importStar",Nl),r("__importDefault",Ul),r("__classPrivateFieldGet",kl),r("__classPrivateFieldSet",Vl),r("__classPrivateFieldIn",Wl)})});var oc={};Rd(oc,{ChunkStorage:()=>Ia,LocationQueue:()=>Ue,copyNdarrayContents:()=>Ov,iterateOverShellAtDistance:()=>Lv,locationHasher:()=>nt,loopForTime:()=>qi,makeProfileHook:()=>ar,makeThroughputHook:()=>Bv,numberOfVoxelsInSphere:()=>Dv,removeUnorderedListItem:()=>Yi});function Yi(r,e){var t=r.indexOf(e);t<0||(t===r.length-1?r.pop():r[t]=r.pop())}function qi(r,e,t){var i=t||performance.now(),n=e();if(!n){var o=performance.now(),a=o-t,s=i+r-a/2;if(!(o>s)){for(var f=1e3,u=0;u<f;u++)if(e()||performance.now()>s)return}}}function Dv(r){if(r===ic)return nc;for(var e=Math.ceil(r),t=0,i=r*r,n=-e;n<=e;++n)for(var o=-e;o<=e;++o)for(var a=-e;a<=e;++a){var s=n*n+o*o+a*a;s<i&&t++}return ic=r,nc=t,t}function Ov(r,e,t,i,n){typeof r=="number"?wv(r,e,n[0],n[1],n[2],i[0],i[1],i[2]):Fv(r,e,t[0],t[1],t[2],i[0],i[1],i[2],n[0],n[1],n[2])}function Fv(r,e,t,i,n,o,a,s,f,u,l){for(var h=r.stride[2],c=e.stride[2],p=0;p<o;p++)for(var d=0;d<a;d++)for(var m=r.index(t+p,i+d,n),_=e.index(f+p,u+d,l),y=0;y<s;y++)e.data[_]=r.data[m],m+=h,_+=c}function wv(r,e,t,i,n,o,a,s){for(var f=e.stride[2],u=0;u<o;u++)for(var l=0;l<a;l++)for(var h=e.index(t+u,i+l,n),c=0;c<s;c++)e.data[h]=r,h+=f}function Lv(r,e,t,i){if(r===0)return i(0,0,0);var n=Math.min(r,e),o=Math.min(r,t);if(r<=t){for(var a=-n;a<=n;a++)for(var s=-n;s<=n;s++)if(i(a,r,s)||i(a,-r,s))return!0}if(r<=e){for(var f=-r;f<r;f++)for(var u=-o+1;u<o;u++)if(i(f,u,r)||i(-f,u,-r)||i(r,u,-f)||i(-r,u,f))return!0}return!1}function nt(r,e,t){return r&1023|(e&1023)<<10|(t&1023)<<20}function Ia(){var r={};this.getChunkByIndexes=(e,t,i)=>r[nt(e,t,i)]||null,this.storeChunkByIndexes=(e,t,i,n)=>{r[nt(e,t,i)]=n},this.removeChunkByIndexes=(e,t,i)=>{delete r[nt(e,t,i)]}}function Ue(){this.arr=[],this.hash={}}function ar(r,e="",t){if(!(r>0))return()=>{};var i={},n=0,o=0,a=0,s=0,f=()=>{n=o=performance.now(),a++},u=h=>{var c=performance.now();i[h]=(i[h]||0)+(c-o),o=c},l=()=>{if(s+=performance.now()-n,!(a<r)){var h=`${e}: ${(s/r).toFixed(2)}ms  --  `;h+=Object.keys(i).map(c=>t&&i[c]/s<.05?"":`${c}: ${(i[c]/a).toFixed(2)}ms`).join("  "),console.log(h+`    (avg over ${r} runs)`),i={},a=s=0}};return h=>{h==="start"?f():h==="end"?l():u(h)}}function Bv(r,e,t){var i=e||"",n=r||1,o={},a=performance.now(),s=0;return function(u){if(u!=="start")if(u==="end"){if(++s<n)return;var l=performance.now();console.log(i+"   "+Object.keys(o).map(h=>{var c=o[h]/(l-a)*1e3;return o[h]=0,h+":"+c.toFixed(2)+"   "}).join("")),a=l,s=0}else o[u]||(o[u]=0),o[u]++}}var ic,nc,Ut=hs(()=>{v();ic=0,nc=0;Ue.prototype.forEach=function(r,e){this.arr.forEach(r,e)};Ue.prototype.includes=function(r,e,t){var i=nt(r,e,t);return!!this.hash[i]};Ue.prototype.add=function(r,e,t){var i=nt(r,e,t);this.hash[i]||(this.arr.push([r,e,t,i]),this.hash[i]=!0)};Ue.prototype.addToFront=function(r,e,t){var i=nt(r,e,t);this.hash[i]||(this.arr.unshift([r,e,t,i]),this.hash[i]=!0)};Ue.prototype.removeByIndex=function(r){var e=this.arr[r];delete this.hash[e[3]],this.arr.splice(r,1)};Ue.prototype.remove=function(r,e,t){var i=nt(r,e,t);if(!!this.hash[i]){delete this.hash[i];for(var n=0;n<this.arr.length;n++)if(i===this.arr[n][3]){this.arr.splice(n,1);return}throw"internal bug with location queue - hash value overlapped"}};Ue.prototype.count=function(){return this.arr.length};Ue.prototype.isEmpty=function(){return this.arr.length===0};Ue.prototype.empty=function(){this.arr.length=0,this.hash={}};Ue.prototype.pop=function(){var r=this.arr.pop();return delete this.hash[r[3]],r};Ue.prototype.copyFrom=function(r){this.arr=r.arr.slice(),this.hash={};for(var e in r.hash)this.hash[e]=!0};Ue.prototype.sortByDistance=function(r){var e={};for(var t of this.arr)e[t]=r(t[0],t[1],t[2]);this.arr.sort((i,n)=>e[n]-e[i]),e=null}});var od=$(Ve=>{"use strict";v();var rs=32;Ve.INT_BITS=rs;Ve.INT_MAX=2147483647;Ve.INT_MIN=-1<<rs-1;Ve.sign=function(r){return(r>0)-(r<0)};Ve.abs=function(r){var e=r>>rs-1;return(r^e)-e};Ve.min=function(r,e){return e^(r^e)&-(r<e)};Ve.max=function(r,e){return r^(r^e)&-(r<e)};Ve.isPow2=function(r){return!(r&r-1)&&!!r};Ve.log2=function(r){var e,t;return e=(r>65535)<<4,r>>>=e,t=(r>255)<<3,r>>>=t,e|=t,t=(r>15)<<2,r>>>=t,e|=t,t=(r>3)<<1,r>>>=t,e|=t,e|r>>1};Ve.log10=function(r){return r>=1e9?9:r>=1e8?8:r>=1e7?7:r>=1e6?6:r>=1e5?5:r>=1e4?4:r>=1e3?3:r>=100?2:r>=10?1:0};Ve.popCount=function(r){return r=r-(r>>>1&1431655765),r=(r&858993459)+(r>>>2&858993459),(r+(r>>>4)&252645135)*16843009>>>24};function nd(r){var e=32;return r&=-r,r&&e--,r&65535&&(e-=16),r&16711935&&(e-=8),r&252645135&&(e-=4),r&858993459&&(e-=2),r&1431655765&&(e-=1),e}Ve.countTrailingZeros=nd;Ve.nextPow2=function(r){return r+=r===0,--r,r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r+1};Ve.prevPow2=function(r){return r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r-(r>>>1)};Ve.parity=function(r){return r^=r>>>16,r^=r>>>8,r^=r>>>4,r&=15,27030>>>r&1};var tn=new Array(256);(function(r){for(var e=0;e<256;++e){var t=e,i=e,n=7;for(t>>>=1;t;t>>>=1)i<<=1,i|=t&1,--n;r[e]=i<<n&255}})(tn);Ve.reverse=function(r){return tn[r&255]<<24|tn[r>>>8&255]<<16|tn[r>>>16&255]<<8|tn[r>>>24&255]};Ve.interleave2=function(r,e){return r&=65535,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,r|e<<1};Ve.deinterleave2=function(r,e){return r=r>>>e&1431655765,r=(r|r>>>1)&858993459,r=(r|r>>>2)&252645135,r=(r|r>>>4)&16711935,r=(r|r>>>16)&65535,r<<16>>16};Ve.interleave3=function(r,e,t){return r&=1023,r=(r|r<<16)&4278190335,r=(r|r<<8)&251719695,r=(r|r<<4)&3272356035,r=(r|r<<2)&1227133513,e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,r|=e<<1,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,r|t<<2};Ve.deinterleave3=function(r,e){return r=r>>>e&1227133513,r=(r|r>>>2)&3272356035,r=(r|r>>>4)&251719695,r=(r|r>>>8)&4278190335,r=(r|r>>>16)&1023,r<<22>>22};Ve.nextCombination=function(r){var e=r|r-1;return e+1|(~e&-~e)-1>>>nd(r)+1}});var fd=$(Ro=>{v();var ad=od();function sd(r){for(var e=0,t=r.length,i=0,n,o;i<r.length;){for(n=r[i],o=0;i<t&&r[i]===n;)++i,++o;e+=ad.log2(o)/7|0,e+=ad.log2(n>>>0)/7|0,e+=2}return e}Ro.size=sd;function f0(r,e){e||(e=new Uint8Array(sd(r)));for(var t=0,i=e.length,n=0,o,a;n<r.length;){for(o=r[n],a=0;n<r.length&&r[n]===o;)++n,++a;for(;t<i&&a>=128;)e[t++]=128+(a&127),a>>>=7;if(t>=i)throw new Error("RLE buffer overflow");for(e[t++]=a,o>>>=0;t<i&&o>=128;)e[t++]=128+(o&127),o>>>=7;if(t>=i)throw new Error("RLE buffer overflow");e[t++]=o}return e}Ro.encode=f0;function u0(r,e){for(var t=e.length,i=r.length,n=0,o=0,a,s,f,u;o<i;){for(a=0,s=0;o<i&&r[o]>=128;)a+=(r[o++]&127)<<s,s+=7;if(a+=r[o++]<<s,o>=i)throw new Error("RLE buffer underrun");if(n+a>t)throw new Error("Chunk buffer overflow");for(f=0,s=0;o<i&&r[o]>=128;)f+=(r[o++]&127)<<s,s+=7;if(o>=i)throw new Error("RLE buffer underrun");for(f+=r[o++]<<s,u=0;u<a;++u)e[n++]=f}return e}Ro.decode=u0});v();v();v();v();var Et=He(Tt()),$a=He(on()),Jc=He(Mi()),$c=He(nu());v();v();var Xo=He(Mi());var ou={name:"game-inputs",version:"0.7.0",description:"Simple library to abstract key/mouse events for games.",main:"src/inputs.js",typings:"dist/src/inputs.d.ts",files:["/src","/dist"],scripts:{start:"cd docs/ && webpack serve",build:"tsc; cd docs/ && webpack"},author:"Andy Hall",license:"ISC",keywords:["game","inputs","key","mouse","events"],dependencies:{events:"^3.3.0"},repository:{type:"git",url:"https://github.com/fenomas/game-inputs"},bugs:{url:"https://github.com/fenomas/game-inputs/issues"}};var Op=ou.version;function Fp(){this.preventDefaults=!1,this.stopPropagation=!1,this.allowContextMenu=!1,this.disabled=!1}var un=class{constructor(e,t){this.version=Op;var i=Object.assign({},new Fp,t||{});this.element=e||document,this.preventDefaults=!!i.preventDefaults,this.stopPropagation=!!i.stopPropagation,this.allowContextMenu=!!i.allowContextMenu,this.disabled=!!i.disabled,this.filterEvents=(n,o)=>!0,this.down=new Xo.EventEmitter,this.up=new Xo.EventEmitter,this.state={},this.pointerState={dx:0,dy:0,scrollx:0,scrolly:0,scrollz:0},this.pressCount={},this.releaseCount={},this._keyBindmap={},this._keyStates={},this._bindPressCount={},this._touches={lastX:0,lastY:0,currID:null},document.readyState==="complete"?au(this):document.addEventListener("DOMContentLoaded",n=>{au(this)},{once:!0})}bind(e,...t){t.forEach(i=>{var n=this._keyBindmap[i]||[];n.includes(e)||(n.push(e),this._keyBindmap[i]=n)}),this.state[e]=!!this.state[e],this.pressCount[e]=this.pressCount[e]||0,this.releaseCount[e]=this.releaseCount[e]||0}unbind(e){for(var t in this._keyBindmap){var i=this._keyBindmap[t],n=i.indexOf(e);n>-1&&i.splice(n,1)}}getBindings(){var e={};for(var t in this._keyBindmap){var i=this._keyBindmap[t];i.forEach(n=>{e[n]=e[n]||[],e[n].push(t)})}return e}tick(){zo(this.pointerState),zo(this.pressCount),zo(this.releaseCount)}};function zo(r){for(var e in r)r[e]=0}function au(r){window.addEventListener("keydown",su.bind(null,r,!0),!1),window.addEventListener("keyup",su.bind(null,r,!1),!1);var e={passive:!0};window.PointerEvent?(r.element.addEventListener("pointerdown",fn.bind(null,r,!0),e),window.document.addEventListener("pointerup",fn.bind(null,r,!1),e),r.element.addEventListener("pointermove",fu.bind(null,r),e)):(r.element.addEventListener("mousedown",fn.bind(null,r,!0),e),window.document.addEventListener("mouseup",fn.bind(null,r,!1),e),r.element.addEventListener("mousemove",fu.bind(null,r),e)),r.element.addEventListener("wheel",wp.bind(null,r),e),r.element.addEventListener("contextmenu",Lp.bind(null,r),!1),window.addEventListener("blur",Bp.bind(null,r),!1)}function su(r,e,t){Ho(t.code,e,r,t)}function fn(r,e,t){if("pointerId"in t)if(e){if(r._touches.currID!==null)return;r._touches.currID=t.pointerId}else{if(r._touches.currID!==t.pointerId)return;r._touches.currID=null}var i="button"in t?t.button+1:1;return Ho("Mouse"+i,e,r,t),!1}function fu(r,e){if(!("pointerId"in e&&r._touches.currID!==null&&r._touches.currID!==e.pointerId)){var t=e.movementX||e.mozMovementX||0,i=e.movementY||e.mozMovementY||0;r.pointerState.dx+=t,r.pointerState.dy+=i}}function wp(r,e){var t=1;switch(e.deltaMode){case 0:t=1;break;case 1:t=12;break;case 2:t=r.element.clientHeight||window.innerHeight;break}r.pointerState.scrollx+=(e.deltaX||0)*t,r.pointerState.scrolly+=(e.deltaY||0)*t,r.pointerState.scrollz+=(e.deltaZ||0)*t}function Lp(r,e){if(!r.allowContextMenu)return e.preventDefault(),!1}function Bp(r){for(var e in r._keyStates)!r._keyStates[e]||/^Mouse\d/.test(e)||Ho(e,!1,r,{code:e,note:"This is a mocked KeyboardEvent made by the 'game-inputs' module",preventDefault:()=>{},stopPropagation:()=>{}})}function Ho(r,e,t,i){var n=t._keyBindmap[r];if(!!n){var o=t._keyStates[r];uu(o,e)&&(t._keyStates[r]=e,n.forEach(a=>{var s=t.filterEvents?t.filterEvents(i,a):!0;!s||Np(a,e,t,i)})),"button"in i||(t.preventDefaults&&!i.defaultPrevented&&i.preventDefault(),t.stopPropagation&&i.stopPropagation())}}function Np(r,e,t,i){var n=e?t.pressCount:t.releaseCount;n[r]=(n[r]||0)+1;var o=t._bindPressCount[r]||0;o+=e?1:-1,o<0&&(o=0),t._bindPressCount[r]=o;var a=t.state[r];if(uu(a,o)){t.state[r]=o>0;var s=e?t.down:t.up;t.disabled||s.emit(r,i)}}function uu(r,e){return r?!e:e}var Up={preventDefaults:!1,stopPropagation:!1,allowContextMenu:!1},kp={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],left:["KeyA","ArrowLeft"],right:["KeyD","ArrowRight"],fire:"Mouse1","mid-fire":["Mouse2","KeyQ"],"alt-fire":["Mouse3","KeyE"],jump:"Space"},ln=class extends un{constructor(e,t,i){t=Object.assign({},Up,t),super(i,t);var n=t.bindings||kp;for(var o in n){var a=Array.isArray(n[o])?n[o]:[n[o]];this.bind(o,...a)}}};v();var hu=He(Mi());v();var hn=class{constructor(e=null,t=10,i=100){this.stickyPointerLock=!1,this.stickyFullscreen=!1,this.tickRate=30,this.maxRenderRate=0,this.pointerLock=!1,this.fullscreen=!1,this.onTick=function(n){},this.onRender=function(){},this.onInit=function(){},this.onResize=function(){},this.onPointerLockChanged=function(n){},this.onFullscreenChanged=function(n){},this.onPointerLockError=function(n){},zp(()=>{Vp(this,t,i),Gp(this,e),this.onInit()})}};function Vp(r,e,t){r._nowObject=performance||Date,r._skipFramesAfter=t,r._renderAccum=0;var i=r._nowObject.now();r._lastTick=i,r._lastRender=i,r._frameCB=Wp.bind(null,r),requestAnimationFrame(r._frameCB),e>0&&(r._intervalCB=lu.bind(null,r),r._interval=setInterval(r._intervalCB,e))}function lu(r){for(var e=r._nowObject.now(),t=e+r._skipFramesAfter,i=1e3/r.tickRate;r._lastTick+i<e;)if(r.onTick(i),r._lastTick+=i,e=r._nowObject.now(),e>t){r._lastTick=e;return}}function Wp(r){requestAnimationFrame(r._frameCB),lu(r);var e=r._nowObject.now(),t=e-r._lastRender;if(r._lastRender=e,r.maxRenderRate>0){r._renderAccum+=t;var i=1e3/r.maxRenderRate;if(r._renderAccum<i)return;r._renderAccum=Math.min(r._renderAccum-i,i)}var n=1e3/r.tickRate,o=(e-r._lastTick)/n;r.onRender(t,o,n)}function Gp(r,e){if(!!e){var t=!1,i=!1,n=f=>{if(!!e.requestPointerLock&&!!f!==t&&f){var u=e.requestPointerLock();u&&u.catch&&u.catch(l=>{})}},o=f=>{!!f!==i&&(f?e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};document.addEventListener("pointerlockchange",f=>{t=document.pointerLockElement===e,r.onPointerLockChanged(t)}),document.addEventListener("fullscreenchange",f=>{i=document.fullscreenElement===e,r.onFullscreenChanged(i)}),document.addEventListener("pointerlockerror",f=>{r.onPointerLockError(f)}),Object.defineProperty(r,"pointerLock",{get:()=>t,set:n}),Object.defineProperty(r,"fullscreen",{get:()=>i,set:o}),e.addEventListener("click",f=>{r.stickyPointerLock&&!t&&n(!0),r.stickyFullscreen&&!i&&o(!0)});var a=()=>r.onResize();if(window.ResizeObserver){var s=new ResizeObserver(a);s.observe(e)}else window.addEventListener("resize",a)}}var zp=r=>{if(document.readyState==="loading"){var e=()=>{document.removeEventListener("readystatechange",e),r()};document.addEventListener("readystatechange",e)}else setTimeout(r,1)};var cn=class extends hu.EventEmitter{constructor(e,t){super(),t=t||{},this.noa=e;var i=t.domElement||null;typeof i=="string"&&(i=document.querySelector(i)),this.element=i||Xp(),this.canvas=Hp(this.element),this.supportsPointerLock=!1,this.pointerInGame=!1,this.isFocused=!!document.hasFocus(),this.hasPointerLock=!1;var n=10;this._shell=new hn(this.element,n),this._shell.tickRate=t.tickRate,this._shell.maxRenderRate=t.maxRenderRate,this._shell.stickyPointerLock=t.stickyPointerLock,this._shell.stickyFullscreen=t.stickyFullscreen,this._shell.onTick=e.tick.bind(e),this._shell.onRender=e.render.bind(e),this._shell.onPointerLockChanged=o=>{this.hasPointerLock=o,this.emit(o?"gainedPointerLock":"lostPointerLock"),o&&(this.pointerInGame=!0)},this._shell.onInit=()=>{this._shell.onResize=e.rendering.resize.bind(e.rendering),Kp(this),this.element.addEventListener("mouseenter",()=>{this.pointerInGame=!0}),this.element.addEventListener("mouseleave",()=>{this.pointerInGame=!1}),window.addEventListener("focus",()=>{this.isFocused=!0}),window.addEventListener("blur",()=>{this.isFocused=!1});var o=()=>{this.pointerInGame=!0,this.isFocused=!0,this.element.removeEventListener("mousedown",o)};this.element.addEventListener("mousedown",o),this.emit("DOMready"),this._shell.onInit=null}}appendTo(e){this.element.appendChild(e)}setPointerLock(e=!1){this._shell.pointerLock=!!e}};function Xp(){var r=document.createElement("div");return r.tabIndex=1,r.style.position="fixed",r.style.left="0px",r.style.right="0px",r.style.top="0px",r.style.bottom="0px",r.style.height="100%",r.style.overflow="hidden",document.body.appendChild(r),document.body.style.overflow="hidden",document.body.style.height="100%",r.id="noa-container",r}function Hp(r){var e=r.querySelector("canvas");return e||(e=document.createElement("canvas"),e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.height="100%",e.style.width="100%",e.id="noa-canvas",r.insertBefore(e,r.firstChild)),e}function Kp(r){var e="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(e){r.supportsPointerLock=!0;var t=function(i){r.supportsPointerLock=!1,document.removeEventListener(i.type,t)};document.addEventListener("touchmove",t)}}v();var pt=He(Tt()),pu=He(dn()),_u=He(Ko()),f_={inverseX:!1,inverseY:!1,sensitivityX:10,sensitivityY:10,initialZoom:0,zoomSpeed:.2},jo=[pt.default.create(),pt.default.create(),pt.default.create()],u_=pt.default.create(),pn=class{constructor(e,t){t=Object.assign({},f_,t),this.noa=e,this.sensitivityX=+t.sensitivityX,this.sensitivityY=+t.sensitivityY,this.inverseX=!!t.inverseX,this.inverseY=!!t.inverseY,this.inputsDisabled=!1,this.heading=0,this.pitch=0,this.cameraTarget=this.noa.ents.createEntity(["position"]);var i=.9*e.ents.getPositionData(e.playerEntity).height;e.ents.addComponent(this.cameraTarget,"followsEntity",{entity:e.playerEntity,offset:[0,i,0]}),this.zoomDistance=t.initialZoom,this.zoomSpeed=t.zoomSpeed,this.currentZoom=t.initialZoom,this._dirVector=pt.default.fromValues(0,0,1)}_localGetTargetPosition(){var e=this.noa.ents.getPositionData(this.cameraTarget),t=jo[0];return pt.default.copy(t,e._renderPosition)}_localGetPosition(){var e=this._localGetTargetPosition();return this.currentZoom===0?e:pt.default.scaleAndAdd(e,e,this._dirVector,-this.currentZoom)}getTargetPosition(){var e=this._localGetTargetPosition(),t=jo[1];return this.noa.localToGlobal(e,t)}getPosition(){var e=this._localGetPosition(),t=jo[2];return this.noa.localToGlobal(e,t)}getDirection(){return this._dirVector}applyInputsToCamera(){var e=this.noa.inputs.pointerState;h_(e);var t=.0066*Math.PI/180,i=e.dy*this.sensitivityY*t,n=e.dx*this.sensitivityX*t;this.inverseY&&(i=-i),this.inverseX&&(n=-n),this.inputsDisabled&&(n=i=0);var o=2*Math.PI;this.heading+=n<0?n+o:n,this.heading>o&&(this.heading-=o);var a=Math.PI/2-.001;this.pitch=Math.max(-a,Math.min(a,this.pitch+i)),pt.default.set(this._dirVector,0,0,1);var s=this._dirVector,f=u_;pt.default.rotateX(s,s,f,this.pitch),pt.default.rotateY(s,s,f,this.heading)}updateBeforeEntityRenderSystems(){this.currentZoom+=(this.zoomDistance-this.currentZoom)*this.zoomSpeed}updateAfterEntityRenderSystems(){var e=l_(this);this.currentZoom>e&&(this.currentZoom=e)}};function l_(r){r._sweepBox||(r._sweepBox=new pu.default([0,0,0],[.2,.2,.2]),r._sweepGetVoxel=r.noa.world.getBlockSolidity.bind(r.noa.world),r._sweepVec=pt.default.create(),r._sweepHit=()=>!0);var e=pt.default.copy(r._sweepVec,r._localGetTargetPosition());pt.default.add(e,e,r.noa.worldOriginOffset);for(var t=0;t<3;t++)e[t]-=.1;r._sweepBox.setPosition(e);var i=Math.max(r.zoomDistance,r.currentZoom)+.1;return pt.default.scale(r._sweepVec,r.getDirection(),-i),(0,_u.default)(r._sweepGetVoxel,r._sweepBox,r._sweepVec,r._sweepHit,!0)}function h_(r){var e=r.dx,t=r.dy,i=Math.abs(e)>400&&Math.abs(e/Ri)>4,n=Math.abs(t)>400&&Math.abs(t/xi)>4;i||n?(r.dx=Ri,r.dy=xi,Ri=(Ri+e)/2,xi=(xi+t)/2):(Ri=e||1,xi=t||1)}var Ri=0,xi=0;v();var rc=He(yu()),Br=He(Tt());v();var Kr=He(Tt()),Yo=class{constructor(){this.position=null,this.width=.8,this.height=.8,this._localPosition=null,this._renderPosition=null,this._extents=null}};function bu(r){return{name:"position",order:60,state:new Yo,onAdd:function(e,t){var i=[0,0,0];t.position&&Kr.default.copy(i,t.position),t.position=i,t._localPosition=Kr.default.create(),t._renderPosition=Kr.default.create(),t._extents=new Float32Array(6),r.globalToLocal(t.position,null,t._localPosition),Kr.default.copy(t._renderPosition,t._localPosition),_n(t)},onRemove:null,system:function(e,t){for(var i=r.worldOriginOffset,n=0;n<t.length;n++){var o=t[n];Kr.default.add(o.position,o._localPosition,i),_n(o)}}}}function _n(r){var e=r.width/2,t=r._localPosition,i=r._extents;i[0]=t[0]-e,i[1]=t[1],i[2]=t[2]-e,i[3]=t[0]+e,i[4]=t[1]+r.height,i[5]=t[2]+e}v();var Zt=He(Tt()),qo=class{constructor(){this.body=null}};function Au(r){return{name:"physics",order:40,state:new qo,onAdd:function(e,t){t.body=r.physics.addBody();var i=r.ents.getPositionData(t.__id);Zo(t,i)},onRemove:function(e,t){if(r.ents.hasPosition(t.__id)){var i=r.ents.getPositionData(t.__id);Eu(t,i),Tu(t,i,0,!1)}r.physics.removeBody(t.body)},system:function(e,t){for(var i=0;i<t.length;i++){var n=t[i],o=r.ents.getPositionData(n.__id);Eu(n,o)}},renderSystem:function(e,t){var i=r.positionInCurrentTick,n=1e3/r.container._shell.tickRate;n*=r.timeScale;for(var o=i*n,a=(o-n)/1e3,s=0;s<t.length;s++){var f=t[s],u=f.__id,l=r.ents.getPositionData(u),h=r.ents.cameraSmoothed(u);Tu(f,l,a,h)}}}}var vn=Zt.default.create();function Zo(r,e){var t=r.body.aabb,i=e._extents;Zt.default.copy(t.base,i),Zt.default.set(t.vec,e.width,e.height,e.width),Zt.default.add(t.max,t.base,t.vec)}function Eu(r,e){var t=r.body.aabb.base,i=e.width/2;Zt.default.set(e._localPosition,t[0]+i,t[1],t[2]+i)}function Tu(r,e,t,i){var n=r.body.velocity;Zt.default.scaleAndAdd(vn,e._localPosition,n,t),i&&Zt.default.lerp(vn,e._renderPosition,vn,.3),Zt.default.copy(e._renderPosition,vn)}v();var $_=hl();function cl(r){var e=[];return{name:"collideEntities",order:70,state:{cylinder:!1,collideBits:1,collideMask:1,callback:null},onAdd:null,onRemove:null,system:function(f,u){for(var l=r.ents,h=0;h<u.length;h++){var c=u[h].__id,p=l.getPositionData(c);e[h]=p._extents}e.length=u.length,$_(e,function(d,m){var _=u[d],y=u[m];if(!(!_||!y)){var g=e[d],T=e[m];i(_,y,g,T)&&t(r,_,y)}})}};function t(s,f,u){var l=f.__id,h=u.__id;f.collideMask&u.collideBits&&f.callback&&f.callback(h),u.collideMask&f.collideBits&&u.callback&&u.callback(l),s.ents.onPairwiseEntityCollision(l,h)}function i(s,f,u,l){return s.cylinder?f.cylinder?n(u,l):o(u,l):f.cylinder?o(l,u):!0}function n(s,f){var u=(s[3]-s[0])/2,l=(f[3]-f[0])/2,h=s[0]+u-(f[0]+l),c=s[2]+u-(f[2]+l),p=h*h+c*c,d=u+l;return p<=d*d}function o(s,f){var u=(s[3]-s[0])/2,l=s[0]+u,h=s[2]+u,c=a(l,f[0],f[3]),p=a(h,f[2],f[5]),d=c-l,m=p-h,_=d*d+m*m;return _<=u*u}function a(s,f,u){return s<f?f:s>u?u:s}}v();function dl(r){return{name:"collideTerrain",order:0,state:{callback:null},onAdd:function(e,t){var i=r.entities;if(i.hasPhysics(e)){var n=i.getPhysics(e).body;n.onCollide=function(a){var s=r.ents.getCollideTerrain(e).callback;s&&s(a,e)}}},onRemove:function(e,t){var i=r.entities;i.hasPhysics(e)&&(i.getPhysics(e).body.onCollide=null)}}}v();function pl(r){return{name:"fadeOnZoom",order:99,state:{cutoff:1.5},onAdd:null,onRemove:null,system:function(t,i){for(var n=r.camera.currentZoom,o=r.entities,a=0;a<i.length;a++)ev(i[a],n,o)}}}function ev(r,e,t){if(!!t.hasMesh(r.__id)){var i=e>r.cutoff;t.getMeshData(r.__id).mesh.visibility=i}}v();var wi=He(Tt());function _l(r){return{name:"followsEntity",order:50,state:{entity:0,offset:null,onTargetMissing:null},onAdd:function(i,n){var o=wi.default.create();n.offset=n.offset?wi.default.copy(o,n.offset):o,e(n),t(n)},onRemove:null,system:function(n,o){for(var a=0;a<o.length;a++)e(o[a])},renderSystem:function(n,o){for(var a=0;a<o.length;a++)t(o[a])}};function e(i){var n=i.__id,o=r.ents.getPositionData(n),a=r.ents.getPositionData(i.entity);a?wi.default.add(o._localPosition,a._localPosition,i.offset):(i.onTargetMissing&&i.onTargetMissing(n),r.ents.removeComponent(n,r.ents.names.followsEntity))}function t(i){var n=i.__id,o=r.ents.getPositionData(n),a=r.ents.getPositionData(i.entity);a&&wi.default.add(o._renderPosition,a._renderPosition,i.offset)}}v();var vl=He(Tt());function ml(r){return{name:"mesh",order:100,state:{mesh:null,offset:null},onAdd:function(e,t){var i=r.ents.getPositionData(e);if(t.mesh)r.rendering.addMeshToScene(t.mesh,!1,i.position);else throw new Error("Mesh component added without a mesh - probably a bug!");t.offset||(t.offset=vl.default.create());var n=i._renderPosition;t.mesh.position.copyFromFloats(n[0]+t.offset[0],n[1]+t.offset[1],n[2]+t.offset[2])},onRemove:function(e,t){t.mesh.dispose()},renderSystem:function(e,t){for(var i=0;i<t.length;i++){var n=t[i],o=n.__id,a=r.ents.getPositionData(o)._renderPosition;n.mesh.position.copyFromFloats(a[0]+n.offset[0],a[1]+n.offset[1],a[2]+n.offset[2])}}}}v();var kt=He(Tt());function tv(){this.heading=0,this.running=!1,this.jumping=!1,this.maxSpeed=10,this.moveForce=30,this.responsiveness=15,this.runningFriction=0,this.standingFriction=2,this.airMoveMult=.5,this.jumpImpulse=10,this.jumpForce=12,this.jumpTime=500,this.airJumps=1,this._jumpCount=0,this._currjumptime=0,this._isJumping=!1}function gl(r){return{name:"movement",order:30,state:new tv,onAdd:null,onRemove:null,system:function(t,i){for(var n=r.entities,o=0;o<i.length;o++){var a=i[o],s=n.getPhysics(a.__id);s&&ov(t,a,s.body)}}}}var rv=kt.default.create(),iv=kt.default.create(),nv=kt.default.create();function ov(r,e,t){var i=t.atRestY()<0,n=i||e._jumpCount<e.airJumps;if(i&&(e._isJumping=!1,e._jumpCount=0),e.jumping)if(e._isJumping){if(e._currjumptime>0){var o=e.jumpForce;e._currjumptime<r&&(o*=e._currjumptime/r),t.applyForce([0,o,0]),e._currjumptime-=r}}else n&&(e._isJumping=!0,i||e._jumpCount++,e._currjumptime=e.jumpTime,t.applyImpulse([0,e.jumpImpulse,0]),!i&&t.velocity[1]<0&&(t.velocity[1]=0));else e._isJumping=!1;var a=rv,s=iv;if(e.running){var f=e.maxSpeed;kt.default.set(a,0,0,f),kt.default.rotateY(a,a,nv,e.heading),kt.default.subtract(s,a,t.velocity),s[1]=0;var u=kt.default.length(s);if(kt.default.normalize(s,s),u>0){var l=e.moveForce;i||(l*=e.airMoveMult);var h=e.responsiveness*u;l>h&&(l=h),kt.default.scale(s,s,l),t.applyForce(s)}t.friction=e.runningFriction}else t.friction=e.standingFriction}v();function yl(r){return{name:"receivesInputs",order:20,state:{},onAdd:null,onRemove:null,system:function(t,i){for(var n=r.entities,o=r.inputs.state,a=r.camera.heading,s=0;s<i.length;s++){var f=i[s],u=n.getMovement(f.__id);av(u,o,a)}}}}function av(r,e,t){r.jumping=!!e.jump;var i=e.forward?e.backward?0:1:e.backward?-1:0,n=e.right?e.left?0:1:e.left?-1:0;(i|n)===0?r.running=!1:(r.running=!0,i?(i==-1&&(t+=Math.PI),n&&(t+=Math.PI/4*i*n)):t+=n*Math.PI/2,r.heading=t)}v();var ji=He(Tt());v();v();var ae=function(){function r(){}return r.WithinEpsilon=function(e,t,i){return i===void 0&&(i=1401298e-51),Math.abs(e-t)<=i},r.ToHex=function(e){var t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()},r.Sign=function(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1},r.Clamp=function(e,t,i){return t===void 0&&(t=0),i===void 0&&(i=1),Math.min(i,Math.max(t,e))},r.Log2=function(e){return Math.log(e)*Math.LOG2E},r.ILog2=function(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;var t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t},r.Repeat=function(e,t){return e-Math.floor(e/t)*t},r.Normalize=function(e,t,i){return(e-t)/(i-t)},r.Denormalize=function(e,t,i){return e*(i-t)+t},r.DeltaAngle=function(e,t){var i=r.Repeat(t-e,360);return i>180&&(i-=360),i},r.PingPong=function(e,t){var i=r.Repeat(e,t*2);return t-Math.abs(i-t)},r.SmoothStep=function(e,t,i){var n=r.Clamp(i);return n=-2*n*n*n+3*n*n,t*n+e*(1-n)},r.MoveTowards=function(e,t,i){var n=0;return Math.abs(t-e)<=i?n=t:n=e+r.Sign(t-e)*i,n},r.MoveTowardsAngle=function(e,t,i){var n=r.DeltaAngle(e,t),o=0;return-i<n&&n<i?o=t:(t=e+n,o=r.MoveTowards(e,t,i)),o},r.Lerp=function(e,t,i){return e+(t-e)*i},r.LerpAngle=function(e,t,i){var n=r.Repeat(t-e,360);return n>180&&(n-=360),e+n*r.Clamp(i)},r.InverseLerp=function(e,t,i){var n=0;return e!=t?n=r.Clamp((i-e)/(t-e)):n=0,n},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a;return e*f+i*u+t*l+n*h},r.Hermite1stDerivative=function(e,t,i,n,o){var a=o*o;return(a-o)*6*e+(3*a-4*o+1)*t+(-a+o)*6*i+(3*a-2*o)*n},r.RandomRange=function(e,t){return e===t?e:Math.random()*(t-e)+e},r.RangeToPercent=function(e,t,i){return(e-t)/(i-t)},r.PercentToRange=function(e,t,i){return(i-t)*e+t},r.NormalizeRadians=function(e){return e-=r.TwoPi*Math.floor((e+Math.PI)/r.TwoPi),e},r.HCF=function(e,t){var i=e%t;return i===0?t:r.HCF(t,i)},r.TwoPi=Math.PI*2,r}();v();var xr=.45454545454545453,Pr=2.2,iE=(1+Math.sqrt(5))/2,ye=.001;v();var Be=function(){function r(){}return r.BuildArray=function(e,t){for(var i=[],n=0;n<e;++n)i.push(t());return i},r.BuildTuple=function(e,t){return r.BuildArray(e,t)},r}();v();var bl={};function Ke(r,e){bl[r]=e}function wt(r){return bl[r]}var de=function(){function r(e,t,i){e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=0),this.r=e,this.g=t,this.b=i}return r.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},r.prototype.getClassName=function(){return"Color3"},r.prototype.getHashCode=function(){var e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this},r.prototype.fromArray=function(e,t){return t===void 0&&(t=0),r.FromArrayToRef(e,t,this),this},r.prototype.toColor4=function(e){return e===void 0&&(e=1),new Ae(this.r,this.g,this.b,e)},r.prototype.asArray=function(){return[this.r,this.g,this.b]},r.prototype.toLuminance=function(){return this.r*.3+this.g*.59+this.b*.11},r.prototype.multiply=function(e){return new r(this.r*e.r,this.g*e.g,this.b*e.b)},r.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this},r.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},r.prototype.equalsFloats=function(e,t,i){return this.r===e&&this.g===t&&this.b===i},r.prototype.scale=function(e){return new r(this.r*e,this.g*e,this.b*e)},r.prototype.scaleInPlace=function(e){return this.r*=e,this.g*=e,this.b*=e,this},r.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this},r.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this},r.prototype.clampToRef=function(e,t,i){return e===void 0&&(e=0),t===void 0&&(t=1),i.r=ae.Clamp(this.r,e,t),i.g=ae.Clamp(this.g,e,t),i.b=ae.Clamp(this.b,e,t),this},r.prototype.add=function(e){return new r(this.r+e.r,this.g+e.g,this.b+e.b)},r.prototype.addToRef=function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this},r.prototype.subtract=function(e){return new r(this.r-e.r,this.g-e.g,this.b-e.b)},r.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this},r.prototype.clone=function(){return new r(this.r,this.g,this.b)},r.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},r.prototype.copyFromFloats=function(e,t,i){return this.r=e,this.g=t,this.b=i,this},r.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)},r.prototype.toHexString=function(){var e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+ae.ToHex(e)+ae.ToHex(t)+ae.ToHex(i)},r.prototype.toLinearSpace=function(){var e=new r;return this.toLinearSpaceToRef(e),e},r.prototype.toHSV=function(){var e=new r;return this.toHSVToRef(e),e},r.prototype.toHSVToRef=function(e){var t=this.r,i=this.g,n=this.b,o=Math.max(t,i,n),a=Math.min(t,i,n),s=0,f=0,u=o,l=o-a;o!==0&&(f=l/o),o!=a&&(o==t?(s=(i-n)/l,i<n&&(s+=6)):o==i?s=(n-t)/l+2:o==n&&(s=(t-i)/l+4),s*=60),e.r=s,e.g=f,e.b=u},r.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,Pr),e.g=Math.pow(this.g,Pr),e.b=Math.pow(this.b,Pr),this},r.prototype.toGammaSpace=function(){var e=new r;return this.toGammaSpaceToRef(e),e},r.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,xr),e.g=Math.pow(this.g,xr),e.b=Math.pow(this.b,xr),this},r.HSVtoRGBToRef=function(e,t,i,n){var o=i*t,a=e/60,s=o*(1-Math.abs(a%2-1)),f=0,u=0,l=0;a>=0&&a<=1?(f=o,u=s):a>=1&&a<=2?(f=s,u=o):a>=2&&a<=3?(u=o,l=s):a>=3&&a<=4?(u=s,l=o):a>=4&&a<=5?(f=s,l=o):a>=5&&a<=6&&(f=o,l=s);var h=i-o;n.set(f+h,u+h,l+h)},r.FromHSV=function(e,t,i){var n=new r(0,0,0);return r.HSVtoRGBToRef(e,t,i,n),n},r.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==7)return new r(0,0,0);var t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return r.FromInts(t,i,n)},r.FromArray=function(e,t){return t===void 0&&(t=0),new r(e[t],e[t+1],e[t+2])},r.FromArrayToRef=function(e,t,i){t===void 0&&(t=0),i.r=e[t],i.g=e[t+1],i.b=e[t+2]},r.FromInts=function(e,t,i){return new r(e/255,t/255,i/255)},r.Lerp=function(e,t,i){var n=new r(0,0,0);return r.LerpToRef(e,t,i,n),n},r.LerpToRef=function(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a,c=e.r*f+i.r*u+t.r*l+n.r*h,p=e.g*f+i.g*u+t.g*l+n.g*h,d=e.b*f+i.b*u+t.b*l+n.b*h;return new r(c,p,d)},r.Hermite1stDerivative=function(e,t,i,n,o){var a=r.Black();return this.Hermite1stDerivativeToRef(e,t,i,n,o,a),a},r.Hermite1stDerivativeToRef=function(e,t,i,n,o,a){var s=o*o;a.r=(s-o)*6*e.r+(3*s-4*o+1)*t.r+(-s+o)*6*i.r+(3*s-2*o)*n.r,a.g=(s-o)*6*e.g+(3*s-4*o+1)*t.g+(-s+o)*6*i.g+(3*s-2*o)*n.g,a.b=(s-o)*6*e.b+(3*s-4*o+1)*t.b+(-s+o)*6*i.b+(3*s-2*o)*n.b},r.Red=function(){return new r(1,0,0)},r.Green=function(){return new r(0,1,0)},r.Blue=function(){return new r(0,0,1)},r.Black=function(){return new r(0,0,0)},Object.defineProperty(r,"BlackReadOnly",{get:function(){return r._BlackReadOnly},enumerable:!1,configurable:!0}),r.White=function(){return new r(1,1,1)},r.Purple=function(){return new r(.5,0,.5)},r.Magenta=function(){return new r(1,0,1)},r.Yellow=function(){return new r(1,1,0)},r.Gray=function(){return new r(.5,.5,.5)},r.Teal=function(){return new r(0,1,1)},r.Random=function(){return new r(Math.random(),Math.random(),Math.random())},r._BlackReadOnly=r.Black(),r}();var Ae=function(){function r(e,t,i,n){e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=0),n===void 0&&(n=1),this.r=e,this.g=t,this.b=i,this.a=n}return r.prototype.addInPlace=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},r.prototype.asArray=function(){return[this.r,this.g,this.b,this.a]},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this},r.prototype.fromArray=function(e,t){return t===void 0&&(t=0),r.FromArrayToRef(e,t,this),this},r.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},r.prototype.add=function(e){return new r(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},r.prototype.subtract=function(e){return new r(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},r.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this},r.prototype.scale=function(e){return new r(this.r*e,this.g*e,this.b*e,this.a*e)},r.prototype.scaleInPlace=function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this},r.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this},r.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this},r.prototype.clampToRef=function(e,t,i){return e===void 0&&(e=0),t===void 0&&(t=1),i.r=ae.Clamp(this.r,e,t),i.g=ae.Clamp(this.g,e,t),i.b=ae.Clamp(this.b,e,t),i.a=ae.Clamp(this.a,e,t),this},r.prototype.multiply=function(e){return new r(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)},r.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t},r.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},r.prototype.getClassName=function(){return"Color4"},r.prototype.getHashCode=function(){var e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e},r.prototype.clone=function(){return new r(this.r,this.g,this.b,this.a)},r.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},r.prototype.copyFromFloats=function(e,t,i,n){return this.r=e,this.g=t,this.b=i,this.a=n,this},r.prototype.set=function(e,t,i,n){return this.copyFromFloats(e,t,i,n)},r.prototype.toHexString=function(e){e===void 0&&(e=!1);var t=Math.round(this.r*255),i=Math.round(this.g*255),n=Math.round(this.b*255);if(e)return"#"+ae.ToHex(t)+ae.ToHex(i)+ae.ToHex(n);var o=Math.round(this.a*255);return"#"+ae.ToHex(t)+ae.ToHex(i)+ae.ToHex(n)+ae.ToHex(o)},r.prototype.toLinearSpace=function(){var e=new r;return this.toLinearSpaceToRef(e),e},r.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,Pr),e.g=Math.pow(this.g,Pr),e.b=Math.pow(this.b,Pr),e.a=this.a,this},r.prototype.toGammaSpace=function(){var e=new r;return this.toGammaSpaceToRef(e),e},r.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,xr),e.g=Math.pow(this.g,xr),e.b=Math.pow(this.b,xr),e.a=this.a,this},r.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new r(0,0,0,0);var t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),o=e.length===9?parseInt(e.substring(7,9),16):255;return r.FromInts(t,i,n,o)},r.Lerp=function(e,t,i){var n=new r(0,0,0,0);return r.LerpToRef(e,t,i,n),n},r.LerpToRef=function(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i,n.a=e.a+(t.a-e.a)*i},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a,c=e.r*f+i.r*u+t.r*l+n.r*h,p=e.g*f+i.g*u+t.g*l+n.g*h,d=e.b*f+i.b*u+t.b*l+n.b*h,m=e.a*f+i.a*u+t.a*l+n.a*h;return new r(c,p,d,m)},r.Hermite1stDerivative=function(e,t,i,n,o){var a=new r;return this.Hermite1stDerivativeToRef(e,t,i,n,o,a),a},r.Hermite1stDerivativeToRef=function(e,t,i,n,o,a){var s=o*o;a.r=(s-o)*6*e.r+(3*s-4*o+1)*t.r+(-s+o)*6*i.r+(3*s-2*o)*n.r,a.g=(s-o)*6*e.g+(3*s-4*o+1)*t.g+(-s+o)*6*i.g+(3*s-2*o)*n.g,a.b=(s-o)*6*e.b+(3*s-4*o+1)*t.b+(-s+o)*6*i.b+(3*s-2*o)*n.b,a.a=(s-o)*6*e.a+(3*s-4*o+1)*t.a+(-s+o)*6*i.a+(3*s-2*o)*n.a},r.FromColor3=function(e,t){return t===void 0&&(t=1),new r(e.r,e.g,e.b,t)},r.FromArray=function(e,t){return t===void 0&&(t=0),new r(e[t],e[t+1],e[t+2],e[t+3])},r.FromArrayToRef=function(e,t,i){t===void 0&&(t=0),i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]},r.FromInts=function(e,t,i,n){return new r(e/255,t/255,i/255,n/255)},r.CheckColors4=function(e,t){if(e.length===t*3){for(var i=[],n=0;n<e.length;n+=3){var o=n/3*4;i[o]=e[n],i[o+1]=e[n+1],i[o+2]=e[n+2],i[o+3]=1}return i}return e},r}();var Li=function(){function r(){}return r.Color3=Be.BuildArray(3,de.Black),r.Color4=Be.BuildArray(3,function(){return new Ae(0,0,0,0)}),r}();Ke("BABYLON.Color3",de);Ke("BABYLON.Color4",Ae);v();v();v();var zl=He(Gl(),1),{__extends:Y,__assign:Vt,__rest:dE,__decorate:x,__param:pE,__metadata:_E,__awaiter:ii,__generator:Lt,__exportStar:vE,__createBinding:mE,__values:gE,__read:yE,__spread:bE,__spreadArrays:EE,__spreadArray:TE,__await:AE,__asyncGenerator:SE,__asyncDelegator:ME,__asyncValues:RE,__makeTemplateObject:xE,__importStar:PE,__importDefault:CE,__classPrivateFieldGet:IE,__classPrivateFieldSet:DE,__classPrivateFieldIn:OE}=zl.default;v();var sv=function(){function r(e,t,i,n){t===void 0&&(t=!1),this.initialize(e,t,i,n)}return r.prototype.initialize=function(e,t,i,n){return t===void 0&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=n,this},r}();var fv=function(){function r(e,t,i){i===void 0&&(i=null),this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}return r}();var wE=function(){function r(){}return r.prototype.dispose=function(){if(this._observers&&this._observables)for(var e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null},r.Watch=function(e,t,i,n){i===void 0&&(i=-1),n===void 0&&(n=null);var o=new r;o._observers=new Array,o._observables=e;for(var a=0,s=e;a<s.length;a++){var f=s[a],u=f.add(t,i,!1,n);u&&o._observers.push(u)}return o},r}();var U=function(){function r(e){this._observers=new Array,this._eventState=new sv(0),e&&(this._onObserverAdded=e)}return r.FromPromise=function(e,t){var i=new r;return e.then(function(n){i.notifyObservers(n)}).catch(function(n){if(t)t.notifyObservers(n);else throw n}),i},Object.defineProperty(r.prototype,"observers",{get:function(){return this._observers},enumerable:!1,configurable:!0}),r.prototype.add=function(e,t,i,n,o){if(t===void 0&&(t=-1),i===void 0&&(i=!1),n===void 0&&(n=null),o===void 0&&(o=!1),!e)return null;var a=new fv(e,t,n);return a.unregisterOnNextCall=o,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),a},r.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},r.prototype.remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return t!==-1?(this._deferUnregister(e),!0):!1},r.prototype.removeCallback=function(e,t){for(var i=0;i<this._observers.length;i++){var n=this._observers[i];if(!n._willBeUnregistered&&n.callback===e&&(!t||t===n.scope))return this._deferUnregister(n),!0}return!1},r.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(function(){t._remove(e)},0)},r.prototype._remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return t!==-1?(this._observers.splice(t,1),!0):!1},r.prototype.makeObserverTopPriority=function(e){this._remove(e),this._observers.unshift(e)},r.prototype.makeObserverBottomPriority=function(e){this._remove(e),this._observers.push(e)},r.prototype.notifyObservers=function(e,t,i,n,o){if(t===void 0&&(t=-1),!this._observers.length)return!0;var a=this._eventState;a.mask=t,a.target=i,a.currentTarget=n,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=o;for(var s=0,f=this._observers;s<f.length;s++){var u=f[s];if(!u._willBeUnregistered&&(u.mask&t&&(u.scope?a.lastReturnValue=u.callback.apply(u.scope,[e,a]):a.lastReturnValue=u.callback(e,a),u.unregisterOnNextCall&&this._deferUnregister(u)),a.skipNextObservers))return!1}return!0},r.prototype.notifyObserversWithPromise=function(e,t,i,n,o){var a=this;t===void 0&&(t=-1);var s=Promise.resolve(e);if(!this._observers.length)return s;var f=this._eventState;return f.mask=t,f.target=i,f.currentTarget=n,f.skipNextObservers=!1,f.userInfo=o,this._observers.forEach(function(u){f.skipNextObservers||u._willBeUnregistered||u.mask&t&&(u.scope?s=s.then(function(l){return f.lastReturnValue=l,u.callback.apply(u.scope,[e,f])}):s=s.then(function(l){return f.lastReturnValue=l,u.callback(e,f)}),u.unregisterOnNextCall&&a._deferUnregister(u))}),s.then(function(){return e})},r.prototype.notifyObserver=function(e,t,i){if(i===void 0&&(i=-1),!e._willBeUnregistered){var n=this._eventState;n.mask=i,n.skipNextObservers=!1,e.callback(t,n),e.unregisterOnNextCall&&this._deferUnregister(e)}},r.prototype.hasObservers=function(){return this._observers.length>0},r.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},r.prototype.clone=function(){var e=new r;return e._observers=this._observers.slice(0),e},r.prototype.hasSpecificMask=function(e){e===void 0&&(e=-1);for(var t=0,i=this._observers;t<i.length;t++){var n=i[t];if(n.mask&e||n.mask===e)return!0}return!1},r}();v();v();function Me(){return typeof window!="undefined"}function da(){return typeof navigator!="undefined"}function ni(){return typeof document!="undefined"}function Bi(r){for(var e="",t=r.firstChild;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}var Ni={IsWindowObjectExist:Me,IsNavigatorAvailable:da,IsDocumentAvailable:ni,GetDOMTextContent:Bi};v();var q=function(){function r(){}return r._CheckLimit=function(e,t){var i=r._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},r._LogLimitOutputs[e]=i),i.current<=i.limit},r._GenerateLimitMessage=function(e,t){var i=r._LogLimitOutputs[e];if(!(!i||!r.MessageLimitReached)&&i.current===i.limit)switch(t){case 0:r.Log(r.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,"log"));break;case 1:r.Warn(r.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,"warning"));break;case 2:r.Error(r.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,"error"));break}},r._AddLogEntry=function(e){r._LogCache=e+r._LogCache,r.OnNewCacheEntry&&r.OnNewCacheEntry(e)},r._FormatMessage=function(e){var t=function(n){return n<10?"0"+n:""+n},i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e},r._LogDisabled=function(e,t){},r._LogEnabled=function(e,t){if(!(t!==void 0&&!r._CheckLimit(e,t))){var i=r._FormatMessage(e);console.log("BJS - "+i);var n="<div style='color:white'>"+i+"</div><br>";r._AddLogEntry(n),r._GenerateLimitMessage(e,0)}},r._WarnDisabled=function(e,t){},r._WarnEnabled=function(e,t){if(!(t!==void 0&&!r._CheckLimit(e,t))){var i=r._FormatMessage(e);console.warn("BJS - "+i);var n="<div style='color:orange'>"+e+"</div><br>";r._AddLogEntry(n),r._GenerateLimitMessage(e,1)}},r._ErrorDisabled=function(e,t){},r._ErrorEnabled=function(e,t){if(!(t!==void 0&&!r._CheckLimit(e,t))){var i=r._FormatMessage(e);r.errorsCount++,console.error("BJS - "+i);var n="<div style='color:red'>"+i+"</div><br>";r._AddLogEntry(n),r._GenerateLimitMessage(e,2)}},Object.defineProperty(r,"LogCache",{get:function(){return r._LogCache},enumerable:!1,configurable:!0}),r.ClearLogCache=function(){r._LogCache="",r._LogLimitOutputs={},r.errorsCount=0},Object.defineProperty(r,"LogLevels",{set:function(e){(e&r.MessageLogLevel)===r.MessageLogLevel?r.Log=r._LogEnabled:r.Log=r._LogDisabled,(e&r.WarningLogLevel)===r.WarningLogLevel?r.Warn=r._WarnEnabled:r.Warn=r._WarnDisabled,(e&r.ErrorLogLevel)===r.ErrorLogLevel?r.Error=r._ErrorEnabled:r.Error=r._ErrorDisabled},enumerable:!1,configurable:!0}),r.NoneLogLevel=0,r.MessageLogLevel=1,r.WarningLogLevel=2,r.ErrorLogLevel=4,r.AllLogLevel=7,r.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",r._LogCache="",r._LogLimitOutputs={},r.errorsCount=0,r.Log=r._LogEnabled,r.Warn=r._WarnEnabled,r.Error=r._ErrorEnabled,r}();v();var Xl=function(r,e){return!r||r.getClassName&&r.getClassName()==="Mesh"?null:r.getClassName&&r.getClassName()==="SubMesh"?r.clone(e):r.clone?r.clone():null};function uv(r){var e=[];do Object.getOwnPropertyNames(r).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(r=Object.getPrototypeOf(r));return e}var oi=function(){function r(){}return r.DeepCopy=function(e,t,i,n){for(var o=uv(e),a=0,s=o;a<s.length;a++){var f=s[a];if(!(f[0]==="_"&&(!n||n.indexOf(f)===-1))&&!f.endsWith("Observable")&&!(i&&i.indexOf(f)!==-1)){var u=e[f],l=typeof u;if(l!=="function")try{if(l==="object")if(u instanceof Array){if(t[f]=[],u.length>0)if(typeof u[0]=="object")for(var h=0;h<u.length;h++){var c=Xl(u[h],t);t[f].indexOf(c)===-1&&t[f].push(c)}else t[f]=u.slice(0)}else t[f]=Xl(u,t);else t[f]=u}catch(p){q.Warn(p.message)}}}},r}();v();var Wt=function(){function r(){}return Object.defineProperty(r,"Now",{get:function(){return Ni.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()},enumerable:!1,configurable:!0}),r}();v();function Q(r){return"".concat(r," needs to be imported before as it contains a side-effect required by your code.")}v();function lv(){return typeof _native!="undefined"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var er=function(){function r(){this._xhr=lv(),this._requestURL=""}return r.prototype._injectCustomRequestHeaders=function(){if(!this._shouldSkipRequestModifications(this._requestURL))for(var e in r.CustomRequestHeaders){var t=r.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}},r.prototype._shouldSkipRequestModifications=function(e){return r.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))},Object.defineProperty(r.prototype,"onprogress",{get:function(){return this._xhr.onprogress},set:function(e){this._xhr.onprogress=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"readyState",{get:function(){return this._xhr.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"status",{get:function(){return this._xhr.status},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"statusText",{get:function(){return this._xhr.statusText},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"response",{get:function(){return this._xhr.response},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"responseURL",{get:function(){return this._xhr.responseURL},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"responseText",{get:function(){return this._xhr.responseText},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"responseType",{get:function(){return this._xhr.responseType},set:function(e){this._xhr.responseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"timeout",{get:function(){return this._xhr.timeout},set:function(e){this._xhr.timeout=e},enumerable:!1,configurable:!0}),r.prototype.addEventListener=function(e,t,i){this._xhr.addEventListener(e,t,i)},r.prototype.removeEventListener=function(e,t,i){this._xhr.removeEventListener(e,t,i)},r.prototype.abort=function(){this._xhr.abort()},r.prototype.send=function(e){r.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)},r.prototype.open=function(e,t){for(var i=0,n=r.CustomRequestModifiers;i<n.length;i++){var o=n[i];if(this._shouldSkipRequestModifications(t))return;o(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)},r.prototype.setRequestHeader=function(e,t){this._xhr.setRequestHeader(e,t)},r.prototype.getResponseHeader=function(e){return this._xhr.getResponseHeader(e)},r.CustomRequestHeaders={},r.CustomRequestModifiers=new Array,r.SkipRequestModificationForBabylonCDN=!0,r}();v();var le=function(){function r(){}return Object.defineProperty(r,"LastCreatedEngine",{get:function(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),r.Instances=new Array,r._LastCreatedScene=null,r.UseFallbackTexture=!0,r.FallbackTexture="",r}();v();v();var Ui=function(){function r(){}return r.FilesToLoad={},r}();v();var Hl=function(){function r(){}return r.ExponentialBackoff=function(e,t){return e===void 0&&(e=3),t===void 0&&(t=500),function(i,n,o){return n.status!==0||o>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,o)*t}},r}();v();var ai=function(r){Y(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e._setPrototypeOf=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t},e}(Error);var si={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},fi=function(r){Y(e,r);function e(t,i,n){var o=r.call(this,t)||this;return o.errorCode=i,o.innerError=n,o.name="RuntimeError",ai._setPrototypeOf(o,e.prototype),o}return e}(ai);v();var On=function(r){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="",i,n,o,a,s,f,u,l=0,h=ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r);l<h.length;)i=h[l++],n=l<h.length?h[l++]:Number.NaN,o=l<h.length?h[l++]:Number.NaN,a=i>>2,s=(i&3)<<4|n>>4,f=(n&15)<<2|o>>6,u=o&63,isNaN(n)?f=u=64:isNaN(o)&&(u=64),t+=e.charAt(a)+e.charAt(s)+e.charAt(f)+e.charAt(u);return t},pa=function(r){return atob(r)},Kl=function(r){for(var e=pa(r),t=e.length,i=new Uint8Array(new ArrayBuffer(t)),n=0;n<t;n++)i[n]=e.charCodeAt(n);return i.buffer};v();v();var cr=function(){function r(){this.children=[]}return r.prototype.isValid=function(e){return!0},r.prototype.process=function(e,t){var i="";if(this.line){var n=this.line,o=t.processor;if(o){if(o.lineProcessor&&(n=o.lineProcessor(n,t.isFragment,t.processingContext)),o.attributeProcessor&&this.line.startsWith("attribute"))n=o.attributeProcessor(this.line,e,t.processingContext);else if(o.varyingProcessor&&this.line.startsWith("varying"))n=o.varyingProcessor(this.line,t.isFragment,e,t.processingContext);else if(o.uniformProcessor&&o.uniformRegexp&&o.uniformRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=o.uniformProcessor(this.line,t.isFragment,e,t.processingContext));else if(o.uniformBufferProcessor&&o.uniformBufferRegexp&&o.uniformBufferRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=o.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0);else if(o.textureProcessor&&o.textureRegexp&&o.textureRegexp.test(this.line))n=o.textureProcessor(this.line,t.isFragment,e,t.processingContext);else if((o.uniformProcessor||o.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer){var a=/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/;a.test(this.line)?o.uniformProcessor&&(n=o.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):o.uniformBufferProcessor&&(n=o.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)}t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,o.endOfUniformBufferProcessor&&(n=o.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=n+`\r
`}return this.children.forEach(function(s){i+=s.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i},r}();v();var jl=function(){function r(){this._lines=[]}return Object.defineProperty(r.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lines",{set:function(e){this._lines.length=0;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(n[0]==="#"){this._lines.push(n);continue}if(n.trim().startsWith("//")){this._lines.push(n);continue}for(var o=n.split(";"),a=0;a<o.length;a++){var s=o[a];s=s.trim(),s&&this._lines.push(s+(a!==o.length-1?";":""))}}},enumerable:!1,configurable:!0}),r}();v();var Fn=function(r){Y(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.process=function(t,i){for(var n=0;n<this.children.length;n++){var o=this.children[n];if(o.isValid(t))return o.process(t,i)}return""},e}(cr);v();var Yl=function(r){Y(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isValid=function(t){return this.testExpression.isTrue(t)},e}(cr);v();v();var Gt=function(){function r(){}return r.prototype.isTrue=function(e){return!0},r.postfixToInfix=function(e){for(var t=[],i=0,n=e;i<n.length;i++){var o=n[i];if(r._OperatorPriority[o]===void 0)t.push(o);else{var a=t[t.length-1],s=t[t.length-2];t.length-=2,t.push("(".concat(s).concat(o).concat(a,")"))}}return t[t.length-1]},r.infixToPostfix=function(e){for(var t=[],i=-1,n=function(){u=u.trim(),u!==""&&(t.push(u),u="")},o=function(c){i<r._Stack.length-1&&(r._Stack[++i]=c)},a=function(){return r._Stack[i]},s=function(){return i===-1?"!!INVALID EXPRESSION!!":r._Stack[i--]},f=0,u="";f<e.length;){var l=e.charAt(f),h=f<e.length-1?e.substr(f,2):"";if(l==="(")u="",o(l);else if(l===")"){for(n();i!==-1&&a()!=="(";)t.push(s());s()}else if(r._OperatorPriority[h]>1){for(n();i!==-1&&r._OperatorPriority[a()]>=r._OperatorPriority[h];)t.push(s());o(h),f++}else u+=l;f++}for(n();i!==-1;)a()==="("?s():t.push(s());return t},r._OperatorPriority={")":0,"(":1,"||":2,"&&":3},r._Stack=["","","","","","","","","","","","","","","","","","","",""],r}();var ki=function(r){Y(e,r);function e(t,i){i===void 0&&(i=!1);var n=r.call(this)||this;return n.define=t,n.not=i,n}return e.prototype.isTrue=function(t){var i=t[this.define]!==void 0;return this.not&&(i=!i),i},e}(Gt);v();var ql=function(r){Y(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)},e}(Gt);v();var Zl=function(r){Y(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)},e}(Gt);v();var Ql=function(r){Y(e,r);function e(t,i,n){var o=r.call(this)||this;return o.define=t,o.operand=i,o.testValue=n,o}return e.prototype.isTrue=function(t){var i=t[this.define];i===void 0&&(i=this.define);var n=!1,o=parseInt(i),a=parseInt(this.testValue);switch(this.operand){case">":n=o>a;break;case"<":n=o<a;break;case"<=":n=o<=a;break;case">=":n=o>=a;break;case"==":n=o===a;break}return n},e}(Gt);v();var we;(function(r){r[r.GLSL=0]="GLSL",r[r.WGSL=1]="WGSL"})(we||(we={}));var hv=/defined\s*?\((.+?)\)/g,_a=/defined\s*?\[(.+?)\]/g,Jl=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,Cr=function(){function r(){}return r.Initialize=function(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)},r.Process=function(e,t,i,n){var o=this,a;!((a=t.processor)===null||a===void 0)&&a.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(s){t.processCodeAfterIncludes&&(s=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",s));var f=o._ProcessShaderConversion(s,t,n);i(f)})},r.PreProcess=function(e,t,i,n){var o=this,a;!((a=t.processor)===null||a===void 0)&&a.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(s){t.processCodeAfterIncludes&&(s=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",s));var f=o._ApplyPreProcessing(s,t,n);i(f)})},r.Finalize=function(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)},r._ProcessPrecision=function(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;var n=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?n?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:n||(e=e.replace("precision highp float","precision mediump float")),e},r._ExtractOperation=function(e){var t=/defined\((.+)\)/,i=t.exec(e);if(i&&i.length)return new ki(i[1].trim(),e[0]==="!");for(var n=["==",">=","<=","<",">"],o="",a=0,s=0,f=n;s<f.length&&(o=f[s],a=e.indexOf(o),!(a>-1));s++);if(a===-1)return new ki(e);var u=e.substring(0,a).trim(),l=e.substring(a+o.length).trim();return new Ql(u,o,l)},r._BuildSubExpression=function(e){e=e.replace(hv,"defined[$1]");for(var t=Gt.infixToPostfix(e),i=[],n=0,o=t;n<o.length;n++){var a=o[n];if(a!=="||"&&a!=="&&")i.push(a);else if(i.length>=2){var s=i[i.length-1],f=i[i.length-2];i.length-=2;var u=a=="&&"?new Zl:new ql;typeof s=="string"&&(s=s.replace(_a,"defined($1)")),typeof f=="string"&&(f=f.replace(_a,"defined($1)")),u.leftOperand=typeof f=="string"?this._ExtractOperation(f):f,u.rightOperand=typeof s=="string"?this._ExtractOperation(s):s,i.push(u)}}var l=i[i.length-1];return typeof l=="string"&&(l=l.replace(_a,"defined($1)")),typeof l=="string"?this._ExtractOperation(l):l},r._BuildExpression=function(e,t){var i=new Yl,n=e.substring(0,t),o=e.substring(t);return o=o.substring(0,(o.indexOf("//")+1||o.length+1)-1).trim(),n==="#ifdef"?i.testExpression=new ki(o):n==="#ifndef"?i.testExpression=new ki(o,!0):i.testExpression=this._BuildSubExpression(o),i},r._MoveCursorWithinIf=function(e,t,i){for(var n=e.currentLine;this._MoveCursor(e,i);){n=e.currentLine;var o=n.substring(0,5).toLowerCase();if(o==="#else"){var a=new cr;t.children.push(a),this._MoveCursor(e,a);return}else if(o==="#elif"){var s=this._BuildExpression(n,5);t.children.push(s),i=s}}},r._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var i=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/,o=n.exec(i);if(o&&o.length){var a=o[0];switch(a){case"#ifdef":{var s=new Fn;t.children.push(s);var f=this._BuildExpression(i,6);s.children.push(f),this._MoveCursorWithinIf(e,s,f);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{var s=new Fn;t.children.push(s);var f=this._BuildExpression(i,7);s.children.push(f),this._MoveCursorWithinIf(e,s,f);break}case"#if":{var s=new Fn,f=this._BuildExpression(i,3);t.children.push(s),s.children.push(f),this._MoveCursorWithinIf(e,s,f);break}}}else{var u=new cr;if(u.line=i,t.children.push(u),i[0]==="#"&&i[1]==="d"){var l=i.replace(";","").split(" ");u.additionalDefineKey=l[1],l.length===3&&(u.additionalDefineValue=l[2])}}}return!1},r._EvaluatePreProcessors=function(e,t,i){var n=new cr,o=new jl;return o.lineIndex=-1,o.lines=e.split(`
`),this._MoveCursor(o,n),n.process(t,i)},r._PreparePreProcessors=function(e,t){for(var i,n=e.defines,o={},a=0,s=n;a<s.length;a++){var f=s[a],u=f.replace("#define","").replace(";","").trim(),l=u.split(" ");o[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===we.GLSL&&(o.GL_ES="true"),o.__VERSION__=e.version,o[e.platformName]="true",t._getGlobalDefines(o),o},r._ProcessShaderConversion=function(e,t,i){var n=this._ProcessPrecision(e,t);if(!t.processor)return n;if(t.processor.shaderLanguage===we.GLSL&&n.indexOf("#version 3")!==-1)return n.replace("#version 300 es","");var o=t.defines,a=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,o,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,a,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n},r._ApplyPreProcessing=function(e,t,i){var n,o,a=e,s=t.defines,f=this._PreparePreProcessors(t,i);return!((n=t.processor)===null||n===void 0)&&n.preProcessor&&(a=t.processor.preProcessor(a,s,t.isFragment,t.processingContext)),a=this._EvaluatePreProcessors(a,f,t),!((o=t.processor)===null||o===void 0)&&o.postProcessor&&(a=t.processor.postProcessor(a,s,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(a=i.inlineShaderCode(a)),a},r._ProcessIncludes=function(e,t,i){for(var n=this,o=Jl.exec(e),a=new String(e),s=!1,f=function(){var l=o[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(/__decl__/,""),t.supportsUniformBuffers&&(l=l.replace(/Vertex/,"Ubo"),l=l.replace(/Fragment/,"Ubo")),l=l+"Declaration"),t.includesShadersStore[l]){var h=t.includesShadersStore[l];if(o[2])for(var c=o[3].split(","),p=0;p<c.length;p+=2){var d=new RegExp(c[p],"g"),m=c[p+1];h=h.replace(d,m)}if(o[4]){var _=o[5];if(_.indexOf("..")!==-1){var y=_.split(".."),g=parseInt(y[0]),T=parseInt(y[1]),A=h.slice(0);h="",isNaN(T)&&(T=t.indexParameters[y[1]]);for(var M=g;M<T;M++)t.supportsUniformBuffers||(A=A.replace(/light\{X\}.(\w*)/g,function(P,R){return R+"{X}"})),h+=A.replace(/\{X\}/g,M.toString())+`
`}else t.supportsUniformBuffers||(h=h.replace(/light\{X\}.(\w*)/g,function(P,R){return R+"{X}"})),h=h.replace(/\{X\}/g,_)}a=a.replace(o[0],h),s=s||h.indexOf("#include<")>=0||h.indexOf("#include <")>=0}else{var C=t.shadersRepository+"ShadersInclude/"+l+".fx";return r._FileToolsLoadFile(C,function(P){t.includesShadersStore[l]=P,n._ProcessIncludes(a,t,i)}),{value:void 0}}o=Jl.exec(e)};o!=null;){var u=f();if(typeof u=="object")return u.value}s?this._ProcessIncludes(a.toString(),t,i):i(a)},r._FileToolsLoadFile=function(e,t,i,n,o,a){throw Q("FileTools")},r}();v();v();v();var N=function(){function r(){}return r.GetShadersRepository=function(e){return e===void 0&&(e=we.GLSL),e===we.GLSL?r.ShadersRepository:r.ShadersRepositoryWGSL},r.GetShadersStore=function(e){return e===void 0&&(e=we.GLSL),e===we.GLSL?r.ShadersStore:r.ShadersStoreWGSL},r.GetIncludesShadersStore=function(e){return e===void 0&&(e=we.GLSL),e===we.GLSL?r.IncludesShadersStore:r.IncludesShadersStoreWGSL},r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={},r}();var ui=function(){function r(e,t,i,n,o,a,s,f,u,l,h,c){n===void 0&&(n=null),a===void 0&&(a=null),s===void 0&&(s=null),f===void 0&&(f=null),u===void 0&&(u=null),h===void 0&&(h=""),c===void 0&&(c=we.GLSL);var p=this,d,m,_;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new U,this.onErrorObservable=new U,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=h;var y=void 0,g=null;if(t.attributes){var T=t;if(this._engine=i,this._attributesNames=T.attributes,this._uniformsNames=T.uniformsNames.concat(T.samplers),this._samplerList=T.samplers.slice(),this.defines=T.defines,this.onError=T.onError,this.onCompiled=T.onCompiled,this._fallbacks=T.fallbacks,this._indexParameters=T.indexParameters,this._transformFeedbackVaryings=T.transformFeedbackVaryings||null,this._multiTarget=!!T.multiTarget,this._shaderLanguage=(d=T.shaderLanguage)!==null&&d!==void 0?d:we.GLSL,T.uniformBuffersNames){this._uniformBuffersNamesList=T.uniformBuffersNames.slice();for(var A=0;A<T.uniformBuffersNames.length;A++)this._uniformBuffersNames[T.uniformBuffersNames[A]]=A}g=(m=T.processFinalCode)!==null&&m!==void 0?m:null,y=(_=T.processCodeAfterIncludes)!==null&&_!==void 0?_:void 0}else this._engine=o,this.defines=a==null?"":a,this._uniformsNames=i.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=c,this.onError=u,this.onCompiled=f,this._indexParameters=l,this._fallbacks=s;this._attributeLocationByName={},this.uniqueId=r._UniqueIdSeed++;var M,C,P=Me()?this._engine.getHostDocument():null;e.vertexSource?M="source:"+e.vertexSource:e.vertexElement?(M=P?P.getElementById(e.vertexElement):null,M||(M=e.vertexElement)):M=e.vertex||e,e.fragmentSource?C="source:"+e.fragmentSource:e.fragmentElement?(C=P?P.getElementById(e.fragmentElement):null,C||(C=e.fragmentElement)):C=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);var R={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:N.GetShadersRepository(this._shaderLanguage),includesShadersStore:N.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:y},F=[void 0,void 0],I=function(){if(F[0]&&F[1]){R.isFragment=!0;var D=F[0],V=F[1];Cr.Process(V,R,function(k){g&&(k=g("fragment",k));var w=Cr.Finalize(D,k,R);p._useFinalCode(w.vertexCode,w.fragmentCode,e)},p._engine)}};this._loadShader(M,"Vertex","",function(D){Cr.Initialize(R),Cr.Process(D,R,function(V){p._rawVertexSourceCode=D,g&&(V=g("vertex",V)),F[0]=V,I()},p._engine)}),this._loadShader(C,"Fragment","Pixel",function(D){p._rawFragmentSourceCode=D,F[1]=D,I()})}return Object.defineProperty(r,"ShadersRepository",{get:function(){return N.ShadersRepository},set:function(e){N.ShadersRepository=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new U),this._onBindObservable},enumerable:!1,configurable:!0}),r.prototype._useFinalCode=function(e,t,i){if(i){var n=i.vertexElement||i.vertex||i.spectorName||i,o=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===we.WGSL?"//":"")+"#define SHADER_NAME vertex:"+n+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===we.WGSL?"//":"")+"#define SHADER_NAME fragment:"+o+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()},Object.defineProperty(r.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),r.prototype.isReady=function(){try{return this._isReadyInternal()}catch(e){return!1}},r.prototype._isReadyInternal=function(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1},r.prototype.getEngine=function(){return this._engine},r.prototype.getPipelineContext=function(){return this._pipelineContext},r.prototype.getAttributesNames=function(){return this._attributesNames},r.prototype.getAttributeLocation=function(e){return this._attributes[e]},r.prototype.getAttributeLocationByName=function(e){return this._attributeLocationByName[e]},r.prototype.getAttributesCount=function(){return this._attributes.length},r.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},r.prototype.getUniform=function(e){return this._uniforms[e]},r.prototype.getSamplers=function(){return this._samplerList},r.prototype.getUniformNames=function(){return this._uniformsNames},r.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},r.prototype.getIndexParameters=function(){return this._indexParameters},r.prototype.getCompilationError=function(){return this._compilationError},r.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},r.prototype.executeWhenCompiled=function(e){var t=this;if(this.isReady()){e(this);return}this.onCompileObservable.add(function(i){e(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(function(){t._checkIsReady(null)},16)},r.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(i){this._processCompilationErrors(i,e);return}this._isDisposed||setTimeout(function(){t._checkIsReady(e)},16)},r.prototype._loadShader=function(e,t,i,n){if(typeof HTMLElement!="undefined"&&e instanceof HTMLElement){var o=Bi(e);n(o);return}if(e.substr(0,7)==="source:"){n(e.substr(7));return}if(e.substr(0,7)==="base64:"){var a=window.atob(e.substr(7));n(a);return}var s=N.GetShadersStore(this._shaderLanguage);if(s[e+t+"Shader"]){n(s[e+t+"Shader"]);return}if(i&&s[e+i+"Shader"]){n(s[e+i+"Shader"]);return}var f;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?f=e:f=N.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(f+"."+t.toLowerCase()+".fx",n)},Object.defineProperty(r.prototype,"vertexSourceCode",{get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fragmentSourceCode",{get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),r.prototype._rebuildProgram=function(e,t,i,n){var o=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(a,s){n&&n(s)},this.onCompiled=function(){var a=o.getEngine().scenes;if(a)for(var s=0;s<a.length;s++)a[s].markAllMaterialsAsDirty(63);o._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()},r.prototype._prepareEffect=function(){var e=this,t=this._attributesNames,i=this.defines,n=this._pipelineContext;this._isReady=!1;try{var o=this._engine;this._pipelineContext=o.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;var a=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?o._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,null,this._transformFeedbackVaryings,this._key):o._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,i,this._transformFeedbackVaryings,this._key),o._executeWhenRenderingStateIsCompiled(this._pipelineContext,function(){if(e._attributes=[],e._pipelineContext._fillEffectInformation(e,e._uniformBuffersNames,e._uniformsNames,e._uniforms,e._samplerList,e._samplers,t,e._attributes),t)for(var s=0;s<t.length;s++){var f=t[s];e._attributeLocationByName[f]=e._attributes[s]}o.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),n&&e.getEngine()._deletePipelineContext(n)}),this._pipelineContext.isAsync&&this._checkIsReady(n)}catch(s){this._processCompilationErrors(s,n)}},r.prototype._getShaderCodeAndErrorLine=function(e,t,i){var n=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,o=null;if(t&&e){var a=t.match(n);if(a&&a.length===2){var s=parseInt(a[1]),f=e.split(`
`,-1);f.length>=s&&(o="Offending line [".concat(s,"] in ").concat(i?"fragment":"vertex"," code: ").concat(f[s-1]))}}return[e,o]},r.prototype._processCompilationErrors=function(e,t){var i,n,o,a,s;t===void 0&&(t=null),this._compilationError=e.message;var f=this._attributesNames,u=this._fallbacks;if(q.Error("Unable to compile effect:"),q.Error("Uniforms: "+this._uniformsNames.map(function(p){return" "+p})),q.Error("Attributes: "+f.map(function(p){return" "+p})),q.Error(`Defines:\r
`+this.defines),r.LogShaderCodeOnCompilationError){var l=null,h=null,c=null;!((o=this._pipelineContext)===null||o===void 0)&&o._getVertexShaderCode()&&(i=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),c=i[0],l=i[1],c&&(q.Error("Vertex code:"),q.Error(c))),!((a=this._pipelineContext)===null||a===void 0)&&a._getFragmentShaderCode()&&(n=this._getShaderCodeAndErrorLine((s=this._pipelineContext)===null||s===void 0?void 0:s._getFragmentShaderCode(),this._compilationError,!0),c=n[0],h=n[1],c&&(q.Error("Fragment code:"),q.Error(c))),l&&q.Error(l),h&&q.Error(h)}q.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),u?(this._pipelineContext=null,u.hasMoreFallbacks?(this._allFallbacksProcessed=!1,q.Error("Trying next fallback."),this.defines=u.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(r.prototype,"isSupported",{get:function(){return this._compilationError===""},enumerable:!1,configurable:!0}),r.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers[e],t,e)},r.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)},r.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)},r.prototype.setTextureArray=function(e,t){var i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){for(var n=this._samplerList.indexOf(e),o=1;o<t.length;o++){var a=i+(o-1).toString();this._samplerList.splice(n+o,0,a)}for(var s=0,f=0,u=this._samplerList;f<u.length;f++){var l=u[f];this._samplers[l]=s,s+=1}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)},r.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},r.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)},r.prototype.bindUniformBuffer=function(e,t){var i=this._uniformBuffersNames[t];i===void 0||r._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(r._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))},r.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)},r.prototype.setInt=function(e,t){return this._pipelineContext.setInt(e,t),this},r.prototype.setInt2=function(e,t,i){return this._pipelineContext.setInt2(e,t,i),this},r.prototype.setInt3=function(e,t,i,n){return this._pipelineContext.setInt3(e,t,i,n),this},r.prototype.setInt4=function(e,t,i,n,o){return this._pipelineContext.setInt4(e,t,i,n,o),this},r.prototype.setIntArray=function(e,t){return this._pipelineContext.setIntArray(e,t),this},r.prototype.setIntArray2=function(e,t){return this._pipelineContext.setIntArray2(e,t),this},r.prototype.setIntArray3=function(e,t){return this._pipelineContext.setIntArray3(e,t),this},r.prototype.setIntArray4=function(e,t){return this._pipelineContext.setIntArray4(e,t),this},r.prototype.setFloatArray=function(e,t){return this._pipelineContext.setArray(e,t),this},r.prototype.setFloatArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},r.prototype.setFloatArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},r.prototype.setFloatArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},r.prototype.setArray=function(e,t){return this._pipelineContext.setArray(e,t),this},r.prototype.setArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},r.prototype.setArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},r.prototype.setArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},r.prototype.setMatrices=function(e,t){return this._pipelineContext.setMatrices(e,t),this},r.prototype.setMatrix=function(e,t){return this._pipelineContext.setMatrix(e,t),this},r.prototype.setMatrix3x3=function(e,t){return this._pipelineContext.setMatrix3x3(e,t),this},r.prototype.setMatrix2x2=function(e,t){return this._pipelineContext.setMatrix2x2(e,t),this},r.prototype.setFloat=function(e,t){return this._pipelineContext.setFloat(e,t),this},r.prototype.setBool=function(e,t){return this._pipelineContext.setInt(e,t?1:0),this},r.prototype.setVector2=function(e,t){return this._pipelineContext.setVector2(e,t),this},r.prototype.setFloat2=function(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this},r.prototype.setVector3=function(e,t){return this._pipelineContext.setVector3(e,t),this},r.prototype.setFloat3=function(e,t,i,n){return this._pipelineContext.setFloat3(e,t,i,n),this},r.prototype.setVector4=function(e,t){return this._pipelineContext.setVector4(e,t),this},r.prototype.setQuaternion=function(e,t){return this._pipelineContext.setQuaternion(e,t),this},r.prototype.setFloat4=function(e,t,i,n,o){return this._pipelineContext.setFloat4(e,t,i,n,o),this},r.prototype.setColor3=function(e,t){return this._pipelineContext.setColor3(e,t),this},r.prototype.setColor4=function(e,t,i){return this._pipelineContext.setColor4(e,t,i),this},r.prototype.setDirectColor4=function(e,t){return this._pipelineContext.setDirectColor4(e,t),this},r.prototype.dispose=function(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0},r.RegisterShader=function(e,t,i,n){n===void 0&&(n=we.GLSL),t&&(N.GetShadersStore(n)["".concat(e,"PixelShader")]=t),i&&(N.GetShadersStore(n)["".concat(e,"VertexShader")]=i)},r.ResetCache=function(){r._BaseCache={}},r.LogShaderCodeOnCompilationError=!0,r._UniqueIdSeed=0,r._BaseCache={},r.ShadersStore=N.ShadersStore,r.IncludesShadersStore=N.IncludesShadersStore,r}();v();var $l=function(){function r(e){e===void 0&&(e=!0),this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}return Object.defineProperty(r.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"zOffsetUnits",{get:function(){return this._zOffsetUnits},set:function(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!1,configurable:!0}),r.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1},r.prototype.apply=function(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},r}();v();var eh=function(){function r(){this.reset()}return r.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=r.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=r.KEEP,this.opDepthFail=r.KEEP,this.opStencilDepthPass=r.REPLACE},Object.defineProperty(r.prototype,"stencilFunc",{get:function(){return this.func},set:function(e){this.func=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilFuncRef",{get:function(){return this.funcRef},set:function(e){this.funcRef=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilFuncMask",{get:function(){return this.funcMask},set:function(e){this.funcMask=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilOpStencilFail",{get:function(){return this.opStencilFail},set:function(e){this.opStencilFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilOpDepthFail",{get:function(){return this.opDepthFail},set:function(e){this.opDepthFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilOpStencilDepthPass",{get:function(){return this.opStencilDepthPass},set:function(e){this.opStencilDepthPass=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilMask",{get:function(){return this.mask},set:function(e){this.mask=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilTest",{get:function(){return this.enabled},set:function(e){this.enabled=e},enumerable:!1,configurable:!0}),r.ALWAYS=519,r.KEEP=7680,r.REPLACE=7681,r}();v();var th=function(){function r(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}return Object.defineProperty(r.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!1,configurable:!0}),r.prototype.setAlphaBlendConstants=function(e,t,i,n){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)},r.prototype.setAlphaBlendFunctionParameters=function(e,t,i,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)},r.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},r.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},r.prototype.apply=function(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},r}();v();v();var rh=function(){function r(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}return Object.defineProperty(r.prototype,"wrapU",{get:function(){return this._cachedWrapU},set:function(e){this._cachedWrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapV",{get:function(){return this._cachedWrapV},set:function(e){this._cachedWrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapR",{get:function(){return this._cachedWrapR},set:function(e){this._cachedWrapR=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"anisotropicFilteringLevel",{get:function(){return this._cachedAnisotropicFilteringLevel},set:function(e){this._cachedAnisotropicFilteringLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"comparisonFunction",{get:function(){return this._comparisonFunction},set:function(e){this._comparisonFunction=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useMipMaps",{get:function(){return this._useMipMaps},set:function(e){this._useMipMaps=e},enumerable:!1,configurable:!0}),r.prototype.setParameters=function(e,t,i,n,o,a){return e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=1),n===void 0&&(n=1),o===void 0&&(o=2),a===void 0&&(a=0),this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=o,this._comparisonFunction=a,this},r.prototype.compareSampler=function(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps},r}();var Le;(function(r){r[r.Unknown=0]="Unknown",r[r.Url=1]="Url",r[r.Temp=2]="Temp",r[r.Raw=3]="Raw",r[r.Dynamic=4]="Dynamic",r[r.RenderTarget=5]="RenderTarget",r[r.MultiRenderTarget=6]="MultiRenderTarget",r[r.Cube=7]="Cube",r[r.CubeRaw=8]="CubeRaw",r[r.CubePrefiltered=9]="CubePrefiltered",r[r.Raw3D=10]="Raw3D",r[r.Raw2DArray=11]="Raw2DArray",r[r.DepthStencil=12]="DepthStencil",r[r.CubeRawRGBD=13]="CubeRawRGBD",r[r.Depth=14]="Depth"})(Le||(Le={}));var zt=function(r){Y(e,r);function e(t,i,n){n===void 0&&(n=!1);var o=r.call(this)||this;return o.isReady=!1,o.isCube=!1,o.is3D=!1,o.is2DArray=!1,o.isMultiview=!1,o.url="",o.generateMipMaps=!1,o.samples=0,o.type=-1,o.format=-1,o.onLoadedObservable=new U,o.onErrorObservable=new U,o.onRebuildCallback=null,o.width=0,o.height=0,o.depth=0,o.baseWidth=0,o.baseHeight=0,o.baseDepth=0,o.invertY=!1,o._invertVScale=!1,o._associatedChannel=-1,o._source=Le.Unknown,o._buffer=null,o._bufferView=null,o._bufferViewArray=null,o._bufferViewArrayArray=null,o._size=0,o._extension="",o._files=null,o._workingCanvas=null,o._workingContext=null,o._cachedCoordinatesMode=null,o._isDisabled=!1,o._compression=null,o._sphericalPolynomial=null,o._sphericalPolynomialPromise=null,o._sphericalPolynomialComputed=!1,o._lodGenerationScale=0,o._lodGenerationOffset=0,o._useSRGBBuffer=!1,o._lodTextureHigh=null,o._lodTextureMid=null,o._lodTextureLow=null,o._isRGBD=!1,o._linearSpecularLOD=!1,o._irradianceTexture=null,o._hardwareTexture=null,o._maxLodLevel=null,o._references=1,o._gammaSpace=null,o._engine=t,o._source=i,o._uniqueId=e._Counter++,n||(o._hardwareTexture=t._createHardwareTexture()),o}return Object.defineProperty(e.prototype,"useMipMaps",{get:function(){return this.generateMipMaps},set:function(t){this.generateMipMaps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),e.prototype.getEngine=function(){return this._engine},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),e.prototype.incrementReferences=function(){this._references++},e.prototype.updateSize=function(t,i,n){n===void 0&&(n=1),this._engine.updateTextureDimensions(this,t,i,n),this.width=t,this.height=i,this.depth=n,this.baseWidth=t,this.baseHeight=i,this.baseDepth=n,this._size=t*i*n},e.prototype._rebuild=function(){var t=this,i;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){var n=this.onRebuildCallback(this),o=function(s){s._swapAndDie(t,!1),t.isReady=n.isReady};n.isAsync?n.proxy.then(o):o(n.proxy);return}var a;switch(this.source){case Le.Temp:break;case Le.Url:a=this._engine.createTexture((i=this._originalUrl)!==null&&i!==void 0?i:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){a._swapAndDie(t,!1),t.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case Le.Raw:a=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),a._swapAndDie(this,!1),this.isReady=!0;break;case Le.Raw3D:a=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),a._swapAndDie(this,!1),this.isReady=!0;break;case Le.Raw2DArray:a=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),a._swapAndDie(this,!1),this.isReady=!0;break;case Le.Dynamic:a=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),a._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Le.Cube:a=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){a._swapAndDie(t,!1),t.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case Le.CubeRaw:a=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),a._swapAndDie(this,!1),this.isReady=!0;break;case Le.CubeRawRGBD:return;case Le.CubePrefiltered:a=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(s){s&&s._swapAndDie(t,!1),t.isReady=!0},null,this.format,this._extension),a._sphericalPolynomial=this._sphericalPolynomial;return}},e.prototype._swapAndDie=function(t,i){var n;i===void 0&&(i=!0),(n=this._hardwareTexture)===null||n===void 0||n.setUsage(t._source,this.generateMipMaps,this.isCube,this.width,this.height),t._hardwareTexture=this._hardwareTexture,i&&(t._isRGBD=this._isRGBD),this._lodTextureHigh&&(t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(t._lodTextureLow&&t._lodTextureLow.dispose(),t._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(t._irradianceTexture&&t._irradianceTexture.dispose(),t._irradianceTexture=this._irradianceTexture);var o=this._engine.getLoadedTexturesCache(),a=o.indexOf(this);a!==-1&&o.splice(a,1),a=o.indexOf(t),a===-1&&o.push(t)},e.prototype.dispose=function(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)},e._Counter=0,e}(rh);v();var ih=function(){function r(){this.shaderLanguage=we.GLSL}return r.prototype.postProcessor=function(e,t,i,n,o){if(!o.getCaps().drawBuffersExtension){var a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e},r}();v();var nh=function(){function r(){this.shaderLanguage=we.GLSL}return r.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},r.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},r.prototype.postProcessor=function(e,t,i){var n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,o=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(o,""),e=e.replace(/texture2D\s*\(/g,"texture("),i)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(n?"":`out vec4 glFragColor;
`)+"void main(");else{var a=t.indexOf("#define MULTIVIEW")!==-1;if(a)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e}return e},r}();v();v();var wn=function(){function r(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=r._Counter++}return Object.defineProperty(r.prototype,"underlyingResource",{get:function(){return null},enumerable:!1,configurable:!0}),r._Counter=0,r}();var dr=function(r){Y(e,r);function e(t){var i=r.call(this)||this;return i._buffer=t,i}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),e}(wn);v();var oh=function(){function r(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(r.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isReady",{get:function(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1},enumerable:!1,configurable:!0}),r.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},r.prototype._fillEffectInformation=function(e,t,i,n,o,a,s,f){var u=this.engine;if(u.supportsUniformBuffers)for(var l in t)e.bindUniformBlock(l,t[l]);var h=this.engine.getUniforms(this,i);h.forEach(function(y,g){n[i[g]]=y}),this._uniforms=n;var c;for(c=0;c<o.length;c++){var p=e.getUniform(o[c]);p==null&&(o.splice(c,1),c--)}o.forEach(function(y,g){a[y]=g});for(var d=0,m=u.getAttributes(this,s);d<m.length;d++){var _=m[d];f.push(_)}},r.prototype.dispose=function(){this._uniforms={}},r.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)},r.prototype._cacheFloat2=function(e,t,i){var n=this._valueCache[e];if(!n||n.length!==2)return n=[t,i],this._valueCache[e]=n,!0;var o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),o},r.prototype._cacheFloat3=function(e,t,i,n){var o=this._valueCache[e];if(!o||o.length!==3)return o=[t,i,n],this._valueCache[e]=o,!0;var a=!1;return o[0]!==t&&(o[0]=t,a=!0),o[1]!==i&&(o[1]=i,a=!0),o[2]!==n&&(o[2]=n,a=!0),a},r.prototype._cacheFloat4=function(e,t,i,n,o){var a=this._valueCache[e];if(!a||a.length!==4)return a=[t,i,n,o],this._valueCache[e]=a,!0;var s=!1;return a[0]!==t&&(a[0]=t,s=!0),a[1]!==i&&(a[1]=i,s=!0),a[2]!==n&&(a[2]=n,s=!0),a[3]!==o&&(a[3]=o,s=!0),s},r.prototype.setInt=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setInt2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setInt3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setInt4=function(e,t,i,n,o){this._cacheFloat4(e,t,i,n,o)&&(this.engine.setInt4(this._uniforms[e],t,i,n,o)||(this._valueCache[e]=null))},r.prototype.setIntArray=function(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)},r.prototype.setIntArray2=function(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)},r.prototype.setIntArray3=function(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)},r.prototype.setIntArray4=function(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)},r.prototype.setArray=function(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)},r.prototype.setArray2=function(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)},r.prototype.setArray3=function(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)},r.prototype.setArray4=function(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)},r.prototype.setMatrices=function(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))},r.prototype.setMatrix=function(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))},r.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)},r.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)},r.prototype.setFloat=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setVector2=function(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))},r.prototype.setFloat2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setVector3=function(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))},r.prototype.setFloat3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setVector4=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setQuaternion=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setFloat4=function(e,t,i,n,o){this._cacheFloat4(e,t,i,n,o)&&(this.engine.setFloat4(this._uniforms[e],t,i,n,o)||(this._valueCache[e]=null))},r.prototype.setColor3=function(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))},r.prototype.setColor4=function(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))},r.prototype.setDirectColor4=function(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))},r.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},r.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},r}();v();var tr=function(){function r(){}return r.SetMatrixPrecision=function(e){if(r.MatrixTrackPrecisionChange=!1,e&&!r.MatrixUse64Bits&&r.MatrixTrackedMatrices)for(var t=0;t<r.MatrixTrackedMatrices.length;++t){var i=r.MatrixTrackedMatrices[t],n=i._m;i._m=new Array(16);for(var o=0;o<16;++o)i._m[o]=n[o]}r.MatrixUse64Bits=e,r.MatrixCurrentType=r.MatrixUse64Bits?Array:Float32Array,r.MatrixTrackedMatrices=null},r.MatrixUse64Bits=!1,r.MatrixTrackPrecisionChange=!0,r.MatrixCurrentType=Float32Array,r.MatrixTrackedMatrices=[],r}();v();var Ln=function(){function r(e,t){if(e===void 0&&(e=null),this._MSAARenderBuffer=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}return Object.defineProperty(r.prototype,"underlyingResource",{get:function(){return this._webGLTexture},enumerable:!1,configurable:!0}),r.prototype.setUsage=function(){},r.prototype.set=function(e){this._webGLTexture=e},r.prototype.reset=function(){this._webGLTexture=null,this._MSAARenderBuffer=null},r.prototype.release=function(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()},r}();v();var li=function(){function r(e,t){t===void 0&&(t=!0),this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}return r.IsWrapper=function(e){return e.getPipelineContext===void 0},r.GetEffect=function(e){return e.getPipelineContext===void 0?e.effect:e},r.prototype.setEffect=function(e,t,i){var n;i===void 0&&(i=!0),this.effect=e,t!==void 0&&(this.defines=t),i&&((n=this.drawContext)===null||n===void 0||n.reset())},r.prototype.dispose=function(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()},r}();v();var ah=function(){function r(e){e===void 0&&(e=!0),this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}return Object.defineProperty(r.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"func",{get:function(){return this._func},set:function(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"funcRef",{get:function(){return this._funcRef},set:function(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"funcMask",{get:function(){return this._funcMask},set:function(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)},enumerable:!1,configurable:!0}),r.prototype.reset=function(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},r.prototype.apply=function(e){var t;if(!!e){var i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}},r}();var cv=function(){function r(){}return r}(),me=function(){function r(e,t,i,n){var o=this;this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new U,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new U,this.onContextRestoredObservable=new U,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new $l,this._stencilStateComposer=new ah,this._stencilState=new eh,this._alphaState=new th,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new U,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={};var a=null;if(i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=n!=null?n:!1,this._stencilStateComposer.stencilGlobal=this._stencilState,tr.SetMatrixPrecision(!!i.useHighPrecisionMatrix),!!e){if(n=n||i.adaptToDeviceRatio||!1,e.getContext){if(a=e,this._renderingCanvas=a,t!==void 0&&(i.antialias=t),i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.timeStep===void 0&&(i.timeStep=1/60),i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.audioEngine===void 0&&(i.audioEngine=!0),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioContext!==void 0&&(this._audioContext=i.audioEngineOptions.audioContext),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioDestination!==void 0&&(this._audioDestination=i.audioEngineOptions.audioDestination),i.stencil===void 0&&(i.stencil=!0),i.premultipliedAlpha===!1&&(this.premultipliedAlpha=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),i.useExactSrgbConversions!==void 0&&(this._useExactSrgbConversions=i.useExactSrgbConversions),this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=function(){var D=navigator.userAgent;o.hostInformation.isMobile=D.indexOf("Mobile")!==-1||D.indexOf("Mac")!==-1&&ni()&&"ontouchend"in document},this._checkForMobile(),Me()&&window.addEventListener("resize",this._checkForMobile);for(var s=navigator.userAgent,f=0,u=r.ExceptionList;f<u.length;f++){var l=u[f],h=l.key,c=l.targets,p=new RegExp(h);if(p.test(s)){if(l.capture&&l.captureConstraint){var d=l.capture,m=l.captureConstraint,_=new RegExp(d),y=_.exec(s);if(y&&y.length>0){var g=parseInt(y[y.length-1]);if(g>=m)continue}}for(var T=0,A=c;T<A.length;T++){var M=A[T];switch(M){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(D){D.preventDefault(),o._contextWasLost=!0,q.Warn("WebGL context lost."),o.onContextLostObservable.notifyObservers(o)},this._onContextRestored=function(){o._restoreEngineAfterContextLost(o._initGLContext.bind(o))},a.addEventListener("webglcontextlost",this._onContextLost,!1),a.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=a.getContext("webgl2",i)||a.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(D){}if(!this._gl){if(!a)throw new Error("The provided canvas is null or undefined.");try{this._gl=a.getContext("webgl",i)||a.getContext("experimental-webgl",i)}catch(D){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";var C=this._gl.getContextAttributes();C&&(i.stencil=C.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats);var P=Me()&&window.devicePixelRatio||1,R=i.limitDeviceRatio||P;this._hardwareScalingLevel=n?1/Math.min(R,P):1,this._lastDevicePixelRatio=P,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext(),this._initFeatures();for(var F=0;F<this._caps.maxVertexAttribs;F++)this._currentBufferPointers[F]=new cv;this._shaderProcessor=this.webGLVersion>1?new nh:new ih,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);var I="Babylon.js v".concat(r.Version);console.log(I+" - ".concat(this.description)),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",I)}}return Object.defineProperty(r,"NpmPackage",{get:function(){return"babylonjs@5.20.0"},enumerable:!1,configurable:!0}),Object.defineProperty(r,"Version",{get:function(){return"5.20.0"},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"description",{get:function(){var e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"version",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ShadersRepository",{get:function(){return ui.ShadersRepository},set:function(e){ui.ShadersRepository=e},enumerable:!1,configurable:!0}),r.prototype._getShaderProcessor=function(e){return this._shaderProcessor},Object.defineProperty(r.prototype,"useReverseDepthBuffer",{get:function(){return this._useReverseDepthBuffer},set:function(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"frameId",{get:function(){return this._frameId},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),r.prototype.getCreationOptions=function(){return this._creationOptions},Object.defineProperty(r.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"activeRenderLoops",{get:function(){return this._activeRenderLoops},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isWebGPU",{get:function(){return this._isWebGPU},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shaderPlatformName",{get:function(){return this._shaderPlatformName},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"snapshotRendering",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"snapshotRenderingMode",{get:function(){return this._snapshotRenderingMode},set:function(e){this._snapshotRenderingMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useExactSrgbConversions",{get:function(){return this._useExactSrgbConversions},enumerable:!1,configurable:!0}),r.prototype.snapshotRenderingReset=function(){this.snapshotRendering=!1},r._CreateCanvas=function(e,t){if(typeof document=="undefined")return new OffscreenCanvas(e,t);var i=document.createElement("canvas");return i.width=e,i.height=t,i},r.prototype.createCanvas=function(e,t){return r._CreateCanvas(e,t)},r.prototype.createCanvasImage=function(){return document.createElement("img")},r.prototype._restoreEngineAfterContextLost=function(e){var t=this;setTimeout(function(){return ii(t,void 0,void 0,function(){var i,n,o,a,s;return Lt(this,function(f){switch(f.label){case 0:return this._dummyFramebuffer=null,i=this._depthCullingState.depthTest,n=this._depthCullingState.depthFunc,o=this._depthCullingState.depthMask,a=this._stencilState.stencilTest,[4,e()];case 1:return f.sent(),this._rebuildEffects(),(s=this._rebuildComputeEffects)===null||s===void 0||s.call(this),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this._rebuildBuffers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=n,this._depthCullingState.depthMask=o,this._stencilState.stencilTest=a,q.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1,[2]}})})},0)},r.prototype._sharedInit=function(e,t,i){this._renderingCanvas=e},r.prototype._getShaderProcessingContext=function(e){return null},r.prototype._rebuildInternalTextures=function(){for(var e=this._internalTexturesCache.slice(),t=0,i=e;t<i.length;t++){var n=i[t];n._rebuild()}},r.prototype._rebuildRenderTargetWrappers=function(){for(var e=this._renderTargetWrapperCache.slice(),t=0,i=e;t<i.length;t++){var n=i[t];n._rebuild()}},r.prototype._rebuildEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}ui.ResetCache()},r.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];if(!t.isReady())return!1}return!0},r.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++){var i=t[e];i._rebuild()}for(var n=0,o=this._storageBuffers;n<o.length;n++){var a=o[n];a._rebuild()}},r.prototype._initGLContext=function(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);var t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{var i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=i["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var o=this._gl.getExtension("WEBGL_depth_texture");o!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=o.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var a=this._gl.getExtension("OES_vertex_array_object");a!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=a.createVertexArrayOES.bind(a),this._gl.bindVertexArray=a.bindVertexArrayOES.bind(a),this._gl.deleteVertexArray=a.deleteVertexArrayOES.bind(a))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var s=this._gl.getExtension("ANGLE_instanced_arrays");s!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var f=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),u=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);f&&u&&(this._caps.highPrecisionShaderSupported=f.precision!==0&&u.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var l=this._gl.getExtension("EXT_blend_minmax");l!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=l.MAX_EXT,this._gl.MIN=l.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{var h=this._gl.getExtension("EXT_sRGB");h!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=h.SRGB_EXT,this._gl.SRGB8=h.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=h.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var c=0;c<this._maxSimultaneousTextures;c++)this._nextFreeTextureSlots.push(c)},r.prototype._initFeatures=function(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}},Object.defineProperty(r.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(r.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),r.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=this.createCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},r.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)||(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},r.prototype.getInfo=function(){return this.getGlInfo()},r.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},r.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},r.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},r.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},r.prototype.getCaps=function(){return this._caps},r.prototype.stopRenderLoop=function(e){if(!e){this._activeRenderLoops=[];return}var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)},r.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++){var i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},r.prototype.getRenderingCanvas=function(){return this._renderingCanvas},r.prototype.getAudioContext=function(){return this._audioContext},r.prototype.getAudioDestination=function(){return this._audioDestination},r.prototype.getHostWindow=function(){return Me()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},r.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},r.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},r.prototype._queueNewFrame=function(e,t){return r.QueueNewFrame(e,t)},r.prototype.runRenderLoop=function(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},r.prototype.clear=function(e,t,i,n){n===void 0&&(n=!1);var o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;var a=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),a|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)},r.prototype._viewport=function(e,t,i,n){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=n,this._gl.viewport(e,t,i,n))},r.prototype.setViewport=function(e,t,i){var n=t||this.getRenderWidth(),o=i||this.getRenderHeight(),a=e.x||0,s=e.y||0;this._cachedViewport=e,this._viewport(a*n,s*o,n*e.width,o*e.height)},r.prototype.beginFrame=function(){},r.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._frameId++},r.prototype.resize=function(e){e===void 0&&(e=!1);var t,i;if(this.adaptToDeviceRatio){var n=Me()&&window.devicePixelRatio||1,o=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=o}Me()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,i=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)},r.prototype.setSize=function(e,t,i){return i===void 0&&(i=!1),!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)},r.prototype.bindFramebuffer=function(e,t,i,n,o,a,s){var f,u,l,h,c;t===void 0&&(t=0),a===void 0&&(a=0),s===void 0&&(s=0);var p=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(p._MSAAFramebuffer?p._MSAAFramebuffer:p._framebuffer);var d=this._gl;e.is2DArray?d.framebufferTextureLayer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,(f=e.texture._hardwareTexture)===null||f===void 0?void 0:f.underlyingResource,a,s):e.isCube&&d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+t,(u=e.texture._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,a);var m=e._depthStencilTexture;if(m){var _=e._depthStencilTextureWithStencil?d.DEPTH_STENCIL_ATTACHMENT:d.DEPTH_ATTACHMENT;e.is2DArray?d.framebufferTextureLayer(d.FRAMEBUFFER,_,(l=m._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,a,s):e.isCube?d.framebufferTexture2D(d.FRAMEBUFFER,_,d.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=m._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,a):d.framebufferTexture2D(d.FRAMEBUFFER,_,d.TEXTURE_2D,(c=m._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,a)}this._cachedViewport&&!o?this.setViewport(this._cachedViewport,i,n):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),n||(n=e.height,a&&(n=n/Math.pow(2,a))),this._viewport(0,0,i,n)),this.wipeCaches()},r.prototype.setState=function(e,t,i,n,o,a,s){var f,u;t===void 0&&(t=0),n===void 0&&(n=!1),s===void 0&&(s=0),(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);var l=!((u=(f=this.cullBackFaces)!==null&&f!==void 0?f:o)!==null&&u!==void 0)||u?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==l||i)&&(this._depthCullingState.cullFace=l),this.setZOffset(t),this.setZOffsetUnits(s);var h=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==h||i)&&(this._depthCullingState.frontFace=h),this._stencilStateComposer.stencilMaterial=a},r.prototype.getDepthBuffer=function(){return this._depthCullingState.depthTest},r.prototype.setDepthBuffer=function(e){this._depthCullingState.depthTest=e},r.prototype.setZOffset=function(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e},r.prototype.getZOffset=function(){var e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e},r.prototype.setZOffsetUnits=function(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e},r.prototype.getZOffsetUnits=function(){var e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e},r.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},r.prototype._currentFrameBufferIsDefaultFrameBuffer=function(){return this._currentFramebuffer===null},r.prototype.generateMipmaps=function(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)},r.prototype.unBindFramebuffer=function(e,t,i){var n;t===void 0&&(t=!1);var o=e;this._currentRenderTarget=null;var a=this._gl;if(o._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}a.bindFramebuffer(a.READ_FRAMEBUFFER,o._MSAAFramebuffer),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,o._framebuffer),a.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,a.COLOR_BUFFER_BIT,a.NEAREST)}((n=e.texture)===null||n===void 0?void 0:n.generateMipMaps)&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(o._MSAAFramebuffer&&this._bindUnboundFramebuffer(o._framebuffer),i()),this._bindUnboundFramebuffer(null)},r.prototype.flushFramebuffer=function(){this._gl.flush()},r.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},r.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},r.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},r.prototype._createVertexBuffer=function(e,t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");var n=new dr(i);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),n.references=1,n},r.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},r.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},r.prototype.createIndexBuffer=function(e,t){var i=this._gl.createBuffer(),n=new dr(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);var o=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,o,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=o.BYTES_PER_ELEMENT===4,n},r.prototype._normalizeIndexData=function(e){var t=e.BYTES_PER_ELEMENT;if(t===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},r.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)},r.prototype.bindUniformBlock=function(e,t,i){var n=e.program,o=this._gl.getUniformBlockIndex(n,t);this._gl.uniformBlockBinding(n,o,i)},r.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},r.prototype._bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},r.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},r.prototype._vertexAttribPointer=function(e,t,i,n,o,a,s){var f=this._currentBufferPointers[t];if(!!f){var u=!1;f.active?(f.buffer!==e&&(f.buffer=e,u=!0),f.size!==i&&(f.size=i,u=!0),f.type!==n&&(f.type=n,u=!0),f.normalized!==o&&(f.normalized=o,u=!0),f.stride!==a&&(f.stride=a,u=!0),f.offset!==s&&(f.offset=s,u=!0)):(u=!0,f.active=!0,f.index=t,f.size=i,f.type=n,f.normalized=o,f.stride=a,f.offset=s,f.buffer=e),(u||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(t,i,n,a,s):this._gl.vertexAttribPointer(t,i,n,o,a,s))}},r.prototype._bindIndexBufferWithCache=function(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},r.prototype._bindVertexBuffersAttributes=function(e,t,i){var n=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0;o<n.length;o++){var a=t.getAttributeLocation(o);if(a>=0){var s=n[o],f=null;if(i&&(f=i[s]),f||(f=e[s]),!f)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);var u=f.getBuffer();u&&(this._vertexAttribPointer(u,a,f.getSize(),f.type,f.normalized,f.byteStride,f.byteOffset),f.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,f.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(u))))}}},r.prototype.recordVertexArrayObject=function(e,t,i,n){var o=this._gl.createVertexArray();if(!o)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(o),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,n),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),o},r.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)},r.prototype.bindBuffersDirectly=function(e,t,i,n,o){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==o){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=o;var a=o.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var s=0,f=0;f<a;f++)if(f<i.length){var u=o.getAttributeLocation(f);u>=0&&(this._gl.enableVertexAttribArray(u),this._vertexAttribArraysEnabled[u]=!0,this._vertexAttribPointer(e,u,i[f],this._gl.FLOAT,!1,n,s)),s+=i[f]*4}}this._bindIndexBufferWithCache(t)},r.prototype._unbindVertexArrayObject=function(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},r.prototype.bindBuffers=function(e,t,i,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,n)),this._bindIndexBufferWithCache(t)},r.prototype.unbindInstanceAttributes=function(){for(var e,t=0,i=this._currentInstanceLocations.length;t<i;t++){var n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));var o=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(o,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},r.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},r.prototype._releaseBuffer=function(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1},r.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},r.prototype.updateAndBindInstancesBuffer=function(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(var n=0;n<4;n++){var o=i[n];this._vertexAttribArraysEnabled[o]||(this._gl.enableVertexAttribArray(o),this._vertexAttribArraysEnabled[o]=!0),this._vertexAttribPointer(e,o,4,this._gl.FLOAT,!1,64,n*16),this._gl.vertexAttribDivisor(o,1),this._currentInstanceLocations.push(o),this._currentInstanceBuffers.push(e)}},r.prototype.bindInstancesBuffer=function(e,t,i){i===void 0&&(i=!0),this.bindArrayBuffer(e);var n=0;if(i)for(var o=0;o<t.length;o++){var a=t[o];n+=a.attributeSize*4}for(var o=0;o<t.length;o++){var a=t[o];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,n,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}},r.prototype.disableInstanceAttributeByName=function(e){if(!!this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}},r.prototype.disableInstanceAttribute=function(e){for(var t=!1,i;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},r.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},r.prototype.draw=function(e,t,i,n){this.drawElementsType(e?0:1,t,i,n)},r.prototype.drawPointClouds=function(e,t,i){this.drawArraysType(2,e,t,i)},r.prototype.drawUnIndexed=function(e,t,i,n){this.drawArraysType(e?0:1,t,i,n)},r.prototype.drawElementsType=function(e,t,i,n){this.applyStates(),this._reportDrawCall();var o=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,s=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(o,i,a,t*s,n):this._gl.drawElements(o,i,a,t*s)},r.prototype.drawArraysType=function(e,t,i,n){this.applyStates(),this._reportDrawCall();var o=this._drawMode(e);n?this._gl.drawArraysInstanced(o,t,i,n):this._gl.drawArrays(o,t,i)},r.prototype._drawMode=function(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}},r.prototype._reportDrawCall=function(){},r.prototype._releaseEffect=function(e){if(this._compiledEffects[e._key]){delete this._compiledEffects[e._key];var t=e.getPipelineContext();t&&this._deletePipelineContext(t)}},r.prototype._deletePipelineContext=function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))},r.prototype._getGlobalDefines=function(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{var t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}},r.prototype.createEffect=function(e,t,i,n,o,a,s,f,u,l){var h;l===void 0&&(l=we.GLSL);var c=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,p=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,d=this._getGlobalDefines(),m=(h=o!=null?o:t.defines)!==null&&h!==void 0?h:"";d&&(m+=d);var _=c+"+"+p+"@"+m;if(this._compiledEffects[_]){var y=this._compiledEffects[_];return s&&y.isReady()&&s(y),y}var g=new ui(e,t,i,n,this,o,a,s,f,u,_,l);return this._compiledEffects[_]=g,g},r._ConcatenateShader=function(e,t,i){return i===void 0&&(i=""),i+(t?t+`
`:"")+e},r.prototype._compileShader=function(e,t,i,n){return this._compileRawShader(r._ConcatenateShader(e,i,n),t)},r.prototype._compileRawShader=function(e,t){var i=this._gl,n=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!n){for(var o=i.NO_ERROR,a=i.NO_ERROR;(a=i.getError())!==i.NO_ERROR;)o=a;throw new Error("Something went wrong while creating a gl ".concat(t," shader object. gl error=").concat(o,", gl isContextLost=").concat(i.isContextLost(),", _contextWasLost=").concat(this._contextWasLost))}return i.shaderSource(n,e),i.compileShader(n),n},r.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},r.prototype.createRawShaderProgram=function(e,t,i,n,o){o===void 0&&(o=null),n=n||this._gl;var a=this._compileRawShader(t,"vertex"),s=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,a,s,n,o)},r.prototype.createShaderProgram=function(e,t,i,n,o,a){a===void 0&&(a=null),o=o||this._gl;var s=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",f=this._compileShader(t,"vertex",n,s),u=this._compileShader(i,"fragment",n,s);return this._createShaderProgram(e,f,u,o,a)},r.prototype.inlineShaderCode=function(e){return e},r.prototype.createPipelineContext=function(e){var t=new oh;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t},r.prototype.createMaterialContext=function(){},r.prototype.createDrawContext=function(){},r.prototype._createShaderProgram=function(e,t,i,n,o){o===void 0&&(o=null);var a=n.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");return n.attachShader(a,t),n.attachShader(a,i),n.linkProgram(a),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),a},r.prototype._finalizePipelineContext=function(e){var t=e.context,i=e.vertexShader,n=e.fragmentShader,o=e.program,a=t.getProgramParameter(o,t.LINK_STATUS);if(!a){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){var s=this._gl.getShaderInfoLog(i);if(s)throw e.vertexCompilationError=s,new Error("VERTEX SHADER "+s)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){var s=this._gl.getShaderInfoLog(n);if(s)throw e.fragmentCompilationError=s,new Error("FRAGMENT SHADER "+s)}var f=t.getProgramInfoLog(o);if(f)throw e.programLinkError=f,new Error(f)}if(this.validateShaderPrograms){t.validateProgram(o);var u=t.getProgramParameter(o,t.VALIDATE_STATUS);if(!u){var f=t.getProgramInfoLog(o);if(f)throw e.programValidationError=f,new Error(f)}}t.deleteShader(i),t.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},r.prototype._preparePipelineContext=function(e,t,i,n,o,a,s,f,u,l){var h=e;n?h.program=this.createRawShaderProgram(h,t,i,void 0,u):h.program=this.createShaderProgram(h,t,i,f,void 0,u),h.program.__SPECTOR_rebuildProgram=s},r.prototype._isRenderingStateCompiled=function(e){var t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1},r.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var i=e;if(!i.isParallelCompiled){t();return}var n=i.onCompiled;n?i.onCompiled=function(){n(),t()}:i.onCompiled=t},r.prototype.getUniforms=function(e,t){for(var i=new Array,n=e,o=0;o<t.length;o++)i.push(this._gl.getUniformLocation(n.program,t[o]));return i},r.prototype.getAttributes=function(e,t){for(var i=[],n=e,o=0;o<t.length;o++)try{i.push(this._gl.getAttribLocation(n.program,t[o]))}catch(a){i.push(-1)}return i},r.prototype.enableEffect=function(e){e=e!==null&&li.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},r.prototype.setInt=function(e,t){return e?(this._gl.uniform1i(e,t),!0):!1},r.prototype.setInt2=function(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1},r.prototype.setInt3=function(e,t,i,n){return e?(this._gl.uniform3i(e,t,i,n),!0):!1},r.prototype.setInt4=function(e,t,i,n,o){return e?(this._gl.uniform4i(e,t,i,n,o),!0):!1},r.prototype.setIntArray=function(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1},r.prototype.setIntArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)},r.prototype.setIntArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)},r.prototype.setIntArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)},r.prototype.setArray=function(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)},r.prototype.setArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)},r.prototype.setArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)},r.prototype.setArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)},r.prototype.setMatrices=function(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1},r.prototype.setMatrix3x3=function(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1},r.prototype.setMatrix2x2=function(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1},r.prototype.setFloat=function(e,t){return e?(this._gl.uniform1f(e,t),!0):!1},r.prototype.setFloat2=function(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1},r.prototype.setFloat3=function(e,t,i,n){return e?(this._gl.uniform3f(e,t,i,n),!0):!1},r.prototype.setFloat4=function(e,t,i,n,o){return e?(this._gl.uniform4f(e,t,i,n,o),!0):!1},r.prototype.applyStates=function(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}},r.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},r.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(r.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilStateComposer",{get:function(){return this._stencilStateComposer},enumerable:!1,configurable:!0}),r.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache.length=0},r.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},r.prototype._getSamplingParameters=function(e,t){var i=this._gl,n=i.NEAREST,o=i.NEAREST;switch(e){case 11:n=i.LINEAR,t?o=i.LINEAR_MIPMAP_NEAREST:o=i.LINEAR;break;case 3:n=i.LINEAR,t?o=i.LINEAR_MIPMAP_LINEAR:o=i.LINEAR;break;case 8:n=i.NEAREST,t?o=i.NEAREST_MIPMAP_LINEAR:o=i.NEAREST;break;case 4:n=i.NEAREST,t?o=i.NEAREST_MIPMAP_NEAREST:o=i.NEAREST;break;case 5:n=i.NEAREST,t?o=i.LINEAR_MIPMAP_NEAREST:o=i.LINEAR;break;case 6:n=i.NEAREST,t?o=i.LINEAR_MIPMAP_LINEAR:o=i.LINEAR;break;case 7:n=i.NEAREST,o=i.LINEAR;break;case 1:n=i.NEAREST,o=i.NEAREST;break;case 9:n=i.LINEAR,t?o=i.NEAREST_MIPMAP_NEAREST:o=i.NEAREST;break;case 10:n=i.LINEAR,t?o=i.NEAREST_MIPMAP_LINEAR:o=i.NEAREST;break;case 2:n=i.LINEAR,o=i.LINEAR;break;case 12:n=i.LINEAR,o=i.NEAREST;break}return{min:o,mag:n}},r.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},r.prototype._createHardwareTexture=function(){return new Ln(this._createTexture(),this._gl)},r.prototype._createInternalTexture=function(e,t,i,n){i===void 0&&(i=!0),n===void 0&&(n=Le.Unknown);var o={};t!==void 0&&typeof t=="object"?(o.generateMipMaps=t.generateMipMaps,o.type=t.type===void 0?0:t.type,o.samplingMode=t.samplingMode===void 0?3:t.samplingMode,o.format=t.format===void 0?5:t.format,o.useSRGBBuffer=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer):(o.generateMipMaps=t,o.type=0,o.samplingMode=3,o.format=5,o.useSRGBBuffer=!1),o.useSRGBBuffer=o.useSRGBBuffer&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(o.type===1&&!this._caps.textureFloatLinearFiltering||o.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o.samplingMode=1),o.type===1&&!this._caps.textureFloat&&(o.type=0,q.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));var a=this._gl,s=new zt(this,n);s._useSRGBBuffer=!!o.useSRGBBuffer;var f=e.width||e,u=e.height||e,l=e.layers||0,h=this._getSamplingParameters(o.samplingMode,!!o.generateMipMaps),c=l!==0?a.TEXTURE_2D_ARRAY:a.TEXTURE_2D,p=this._getRGBABufferInternalSizedFormat(o.type,o.format,o.useSRGBBuffer),d=this._getInternalFormat(o.format),m=this._getWebGLTextureType(o.type);return this._bindTextureDirectly(c,s),l!==0?(s.is2DArray=!0,a.texImage3D(c,0,p,f,u,l,0,d,m,null)):a.texImage2D(c,0,p,f,u,0,d,m,null),a.texParameteri(c,a.TEXTURE_MAG_FILTER,h.mag),a.texParameteri(c,a.TEXTURE_MIN_FILTER,h.min),a.texParameteri(c,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(c,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),o.generateMipMaps&&this._gl.generateMipmap(c),this._bindTextureDirectly(c,null),s.baseWidth=f,s.baseHeight=u,s.width=f,s.height=u,s.depth=l,s.isReady=!0,s.samples=1,s.generateMipMaps=!!o.generateMipMaps,s.samplingMode=o.samplingMode,s.type=o.type,s.format=o.format,this._internalTexturesCache.push(s),s},r.prototype._getUseSRGBBuffer=function(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)},r.prototype._createTextureBase=function(e,t,i,n,o,a,s,f,u,l,h,c,p,d,m,_){var y=this;o===void 0&&(o=3),a===void 0&&(a=null),s===void 0&&(s=null),l===void 0&&(l=null),h===void 0&&(h=null),c===void 0&&(c=null),p===void 0&&(p=null),e=e||"";var g=e.substr(0,5)==="data:",T=e.substr(0,5)==="blob:",A=g&&e.indexOf(";base64,")!==-1,M=h||new zt(this,Le.Url),C=e;this._transformTextureUrl&&!A&&!h&&!l&&(e=this._transformTextureUrl(e)),C!==e&&(M._originalUrl=C);var P=e.lastIndexOf("."),R=p||(P>-1?e.substring(P).toLowerCase():""),F=null,I=R.indexOf("?");I>-1&&(R=R.split("?")[0]);for(var D=0,V=r._TextureLoaders;D<V.length;D++){var k=V[D];if(k.canLoad(R,d)){F=k;break}}n&&n.addPendingData(M),M.url=e,M.generateMipMaps=!t,M.samplingMode=o,M.invertY=i,M._useSRGBBuffer=this._getUseSRGBBuffer(!!_,t),this._doNotHandleContextLost||(M._buffer=l);var w=null;a&&!h&&(w=M.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(M);var G=function(W,z){n&&n.removePendingData(M),e===C?(w&&M.onLoadedObservable.remove(w),le.UseFallbackTexture&&y._createTextureBase(le.FallbackTexture,t,M.invertY,n,o,null,s,f,u,l,M),W=(W||"Unknown error")+(le.UseFallbackTexture?" - Fallback texture was used":""),M.onErrorObservable.notifyObservers({message:W,exception:z}),s&&s(W,z)):(q.Warn("Failed to load ".concat(e,", falling back to ").concat(C)),y._createTextureBase(C,t,M.invertY,n,o,a,s,f,u,l,M,c,p,d,m,_))};if(F){var K=function(W){F.loadData(W,M,function(z,oe,be,Pe,ze,$e){$e?G("TextureLoader failed to load data"):f(M,R,n,{width:z,height:oe},M.invertY,!be,Pe,function(){return ze(),!1},o)},m)};l?l instanceof ArrayBuffer?K(new Uint8Array(l)):ArrayBuffer.isView(l)?K(l):s&&s("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,function(W){return K(new Uint8Array(W))},void 0,n?n.offlineProvider:void 0,!0,function(W,z){G("Unable to load "+(W&&W.responseURL,z))})}else{var j=function(W){T&&!y._doNotHandleContextLost&&(M._buffer=W),f(M,R,n,W,M.invertY,t,!1,u,o)};!g||A?l&&(typeof l.decoding=="string"||l.close)?j(l):r._FileToolsLoadImage(e,j,G,n?n.offlineProvider:null,d,M.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof l=="string"||l instanceof ArrayBuffer||ArrayBuffer.isView(l)||l instanceof Blob?r._FileToolsLoadImage(l,j,G,n?n.offlineProvider:null,d,M.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):l&&j(l)}return M},r.prototype.createTexture=function(e,t,i,n,o,a,s,f,u,l,h,c,p,d,m){var _=this;return o===void 0&&(o=3),a===void 0&&(a=null),s===void 0&&(s=null),f===void 0&&(f=null),u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=null),this._createTextureBase(e,t,i,n,o,a,s,this._prepareWebGLTexture.bind(this),function(y,g,T,A,M,C){var P=_._gl,R=T.width===y&&T.height===g,F=l?_._getInternalFormat(l,M._useSRGBBuffer):A===".jpg"&&!M._useSRGBBuffer?P.RGB:M._useSRGBBuffer?P.SRGB8_ALPHA8:P.RGBA,I=l?_._getInternalFormat(l):A===".jpg"&&!M._useSRGBBuffer?P.RGB:P.RGBA;if(M._useSRGBBuffer&&_.webGLVersion===1&&(I=F),R)return P.texImage2D(P.TEXTURE_2D,0,F,I,P.UNSIGNED_BYTE,T),!1;var D=_._caps.maxTextureSize;if(T.width>D||T.height>D||!_._supportsHardwareTextureRescaling)return _._prepareWorkingCanvas(),!_._workingCanvas||!_._workingContext||(_._workingCanvas.width=y,_._workingCanvas.height=g,_._workingContext.drawImage(T,0,0,T.width,T.height,0,0,y,g),P.texImage2D(P.TEXTURE_2D,0,F,I,P.UNSIGNED_BYTE,_._workingCanvas),M.width=y,M.height=g),!1;var V=new zt(_,Le.Temp);return _._bindTextureDirectly(P.TEXTURE_2D,V,!0),P.texImage2D(P.TEXTURE_2D,0,F,I,P.UNSIGNED_BYTE,T),_._rescaleTexture(V,M,n,F,function(){_._releaseTexture(V),_._bindTextureDirectly(P.TEXTURE_2D,M,!0),C()}),!0},f,u,l,h,c,p,m)},r._FileToolsLoadImage=function(e,t,i,n,o,a){throw Q("FileTools")},r.prototype._rescaleTexture=function(e,t,i,n,o){},r.prototype.createRawTexture=function(e,t,i,n,o,a,s,f,u,l,h){throw f===void 0&&(f=null),u===void 0&&(u=0),l===void 0&&(l=0),h===void 0&&(h=!1),Q("Engine.RawTexture")},r.prototype.createRawCubeTexture=function(e,t,i,n,o,a,s,f){throw f===void 0&&(f=null),Q("Engine.RawTexture")},r.prototype.createRawTexture3D=function(e,t,i,n,o,a,s,f,u,l){throw u===void 0&&(u=null),l===void 0&&(l=0),Q("Engine.RawTexture")},r.prototype.createRawTexture2DArray=function(e,t,i,n,o,a,s,f,u,l){throw u===void 0&&(u=null),l===void 0&&(l=0),Q("Engine.RawTexture")},r.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},r.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},r.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},r.prototype.updateTextureSamplingMode=function(e,t,i){i===void 0&&(i=!1);var n=this._getTextureTarget(t),o=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,o.mag,t),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,o.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),t.samplingMode=e},r.prototype.updateTextureDimensions=function(e,t,i,n){n===void 0&&(n=1)},r.prototype.updateTextureWrappingMode=function(e,t,i,n){i===void 0&&(i=null),n===void 0&&(n=null);var o=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&n!==null&&(this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(o,null)},r.prototype._setupDepthStencilTexture=function(e,t,i,n,o,a){a===void 0&&(a=1);var s=t.width||t,f=t.height||t,u=t.layers||0;e.baseWidth=s,e.baseHeight=f,e.width=s,e.height=f,e.is2DArray=u>0,e.depth=u,e.isReady=!0,e.samples=a,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=o;var l=this._gl,h=this._getTextureTarget(e),c=this._getSamplingParameters(e.samplingMode,!1);l.texParameteri(h,l.TEXTURE_MAG_FILTER,c.mag),l.texParameteri(h,l.TEXTURE_MIN_FILTER,c.min),l.texParameteri(h,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(h,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(o===0?(l.texParameteri(h,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(h,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(h,l.TEXTURE_COMPARE_FUNC,o),l.texParameteri(h,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)))},r.prototype._uploadCompressedDataToTextureDirectly=function(e,t,i,n,o,a,s){a===void 0&&(a=0),s===void 0&&(s=0);var f=this._gl,u=f.TEXTURE_2D;if(e.isCube&&(u=f.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=f.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=f.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=f.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=f.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=f.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=f.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=f.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(u,s,t,i,n,0,o)},r.prototype._uploadDataToTextureDirectly=function(e,t,i,n,o,a){i===void 0&&(i=0),n===void 0&&(n=0),a===void 0&&(a=!1);var s=this._gl,f=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format),l=o===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(o,e._useSRGBBuffer);this._unpackFlipY(e.invertY);var h=s.TEXTURE_2D;e.isCube&&(h=s.TEXTURE_CUBE_MAP_POSITIVE_X+i);var c=Math.round(Math.log(e.width)*Math.LOG2E),p=Math.round(Math.log(e.height)*Math.LOG2E),d=a?e.width:Math.pow(2,Math.max(c-n,0)),m=a?e.height:Math.pow(2,Math.max(p-n,0));s.texImage2D(h,n,l,d,m,0,u,f,t)},r.prototype.updateTextureData=function(e,t,i,n,o,a,s,f,u){s===void 0&&(s=0),f===void 0&&(f=0),u===void 0&&(u=!1);var l=this._gl,h=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var p=l.TEXTURE_2D;e.isCube&&(p=l.TEXTURE_CUBE_MAP_POSITIVE_X+s),this._bindTextureDirectly(p,e,!0),l.texSubImage2D(p,f,i,n,o,a,c,h,t),u&&this._gl.generateMipmap(p),this._bindTextureDirectly(p,null)},r.prototype._uploadArrayBufferViewToTexture=function(e,t,i,n){i===void 0&&(i=0),n===void 0&&(n=0);var o=this._gl,a=e.isCube?o.TEXTURE_CUBE_MAP:o.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,i,n),this._bindTextureDirectly(a,null,!0)},r.prototype._prepareWebGLTextureContinuation=function(e,t,i,n,o){var a=this._gl;if(!!a){var s=this._getSamplingParameters(o,!i);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,s.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,s.min),!i&&!n&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},r.prototype._prepareWebGLTexture=function(e,t,i,n,o,a,s,f,u){var l=this;u===void 0&&(u=3);var h=this.getCaps().maxTextureSize,c=Math.min(h,this.needPOTTextures?r.GetExponentOfTwo(n.width,h):n.width),p=Math.min(h,this.needPOTTextures?r.GetExponentOfTwo(n.height,h):n.height),d=this._gl;if(!!d){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(d.TEXTURE_2D,e,!0),this._unpackFlipY(o===void 0?!0:!!o),e.baseWidth=n.width,e.baseHeight=n.height,e.width=c,e.height=p,e.isReady=!0,!f(c,p,n,t,e,function(){l._prepareWebGLTextureContinuation(e,i,a,s,u)})&&this._prepareWebGLTextureContinuation(e,i,a,s,u)}},r.prototype._setupFramebufferDepthAttachments=function(e,t,i,n,o){o===void 0&&(o=1);var a=this._gl;if(e&&t)return this._createRenderBuffer(i,n,o,a.DEPTH_STENCIL,a.DEPTH24_STENCIL8,a.DEPTH_STENCIL_ATTACHMENT);if(t){var s=a.DEPTH_COMPONENT16;return this._webGLVersion>1&&(s=a.DEPTH_COMPONENT32F),this._createRenderBuffer(i,n,o,s,s,a.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,n,o,a.STENCIL_INDEX8,a.STENCIL_INDEX8,a.STENCIL_ATTACHMENT):null},r.prototype._createRenderBuffer=function(e,t,i,n,o,a,s){s===void 0&&(s=!0);var f=this._gl,u=f.createRenderbuffer();return f.bindRenderbuffer(f.RENDERBUFFER,u),i>1&&f.renderbufferStorageMultisample?f.renderbufferStorageMultisample(f.RENDERBUFFER,i,o,e,t):f.renderbufferStorage(f.RENDERBUFFER,n,e,t),f.framebufferRenderbuffer(f.FRAMEBUFFER,a,f.RENDERBUFFER,u),s&&f.bindRenderbuffer(f.RENDERBUFFER,null),u},r.prototype._releaseTexture=function(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();var i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},r.prototype._releaseRenderTargetWrapper=function(e){var t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)},r.prototype._deleteTexture=function(e){e&&this._gl.deleteTexture(e)},r.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},r.prototype.bindSamplers=function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var i=e.getSamplers(),n=0;n<i.length;n++){var o=e.getUniform(i[n]);o&&(this._boundUniforms[n]=o)}this._currentEffect=null},r.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},r.prototype._bindTextureDirectly=function(e,t,i,n){var o,a;i===void 0&&(i=!1),n===void 0&&(n=!1);var s=!1,f=t&&t._associatedChannel>-1;i&&f&&(this._activeChannel=t._associatedChannel);var u=this._boundTexturesCache[this._activeChannel];if(u!==t||n){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(a=(o=t==null?void 0:t._hardwareTexture)===null||o===void 0?void 0:o.underlyingResource)!==null&&a!==void 0?a:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(s=!0,this._activateCurrentTexture());return f&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),s},r.prototype._bindTexture=function(e,t,i){if(e!==void 0){t&&(t._associatedChannel=e),this._activeChannel=e;var n=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,t)}},r.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},r.prototype.setTexture=function(e,t,i,n){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))},r.prototype._bindSamplerUniformToChannel=function(e,t){var i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)},r.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},r.prototype._setTexture=function(e,t,i,n,o){if(i===void 0&&(i=!1),n===void 0&&(n=!1),o===void 0&&(o=""),!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;var a;n?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!i&&a&&(a._associatedChannel=e);var s=!0;this._boundTexturesCache[e]===a&&(i||this._bindSamplerUniformToChannel(a._associatedChannel,e),s=!1),this._activeChannel=e;var f=this._getTextureTarget(a);if(s&&this._bindTextureDirectly(f,a,i),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;var u=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=u,t.wrapV=u}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(f,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(f,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(f,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(f,a,t.anisotropicFilteringLevel)}return!0},r.prototype.setTextureArray=function(e,t,i,n){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(var o=0;o<i.length;o++){var a=i[o].getInternalTexture();a?(this._textureUnits[o]=e+o,a._associatedChannel=e+o):this._textureUnits[o]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var s=0;s<i.length;s++)this._setTexture(this._textureUnits[s],i[s],!0)}},r.prototype._setAnisotropicLevel=function(e,t,i){var n=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),n&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)},r.prototype._setTextureParameterFloat=function(e,t,i,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,t,i)},r.prototype._setTextureParameterInteger=function(e,t,i,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,t,i)},r.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(var e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)},r.prototype.releaseEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}},r.prototype.dispose=function(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Me()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,ui.ResetCache();for(var t=0,i=this._activeRequests;t<i.length;t++){var n=i[t];n.abort()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},r.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},r.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},r.prototype.getError=function(){return this._gl.getError()},r.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},r.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},r.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var i=!0,n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var o=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,o),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);var a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&a===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);var s=t.RGBA,f=t.UNSIGNED_BYTE,u=new Uint8Array(4);t.readPixels(0,0,1,1,s,f,u),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(n),t.deleteFramebuffer(o),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i},r.prototype._getWebGLTextureType=function(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},r.prototype._getInternalFormat=function(e,t){t===void 0&&(t=!1);var i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i},r.prototype._getRGBABufferInternalSizedFormat=function(e,t,i){if(i===void 0&&(i=!1),this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8},r.prototype._getRGBAMultiSampleBufferFormat=function(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8},r.prototype._loadFile=function(e,t,i,n,o,a){var s=this,f=r._FileToolsLoadFile(e,t,i,n,o,a);return this._activeRequests.push(f),f.onCompleteObservable.add(function(u){s._activeRequests.splice(s._activeRequests.indexOf(u),1)}),f},r._FileToolsLoadFile=function(e,t,i,n,o,a){throw Q("FileTools")},r.prototype.readPixels=function(e,t,i,n,o,a){o===void 0&&(o=!0),a===void 0&&(a=!0);var s=o?4:3,f=o?this._gl.RGBA:this._gl.RGB,u=new Uint8Array(n*i*s);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,n,f,this._gl.UNSIGNED_BYTE,u),Promise.resolve(u)},Object.defineProperty(r,"IsSupportedAsync",{get:function(){return Promise.resolve(this.isSupported())},enumerable:!1,configurable:!0}),Object.defineProperty(r,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),r.isSupported=function(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch(i){this._IsSupported=!1}return this._IsSupported},Object.defineProperty(r,"HasMajorPerformanceCaveat",{get:function(){if(this._HasMajorPerformanceCaveat===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(i){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),r.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},r.FloorPOT=function(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)},r.NearestPOT=function(e){var t=r.CeilingPOT(e),i=r.FloorPOT(e);return t-e>e-i?i:t},r.GetExponentOfTwo=function(e,t,i){i===void 0&&(i=2);var n;switch(i){case 1:n=r.FloorPOT(e);break;case 2:n=r.NearestPOT(e);break;case 3:default:n=r.CeilingPOT(e);break}return Math.min(n,t)},r.QueueNewFrame=function(e,t){return Me()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16)):typeof requestAnimationFrame!="undefined"?requestAnimationFrame(e):setTimeout(e,16)},r.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:ni()?document:null},r.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],r._TextureLoaders=[],r.CollisionsEpsilon=.001,r._IsSupported=null,r._HasMajorPerformanceCaveat=null,r}();v();var Ir=function(){function r(){}return r.SetImmediate=function(e){Me()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)},r}();var dv=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),sh=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,si.LoadFileError)||this;return n.name="LoadFileError",ai._setPrototypeOf(n,e.prototype),i instanceof er?n.request=i:n.file=i,n}return e}(fi);var fh=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,si.RequestFileError)||this;return n.request=i,n.name="RequestFileError",ai._setPrototypeOf(n,e.prototype),n}return e}(fi);var pv=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,si.ReadFileError)||this;return n.file=i,n.name="ReadFileError",ai._setPrototypeOf(n,e.prototype),n}return e}(fi);var je={DefaultRetryStrategy:Hl.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:function(r){return r}},uh=function(r){return r=r.replace(/#/gm,"%23"),r},Bn=function(r,e){if(!(r&&r.indexOf("data:")===0)&&je.CorsBehavior)if(typeof je.CorsBehavior=="string"||je.CorsBehavior instanceof String)e.crossOrigin=je.CorsBehavior;else{var t=je.CorsBehavior(r);t&&(e.crossOrigin=t)}},Nn=function(r,e,t,i,n,o){var a;n===void 0&&(n="");var s,f=!1;r instanceof ArrayBuffer||ArrayBuffer.isView(r)?typeof Blob!="undefined"&&typeof URL!="undefined"?(s=URL.createObjectURL(new Blob([r],{type:n})),f=!0):s="data:".concat(n,";base64,")+On(r):r instanceof Blob?(s=URL.createObjectURL(r),f=!0):(s=uh(r),s=je.PreprocessUrl(r));var u=le.LastCreatedEngine,l=function(g){if(t){var T=s||r.toString();t("Error while trying to load image: ".concat(T.indexOf("http")===0||T.length<=128?T:T.slice(0,128)+"..."),g)}};if(typeof Image=="undefined"||((a=u==null?void 0:u._features.forceBitmapOverHTMLImageElement)!==null&&a!==void 0?a:!1))return rr(s,function(g){u.createImageBitmap(new Blob([g],{type:n}),Vt({premultiplyAlpha:"none"},o)).then(function(T){e(T),f&&URL.revokeObjectURL(s)}).catch(function(T){t&&t("Error while trying to load image: "+r,T)})},void 0,i||void 0,!0,function(g,T){l(T)}),null;var h=new Image;Bn(s,h);var c=function(){h.removeEventListener("load",c),h.removeEventListener("error",p),e(h),f&&h.src&&URL.revokeObjectURL(h.src)},p=function(g){h.removeEventListener("load",c),h.removeEventListener("error",p),l(g),f&&h.src&&URL.revokeObjectURL(h.src)};h.addEventListener("load",c),h.addEventListener("error",p);var d=function(){h.src=s},m=function(){i&&i.loadImage(s,h)};if(s.substr(0,5)!=="blob:"&&s.substr(0,5)!=="data:"&&i&&i.enableTexturesOffline)i.open(m,d);else{if(s.indexOf("file:")!==-1){var _=decodeURIComponent(s.substring(5).toLowerCase());if(Ui.FilesToLoad[_]&&typeof URL!="undefined"){try{var y=void 0;try{y=URL.createObjectURL(Ui.FilesToLoad[_])}catch(g){y=URL.createObjectURL(Ui.FilesToLoad[_])}h.src=y,f=!0}catch(g){h.src=""}return h}}d()}return h},Dr=function(r,e,t,i,n){var o=new FileReader,a={onCompleteObservable:new U,abort:function(){return o.abort()}};return o.onloadend=function(){return a.onCompleteObservable.notifyObservers(a)},n&&(o.onerror=function(){n(new pv("Unable to read ".concat(r.name),r))}),o.onload=function(s){e(s.target.result)},t&&(o.onprogress=t),i?o.readAsArrayBuffer(r):o.readAsText(r),a},rr=function(r,e,t,i,n,o,a){if(r.name)return Dr(r,e,t,n,o?function(h){o(void 0,h)}:void 0);var s=r;if(s.indexOf("file:")!==-1){var f=decodeURIComponent(s.substring(5).toLowerCase());f.indexOf("./")===0&&(f=f.substring(2));var u=Ui.FilesToLoad[f];if(u)return Dr(u,e,t,n,o?function(h){return o(void 0,new sh(h.message,h.file))}:void 0)}if(kn(s)){var l={onCompleteObservable:new U,abort:function(){return function(){}}};try{e(n?Vn(s):hh(s))}catch(h){o?o(void 0,h):q.Error(h.message||"Failed to parse the Data URL")}return Ir.SetImmediate(function(){l.onCompleteObservable.notifyObservers(l)}),l}return Un(s,function(h,c){e(h,c?c.responseURL:void 0)},t,i,n,o?function(h){o(h.request,new sh(h.message,h.request))}:void 0,a)},Un=function(r,e,t,i,n,o,a){r=uh(r),r=je.PreprocessUrl(r);var s=je.BaseUrl+r,f=!1,u={onCompleteObservable:new U,abort:function(){return f=!0}},l=function(){var p=new er,d=null,m,_=function(){!p||(t&&p.removeEventListener("progress",t),m&&p.removeEventListener("readystatechange",m),p.removeEventListener("loadend",y))},y=function(){_(),u.onCompleteObservable.notifyObservers(u),u.onCompleteObservable.clear(),t=void 0,m=null,y=null,o=void 0,a=void 0,e=void 0};u.abort=function(){f=!0,y&&y(),p&&p.readyState!==(XMLHttpRequest.DONE||4)&&p.abort(),d!==null&&(clearTimeout(d),d=null),p=null};var g=function(A){var M=A.message||"Unknown error";o&&p?o(new fh(M,p)):q.Error(M)},T=function(A){if(!!p){if(p.open("GET",s),a)try{a(p)}catch(M){g(M);return}n&&(p.responseType="arraybuffer"),t&&p.addEventListener("progress",t),y&&p.addEventListener("loadend",y),m=function(){if(!(f||!p)&&p.readyState===(XMLHttpRequest.DONE||4)){if(m&&p.removeEventListener("readystatechange",m),p.status>=200&&p.status<300||p.status===0&&(!Me()||lh())){try{e&&e(n?p.response:p.responseText,p)}catch(R){g(R)}return}var M=je.DefaultRetryStrategy;if(M){var C=M(s,p,A);if(C!==-1){_(),p=new er,d=setTimeout(function(){return T(A+1)},C);return}}var P=new fh("Error status: "+p.status+" "+p.statusText+" - Unable to load "+s,p);o&&o(P)}},p.addEventListener("readystatechange",m),p.send()}};T(0)};if(i&&i.enableSceneOffline){var h=function(p){p&&p.status>400?o&&o(p):l()},c=function(){i&&i.loadFile(je.BaseUrl+r,function(p){!f&&e&&e(p),u.onCompleteObservable.notifyObservers(u)},t?function(p){!f&&t&&t(p)}:void 0,h,n)};i.open(c,h)}else l();return u},lh=function(){return typeof location!="undefined"&&location.protocol==="file:"},kn=function(r){return dv.test(r)};function Vn(r){return Kl(r.split(",")[1])}var hh=function(r){return pa(r.split(",")[1])},_v=function(){me._FileToolsLoadImage=Nn,me._FileToolsLoadFile=rr,Cr._FileToolsLoadFile=rr};_v();var Vi,vv=function(r,e,t,i,n,o,a,s,f,u){Vi={DecodeBase64UrlToBinary:r,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:n,LoadFile:o,LoadImage:a,ReadFile:s,RequestFile:f,SetCorsBehavior:u},Object.defineProperty(Vi,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(l){t.DefaultRetryStrategy=l}}),Object.defineProperty(Vi,"BaseUrl",{get:function(){return t.BaseUrl},set:function(l){t.BaseUrl=l}}),Object.defineProperty(Vi,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(l){t.PreprocessUrl=l}}),Object.defineProperty(Vi,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(l){t.CorsBehavior=l}})};vv(Vn,hh,je,kn,lh,rr,Nn,Dr,Un,Bn);v();var hi=function(){function r(){}return r.Instantiate=function(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];var t=wt(e);if(t)return t;q.Warn(e+" not found, you may have missed an import.");for(var i=e.split("."),n=window||this,o=0,a=i.length;o<a;o++)n=n[i[o]];return typeof n!="function"?null:n},r.RegisteredExternalClasses={},r}();v();function Wn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){var e=Math.random()*16|0,t=r==="x"?e:e&3|8;return t.toString(16)})}var he=function(){function r(){}return Object.defineProperty(r,"BaseUrl",{get:function(){return je.BaseUrl},set:function(e){je.BaseUrl=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"DefaultRetryStrategy",{get:function(){return je.DefaultRetryStrategy},set:function(e){je.DefaultRetryStrategy=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"CorsBehavior",{get:function(){return je.CorsBehavior},set:function(e){je.CorsBehavior=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"UseFallbackTexture",{get:function(){return le.UseFallbackTexture},set:function(e){le.UseFallbackTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RegisteredExternalClasses",{get:function(){return hi.RegisteredExternalClasses},set:function(e){hi.RegisteredExternalClasses=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"fallbackTexture",{get:function(){return le.FallbackTexture},set:function(e){le.FallbackTexture=e},enumerable:!1,configurable:!0}),r.FetchToRef=function(e,t,i,n,o,a){var s=Math.abs(e)*i%i|0,f=Math.abs(t)*n%n|0,u=(s+f*i)*4;a.r=o[u]/255,a.g=o[u+1]/255,a.b=o[u+2]/255,a.a=o[u+3]/255},r.Mix=function(e,t,i){return e*(1-i)+t*i},r.Instantiate=function(e){return hi.Instantiate(e)},r.SetImmediate=function(e){Ir.SetImmediate(e)},r.IsExponentOfTwo=function(e){var t=1;do t*=2;while(t<e);return t===e},r.FloatRound=function(e){return Math.fround?Math.fround(e):(r._TmpFloatArray[0]=e,r._TmpFloatArray[0])},r.GetFilename=function(e){var t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)},r.GetFolderPath=function(e,t){t===void 0&&(t=!1);var i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)},r.ToDegrees=function(e){return e*180/Math.PI},r.ToRadians=function(e){return e*Math.PI/180},r.MakeArray=function(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]},r.GetPointerPrefix=function(e){var t="pointer";return Me()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t},r.SetCorsBehavior=function(e,t){Bn(e,t)},r.SetReferrerPolicyBehavior=function(e,t){t.referrerPolicy=e},r.CleanUrl=function(e){return e=e.replace(/#/gm,"%23"),e},Object.defineProperty(r,"PreprocessUrl",{get:function(){return je.PreprocessUrl},set:function(e){je.PreprocessUrl=e},enumerable:!1,configurable:!0}),r.LoadImage=function(e,t,i,n,o,a){return Nn(e,t,i,n,o,a)},r.LoadFile=function(e,t,i,n,o,a){return rr(e,t,i,n,o,a)},r.LoadFileAsync=function(e,t){return t===void 0&&(t=!0),new Promise(function(i,n){rr(e,function(o){i(o)},void 0,void 0,t,function(o,a){n(a)})})},r.LoadScript=function(e,t,i,n){if(!!Me()){var o=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e),n&&(a.id=n),a.onload=function(){t&&t()},a.onerror=function(s){i&&i("Unable to load script '".concat(e,"'"),s)},o.appendChild(a)}},r.LoadScriptAsync=function(e){var t=this;return new Promise(function(i,n){t.LoadScript(e,function(){i()},function(o,a){n(a)})})},r.ReadFileAsDataURL=function(e,t,i){var n=new FileReader,o={onCompleteObservable:new U,abort:function(){return n.abort()}};return n.onloadend=function(){o.onCompleteObservable.notifyObservers(o)},n.onload=function(a){t(a.target.result)},n.onprogress=i,n.readAsDataURL(e),o},r.ReadFile=function(e,t,i,n,o){return Dr(e,t,i,n,o)},r.FileAsURL=function(e){var t=new Blob([e]),i=window.URL||window.webkitURL,n=i.createObjectURL(t);return n},r.Format=function(e,t){return t===void 0&&(t=2),e.toFixed(t)},r.DeepCopy=function(e,t,i,n){oi.DeepCopy(e,t,i,n)},r.IsEmpty=function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},r.RegisterTopRootEvents=function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch(o){}}},r.UnregisterTopRootEvents=function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch(o){}}},r.DumpFramebuffer=function(e,t,i,n,o,a){return o===void 0&&(o="image/png"),ii(this,void 0,void 0,function(){var s,f;return Lt(this,function(u){switch(u.label){case 0:return[4,i.readPixels(0,0,e,t)];case 1:return s=u.sent(),f=new Uint8Array(s.buffer),r.DumpData(e,t,f,n,o,a,!0),[2]}})})},r.DumpData=function(e,t,i,n,o,a,s,f,u){o===void 0&&(o="image/png"),s===void 0&&(s=!1),f===void 0&&(f=!1),r._ScreenshotCanvas||(r._ScreenshotCanvas=document.createElement("canvas")),r._ScreenshotCanvas.width=e,r._ScreenshotCanvas.height=t;var l=r._ScreenshotCanvas.getContext("2d");if(l){if(i instanceof Float32Array){for(var h=new Uint8Array(i.length),c=i.length;c--;){var p=i[c];h[c]=p<0?0:p>1?1:Math.round(p*255)}i=h}var d=l.createImageData(e,t),m=d.data;m.set(i),l.putImageData(d,0,0);var _=r._ScreenshotCanvas;if(s){var y=document.createElement("canvas");y.width=e,y.height=t;var g=y.getContext("2d");if(!g)return;g.translate(0,t),g.scale(1,-1),g.drawImage(r._ScreenshotCanvas,0,0),_=y}f?r.ToBlob(_,function(T){var A=new FileReader;A.onload=function(M){var C=M.target.result;n&&n(C)},A.readAsArrayBuffer(T)},o,u):r.EncodeScreenshotCanvasData(n,o,a,_,u)}},r.DumpDataAsync=function(e,t,i,n,o,a,s,f){return n===void 0&&(n="image/png"),a===void 0&&(a=!1),s===void 0&&(s=!1),new Promise(function(u){r.DumpData(e,t,i,function(l){return u(l)},n,o,a,s,f)})},r.ToBlob=function(e,t,i,n){i===void 0&&(i="image/png"),e.toBlob||(e.toBlob=function(o,a,s){var f=this;setTimeout(function(){for(var u=atob(f.toDataURL(a,s).split(",")[1]),l=u.length,h=new Uint8Array(l),c=0;c<l;c++)h[c]=u.charCodeAt(c);o(new Blob([h]))})}),e.toBlob(function(o){t(o)},i,n)},r.DownloadBlob=function(e,t){if("download"in document.createElement("a")){if(!t){var i=new Date,n=(i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2);t="screenshot_"+n+".png"}r.Download(e,t)}else if(e&&typeof URL!="undefined"){var o=URL.createObjectURL(e),a=window.open("");if(!a)return;var s=a.document.createElement("img");s.onload=function(){URL.revokeObjectURL(o)},s.src=o,a.document.body.appendChild(s)}},r.EncodeScreenshotCanvasData=function(e,t,i,n,o){if(t===void 0&&(t="image/png"),e){var a=(n!=null?n:r._ScreenshotCanvas).toDataURL(t,o);e(a)}else this.ToBlob(n!=null?n:r._ScreenshotCanvas,function(s){s&&r.DownloadBlob(s,i)},t,o)},r.Download=function(e,t){if(navigator&&navigator.msSaveBlob){navigator.msSaveBlob(e,t);return}if(typeof URL!="undefined"){var i=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=i,n.download=t,n.addEventListener("click",function(){n.parentElement&&n.parentElement.removeChild(n)}),n.click(),window.URL.revokeObjectURL(i)}},r.BackCompatCameraNoPreventDefault=function(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1},r.CreateScreenshot=function(e,t,i,n,o){throw o===void 0&&(o="image/png"),Q("ScreenshotTools")},r.CreateScreenshotAsync=function(e,t,i,n){throw n===void 0&&(n="image/png"),Q("ScreenshotTools")},r.CreateScreenshotUsingRenderTarget=function(e,t,i,n,o,a,s,f){throw o===void 0&&(o="image/png"),a===void 0&&(a=1),s===void 0&&(s=!1),Q("ScreenshotTools")},r.CreateScreenshotUsingRenderTargetAsync=function(e,t,i,n,o,a,s){throw n===void 0&&(n="image/png"),o===void 0&&(o=1),a===void 0&&(a=!1),Q("ScreenshotTools")},r.RandomId=function(){return Wn()},r.IsBase64=function(e){return kn(e)},r.DecodeBase64=function(e){return Vn(e)},Object.defineProperty(r,"errorsCount",{get:function(){return q.errorsCount},enumerable:!1,configurable:!0}),r.Log=function(e){q.Log(e)},r.Warn=function(e){q.Warn(e)},r.Error=function(e){q.Error(e)},Object.defineProperty(r,"LogCache",{get:function(){return q.LogCache},enumerable:!1,configurable:!0}),r.ClearLogCache=function(){q.ClearLogCache()},Object.defineProperty(r,"LogLevels",{set:function(e){q.LogLevels=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"PerformanceLogLevel",{set:function(e){if((e&r.PerformanceUserMarkLogLevel)===r.PerformanceUserMarkLogLevel){r.StartPerformanceCounter=r._StartUserMark,r.EndPerformanceCounter=r._EndUserMark;return}if((e&r.PerformanceConsoleLogLevel)===r.PerformanceConsoleLogLevel){r.StartPerformanceCounter=r._StartPerformanceConsole,r.EndPerformanceCounter=r._EndPerformanceConsole;return}r.StartPerformanceCounter=r._StartPerformanceCounterDisabled,r.EndPerformanceCounter=r._EndPerformanceCounterDisabled},enumerable:!1,configurable:!0}),r._StartPerformanceCounterDisabled=function(e,t){},r._EndPerformanceCounterDisabled=function(e,t){},r._StartUserMark=function(e,t){if(t===void 0&&(t=!0),!r._Performance){if(!Me())return;r._Performance=window.performance}!t||!r._Performance.mark||r._Performance.mark(e+"-Begin")},r._EndUserMark=function(e,t){t===void 0&&(t=!0),!(!t||!r._Performance.mark)&&(r._Performance.mark(e+"-End"),r._Performance.measure(e,e+"-Begin",e+"-End"))},r._StartPerformanceConsole=function(e,t){t===void 0&&(t=!0),t&&(r._StartUserMark(e,t),console.time&&console.time(e))},r._EndPerformanceConsole=function(e,t){t===void 0&&(t=!0),t&&(r._EndUserMark(e,t),console.timeEnd(e))},Object.defineProperty(r,"Now",{get:function(){return Wt.Now},enumerable:!1,configurable:!0}),r.GetClassName=function(e,t){t===void 0&&(t=!1);var i=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){var n=t?e:Object.getPrototypeOf(e);i=n.constructor.__bjsclassName__}i||(i=typeof e)}return i},r.First=function(e,t){for(var i=0,n=e;i<n.length;i++){var o=n[i];if(t(o))return o}return null},r.getFullClassName=function(e,t){t===void 0&&(t=!1);var i=null,n=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){var o=t?e:Object.getPrototypeOf(e);i=o.constructor.__bjsclassName__,n=o.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(n!=null?n+".":"")+i:null},r.DelayAsync=function(e){return new Promise(function(t){setTimeout(function(){t()},e)})},r.IsSafari=function(){return da()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1},r.UseCustomRequestHeaders=!1,r.CustomRequestHeaders=er.CustomRequestHeaders,r._TmpFloatArray=new Float32Array(1),r.GetDOMTextContent=Bi,r.GetAbsoluteUrl=typeof document=="object"?function(e){var t=document.createElement("a");return t.href=e,t.href}:typeof URL=="function"&&typeof location=="object"?function(e){return new URL(e,location.origin).href}:function(){throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},r.NoneLogLevel=q.NoneLogLevel,r.MessageLogLevel=q.MessageLogLevel,r.WarningLogLevel=q.WarningLogLevel,r.ErrorLogLevel=q.ErrorLogLevel,r.AllLogLevel=q.AllLogLevel,r.IsWindowObjectExist=Me,r.PerformanceNoneLogLevel=0,r.PerformanceUserMarkLogLevel=1,r.PerformanceConsoleLogLevel=2,r.StartPerformanceCounter=r._StartPerformanceCounterDisabled,r.EndPerformanceCounter=r._EndPerformanceCounterDisabled,r}();var ch=function(){function r(e,t,i,n){n===void 0&&(n=0),this.iterations=e,this.index=n-1,this._done=!1,this._fn=t,this._successCallback=i}return r.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},r.prototype.breakLoop=function(){this._done=!0,this._successCallback()},r.Run=function(e,t,i,n){n===void 0&&(n=0);var o=new r(e,t,i,n);return o.executeNext(),o},r.SyncAsyncForLoop=function(e,t,i,n,o,a){return a===void 0&&(a=0),r.Run(Math.ceil(e/t),function(s){o&&o()?s.breakLoop():setTimeout(function(){for(var f=0;f<t;++f){var u=s.index*t+f;if(u>=e)break;if(i(u),o&&o()){s.breakLoop();break}}s.executeNext()},a)},n)},r}();le.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";v();v();var dh=function(){function r(){}return r.Eval=function(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,function(i){return i=i.slice(1,i.length-1),r._HandleParenthesisContent(i,t)}):e=r._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:r.Eval(e,t)},r._HandleParenthesisContent=function(e,t){t=t||function(l){return l==="true"};var i,n=e.split("||");for(var o in n)if(Object.prototype.hasOwnProperty.call(n,o)){var a=r._SimplifyNegation(n[o].trim()),s=a.split("&&");if(s.length>1)for(var f=0;f<s.length;++f){var u=r._SimplifyNegation(s[f].trim());if(u!=="true"&&u!=="false"?u[0]==="!"?i=!t(u.substring(1)):i=t(u):i=u==="true",!i){a="false";break}}if(i||a==="true"){i=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?i=!t(a.substring(1)):i=t(a):i=a==="true"}return i?"true":"false"},r._SimplifyNegation=function(e){return e=e.replace(/^[\s!]+/,function(t){return t=t.replace(/[\s]/g,function(){return""}),t.length%2?"!":""}),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e},r}();var Ee=function(){function r(){}return r.EnableFor=function(e){e._tags=e._tags||{},e.hasTags=function(){return r.HasTags(e)},e.addTags=function(t){return r.AddTagsTo(e,t)},e.removeTags=function(t){return r.RemoveTagsFrom(e,t)},e.matchesTagsQuery=function(t){return r.MatchesQuery(e,t)}},r.DisableFor=function(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery},r.HasTags=function(e){if(!e._tags)return!1;var t=e._tags;for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1},r.GetTags=function(e,t){if(t===void 0&&(t=!0),!e._tags)return null;if(t){var i=[];for(var n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&e._tags[n]===!0&&i.push(n);return i.join(" ")}else return e._tags},r.AddTagsTo=function(e,t){if(!!t&&typeof t=="string"){var i=t.split(" ");i.forEach(function(n){r._AddTagTo(e,n)})}},r._AddTagTo=function(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(r.EnableFor(e),e._tags[t]=!0))},r.RemoveTagsFrom=function(e,t){if(!!r.HasTags(e)){var i=t.split(" ");for(var n in i)r._RemoveTagFrom(e,i[n])}},r._RemoveTagFrom=function(e,t){delete e._tags[t]},r.MatchesQuery=function(e,t){return t===void 0?!0:t===""?r.HasTags(e):dh.Eval(t,function(i){return r.HasTags(e)&&e._tags[i]})},r}();v();function va(r,e,t){try{var i=r.next();i.done?e(i):i.value?i.value.then(function(){i.value=void 0,e(i)},t):e(i)}catch(n){t(n)}}function ph(r){r===void 0&&(r=25);var e;return function(t,i,n){var o=performance.now();e===void 0||o-e>r?(e=o,setTimeout(function(){va(t,i,n)},0)):va(t,i,n)}}function _h(r,e,t,i,n){var o=function(){var a,s=function(f){f.done?t(f.value):a===void 0?a=!0:o()};do a=void 0,!n||!n.aborted?e(r,s,i):i(new Error("Aborted")),a===void 0&&(a=!1);while(a)};o()}function Wi(r,e){var t;return _h(r,va,function(i){return t=i},function(i){throw i},e),t}function vh(r,e,t){return new Promise(function(i,n){_h(r,e,i,n,t)})}function mh(r,e){return function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return Wi(r.apply(void 0,t),e)}}v();var mt=function(r){return parseInt(r.toString().replace(/\W/g,""))},_e=function(){function r(e,t){e===void 0&&(e=0),t===void 0&&(t=0),this.x=e,this.y=t}return r.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y,"}")},r.prototype.getClassName=function(){return"Vector2"},r.prototype.getHashCode=function(){var e=mt(this.x),t=mt(this.y),i=e;return i=i*397^t,i},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,this},r.prototype.fromArray=function(e,t){return t===void 0&&(t=0),r.FromArrayToRef(e,t,this),this},r.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},r.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this},r.prototype.copyFromFloats=function(e,t){return this.x=e,this.y=t,this},r.prototype.set=function(e,t){return this.copyFromFloats(e,t)},r.prototype.add=function(e){return new r(this.x+e.x,this.y+e.y)},r.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,this},r.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this},r.prototype.addVector3=function(e){return new r(this.x+e.x,this.y+e.y)},r.prototype.subtract=function(e){return new r(this.x-e.x,this.y-e.y)},r.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,this},r.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this},r.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this},r.prototype.multiply=function(e){return new r(this.x*e.x,this.y*e.y)},r.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,this},r.prototype.multiplyByFloats=function(e,t){return new r(this.x*e,this.y*t)},r.prototype.divide=function(e){return new r(this.x/e.x,this.y/e.y)},r.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,this},r.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},r.prototype.negate=function(){return new r(-this.x,-this.y)},r.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this},r.prototype.negateToRef=function(e){return e.copyFromFloats(this.x*-1,this.y*-1)},r.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this},r.prototype.scale=function(e){var t=new r(0,0);return this.scaleToRef(e,t),t},r.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,this},r.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,this},r.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},r.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=ye),e&&ae.WithinEpsilon(this.x,e.x,t)&&ae.WithinEpsilon(this.y,e.y,t)},r.prototype.floor=function(){return new r(Math.floor(this.x),Math.floor(this.y))},r.prototype.fract=function(){return new r(this.x-Math.floor(this.x),this.y-Math.floor(this.y))},r.prototype.rotateToRef=function(e,t){var i=Math.cos(e),n=Math.sin(e);return t.x=i*this.x-n*this.y,t.y=n*this.x+i*this.y,this},r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},r.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},r.prototype.normalize=function(){return r.NormalizeToRef(this,this),this},r.prototype.clone=function(){return new r(this.x,this.y)},r.Zero=function(){return new r(0,0)},r.One=function(){return new r(1,1)},Object.defineProperty(r,"ZeroReadOnly",{get:function(){return r._ZeroReadOnly},enumerable:!1,configurable:!0}),r.FromArray=function(e,t){return t===void 0&&(t=0),new r(e[t],e[t+1])},r.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1]},r.CatmullRom=function(e,t,i,n,o){var a=o*o,s=o*a,f=.5*(2*t.x+(-e.x+i.x)*o+(2*e.x-5*t.x+4*i.x-n.x)*a+(-e.x+3*t.x-3*i.x+n.x)*s),u=.5*(2*t.y+(-e.y+i.y)*o+(2*e.y-5*t.y+4*i.y-n.y)*a+(-e.y+3*t.y-3*i.y+n.y)*s);return new r(f,u)},r.Clamp=function(e,t,i){var n=e.x;n=n>i.x?i.x:n,n=n<t.x?t.x:n;var o=e.y;return o=o>i.y?i.y:o,o=o<t.y?t.y:o,new r(n,o)},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a,c=e.x*f+i.x*u+t.x*l+n.x*h,p=e.y*f+i.y*u+t.y*l+n.y*h;return new r(c,p)},r.Hermite1stDerivative=function(e,t,i,n,o){var a=r.Zero();return this.Hermite1stDerivativeToRef(e,t,i,n,o,a),a},r.Hermite1stDerivativeToRef=function(e,t,i,n,o,a){var s=o*o;a.x=(s-o)*6*e.x+(3*s-4*o+1)*t.x+(-s+o)*6*i.x+(3*s-2*o)*n.x,a.y=(s-o)*6*e.y+(3*s-4*o+1)*t.y+(-s+o)*6*i.y+(3*s-2*o)*n.y},r.Lerp=function(e,t,i){var n=e.x+(t.x-e.x)*i,o=e.y+(t.y-e.y)*i;return new r(n,o)},r.Dot=function(e,t){return e.x*t.x+e.y*t.y},r.Normalize=function(e){var t=r.Zero();return this.NormalizeToRef(e,t),t},r.NormalizeToRef=function(e,t){var i=e.length();i!==0&&(t.x=e.x/i,t.y=e.y/i)},r.Minimize=function(e,t){var i=e.x<t.x?e.x:t.x,n=e.y<t.y?e.y:t.y;return new r(i,n)},r.Maximize=function(e,t){var i=e.x>t.x?e.x:t.x,n=e.y>t.y?e.y:t.y;return new r(i,n)},r.Transform=function(e,t){var i=r.Zero();return r.TransformToRef(e,t,i),i},r.TransformToRef=function(e,t,i){var n=t.m,o=e.x*n[0]+e.y*n[4]+n[12],a=e.x*n[1]+e.y*n[5]+n[13];i.x=o,i.y=a},r.PointInTriangle=function(e,t,i,n){var o=.5*(-i.y*n.x+t.y*(-i.x+n.x)+t.x*(i.y-n.y)+i.x*n.y),a=o<0?-1:1,s=(t.y*n.x-t.x*n.y+(n.y-t.y)*e.x+(t.x-n.x)*e.y)*a,f=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*a;return s>0&&f>0&&s+f<2*o*a},r.Distance=function(e,t){return Math.sqrt(r.DistanceSquared(e,t))},r.DistanceSquared=function(e,t){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},r.Center=function(e,t){return r.CenterToRef(e,t,r.Zero())},r.CenterToRef=function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)},r.DistanceOfPointFromSegment=function(e,t,i){var n=r.DistanceSquared(t,i);if(n===0)return r.Distance(e,t);var o=i.subtract(t),a=Math.max(0,Math.min(1,r.Dot(e.subtract(t),o)/n)),s=t.add(o.multiplyByFloats(a,a));return r.Distance(e,s)},r._ZeroReadOnly=r.Zero(),r}();var E=function(){function r(e,t,i){e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=0),this._isDirty=!0,this._x=e,this._y=t,this._z=i}return Object.defineProperty(r.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),r.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z,"}")},r.prototype.getClassName=function(){return"Vector3"},r.prototype.getHashCode=function(){var e=mt(this._x),t=mt(this._y),i=mt(this._z),n=e;return n=n*397^t,n=n*397^i,n},r.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this},r.prototype.fromArray=function(e,t){return t===void 0&&(t=0),r.FromArrayToRef(e,t,this),this},r.prototype.toQuaternion=function(){return ie.RotationYawPitchRoll(this._y,this._x,this._z)},r.prototype.addInPlace=function(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)},r.prototype.addInPlaceFromFloats=function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this},r.prototype.add=function(e){return new r(this._x+e._x,this._y+e._y,this._z+e._z)},r.prototype.addToRef=function(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)},r.prototype.subtractInPlace=function(e){return this.x-=e._x,this.y-=e._y,this.z-=e._z,this},r.prototype.subtract=function(e){return new r(this._x-e._x,this._y-e._y,this._z-e._z)},r.prototype.subtractToRef=function(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)},r.prototype.subtractFromFloats=function(e,t,i){return new r(this._x-e,this._y-t,this._z-i)},r.prototype.subtractFromFloatsToRef=function(e,t,i,n){return n.copyFromFloats(this._x-e,this._y-t,this._z-i)},r.prototype.negate=function(){return new r(-this._x,-this._y,-this._z)},r.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},r.prototype.negateToRef=function(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)},r.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this},r.prototype.scale=function(e){return new r(this._x*e,this._y*e,this._z*e)},r.prototype.scaleToRef=function(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)},r.prototype.applyRotationQuaternionToRef=function(e,t){var i=e.w*this.x+e.y*this.z-e.z*this.y,n=e.w*this.y+e.z*this.x-e.x*this.z,o=e.w*this.z+e.x*this.y-e.y*this.x,a=-e.x*this.x-e.y*this.y-e.z*this.z;return t.x=i*e.w+a*-e.x+n*-e.z-o*-e.y,t.y=n*e.w+a*-e.y+o*-e.x-i*-e.z,t.z=o*e.w+a*-e.z+i*-e.y-n*-e.x,t},r.prototype.applyRotationQuaternionInPlace=function(e){return this.applyRotationQuaternionToRef(e,this)},r.prototype.applyRotationQuaternion=function(e){return this.applyRotationQuaternionToRef(e,r.Zero())},r.prototype.scaleAndAddToRef=function(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)},r.prototype.projectOnPlane=function(e,t){var i=r.Zero();return this.projectOnPlaneToRef(e,t,i),i},r.prototype.projectOnPlaneToRef=function(e,t,i){var n=e.normal,o=e.d,a=Z.Vector3[0];this.subtractToRef(t,a),a.normalize();var s=r.Dot(a,n);if(Math.abs(s)<Math.pow(10,-10))i.setAll(1/0);else{var f=-(r.Dot(t,n)+o)/s,u=a.scaleInPlace(f);t.addToRef(u,i)}},r.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z},r.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=ye),e&&ae.WithinEpsilon(this._x,e._x,t)&&ae.WithinEpsilon(this._y,e._y,t)&&ae.WithinEpsilon(this._z,e._z,t)},r.prototype.equalsToFloats=function(e,t,i){return this._x===e&&this._y===t&&this._z===i},r.prototype.multiplyInPlace=function(e){return this.x*=e._x,this.y*=e._y,this.z*=e._z,this},r.prototype.multiply=function(e){return this.multiplyByFloats(e._x,e._y,e._z)},r.prototype.multiplyToRef=function(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)},r.prototype.multiplyByFloats=function(e,t,i){return new r(this._x*e,this._y*t,this._z*i)},r.prototype.divide=function(e){return new r(this._x/e._x,this._y/e._y,this._z/e._z)},r.prototype.divideToRef=function(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)},r.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},r.prototype.minimizeInPlace=function(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)},r.prototype.maximizeInPlace=function(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)},r.prototype.minimizeInPlaceFromFloats=function(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this},r.prototype.maximizeInPlaceFromFloats=function(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this},r.prototype.isNonUniformWithinEpsilon=function(e){var t=Math.abs(this._x),i=Math.abs(this._y);if(!ae.WithinEpsilon(t,i,e))return!0;var n=Math.abs(this._z);return!ae.WithinEpsilon(t,n,e)||!ae.WithinEpsilon(i,n,e)},Object.defineProperty(r.prototype,"isNonUniform",{get:function(){var e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;var i=Math.abs(this._z);return e!==i},enumerable:!1,configurable:!0}),r.prototype.floor=function(){return new r(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))},r.prototype.fract=function(){return new r(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))},r.prototype.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)},r.prototype.lengthSquared=function(){return this._x*this._x+this._y*this._y+this._z*this._z},Object.defineProperty(r.prototype,"hasAZeroComponent",{get:function(){return this._x*this._y*this._z===0},enumerable:!1,configurable:!0}),r.prototype.normalize=function(){return this.normalizeFromLength(this.length())},r.prototype.reorderInPlace=function(e){var t=this;return e=e.toLowerCase(),e==="xyz"?this:(Z.Vector3[0].copyFrom(this),["x","y","z"].forEach(function(i,n){t[i]=Z.Vector3[0][e[n]]}),this)},r.prototype.rotateByQuaternionToRef=function(e,t){return e.toRotationMatrix(Z.Matrix[0]),r.TransformCoordinatesToRef(this,Z.Matrix[0],t),t},r.prototype.rotateByQuaternionAroundPointToRef=function(e,t,i){return this.subtractToRef(t,Z.Vector3[0]),Z.Vector3[0].rotateByQuaternionToRef(e,Z.Vector3[0]),t.addToRef(Z.Vector3[0],i),i},r.prototype.cross=function(e){return r.Cross(this,e)},r.prototype.normalizeFromLength=function(e){return e===0||e===1?this:this.scaleInPlace(1/e)},r.prototype.normalizeToNew=function(){var e=new r(0,0,0);return this.normalizeToRef(e),e},r.prototype.normalizeToRef=function(e){var t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)},r.prototype.clone=function(){return new r(this._x,this._y,this._z)},r.prototype.copyFrom=function(e){return this.copyFromFloats(e._x,e._y,e._z)},r.prototype.copyFromFloats=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},r.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)},r.prototype.setAll=function(e){return this.x=this.y=this.z=e,this},r.GetClipFactor=function(e,t,i,n){var o=r.Dot(e,i)-n,a=r.Dot(t,i)-n,s=o/(o-a);return s},r.GetAngleBetweenVectors=function(e,t,i){var n=e.normalizeToRef(Z.Vector3[1]),o=t.normalizeToRef(Z.Vector3[2]),a=r.Dot(n,o);a=ae.Clamp(a,-1,1);var s=Math.acos(a),f=Z.Vector3[3];return r.CrossToRef(n,o,f),r.Dot(f,i)>0?isNaN(s)?0:s:isNaN(s)?-Math.PI:-Math.acos(a)},r.GetAngleBetweenVectorsOnPlane=function(e,t,i){Z.Vector3[0].copyFrom(e);var n=Z.Vector3[0];Z.Vector3[1].copyFrom(t);var o=Z.Vector3[1];Z.Vector3[2].copyFrom(i);var a=Z.Vector3[2],s=Z.Vector3[3],f=Z.Vector3[4];n.normalize(),o.normalize(),a.normalize(),r.CrossToRef(a,n,s),r.CrossToRef(s,a,f);var u=Math.atan2(r.Dot(o,s),r.Dot(o,f));return ae.NormalizeRadians(u)},r.SlerpToRef=function(e,t,i,n){i=ae.Clamp(i,0,1);var o=Z.Vector3[0],a=Z.Vector3[1];o.copyFrom(e);var s=o.length();o.normalizeFromLength(s),a.copyFrom(t);var f=a.length();a.normalizeFromLength(f);var u=r.Dot(o,a),l,h;if(u<1-ye){var c=Math.acos(u),p=1/Math.sin(c);l=Math.sin((1-i)*c)*p,h=Math.sin(i*c)*p}else l=1-i,h=i;o.scaleInPlace(l),a.scaleInPlace(h),n.copyFrom(o).addInPlace(a),n.scaleInPlace(ae.Lerp(s,f,i))},r.SmoothToRef=function(e,t,i,n,o){r.SlerpToRef(e,t,n===0?1:i/n,o)},r.FromArray=function(e,t){return t===void 0&&(t=0),new r(e[t],e[t+1],e[t+2])},r.FromFloatArray=function(e,t){return r.FromArray(e,t)},r.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2]},r.FromFloatArrayToRef=function(e,t,i){return r.FromArrayToRef(e,t,i)},r.FromFloatsToRef=function(e,t,i,n){n.copyFromFloats(e,t,i)},r.Zero=function(){return new r(0,0,0)},r.One=function(){return new r(1,1,1)},r.Up=function(){return new r(0,1,0)},Object.defineProperty(r,"UpReadOnly",{get:function(){return r._UpReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"DownReadOnly",{get:function(){return r._DownReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RightReadOnly",{get:function(){return r._RightReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LeftReadOnly",{get:function(){return r._LeftReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LeftHandedForwardReadOnly",{get:function(){return r._LeftHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RightHandedForwardReadOnly",{get:function(){return r._RightHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ZeroReadOnly",{get:function(){return r._ZeroReadOnly},enumerable:!1,configurable:!0}),r.Down=function(){return new r(0,-1,0)},r.Forward=function(e){return e===void 0&&(e=!1),new r(0,0,e?-1:1)},r.Backward=function(e){return e===void 0&&(e=!1),new r(0,0,e?1:-1)},r.Right=function(){return new r(1,0,0)},r.Left=function(){return new r(-1,0,0)},r.TransformCoordinates=function(e,t){var i=r.Zero();return r.TransformCoordinatesToRef(e,t,i),i},r.TransformCoordinatesToRef=function(e,t,i){r.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i)},r.TransformCoordinatesFromFloatsToRef=function(e,t,i,n,o){var a=n.m,s=e*a[0]+t*a[4]+i*a[8]+a[12],f=e*a[1]+t*a[5]+i*a[9]+a[13],u=e*a[2]+t*a[6]+i*a[10]+a[14],l=1/(e*a[3]+t*a[7]+i*a[11]+a[15]);o.x=s*l,o.y=f*l,o.z=u*l},r.TransformNormal=function(e,t){var i=r.Zero();return r.TransformNormalToRef(e,t,i),i},r.TransformNormalToRef=function(e,t,i){this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i)},r.TransformNormalFromFloatsToRef=function(e,t,i,n,o){var a=n.m;o.x=e*a[0]+t*a[4]+i*a[8],o.y=e*a[1]+t*a[5]+i*a[9],o.z=e*a[2]+t*a[6]+i*a[10]},r.CatmullRom=function(e,t,i,n,o){var a=o*o,s=o*a,f=.5*(2*t._x+(-e._x+i._x)*o+(2*e._x-5*t._x+4*i._x-n._x)*a+(-e._x+3*t._x-3*i._x+n._x)*s),u=.5*(2*t._y+(-e._y+i._y)*o+(2*e._y-5*t._y+4*i._y-n._y)*a+(-e._y+3*t._y-3*i._y+n._y)*s),l=.5*(2*t._z+(-e._z+i._z)*o+(2*e._z-5*t._z+4*i._z-n._z)*a+(-e._z+3*t._z-3*i._z+n._z)*s);return new r(f,u,l)},r.Clamp=function(e,t,i){var n=new r;return r.ClampToRef(e,t,i,n),n},r.ClampToRef=function(e,t,i,n){var o=e._x;o=o>i._x?i._x:o,o=o<t._x?t._x:o;var a=e._y;a=a>i._y?i._y:a,a=a<t._y?t._y:a;var s=e._z;s=s>i._z?i._z:s,s=s<t._z?t._z:s,n.copyFromFloats(o,a,s)},r.CheckExtends=function(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a,c=e._x*f+i._x*u+t._x*l+n._x*h,p=e._y*f+i._y*u+t._y*l+n._y*h,d=e._z*f+i._z*u+t._z*l+n._z*h;return new r(c,p,d)},r.Hermite1stDerivative=function(e,t,i,n,o){var a=r.Zero();return this.Hermite1stDerivativeToRef(e,t,i,n,o,a),a},r.Hermite1stDerivativeToRef=function(e,t,i,n,o,a){var s=o*o;a.x=(s-o)*6*e.x+(3*s-4*o+1)*t.x+(-s+o)*6*i.x+(3*s-2*o)*n.x,a.y=(s-o)*6*e.y+(3*s-4*o+1)*t.y+(-s+o)*6*i.y+(3*s-2*o)*n.y,a.z=(s-o)*6*e.z+(3*s-4*o+1)*t.z+(-s+o)*6*i.z+(3*s-2*o)*n.z},r.Lerp=function(e,t,i){var n=new r(0,0,0);return r.LerpToRef(e,t,i,n),n},r.LerpToRef=function(e,t,i,n){n.x=e._x+(t._x-e._x)*i,n.y=e._y+(t._y-e._y)*i,n.z=e._z+(t._z-e._z)*i},r.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z},r.Cross=function(e,t){var i=r.Zero();return r.CrossToRef(e,t,i),i},r.CrossToRef=function(e,t,i){var n=e._y*t._z-e._z*t._y,o=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;i.copyFromFloats(n,o,a)},r.Normalize=function(e){var t=r.Zero();return r.NormalizeToRef(e,t),t},r.NormalizeToRef=function(e,t){e.normalizeToRef(t)},r.Project=function(e,t,i,n){var o=new r;return r.ProjectToRef(e,t,i,n,o),o},r.ProjectToRef=function(e,t,i,n,o){var a=n.width,s=n.height,f=n.x,u=n.y,l=Z.Matrix[1];B.FromValuesToRef(a/2,0,0,0,0,-s/2,0,0,0,0,.5,0,f+a/2,s/2+u,.5,1,l);var h=Z.Matrix[0];return t.multiplyToRef(i,h),h.multiplyToRef(l,h),r.TransformCoordinatesToRef(e,h,o),o},r._UnprojectFromInvertedMatrixToRef=function(e,t,i){r.TransformCoordinatesToRef(e,t,i);var n=t.m,o=e._x*n[3]+e._y*n[7]+e._z*n[11]+n[15];ae.WithinEpsilon(o,1)&&i.scaleInPlace(1/o)},r.UnprojectFromTransform=function(e,t,i,n,o){return this.Unproject(e,t,i,n,o,B.IdentityReadOnly)},r.Unproject=function(e,t,i,n,o,a){var s=r.Zero();return r.UnprojectToRef(e,t,i,n,o,a,s),s},r.UnprojectToRef=function(e,t,i,n,o,a,s){r.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,n,o,a,s)},r.UnprojectFloatsToRef=function(e,t,i,n,o,a,s,f,u){var l,h=Z.Matrix[0];a.multiplyToRef(s,h),h.multiplyToRef(f,h),h.invert();var c=Z.Vector3[0];c.x=e/n*2-1,c.y=-(t/o*2-1),!((l=le.LastCreatedEngine)===null||l===void 0)&&l.isNDCHalfZRange?c.z=i:c.z=2*i-1,r._UnprojectFromInvertedMatrixToRef(c,h,u)},r.Minimize=function(e,t){var i=e.clone();return i.minimizeInPlace(t),i},r.Maximize=function(e,t){var i=e.clone();return i.maximizeInPlace(t),i},r.Distance=function(e,t){return Math.sqrt(r.DistanceSquared(e,t))},r.DistanceSquared=function(e,t){var i=e._x-t._x,n=e._y-t._y,o=e._z-t._z;return i*i+n*n+o*o},r.ProjectOnTriangleToRef=function(e,t,i,n,o){var a=Z.Vector3[0],s=Z.Vector3[1],f=Z.Vector3[2],u=Z.Vector3[3],l=Z.Vector3[4];i.subtractToRef(t,a),n.subtractToRef(t,s),n.subtractToRef(i,f);var h=a.length(),c=s.length(),p=f.length();if(h<ye||c<ye||p<ye)return o.copyFrom(t),r.Distance(e,t);e.subtractToRef(t,l),r.CrossToRef(a,s,u);var d=u.length();if(d<ye)return o.copyFrom(t),r.Distance(e,t);u.normalizeFromLength(d);var m=l.length();if(m<ye)return o.copyFrom(t),0;l.normalizeFromLength(m);var _=r.Dot(u,l),y=Z.Vector3[5],g=Z.Vector3[6];y.copyFrom(u).scaleInPlace(-m*_),g.copyFrom(e).addInPlace(y);var T=Z.Vector3[4],A=Z.Vector3[5],M=Z.Vector3[7],C=Z.Vector3[8];T.copyFrom(a).scaleInPlace(1/h),C.copyFrom(s).scaleInPlace(1/c),T.addInPlace(C).scaleInPlace(-1),A.copyFrom(a).scaleInPlace(-1/h),C.copyFrom(f).scaleInPlace(1/p),A.addInPlace(C).scaleInPlace(-1),M.copyFrom(f).scaleInPlace(-1/p),C.copyFrom(s).scaleInPlace(-1/c),M.addInPlace(C).scaleInPlace(-1);var P=Z.Vector3[9],R;P.copyFrom(g).subtractInPlace(t),r.CrossToRef(T,P,C),R=r.Dot(C,u);var F=R;P.copyFrom(g).subtractInPlace(i),r.CrossToRef(A,P,C),R=r.Dot(C,u);var I=R;P.copyFrom(g).subtractInPlace(n),r.CrossToRef(M,P,C),R=r.Dot(C,u);var D=R,V=Z.Vector3[10],k,w;F>0&&I<0?(V.copyFrom(a),k=t,w=i):I>0&&D<0?(V.copyFrom(f),k=i,w=n):(V.copyFrom(s).scaleInPlace(-1),k=n,w=t);var G=Z.Vector3[9],K=Z.Vector3[4];k.subtractToRef(g,C),w.subtractToRef(g,G),r.CrossToRef(C,G,K);var j=r.Dot(K,u)<0;if(!j)return o.copyFrom(g),Math.abs(m*_);var W=Z.Vector3[5];r.CrossToRef(V,K,W),W.normalize();var z=Z.Vector3[9];z.copyFrom(k).subtractInPlace(g);var oe=z.length();if(oe<ye)return o.copyFrom(k),r.Distance(e,k);z.normalizeFromLength(oe);var be=r.Dot(W,z),Pe=Z.Vector3[7];Pe.copyFrom(g).addInPlace(W.scaleInPlace(oe*be)),C.copyFrom(Pe).subtractInPlace(k),m=V.length(),V.normalizeFromLength(m);var ze=r.Dot(C,V)/Math.max(m,ye);return ze=ae.Clamp(ze,0,1),Pe.copyFrom(k).addInPlace(V.scaleInPlace(ze*m)),o.copyFrom(Pe),r.Distance(e,Pe)},r.Center=function(e,t){return r.CenterToRef(e,t,r.Zero())},r.CenterToRef=function(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)},r.RotationFromAxis=function(e,t,i){var n=r.Zero();return r.RotationFromAxisToRef(e,t,i,n),n},r.RotationFromAxisToRef=function(e,t,i,n){var o=Z.Quaternion[0];ie.RotationQuaternionFromAxisToRef(e,t,i,o),o.toEulerAnglesToRef(n)},r._UpReadOnly=r.Up(),r._DownReadOnly=r.Down(),r._LeftHandedForwardReadOnly=r.Forward(!1),r._RightHandedForwardReadOnly=r.Forward(!0),r._RightReadOnly=r.Right(),r._LeftReadOnly=r.Left(),r._ZeroReadOnly=r.Zero(),r}();var It=function(){function r(e,t,i,n){this.x=e,this.y=t,this.z=i,this.w=n}return r.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y," Z: ").concat(this.z," W: ").concat(this.w,"}")},r.prototype.getClassName=function(){return"Vector4"},r.prototype.getHashCode=function(){var e=mt(this.x),t=mt(this.y),i=mt(this.z),n=mt(this.w),o=e;return o=o*397^t,o=o*397^i,o=o*397^n,o},r.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this},r.prototype.fromArray=function(e,t){return t===void 0&&(t=0),r.FromArrayToRef(e,t,this),this},r.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},r.prototype.add=function(e){return new r(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},r.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,this},r.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},r.prototype.subtract=function(e){return new r(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},r.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,this},r.prototype.subtractFromFloats=function(e,t,i,n){return new r(this.x-e,this.y-t,this.z-i,this.w-n)},r.prototype.subtractFromFloatsToRef=function(e,t,i,n,o){return o.x=this.x-e,o.y=this.y-t,o.z=this.z-i,o.w=this.w-n,this},r.prototype.negate=function(){return new r(-this.x,-this.y,-this.z,-this.w)},r.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},r.prototype.negateToRef=function(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)},r.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},r.prototype.scale=function(e){return new r(this.x*e,this.y*e,this.z*e,this.w*e)},r.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this},r.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this},r.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},r.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=ye),e&&ae.WithinEpsilon(this.x,e.x,t)&&ae.WithinEpsilon(this.y,e.y,t)&&ae.WithinEpsilon(this.z,e.z,t)&&ae.WithinEpsilon(this.w,e.w,t)},r.prototype.equalsToFloats=function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n},r.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},r.prototype.multiply=function(e){return new r(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)},r.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,this},r.prototype.multiplyByFloats=function(e,t,i,n){return new r(this.x*e,this.y*t,this.z*i,this.w*n)},r.prototype.divide=function(e){return new r(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)},r.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,this},r.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},r.prototype.minimizeInPlace=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},r.prototype.maximizeInPlace=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},r.prototype.floor=function(){return new r(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))},r.prototype.fract=function(){return new r(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))},r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},r.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},r.prototype.normalize=function(){var e=this.length();return e===0?this:this.scaleInPlace(1/e)},r.prototype.toVector3=function(){return new E(this.x,this.y,this.z)},r.prototype.clone=function(){return new r(this.x,this.y,this.z,this.w)},r.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},r.prototype.copyFromFloats=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},r.prototype.set=function(e,t,i,n){return this.copyFromFloats(e,t,i,n)},r.prototype.setAll=function(e){return this.x=this.y=this.z=this.w=e,this},r.FromArray=function(e,t){return t||(t=0),new r(e[t],e[t+1],e[t+2],e[t+3])},r.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]},r.FromFloatArrayToRef=function(e,t,i){r.FromArrayToRef(e,t,i)},r.FromFloatsToRef=function(e,t,i,n,o){o.x=e,o.y=t,o.z=i,o.w=n},r.Zero=function(){return new r(0,0,0,0)},r.One=function(){return new r(1,1,1,1)},Object.defineProperty(r,"ZeroReadOnly",{get:function(){return r._ZeroReadOnly},enumerable:!1,configurable:!0}),r.Normalize=function(e){var t=r.Zero();return r.NormalizeToRef(e,t),t},r.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},r.Minimize=function(e,t){var i=e.clone();return i.minimizeInPlace(t),i},r.Maximize=function(e,t){var i=e.clone();return i.maximizeInPlace(t),i},r.Distance=function(e,t){return Math.sqrt(r.DistanceSquared(e,t))},r.DistanceSquared=function(e,t){var i=e.x-t.x,n=e.y-t.y,o=e.z-t.z,a=e.w-t.w;return i*i+n*n+o*o+a*a},r.Center=function(e,t){return r.CenterToRef(e,t,r.Zero())},r.CenterToRef=function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)},r.TransformCoordinates=function(e,t){var i=r.Zero();return r.TransformCoordinatesToRef(e,t,i),i},r.TransformCoordinatesToRef=function(e,t,i){r.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i)},r.TransformCoordinatesFromFloatsToRef=function(e,t,i,n,o){var a=n.m,s=e*a[0]+t*a[4]+i*a[8]+a[12],f=e*a[1]+t*a[5]+i*a[9]+a[13],u=e*a[2]+t*a[6]+i*a[10]+a[14],l=e*a[3]+t*a[7]+i*a[11]+a[15];o.x=s,o.y=f,o.z=u,o.w=l},r.TransformNormal=function(e,t){var i=r.Zero();return r.TransformNormalToRef(e,t,i),i},r.TransformNormalToRef=function(e,t,i){var n=t.m,o=e.x*n[0]+e.y*n[4]+e.z*n[8],a=e.x*n[1]+e.y*n[5]+e.z*n[9],s=e.x*n[2]+e.y*n[6]+e.z*n[10];i.x=o,i.y=a,i.z=s,i.w=e.w},r.TransformNormalFromFloatsToRef=function(e,t,i,n,o,a){var s=o.m;a.x=e*s[0]+t*s[4]+i*s[8],a.y=e*s[1]+t*s[5]+i*s[9],a.z=e*s[2]+t*s[6]+i*s[10],a.w=n},r.FromVector3=function(e,t){return t===void 0&&(t=0),new r(e._x,e._y,e._z,t)},r._ZeroReadOnly=r.Zero(),r}();var ie=function(){function r(e,t,i,n){e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=0),n===void 0&&(n=1),this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=n}return Object.defineProperty(r.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"w",{get:function(){return this._w},set:function(e){this._w=e,this._isDirty=!0},enumerable:!1,configurable:!0}),r.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z," W: ").concat(this._w,"}")},r.prototype.getClassName=function(){return"Quaternion"},r.prototype.getHashCode=function(){var e=mt(this._x),t=mt(this._y),i=mt(this._z),n=mt(this._w),o=e;return o=o*397^t,o=o*397^i,o=o*397^n,o},r.prototype.asArray=function(){return[this._x,this._y,this._z,this._w]},r.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this},r.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w},r.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=ye),e&&ae.WithinEpsilon(this._x,e._x,t)&&ae.WithinEpsilon(this._y,e._y,t)&&ae.WithinEpsilon(this._z,e._z,t)&&ae.WithinEpsilon(this._w,e._w,t)},r.prototype.clone=function(){return new r(this._x,this._y,this._z,this._w)},r.prototype.copyFrom=function(e){return this.x=e._x,this.y=e._y,this.z=e._z,this.w=e._w,this},r.prototype.copyFromFloats=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},r.prototype.set=function(e,t,i,n){return this.copyFromFloats(e,t,i,n)},r.prototype.add=function(e){return new r(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)},r.prototype.addInPlace=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this},r.prototype.subtract=function(e){return new r(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)},r.prototype.subtractInPlace=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this},r.prototype.scale=function(e){return new r(this._x*e,this._y*e,this._z*e,this._w*e)},r.prototype.scaleToRef=function(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,this},r.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},r.prototype.scaleAndAddToRef=function(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,this},r.prototype.multiply=function(e){var t=new r(0,0,0,1);return this.multiplyToRef(e,t),t},r.prototype.multiplyToRef=function(e,t){var i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,n=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,o=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,n,o,a),this},r.prototype.multiplyInPlace=function(e){return this.multiplyToRef(e,this),this},r.prototype.conjugateToRef=function(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),this},r.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},r.prototype.conjugate=function(){return new r(-this._x,-this._y,-this._z,this._w)},r.prototype.invert=function(){var e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e},r.prototype.invertInPlace=function(){this.conjugateInPlace();var e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)},r.prototype.lengthSquared=function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},r.prototype.length=function(){return Math.sqrt(this.lengthSquared())},r.prototype.normalize=function(){var e=this.length();if(e===0)return this;var t=1/e;return this.scaleInPlace(t),this},r.prototype.normalizeToNew=function(){var e=this.length();if(e===0)return this.clone();var t=1/e;return this.scale(t)},r.prototype.toEulerAngles=function(){var e=E.Zero();return this.toEulerAnglesToRef(e),e},r.prototype.toEulerAnglesToRef=function(e){var t=this._z,i=this._x,n=this._y,o=this._w,a=n*t-i*o,s=.4999999;if(a<-s)e.y=2*Math.atan2(n,o),e.x=Math.PI/2,e.z=0;else if(a>s)e.y=2*Math.atan2(n,o),e.x=-Math.PI/2,e.z=0;else{var f=o*o,u=t*t,l=i*i,h=n*n;e.z=Math.atan2(2*(i*n+t*o),-u-l+h+f),e.x=Math.asin(-2*a),e.y=Math.atan2(2*(t*i+n*o),u-l-h+f)}return this},r.prototype.toRotationMatrix=function(e){return B.FromQuaternionToRef(this,e),this},r.prototype.fromRotationMatrix=function(e){return r.FromRotationMatrixToRef(e,this),this},r.FromRotationMatrix=function(e){var t=new r;return r.FromRotationMatrixToRef(e,t),t},r.FromRotationMatrixToRef=function(e,t){var i=e.m,n=i[0],o=i[4],a=i[8],s=i[1],f=i[5],u=i[9],l=i[2],h=i[6],c=i[10],p=n+f+c,d;p>0?(d=.5/Math.sqrt(p+1),t.w=.25/d,t.x=(h-u)*d,t.y=(a-l)*d,t.z=(s-o)*d):n>f&&n>c?(d=2*Math.sqrt(1+n-f-c),t.w=(h-u)/d,t.x=.25*d,t.y=(o+s)/d,t.z=(a+l)/d):f>c?(d=2*Math.sqrt(1+f-n-c),t.w=(a-l)/d,t.x=(o+s)/d,t.y=.25*d,t.z=(u+h)/d):(d=2*Math.sqrt(1+c-n-f),t.w=(s-o)/d,t.x=(a+l)/d,t.y=(u+h)/d,t.z=.25*d)},r.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},r.AreClose=function(e,t){var i=r.Dot(e,t);return i>=0},r.SmoothToRef=function(e,t,i,n,o){var a=n===0?1:i/n;a=ae.Clamp(a,0,1),r.SlerpToRef(e,t,a,o)},r.Zero=function(){return new r(0,0,0,0)},r.Inverse=function(e){return new r(-e._x,-e._y,-e._z,e._w)},r.InverseToRef=function(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t},r.Identity=function(){return new r(0,0,0,1)},r.IsIdentity=function(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1},r.RotationAxis=function(e,t){return r.RotationAxisToRef(e,t,new r)},r.RotationAxisToRef=function(e,t,i){var n=Math.sin(t/2);return e.normalize(),i.w=Math.cos(t/2),i.x=e._x*n,i.y=e._y*n,i.z=e._z*n,i},r.FromArray=function(e,t){return t||(t=0),new r(e[t],e[t+1],e[t+2],e[t+3])},r.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]},r.FromEulerAngles=function(e,t,i){var n=new r;return r.RotationYawPitchRollToRef(t,e,i,n),n},r.FromEulerAnglesToRef=function(e,t,i,n){return r.RotationYawPitchRollToRef(t,e,i,n),n},r.FromEulerVector=function(e){var t=new r;return r.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t},r.FromEulerVectorToRef=function(e,t){return r.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t},r.FromUnitVectorsToRef=function(e,t,i){var n=E.Dot(e,t)+1;return n<ye?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(E.CrossToRef(e,t,L.Vector3[0]),i.set(L.Vector3[0].x,L.Vector3[0].y,L.Vector3[0].z,n)),i.normalize()},r.RotationYawPitchRoll=function(e,t,i){var n=new r;return r.RotationYawPitchRollToRef(e,t,i,n),n},r.RotationYawPitchRollToRef=function(e,t,i,n){var o=i*.5,a=t*.5,s=e*.5,f=Math.sin(o),u=Math.cos(o),l=Math.sin(a),h=Math.cos(a),c=Math.sin(s),p=Math.cos(s);n.x=p*l*u+c*h*f,n.y=c*h*u-p*l*f,n.z=p*h*f-c*l*u,n.w=p*h*u+c*l*f},r.RotationAlphaBetaGamma=function(e,t,i){var n=new r;return r.RotationAlphaBetaGammaToRef(e,t,i,n),n},r.RotationAlphaBetaGammaToRef=function(e,t,i,n){var o=(i+e)*.5,a=(i-e)*.5,s=t*.5;n.x=Math.cos(a)*Math.sin(s),n.y=Math.sin(a)*Math.sin(s),n.z=Math.sin(o)*Math.cos(s),n.w=Math.cos(o)*Math.cos(s)},r.RotationQuaternionFromAxis=function(e,t,i){var n=new r(0,0,0,0);return r.RotationQuaternionFromAxisToRef(e,t,i,n),n},r.RotationQuaternionFromAxisToRef=function(e,t,i,n){var o=Z.Matrix[0];B.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),o),r.FromRotationMatrixToRef(o,n)},r.FromLookDirectionLH=function(e,t){var i=new r;return r.FromLookDirectionLHToRef(e,t,i),i},r.FromLookDirectionLHToRef=function(e,t,i){var n=Z.Matrix[0];B.LookDirectionLHToRef(e,t,n),r.FromRotationMatrixToRef(n,i)},r.FromLookDirectionRH=function(e,t){var i=new r;return r.FromLookDirectionRHToRef(e,t,i),i},r.FromLookDirectionRHToRef=function(e,t,i){var n=Z.Matrix[0];return B.LookDirectionRHToRef(e,t,n),r.FromRotationMatrixToRef(n,i)},r.Slerp=function(e,t,i){var n=r.Identity();return r.SlerpToRef(e,t,i,n),n},r.SlerpToRef=function(e,t,i,n){var o,a,s=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,f=!1;if(s<0&&(f=!0,s=-s),s>.999999)a=1-i,o=f?-i:i;else{var u=Math.acos(s),l=1/Math.sin(u);a=Math.sin((1-i)*u)*l,o=f?-Math.sin(i*u)*l:Math.sin(i*u)*l}n.x=a*e._x+o*t._x,n.y=a*e._y+o*t._y,n.z=a*e._z+o*t._z,n.w=a*e._w+o*t._w},r.Hermite=function(e,t,i,n,o){var a=o*o,s=o*a,f=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+o,h=s-a,c=e._x*f+i._x*u+t._x*l+n._x*h,p=e._y*f+i._y*u+t._y*l+n._y*h,d=e._z*f+i._z*u+t._z*l+n._z*h,m=e._w*f+i._w*u+t._w*l+n._w*h;return new r(c,p,d,m)},r.Hermite1stDerivative=function(e,t,i,n,o){var a=r.Zero();return this.Hermite1stDerivativeToRef(e,t,i,n,o,a),a},r.Hermite1stDerivativeToRef=function(e,t,i,n,o,a){var s=o*o;a.x=(s-o)*6*e.x+(3*s-4*o+1)*t.x+(-s+o)*6*i.x+(3*s-2*o)*n.x,a.y=(s-o)*6*e.y+(3*s-4*o+1)*t.y+(-s+o)*6*i.y+(3*s-2*o)*n.y,a.z=(s-o)*6*e.z+(3*s-4*o+1)*t.z+(-s+o)*6*i.z+(3*s-2*o)*n.z,a.w=(s-o)*6*e.w+(3*s-4*o+1)*t.w+(-s+o)*6*i.w+(3*s-2*o)*n.w},r}();var B=function(){function r(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,tr.MatrixTrackPrecisionChange&&tr.MatrixTrackedMatrices.push(this),this._m=new tr.MatrixCurrentType(16),this.markAsUpdated()}return Object.defineProperty(r,"Use64Bits",{get:function(){return tr.MatrixUse64Bits},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"m",{get:function(){return this._m},enumerable:!1,configurable:!0}),r.prototype.markAsUpdated=function(){this.updateFlag=r._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0},r.prototype._updateIdentityStatus=function(e,t,i,n){t===void 0&&(t=!1),i===void 0&&(i=!1),n===void 0&&(n=!0),this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:n},r.prototype.isIdentity=function(){if(this._isIdentityDirty){this._isIdentityDirty=!1;var e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity},r.prototype.isIdentityAs3x2=function(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2},r.prototype.determinant=function(){if(this._isIdentity===!0)return 1;var e=this._m,t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],f=e[6],u=e[7],l=e[8],h=e[9],c=e[10],p=e[11],d=e[12],m=e[13],_=e[14],y=e[15],g=c*y-_*p,T=h*y-m*p,A=h*_-m*c,M=l*y-d*p,C=l*_-c*d,P=l*m-d*h,R=+(s*g-f*T+u*A),F=-(a*g-f*M+u*C),I=+(a*T-s*M+u*P),D=-(a*A-s*C+f*P);return t*R+i*F+n*I+o*D},r.prototype.toArray=function(){return this._m},r.prototype.asArray=function(){return this._m},r.prototype.invert=function(){return this.invertToRef(this),this},r.prototype.reset=function(){return r.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this},r.prototype.add=function(e){var t=new r;return this.addToRef(e,t),t},r.prototype.addToRef=function(e,t){for(var i=this._m,n=t._m,o=e.m,a=0;a<16;a++)n[a]=i[a]+o[a];return t.markAsUpdated(),this},r.prototype.addToSelf=function(e){for(var t=this._m,i=e.m,n=0;n<16;n++)t[n]+=i[n];return this.markAsUpdated(),this},r.prototype.invertToRef=function(e){if(this._isIdentity===!0)return r.IdentityToRef(e),this;var t=this._m,i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],f=t[5],u=t[6],l=t[7],h=t[8],c=t[9],p=t[10],d=t[11],m=t[12],_=t[13],y=t[14],g=t[15],T=p*g-y*d,A=c*g-_*d,M=c*y-_*p,C=h*g-m*d,P=h*y-p*m,R=h*_-m*c,F=+(f*T-u*A+l*M),I=-(s*T-u*C+l*P),D=+(s*A-f*C+l*R),V=-(s*M-f*P+u*R),k=i*F+n*I+o*D+a*V;if(k===0)return e.copyFrom(this),this;var w=1/k,G=u*g-y*l,K=f*g-_*l,j=f*y-_*u,W=s*g-m*l,z=s*y-m*u,oe=s*_-m*f,be=u*d-p*l,Pe=f*d-c*l,ze=f*p-c*u,$e=s*d-h*l,ft=s*p-h*u,ut=s*c-h*f,lt=-(n*T-o*A+a*M),ht=+(i*T-o*C+a*P),Xe=-(i*A-n*C+a*R),Ze=+(i*M-n*P+o*R),St=+(n*G-o*K+a*j),Mt=-(i*G-o*W+a*z),ot=+(i*K-n*W+a*oe),ct=-(i*j-n*z+o*oe),Ot=-(n*be-o*Pe+a*ze),Pt=+(i*be-o*$e+a*ft),Wr=-(i*Pe-n*$e+a*ut),Gr=+(i*ze-n*ft+o*ut);return r.FromValuesToRef(F*w,lt*w,St*w,Ot*w,I*w,ht*w,Mt*w,Pt*w,D*w,Xe*w,ot*w,Wr*w,V*w,Ze*w,ct*w,Gr*w,e),this},r.prototype.addAtIndex=function(e,t){return this._m[e]+=t,this.markAsUpdated(),this},r.prototype.multiplyAtIndex=function(e,t){return this._m[e]*=t,this.markAsUpdated(),this},r.prototype.setTranslationFromFloats=function(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this},r.prototype.addTranslationFromFloats=function(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this},r.prototype.setTranslation=function(e){return this.setTranslationFromFloats(e._x,e._y,e._z)},r.prototype.getTranslation=function(){return new E(this._m[12],this._m[13],this._m[14])},r.prototype.getTranslationToRef=function(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],this},r.prototype.removeRotationAndScaling=function(){var e=this.m;return r.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this},r.prototype.multiply=function(e){var t=new r;return this.multiplyToRef(e,t),t},r.prototype.copyFrom=function(e){e.copyToArray(this._m);var t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this},r.prototype.copyToArray=function(e,t){t===void 0&&(t=0);var i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this},r.prototype.multiplyToRef=function(e,t){return this._isIdentity?(t.copyFrom(e),this):e._isIdentity?(t.copyFrom(this),this):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),this)},r.prototype.multiplyToArray=function(e,t,i){var n=this._m,o=e.m,a=n[0],s=n[1],f=n[2],u=n[3],l=n[4],h=n[5],c=n[6],p=n[7],d=n[8],m=n[9],_=n[10],y=n[11],g=n[12],T=n[13],A=n[14],M=n[15],C=o[0],P=o[1],R=o[2],F=o[3],I=o[4],D=o[5],V=o[6],k=o[7],w=o[8],G=o[9],K=o[10],j=o[11],W=o[12],z=o[13],oe=o[14],be=o[15];return t[i]=a*C+s*I+f*w+u*W,t[i+1]=a*P+s*D+f*G+u*z,t[i+2]=a*R+s*V+f*K+u*oe,t[i+3]=a*F+s*k+f*j+u*be,t[i+4]=l*C+h*I+c*w+p*W,t[i+5]=l*P+h*D+c*G+p*z,t[i+6]=l*R+h*V+c*K+p*oe,t[i+7]=l*F+h*k+c*j+p*be,t[i+8]=d*C+m*I+_*w+y*W,t[i+9]=d*P+m*D+_*G+y*z,t[i+10]=d*R+m*V+_*K+y*oe,t[i+11]=d*F+m*k+_*j+y*be,t[i+12]=g*C+T*I+A*w+M*W,t[i+13]=g*P+T*D+A*G+M*z,t[i+14]=g*R+T*V+A*K+M*oe,t[i+15]=g*F+T*k+A*j+M*be,this},r.prototype.equals=function(e){var t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;var i=this.m,n=t.m;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]&&i[9]===n[9]&&i[10]===n[10]&&i[11]===n[11]&&i[12]===n[12]&&i[13]===n[13]&&i[14]===n[14]&&i[15]===n[15]},r.prototype.clone=function(){var e=new r;return e.copyFrom(this),e},r.prototype.getClassName=function(){return"Matrix"},r.prototype.getHashCode=function(){for(var e=mt(this._m[0]),t=1;t<16;t++)e=e*397^mt(this._m[t]);return e},r.prototype.decomposeToTransformNode=function(e){return e.rotationQuaternion=e.rotationQuaternion||new ie,this.decompose(e.scaling,e.rotationQuaternion,e.position)},r.prototype.decompose=function(e,t,i,n){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;var o=this._m;if(i&&i.copyFromFloats(o[12],o[13],o[14]),e=e||Z.Vector3[0],e.x=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),e.y=Math.sqrt(o[4]*o[4]+o[5]*o[5]+o[6]*o[6]),e.z=Math.sqrt(o[8]*o[8]+o[9]*o[9]+o[10]*o[10]),n){var a=n.scaling.x<0?-1:1,s=n.scaling.y<0?-1:1,f=n.scaling.z<0?-1:1;e.x*=a,e.y*=s,e.z*=f}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){var u=1/e._x,l=1/e._y,h=1/e._z;r.FromValuesToRef(o[0]*u,o[1]*u,o[2]*u,0,o[4]*l,o[5]*l,o[6]*l,0,o[8]*h,o[9]*h,o[10]*h,0,0,0,0,1,Z.Matrix[0]),ie.FromRotationMatrixToRef(Z.Matrix[0],t)}return!0},r.prototype.getRow=function(e){if(e<0||e>3)return null;var t=e*4;return new It(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])},r.prototype.setRow=function(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)},r.prototype.transpose=function(){return r.Transpose(this)},r.prototype.transposeToRef=function(e){return r.TransposeToRef(this,e),this},r.prototype.setRowFromFloats=function(e,t,i,n,o){if(e<0||e>3)return this;var a=e*4;return this._m[a+0]=t,this._m[a+1]=i,this._m[a+2]=n,this._m[a+3]=o,this.markAsUpdated(),this},r.prototype.scale=function(e){var t=new r;return this.scaleToRef(e,t),t},r.prototype.scaleToRef=function(e,t){for(var i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),this},r.prototype.scaleAndAddToRef=function(e,t){for(var i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),this},r.prototype.toNormalMatrix=function(e){var t=Z.Matrix[0];this.invertToRef(t),t.transposeToRef(e);var i=e._m;r.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e)},r.prototype.getRotationMatrix=function(){var e=new r;return this.getRotationMatrixToRef(e),e},r.prototype.getRotationMatrixToRef=function(e){var t=Z.Vector3[0];if(!this.decompose(t))return r.IdentityToRef(e),this;var i=this._m,n=1/t._x,o=1/t._y,a=1/t._z;return r.FromValuesToRef(i[0]*n,i[1]*n,i[2]*n,0,i[4]*o,i[5]*o,i[6]*o,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,e),this},r.prototype.toggleModelMatrixHandInPlace=function(){var e=this._m;e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated()},r.prototype.toggleProjectionMatrixHandInPlace=function(){var e=this._m;e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated()},r.FromArray=function(e,t){t===void 0&&(t=0);var i=new r;return r.FromArrayToRef(e,t,i),i},r.FromArrayToRef=function(e,t,i){for(var n=0;n<16;n++)i._m[n]=e[n+t];i.markAsUpdated()},r.FromFloat32ArrayToRefScaled=function(e,t,i,n){for(var o=0;o<16;o++)n._m[o]=e[o+t]*i;n.markAsUpdated()},Object.defineProperty(r,"IdentityReadOnly",{get:function(){return r._IdentityReadOnly},enumerable:!1,configurable:!0}),r.FromValuesToRef=function(e,t,i,n,o,a,s,f,u,l,h,c,p,d,m,_,y){var g=y._m;g[0]=e,g[1]=t,g[2]=i,g[3]=n,g[4]=o,g[5]=a,g[6]=s,g[7]=f,g[8]=u,g[9]=l,g[10]=h,g[11]=c,g[12]=p,g[13]=d,g[14]=m,g[15]=_,y.markAsUpdated()},r.FromValues=function(e,t,i,n,o,a,s,f,u,l,h,c,p,d,m,_){var y=new r,g=y._m;return g[0]=e,g[1]=t,g[2]=i,g[3]=n,g[4]=o,g[5]=a,g[6]=s,g[7]=f,g[8]=u,g[9]=l,g[10]=h,g[11]=c,g[12]=p,g[13]=d,g[14]=m,g[15]=_,y.markAsUpdated(),y},r.Compose=function(e,t,i){var n=new r;return r.ComposeToRef(e,t,i,n),n},r.ComposeToRef=function(e,t,i,n){var o=n._m,a=t._x,s=t._y,f=t._z,u=t._w,l=a+a,h=s+s,c=f+f,p=a*l,d=a*h,m=a*c,_=s*h,y=s*c,g=f*c,T=u*l,A=u*h,M=u*c,C=e._x,P=e._y,R=e._z;o[0]=(1-(_+g))*C,o[1]=(d+M)*C,o[2]=(m-A)*C,o[3]=0,o[4]=(d-M)*P,o[5]=(1-(p+g))*P,o[6]=(y+T)*P,o[7]=0,o[8]=(m+A)*R,o[9]=(y-T)*R,o[10]=(1-(p+_))*R,o[11]=0,o[12]=i._x,o[13]=i._y,o[14]=i._z,o[15]=1,n.markAsUpdated()},r.Identity=function(){var e=r.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e},r.IdentityToRef=function(e){r.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0)},r.Zero=function(){var e=r.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e},r.RotationX=function(e){var t=new r;return r.RotationXToRef(e,t),t},r.Invert=function(e){var t=new r;return e.invertToRef(t),t},r.RotationXToRef=function(e,t){var i=Math.sin(e),n=Math.cos(e);r.FromValuesToRef(1,0,0,0,0,n,i,0,0,-i,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0)},r.RotationY=function(e){var t=new r;return r.RotationYToRef(e,t),t},r.RotationYToRef=function(e,t){var i=Math.sin(e),n=Math.cos(e);r.FromValuesToRef(n,0,-i,0,0,1,0,0,i,0,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0)},r.RotationZ=function(e){var t=new r;return r.RotationZToRef(e,t),t},r.RotationZToRef=function(e,t){var i=Math.sin(e),n=Math.cos(e);r.FromValuesToRef(n,i,0,0,-i,n,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0)},r.RotationAxis=function(e,t){var i=new r;return r.RotationAxisToRef(e,t,i),i},r.RotationAxisToRef=function(e,t,i){var n=Math.sin(-t),o=Math.cos(-t),a=1-o;e.normalize();var s=i._m;s[0]=e._x*e._x*a+o,s[1]=e._x*e._y*a-e._z*n,s[2]=e._x*e._z*a+e._y*n,s[3]=0,s[4]=e._y*e._x*a+e._z*n,s[5]=e._y*e._y*a+o,s[6]=e._y*e._z*a-e._x*n,s[7]=0,s[8]=e._z*e._x*a-e._y*n,s[9]=e._z*e._y*a+e._x*n,s[10]=e._z*e._z*a+o,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,i.markAsUpdated()},r.RotationAlignToRef=function(e,t,i){var n=E.Dot(t,e),o=i._m;if(n<-1+ye)o[0]=-1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0;else{var a=E.Cross(t,e),s=1/(1+n);o[0]=a._x*a._x*s+n,o[1]=a._y*a._x*s-a._z,o[2]=a._z*a._x*s+a._y,o[3]=0,o[4]=a._x*a._y*s+a._z,o[5]=a._y*a._y*s+n,o[6]=a._z*a._y*s-a._x,o[7]=0,o[8]=a._x*a._z*s-a._y,o[9]=a._y*a._z*s+a._x,o[10]=a._z*a._z*s+n,o[11]=0}o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated()},r.RotationYawPitchRoll=function(e,t,i){var n=new r;return r.RotationYawPitchRollToRef(e,t,i,n),n},r.RotationYawPitchRollToRef=function(e,t,i,n){ie.RotationYawPitchRollToRef(e,t,i,Z.Quaternion[0]),Z.Quaternion[0].toRotationMatrix(n)},r.Scaling=function(e,t,i){var n=new r;return r.ScalingToRef(e,t,i,n),n},r.ScalingToRef=function(e,t,i,n){r.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,n),n._updateIdentityStatus(e===1&&t===1&&i===1)},r.Translation=function(e,t,i){var n=new r;return r.TranslationToRef(e,t,i,n),n},r.TranslationToRef=function(e,t,i,n){r.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,n),n._updateIdentityStatus(e===0&&t===0&&i===0)},r.Lerp=function(e,t,i){var n=new r;return r.LerpToRef(e,t,i,n),n},r.LerpToRef=function(e,t,i,n){for(var o=n._m,a=e.m,s=t.m,f=0;f<16;f++)o[f]=a[f]*(1-i)+s[f]*i;n.markAsUpdated()},r.DecomposeLerp=function(e,t,i){var n=new r;return r.DecomposeLerpToRef(e,t,i,n),n},r.DecomposeLerpToRef=function(e,t,i,n){var o=Z.Vector3[0],a=Z.Quaternion[0],s=Z.Vector3[1];e.decompose(o,a,s);var f=Z.Vector3[2],u=Z.Quaternion[1],l=Z.Vector3[3];t.decompose(f,u,l);var h=Z.Vector3[4];E.LerpToRef(o,f,i,h);var c=Z.Quaternion[2];ie.SlerpToRef(a,u,i,c);var p=Z.Vector3[5];E.LerpToRef(s,l,i,p),r.ComposeToRef(h,c,p,n)},r.LookAtLH=function(e,t,i){var n=new r;return r.LookAtLHToRef(e,t,i,n),n},r.LookAtLHToRef=function(e,t,i,n){var o=Z.Vector3[0],a=Z.Vector3[1],s=Z.Vector3[2];t.subtractToRef(e,s),s.normalize(),E.CrossToRef(i,s,o);var f=o.lengthSquared();f===0?o.x=1:o.normalizeFromLength(Math.sqrt(f)),E.CrossToRef(s,o,a),a.normalize();var u=-E.Dot(o,e),l=-E.Dot(a,e),h=-E.Dot(s,e);r.FromValuesToRef(o._x,a._x,s._x,0,o._y,a._y,s._y,0,o._z,a._z,s._z,0,u,l,h,1,n)},r.LookAtRH=function(e,t,i){var n=new r;return r.LookAtRHToRef(e,t,i,n),n},r.LookAtRHToRef=function(e,t,i,n){var o=Z.Vector3[0],a=Z.Vector3[1],s=Z.Vector3[2];e.subtractToRef(t,s),s.normalize(),E.CrossToRef(i,s,o);var f=o.lengthSquared();f===0?o.x=1:o.normalizeFromLength(Math.sqrt(f)),E.CrossToRef(s,o,a),a.normalize();var u=-E.Dot(o,e),l=-E.Dot(a,e),h=-E.Dot(s,e);r.FromValuesToRef(o._x,a._x,s._x,0,o._y,a._y,s._y,0,o._z,a._z,s._z,0,u,l,h,1,n)},r.LookDirectionLH=function(e,t){var i=new r;return r.LookDirectionLHToRef(e,t,i),i},r.LookDirectionLHToRef=function(e,t,i){var n=Z.Vector3[0];n.copyFrom(e),n.scaleInPlace(-1);var o=Z.Vector3[1];E.CrossToRef(t,n,o),r.FromValuesToRef(o._x,o._y,o._z,0,t._x,t._y,t._z,0,n._x,n._y,n._z,0,0,0,0,1,i)},r.LookDirectionRH=function(e,t){var i=new r;return r.LookDirectionRHToRef(e,t,i),i},r.LookDirectionRHToRef=function(e,t,i){var n=Z.Vector3[2];E.CrossToRef(t,e,n),r.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i)},r.OrthoLH=function(e,t,i,n,o){var a=new r;return r.OrthoLHToRef(e,t,i,n,a,o),a},r.OrthoLHToRef=function(e,t,i,n,o,a){var s=i,f=n,u=2/e,l=2/t,h=2/(f-s),c=-(f+s)/(f-s);r.FromValuesToRef(u,0,0,0,0,l,0,0,0,0,h,0,0,0,c,1,o),a&&o.multiplyToRef(pr,o),o._updateIdentityStatus(u===1&&l===1&&h===1&&c===0)},r.OrthoOffCenterLH=function(e,t,i,n,o,a,s){var f=new r;return r.OrthoOffCenterLHToRef(e,t,i,n,o,a,f,s),f},r.OrthoOffCenterLHToRef=function(e,t,i,n,o,a,s,f){var u=o,l=a,h=2/(t-e),c=2/(n-i),p=2/(l-u),d=-(l+u)/(l-u),m=(e+t)/(e-t),_=(n+i)/(i-n);r.FromValuesToRef(h,0,0,0,0,c,0,0,0,0,p,0,m,_,d,1,s),f&&s.multiplyToRef(pr,s),s.markAsUpdated()},r.OrthoOffCenterRH=function(e,t,i,n,o,a,s){var f=new r;return r.OrthoOffCenterRHToRef(e,t,i,n,o,a,f,s),f},r.OrthoOffCenterRHToRef=function(e,t,i,n,o,a,s,f){r.OrthoOffCenterLHToRef(e,t,i,n,o,a,s,f),s._m[10]*=-1},r.PerspectiveLH=function(e,t,i,n,o,a){a===void 0&&(a=0);var s=new r,f=i,u=n,l=2*f/e,h=2*f/t,c=(u+f)/(u-f),p=-2*u*f/(u-f),d=Math.tan(a);return r.FromValuesToRef(l,0,0,0,0,h,0,d,0,0,c,1,0,0,p,0,s),o&&s.multiplyToRef(pr,s),s._updateIdentityStatus(!1),s},r.PerspectiveFovLH=function(e,t,i,n,o,a,s){a===void 0&&(a=0),s===void 0&&(s=!1);var f=new r;return r.PerspectiveFovLHToRef(e,t,i,n,f,!0,o,a,s),f},r.PerspectiveFovLHToRef=function(e,t,i,n,o,a,s,f,u){a===void 0&&(a=!0),f===void 0&&(f=0),u===void 0&&(u=!1);var l=i,h=n,c=1/Math.tan(e*.5),p=a?c/t:c,d=a?c:c*t,m=u&&l===0?-1:h!==0?(h+l)/(h-l):1,_=u&&l===0?2*h:h!==0?-2*h*l/(h-l):-2*l,y=Math.tan(f);r.FromValuesToRef(p,0,0,0,0,d,0,y,0,0,m,1,0,0,_,0,o),s&&o.multiplyToRef(pr,o),o._updateIdentityStatus(!1)},r.PerspectiveFovReverseLHToRef=function(e,t,i,n,o,a,s,f){a===void 0&&(a=!0),f===void 0&&(f=0);var u=1/Math.tan(e*.5),l=a?u/t:u,h=a?u:u*t,c=Math.tan(f);r.FromValuesToRef(l,0,0,0,0,h,0,c,0,0,-i,1,0,0,1,0,o),s&&o.multiplyToRef(pr,o),o._updateIdentityStatus(!1)},r.PerspectiveFovRH=function(e,t,i,n,o,a,s){a===void 0&&(a=0),s===void 0&&(s=!1);var f=new r;return r.PerspectiveFovRHToRef(e,t,i,n,f,!0,o,a,s),f},r.PerspectiveFovRHToRef=function(e,t,i,n,o,a,s,f,u){a===void 0&&(a=!0),f===void 0&&(f=0),u===void 0&&(u=!1);var l=i,h=n,c=1/Math.tan(e*.5),p=a?c/t:c,d=a?c:c*t,m=u&&l===0?1:h!==0?-(h+l)/(h-l):-1,_=u&&l===0?2*h:h!==0?-2*h*l/(h-l):-2*l,y=Math.tan(f);r.FromValuesToRef(p,0,0,0,0,d,0,y,0,0,m,-1,0,0,_,0,o),s&&o.multiplyToRef(pr,o),o._updateIdentityStatus(!1)},r.PerspectiveFovReverseRHToRef=function(e,t,i,n,o,a,s,f){a===void 0&&(a=!0),f===void 0&&(f=0);var u=1/Math.tan(e*.5),l=a?u/t:u,h=a?u:u*t,c=Math.tan(f);r.FromValuesToRef(l,0,0,0,0,h,0,c,0,0,-i,-1,0,0,-1,0,o),s&&o.multiplyToRef(pr,o),o._updateIdentityStatus(!1)},r.PerspectiveFovWebVRToRef=function(e,t,i,n,o,a,s){o===void 0&&(o=!1),s===void 0&&(s=0);var f=o?-1:1,u=Math.tan(e.upDegrees*Math.PI/180),l=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),c=Math.tan(e.rightDegrees*Math.PI/180),p=2/(h+c),d=2/(u+l),m=Math.tan(s),_=n._m;_[0]=p,_[1]=_[2]=_[3]=_[4]=0,_[5]=d,_[6]=0,_[7]=m,_[8]=(h-c)*p*.5,_[9]=-((u-l)*d*.5),_[10]=-i/(t-i),_[11]=1*f,_[12]=_[13]=_[15]=0,_[14]=-(2*i*t)/(i-t),a&&n.multiplyToRef(pr,n),n.markAsUpdated()},r.GetFinalMatrix=function(e,t,i,n,o,a){var s=e.width,f=e.height,u=e.x,l=e.y,h=r.FromValues(s/2,0,0,0,0,-f/2,0,0,0,0,a-o,0,u+s/2,f/2+l,o,1),c=Z.Matrix[0];return t.multiplyToRef(i,c),c.multiplyToRef(n,c),c.multiply(h)},r.GetAsMatrix2x2=function(e){var t=e.m,i=[t[0],t[1],t[4],t[5]];return tr.MatrixUse64Bits?i:new Float32Array(i)},r.GetAsMatrix3x3=function(e){var t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return tr.MatrixUse64Bits?i:new Float32Array(i)},r.Transpose=function(e){var t=new r;return r.TransposeToRef(e,t),t},r.TransposeToRef=function(e,t){var i=t._m,n=e.m;i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty)},r.Reflection=function(e){var t=new r;return r.ReflectionToRef(e,t),t},r.ReflectionToRef=function(e,t){e.normalize();var i=e.normal.x,n=e.normal.y,o=e.normal.z,a=-2*i,s=-2*n,f=-2*o;r.FromValuesToRef(a*i+1,s*i,f*i,0,a*n,s*n+1,f*n,0,a*o,s*o,f*o+1,0,a*e.d,s*e.d,f*e.d,1,t)},r.FromXYZAxesToRef=function(e,t,i,n){r.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,n)},r.FromQuaternionToRef=function(e,t){var i=e._x*e._x,n=e._y*e._y,o=e._z*e._z,a=e._x*e._y,s=e._z*e._w,f=e._z*e._x,u=e._y*e._w,l=e._y*e._z,h=e._x*e._w;t._m[0]=1-2*(n+o),t._m[1]=2*(a+s),t._m[2]=2*(f-u),t._m[3]=0,t._m[4]=2*(a-s),t._m[5]=1-2*(o+i),t._m[6]=2*(l+h),t._m[7]=0,t._m[8]=2*(f+u),t._m[9]=2*(l-h),t._m[10]=1-2*(n+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated()},r._UpdateFlagSeed=0,r._IdentityReadOnly=r.Identity(),r}();var Z=function(){function r(){}return r.Vector3=Be.BuildTuple(11,E.Zero),r.Matrix=Be.BuildTuple(2,B.Identity),r.Quaternion=Be.BuildTuple(3,ie.Zero),r}(),L=function(){function r(){}return r.Vector2=Be.BuildTuple(3,_e.Zero),r.Vector3=Be.BuildTuple(13,E.Zero),r.Vector4=Be.BuildTuple(3,It.Zero),r.Quaternion=Be.BuildTuple(2,ie.Zero),r.Matrix=Be.BuildTuple(8,B.Identity),r}();Ke("BABYLON.Vector2",_e);Ke("BABYLON.Vector3",E);Ke("BABYLON.Vector4",It);Ke("BABYLON.Matrix",B);var pr=B.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);v();v();var zn={},Gn={},gh=function(r,e,t){var i=r();Ee&&Ee.AddTagsTo(i,e.tags);var n=ma(i);for(var o in n){var a=n[o],s=e[o],f=a.type;if(s!=null&&(o!=="uniqueId"||te.AllowLoadingUniqueId))switch(f){case 0:case 6:case 11:i[o]=s;break;case 1:i[o]=t||s.isRenderTarget?s:s.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[o]=t?s:s.clone();break}}return i};function mv(r){var e=r.getClassName();return zn[e]||(zn[e]={}),zn[e]}function ma(r){var e=r.getClassName();if(Gn[e])return Gn[e];Gn[e]={};for(var t=Gn[e],i=r,n=e;n;){var o=zn[n];for(var a in o)t[a]=o[a];var s=void 0,f=!1;do{if(s=Object.getPrototypeOf(i),!s.getClassName){f=!0;break}if(s.getClassName()!==n)break;i=s}while(s);if(f)break;n=s.getClassName(),i=s}return t}function ir(r,e){return function(t,i){var n=mv(t);n[i]||(n[i]={type:r,sourceName:e})}}function gv(r,e){return e===void 0&&(e=null),function(t,i){var n=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[n]},set:function(o){typeof this.equals=="function"&&this.equals(o)||this[n]!==o&&(this[n]=o,t[r].apply(this))},enumerable:!0,configurable:!0})}}function ve(r,e){return e===void 0&&(e=null),gv(r,e)}function O(r){return ir(0,r)}function at(r){return ir(1,r)}function Ht(r){return ir(2,r)}function ci(r){return ir(3,r)}function At(r){return ir(5,r)}function yh(r){return ir(6,r)}function bh(r){return ir(7,r)}function Eh(r){return ir(8,r)}function Th(r){return ir(10,r)}var te=function(){function r(){}return r.AppendSerializedAnimations=function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var n=e.animations[i];t.animations.push(n.serialize())}}},r.Serialize=function(e,t){t||(t={}),Ee&&(t.tags=Ee.GetTags(e));var i=ma(e);for(var n in i){var o=i[n],a=o.sourceName||n,s=o.type,f=e[n];if(f!=null&&(n!=="uniqueId"||r.AllowLoadingUniqueId))switch(s){case 0:t[a]=f;break;case 1:t[a]=f.serialize();break;case 2:t[a]=f.asArray();break;case 3:t[a]=f.serialize();break;case 4:t[a]=f.asArray();break;case 5:t[a]=f.asArray();break;case 6:t[a]=f.id;break;case 7:t[a]=f.serialize();break;case 8:t[a]=f.asArray();break;case 9:t[a]=f.serialize();break;case 10:t[a]=f.asArray();break;case 11:t[a]=f.id;break;case 12:t[a]=f.asArray();break}}return t},r.Parse=function(e,t,i,n){n===void 0&&(n=null);var o=e();n||(n=""),Ee&&Ee.AddTagsTo(o,t.tags);var a=ma(o);for(var s in a){var f=a[s],u=t[f.sourceName||s],l=f.type;if(u!=null&&(s!=="uniqueId"||r.AllowLoadingUniqueId)){var h=o;switch(l){case 0:h[s]=u;break;case 1:i&&(h[s]=r._TextureParser(u,i,n));break;case 2:h[s]=de.FromArray(u);break;case 3:h[s]=r._FresnelParametersParser(u);break;case 4:h[s]=_e.FromArray(u);break;case 5:h[s]=E.FromArray(u);break;case 6:i&&(h[s]=i.getLastMeshById(u));break;case 7:h[s]=r._ColorCurvesParser(u);break;case 8:h[s]=Ae.FromArray(u);break;case 9:h[s]=r._ImageProcessingConfigurationParser(u);break;case 10:h[s]=ie.FromArray(u);break;case 11:i&&(h[s]=i.getCameraById(u));break;case 12:h[s]=B.FromArray(u);break}}}return o},r.Clone=function(e,t){return gh(e,t,!1)},r.Instanciate=function(e,t){return gh(e,t,!0)},r.AllowLoadingUniqueId=!1,r._ImageProcessingConfigurationParser=function(e){throw Q("ImageProcessingConfiguration")},r._FresnelParametersParser=function(e){throw Q("FresnelParameters")},r._ColorCurvesParser=function(e){throw Q("ColorCurves")},r._TextureParser=function(e,t,i){throw Q("Texture")},r}();function Xt(r,e,t,i){var n=t.value;t.value=function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];var s=n;if(typeof _native!="undefined"&&_native[e]){var f=_native[e];i?s=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];return i.apply(void 0,u)?f.apply(void 0,u):n.apply(void 0,u)}:s=f}return r[e]=s,s.apply(void 0,o)}}Xt.filter=function(r){return function(e,t,i){return Xt(e,t,i,r)}};var yv=function(){function r(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new U,this._onClonedObservable=new U}return r}(),gt=function(){function r(e,t){t===void 0&&(t=null),this._isDirty=!1,this._nodeDataStorage=new yv,this.state="",this.metadata=null,this.reservedDataStore=null,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=B.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||le.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}return r.AddNodeConstructor=function(e,t){this._NodeConstructors[e]=t},r.Construct=function(e,t,i,n){var o=this._NodeConstructors[e];return o?o(t,i,n):null},Object.defineProperty(r.prototype,"doNotSerialize",{get:function(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1},set:function(e){this._nodeDataStorage._doNotSerialize=e},enumerable:!1,configurable:!0}),r.prototype.isDisposed=function(){return this._nodeDataStorage._isDisposed},Object.defineProperty(r.prototype,"parent",{get:function(){return this._parentNode},set:function(e){if(this._parentNode!==e){var t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){var i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}},enumerable:!1,configurable:!0}),r.prototype._serializeAsParent=function(e){e.parentId=this.uniqueId},r.prototype._addToSceneRootNodes=function(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))},r.prototype._removeFromSceneRootNodes=function(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){var e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}},Object.defineProperty(r.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"Node"},Object.defineProperty(r.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onEnabledStateChangedObservable",{get:function(){return this._nodeDataStorage._onEnabledStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onClonedObservable",{get:function(){return this._nodeDataStorage._onClonedObservable},enumerable:!1,configurable:!0}),r.prototype.getScene=function(){return this._scene},r.prototype.getEngine=function(){return this._scene.getEngine()},r.prototype.addBehavior=function(e,t){var i=this;t===void 0&&(t=!1);var n=this._behaviors.indexOf(e);return n!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(function(){e.attach(i)}):e.attach(this),this._behaviors.push(e),this)},r.prototype.removeBehavior=function(e){var t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)},Object.defineProperty(r.prototype,"behaviors",{get:function(){return this._behaviors},enumerable:!1,configurable:!0}),r.prototype.getBehaviorByName=function(e){for(var t=0,i=this._behaviors;t<i.length;t++){var n=i[t];if(n.name===e)return n}return null},r.prototype.getWorldMatrix=function(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},r.prototype._getWorldMatrixDeterminant=function(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant},Object.defineProperty(r.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!1,configurable:!0}),r.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},r.prototype.updateCache=function(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},r.prototype._getActionManagerForTrigger=function(e,t){return t===void 0&&(t=!0),this.parent?this.parent._getActionManagerForTrigger(e,!1):null},r.prototype._updateCache=function(e){},r.prototype._isSynchronized=function(){return!0},r.prototype._markSyncedWithParent=function(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)},r.prototype.isSynchronizedWithParent=function(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0},r.prototype.isSynchronized=function(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()},r.prototype.isReady=function(e){return e===void 0&&(e=!1),this._nodeDataStorage._isReady},r.prototype.markAsDirty=function(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},r.prototype.isEnabled=function(e){return e===void 0&&(e=!0),e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1},r.prototype._syncParentEnabledState=function(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(function(e){e._syncParentEnabledState()})},r.prototype.setEnabled=function(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e),this._syncParentEnabledState())},r.prototype.isDescendantOf=function(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1},r.prototype._getDescendants=function(e,t,i){if(t===void 0&&(t=!1),!!this._children)for(var n=0;n<this._children.length;n++){var o=this._children[n];(!i||i(o))&&e.push(o),t||o._getDescendants(e,!1,i)}},r.prototype.getDescendants=function(e,t){var i=new Array;return this._getDescendants(i,e,t),i},r.prototype.getChildMeshes=function(e,t){var i=[];return this._getDescendants(i,e,function(n){return(!t||t(n))&&n.cullingStrategy!==void 0}),i},r.prototype.getChildren=function(e,t){return t===void 0&&(t=!0),this.getDescendants(t,e)},r.prototype._setReady=function(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}},r.prototype.getAnimationByName=function(e){for(var t=0;t<this.animations.length;t++){var i=this.animations[t];if(i.name===e)return i}return null},r.prototype.createAnimationRange=function(e,t,i){if(!this._ranges[e]){this._ranges[e]=r._AnimationRangeFactory(e,t,i);for(var n=0,o=this.animations.length;n<o;n++)this.animations[n]&&this.animations[n].createRange(e,t,i)}},r.prototype.deleteAnimationRange=function(e,t){t===void 0&&(t=!0);for(var i=0,n=this.animations.length;i<n;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null},r.prototype.getAnimationRange=function(e){return this._ranges[e]||null},r.prototype.getAnimationRanges=function(){var e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e},r.prototype.beginAnimation=function(e,t,i,n){var o=this.getAnimationRange(e);return o?this._scene.beginAnimation(this,o.from,o.to,t,i,n):null},r.prototype.serializeAnimationRanges=function(){var e=[];for(var t in this._ranges){var i=this._ranges[t];if(!!i){var n={};n.name=t,n.from=i.from,n.to=i.to,e.push(n)}}return e},r.prototype.computeWorldMatrix=function(e){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix},r.prototype.dispose=function(e,t){if(t===void 0&&(t=!1),this._nodeDataStorage._isDisposed=!0,!e)for(var i=this.getDescendants(!0),n=0,o=i;n<o.length;n++){var a=o[n];a.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(var s=0,f=this._behaviors;s<f.length;s++){var u=f[s];u.detach()}this._behaviors.length=0,this.metadata=null},r.ParseAnimationRanges=function(e,t,i){if(t.ranges)for(var n=0;n<t.ranges.length;n++){var o=t.ranges[n];e.createAnimationRange(o.name,o.from,o.to)}},r.prototype.getHierarchyBoundingVectors=function(e,t){e===void 0&&(e=!0),t===void 0&&(t=null),this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);var i,n,o=this;if(o.getBoundingInfo&&o.subMeshes){var a=o.getBoundingInfo();i=a.boundingBox.minimumWorld.clone(),n=a.boundingBox.maximumWorld.clone()}else i=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e)for(var s=this.getDescendants(!1),f=0,u=s;f<u.length;f++){var l=u[f],h=l;if(h.computeWorldMatrix(!0),!(t&&!t(h))&&!(!h.getBoundingInfo||h.getTotalVertices()===0)){var c=h.getBoundingInfo(),p=c.boundingBox,d=p.minimumWorld,m=p.maximumWorld;E.CheckExtends(d,i,n),E.CheckExtends(m,i,n)}}return{min:i,max:n}},r._AnimationRangeFactory=function(e,t,i){throw Q("AnimationRange")},r._NodeConstructors={},x([O()],r.prototype,"name",void 0),x([O()],r.prototype,"id",void 0),x([O()],r.prototype,"uniqueId",void 0),x([O()],r.prototype,"state",void 0),x([O()],r.prototype,"metadata",void 0),r}();v();var Or=function(){function r(e,t,i,n,o,a,s,f){n===void 0&&(n=0),o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=!1),this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=f||1,t instanceof wn?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=s?n:n*Float32Array.BYTES_PER_ELEMENT,o||this.create()}return r.prototype.createVertexBuffer=function(e,t,i,n,o,a,s){a===void 0&&(a=!1);var f=a?t:t*Float32Array.BYTES_PER_ELEMENT,u=n?a?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new b(this._engine,this,e,this._updatable,!0,u,o===void 0?this._instanced:o,f,i,void 0,void 0,!0,this._divisor||s)},r.prototype.isUpdatable=function(){return this._updatable},r.prototype.getData=function(){return this._data},r.prototype.getBuffer=function(){return this._buffer},r.prototype.getStrideSize=function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT},r.prototype.create=function(e){e===void 0&&(e=null),!(!e&&this._buffer)&&(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))},r.prototype._rebuild=function(){this._buffer=null,this.create(this._data)},r.prototype.update=function(e){this.create(e)},r.prototype.updateDirectly=function(e,t,i,n){n===void 0&&(n=!1),!!this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)},r.prototype._increaseReferences=function(){if(!!this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}},r.prototype.dispose=function(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)},r}();var b=function(){function r(e,t,i,n,o,a,s,f,u,l,h,c,p,d){if(h===void 0&&(h=!1),c===void 0&&(c=!1),p===void 0&&(p=1),d===void 0&&(d=!1),t instanceof Or?(this._buffer=t,this._ownsBuffer=d):(this._buffer=new Or(e,t,n,a,o,s,c),this._ownsBuffer=!0),this.uniqueId=r._Counter++,this._kind=i,l==null){var m=this.getData();this.type=r.FLOAT,m instanceof Int8Array?this.type=r.BYTE:m instanceof Uint8Array?this.type=r.UNSIGNED_BYTE:m instanceof Int16Array?this.type=r.SHORT:m instanceof Uint16Array?this.type=r.UNSIGNED_SHORT:m instanceof Int32Array?this.type=r.INT:m instanceof Uint32Array&&(this.type=r.UNSIGNED_INT)}else this.type=l;var _=r.GetTypeByteLength(this.type);c?(this._size=u||(a?a/_:r.DeduceStride(i)),this.byteStride=a||this._buffer.byteStride||this._size*_,this.byteOffset=f||0):(this._size=u||a||r.DeduceStride(i),this.byteStride=a?a*_:this._buffer.byteStride||this._size*_,this.byteOffset=(f||0)*_),this.normalized=h,this._instanced=s!==void 0?s:!1,this._instanceDivisor=s?p:0,this._computeHashCode()}return Object.defineProperty(r.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(e){this._instanceDivisor=e,e==0?this._instanced=!1:this._instanced=!0,this._computeHashCode()},enumerable:!1,configurable:!0}),r.prototype._computeHashCode=function(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)},r.prototype._rebuild=function(){!this._buffer||this._buffer._rebuild()},r.prototype.getKind=function(){return this._kind},r.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},r.prototype.getData=function(){return this._buffer.getData()},r.prototype.getFloatData=function(e,t){var i=this.getData();if(!i)return null;var n=this.getSize()*r.GetTypeByteLength(this.type),o=e*this.getSize();if(this.type!==r.FLOAT||this.byteStride!==n){var a=new Float32Array(o);return this.forEach(o,function(h,c){return a[c]=h}),a}if(!(i instanceof Array||i instanceof Float32Array)||this.byteOffset!==0||i.length!==o)if(i instanceof Array){var s=this.byteOffset/4;return i.slice(s,s+o)}else{if(i instanceof ArrayBuffer)return new Float32Array(i,this.byteOffset,o);var s=i.byteOffset+this.byteOffset;if(t){var f=new Float32Array(o),u=new Float32Array(i.buffer,s,o);return f.set(u),f}var l=s%4;return l&&(s=Math.max(0,s-l)),new Float32Array(i.buffer,s,o)}return t?i.slice():i},r.prototype.getBuffer=function(){return this._buffer.getBuffer()},r.prototype.getStrideSize=function(){return this.byteStride/r.GetTypeByteLength(this.type)},r.prototype.getOffset=function(){return this.byteOffset/r.GetTypeByteLength(this.type)},r.prototype.getSize=function(e){return e===void 0&&(e=!1),e?this._size*r.GetTypeByteLength(this.type):this._size},r.prototype.getIsInstanced=function(){return this._instanced},r.prototype.getInstanceDivisor=function(){return this._instanceDivisor},r.prototype.create=function(e){this._buffer.create(e)},r.prototype.update=function(e){this._buffer.update(e)},r.prototype.updateDirectly=function(e,t,i){i===void 0&&(i=!1),this._buffer.updateDirectly(e,t,void 0,i)},r.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},r.prototype.forEach=function(e,t){r.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)},r.DeduceStride=function(e){switch(e){case r.UVKind:case r.UV2Kind:case r.UV3Kind:case r.UV4Kind:case r.UV5Kind:case r.UV6Kind:return 2;case r.NormalKind:case r.PositionKind:return 3;case r.ColorKind:case r.MatricesIndicesKind:case r.MatricesIndicesExtraKind:case r.MatricesWeightsKind:case r.MatricesWeightsExtraKind:case r.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}},r.GetTypeByteLength=function(e){switch(e){case r.BYTE:case r.UNSIGNED_BYTE:return 1;case r.SHORT:case r.UNSIGNED_SHORT:return 2;case r.INT:case r.UNSIGNED_INT:case r.FLOAT:return 4;default:throw new Error("Invalid type '".concat(e,"'"))}},r.ForEach=function(e,t,i,n,o,a,s,f){if(e instanceof Array)for(var u=t/4,l=i/4,h=0;h<a;h+=n){for(var c=0;c<n;c++)f(e[u+c],h+c);u+=l}else for(var p=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),d=r.GetTypeByteLength(o),h=0;h<a;h+=n){for(var m=t,c=0;c<n;c++){var _=r._GetFloatValue(p,o,m,s);f(_,h+c),m+=d}t+=i}},r._GetFloatValue=function(e,t,i,n){switch(t){case r.BYTE:{var o=e.getInt8(i);return n&&(o=Math.max(o/127,-1)),o}case r.UNSIGNED_BYTE:{var o=e.getUint8(i);return n&&(o=o/255),o}case r.SHORT:{var o=e.getInt16(i,!0);return n&&(o=Math.max(o/32767,-1)),o}case r.UNSIGNED_SHORT:{var o=e.getUint16(i,!0);return n&&(o=o/65535),o}case r.INT:return e.getInt32(i,!0);case r.UNSIGNED_INT:return e.getUint32(i,!0);case r.FLOAT:return e.getFloat32(i,!0);default:throw new Error("Invalid component type ".concat(t))}},r._Counter=0,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra",r}();v();var re=function(){function r(){this._applyTo=mh(this._applyToCoroutine.bind(this))}return r.prototype.set=function(e,t){switch(e.length||q.Warn("Setting vertex data kind '".concat(t,"' with an empty array")),t){case b.PositionKind:this.positions=e;break;case b.NormalKind:this.normals=e;break;case b.TangentKind:this.tangents=e;break;case b.UVKind:this.uvs=e;break;case b.UV2Kind:this.uvs2=e;break;case b.UV3Kind:this.uvs3=e;break;case b.UV4Kind:this.uvs4=e;break;case b.UV5Kind:this.uvs5=e;break;case b.UV6Kind:this.uvs6=e;break;case b.ColorKind:this.colors=e;break;case b.MatricesIndicesKind:this.matricesIndices=e;break;case b.MatricesWeightsKind:this.matricesWeights=e;break;case b.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case b.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}},r.prototype.applyToMesh=function(e,t){return this._applyTo(e,t,!1),this},r.prototype.applyToGeometry=function(e,t){return this._applyTo(e,t,!1),this},r.prototype.updateMesh=function(e){return this._update(e),this},r.prototype.updateGeometry=function(e){return this._update(e),this},r.prototype._applyToCoroutine=function(e,t,i){return t===void 0&&(t=!1),Lt(this,function(n){switch(n.label){case 0:return this.positions?(e.setVerticesData(b.PositionKind,this.positions,t),i?[4]:[3,2]):[3,2];case 1:n.sent(),n.label=2;case 2:return this.normals?(e.setVerticesData(b.NormalKind,this.normals,t),i?[4]:[3,4]):[3,4];case 3:n.sent(),n.label=4;case 4:return this.tangents?(e.setVerticesData(b.TangentKind,this.tangents,t),i?[4]:[3,6]):[3,6];case 5:n.sent(),n.label=6;case 6:return this.uvs?(e.setVerticesData(b.UVKind,this.uvs,t),i?[4]:[3,8]):[3,8];case 7:n.sent(),n.label=8;case 8:return this.uvs2?(e.setVerticesData(b.UV2Kind,this.uvs2,t),i?[4]:[3,10]):[3,10];case 9:n.sent(),n.label=10;case 10:return this.uvs3?(e.setVerticesData(b.UV3Kind,this.uvs3,t),i?[4]:[3,12]):[3,12];case 11:n.sent(),n.label=12;case 12:return this.uvs4?(e.setVerticesData(b.UV4Kind,this.uvs4,t),i?[4]:[3,14]):[3,14];case 13:n.sent(),n.label=14;case 14:return this.uvs5?(e.setVerticesData(b.UV5Kind,this.uvs5,t),i?[4]:[3,16]):[3,16];case 15:n.sent(),n.label=16;case 16:return this.uvs6?(e.setVerticesData(b.UV6Kind,this.uvs6,t),i?[4]:[3,18]):[3,18];case 17:n.sent(),n.label=18;case 18:return this.colors?(e.setVerticesData(b.ColorKind,this.colors,t),i?[4]:[3,20]):[3,20];case 19:n.sent(),n.label=20;case 20:return this.matricesIndices?(e.setVerticesData(b.MatricesIndicesKind,this.matricesIndices,t),i?[4]:[3,22]):[3,22];case 21:n.sent(),n.label=22;case 22:return this.matricesWeights?(e.setVerticesData(b.MatricesWeightsKind,this.matricesWeights,t),i?[4]:[3,24]):[3,24];case 23:n.sent(),n.label=24;case 24:return this.matricesIndicesExtra?(e.setVerticesData(b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i?[4]:[3,26]):[3,26];case 25:n.sent(),n.label=26;case 26:return this.matricesWeightsExtra?(e.setVerticesData(b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i?[4]:[3,28]):[3,28];case 27:n.sent(),n.label=28;case 28:return this.indices?(e.setIndices(this.indices,null,t),i?[4]:[3,30]):[3,31];case 29:n.sent(),n.label=30;case 30:return[3,32];case 31:e.setIndices([],null),n.label=32;case 32:return[2,this]}})},r.prototype._update=function(e,t,i){return this.positions&&e.updateVerticesData(b.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(b.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(b.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(b.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(b.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(b.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(b.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(b.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(b.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(b.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(b.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(b.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this},r._TransformVector3Coordinates=function(e,t,i,n){i===void 0&&(i=0),n===void 0&&(n=e.length);for(var o=L.Vector3[0],a=L.Vector3[1],s=i;s<i+n;s+=3)E.FromArrayToRef(e,s,o),E.TransformCoordinatesToRef(o,t,a),e[s]=a.x,e[s+1]=a.y,e[s+2]=a.z},r._TransformVector3Normals=function(e,t,i,n){i===void 0&&(i=0),n===void 0&&(n=e.length);for(var o=L.Vector3[0],a=L.Vector3[1],s=i;s<i+n;s+=3)E.FromArrayToRef(e,s,o),E.TransformNormalToRef(o,t,a),e[s]=a.x,e[s+1]=a.y,e[s+2]=a.z},r._TransformVector4Normals=function(e,t,i,n){i===void 0&&(i=0),n===void 0&&(n=e.length);for(var o=L.Vector4[0],a=L.Vector4[1],s=i;s<i+n;s+=4)It.FromArrayToRef(e,s,o),It.TransformNormalToRef(o,t,a),e[s]=a.x,e[s+1]=a.y,e[s+2]=a.z,e[s+3]=a.w},r._FlipFaces=function(e,t,i){t===void 0&&(t=0),i===void 0&&(i=e.length);for(var n=t;n<t+i;n+=3){var o=e[n+1];e[n+1]=e[n+2],e[n+2]=o}},r.prototype.transform=function(e){var t=e.determinant()<0;return this.positions&&r._TransformVector3Coordinates(this.positions,e),this.normals&&r._TransformVector3Normals(this.normals,e),this.tangents&&r._TransformVector4Normals(this.tangents,e),t&&this.indices&&r._FlipFaces(this.indices),this},r.prototype.merge=function(e,t,i){t===void 0&&(t=!1),i===void 0&&(i=!1);var n=Array.isArray(e)?e.map(function(o){return[o,void 0]}):[[e,void 0]];return Wi(this._mergeCoroutine(void 0,n,t,!1,i))},r.prototype._mergeCoroutine=function(e,t,i,n,o){var a,s,f,g,u,l,h,c,p,d,m,_,y,g,T,A,M=this,C,P,R,F;return i===void 0&&(i=!1),Lt(this,function(I){switch(I.label){case 0:for(this._validate(),a=t.map(function(D){return D[0]}),s=0,f=a;s<f.length;s++)if(g=f[s],g._validate(),!this.normals!=!g.normals||!this.tangents!=!g.tangents||!this.uvs!=!g.uvs||!this.uvs2!=!g.uvs2||!this.uvs3!=!g.uvs3||!this.uvs4!=!g.uvs4||!this.uvs5!=!g.uvs5||!this.uvs6!=!g.uvs6||!this.colors!=!g.colors||!this.matricesIndices!=!g.matricesIndices||!this.matricesWeights!=!g.matricesWeights||!this.matricesIndicesExtra!=!g.matricesIndicesExtra||!this.matricesWeightsExtra!=!g.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(u=a.reduce(function(D,V){var k,w;return D+((w=(k=V.indices)===null||k===void 0?void 0:k.length)!==null&&w!==void 0?w:0)},(P=(C=this.indices)===null||C===void 0?void 0:C.length)!==null&&P!==void 0?P:0),l=o||a.some(function(D){return D.indices===M.indices}),h=l?(R=this.indices)===null||R===void 0?void 0:R.slice():this.indices,!(u>0))return[3,4];c=(F=h==null?void 0:h.length)!==null&&F!==void 0?F:0,h||(h=new Array(u)),h.length!==u&&(Array.isArray(h)?h.length=u:(p=i||h instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u),p.set(h),h=p),e&&e.determinant()<0&&r._FlipFaces(h,0,c)),d=this.positions?this.positions.length/3:0,m=0,_=t,I.label=1;case 1:if(!(m<_.length))return[3,4];if(y=_[m],g=y[0],T=y[1],!g.indices)return[3,3];for(A=0;A<g.indices.length;A++)h[c+A]=g.indices[A]+d;return T&&T.determinant()<0&&r._FlipFaces(h,c,g.indices.length),d+=g.positions.length/3,c+=g.indices.length,n?[4]:[3,3];case 2:I.sent(),I.label=3;case 3:return m++,[3,1];case 4:return this.indices=h,this.positions=r._MergeElement(b.PositionKind,this.positions,e,t.map(function(D){return[D[0].positions,D[1]]})),n?[4]:[3,6];case 5:I.sent(),I.label=6;case 6:return this.normals=r._MergeElement(b.NormalKind,this.normals,e,t.map(function(D){return[D[0].normals,D[1]]})),n?[4]:[3,8];case 7:I.sent(),I.label=8;case 8:return this.tangents=r._MergeElement(b.TangentKind,this.tangents,e,t.map(function(D){return[D[0].tangents,D[1]]})),n?[4]:[3,10];case 9:I.sent(),I.label=10;case 10:return this.uvs=r._MergeElement(b.UVKind,this.uvs,e,t.map(function(D){return[D[0].uvs,D[1]]})),n?[4]:[3,12];case 11:I.sent(),I.label=12;case 12:return this.uvs2=r._MergeElement(b.UV2Kind,this.uvs2,e,t.map(function(D){return[D[0].uvs2,D[1]]})),n?[4]:[3,14];case 13:I.sent(),I.label=14;case 14:return this.uvs3=r._MergeElement(b.UV3Kind,this.uvs3,e,t.map(function(D){return[D[0].uvs3,D[1]]})),n?[4]:[3,16];case 15:I.sent(),I.label=16;case 16:return this.uvs4=r._MergeElement(b.UV4Kind,this.uvs4,e,t.map(function(D){return[D[0].uvs4,D[1]]})),n?[4]:[3,18];case 17:I.sent(),I.label=18;case 18:return this.uvs5=r._MergeElement(b.UV5Kind,this.uvs5,e,t.map(function(D){return[D[0].uvs5,D[1]]})),n?[4]:[3,20];case 19:I.sent(),I.label=20;case 20:return this.uvs6=r._MergeElement(b.UV6Kind,this.uvs6,e,t.map(function(D){return[D[0].uvs6,D[1]]})),n?[4]:[3,22];case 21:I.sent(),I.label=22;case 22:return this.colors=r._MergeElement(b.ColorKind,this.colors,e,t.map(function(D){return[D[0].colors,D[1]]})),n?[4]:[3,24];case 23:I.sent(),I.label=24;case 24:return this.matricesIndices=r._MergeElement(b.MatricesIndicesKind,this.matricesIndices,e,t.map(function(D){return[D[0].matricesIndices,D[1]]})),n?[4]:[3,26];case 25:I.sent(),I.label=26;case 26:return this.matricesWeights=r._MergeElement(b.MatricesWeightsKind,this.matricesWeights,e,t.map(function(D){return[D[0].matricesWeights,D[1]]})),n?[4]:[3,28];case 27:I.sent(),I.label=28;case 28:return this.matricesIndicesExtra=r._MergeElement(b.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(function(D){return[D[0].matricesIndicesExtra,D[1]]})),n?[4]:[3,30];case 29:I.sent(),I.label=30;case 30:return this.matricesWeightsExtra=r._MergeElement(b.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(function(D){return[D[0].matricesWeightsExtra,D[1]]})),[2,this]}})},r._MergeElement=function(e,t,i,n){var o=n.filter(function(M){return M[0]!==null&&M[0]!==void 0});if(!t&&o.length==0)return t;if(!t)return this._MergeElement(e,o[0][0],o[0][1],o.slice(1));var a=o.reduce(function(M,C){return M+C[0].length},t.length),s=e===b.PositionKind?r._TransformVector3Coordinates:e===b.NormalKind?r._TransformVector3Normals:e===b.TangentKind?r._TransformVector4Normals:function(){};if(t instanceof Float32Array){var f=new Float32Array(a);f.set(t),i&&s(f,i,0,t.length);for(var u=t.length,l=0,h=o;l<h.length;l++){var c=h[l],p=c[0],d=c[1];f.set(p,u),d&&s(f,d,u,p.length),u+=p.length}return f}else{for(var m=new Array(a),_=0;_<t.length;_++)m[_]=t[_];i&&s(m,i,0,t.length);for(var u=t.length,y=0,g=o;y<g.length;y++){for(var T=g[y],p=T[0],A=T[1],_=0;_<p.length;_++)m[u+_]=p[_];A&&s(m,A,u,p.length),u+=p.length}return m}},r.prototype._validate=function(){if(!this.positions)throw new fi("Positions are required",si.MeshInvalidPositionsError);var e=function(n,o){var a=b.DeduceStride(n);if(o.length%a!==0)throw new Error("The "+n+"s array count must be a multiple of "+a);return o.length/a},t=e(b.PositionKind,this.positions),i=function(n,o){var a=e(n,o);if(a!==t)throw new Error("The "+n+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(b.NormalKind,this.normals),this.tangents&&i(b.TangentKind,this.tangents),this.uvs&&i(b.UVKind,this.uvs),this.uvs2&&i(b.UV2Kind,this.uvs2),this.uvs3&&i(b.UV3Kind,this.uvs3),this.uvs4&&i(b.UV4Kind,this.uvs4),this.uvs5&&i(b.UV5Kind,this.uvs5),this.uvs6&&i(b.UV6Kind,this.uvs6),this.colors&&i(b.ColorKind,this.colors),this.matricesIndices&&i(b.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(b.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(b.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(b.MatricesWeightsExtraKind,this.matricesWeightsExtra)},r.prototype.serialize=function(){var e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e},r.ExtractFromMesh=function(e,t,i){return r._ExtractFrom(e,t,i)},r.ExtractFromGeometry=function(e,t,i){return r._ExtractFrom(e,t,i)},r._ExtractFrom=function(e,t,i){var n=new r;return e.isVerticesDataPresent(b.PositionKind)&&(n.positions=e.getVerticesData(b.PositionKind,t,i)),e.isVerticesDataPresent(b.NormalKind)&&(n.normals=e.getVerticesData(b.NormalKind,t,i)),e.isVerticesDataPresent(b.TangentKind)&&(n.tangents=e.getVerticesData(b.TangentKind,t,i)),e.isVerticesDataPresent(b.UVKind)&&(n.uvs=e.getVerticesData(b.UVKind,t,i)),e.isVerticesDataPresent(b.UV2Kind)&&(n.uvs2=e.getVerticesData(b.UV2Kind,t,i)),e.isVerticesDataPresent(b.UV3Kind)&&(n.uvs3=e.getVerticesData(b.UV3Kind,t,i)),e.isVerticesDataPresent(b.UV4Kind)&&(n.uvs4=e.getVerticesData(b.UV4Kind,t,i)),e.isVerticesDataPresent(b.UV5Kind)&&(n.uvs5=e.getVerticesData(b.UV5Kind,t,i)),e.isVerticesDataPresent(b.UV6Kind)&&(n.uvs6=e.getVerticesData(b.UV6Kind,t,i)),e.isVerticesDataPresent(b.ColorKind)&&(n.colors=e.getVerticesData(b.ColorKind,t,i)),e.isVerticesDataPresent(b.MatricesIndicesKind)&&(n.matricesIndices=e.getVerticesData(b.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(b.MatricesWeightsKind)&&(n.matricesWeights=e.getVerticesData(b.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(b.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=e.getVerticesData(b.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(b.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=e.getVerticesData(b.MatricesWeightsExtraKind,t,i)),n.indices=e.getIndices(t,i),n},r.CreateRibbon=function(e){throw Q("ribbonBuilder")},r.CreateBox=function(e){throw Q("boxBuilder")},r.CreateTiledBox=function(e){throw Q("tiledBoxBuilder")},r.CreateTiledPlane=function(e){throw Q("tiledPlaneBuilder")},r.CreateSphere=function(e){throw Q("sphereBuilder")},r.CreateCylinder=function(e){throw Q("cylinderBuilder")},r.CreateTorus=function(e){throw Q("torusBuilder")},r.CreateLineSystem=function(e){throw Q("linesBuilder")},r.CreateDashedLines=function(e){throw Q("linesBuilder")},r.CreateGround=function(e){throw Q("groundBuilder")},r.CreateTiledGround=function(e){throw Q("groundBuilder")},r.CreateGroundFromHeightMap=function(e){throw Q("groundBuilder")},r.CreatePlane=function(e){throw Q("planeBuilder")},r.CreateDisc=function(e){throw Q("discBuilder")},r.CreatePolygon=function(e,t,i,n,o,a,s){throw Q("polygonBuilder")},r.CreateIcoSphere=function(e){throw Q("icoSphereBuilder")},r.CreatePolyhedron=function(e){throw Q("polyhedronBuilder")},r.CreateCapsule=function(e){throw e===void 0&&(e={orientation:E.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}),Q("capsuleBuilder")},r.CreateTorusKnot=function(e){throw Q("torusKnotBuilder")},r.ComputeNormals=function(e,t,i,n){var o=0,a=0,s=0,f=0,u=0,l=0,h=0,c=0,p=0,d=0,m=0,_=0,y=0,g=0,T=0,A=0,M=0,C=0,P=0,R=0,F=!1,I=!1,D=!1,V=!1,k=1,w=0,G=null;n&&(F=!!n.facetNormals,I=!!n.facetPositions,D=!!n.facetPartitioning,k=n.useRightHandedSystem===!0?-1:1,w=n.ratio||0,V=!!n.depthSort,G=n.distanceTo,V&&G===void 0&&(G=E.Zero()));var K=0,j=0,W=0,z=0;for(D&&n&&n.bbSize&&(K=n.subDiv.X*w/n.bbSize.x,j=n.subDiv.Y*w/n.bbSize.y,W=n.subDiv.Z*w/n.bbSize.z,z=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),o=0;o<e.length;o++)i[o]=0;var oe=t.length/3|0;for(o=0;o<oe;o++){if(_=t[o*3]*3,y=_+1,g=_+2,T=t[o*3+1]*3,A=T+1,M=T+2,C=t[o*3+2]*3,P=C+1,R=C+2,a=e[_]-e[T],s=e[y]-e[A],f=e[g]-e[M],u=e[C]-e[T],l=e[P]-e[A],h=e[R]-e[M],c=k*(s*h-f*l),p=k*(f*u-a*h),d=k*(a*l-s*u),m=Math.sqrt(c*c+p*p+d*d),m=m===0?1:m,c/=m,p/=m,d/=m,F&&n&&(n.facetNormals[o].x=c,n.facetNormals[o].y=p,n.facetNormals[o].z=d),I&&n&&(n.facetPositions[o].x=(e[_]+e[T]+e[C])/3,n.facetPositions[o].y=(e[y]+e[A]+e[P])/3,n.facetPositions[o].z=(e[g]+e[M]+e[R])/3),D&&n){var be=Math.floor((n.facetPositions[o].x-n.bInfo.minimum.x*w)*K),Pe=Math.floor((n.facetPositions[o].y-n.bInfo.minimum.y*w)*j),ze=Math.floor((n.facetPositions[o].z-n.bInfo.minimum.z*w)*W),$e=Math.floor((e[_]-n.bInfo.minimum.x*w)*K),ft=Math.floor((e[y]-n.bInfo.minimum.y*w)*j),ut=Math.floor((e[g]-n.bInfo.minimum.z*w)*W),lt=Math.floor((e[T]-n.bInfo.minimum.x*w)*K),ht=Math.floor((e[A]-n.bInfo.minimum.y*w)*j),Xe=Math.floor((e[M]-n.bInfo.minimum.z*w)*W),Ze=Math.floor((e[C]-n.bInfo.minimum.x*w)*K),St=Math.floor((e[P]-n.bInfo.minimum.y*w)*j),Mt=Math.floor((e[R]-n.bInfo.minimum.z*w)*W),ot=$e+n.subDiv.max*ft+z*ut,ct=lt+n.subDiv.max*ht+z*Xe,Ot=Ze+n.subDiv.max*St+z*Mt,Pt=be+n.subDiv.max*Pe+z*ze;n.facetPartitioning[Pt]=n.facetPartitioning[Pt]?n.facetPartitioning[Pt]:new Array,n.facetPartitioning[ot]=n.facetPartitioning[ot]?n.facetPartitioning[ot]:new Array,n.facetPartitioning[ct]=n.facetPartitioning[ct]?n.facetPartitioning[ct]:new Array,n.facetPartitioning[Ot]=n.facetPartitioning[Ot]?n.facetPartitioning[Ot]:new Array,n.facetPartitioning[ot].push(o),ct!=ot&&n.facetPartitioning[ct].push(o),Ot==ct||Ot==ot||n.facetPartitioning[Ot].push(o),Pt==ot||Pt==ct||Pt==Ot||n.facetPartitioning[Pt].push(o)}if(V&&n&&n.facetPositions){var Wr=n.depthSortedFacets[o];Wr.ind=o*3,Wr.sqDistance=E.DistanceSquared(n.facetPositions[o],G)}i[_]+=c,i[y]+=p,i[g]+=d,i[T]+=c,i[A]+=p,i[M]+=d,i[C]+=c,i[P]+=p,i[R]+=d}for(o=0;o<i.length/3;o++)c=i[o*3],p=i[o*3+1],d=i[o*3+2],m=Math.sqrt(c*c+p*p+d*d),m=m===0?1:m,c/=m,p/=m,d/=m,i[o*3]=c,i[o*3+1]=p,i[o*3+2]=d},r._ComputeSides=function(e,t,i,n,o,a,s){var f=i.length,u=n.length,l,h;switch(e=e||r.DEFAULTSIDE,e){case r.FRONTSIDE:break;case r.BACKSIDE:for(l=0;l<f;l+=3){var c=i[l];i[l]=i[l+2],i[l+2]=c}for(h=0;h<u;h++)n[h]=-n[h];break;case r.DOUBLESIDE:{for(var p=t.length,d=p/3,m=0;m<p;m++)t[p+m]=t[m];for(l=0;l<f;l+=3)i[l+f]=i[l+2]+d,i[l+1+f]=i[l+1]+d,i[l+2+f]=i[l]+d;for(h=0;h<u;h++)n[u+h]=-n[h];var _=o.length,y=0;for(y=0;y<_;y++)o[y+_]=o[y];for(a=a||new It(0,0,1,1),s=s||new It(0,0,1,1),y=0,l=0;l<_/2;l++)o[y]=a.x+(a.z-a.x)*o[y],o[y+1]=a.y+(a.w-a.y)*o[y+1],o[y+_]=s.x+(s.z-s.x)*o[y+_],o[y+_+1]=s.y+(s.w-s.y)*o[y+_+1],y+=2;break}}},r.ImportVertexData=function(e,t){var i=new r,n=e.positions;n&&i.set(n,b.PositionKind);var o=e.normals;o&&i.set(o,b.NormalKind);var a=e.tangents;a&&i.set(a,b.TangentKind);var s=e.uvs;s&&i.set(s,b.UVKind);var f=e.uv2s;f&&i.set(f,b.UV2Kind);var u=e.uv3s;u&&i.set(u,b.UV3Kind);var l=e.uv4s;l&&i.set(l,b.UV4Kind);var h=e.uv5s;h&&i.set(h,b.UV5Kind);var c=e.uv6s;c&&i.set(c,b.UV6Kind);var p=e.colors;p&&i.set(Ae.CheckColors4(p,n.length/3),b.ColorKind);var d=e.matricesIndices;d&&i.set(d,b.MatricesIndicesKind);var m=e.matricesWeights;m&&i.set(m,b.MatricesWeightsKind);var _=e.indices;_&&(i.indices=_),t.setAllVerticesData(i,e.updatable)},r.FRONTSIDE=0,r.BACKSIDE=1,r.DOUBLESIDE=2,r.DEFAULTSIDE=0,x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0];return!Array.isArray(i)})],r,"_TransformVector3Coordinates",null),x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0];return!Array.isArray(i)})],r,"_TransformVector3Normals",null),x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0];return!Array.isArray(i)})],r,"_TransformVector4Normals",null),x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0];return!Array.isArray(i)})],r,"_FlipFaces",null),r}();v();v();v();var Gi=function(){function r(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}return r}();v();v();var di=function(){function r(e,t,i){this.vectors=Be.BuildArray(8,E.Zero),this.center=E.Zero(),this.centerWorld=E.Zero(),this.extendSize=E.Zero(),this.extendSizeWorld=E.Zero(),this.directions=Be.BuildArray(3,E.Zero),this.vectorsWorld=Be.BuildArray(8,E.Zero),this.minimumWorld=E.Zero(),this.maximumWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}return r.prototype.reConstruct=function(e,t,i){var n=e.x,o=e.y,a=e.z,s=t.x,f=t.y,u=t.z,l=this.vectors;this.minimum.copyFromFloats(n,o,a),this.maximum.copyFromFloats(s,f,u),l[0].copyFromFloats(n,o,a),l[1].copyFromFloats(s,f,u),l[2].copyFromFloats(s,o,a),l[3].copyFromFloats(n,f,a),l[4].copyFromFloats(n,o,u),l[5].copyFromFloats(s,f,a),l[6].copyFromFloats(n,f,u),l[7].copyFromFloats(s,o,u),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||B.IdentityReadOnly,this._update(this._worldMatrix)},r.prototype.scale=function(e){var t=r._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),n=i.length();i.normalizeFromLength(n);var o=n*e,a=i.scaleInPlace(o*.5),s=this.center.subtractToRef(a,t[1]),f=this.center.addToRef(a,t[2]);return this.reConstruct(s,f,this._worldMatrix),this},r.prototype.getWorldMatrix=function(){return this._worldMatrix},r.prototype._update=function(e){var t=this.minimumWorld,i=this.maximumWorld,n=this.directions,o=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(var s=0;s<8;++s)o[s].copyFrom(a[s]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(var s=0;s<8;++s){var f=o[s];E.TransformCoordinatesToRef(a[s],e,f),t.minimizeInPlace(f),i.maximizeInPlace(f)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}E.FromArrayToRef(e.m,0,n[0]),E.FromArrayToRef(e.m,4,n[1]),E.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e},r.prototype.isInFrustum=function(e){return r.IsInFrustum(this.vectorsWorld,e)},r.prototype.isCompletelyInFrustum=function(e){return r.IsCompletelyInFrustum(this.vectorsWorld,e)},r.prototype.intersectsPoint=function(e){var t=this.minimumWorld,i=this.maximumWorld,n=t.x,o=t.y,a=t.z,s=i.x,f=i.y,u=i.z,l=e.x,h=e.y,c=e.z,p=-ye;return!(s-l<p||p>l-n||f-h<p||p>h-o||u-c<p||p>c-a)},r.prototype.intersectsSphere=function(e){return r.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)},r.prototype.intersectsMinMax=function(e,t){var i=this.minimumWorld,n=this.maximumWorld,o=i.x,a=i.y,s=i.z,f=n.x,u=n.y,l=n.z,h=e.x,c=e.y,p=e.z,d=t.x,m=t.y,_=t.z;return!(f<h||o>d||u<c||a>m||l<p||s>_)},r.prototype.dispose=function(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()},r.Intersects=function(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)},r.IntersectsSphere=function(e,t,i,n){var o=r._TmpVector3[0];E.ClampToRef(i,e,t,o);var a=E.DistanceSquared(i,o);return a<=n*n},r.IsCompletelyInFrustum=function(e,t){for(var i=0;i<6;++i)for(var n=t[i],o=0;o<8;++o)if(n.dotCoordinate(e[o])<0)return!1;return!0},r.IsInFrustum=function(e,t){for(var i=0;i<6;++i){for(var n=!0,o=t[i],a=0;a<8;++a)if(o.dotCoordinate(e[a])>=0){n=!1;break}if(n)return!1}return!0},r._TmpVector3=Be.BuildArray(3,E.Zero),r}();v();var ga=function(){function r(e,t,i){this.center=E.Zero(),this.centerWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this.reConstruct(e,t,i)}return r.prototype.reConstruct=function(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);var n=E.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=n*.5,this._update(i||B.IdentityReadOnly)},r.prototype.scale=function(e){var t=this.radius*e,i=r._TmpVector3,n=i[0].setAll(t),o=this.center.subtractToRef(n,i[1]),a=this.center.addToRef(n,i[2]);return this.reConstruct(o,a,this._worldMatrix),this},r.prototype.getWorldMatrix=function(){return this._worldMatrix},r.prototype._update=function(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{E.TransformCoordinatesToRef(this.center,e,this.centerWorld);var t=r._TmpVector3[0];E.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}},r.prototype.isInFrustum=function(e){for(var t=this.centerWorld,i=this.radiusWorld,n=0;n<6;n++)if(e[n].dotCoordinate(t)<=-i)return!1;return!0},r.prototype.isCenterInFrustum=function(e){for(var t=this.centerWorld,i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0},r.prototype.intersectsPoint=function(e){var t=E.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)},r.Intersects=function(e,t){var i=E.DistanceSquared(e.centerWorld,t.centerWorld),n=e.radiusWorld+t.radiusWorld;return!(n*n<i)},r.CreateFromCenterAndRadius=function(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);var n=new r(this._TmpVector3[0],this._TmpVector3[2]);return i?n._worldMatrix=i:n._worldMatrix=B.Identity(),n},r._TmpVector3=Be.BuildArray(3,E.Zero),r}();var ya={min:0,max:0},ba={min:0,max:0},Ah=function(r,e,t){var i=E.Dot(e.centerWorld,r),n=Math.abs(E.Dot(e.directions[0],r))*e.extendSize.x,o=Math.abs(E.Dot(e.directions[1],r))*e.extendSize.y,a=Math.abs(E.Dot(e.directions[2],r))*e.extendSize.z,s=n+o+a;t.min=i-s,t.max=i+s},yt=function(r,e,t){return Ah(r,e,ya),Ah(r,t,ba),!(ya.min>ba.max||ba.min>ya.max)},Kt=function(){function r(e,t,i){this._isLocked=!1,this.boundingBox=new di(e,t,i),this.boundingSphere=new ga(e,t,i)}return r.prototype.reConstruct=function(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)},Object.defineProperty(r.prototype,"minimum",{get:function(){return this.boundingBox.minimum},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"maximum",{get:function(){return this.boundingBox.maximum},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isLocked",{get:function(){return this._isLocked},set:function(e){this._isLocked=e},enumerable:!1,configurable:!0}),r.prototype.update=function(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))},r.prototype.centerOn=function(e,t){var i=r._TmpVector3[0].copyFrom(e).subtractInPlace(t),n=r._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this},r.prototype.encapsulate=function(e){var t=E.Minimize(this.minimum,e),i=E.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this},r.prototype.encapsulateBoundingInfo=function(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this},r.prototype.scale=function(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this},r.prototype.isInFrustum=function(e,t){t===void 0&&(t=0);var i=t===2||t===3;if(i&&this.boundingSphere.isCenterInFrustum(e))return!0;if(!this.boundingSphere.isInFrustum(e))return!1;var n=t===1||t===3;return n?!0:this.boundingBox.isInFrustum(e)},Object.defineProperty(r.prototype,"diagonalLength",{get:function(){var e=this.boundingBox,t=e.maximumWorld.subtractToRef(e.minimumWorld,r._TmpVector3[0]);return t.length()},enumerable:!1,configurable:!0}),r.prototype.isCompletelyInFrustum=function(e){return this.boundingBox.isCompletelyInFrustum(e)},r.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},r.prototype.intersectsPoint=function(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))},r.prototype.intersects=function(e,t){if(!ga.Intersects(this.boundingSphere,e.boundingSphere)||!di.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;var i=this.boundingBox,n=e.boundingBox;return!(!yt(i.directions[0],i,n)||!yt(i.directions[1],i,n)||!yt(i.directions[2],i,n)||!yt(n.directions[0],i,n)||!yt(n.directions[1],i,n)||!yt(n.directions[2],i,n)||!yt(E.Cross(i.directions[0],n.directions[0]),i,n)||!yt(E.Cross(i.directions[0],n.directions[1]),i,n)||!yt(E.Cross(i.directions[0],n.directions[2]),i,n)||!yt(E.Cross(i.directions[1],n.directions[0]),i,n)||!yt(E.Cross(i.directions[1],n.directions[1]),i,n)||!yt(E.Cross(i.directions[1],n.directions[2]),i,n)||!yt(E.Cross(i.directions[2],n.directions[0]),i,n)||!yt(E.Cross(i.directions[2],n.directions[1]),i,n)||!yt(E.Cross(i.directions[2],n.directions[2]),i,n))},r._TmpVector3=Be.BuildArray(2,E.Zero),r}();v();var Sh=function(){function r(){}return r.extractMinAndMaxIndexed=function(e,t,i,n,o,a){for(var s=i;s<i+n;s++){var f=t[s]*3,u=e[f],l=e[f+1],h=e[f+2];o.minimizeInPlaceFromFloats(u,l,h),a.maximizeInPlaceFromFloats(u,l,h)}},r.extractMinAndMax=function(e,t,i,n,o,a){for(var s=t,f=t*n;s<t+i;s++,f+=n){var u=e[f],l=e[f+1],h=e[f+2];o.minimizeInPlaceFromFloats(u,l,h),a.maximizeInPlaceFromFloats(u,l,h)}},x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0],n=e[1];return!Array.isArray(i)&&!Array.isArray(n)})],r,"extractMinAndMaxIndexed",null),x([Xt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[0];return!Array.isArray(i)})],r,"extractMinAndMax",null),r}();function Mh(r,e,t,i,n){n===void 0&&(n=null);var o=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Sh.extractMinAndMaxIndexed(r,e,t,i,o,a),n&&(o.x-=o.x*n.x+n.y,o.y-=o.y*n.x+n.y,o.z-=o.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:o,maximum:a}}function Xn(r,e,t,i,n){i===void 0&&(i=null);var o=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),Sh.extractMinAndMax(r,e,t,n,o,a),i&&(o.x-=o.x*i.x+i.y,o.y-=o.y*i.x+i.y,o.z-=o.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:o,maximum:a}}var Bt=function(){function r(e,t,i,n,o,a,s,f,u){f===void 0&&(f=!0),u===void 0&&(u=!0),this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=n,this.indexCount=o,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=s||a,u&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,f&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}return Object.defineProperty(r.prototype,"materialDefines",{get:function(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines},set:function(e){var t,i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e},enumerable:!1,configurable:!0}),r.prototype._getDrawWrapper=function(e,t){t===void 0&&(t=!1),e=e!=null?e:this._engine.currentRenderPassId;var i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new li(this._mesh.getScene().getEngine())),i},r.prototype._removeDrawWrapper=function(e,t){var i;t===void 0&&(t=!0),t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0},Object.defineProperty(r.prototype,"effect",{get:function(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_drawWrapper",{get:function(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_drawWrapperOverride",{get:function(){return this._mainDrawWrapperOverride},enumerable:!1,configurable:!0}),r.prototype._setMainDrawWrapperOverride=function(e){this._mainDrawWrapperOverride=e},r.prototype.setEffect=function(e,t,i,n){t===void 0&&(t=null),n===void 0&&(n=!0);var o=this._drawWrapper;o.setEffect(e,t,n),i!==void 0&&(o.materialContext=i),e||(o.defines=null,o.materialContext=void 0)},r.prototype.resetDrawCache=function(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(var t=0,i=this._drawWrappers;t<i.length;t++){var n=i[t];n==null||n.dispose()}this._drawWrappers=[]},r.AddToMesh=function(e,t,i,n,o,a,s,f){return f===void 0&&(f=!0),new r(e,t,i,n,o,a,s,f)},Object.defineProperty(r.prototype,"IsGlobal",{get:function(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()},enumerable:!1,configurable:!0}),r.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},r.prototype.setBoundingInfo=function(e){return this._boundingInfo=e,this},r.prototype.getMesh=function(){return this._mesh},r.prototype.getRenderingMesh=function(){return this._renderingMesh},r.prototype.getReplacementMesh=function(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null},r.prototype.getEffectiveMesh=function(){var e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh},r.prototype.getMaterial=function(e){var t;e===void 0&&(e=!0);var i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){var n=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}}else return e?this._mesh.getScene().defaultMaterial:null;return i},r.prototype._isMultiMaterial=function(e){return e.getSubMaterial!==void 0},r.prototype.refreshBoundingInfo=function(e){if(e===void 0&&(e=null),this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(b.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var t=this._renderingMesh.getIndices(),i;if(this.indexStart===0&&this.indexCount===t.length){var n=this._renderingMesh.getBoundingInfo();i={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else i=Mh(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Kt(i.minimum,i.maximum),this},r.prototype._checkCollision=function(e){var t=this.getBoundingInfo();return t._checkCollision(e)},r.prototype.updateBoundingInfo=function(e){var t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this},r.prototype.isInFrustum=function(e){var t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1},r.prototype.isCompletelyInFrustum=function(e){var t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1},r.prototype.render=function(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this},r.prototype._getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){for(var i=[],n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)i.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer},r.prototype.canIntersects=function(e){var t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1},r.prototype.intersects=function(e,t,i,n,o){var a=this.getMaterial();if(!a)return null;var s=3,f=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:s=1,f=!0;break;default:break}return a.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,n):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,n,o):this._intersectTriangles(e,t,i,s,f,n,o)},r.prototype._intersectLines=function(e,t,i,n,o){for(var a=null,s=this.indexStart;s<this.indexStart+this.indexCount;s+=2){var f=t[i[s]],u=t[i[s+1]],l=e.intersectionSegment(f,u,n);if(!(l<0)&&(o||!a||l<a.distance)&&(a=new Gi(null,null,l),a.faceId=s/2,o))break}return a},r.prototype._intersectUnIndexedLines=function(e,t,i,n,o){for(var a=null,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=2){var f=t[s],u=t[s+1],l=e.intersectionSegment(f,u,n);if(!(l<0)&&(o||!a||l<a.distance)&&(a=new Gi(null,null,l),a.faceId=s/2,o))break}return a},r.prototype._intersectTriangles=function(e,t,i,n,o,a,s){for(var f=null,u=-1,l=this.indexStart;l<this.indexStart+this.indexCount-(3-n);l+=n){u++;var h=i[l],c=i[l+1],p=i[l+2];if(o&&p===4294967295){l+=2;continue}var d=t[h],m=t[c],_=t[p];if(!(!d||!m||!_)&&!(s&&!s(d,m,_,e))){var y=e.intersectsTriangle(d,m,_);if(y){if(y.distance<0)continue;if((a||!f||y.distance<f.distance)&&(f=y,f.faceId=u,a))break}}}return f},r.prototype._intersectUnIndexedTriangles=function(e,t,i,n,o){for(var a=null,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=3){var f=t[s],u=t[s+1],l=t[s+2];if(!(o&&!o(f,u,l,e))){var h=e.intersectsTriangle(f,u,l);if(h){if(h.distance<0)continue;if((n||!a||h.distance<a.distance)&&(a=h,a.faceId=s/3,n))break}}}return a},r.prototype._rebuild=function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)},r.prototype.clone=function(e,t){var i=new r(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){var n=this.getBoundingInfo();if(!n)return i;i._boundingInfo=new Kt(n.minimum,n.maximum)}return i},r.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()},r.prototype.getClassName=function(){return"SubMesh"},r.CreateFromIndices=function(e,t,i,n,o,a){a===void 0&&(a=!0);for(var s=Number.MAX_VALUE,f=-Number.MAX_VALUE,u=o||n,l=u.getIndices(),h=t;h<t+i;h++){var c=l[h];c<s&&(s=c),c>f&&(f=c)}return new r(e,s,f-s+1,t,i,n,o,a)},r}();v();var Hn=function(){function r(){}return Object.defineProperty(r,"ForceFullSceneLoadingForIncremental",{get:function(){return r._ForceFullSceneLoadingForIncremental},set:function(e){r._ForceFullSceneLoadingForIncremental=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ShowLoadingScreen",{get:function(){return r._ShowLoadingScreen},set:function(e){r._ShowLoadingScreen=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"loggingLevel",{get:function(){return r._LoggingLevel},set:function(e){r._LoggingLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"CleanBoneMatrixWeights",{get:function(){return r._CleanBoneMatrixWeights},set:function(e){r._CleanBoneMatrixWeights=e},enumerable:!1,configurable:!0}),r._ForceFullSceneLoadingForIncremental=!1,r._ShowLoadingScreen=!0,r._CleanBoneMatrixWeights=!1,r._LoggingLevel=0,r}();v();var Oe=function(){function r(){}return r.UseOpenGLOrientationForUV=!1,r}();var nr=function(){function r(e,t,i,n,o){n===void 0&&(n=!1),o===void 0&&(o=null),this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||le.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,i?this.setAllVerticesData(i,n):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),o&&(this.applyToMesh(o),o.computeWorldMatrix(!0)))}return Object.defineProperty(r.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)},enumerable:!1,configurable:!0}),r.CreateGeometryForMesh=function(e){var t=new r(r.RandomId(),e.getScene());return t.applyToMesh(e),t},Object.defineProperty(r.prototype,"meshes",{get:function(){return this._meshes},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"extend",{get:function(){return this._extend},enumerable:!1,configurable:!0}),r.prototype.getScene=function(){return this._scene},r.prototype.getEngine=function(){return this._engine},r.prototype.isReady=function(){return this.delayLoadState===1||this.delayLoadState===0},Object.defineProperty(r.prototype,"doNotSerialize",{get:function(){for(var e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0},enumerable:!1,configurable:!0}),r.prototype._rebuild=function(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(var e in this._vertexBuffers){var t=this._vertexBuffers[e];t._rebuild()}},r.prototype.setAllVerticesData=function(e,t){e.applyToGeometry(this,t),this._notifyUpdate()},r.prototype.setVerticesData=function(e,t,i,n){i===void 0&&(i=!1),i&&Array.isArray(t)&&(t=new Float32Array(t));var o=new b(this._engine,t,e,i,this._meshes.length===0,n);this.setVerticesBuffer(o)},r.prototype.removeVerticesData=function(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()},r.prototype.setVerticesBuffer=function(e,t,i){t===void 0&&(t=null),i===void 0&&(i=!0);var n=e.getKind();this._vertexBuffers[n]&&i&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;var o=this._meshes,a=o.length;if(n===b.PositionKind){var s=e.getData();t!=null?this._totalVertices=t:s!=null&&(this._totalVertices=s.length/(e.type===b.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(s),this._resetPointsArrayCache();for(var f=0;f<a;f++){var u=o[f];u.buildBoundingInfo(this._extend.minimum,this._extend.maximum),u._createGlobalSubMesh(u.isUnIndexed),u.computeWorldMatrix(!0),u.synchronizeInstances()}}this._notifyUpdate(n)},r.prototype.updateVerticesDataDirectly=function(e,t,i,n){n===void 0&&(n=!1);var o=this.getVertexBuffer(e);!o||(o.updateDirectly(t,i,n),this._notifyUpdate(e))},r.prototype.updateVerticesData=function(e,t,i){i===void 0&&(i=!1);var n=this.getVertexBuffer(e);!n||(n.update(t),e===b.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))},r.prototype._updateBoundingInfo=function(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e)for(var i=this._meshes,n=0,o=i;n<o.length;n++){var a=o[n];a.hasBoundingInfo?a.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):a.buildBoundingInfo(this._extend.minimum,this._extend.maximum);for(var s=a.subMeshes,f=0,u=s;f<u.length;f++){var l=u[f];l.refreshBoundingInfo()}}},r.prototype._bind=function(e,t,i,n){if(!!e){t===void 0&&(t=this._indexBuffer);var o=this.getVertexBuffers();if(!!o){if(t!=this._indexBuffer||!this._vertexArrayObjects&&!n){this._engine.bindBuffers(o,t,e,i);return}var a=n||this._vertexArrayObjects;a[e.key]||(a[e.key]=this._engine.recordVertexArrayObject(o,t,e,i)),this._engine.bindVertexArrayObject(a[e.key],t)}}},r.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},r.prototype.getVerticesData=function(e,t,i){var n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null},r.prototype.isVertexBufferUpdatable=function(e){var t=this._vertexBuffers[e];return t?t.isUpdatable():!1},r.prototype.getVertexBuffer=function(e){return this.isReady()?this._vertexBuffers[e]:null},r.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},r.prototype.isVerticesDataPresent=function(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},r.prototype.getVerticesDataKinds=function(){var e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e},r.prototype.updateIndices=function(e,t,i){if(i===void 0&&(i=!1),!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{var n=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),n)for(var o=0,a=this._meshes;o<a.length;o++){var s=a[o];s._createGlobalSubMesh(!0)}}},r.prototype.setIndices=function(e,t,i){t===void 0&&(t=null),i===void 0&&(i=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(var n=0,o=this._meshes;n<o.length;n++){var a=o[n];a._createGlobalSubMesh(!0),a.synchronizeInstances()}this._notifyUpdate()},r.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},r.prototype.getIndices=function(e,t){if(!this.isReady())return null;var i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()},r.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},r.prototype._releaseVertexArrayObject=function(e){e===void 0&&(e=null),!(!e||!this._vertexArrayObjects)&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])},r.prototype.releaseForMesh=function(e,t){var i=this._meshes,n=i.indexOf(e);n!==-1&&(i.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())},r.prototype.applyToMesh=function(e){if(e._geometry!==this){var t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();var i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}},r.prototype._updateExtend=function(e){if(e===void 0&&(e=null),this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(b.PositionKind),!e))return;this._extend=Xn(e,0,this._totalVertices,this.boundingBias,3)}},r.prototype._applyToMesh=function(e){var t=this._meshes.length;for(var i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===b.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()},r.prototype._notifyUpdate=function(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(var t=0,i=this._meshes;t<i.length;t++){var n=i[t];n._markSubMeshesAsAttributesDirty()}},r.prototype.load=function(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}},r.prototype._queueLoad=function(e,t){var i=this;!this.delayLoadingFile||(e.addPendingData(this),e._loadFile(this.delayLoadingFile,function(n){if(!!i._delayLoadingFunction){i._delayLoadingFunction(JSON.parse(n),i),i.delayLoadState=1,i._delayInfo=[],e.removePendingData(i);for(var o=i._meshes,a=o.length,s=0;s<a;s++)i._applyToMesh(o[s]);t&&t()}},void 0,!0))},r.prototype.toLeftHanded=function(){var e=this.getIndices(!1);if(e!=null&&e.length>0){for(var t=0;t<e.length;t+=3){var i=e[t+0];e[t+0]=e[t+2],e[t+2]=i}this.setIndices(e)}var n=this.getVerticesData(b.PositionKind,!1);if(n!=null&&n.length>0){for(var t=0;t<n.length;t+=3)n[t+2]=-n[t+2];this.setVerticesData(b.PositionKind,n,!1)}var o=this.getVerticesData(b.NormalKind,!1);if(o!=null&&o.length>0){for(var t=0;t<o.length;t+=3)o[t+2]=-o[t+2];this.setVerticesData(b.NormalKind,o,!1)}},r.prototype._resetPointsArrayCache=function(){this._positions=null},r.prototype._generatePointsArray=function(){if(this._positions)return!0;var e=this.getVerticesData(b.PositionKind);if(!e||e.length===0)return!1;for(var t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=E.FromArray(e,t);for(var t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0},r.prototype.isDisposed=function(){return this._isDisposed},r.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};for(var t=this._meshes,i=t.length,n=0;n<i;n++)t[n]._invalidateInstanceVertexArrayObject()}},r.prototype.dispose=function(){var e=this._meshes,t=e.length,i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){var o=this._parentContainer.geometries.indexOf(this);o>-1&&this._parentContainer.geometries.splice(o,1),this._parentContainer=null}this._isDisposed=!0},r.prototype.copy=function(e){var t=new re;t.indices=[];var i=this.getIndices();if(i)for(var n=0;n<i.length;n++)t.indices.push(i[n]);var o=!1,a=!1,s;for(s in this._vertexBuffers){var f=this.getVerticesData(s);if(f&&(f instanceof Float32Array?t.set(new Float32Array(f),s):t.set(f.slice(0),s),!a)){var u=this.getVertexBuffer(s);u&&(o=u.isUpdatable(),a=!o)}}var l=new r(e,this._scene,t,o);l.delayLoadState=this.delayLoadState,l.delayLoadingFile=this.delayLoadingFile,l._delayLoadingFunction=this._delayLoadingFunction;for(s in this._delayInfo)l._delayInfo=l._delayInfo||[],l._delayInfo.push(s);return l._boundingInfo=new Kt(this._extend.minimum,this._extend.maximum),l},r.prototype.serialize=function(){var e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Ee&&Ee.HasTags(this)&&(e.tags=Ee.GetTags(this)),e},r.prototype._toNumberArray=function(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)},r.prototype.clearCachedData=function(){this._indices=[],this._resetPointsArrayCache();for(var e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)},r.prototype.serializeVerticeData=function(){var e=this.serialize();return this.isVerticesDataPresent(b.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(b.PositionKind)),this.isVertexBufferUpdatable(b.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(b.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(b.NormalKind)),this.isVertexBufferUpdatable(b.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(b.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(b.TangentKind)),this.isVertexBufferUpdatable(b.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(b.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(b.UVKind)),this.isVertexBufferUpdatable(b.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(b.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(b.UV2Kind)),this.isVertexBufferUpdatable(b.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(b.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(b.UV3Kind)),this.isVertexBufferUpdatable(b.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(b.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(b.UV4Kind)),this.isVertexBufferUpdatable(b.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(b.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(b.UV5Kind)),this.isVertexBufferUpdatable(b.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(b.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(b.UV6Kind)),this.isVertexBufferUpdatable(b.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(b.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(b.ColorKind)),this.isVertexBufferUpdatable(b.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(b.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(b.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(b.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(b.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(b.MatricesWeightsKind)),this.isVertexBufferUpdatable(b.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e},r.ExtractFromMesh=function(e,t){var i=e._geometry;return i?i.copy(t):null},r.RandomId=function(){return he.RandomId()},r._GetGeometryByLoadedUniqueId=function(e,t){for(var i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null},r._ImportGeometry=function(e,t){var i=t.getScene(),n=e.geometryUniqueId,o=e.geometryId;if(n||o){var a=n?this._GetGeometryByLoadedUniqueId(n,i):i.getGeometryById(o);a&&a.applyToMesh(t)}else if(e instanceof ArrayBuffer){var s=t._binaryInfo;if(s.positionsAttrDesc&&s.positionsAttrDesc.count>0){var f=new Float32Array(e,s.positionsAttrDesc.offset,s.positionsAttrDesc.count);t.setVerticesData(b.PositionKind,f,!1)}if(s.normalsAttrDesc&&s.normalsAttrDesc.count>0){var u=new Float32Array(e,s.normalsAttrDesc.offset,s.normalsAttrDesc.count);t.setVerticesData(b.NormalKind,u,!1)}if(s.tangetsAttrDesc&&s.tangetsAttrDesc.count>0){var l=new Float32Array(e,s.tangetsAttrDesc.offset,s.tangetsAttrDesc.count);t.setVerticesData(b.TangentKind,l,!1)}if(s.uvsAttrDesc&&s.uvsAttrDesc.count>0){var h=new Float32Array(e,s.uvsAttrDesc.offset,s.uvsAttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<h.length;c+=2)h[c]=1-h[c];t.setVerticesData(b.UVKind,h,!1)}if(s.uvs2AttrDesc&&s.uvs2AttrDesc.count>0){var p=new Float32Array(e,s.uvs2AttrDesc.offset,s.uvs2AttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<p.length;c+=2)p[c]=1-p[c];t.setVerticesData(b.UV2Kind,p,!1)}if(s.uvs3AttrDesc&&s.uvs3AttrDesc.count>0){var d=new Float32Array(e,s.uvs3AttrDesc.offset,s.uvs3AttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<d.length;c+=2)d[c]=1-d[c];t.setVerticesData(b.UV3Kind,d,!1)}if(s.uvs4AttrDesc&&s.uvs4AttrDesc.count>0){var m=new Float32Array(e,s.uvs4AttrDesc.offset,s.uvs4AttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<m.length;c+=2)m[c]=1-m[c];t.setVerticesData(b.UV4Kind,m,!1)}if(s.uvs5AttrDesc&&s.uvs5AttrDesc.count>0){var _=new Float32Array(e,s.uvs5AttrDesc.offset,s.uvs5AttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<_.length;c+=2)_[c]=1-_[c];t.setVerticesData(b.UV5Kind,_,!1)}if(s.uvs6AttrDesc&&s.uvs6AttrDesc.count>0){var y=new Float32Array(e,s.uvs6AttrDesc.offset,s.uvs6AttrDesc.count);if(Oe.UseOpenGLOrientationForUV)for(var c=1;c<y.length;c+=2)y[c]=1-y[c];t.setVerticesData(b.UV6Kind,y,!1)}if(s.colorsAttrDesc&&s.colorsAttrDesc.count>0){var g=new Float32Array(e,s.colorsAttrDesc.offset,s.colorsAttrDesc.count);t.setVerticesData(b.ColorKind,g,!1,s.colorsAttrDesc.stride)}if(s.matricesIndicesAttrDesc&&s.matricesIndicesAttrDesc.count>0){for(var T=new Int32Array(e,s.matricesIndicesAttrDesc.offset,s.matricesIndicesAttrDesc.count),A=[],M=0;M<T.length;M++){var c=T[M];A.push(c&255),A.push((c&65280)>>8),A.push((c&16711680)>>16),A.push(c>>24&255)}t.setVerticesData(b.MatricesIndicesKind,A,!1)}if(s.matricesIndicesExtraAttrDesc&&s.matricesIndicesExtraAttrDesc.count>0){for(var T=new Int32Array(e,s.matricesIndicesExtraAttrDesc.offset,s.matricesIndicesExtraAttrDesc.count),A=[],M=0;M<T.length;M++){var c=T[M];A.push(c&255),A.push((c&65280)>>8),A.push((c&16711680)>>16),A.push(c>>24&255)}t.setVerticesData(b.MatricesIndicesExtraKind,A,!1)}if(s.matricesWeightsAttrDesc&&s.matricesWeightsAttrDesc.count>0){var C=new Float32Array(e,s.matricesWeightsAttrDesc.offset,s.matricesWeightsAttrDesc.count);t.setVerticesData(b.MatricesWeightsKind,C,!1)}if(s.indicesAttrDesc&&s.indicesAttrDesc.count>0){var P=new Int32Array(e,s.indicesAttrDesc.offset,s.indicesAttrDesc.count);t.setIndices(P,null)}if(s.subMeshesAttrDesc&&s.subMeshesAttrDesc.count>0){var R=new Int32Array(e,s.subMeshesAttrDesc.offset,s.subMeshesAttrDesc.count*5);t.subMeshes=[];for(var M=0;M<s.subMeshesAttrDesc.count;M++){var F=R[M*5+0],I=R[M*5+1],D=R[M*5+2],V=R[M*5+3],k=R[M*5+4];Bt.AddToMesh(F,I,D,V,k,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(b.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(b.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(b.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(b.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(b.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(b.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(b.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(b.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(b.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(b.ColorKind,Ae.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{for(var A=[],M=0;M<e.matricesIndices.length;M++){var w=e.matricesIndices[M];A.push(w&255),A.push((w&65280)>>8),A.push((w&16711680)>>16),A.push(w>>24&255)}t.setVerticesData(b.MatricesIndicesKind,A,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{for(var A=[],M=0;M<e.matricesIndicesExtra.length;M++){var w=e.matricesIndicesExtra[M];A.push(w&255),A.push((w&65280)>>8),A.push((w&16711680)>>16),A.push(w>>24&255)}t.setVerticesData(b.MatricesIndicesExtraKind,A,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(r._CleanMatricesWeights(e,t),t.setVerticesData(b.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(b.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(var G=0;G<e.subMeshes.length;G++){var K=e.subMeshes[G];Bt.AddToMesh(K.materialIndex,K.verticesStart,K.verticesCount,K.indexStart,K.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)},r._CleanMatricesWeights=function(e,t){var i=.001;if(!!Hn.CleanBoneMatrixWeights){var n=0;if(e.skeletonId>-1){var o=t.getScene().getLastSkeletonById(e.skeletonId);if(!o)return;n=o.bones.length}else return;for(var a=t.getVerticesData(b.MatricesIndicesKind),s=t.getVerticesData(b.MatricesIndicesExtraKind),f=e.matricesWeights,u=e.matricesWeightsExtra,l=e.numBoneInfluencer,h=f.length,c=0;c<h;c+=4){for(var p=0,d=-1,m=0;m<4;m++){var _=f[c+m];p+=_,_<i&&d<0&&(d=m)}if(u)for(var m=0;m<4;m++){var _=u[c+m];p+=_,_<i&&d<0&&(d=m+4)}if((d<0||d>l-1)&&(d=l-1),p>i){for(var y=1/p,m=0;m<4;m++)f[c+m]*=y;if(u)for(var m=0;m<4;m++)u[c+m]*=y}else d>=4?(u[c+d-4]=1-p,s[c+d-4]=n):(f[c+d]=1-p,a[c+d]=n)}t.setVerticesData(b.MatricesIndicesKind,a),e.matricesWeightsExtra&&t.setVerticesData(b.MatricesIndicesExtraKind,s)}},r.Parse=function(e,t,i){var n=new r(e.id,t,void 0,e.updatable);return n._loadedUniqueId=e.uniqueId,Ee&&Ee.AddTagsTo(n,e.tags),e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+e.delayLoadingFile,n._boundingInfo=new Kt(E.FromArray(e.boundingBoxMinimum),E.FromArray(e.boundingBoxMaximum)),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(b.UVKind),e.hasUVs2&&n._delayInfo.push(b.UV2Kind),e.hasUVs3&&n._delayInfo.push(b.UV3Kind),e.hasUVs4&&n._delayInfo.push(b.UV4Kind),e.hasUVs5&&n._delayInfo.push(b.UV5Kind),e.hasUVs6&&n._delayInfo.push(b.UV6Kind),e.hasColors&&n._delayInfo.push(b.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(b.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(b.MatricesWeightsKind),n._delayLoadingFunction=re.ImportVertexData):re.ImportVertexData(e,n),t.pushGeometry(n,!0),n},r}();v();v();v();var Rh=function(){function r(e){e===void 0&&(e=30),this._enabled=!0,this._rollingFrameTime=new bv(e)}return r.prototype.sampleFrame=function(e){if(e===void 0&&(e=Wt.Now),!!this._enabled){if(this._lastFrameTimeMs!=null){var t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}},Object.defineProperty(r.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);return e===0?0:1e3/e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!1,configurable:!0}),r.prototype.enable=function(){this._enabled=!0},r.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(r.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),r.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},r}();var bv=function(){function r(e){this._samples=new Array(e),this.reset()}return r.prototype.add=function(e){var t;if(this.isSaturated()){var i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length},r.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]},r.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},r.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},r.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t},r}();v();var Fr=function(){function r(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(r.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"average",{get:function(){return this._average},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"current",{get:function(){return this._current},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"count",{get:function(){return this._totalValueCount},enumerable:!1,configurable:!0}),r.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},r.prototype.addCount=function(e,t){!r.Enabled||(this._current+=e,t&&this._fetchResult())},r.prototype.beginMonitoring=function(){!r.Enabled||(this._startMonitoringTime=Wt.Now)},r.prototype.endMonitoring=function(e){if(e===void 0&&(e=!0),!!r.Enabled){e&&this.fetchNewFrame();var t=Wt.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}},r.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var e=Wt.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)},r.Enabled=!0,r}();v();me.prototype.setAlphaConstants=function(r,e,t,i){this._alphaState.setAlphaBlendConstants(r,e,t,i)};me.prototype.setAlphaMode=function(r,e){if(e===void 0&&(e=!1),this._alphaMode!==r){switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=r===0),this._alphaMode=r}};me.prototype.getAlphaMode=function(){return this._alphaMode};me.prototype.setAlphaEquation=function(r){if(this._alphaEquation!==r){switch(r){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=r}};me.prototype.getAlphaEquation=function(){return this._alphaEquation};v();function Ev(r,e,t,i){switch(t===void 0&&(t=!1),r){case 3:{var n=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&n.set(new Int8Array(i)),n}case 0:{var o=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&o.set(new Uint8Array(i)),o}case 4:{var a=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&a.set(new Int16Array(i)),a}case 5:case 8:case 9:case 10:case 2:{var s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&s.set(new Uint16Array(i)),s}case 6:{var f=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&f.set(new Int32Array(i)),f}case 7:case 11:case 12:case 13:case 14:case 15:{var u=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&u.set(new Uint32Array(i)),u}case 1:{var l=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&l.set(new Float32Array(i)),l}}var h=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&h.set(new Uint8Array(i)),h}me.prototype._readTexturePixelsSync=function(r,e,t,i,n,o,a,s,f,u){var l,h;i===void 0&&(i=-1),n===void 0&&(n=0),o===void 0&&(o=null),a===void 0&&(a=!0),s===void 0&&(s=!1),f===void 0&&(f=0),u===void 0&&(u=0);var c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var p=c.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),i>-1?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+i,(l=r._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,n):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,(h=r._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n);var d=r.type!==void 0?this._getWebGLTextureType(r.type):c.UNSIGNED_BYTE;if(s)o||(o=Ev(r.type,4*e*t));else switch(d){case c.UNSIGNED_BYTE:o||(o=new Uint8Array(4*e*t)),d=c.UNSIGNED_BYTE;break;default:o||(o=new Float32Array(4*e*t)),d=c.FLOAT;break}return a&&this.flushFramebuffer(),c.readPixels(f,u,e,t,c.RGBA,d,o),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),o};me.prototype._readTexturePixels=function(r,e,t,i,n,o,a,s,f,u){return i===void 0&&(i=-1),n===void 0&&(n=0),o===void 0&&(o=null),a===void 0&&(a=!0),s===void 0&&(s=!1),f===void 0&&(f=0),u===void 0&&(u=0),Promise.resolve(this._readTexturePixelsSync(r,e,t,i,n,o,a,s,f,u))};v();me.prototype.updateDynamicIndexBuffer=function(r,e,t){t===void 0&&(t=0),this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(r);var i;r.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};me.prototype.updateDynamicVertexBuffer=function(r,e,t,i){this.bindArrayBuffer(r),t===void 0&&(t=0);var n=e.byteLength||e.length;i===void 0||i>=n&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};var Re=function(r){Y(e,r);function e(t,i,n,o){o===void 0&&(o=!1);var a=r.call(this,t,i,n,o)||this;if(a.enableOfflineSupport=!1,a.disableManifestCheck=!1,a.disableContextMenu=!0,a.scenes=new Array,a._virtualScenes=new Array,a.onNewSceneAddedObservable=new U,a.postProcesses=new Array,a.isPointerLock=!1,a.onResizeObservable=new U,a.onCanvasBlurObservable=new U,a.onCanvasFocusObservable=new U,a.onCanvasPointerOutObservable=new U,a.onBeginFrameObservable=new U,a.customAnimationFrameRequester=null,a.onEndFrameObservable=new U,a.onBeforeShaderCompilationObservable=new U,a.onAfterShaderCompilationObservable=new U,a._deterministicLockstep=!1,a._lockstepMaxSteps=4,a._timeStep=1/60,a._fps=60,a._deltaTime=0,a._drawCalls=new Fr,a.canvasTabIndex=1,a.disablePerformanceMonitorInBackground=!1,a._performanceMonitor=new Rh,a._compatibilityMode=!0,a.currentRenderPassId=0,a._renderPassNames=["main"],e.Instances.push(a),!t)return a;if(a._features.supportRenderPasses=!0,n=a._creationOptions,t.getContext){var s=t;if(a._sharedInit(s,!!n.doNotHandleTouchAction,n.audioEngine),Me()){var f=document;a._onFullscreenChange=function(){f.fullscreen!==void 0?a.isFullscreen=f.fullscreen:f.mozFullScreen!==void 0?a.isFullscreen=f.mozFullScreen:f.webkitIsFullScreen!==void 0?a.isFullscreen=f.webkitIsFullScreen:f.msIsFullScreen!==void 0&&(a.isFullscreen=f.msIsFullScreen),a.isFullscreen&&a._pointerLockRequested&&s&&e._RequestPointerlock(s)},document.addEventListener("fullscreenchange",a._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",a._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",a._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",a._onFullscreenChange,!1),a._onPointerLockChange=function(){a.isPointerLock=f.mozPointerLockElement===s||f.webkitPointerLockElement===s||f.msPointerLockElement===s||f.pointerLockElement===s},document.addEventListener("pointerlockchange",a._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",a._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",a._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",a._onPointerLockChange,!1),!e.audioEngine&&n.audioEngine&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(a.getRenderingCanvas(),a.getAudioContext(),a.getAudioDestination()))}a._connectVREvents(),a.enableOfflineSupport=e.OfflineProviderFactory!==void 0,a._deterministicLockstep=!!n.deterministicLockstep,a._lockstepMaxSteps=n.lockstepMaxSteps||0,a._timeStep=n.timeStep||1/60}return a._prepareVRComponent(),n.autoEnableWebVR&&a.initWebVR(),a}return Object.defineProperty(e,"NpmPackage",{get:function(){return me.NpmPackage},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return me.Version},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Instances",{get:function(){return le.Instances},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedEngine",{get:function(){return le.LastCreatedEngine},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return le.LastCreatedScene},enumerable:!1,configurable:!0}),e.prototype._createImageBitmapFromSource=function(t,i){var n=this,o=new Promise(function(a,s){var f=new Image;f.onload=function(){f.decode().then(function(){n.createImageBitmap(f,i).then(function(u){a(u)})})},f.onerror=function(){s("Error loading image ".concat(f.src))},f.src=t});return o},e.prototype.createImageBitmap=function(t,i){return createImageBitmap(t,i)},e.prototype.resizeImageBitmap=function(t,i,n){var o=this.createCanvas(i,n),a=o.getContext("2d");if(!a)throw new Error("Unable to get 2d context for resizeImageBitmap");a.drawImage(t,0,0);var s=a.getImageData(0,0,i,n).data;return s},e.MarkAllMaterialsAsDirty=function(t,i){for(var n=0;n<e.Instances.length;n++)for(var o=e.Instances[n],a=0;a<o.scenes.length;a++)o.scenes[a].markAllMaterialsAsDirty(t,i)},e.DefaultLoadingScreenFactory=function(t){throw Q("LoadingScreen")},Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!!e._RescalePostProcessFactory},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(t){this._compatibilityMode=!0},enumerable:!1,configurable:!0}),e.prototype.getInputElement=function(){return this._renderingCanvas},e.prototype._sharedInit=function(t,i,n){var o=this;if(r.prototype._sharedInit.call(this,t,i,n),this._onCanvasFocus=function(){o.onCanvasFocusObservable.notifyObservers(o)},this._onCanvasBlur=function(){o.onCanvasBlurObservable.notifyObservers(o)},this._onCanvasContextMenu=function(s){o.disableContextMenu&&s.preventDefault()},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),t.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.disable(),o._windowIsBackground=!0},this._onFocus=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.enable(),o._windowIsBackground=!1},this._onCanvasPointerOut=function(s){document.elementFromPoint(s.clientX,s.clientY)!==t&&o.onCanvasPointerOutObservable.notifyObservers(s)},Me()){var a=this.getHostWindow();a&&(a.addEventListener("blur",this._onBlur),a.addEventListener("focus",this._onFocus))}t.addEventListener("pointerout",this._onCanvasPointerOut),i||this._disableTouchAction(),!e.audioEngine&&n&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))},e.prototype.getAspectRatio=function(t,i){i===void 0&&(i=!1);var n=t.viewport;return this.getRenderWidth(i)*n.width/(this.getRenderHeight(i)*n.height)},e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},e.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},e.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},e.prototype.getTimeStep=function(){return this._timeStep*1e3},e.prototype.generateMipMapsForCubemap=function(t,i){if(i===void 0&&(i=!0),t.generateMipMaps){var n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,t,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}},e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},e.prototype.setDitheringState=function(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},e.prototype.setRasterizerState=function(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},e.prototype.setDirectViewport=function(t,i,n,o){var a=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,i,n,o),a},e.prototype.scissorClear=function(t,i,n,o,a){this.enableScissor(t,i,n,o),this.clear(a,!0,!0,!0),this.disableScissor()},e.prototype.enableScissor=function(t,i,n,o){var a=this._gl;a.enable(a.SCISSOR_TEST),a.scissor(t,i,n,o)},e.prototype.disableScissor=function(){var t=this._gl;t.disable(t.SCISSOR_TEST)},e.prototype._reportDrawCall=function(t){t===void 0&&(t=1),this._drawCalls.addCount(t,!1)},e.prototype.initWebVR=function(){throw Q("WebVRCamera")},e.prototype._prepareVRComponent=function(){},e.prototype._connectVREvents=function(t,i){},e.prototype._submitVRFrame=function(){},e.prototype.disableVR=function(){},e.prototype.isVRPresenting=function(){return!1},e.prototype._requestVRFrame=function(){},e.prototype._loadFileAsync=function(t,i,n){var o=this;return new Promise(function(a,s){o._loadFile(t,function(f){a(f)},void 0,i,n,function(f,u){s(u)})})},e.prototype.getVertexShaderSource=function(t){var i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[0]):null},e.prototype.getFragmentShaderSource=function(t){var i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[1]):null},e.prototype.setDepthStencilTexture=function(t,i,n,o){t!==void 0&&(i&&(this._boundUniforms[t]=i),!n||!n.depthStencilTexture?this._setTexture(t,null,void 0,void 0,o):this._setTexture(t,n,!1,!0,o))},e.prototype.setTextureFromPostProcess=function(t,i,n){var o,a=null;i&&(i._textures.data[i._currentRenderTextureInd]?a=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(a=i._forcedOutputTexture)),this._bindTexture(t,(o=a==null?void 0:a.texture)!==null&&o!==void 0?o:null,n)},e.prototype.setTextureFromPostProcessOutput=function(t,i,n){var o,a;this._bindTexture(t,(a=(o=i==null?void 0:i._outputTexture)===null||o===void 0?void 0:o.texture)!==null&&a!==void 0?a:null,n)},e.prototype._rebuildBuffers=function(){for(var t=0,i=this.scenes;t<i.length;t++){var n=i[t];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}for(var o=0,a=this._virtualScenes;o<a.length;o++){var n=a[o];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}r.prototype._rebuildBuffers.call(this)},e.prototype._renderFrame=function(){for(var t=0;t<this._activeRenderLoops.length;t++){var i=this._activeRenderLoops[t];i()}},e.prototype._renderLoop=function(){if(!this._contextWasLost){var t=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype._renderViews=function(){return!1},e.prototype.switchFullscreen=function(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)},e.prototype.enterFullscreen=function(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&e._RequestFullscreen(this._renderingCanvas))},e.prototype.exitFullscreen=function(){this.isFullscreen&&e._ExitFullscreen()},e.prototype.enterPointerlock=function(){this._renderingCanvas&&e._RequestPointerlock(this._renderingCanvas)},e.prototype.exitPointerlock=function(){e._ExitPointerlock()},e.prototype.beginFrame=function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),r.prototype.beginFrame.call(this)},e.prototype.endFrame=function(){r.prototype.endFrame.call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)},e.prototype.resize=function(t){t===void 0&&(t=!1),!this.isVRPresenting()&&r.prototype.resize.call(this,t)},e.prototype.setSize=function(t,i,n){if(n===void 0&&(n=!1),!this._renderingCanvas||!r.prototype.setSize.call(this,t,i,n))return!1;if(this.scenes){for(var o=0;o<this.scenes.length;o++)for(var a=this.scenes[o],s=0;s<a.cameras.length;s++){var f=a.cameras[s];f._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0},e.prototype._deletePipelineContext=function(t){var i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),r.prototype._deletePipelineContext.call(this,t)},e.prototype.createShaderProgram=function(t,i,n,o,a,s){s===void 0&&(s=null),a=a||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var f=r.prototype.createShaderProgram.call(this,t,i,n,o,a,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),f},e.prototype._createShaderProgram=function(t,i,n,o,a){a===void 0&&(a=null);var s=o.createProgram();if(t.program=s,!s)throw new Error("Unable to create program");if(o.attachShader(s,i),o.attachShader(s,n),this.webGLVersion>1&&a){var f=this.createTransformFeedback();this.bindTransformFeedback(f),this.setTranformFeedbackVaryings(s,a),t.transformFeedback=f}return o.linkProgram(s),this.webGLVersion>1&&a&&this.bindTransformFeedback(null),t.context=o,t.vertexShader=i,t.fragmentShader=n,t.isParallelCompiled||this._finalizePipelineContext(t),s},e.prototype._releaseTexture=function(t){r.prototype._releaseTexture.call(this,t)},e.prototype._releaseRenderTargetWrapper=function(t){r.prototype._releaseRenderTargetWrapper.call(this,t),this.scenes.forEach(function(i){i.postProcesses.forEach(function(n){n._outputTexture===t&&(n._outputTexture=null)}),i.cameras.forEach(function(n){n._postProcesses.forEach(function(o){o&&o._outputTexture===t&&(o._outputTexture=null)})})})},e.prototype.getRenderPassNames=function(){return this._renderPassNames},e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},e.prototype.createRenderPassId=function(t){var i=++e._RenderPassIdCounter;return this._renderPassNames[i]=t!=null?t:"NONAME",i},e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(var i=0;i<this.scenes.length;++i)for(var n=this.scenes[i],o=0;o<n.meshes.length;++o){var a=n.meshes[o];if(a.subMeshes)for(var s=0;s<a.subMeshes.length;++s){var f=a.subMeshes[s];f._removeDrawWrapper(t)}}},e.prototype._rescaleTexture=function(t,i,n,o,a){var s=this;this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);var f=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&e._RescalePostProcessFactory&&(this._rescalePostProcess=e._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(function(){s._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",t)};var u=n;u||(u=s.scenes[s.scenes.length-1]),u.postProcessManager.directRender([s._rescalePostProcess],f,!0),s._bindTextureDirectly(s._gl.TEXTURE_2D,i,!0),s._gl.copyTexImage2D(s._gl.TEXTURE_2D,0,o,0,0,i.width,i.height,0),s.unBindFramebuffer(f),f.dispose(),a&&a()})},e.prototype.getFps=function(){return this._fps},e.prototype.getDeltaTime=function(){return this._deltaTime},e.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},e.prototype.wrapWebGLTexture=function(t){var i=new Ln(t,this._gl),n=new zt(this,Le.Unknown,!0);return n._hardwareTexture=i,n.isReady=!0,n},e.prototype._uploadImageToTexture=function(t,i,n,o){n===void 0&&(n=0),o===void 0&&(o=0);var a=this._gl,s=this._getWebGLTextureType(t.type),f=this._getInternalFormat(t.format),u=this._getRGBABufferInternalSizedFormat(t.type,f),l=t.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(l,t,!0),this._unpackFlipY(t.invertY);var h=a.TEXTURE_2D;t.isCube&&(h=a.TEXTURE_CUBE_MAP_POSITIVE_X+n),a.texImage2D(h,o,u,f,s,i),this._bindTextureDirectly(l,null,!0)},e.prototype.updateTextureComparisonFunction=function(t,i){if(this.webGLVersion===1){q.Error("WebGL 1 does not support texture comparison.");return}var n=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),i===0?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),i===0?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=i},e.prototype.createInstancesBuffer=function(t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");var n=new dr(i);return n.capacity=t,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),n.references=1,n},e.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},e.prototype._clientWaitAsync=function(t,i,n){i===void 0&&(i=0),n===void 0&&(n=10);var o=this._gl;return new Promise(function(a,s){var f=function(){var u=o.clientWaitSync(t,i,0);if(u==o.WAIT_FAILED){s();return}if(u==o.TIMEOUT_EXPIRED){setTimeout(f,n);return}a()};f()})},e.prototype._readPixelsAsync=function(t,i,n,o,a,s,f){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var u=this._gl,l=u.createBuffer();u.bindBuffer(u.PIXEL_PACK_BUFFER,l),u.bufferData(u.PIXEL_PACK_BUFFER,f.byteLength,u.STREAM_READ),u.readPixels(t,i,n,o,a,s,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null);var h=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(u.flush(),this._clientWaitAsync(h,0,10).then(function(){return u.deleteSync(h),u.bindBuffer(u.PIXEL_PACK_BUFFER,l),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,f),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.deleteBuffer(l),f})):null},e.prototype.dispose=function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();e.Instances.length===1&&e.audioEngine&&(e.audioEngine.dispose(),e.audioEngine=null),this.disableVR(),Me()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),ni()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),r.prototype.dispose.call(this);var t=e.Instances.indexOf(this);t>=0&&e.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()},e.prototype._disableTouchAction=function(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.msTouchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")},e.prototype.displayLoadingUI=function(){if(!!Me()){var t=this.loadingScreen;t&&t.displayLoadingUI()}},e.prototype.hideLoadingUI=function(){if(!!Me()){var t=this._loadingScreen;t&&t.hideLoadingUI()}},Object.defineProperty(e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!1,configurable:!0}),e.prototype.createVideoElement=function(t){return document.createElement("video")},e._RequestPointerlock=function(t){t.requestPointerLock=t.requestPointerLock||t.msRequestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock&&(t.requestPointerLock(),t.focus())},e._ExitPointerlock=function(){var t=document;document.exitPointerLock=document.exitPointerLock||t.msExitPointerLock||t.mozExitPointerLock||t.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock()},e._RequestFullscreen=function(t){var i=t.requestFullscreen||t.msRequestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen;!i||i.call(t)},e._ExitFullscreen=function(){var t=document;document.exitFullscreen?document.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.msCancelFullScreen&&t.msCancelFullScreen()},e.prototype.getFontOffset=function(t){var i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style","font: ".concat(t," !important"));var n=document.createElement("div");n.style.display="inline-block",n.style.width="1px",n.style.height="0px",n.style.verticalAlign="bottom";var o=document.createElement("div");o.style.whiteSpace="nowrap",o.appendChild(i),o.appendChild(n),document.body.appendChild(o);var a=0,s=0;try{s=n.getBoundingClientRect().top-i.getBoundingClientRect().top,n.style.verticalAlign="baseline",a=n.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(o)}return{ascent:a,height:s,descent:s-a}},e.ALPHA_DISABLE=0,e.ALPHA_ADD=1,e.ALPHA_COMBINE=2,e.ALPHA_SUBTRACT=3,e.ALPHA_MULTIPLY=4,e.ALPHA_MAXIMIZED=5,e.ALPHA_ONEONE=6,e.ALPHA_PREMULTIPLIED=7,e.ALPHA_PREMULTIPLIED_PORTERDUFF=8,e.ALPHA_INTERPOLATE=9,e.ALPHA_SCREENMODE=10,e.DELAYLOADSTATE_NONE=0,e.DELAYLOADSTATE_LOADED=1,e.DELAYLOADSTATE_LOADING=2,e.DELAYLOADSTATE_NOTLOADED=4,e.NEVER=512,e.ALWAYS=519,e.LESS=513,e.EQUAL=514,e.LEQUAL=515,e.GREATER=516,e.GEQUAL=518,e.NOTEQUAL=517,e.KEEP=7680,e.REPLACE=7681,e.INCR=7682,e.DECR=7683,e.INVERT=5386,e.INCR_WRAP=34055,e.DECR_WRAP=34056,e.TEXTURE_CLAMP_ADDRESSMODE=0,e.TEXTURE_WRAP_ADDRESSMODE=1,e.TEXTURE_MIRROR_ADDRESSMODE=2,e.TEXTUREFORMAT_ALPHA=0,e.TEXTUREFORMAT_LUMINANCE=1,e.TEXTUREFORMAT_LUMINANCE_ALPHA=2,e.TEXTUREFORMAT_RGB=4,e.TEXTUREFORMAT_RGBA=5,e.TEXTUREFORMAT_RED=6,e.TEXTUREFORMAT_R=6,e.TEXTUREFORMAT_RG=7,e.TEXTUREFORMAT_RED_INTEGER=8,e.TEXTUREFORMAT_R_INTEGER=8,e.TEXTUREFORMAT_RG_INTEGER=9,e.TEXTUREFORMAT_RGB_INTEGER=10,e.TEXTUREFORMAT_RGBA_INTEGER=11,e.TEXTURETYPE_UNSIGNED_BYTE=0,e.TEXTURETYPE_UNSIGNED_INT=0,e.TEXTURETYPE_FLOAT=1,e.TEXTURETYPE_HALF_FLOAT=2,e.TEXTURETYPE_BYTE=3,e.TEXTURETYPE_SHORT=4,e.TEXTURETYPE_UNSIGNED_SHORT=5,e.TEXTURETYPE_INT=6,e.TEXTURETYPE_UNSIGNED_INTEGER=7,e.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,e.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,e.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,e.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,e.TEXTURETYPE_UNSIGNED_INT_24_8=12,e.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,e.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,e.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,e.TEXTURE_NEAREST_SAMPLINGMODE=1,e.TEXTURE_BILINEAR_SAMPLINGMODE=2,e.TEXTURE_TRILINEAR_SAMPLINGMODE=3,e.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,e.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,e.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,e.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,e.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,e.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,e.TEXTURE_NEAREST_LINEAR=7,e.TEXTURE_NEAREST_NEAREST=1,e.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,e.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,e.TEXTURE_LINEAR_LINEAR=2,e.TEXTURE_LINEAR_NEAREST=12,e.TEXTURE_EXPLICIT_MODE=0,e.TEXTURE_SPHERICAL_MODE=1,e.TEXTURE_PLANAR_MODE=2,e.TEXTURE_CUBIC_MODE=3,e.TEXTURE_PROJECTION_MODE=4,e.TEXTURE_SKYBOX_MODE=5,e.TEXTURE_INVCUBIC_MODE=6,e.TEXTURE_EQUIRECTANGULAR_MODE=7,e.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,e.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.SCALEMODE_FLOOR=1,e.SCALEMODE_NEAREST=2,e.SCALEMODE_CEILING=3,e._RescalePostProcessFactory=null,e._RenderPassIdCounter=0,e}(me);v();v();var jt;(function(r){r[r.LOCAL=0]="LOCAL",r[r.WORLD=1]="WORLD",r[r.BONE=2]="BONE"})(jt||(jt={}));var zi=function(){function r(){}return r.X=new E(1,0,0),r.Y=new E(0,1,0),r.Z=new E(0,0,1),r}();var _r;(function(r){r[r.X=0]="X",r[r.Y=1]="Y",r[r.Z=2]="Z"})(_r||(_r={}));var rt=function(r){Y(e,r);function e(t,i,n){i===void 0&&(i=null),n===void 0&&(n=!0);var o=r.call(this,t,i)||this;return o._forward=new E(0,0,1),o._up=new E(0,1,0),o._right=new E(1,0,0),o._position=E.Zero(),o._rotation=E.Zero(),o._rotationQuaternion=null,o._scaling=E.One(),o._transformToBoneReferal=null,o._isAbsoluteSynced=!1,o._billboardMode=e.BILLBOARDMODE_NONE,o._preserveParentRotationForBillboard=!1,o.scalingDeterminant=1,o._infiniteDistance=!1,o.ignoreNonUniformScaling=!1,o.reIntegrateRotationIntoRotationQuaternion=!1,o._poseMatrix=null,o._localMatrix=B.Zero(),o._usePivotMatrix=!1,o._absolutePosition=E.Zero(),o._absoluteScaling=E.Zero(),o._absoluteRotationQuaternion=ie.Identity(),o._pivotMatrix=B.Identity(),o._postMultiplyPivotMatrix=!1,o._isWorldMatrixFrozen=!1,o._indexInSceneTransformNodesArray=-1,o.onAfterWorldMatrixUpdateObservable=new U,o._nonUniformScaling=!1,n&&o.getScene().addTransformNode(o),o}return Object.defineProperty(e.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(t){this._billboardMode!==t&&(this._billboardMode=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"preserveParentRotationForBillboard",{get:function(){return this._preserveParentRotationForBillboard},set:function(t){t!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"infiniteDistance",{get:function(){return this._infiniteDistance},set:function(t){this._infiniteDistance!==t&&(this._infiniteDistance=t)},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"TransformNode"},Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._isDirty=!0},enumerable:!1,configurable:!0}),e.prototype.isUsingPivotMatrix=function(){return this._usePivotMatrix},Object.defineProperty(e.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation=t,this._rotationQuaternion=null,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaling",{get:function(){return this._scaling},set:function(t){this._scaling=t,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(t){this._rotationQuaternion=t,t&&this._rotation.setAll(0),this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forward",{get:function(){return E.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"up",{get:function(){return E.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"right",{get:function(){return E.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()},enumerable:!1,configurable:!0}),e.prototype.updatePoseMatrix=function(t){return this._poseMatrix?(this._poseMatrix.copyFrom(t),this):(this._poseMatrix=t.clone(),this)},e.prototype.getPoseMatrix=function(){return this._poseMatrix||(this._poseMatrix=B.Identity()),this._poseMatrix},e.prototype._isSynchronized=function(){var t=this._cache;return!(this._billboardMode!==t.billboardMode||this._billboardMode!==e.BILLBOARDMODE_NONE||t.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)},e.prototype._initCache=function(){r.prototype._initCache.call(this);var t=this._cache;t.localMatrixUpdated=!1,t.billboardMode=-1,t.infiniteDistance=!1},Object.defineProperty(e.prototype,"absolutePosition",{get:function(){return this.getAbsolutePosition()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"absoluteScaling",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"absoluteRotationQuaternion",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion},enumerable:!1,configurable:!0}),e.prototype.setPreTransformMatrix=function(t){return this.setPivotMatrix(t,!1)},e.prototype.setPivotMatrix=function(t,i){return i===void 0&&(i=!0),this._pivotMatrix.copyFrom(t),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=i,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=B.Invert(this._pivotMatrix)),this},e.prototype.getPivotMatrix=function(){return this._pivotMatrix},e.prototype.instantiateHierarchy=function(t,i,n){t===void 0&&(t=null);var o=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);o&&n&&n(this,o);for(var a=0,s=this.getChildTransformNodes(!0);a<s.length;a++){var f=s[a];f.instantiateHierarchy(o,i,n)}return o},e.prototype.freezeWorldMatrix=function(t,i){return t===void 0&&(t=null),i===void 0&&(i=!1),t?i?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||ie.Identity(),t.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=t,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this},e.prototype.unfreezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this},Object.defineProperty(e.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!1,configurable:!0}),e.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},e.prototype.setAbsolutePosition=function(t){if(!t)return this;var i,n,o;if(t.x===void 0){if(arguments.length<3)return this;i=arguments[0],n=arguments[1],o=arguments[2]}else i=t.x,n=t.y,o=t.z;if(this.parent){var a=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(a),E.TransformCoordinatesFromFloatsToRef(i,n,o,a,this.position)}else this.position.x=i,this.position.y=n,this.position.z=o;return this._absolutePosition.copyFrom(t),this},e.prototype.setPositionWithLocalVector=function(t){return this.computeWorldMatrix(),this.position=E.TransformNormal(t,this._localMatrix),this},e.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=L.Matrix[0];return this._localMatrix.invertToRef(t),E.TransformNormal(this.position,t)},e.prototype.locallyTranslate=function(t){return this.computeWorldMatrix(!0),this.position=E.TransformCoordinates(t,this._localMatrix),this},e.prototype.lookAt=function(t,i,n,o,a){i===void 0&&(i=0),n===void 0&&(n=0),o===void 0&&(o=0),a===void 0&&(a=jt.LOCAL);var s=e._LookAtVectorCache,f=a===jt.LOCAL?this.position:this.getAbsolutePosition();if(t.subtractToRef(f,s),this.setDirection(s,i,n,o),a===jt.WORLD&&this.parent)if(this.rotationQuaternion){var u=L.Matrix[0];this.rotationQuaternion.toRotationMatrix(u);var l=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),u.multiplyToRef(l,u),this.rotationQuaternion.fromRotationMatrix(u)}else{var h=L.Quaternion[0];ie.FromEulerVectorToRef(this.rotation,h);var u=L.Matrix[0];h.toRotationMatrix(u);var l=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),u.multiplyToRef(l,u),h.fromRotationMatrix(u),h.toEulerAnglesToRef(this.rotation)}return this},e.prototype.getDirection=function(t){var i=E.Zero();return this.getDirectionToRef(t,i),i},e.prototype.getDirectionToRef=function(t,i){return E.TransformNormalToRef(t,this.getWorldMatrix(),i),this},e.prototype.setDirection=function(t,i,n,o){i===void 0&&(i=0),n===void 0&&(n=0),o===void 0&&(o=0);var a=-Math.atan2(t.z,t.x)+Math.PI/2,s=Math.sqrt(t.x*t.x+t.z*t.z),f=-Math.atan2(t.y,s);return this.rotationQuaternion?ie.RotationYawPitchRollToRef(a+i,f+n,o,this.rotationQuaternion):(this.rotation.x=f+n,this.rotation.y=a+i,this.rotation.z=o),this},e.prototype.setPivotPoint=function(t,i){i===void 0&&(i=jt.LOCAL),this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);var n=this.getWorldMatrix();if(i==jt.WORLD){var o=L.Matrix[0];n.invertToRef(o),t=E.TransformCoordinates(t,o)}return this.setPivotMatrix(B.Translation(-t.x,-t.y,-t.z),!0)},e.prototype.getPivotPoint=function(){var t=E.Zero();return this.getPivotPointToRef(t),t},e.prototype.getPivotPointToRef=function(t){return t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14],this},e.prototype.getAbsolutePivotPoint=function(){var t=E.Zero();return this.getAbsolutePivotPointToRef(t),t},e.prototype.getAbsolutePivotPointToRef=function(t){return this.getPivotPointToRef(t),E.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this},e.prototype.markAsDirty=function(t){if(this._children)for(var i=0,n=this._children;i<n.length;i++){var o=n[i];o.markAsDirty(t)}return r.prototype.markAsDirty.call(this,t)},e.prototype.setParent=function(t,i){if(i===void 0&&(i=!1),!t&&!this.parent)return this;var n=L.Quaternion[0],o=L.Vector3[0],a=L.Vector3[1],s=L.Matrix[1];B.IdentityToRef(s);var f=L.Matrix[0];this.computeWorldMatrix(!0);var u=this.rotationQuaternion;return u||(u=e._TmpRotation,ie.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,u)),B.ComposeToRef(this.scaling,u,this.position,f),this.parent&&f.multiplyToRef(this.parent.computeWorldMatrix(!0),f),t&&(t.computeWorldMatrix(!0).invertToRef(s),f.multiplyToRef(s,f)),f.decompose(a,n,o,i?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(o),this.parent=t,this},Object.defineProperty(e.prototype,"nonUniformScaling",{get:function(){return this._nonUniformScaling},enumerable:!1,configurable:!0}),e.prototype._updateNonUniformScalingState=function(t){return this._nonUniformScaling===t?!1:(this._nonUniformScaling=t,!0)},e.prototype.attachToBone=function(t,i){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=i,this.parent=t,t.getSkeleton().prepare(),t.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this},e.prototype.detachFromBone=function(t){return t===void 0&&(t=!1),this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,t?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(t&&(this.parent=this._currentParentWhenAttachingToBone),this)},e.prototype.rotate=function(t,i,n){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));var o;if(!n||n===jt.LOCAL)o=ie.RotationAxisToRef(t,i,e._RotationAxisCache),this.rotationQuaternion.multiplyToRef(o,this.rotationQuaternion);else{if(this.parent){var a=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(a),t=E.TransformNormal(t,a)}o=ie.RotationAxisToRef(t,i,e._RotationAxisCache),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this},e.prototype.rotateAround=function(t,i,n){i.normalize(),this.rotationQuaternion||(this.rotationQuaternion=ie.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));var o=L.Vector3[0],a=L.Vector3[1],s=L.Vector3[2],f=L.Quaternion[0],u=L.Matrix[0],l=L.Matrix[1],h=L.Matrix[2],c=L.Matrix[3];return t.subtractToRef(this.position,o),B.TranslationToRef(o.x,o.y,o.z,u),B.TranslationToRef(-o.x,-o.y,-o.z,l),B.RotationAxisToRef(i,n,h),l.multiplyToRef(h,c),c.multiplyToRef(u,c),c.decompose(a,f,s),this.position.addInPlace(s),f.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this},e.prototype.translate=function(t,i,n){var o=t.scale(i);if(!n||n===jt.LOCAL){var a=this.getPositionExpressedInLocalSpace().add(o);this.setPositionWithLocalVector(a)}else this.setAbsolutePosition(this.getAbsolutePosition().add(o));return this},e.prototype.addRotation=function(t,i,n){var o;this.rotationQuaternion?o=this.rotationQuaternion:(o=L.Quaternion[1],ie.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,o));var a=L.Quaternion[0];return ie.RotationYawPitchRollToRef(i,t,n,a),o.multiplyInPlace(a),this.rotationQuaternion||o.toEulerAnglesToRef(this.rotation),this},e.prototype._getEffectiveParent=function(){return this.parent},e.prototype.computeWorldMatrix=function(t){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;var i=this.getScene().getRenderId();if(!this._isDirty&&!t&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;var n=this.getScene().activeCamera,o=(this._billboardMode&e.BILLBOARDMODE_USE_POSITION)!==0,a=this._billboardMode!==e.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();var s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;var f=this._getEffectiveParent(),u=e._TmpScaling,l=this._position;if(this._infiniteDistance&&!this.parent&&n){var h=n.getWorldMatrix(),c=new E(h.m[12],h.m[13],h.m[14]);l=e._TmpTranslation,l.copyFromFloats(this._position.x+c.x,this._position.y+c.y,this._position.z+c.z)}u.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);var p;if(this._rotationQuaternion){if(this._rotationQuaternion._isDirty=!1,p=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion){var d=this.rotation.lengthSquared();d&&(this._rotationQuaternion.multiplyInPlace(ie.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))}}else p=e._TmpRotation,ie.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,p);if(this._usePivotMatrix){var m=L.Matrix[1];B.ScalingToRef(u.x,u.y,u.z,m);var _=L.Matrix[0];p.toRotationMatrix(_),this._pivotMatrix.multiplyToRef(m,L.Matrix[4]),L.Matrix[4].multiplyToRef(_,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(l.x,l.y,l.z)}else B.ComposeToRef(u,p,l,this._localMatrix);if(f&&f.getWorldMatrix){if(t&&f.computeWorldMatrix(t),a){this._transformToBoneReferal?f.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),L.Matrix[7]):L.Matrix[7].copyFrom(f.getWorldMatrix());var y=L.Vector3[5],g=L.Vector3[6];L.Matrix[7].decompose(g,void 0,y),B.ScalingToRef(g.x,g.y,g.z,L.Matrix[7]),L.Matrix[7].setTranslation(y),this._localMatrix.multiplyToRef(L.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(f.getWorldMatrix(),L.Matrix[6]),L.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(f.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(a&&n&&this.billboardMode&&!o){var T=L.Vector3[0];if(this._worldMatrix.getTranslationToRef(T),L.Matrix[1].copyFrom(n.getViewMatrix()),L.Matrix[1].setTranslationFromFloats(0,0,0),L.Matrix[1].invertToRef(L.Matrix[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){L.Matrix[0].decompose(void 0,L.Quaternion[0],void 0);var A=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(A),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(A.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(A.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(A.z=0),B.RotationYawPitchRollToRef(A.y,A.x,A.z,L.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}else if(a&&n&&this.billboardMode&&o){var T=L.Vector3[0];this._worldMatrix.getTranslationToRef(T);var M=n.globalPosition;this._worldMatrix.invertToRef(L.Matrix[1]);var C=L.Vector3[1];E.TransformCoordinatesToRef(M,L.Matrix[1],C),C.normalize();var P=-Math.atan2(C.z,C.x)+Math.PI/2,d=Math.sqrt(C.x*C.x+C.z*C.z),R=-Math.atan2(C.y,d);if(ie.RotationYawPitchRollToRef(P,R,0,L.Quaternion[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){var A=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(A),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(A.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(A.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(A.z=0),B.RotationYawPitchRollToRef(A.y,A.x,A.z,L.Matrix[0])}else B.FromQuaternionToRef(L.Quaternion[0],L.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):f&&f._nonUniformScaling?this._updateNonUniformScalingState(f._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=B.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix},e.prototype.resetLocalMatrix=function(t){if(t===void 0&&(t=!0),this.computeWorldMatrix(),t)for(var i=this.getChildren(),n=0;n<i.length;++n){var o=i[n];if(o){o.computeWorldMatrix();var a=L.Matrix[0];o._localMatrix.multiplyToRef(this._localMatrix,a);var s=L.Quaternion[0];a.decompose(o.scaling,s,o.position),o.rotationQuaternion?o.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(o.rotation)}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=ie.Identity()),this._worldMatrix=B.Identity()},e.prototype._afterComputeWorldMatrix=function(){},e.prototype.registerAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this},e.prototype.unregisterAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this},e.prototype.getPositionInCameraSpace=function(t){return t===void 0&&(t=null),t||(t=this.getScene().activeCamera),E.TransformCoordinates(this.getAbsolutePosition(),t.getViewMatrix())},e.prototype.getDistanceToCamera=function(t){return t===void 0&&(t=null),t||(t=this.getScene().activeCamera),this.getAbsolutePosition().subtract(t.globalPosition).length()},e.prototype.clone=function(t,i,n){var o=this,a=te.Clone(function(){return new e(t,o.getScene())},this);if(a.name=t,a.id=t,i&&(a.parent=i),!n)for(var s=this.getDescendants(!0),f=0;f<s.length;f++){var u=s[f];u.clone&&u.clone(t+"."+u.name,a)}return a},e.prototype.serialize=function(t){var i=te.Serialize(this,t);return i.type=this.getClassName(),i.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(i),i.localMatrix=this.getPivotMatrix().asArray(),i.isEnabled=this.isEnabled(),i},e.Parse=function(t,i,n){var o=te.Parse(function(){return new e(t.name,i)},t,i,n);return t.localMatrix?o.setPreTransformMatrix(B.FromArray(t.localMatrix)):t.pivotMatrix&&o.setPivotMatrix(B.FromArray(t.pivotMatrix)),o.setEnabled(t.isEnabled),o._waitingParsedUniqueId=t.uniqueId,t.parentId!==void 0&&(o._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=t.parentInstanceIndex),o},e.prototype.getChildTransformNodes=function(t,i){var n=[];return this._getDescendants(n,t,function(o){return(!i||i(o))&&o instanceof e}),n},e.prototype.dispose=function(t,i){if(i===void 0&&(i=!1),this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){var n=this._parentContainer.transformNodes.indexOf(this);n>-1&&this._parentContainer.transformNodes.splice(n,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),t)for(var o=this.getChildTransformNodes(!0),a=0,s=o;a<s.length;a++){var f=s[a];f.parent=null,f.computeWorldMatrix(!0)}r.prototype.dispose.call(this,t,i)},e.prototype.normalizeToUnitCube=function(t,i,n){t===void 0&&(t=!0),i===void 0&&(i=!1);var o=null,a=null;i&&(this.rotationQuaternion?(a=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(o=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));var s=this.getHierarchyBoundingVectors(t,n),f=s.max.subtract(s.min),u=Math.max(f.x,f.y,f.z);if(u===0)return this;var l=1/u;return this.scaling.scaleInPlace(l),i&&(this.rotationQuaternion&&a?this.rotationQuaternion.copyFrom(a):this.rotation&&o&&this.rotation.copyFrom(o)),this},e.prototype._syncAbsoluteScalingAndRotation=function(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)},e.BILLBOARDMODE_NONE=0,e.BILLBOARDMODE_X=1,e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_Z=4,e.BILLBOARDMODE_ALL=7,e.BILLBOARDMODE_USE_POSITION=128,e._TmpRotation=ie.Zero(),e._TmpScaling=E.Zero(),e._TmpTranslation=E.Zero(),e._LookAtVectorCache=new E(0,0,0),e._RotationAxisCache=new ie,x([At("position")],e.prototype,"_position",void 0),x([At("rotation")],e.prototype,"_rotation",void 0),x([Th("rotationQuaternion")],e.prototype,"_rotationQuaternion",void 0),x([At("scaling")],e.prototype,"_scaling",void 0),x([O("billboardMode")],e.prototype,"_billboardMode",void 0),x([O()],e.prototype,"scalingDeterminant",void 0),x([O("infiniteDistance")],e.prototype,"_infiniteDistance",void 0),x([O()],e.prototype,"ignoreNonUniformScaling",void 0),x([O()],e.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0),e}(gt);v();var bt=function(){function r(){this._pickingUnavailable=!1,this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}return r.prototype.getNormal=function(e,t){if(e===void 0&&(e=!1),t===void 0&&(t=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(b.NormalKind))return null;var i=this.pickedMesh.getIndices();if(!i)return null;var n;if(t){var o=this.pickedMesh.getVerticesData(b.NormalKind),a=E.FromArray(o,i[this.faceId*3]*3),s=E.FromArray(o,i[this.faceId*3+1]*3),f=E.FromArray(o,i[this.faceId*3+2]*3);a=a.scale(this.bu),s=s.scale(this.bv),f=f.scale(1-this.bu-this.bv),n=new E(a.x+s.x+f.x,a.y+s.y+f.y,a.z+s.z+f.z)}else{var u=this.pickedMesh.getVerticesData(b.PositionKind),l=E.FromArray(u,i[this.faceId*3]*3),h=E.FromArray(u,i[this.faceId*3+1]*3),c=E.FromArray(u,i[this.faceId*3+2]*3),p=l.subtract(h),d=c.subtract(h);n=E.Cross(p,d)}if(e){var m=this.pickedMesh.getWorldMatrix();this.pickedMesh.nonUniformScaling&&(L.Matrix[0].copyFrom(m),m=L.Matrix[0],m.setTranslationFromFloats(0,0,0),m.invert(),m.transposeToRef(L.Matrix[1]),m=L.Matrix[1]),n=E.TransformNormal(n,m)}return n.normalize(),n},r.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(b.UVKind))return null;var e=this.pickedMesh.getIndices();if(!e)return null;var t=this.pickedMesh.getVerticesData(b.UVKind);if(!t)return null;var i=_e.FromArray(t,e[this.faceId*3]*2),n=_e.FromArray(t,e[this.faceId*3+1]*2),o=_e.FromArray(t,e[this.faceId*3+2]*2);return i=i.scale(this.bu),n=n.scale(this.bv),o=o.scale(1-this.bu-this.bv),new _e(i.x+n.x+o.x,i.y+n.y+o.y)},r}();v();v();me.prototype.createUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");var t=new dr(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};me.prototype.createDynamicUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");var t=new dr(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};me.prototype.updateUniformBuffer=function(r,e,t,i){this.bindUniformBuffer(r),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};me.prototype.bindUniformBuffer=function(r){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,r?r.underlyingResource:null)};me.prototype.bindUniformBufferBase=function(r,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,r?r.underlyingResource:null)};me.prototype.bindUniformBlock=function(r,e,t){var i=r.program,n=this._gl.getUniformBlockIndex(i,e);n!==4294967295&&this._gl.uniformBlockBinding(i,n,t)};var vr=function(){function r(e,t,i,n,o){o===void 0&&(o=!1),this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||o,this._dynamic=i,this._name=n!=null?n:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}return Object.defineProperty(r.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!1,configurable:!0}),r.prototype.isDynamic=function(){return this._dynamic!==void 0},r.prototype.getData=function(){return this._bufferData},r.prototype.getBuffer=function(){return this._buffer},r.prototype._fillAlignment=function(e){var t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){var i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;for(var n=this._uniformLocationPointer-i,o=0;o<n;o++)this._data.push(0)}},r.prototype.addUniform=function(e,t,i){if(i===void 0&&(i=0),!this._noUBO&&this._uniformLocations[e]===void 0){var n;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{var o=4-t,a=o*i;t=t*i+a}n=[];for(var s=0;s<t;s++)n.push(0)}else{if(t instanceof Array)n=t,t=n.length;else{t=t,n=[];for(var s=0;s<t;s++)n.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(var s=0;s<t;s++)this._data.push(n[s]);this._needSync=!0}},r.prototype.addMatrix=function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))},r.prototype.addFloat2=function(e,t,i){var n=[t,i];this.addUniform(e,n)},r.prototype.addFloat3=function(e,t,i,n){var o=[t,i,n];this.addUniform(e,o)},r.prototype.addColor3=function(e,t){var i=[t.r,t.g,t.b];this.addUniform(e,i)},r.prototype.addColor4=function(e,t,i){var n=[t.r,t.g,t.b,i];this.addUniform(e,n)},r.prototype.addVector3=function(e,t){var i=[t.x,t.y,t.z];this.addUniform(e,i)},r.prototype.addMatrix3x3=function(e){this.addUniform(e,12)},r.prototype.addMatrix2x2=function(e){this.addUniform(e,8)},r.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},r.prototype._rebuild=function(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))},Object.defineProperty(r.prototype,"_numBuffers",{get:function(){return this._buffers.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_indexBuffer",{get:function(){return this._bufferIndex},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),r.prototype._buffersEqual=function(e,t){for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0},r.prototype._copyBuffer=function(e,t){for(var i=0;i<e.length;++i)t[i]=e[i]},r.prototype.update=function(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(r._UpdatedUbosInFrame[this._name]||(r._UpdatedUbosInFrame[this._name]=0),r._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}},r.prototype._createNewBuffer=function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()},r.prototype._checkNewFrame=function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)},r.prototype.updateUniform=function(e,t,i){this._checkNewFrame();var n=this._uniformLocations[e];if(n===void 0){if(this._buffer){q.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(var a=0;a<i;a++)this._bufferData[n+a]=t[a];else{for(var o=!1,a=0;a<i;a++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+a]!==he.FloatRound(t[a]))&&(o=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+a]=t[a]);this._needSync=this._needSync||o}},r.prototype.updateUniformArray=function(e,t,i){this._checkNewFrame();var n=this._uniformLocations[e];if(n===void 0){q.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");return}this._buffer||this.create();var o=this._uniformArraySizes[e];if(this._dynamic)for(var u=0;u<i;u++)this._bufferData[n+u]=t[u];else{for(var a=!1,s=0,f=0,u=0;u<i;u++)if(this._bufferData[n+f*4+s]!==he.FloatRound(t[u])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+f*4+s]=t[u]),s++,s===o.strideSize){for(;s<4;s++)this._bufferData[n+f*4+s]=0;s=0,f++}this._needSync=this._needSync||a}},r.prototype._cacheMatrix=function(e,t){this._checkNewFrame();var i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)},r.prototype._updateMatrix3x3ForUniform=function(e,t){for(var i=0;i<3;i++)r._TempBuffer[i*4]=t[i*3],r._TempBuffer[i*4+1]=t[i*3+1],r._TempBuffer[i*4+2]=t[i*3+2],r._TempBuffer[i*4+3]=0;this.updateUniform(e,r._TempBuffer,12)},r.prototype._updateMatrix3x3ForEffect=function(e,t){this._currentEffect.setMatrix3x3(e,t)},r.prototype._updateMatrix2x2ForEffect=function(e,t){this._currentEffect.setMatrix2x2(e,t)},r.prototype._updateMatrix2x2ForUniform=function(e,t){for(var i=0;i<2;i++)r._TempBuffer[i*4]=t[i*2],r._TempBuffer[i*4+1]=t[i*2+1],r._TempBuffer[i*4+2]=0,r._TempBuffer[i*4+3]=0;this.updateUniform(e,r._TempBuffer,8)},r.prototype._updateFloatForEffect=function(e,t){this._currentEffect.setFloat(e,t)},r.prototype._updateFloatForUniform=function(e,t){r._TempBuffer[0]=t,this.updateUniform(e,r._TempBuffer,1)},r.prototype._updateFloat2ForEffect=function(e,t,i,n){n===void 0&&(n=""),this._currentEffect.setFloat2(e+n,t,i)},r.prototype._updateFloat2ForUniform=function(e,t,i){r._TempBuffer[0]=t,r._TempBuffer[1]=i,this.updateUniform(e,r._TempBuffer,2)},r.prototype._updateFloat3ForEffect=function(e,t,i,n,o){o===void 0&&(o=""),this._currentEffect.setFloat3(e+o,t,i,n)},r.prototype._updateFloat3ForUniform=function(e,t,i,n){r._TempBuffer[0]=t,r._TempBuffer[1]=i,r._TempBuffer[2]=n,this.updateUniform(e,r._TempBuffer,3)},r.prototype._updateFloat4ForEffect=function(e,t,i,n,o,a){a===void 0&&(a=""),this._currentEffect.setFloat4(e+a,t,i,n,o)},r.prototype._updateFloat4ForUniform=function(e,t,i,n,o){r._TempBuffer[0]=t,r._TempBuffer[1]=i,r._TempBuffer[2]=n,r._TempBuffer[3]=o,this.updateUniform(e,r._TempBuffer,4)},r.prototype._updateFloatArrayForEffect=function(e,t){this._currentEffect.setFloatArray(e,t)},r.prototype._updateFloatArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},r.prototype._updateArrayForEffect=function(e,t){this._currentEffect.setArray(e,t)},r.prototype._updateArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},r.prototype._updateIntArrayForEffect=function(e,t){this._currentEffect.setIntArray(e,t)},r.prototype._updateIntArrayForUniform=function(e,t){r._TempBufferInt32View.set(t),this.updateUniformArray(e,r._TempBuffer,t.length)},r.prototype._updateMatrixForEffect=function(e,t){this._currentEffect.setMatrix(e,t)},r.prototype._updateMatrixForUniform=function(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)},r.prototype._updateMatricesForEffect=function(e,t){this._currentEffect.setMatrices(e,t)},r.prototype._updateMatricesForUniform=function(e,t){this.updateUniform(e,t,t.length)},r.prototype._updateVector3ForEffect=function(e,t){this._currentEffect.setVector3(e,t)},r.prototype._updateVector3ForUniform=function(e,t){r._TempBuffer[0]=t.x,r._TempBuffer[1]=t.y,r._TempBuffer[2]=t.z,this.updateUniform(e,r._TempBuffer,3)},r.prototype._updateVector4ForEffect=function(e,t){this._currentEffect.setVector4(e,t)},r.prototype._updateVector4ForUniform=function(e,t){r._TempBuffer[0]=t.x,r._TempBuffer[1]=t.y,r._TempBuffer[2]=t.z,r._TempBuffer[3]=t.w,this.updateUniform(e,r._TempBuffer,4)},r.prototype._updateColor3ForEffect=function(e,t,i){i===void 0&&(i=""),this._currentEffect.setColor3(e+i,t)},r.prototype._updateColor3ForUniform=function(e,t){r._TempBuffer[0]=t.r,r._TempBuffer[1]=t.g,r._TempBuffer[2]=t.b,this.updateUniform(e,r._TempBuffer,3)},r.prototype._updateColor4ForEffect=function(e,t,i,n){n===void 0&&(n=""),this._currentEffect.setColor4(e+n,t,i)},r.prototype._updateDirectColor4ForEffect=function(e,t,i){i===void 0&&(i=""),this._currentEffect.setDirectColor4(e+i,t)},r.prototype._updateColor4ForUniform=function(e,t,i){r._TempBuffer[0]=t.r,r._TempBuffer[1]=t.g,r._TempBuffer[2]=t.b,r._TempBuffer[3]=i,this.updateUniform(e,r._TempBuffer,4)},r.prototype._updateDirectColor4ForUniform=function(e,t){r._TempBuffer[0]=t.r,r._TempBuffer[1]=t.g,r._TempBuffer[2]=t.b,r._TempBuffer[3]=t.a,this.updateUniform(e,r._TempBuffer,4)},r.prototype._updateIntForEffect=function(e,t,i){i===void 0&&(i=""),this._currentEffect.setInt(e+i,t)},r.prototype._updateIntForUniform=function(e,t){r._TempBufferInt32View[0]=t,this.updateUniform(e,r._TempBuffer,1)},r.prototype._updateInt2ForEffect=function(e,t,i,n){n===void 0&&(n=""),this._currentEffect.setInt2(e+n,t,i)},r.prototype._updateInt2ForUniform=function(e,t,i){r._TempBufferInt32View[0]=t,r._TempBufferInt32View[1]=i,this.updateUniform(e,r._TempBuffer,2)},r.prototype._updateInt3ForEffect=function(e,t,i,n,o){o===void 0&&(o=""),this._currentEffect.setInt3(e+o,t,i,n)},r.prototype._updateInt3ForUniform=function(e,t,i,n){r._TempBufferInt32View[0]=t,r._TempBufferInt32View[1]=i,r._TempBufferInt32View[2]=n,this.updateUniform(e,r._TempBuffer,3)},r.prototype._updateInt4ForEffect=function(e,t,i,n,o,a){a===void 0&&(a=""),this._currentEffect.setInt4(e+a,t,i,n,o)},r.prototype._updateInt4ForUniform=function(e,t,i,n,o){r._TempBufferInt32View[0]=t,r._TempBufferInt32View[1]=i,r._TempBufferInt32View[2]=n,r._TempBufferInt32View[3]=o,this.updateUniform(e,r._TempBuffer,4)},r.prototype.setTexture=function(e,t){this._currentEffect.setTexture(e,t)},r.prototype.updateUniformDirectly=function(e,t){this.updateUniform(e,t,t.length),this.update()},r.prototype.bindToEffect=function(e,t){this._currentEffect=e,this._currentEffectName=t},r.prototype.bindUniformBuffer=function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)},r.prototype.unbindEffect=function(){this._currentEffect=void 0,this._currentEffectName=void 0},r.prototype.setDataBuffer=function(e){if(!this._buffers)return this._buffer===e;for(var t=0;t<this._buffers.length;++t){var i=this._buffers[t];if(i[0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0}return!1},r.prototype.dispose=function(){if(!this._noUBO){var e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var i=0;i<this._buffers.length;++i){var n=this._buffers[i][0];this._engine._releaseBuffer(n)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},r._UpdatedUbosInFrame={},r._MAX_UNIFORM_SIZE=256,r._TempBuffer=new Float32Array(r._MAX_UNIFORM_SIZE),r._TempBufferInt32View=new Uint32Array(r._TempBuffer.buffer),r}();v();var xh=function(){function r(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new E(0,0,0),this._diffPositionForCollisions=new E(0,0,0),this._collisionResponse=!0}return r}();var Tv=function(){function r(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=E.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}return r}(),Av=function(){function r(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Tv,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._meshCollisionData=new xh,this._enableDistantPicking=!1}return r}(),wr=function(r){Y(e,r);function e(t,i){i===void 0&&(i=null);var n=r.call(this,t,i,!1)||this;return n._internalAbstractMeshDataInfo=new Av,n._waitingMaterialId=null,n.cullingStrategy=e.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,n.onCollideObservable=new U,n.onCollisionPositionChangeObservable=new U,n.onMaterialChangedObservable=new U,n.definedFacingForward=!0,n._occlusionQuery=null,n._renderingGroup=null,n.alphaIndex=Number.MAX_VALUE,n.isVisible=!0,n.isPickable=!0,n.isNearPickable=!1,n.isNearGrabbable=!1,n.showSubMeshesBoundingBox=!1,n.isBlocker=!1,n.enablePointerMoveEvents=!1,n.outlineColor=de.Red(),n.outlineWidth=.02,n.overlayColor=de.Red(),n.overlayAlpha=.5,n.useOctreeForRenderingSelection=!0,n.useOctreeForPicking=!0,n.useOctreeForCollisions=!0,n.alwaysSelectAsActiveMesh=!1,n.doNotSyncBoundingInfo=!1,n.actionManager=null,n.ellipsoid=new E(.5,1,.5),n.ellipsoidOffset=new E(0,0,0),n.edgesWidth=1,n.edgesColor=new Ae(1,0,0,1),n._edgesRenderer=null,n._masterMesh=null,n._boundingInfo=null,n._boundingInfoIsDirty=!0,n._renderId=0,n._intersectionsInProgress=new Array,n._unIndexed=!1,n._lightSources=new Array,n._waitingData={lods:null,actions:null,freezeWorldMatrix:null},n._bonesTransformMatrices=null,n._transformMatrixTexture=null,n.onRebuildObservable=new U,n._onCollisionPositionChange=function(o,a,s){s===void 0&&(s=null),a.subtractToRef(n._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Re.CollisionsEpsilon&&n.position.addInPlace(n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&n.onCollideObservable.notifyObservers(s),n.onCollisionPositionChangeObservable.notifyObservers(n.position)},n.getScene().addMesh(n),n._resyncLightSources(),n._uniformBuffer=new vr(n.getScene().getEngine(),void 0,void 0,t,!n.getScene().getEngine().isWebGPU),n._buildUniformLayout(),n}return Object.defineProperty(e,"BILLBOARDMODE_NONE",{get:function(){return rt.BILLBOARDMODE_NONE},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_X",{get:function(){return rt.BILLBOARDMODE_X},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_Y",{get:function(){return rt.BILLBOARDMODE_Y},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_Z",{get:function(){return rt.BILLBOARDMODE_Z},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_ALL",{get:function(){return rt.BILLBOARDMODE_ALL},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_USE_POSITION",{get:function(){return rt.BILLBOARDMODE_USE_POSITION},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"facetNb",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetNb},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"partitioningSubdivisions",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions},set:function(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"partitioningBBoxRatio",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio},set:function(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mustDepthSortFacets",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort},set:function(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"facetDepthSortFrom",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom},set:function(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionRetryCount",{get:function(){return this._internalAbstractMeshDataInfo._collisionRetryCount},set:function(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isFacetDataEnabled",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"morphTargetManager",{get:function(){return this._internalAbstractMeshDataInfo._morphTargetManager},set:function(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bakedVertexAnimationManager",{get:function(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager},set:function(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),e.prototype._syncGeometryWithMorphTargetManager=function(){},e.prototype._updateNonUniformScalingState=function(t){return r.prototype._updateNonUniformScalingState.call(this,t)?(this._markSubMeshesAsMiscDirty(),!0):!1},Object.defineProperty(e.prototype,"onCollide",{set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onCollisionPositionChange",{set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibility",{get:function(){return this._internalAbstractMeshDataInfo._visibility},set:function(t){if(this._internalAbstractMeshDataInfo._visibility!==t){var i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(i===1&&t!==1||i!==1&&t===1)&&this._markSubMeshesAsMiscDirty()}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderingGroupId",{get:function(){return this._internalAbstractMeshDataInfo._renderingGroupId},set:function(t){this._internalAbstractMeshDataInfo._renderingGroupId=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._internalAbstractMeshDataInfo._material},set:function(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))},enumerable:!1,configurable:!0}),e.prototype.getMaterialForRenderPass=function(t){var i;return(i=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[t]},e.prototype.setMaterialForRenderPass=function(t,i){this.resetDrawCache(t),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=i},Object.defineProperty(e.prototype,"receiveShadows",{get:function(){return this._internalAbstractMeshDataInfo._receiveShadows},set:function(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasVertexAlpha",{get:function(){return this._internalAbstractMeshDataInfo._hasVertexAlpha},set:function(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useVertexColors",{get:function(){return this._internalAbstractMeshDataInfo._useVertexColors},set:function(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numBoneInfluencers",{get:function(){return this._internalAbstractMeshDataInfo._numBoneInfluencers},set:function(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"applyFog",{get:function(){return this._internalAbstractMeshDataInfo._applyFog},set:function(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableDistantPicking",{get:function(){return this._internalAbstractMeshDataInfo._enableDistantPicking},set:function(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layerMask",{get:function(){return this._internalAbstractMeshDataInfo._layerMask},set:function(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionMask",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionResponse",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionGroup",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"surroundingMeshes",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightSources",{get:function(){return this._lightSources},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_positions",{get:function(){return null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeleton",{get:function(){return this._internalAbstractMeshDataInfo._skeleton},set:function(t){var i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()},enumerable:!1,configurable:!0}),e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()},e.prototype.transferToEffect=function(t){var i=this._uniformBuffer;i.updateMatrix("world",t),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()},e.prototype.getMeshUniformBuffer=function(){return this._uniformBuffer},e.prototype.getClassName=function(){return"AbstractMesh"},e.prototype.toString=function(t){var i="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);var n=this._internalAbstractMeshDataInfo._skeleton;return n&&(i+=", skeleton: "+n.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i},e.prototype._getEffectiveParent=function(){return this._masterMesh&&this.billboardMode!==rt.BILLBOARDMODE_NONE?this._masterMesh:r.prototype._getEffectiveParent.call(this)},e.prototype._getActionManagerForTrigger=function(t,i){if(i===void 0&&(i=!0),this.actionManager&&(i||this.actionManager.isRecursive))if(t){if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(t,!1):null},e.prototype._rebuild=function(t){if(t===void 0&&(t=!1),this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(var i=0,n=this.subMeshes;i<n.length;i++){var o=n[i];o._rebuild()}},e.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var t=0,i=this.getScene().lights;t<i.length;t++){var n=i[t];!n.isEnabled()||n.canAffectMesh(this)&&this._lightSources.push(n)}this._markSubMeshesAsLightDirty()},e.prototype._resyncLightSource=function(t){var i=t.isEnabled()&&t.canAffectMesh(this),n=this._lightSources.indexOf(t),o=!1;if(n===-1){if(!i)return;this._lightSources.push(t)}else{if(i)return;o=!0,this._lightSources.splice(n,1)}this._markSubMeshesAsLightDirty(o)},e.prototype._unBindEffect=function(){for(var t=0,i=this.subMeshes;t<i.length;t++){var n=i[t];n.setEffect(null)}},e.prototype._removeLightSource=function(t,i){var n=this._lightSources.indexOf(t);n!==-1&&(this._lightSources.splice(n,1),this._markSubMeshesAsLightDirty(i))},e.prototype._markSubMeshesAsDirty=function(t){if(!!this.subMeshes)for(var i=0,n=this.subMeshes;i<n.length;i++)for(var o=n[i],a=0;a<o._drawWrappers.length;++a){var s=o._drawWrappers[a];!s||!s.defines||!s.defines.markAllAsDirty||t(s.defines)}},e.prototype._markSubMeshesAsLightDirty=function(t){t===void 0&&(t=!1),this._markSubMeshesAsDirty(function(i){return i.markAsLightDirty(t)})},e.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsAttributesDirty()})},e.prototype._markSubMeshesAsMiscDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsMiscDirty()})},e.prototype.markAsDirty=function(t){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},e.prototype.resetDrawCache=function(t){if(!!this.subMeshes)for(var i=0,n=this.subMeshes;i<n.length;i++){var o=n[i];o.resetDrawCache(t)}},Object.defineProperty(e.prototype,"isBlocked",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype.getLOD=function(t){return this},e.prototype.getTotalVertices=function(){return 0},e.prototype.getTotalIndices=function(){return 0},e.prototype.getIndices=function(){return null},e.prototype.getVerticesData=function(t){return null},e.prototype.setVerticesData=function(t,i,n,o){return this},e.prototype.updateVerticesData=function(t,i,n,o){return this},e.prototype.setIndices=function(t,i){return this},e.prototype.isVerticesDataPresent=function(t){return!1},e.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)},e.prototype.setBoundingInfo=function(t){return this._boundingInfo=t,this},Object.defineProperty(e.prototype,"hasBoundingInfo",{get:function(){return this._boundingInfo!==null},enumerable:!1,configurable:!0}),e.prototype.buildBoundingInfo=function(t,i,n){return this._boundingInfo=new Kt(t,i,n),this._boundingInfo},e.prototype.normalizeToUnitCube=function(t,i,n){return t===void 0&&(t=!0),i===void 0&&(i=!1),r.prototype.normalizeToUnitCube.call(this,t,i,n)},Object.defineProperty(e.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(b.MatricesIndicesKind)&&this.isVerticesDataPresent(b.MatricesWeightsKind)},enumerable:!1,configurable:!0}),e.prototype._preActivate=function(){},e.prototype._preActivateForIntermediateRendering=function(t){},e.prototype._activate=function(t,i){return this._renderId=t,!0},e.prototype._postActivate=function(){},e.prototype._freeze=function(){},e.prototype._unFreeze=function(){},e.prototype.getWorldMatrix=function(){return this._masterMesh&&this.billboardMode===rt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():r.prototype.getWorldMatrix.call(this)},e.prototype._getWorldMatrixDeterminant=function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():r.prototype._getWorldMatrixDeterminant.call(this)},Object.defineProperty(e.prototype,"isAnInstance",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasThinInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype.movePOV=function(t,i,n){return this.position.addInPlace(this.calcMovePOV(t,i,n)),this},e.prototype.calcMovePOV=function(t,i,n){var o=new B,a=this.rotationQuaternion?this.rotationQuaternion:ie.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);a.toRotationMatrix(o);var s=E.Zero(),f=this.definedFacingForward?-1:1;return E.TransformCoordinatesFromFloatsToRef(t*f,i,n*f,o,s),s},e.prototype.rotatePOV=function(t,i,n){return this.rotation.addInPlace(this.calcRotatePOV(t,i,n)),this},e.prototype.calcRotatePOV=function(t,i,n){var o=this.definedFacingForward?1:-1;return new E(t*o,i,n*o)},e.prototype.refreshBoundingInfo=function(t,i){return t===void 0&&(t=!1),i===void 0&&(i=!1),this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(t,i),null),this)},e.prototype._refreshBoundingInfo=function(t,i){if(t){var n=Xn(t,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new Kt(n.minimum,n.maximum)}if(this.subMeshes)for(var o=0;o<this.subMeshes.length;o++)this.subMeshes[o].refreshBoundingInfo(t);this._updateBoundingInfo()},e.prototype._getData=function(t,i,n,o){if(t===void 0&&(t=!1),i===void 0&&(i=!1),o===void 0&&(o=b.PositionKind),n=n!=null?n:this.getVerticesData(o).slice(),n&&i&&this.morphTargetManager)for(var a=0,s=0,f=0;f<n.length;f++){for(var u=0;u<this.morphTargetManager.numTargets;u++){var l=this.morphTargetManager.getTarget(u),h=l.influence;if(h>0){var c=l.getPositions();c&&(n[f]+=(c[f]-n[f])*h)}}if(a++,o===b.PositionKind&&this._positions&&a===3){a=0;var p=s*3;this._positions[s++].copyFromFloats(n[p],n[p+1],n[p+2])}}if(n&&t&&this.skeleton){var d=this.getVerticesData(b.MatricesIndicesKind),m=this.getVerticesData(b.MatricesWeightsKind);if(m&&d)for(var _=this.numBoneInfluencers>4,y=_?this.getVerticesData(b.MatricesIndicesExtraKind):null,g=_?this.getVerticesData(b.MatricesWeightsExtraKind):null,T=this.skeleton.getTransformMatrices(this),A=L.Vector3[0],M=L.Matrix[0],C=L.Matrix[1],P=0,p=0;p<n.length;p+=3,P+=4){M.reset();var R=void 0,F=void 0;for(R=0;R<4;R++)F=m[P+R],F>0&&(B.FromFloat32ArrayToRefScaled(T,Math.floor(d[P+R]*16),F,C),M.addToSelf(C));if(_)for(R=0;R<4;R++)F=g[P+R],F>0&&(B.FromFloat32ArrayToRefScaled(T,Math.floor(y[P+R]*16),F,C),M.addToSelf(C));o===b.NormalKind?E.TransformNormalFromFloatsToRef(n[p],n[p+1],n[p+2],M,A):E.TransformCoordinatesFromFloatsToRef(n[p],n[p+1],n[p+2],M,A),A.toArray(n,p),o===b.PositionKind&&this._positions&&this._positions[p/3].copyFrom(A)}}return n},e.prototype.getNormalsData=function(t,i){return t===void 0&&(t=!1),i===void 0&&(i=!1),this._getData(t,i,null,b.NormalKind)},e.prototype.getPositionData=function(t,i,n){return t===void 0&&(t=!1),i===void 0&&(i=!1),this._getData(t,i,n,b.PositionKind)},e.prototype._getPositionData=function(t,i){var n,o=this.getVerticesData(b.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),o&&(t&&this.skeleton||i&&this.morphTargetManager)){if(o=o.slice(),this._generatePointsArray(),this._positions){var a=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(a.length);for(var s=0;s<a.length;s++)this._internalAbstractMeshDataInfo._positions[s]=((n=a[s])===null||n===void 0?void 0:n.clone())||new E}return this.getPositionData(t,i,o)}return o},e.prototype._updateBoundingInfo=function(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Kt(E.Zero(),E.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},e.prototype._updateSubMeshesBoundingInfo=function(t){if(!this.subMeshes)return this;for(var i=this.subMeshes.length,n=0;n<i;n++){var o=this.subMeshes[n];(i>1||!o.IsGlobal)&&o.updateBoundingInfo(t)}return this},e.prototype._afterComputeWorldMatrix=function(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)},e.prototype.isInFrustum=function(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)},e.prototype.isCompletelyInFrustum=function(t){return this.getBoundingInfo().isCompletelyInFrustum(t)},e.prototype.intersectsMesh=function(t,i,n){i===void 0&&(i=!1);var o=this.getBoundingInfo(),a=t.getBoundingInfo();if(o.intersects(a,i))return!0;if(n)for(var s=0,f=this.getChildMeshes();s<f.length;s++){var u=f[s];if(u.intersectsMesh(t,i,!0))return!0}return!1},e.prototype.intersectsPoint=function(t){return this.getBoundingInfo().intersectsPoint(t)},Object.defineProperty(e.prototype,"checkCollisions",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collider",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider},enumerable:!1,configurable:!0}),e.prototype.moveWithCollisions=function(t){var i=this.getAbsolutePosition();i.addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);var n=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=n.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,n.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this},e.prototype._collideForSubMesh=function(t,i,n){var o;if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];for(var a=t.verticesStart,s=t.verticesStart+t.verticesCount,f=a;f<s;f++)t._lastColliderWorldVertices.push(E.TransformCoordinates(this._positions[f],i))}return n._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),((o=t.getMaterial())===null||o===void 0?void 0:o.fillMode)===7),this},e.prototype._processCollisionsForSubMeshes=function(t,i){for(var n=this._scene.getCollidingSubMeshCandidates(this,t),o=n.length,a=0;a<o;a++){var s=n.data[a];o>1&&!s._checkCollision(t)||this._collideForSubMesh(s,i,t)}return this},e.prototype._shouldConvertRHS=function(){return!1},e.prototype._checkCollision=function(t){if(!this.getBoundingInfo()._checkCollision(t))return this;var i=L.Matrix[0],n=L.Matrix[1];return B.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,n),this._processCollisionsForSubMeshes(t,n),this},e.prototype._generatePointsArray=function(){return!1},e.prototype.intersects=function(t,i,n,o,a,s){o===void 0&&(o=!1),s===void 0&&(s=!1);var f=new bt,u=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,l=this.getBoundingInfo();if(!this.subMeshes||!s&&(!t.intersectsSphere(l.boundingSphere,u)||!t.intersectsBox(l.boundingBox,u)))return f;if(o)return f.hit=!s,f.pickedMesh=s?null:this,f.distance=s?0:E.Distance(t.origin,l.boundingSphere.center),f.subMeshId=0,f;if(!this._generatePointsArray())return f;for(var h=null,c=this._scene.getIntersectingSubMeshCandidates(this,t),p=c.length,d=!1,m=0;m<p;m++){var _=c.data[m],y=_.getMaterial();if(!!y&&(y.fillMode==7||y.fillMode==0||y.fillMode==1||y.fillMode==2||y.fillMode==4)){d=!0;break}}if(!d)return f.hit=!0,f.pickedMesh=this,f.distance=E.Distance(t.origin,l.boundingSphere.center),f.subMeshId=-1,f;for(var m=0;m<p;m++){var _=c.data[m];if(!(p>1&&!_.canIntersects(t))){var g=_.intersects(t,this._positions,this.getIndices(),i,n);if(g&&(i||!h||g.distance<h.distance)&&(h=g,h.subMeshId=m,i))break}}if(h){var T=a!=null?a:this.getWorldMatrix(),A=L.Vector3[0],M=L.Vector3[1];E.TransformCoordinatesToRef(t.origin,T,A),t.direction.scaleToRef(h.distance,M);var C=E.TransformNormal(M,T),P=C.addInPlace(A);return f.hit=!0,f.distance=E.Distance(A,P),f.pickedPoint=P,f.pickedMesh=this,f.bu=h.bu||0,f.bv=h.bv||0,f.subMeshFaceId=h.faceId,f.faceId=h.faceId+c.data[h.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),f.subMeshId=h.subMeshId,f}return f},e.prototype.clone=function(t,i,n){return null},e.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this},e.prototype.dispose=function(t,i){var n=this;i===void 0&&(i=!1);var o;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),o=0;o<this._intersectionsInProgress.length;o++){var a=this._intersectionsInProgress[o],s=a._intersectionsInProgress.indexOf(this);a._intersectionsInProgress.splice(s,1)}this._intersectionsInProgress.length=0;var f=this.getScene().lights;f.forEach(function(h){var c=h.includedOnlyMeshes.indexOf(n);c!==-1&&h.includedOnlyMeshes.splice(c,1),c=h.excludedMeshes.indexOf(n),c!==-1&&h.excludedMeshes.splice(c,1);var p=h.getShadowGenerator();if(p){var d=p.getShadowMap();d&&d.renderList&&(c=d.renderList.indexOf(n),c!==-1&&d.renderList.splice(c,1))}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();var u=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,u.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),u.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){var l=this._parentContainer.meshes.indexOf(this);l>-1&&this._parentContainer.meshes.splice(l,1),this._parentContainer=null}if(i&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(o=0;o<this.getScene().particleSystems.length;o++)this.getScene().particleSystems[o].emitter===this&&(this.getScene().particleSystems[o].dispose(),o--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),r.prototype.dispose.call(this,t,i)},e.prototype.addChild=function(t,i){return i===void 0&&(i=!1),t.setParent(this,i),this},e.prototype.removeChild=function(t,i){return i===void 0&&(i=!1),t.setParent(null,i),this},e.prototype._initFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=new Array),t.facetPositions||(t.facetPositions=new Array),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(var i=0;i<t.facetNb;i++)t.facetNormals[i]=E.Zero(),t.facetPositions[i]=E.Zero();return t.facetDataEnabled=!0,this},e.prototype.updateFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();var i=this.getVerticesData(b.PositionKind),n=this.getIndices(),o=this.getVerticesData(b.NormalKind),a=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,n instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(n);else if(n instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(n);else{for(var s=!1,f=0;f<n.length;f++)if(n[f]>65535){s=!0;break}s?t.depthSortedIndices=new Uint32Array(n):t.depthSortedIndices=new Uint16Array(n)}if(t.facetDepthSortFunction=function(m,_){return _.sqDistance-m.sqDistance},!t.facetDepthSortFrom){var u=this.getScene().activeCamera;t.facetDepthSortFrom=u?u.position:E.Zero()}t.depthSortedFacets=[];for(var l=0;l<t.facetNb;l++){var h={ind:l*3,sqDistance:0};t.depthSortedFacets.push(h)}t.invertedMatrix=B.Identity(),t.facetDepthSortOrigin=E.Zero()}t.bbSize.x=a.maximum.x-a.minimum.x>ye?a.maximum.x-a.minimum.x:ye,t.bbSize.y=a.maximum.y-a.minimum.y>ye?a.maximum.y-a.minimum.y:ye,t.bbSize.z=a.maximum.z-a.minimum.z>ye?a.maximum.z-a.minimum.z:ye;var c=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(c=c>t.bbSize.z?c:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/c),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/c),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/c),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=a,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),E.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,o&&re.ComputeNormals(i,n,o,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);for(var p=t.depthSortedIndices.length/3|0,l=0;l<p;l++){var d=t.depthSortedFacets[l].ind;t.depthSortedIndices[l*3]=n[d],t.depthSortedIndices[l*3+1]=n[d+1],t.depthSortedIndices[l*3+2]=n[d+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this},e.prototype.getFacetLocalNormals=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals},e.prototype.getFacetLocalPositions=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions},e.prototype.getFacetLocalPartitioning=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning},e.prototype.getFacetPosition=function(t){var i=E.Zero();return this.getFacetPositionToRef(t,i),i},e.prototype.getFacetPositionToRef=function(t,i){var n=this.getFacetLocalPositions()[t],o=this.getWorldMatrix();return E.TransformCoordinatesToRef(n,o,i),this},e.prototype.getFacetNormal=function(t){var i=E.Zero();return this.getFacetNormalToRef(t,i),i},e.prototype.getFacetNormalToRef=function(t,i){var n=this.getFacetLocalNormals()[t];return E.TransformNormalToRef(n,this.getWorldMatrix(),i),this},e.prototype.getFacetsAtLocalCoordinates=function(t,i,n){var o=this.getBoundingInfo(),a=this._internalAbstractMeshDataInfo._facetData,s=Math.floor((t-o.minimum.x*a.partitioningBBoxRatio)*a.subDiv.X*a.partitioningBBoxRatio/a.bbSize.x),f=Math.floor((i-o.minimum.y*a.partitioningBBoxRatio)*a.subDiv.Y*a.partitioningBBoxRatio/a.bbSize.y),u=Math.floor((n-o.minimum.z*a.partitioningBBoxRatio)*a.subDiv.Z*a.partitioningBBoxRatio/a.bbSize.z);return s<0||s>a.subDiv.max||f<0||f>a.subDiv.max||u<0||u>a.subDiv.max?null:a.facetPartitioning[s+a.subDiv.max*f+a.subDiv.max*a.subDiv.max*u]},e.prototype.getClosestFacetAtCoordinates=function(t,i,n,o,a,s){a===void 0&&(a=!1),s===void 0&&(s=!0);var f=this.getWorldMatrix(),u=L.Matrix[5];f.invertToRef(u);var l=L.Vector3[8];E.TransformCoordinatesFromFloatsToRef(t,i,n,u,l);var h=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,o,a,s);return o&&E.TransformCoordinatesFromFloatsToRef(o.x,o.y,o.z,f,o),h},e.prototype.getClosestFacetAtLocalCoordinates=function(t,i,n,o,a,s){a===void 0&&(a=!1),s===void 0&&(s=!0);var f=null,u=0,l=0,h=0,c=0,p=0,d=0,m=0,_=0,y=this.getFacetLocalPositions(),g=this.getFacetLocalNormals(),T=this.getFacetsAtLocalCoordinates(t,i,n);if(!T)return null;for(var A=Number.MAX_VALUE,M=A,C,P,R,F=0;F<T.length;F++)C=T[F],P=g[C],R=y[C],c=(t-R.x)*P.x+(i-R.y)*P.y+(n-R.z)*P.z,(!a||a&&s&&c>=0||a&&!s&&c<=0)&&(c=P.x*R.x+P.y*R.y+P.z*R.z,p=-(P.x*t+P.y*i+P.z*n-c)/(P.x*P.x+P.y*P.y+P.z*P.z),d=t+P.x*p,m=i+P.y*p,_=n+P.z*p,u=d-t,l=m-i,h=_-n,M=u*u+l*l+h*h,M<A&&(A=M,f=C,o&&(o.x=d,o.y=m,o.z=_)));return f},e.prototype.getFacetDataParameters=function(){return this._internalAbstractMeshDataInfo._facetData.facetParameters},e.prototype.disableFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=new Array,t.facetNormals=new Array,t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this},e.prototype.updateIndices=function(t,i,n){return n===void 0&&(n=!1),this},e.prototype.createNormals=function(t){var i=this.getVerticesData(b.PositionKind),n=this.getIndices(),o;return this.isVerticesDataPresent(b.NormalKind)?o=this.getVerticesData(b.NormalKind):o=[],re.ComputeNormals(i,n,o,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(b.NormalKind,o,t),this},e.prototype.alignWithNormal=function(t,i){i||(i=zi.Y);var n=L.Vector3[0],o=L.Vector3[1];return E.CrossToRef(i,t,o),E.CrossToRef(t,o,n),this.rotationQuaternion?ie.RotationQuaternionFromAxisToRef(n,t,o,this.rotationQuaternion):E.RotationFromAxisToRef(n,t,o,this.rotation),this},e.prototype._checkOcclusionQuery=function(){return!1},e.prototype.disableEdgesRendering=function(){throw Q("EdgesRenderer")},e.prototype.enableEdgesRendering=function(t,i,n){throw Q("EdgesRenderer")},e.prototype.getConnectedParticleSystems=function(){var t=this;return this._scene.particleSystems.filter(function(i){return i.emitter===t})},e.OCCLUSION_TYPE_NONE=0,e.OCCLUSION_TYPE_OPTIMISTIC=1,e.OCCLUSION_TYPE_STRICT=2,e.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,e.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,e.CULLINGSTRATEGY_STANDARD=0,e.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,e.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,e.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,e}(rt);Ke("BABYLON.AbstractMesh",wr);v();v();var pi=function(){function r(e,t,i,n){this.normal=new E(e,t,i),this.d=n}return r.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},r.prototype.clone=function(){return new r(this.normal.x,this.normal.y,this.normal.z,this.d)},r.prototype.getClassName=function(){return"Plane"},r.prototype.getHashCode=function(){var e=this.normal.getHashCode();return e=e*397^(this.d|0),e},r.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this},r.prototype.transform=function(e){var t=r._TmpMatrix;e.invertToRef(t);var i=t.m,n=this.normal.x,o=this.normal.y,a=this.normal.z,s=this.d,f=n*i[0]+o*i[1]+a*i[2]+s*i[3],u=n*i[4]+o*i[5]+a*i[6]+s*i[7],l=n*i[8]+o*i[9]+a*i[10]+s*i[11],h=n*i[12]+o*i[13]+a*i[14]+s*i[15];return new r(f,u,l,h)},r.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},r.prototype.copyFromPoints=function(e,t,i){var n=t.x-e.x,o=t.y-e.y,a=t.z-e.z,s=i.x-e.x,f=i.y-e.y,u=i.z-e.z,l=o*u-a*f,h=a*s-n*u,c=n*f-o*s,p=Math.sqrt(l*l+h*h+c*c),d;return p!==0?d=1/p:d=0,this.normal.x=l*d,this.normal.y=h*d,this.normal.z=c*d,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this},r.prototype.isFrontFacingTo=function(e,t){var i=E.Dot(this.normal,e);return i<=t},r.prototype.signedDistanceTo=function(e){return E.Dot(e,this.normal)+this.d},r.FromArray=function(e){return new r(e[0],e[1],e[2],e[3])},r.FromPoints=function(e,t,i){var n=new r(0,0,0,0);return n.copyFromPoints(e,t,i),n},r.FromPositionAndNormal=function(e,t){var i=new r(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i},r.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,i){var n=-(t.x*e.x+t.y*e.y+t.z*e.z);return E.Dot(i,t)+n},r._TmpMatrix=B.Identity(),r}();v();v();v();var st=function(){function r(e){this.length=0,this.data=new Array(e),this._id=r._GlobalId++}return r.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)},r.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e(this.data[t])},r.prototype.sort=function(e){this.data.sort(e)},r.prototype.reset=function(){this.length=0},r.prototype.dispose=function(){this.reset(),this.data&&(this.data.length=0)},r.prototype.concat=function(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},r.prototype.indexOf=function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t},r.prototype.contains=function(e){return this.indexOf(e)!==-1},r._GlobalId=0,r}();var Nt=function(r){Y(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t._duplicateId=0,t}return e.prototype.push=function(t){r.prototype.push.call(this,t),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId},e.prototype.pushNoDuplicate=function(t){return t.__smartArrayFlags&&t.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(t),!0)},e.prototype.reset=function(){r.prototype.reset.call(this),this._duplicateId++},e.prototype.concatWithNoDuplicate=function(t){if(t.length!==0){this.length+t.length>this.data.length&&(this.data.length=(this.length+t.length)*2);for(var i=0;i<t.length;i++){var n=(t.data||t)[i];this.pushNoDuplicate(n)}}},e}(st);v();var Ph=function(){function r(e,t,i,n){this.x=e,this.y=t,this.width=i,this.height=n}return r.prototype.toGlobal=function(e,t){return new r(this.x*e,this.y*t,this.width*e,this.height*t)},r.prototype.toGlobalToRef=function(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height)},r}();v();var _i=function(){function r(){}return r.GetPlanes=function(e){for(var t=[],i=0;i<6;i++)t.push(new pi(0,0,0,0));return r.GetPlanesToRef(e,t),t},r.GetNearPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()},r.GetFarPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()},r.GetLeftPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()},r.GetRightPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()},r.GetTopPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()},r.GetBottomPlaneToRef=function(e,t){var i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()},r.GetPlanesToRef=function(e,t){r.GetNearPlaneToRef(e,t[0]),r.GetFarPlaneToRef(e,t[1]),r.GetLeftPlaneToRef(e,t[2]),r.GetRightPlaneToRef(e,t[3]),r.GetTopPlaneToRef(e,t[4]),r.GetBottomPlaneToRef(e,t[5])},r}();var Ye=function(r){Y(e,r);function e(t,i,n,o){o===void 0&&(o=!0);var a=r.call(this,t,n)||this;return a._position=E.Zero(),a._upVector=E.Up(),a._orthoLeft=null,a._orthoRight=null,a._orthoBottom=null,a._orthoTop=null,a.fov=.8,a.projectionPlaneTilt=0,a.minZ=1,a.maxZ=1e4,a.inertia=.9,a._mode=e.PERSPECTIVE_CAMERA,a.isIntermediate=!1,a.viewport=new Ph(0,0,1,1),a.layerMask=268435455,a.fovMode=e.FOVMODE_VERTICAL_FIXED,a.cameraRigMode=e.RIG_MODE_NONE,a.customRenderTargets=new Array,a.outputRenderTarget=null,a.onViewMatrixChangedObservable=new U,a.onProjectionMatrixChangedObservable=new U,a.onAfterCheckInputsObservable=new U,a.onRestoreStateObservable=new U,a.isRigCamera=!1,a._rigCameras=new Array,a._webvrViewMatrix=B.Identity(),a._skipRendering=!1,a._projectionMatrix=new B,a._postProcesses=new Array,a._activeMeshes=new st(256),a._globalPosition=E.Zero(),a._computedViewMatrix=B.Identity(),a._doNotComputeProjectionMatrix=!1,a._transformMatrix=B.Zero(),a._refreshFrustumPlanes=!0,a._absoluteRotation=ie.Identity(),a._isCamera=!0,a._isLeftCamera=!1,a._isRightCamera=!1,a.getScene().addCamera(a),o&&!a.getScene().activeCamera&&(a.getScene().activeCamera=a),a.position=i,a.renderPassId=a.getScene().getEngine().createRenderPassId("Camera ".concat(t)),a}return Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"upVector",{get:function(){return this._upVector},set:function(t){this._upVector=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"screenArea",{get:function(){var t,i,n,o,a=0,s=0;if(this.mode===e.PERSPECTIVE_CAMERA)this.fovMode===e.FOVMODE_VERTICAL_FIXED?(s=this.minZ*2*Math.tan(this.fov/2),a=this.getEngine().getAspectRatio(this)*s):(a=this.minZ*2*Math.tan(this.fov/2),s=a/this.getEngine().getAspectRatio(this));else{var f=this.getEngine().getRenderWidth()/2,u=this.getEngine().getRenderHeight()/2;a=((t=this.orthoRight)!==null&&t!==void 0?t:f)-((i=this.orthoLeft)!==null&&i!==void 0?i:-f),s=((n=this.orthoTop)!==null&&n!==void 0?n:u)-((o=this.orthoBottom)!==null&&o!==void 0?o:-u)}return a*s},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(t){this._orthoLeft=t;for(var i=0,n=this._rigCameras;i<n.length;i++){var o=n[i];o.orthoLeft=t}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(t){this._orthoRight=t;for(var i=0,n=this._rigCameras;i<n.length;i++){var o=n[i];o.orthoRight=t}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(t){this._orthoBottom=t;for(var i=0,n=this._rigCameras;i<n.length;i++){var o=n[i];o.orthoBottom=t}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(t){this._orthoTop=t;for(var i=0,n=this._rigCameras;i<n.length;i++){var o=n[i];o.orthoTop=t}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mode",{get:function(){return this._mode},set:function(t){this._mode=t;for(var i=0,n=this._rigCameras;i<n.length;i++){var o=n[i];o.mode=t}},enumerable:!1,configurable:!0}),e.prototype.storeState=function(){return this._stateStored=!0,this._storedFov=this.fov,this},e.prototype._restoreStateValues=function(){return this._stateStored?(this.fov=this._storedFov,!0):!1},e.prototype.restoreState=function(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1},e.prototype.getClassName=function(){return"Camera"},e.prototype.toString=function(t){var i="Name: "+this.name;if(i+=", type: "+this.getClassName(),this.animations)for(var n=0;n<this.animations.length;n++)i+=", animation[0]: "+this.animations[n].toString(t);return i},e.prototype.applyVerticalCorrection=function(){var t=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-t.x:t.x},Object.defineProperty(e.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!1,configurable:!0}),e.prototype.getActiveMeshes=function(){return this._activeMeshes},e.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},e.prototype.isReady=function(t){if(t===void 0&&(t=!1),t)for(var i=0,n=this._postProcesses;i<n.length;i++){var o=n[i];if(o&&!o.isReady())return!1}return r.prototype.isReady.call(this,t)},e.prototype._initCache=function(){r.prototype._initCache.call(this),this._cache.position=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},e.prototype._updateCache=function(t){t||r.prototype._updateCache.call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)},e.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},e.prototype._isSynchronizedViewMatrix=function(){return r.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},e.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;var i=this.getEngine();return this.mode===e.PERSPECTIVE_CAMERA?t=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===i.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:t=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===i.getRenderWidth()&&this._cache.renderHeight===i.getRenderHeight(),t},e.prototype.attachControl=function(t,i){},e.prototype.detachControl=function(t){},e.prototype.update=function(){this._checkInputs(),this.cameraRigMode!==e.RIG_MODE_NONE&&this._updateRigCameras()},e.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)},Object.defineProperty(e.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:!1,configurable:!0}),e.prototype._getFirstPostProcess=function(){for(var t=0;t<this._postProcesses.length;t++)if(this._postProcesses[t]!==null)return this._postProcesses[t];return null},e.prototype._cascadePostProcessesToRigCams=function(){var t=this._getFirstPostProcess();t&&t.markTextureDirty();for(var i=0,n=this._rigCameras.length;i<n;i++){var o=this._rigCameras[i],a=o._rigPostProcess;if(a){var s=a.getEffectName()==="pass";s&&(o.isIntermediate=this._postProcesses.length===0),o._postProcesses=this._postProcesses.slice(0).concat(a),a.markTextureDirty()}else o._postProcesses=this._postProcesses.slice(0)}},e.prototype.attachPostProcess=function(t,i){return i===void 0&&(i=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1?(q.Error("You're trying to reuse a post process not defined as reusable."),0):(i==null||i<0?this._postProcesses.push(t):this._postProcesses[i]===null?this._postProcesses[i]=t:this._postProcesses.splice(i,0,t),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(t))},e.prototype.detachPostProcess=function(t){var i=this._postProcesses.indexOf(t);i!==-1&&(this._postProcesses[i]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()},e.prototype.getWorldMatrix=function(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)},e.prototype._getViewMatrix=function(){return B.Identity()},e.prototype.getViewMatrix=function(t){return!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)},e.prototype.freezeProjectionMatrix=function(t){this._doNotComputeProjectionMatrix=!0,t!==void 0&&(this._projectionMatrix=t)},e.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},e.prototype.getProjectionMatrix=function(t){var i,n,o,a,s,f,u,l;if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var h=this.getEngine(),c=this.getScene();if(this.mode===e.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=h.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);var p=h.useReverseDepthBuffer,d=void 0;c.useRightHandedSystem?d=B.PerspectiveFovRHToRef:d=B.PerspectiveFovLHToRef,d(this.fov,h.getAspectRatio(this),p?this.maxZ:this.minZ,p?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===e.FOVMODE_VERTICAL_FIXED,h.isNDCHalfZRange,this.projectionPlaneTilt,h.useReverseDepthBuffer)}else{var m=h.getRenderWidth()/2,_=h.getRenderHeight()/2;c.useRightHandedSystem?B.OrthoOffCenterRHToRef((i=this.orthoLeft)!==null&&i!==void 0?i:-m,(n=this.orthoRight)!==null&&n!==void 0?n:m,(o=this.orthoBottom)!==null&&o!==void 0?o:-_,(a=this.orthoTop)!==null&&a!==void 0?a:_,this.minZ,this.maxZ,this._projectionMatrix,h.isNDCHalfZRange):B.OrthoOffCenterLHToRef((s=this.orthoLeft)!==null&&s!==void 0?s:-m,(f=this.orthoRight)!==null&&f!==void 0?f:m,(u=this.orthoBottom)!==null&&u!==void 0?u:-_,(l=this.orthoTop)!==null&&l!==void 0?l:_,this.minZ,this.maxZ,this._projectionMatrix,h.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=h.getRenderWidth(),this._cache.renderHeight=h.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix},e.prototype.getTransformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},e.prototype._updateFrustumPlanes=function(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?_i.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=_i.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},e.prototype.isInFrustum=function(t,i){if(i===void 0&&(i=!1),this._updateFrustumPlanes(),i&&this.rigCameras.length>0){var n=!1;return this.rigCameras.forEach(function(o){o._updateFrustumPlanes(),n=n||t.isInFrustum(o._frustumPlanes)}),n}else return t.isInFrustum(this._frustumPlanes)},e.prototype.isCompletelyInFrustum=function(t){return this._updateFrustumPlanes(),t.isCompletelyInFrustum(this._frustumPlanes)},e.prototype.getForwardRay=function(t,i,n){throw t===void 0&&(t=100),Q("Ray")},e.prototype.getForwardRayToRef=function(t,i,n,o){throw i===void 0&&(i=100),Q("Ray")},e.prototype.dispose=function(t,i){for(i===void 0&&(i=!1),this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){var o=this._parentContainer.cameras.indexOf(this);o>-1&&this._parentContainer.cameras.splice(o,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==e.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else for(var a=this._postProcesses.length;--a>=0;){var s=this._postProcesses[a];s&&s.dispose(this)}for(var f=this.customRenderTargets.length;--f>=0;)this.customRenderTargets[f].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),r.prototype.dispose.call(this,t,i)},Object.defineProperty(e.prototype,"isLeftCamera",{get:function(){return this._isLeftCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRightCamera",{get:function(){return this._isRightCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"leftCamera",{get:function(){return this._rigCameras.length<1?null:this._rigCameras[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rightCamera",{get:function(){return this._rigCameras.length<2?null:this._rigCameras[1]},enumerable:!1,configurable:!0}),e.prototype.getLeftTarget=function(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()},e.prototype.getRightTarget=function(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()},e.prototype.setCameraRigMode=function(t,i){if(this.cameraRigMode!==t){for(;this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=i.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=he.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==e.RIG_MODE_NONE){var o=this.createRigCamera(this.name+"_L",0);o&&(o._isLeftCamera=!0);var a=this.createRigCamera(this.name+"_R",1);a&&(a._isRightCamera=!0),o&&a&&(this._rigCameras.push(o),this._rigCameras.push(a))}this._setRigMode(i),this._cascadePostProcessesToRigCams(),this.update()}},e.prototype._setRigMode=function(t){},e.prototype._getVRProjectionMatrix=function(){return B.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},e.prototype._updateCameraRotationMatrix=function(){},e.prototype._updateWebVRCameraRotationMatrix=function(){},e.prototype._getWebVRProjectionMatrix=function(){return B.Identity()},e.prototype._getWebVRViewMatrix=function(){return B.Identity()},e.prototype.setCameraRigParameter=function(t,i){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[t]=i,t==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=he.ToRadians(i/.0637))},e.prototype.createRigCamera=function(t,i){return null},e.prototype._updateRigCameras=function(){for(var t=0;t<this._rigCameras.length;t++)this._rigCameras[t].minZ=this.minZ,this._rigCameras[t].maxZ=this.maxZ,this._rigCameras[t].fov=this.fov,this._rigCameras[t].upVector.copyFrom(this.upVector);this.cameraRigMode===e.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},e.prototype._setupInputs=function(){},e.prototype.serialize=function(){var t=te.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(t),this.inputs&&this.inputs.serialize(t),te.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t},e.prototype.clone=function(t,i){i===void 0&&(i=null);var n=te.Clone(e.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return n.name=t,n.parent=i,this.onClonedObservable.notifyObservers(n),n},e.prototype.getDirection=function(t){var i=E.Zero();return this.getDirectionToRef(t,i),i},Object.defineProperty(e.prototype,"absoluteRotation",{get:function(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation},enumerable:!1,configurable:!0}),e.prototype.getDirectionToRef=function(t,i){E.TransformNormalToRef(t,this.getWorldMatrix(),i)},e.GetConstructorFromName=function(t,i,n,o,a){o===void 0&&(o=0),a===void 0&&(a=!0);var s=gt.Construct(t,i,n,{interaxial_distance:o,isStereoscopicSideBySide:a});return s||function(){return e._CreateDefaultParsedCamera(i,n)}},e.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()},e.Parse=function(t,i){var n=t.type,o=e.GetConstructorFromName(n,t.name,i,t.interaxial_distance,t.isStereoscopicSideBySide),a=te.Parse(o,t,i);if(t.parentId!==void 0&&(a._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=t.parentInstanceIndex),a.inputs&&(a.inputs.parse(t),a._setupInputs()),t.upVector&&(a.upVector=E.FromArray(t.upVector)),a.setPosition&&(a.position.copyFromFloats(0,0,0),a.setPosition(E.FromArray(t.position))),t.target&&a.setTarget&&a.setTarget(E.FromArray(t.target)),t.cameraRigMode){var s=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};a.setCameraRigMode(t.cameraRigMode,s)}if(t.animations){for(var f=0;f<t.animations.length;f++){var u=t.animations[f],l=wt("BABYLON.Animation");l&&a.animations.push(l.Parse(u))}gt.ParseAnimationRanges(a,t,i)}return t.autoAnimate&&i.beginAnimation(a,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&a.setEnabled(t.isEnabled),a},e._CreateDefaultParsedCamera=function(t,i){throw Q("UniversalCamera")},e.PERSPECTIVE_CAMERA=0,e.ORTHOGRAPHIC_CAMERA=1,e.FOVMODE_VERTICAL_FIXED=0,e.FOVMODE_HORIZONTAL_FIXED=1,e.RIG_MODE_NONE=0,e.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,e.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,e.RIG_MODE_STEREOSCOPIC_INTERLACED=14,e.RIG_MODE_VR=20,e.RIG_MODE_WEBVR=21,e.RIG_MODE_CUSTOM=22,e.ForceAttachControlToAlwaysPreventDefault=!1,x([At("position")],e.prototype,"_position",void 0),x([At("upVector")],e.prototype,"_upVector",void 0),x([O()],e.prototype,"orthoLeft",null),x([O()],e.prototype,"orthoRight",null),x([O()],e.prototype,"orthoBottom",null),x([O()],e.prototype,"orthoTop",null),x([O()],e.prototype,"fov",void 0),x([O()],e.prototype,"projectionPlaneTilt",void 0),x([O()],e.prototype,"minZ",void 0),x([O()],e.prototype,"maxZ",void 0),x([O()],e.prototype,"inertia",void 0),x([O()],e.prototype,"mode",null),x([O()],e.prototype,"layerMask",void 0),x([O()],e.prototype,"fovMode",void 0),x([O()],e.prototype,"cameraRigMode",void 0),x([O()],e.prototype,"interaxialDistance",void 0),x([O()],e.prototype,"isStereoscopicSideBySide",void 0),e}(gt);v();v();var Ea=function(){function r(){this._count=0,this._data={}}return r.prototype.copyFrom=function(e){var t=this;this.clear(),e.forEach(function(i,n){return t.add(i,n)})},r.prototype.get=function(e){var t=this._data[e];if(t!==void 0)return t},r.prototype.getOrAddWithFactory=function(e,t){var i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i},r.prototype.getOrAdd=function(e,t){var i=this.get(e);return i!==void 0?i:(this.add(e,t),t)},r.prototype.contains=function(e){return this._data[e]!==void 0},r.prototype.add=function(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)},r.prototype.set=function(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)},r.prototype.getAndRemove=function(e){var t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null},r.prototype.remove=function(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1},r.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(r.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),r.prototype.forEach=function(e){for(var t in this._data){var i=this._data[t];e(t,i)}},r.prototype.first=function(e){for(var t in this._data){var i=this._data[t],n=e(t,i);if(n)return n}return null},r}();v();var Ch=function(){function r(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}return r.AddParser=function(e,t){this._BabylonFileParsers[e]=t},r.GetParser=function(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null},r.AddIndividualParser=function(e,t){this._IndividualBabylonFileParsers[e]=t},r.GetIndividualParser=function(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null},r.Parse=function(e,t,i,n){for(var o in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,o)&&this._BabylonFileParsers[o](e,t,i,n)},Object.defineProperty(r.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(e){this._environmentTexture=e},enumerable:!1,configurable:!0}),r.prototype.getNodes=function(){var e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(function(t){return e=e.concat(t.bones)}),e},r._BabylonFileParsers={},r._IndividualBabylonFileParsers={},r}();v();v();var vi=function(){function r(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}return Object.defineProperty(r.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:!1,configurable:!0}),r.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1},r.prototype.markAsUnprocessed=function(){this._isDirty=!0},r.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},r.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},r.prototype.markAsLightDirty=function(e){e===void 0&&(e=!1),this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0},r.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},r.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},r.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},r.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},r.prototype.markAsPrePassDirty=function(){this._arePrePassDirty=!0,this._isDirty=!0},r.prototype.rebuild=function(){this._keys.length=0;for(var e=0,t=Object.keys(this);e<t.length;e++){var i=t[e];i[0]!=="_"&&this._keys.push(i)}if(this._externalProperties)for(var n in this._externalProperties)this._keys.indexOf(n)===-1&&this._keys.push(n)},r.prototype.isEqual=function(e){if(this._keys.length!==e._keys.length)return!1;for(var t=0;t<this._keys.length;t++){var i=this._keys[t];if(this[i]!==e[i])return!1}return!0},r.prototype.cloneTo=function(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(var t=0;t<this._keys.length;t++){var i=this._keys[t];e[i]=this[i]}},r.prototype.reset=function(){var e=this;this._keys.forEach(function(t){return e._setDefaultValue(t)})},r.prototype._setDefaultValue=function(e){var t,i,n,o,a,s=(n=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&n!==void 0?n:typeof this[e],f=(a=(o=this._externalProperties)===null||o===void 0?void 0:o[e])===null||a===void 0?void 0:a.default;switch(s){case"number":this[e]=f!=null?f:0;break;case"string":this[e]=f!=null?f:"";break;default:this[e]=f!=null?f:!1;break}},r.prototype.toString=function(){for(var e="",t=0;t<this._keys.length;t++){var i=this._keys[t],n=this[i],o=typeof n;switch(o){case"number":case"string":e+="#define "+i+" "+n+`
`;break;default:n&&(e+="#define "+i+`
`);break}}return e},r}();v();var Xi=function(){function r(){this._dirty=!0,this._tempColor=new Ae(0,0,0,0),this._globalCurve=new Ae(0,0,0,0),this._highlightsCurve=new Ae(0,0,0,0),this._midtonesCurve=new Ae(0,0,0,0),this._shadowsCurve=new Ae(0,0,0,0),this._positiveCurve=new Ae(0,0,0,0),this._negativeCurve=new Ae(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(r.prototype,"globalHue",{get:function(){return this._globalHue},set:function(e){this._globalHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(e){this._globalDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(e){this._globalSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"globalExposure",{get:function(){return this._globalExposure},set:function(e){this._globalExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(e){this._highlightsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(e){this._highlightsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(e){this._highlightsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(e){this._highlightsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(e){this._midtonesHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(e){this._midtonesDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(e){this._midtonesSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(e){this._midtonesExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(e){this._shadowsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(e){this._shadowsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(e){this._shadowsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(e){this._shadowsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ColorCurves"},r.Bind=function(e,t,i,n,o){i===void 0&&(i="vCameraColorCurvePositive"),n===void 0&&(n="vCameraColorCurveNeutral"),o===void 0&&(o="vCameraColorCurveNegative"),e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(o,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))},r.PrepareUniforms=function(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},r.prototype._getColorGradingDataToRef=function(e,t,i,n,o){e!=null&&(e=r._Clamp(e,0,360),t=r._Clamp(t,-100,100),i=r._Clamp(i,-100,100),n=r._Clamp(n,-100,100),t=r._ApplyColorGradingSliderNonlinear(t),t*=.5,n=r._ApplyColorGradingSliderNonlinear(n),t<0&&(t*=-1,e=(e+180)%360),r._FromHSBToRef(e,t,50+.25*n,o),o.scaleToRef(2,o),o.a=1+.01*i)},r._ApplyColorGradingSliderNonlinear=function(e){e/=100;var t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t},r._FromHSBToRef=function(e,t,i,n){var o=r._Clamp(e,0,360),a=r._Clamp(t/100,0,1),s=r._Clamp(i/100,0,1);if(a===0)n.r=s,n.g=s,n.b=s;else{o/=60;var f=Math.floor(o),u=o-f,l=s*(1-a),h=s*(1-a*u),c=s*(1-a*(1-u));switch(f){case 0:n.r=s,n.g=c,n.b=l;break;case 1:n.r=h,n.g=s,n.b=l;break;case 2:n.r=l,n.g=s,n.b=c;break;case 3:n.r=l,n.g=h,n.b=s;break;case 4:n.r=c,n.g=l,n.b=s;break;default:n.r=s,n.g=l,n.b=h;break}}n.a=1},r._Clamp=function(e,t,i){return Math.min(Math.max(e,t),i)},r.prototype.clone=function(){return te.Clone(function(){return new r},this)},r.prototype.serialize=function(){return te.Serialize(this)},r.Parse=function(e){return te.Parse(function(){return new r},e,null,null)},x([O()],r.prototype,"_globalHue",void 0),x([O()],r.prototype,"_globalDensity",void 0),x([O()],r.prototype,"_globalSaturation",void 0),x([O()],r.prototype,"_globalExposure",void 0),x([O()],r.prototype,"_highlightsHue",void 0),x([O()],r.prototype,"_highlightsDensity",void 0),x([O()],r.prototype,"_highlightsSaturation",void 0),x([O()],r.prototype,"_highlightsExposure",void 0),x([O()],r.prototype,"_midtonesHue",void 0),x([O()],r.prototype,"_midtonesDensity",void 0),x([O()],r.prototype,"_midtonesSaturation",void 0),x([O()],r.prototype,"_midtonesExposure",void 0),r}();te._ColorCurvesParser=Xi.Parse;var px=function(r){Y(e,r);function e(){var t=r.call(this)||this;return t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.EXPOSURE=!1,t.SKIPFINALCOLORCLAMP=!1,t.rebuild(),t}return e}(vi);var mr=function(){function r(){this.colorCurves=new Xi,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=r.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new Ae(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=r.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new U}return Object.defineProperty(r.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"colorGradingTexture",{get:function(){return this._colorGradingTexture},set:function(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"exposure",{get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"toneMappingType",{get:function(){return this._toneMappingType},set:function(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"contrast",{get:function(){return this._contrast},set:function(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"skipFinalColorClamp",{get:function(){return this._skipFinalColorClamp},set:function(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),r.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)},r.prototype.getClassName=function(){return"ImageProcessingConfiguration"},r.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),t.VIGNETTE&&(e.push("vInverseScreenSize"),e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Xi.PrepareUniforms(e)},r.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},r.prototype.prepareDefines=function(e,t){if(t===void 0&&(t=!1),t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===r._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case r.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING},r.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()},r.prototype.bind=function(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Xi.Bind(this.colorCurves,e),this._vignetteEnabled){var i=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();e.setFloat2("vInverseScreenSize",i,n);var o=t!=null?t:n/i,a=Math.tan(this.vignetteCameraFov*.5),s=a*o,f=Math.sqrt(s*a);s=he.Mix(s,f,this.vignetteStretch),a=he.Mix(a,f,this.vignetteStretch),e.setFloat4("vignetteSettings1",s,a,-s*this.vignetteCentreX,-a*this.vignetteCentreY);var u=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,u)}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);var l=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(l-1)/l,.5/l,l,this.colorGradingTexture.level)}},r.prototype.clone=function(){return te.Clone(function(){return new r},this)},r.prototype.serialize=function(){return te.Serialize(this)},r.Parse=function(e){return te.Parse(function(){return new r},e,null,null)},Object.defineProperty(r,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:!1,configurable:!0}),Object.defineProperty(r,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:!1,configurable:!0}),r.TONEMAPPING_STANDARD=0,r.TONEMAPPING_ACES=1,r._VIGNETTEMODE_MULTIPLY=0,r._VIGNETTEMODE_OPAQUE=1,x([bh()],r.prototype,"colorCurves",void 0),x([O()],r.prototype,"_colorCurvesEnabled",void 0),x([at("colorGradingTexture")],r.prototype,"_colorGradingTexture",void 0),x([O()],r.prototype,"_colorGradingEnabled",void 0),x([O()],r.prototype,"_colorGradingWithGreenDepth",void 0),x([O()],r.prototype,"_colorGradingBGR",void 0),x([O()],r.prototype,"_exposure",void 0),x([O()],r.prototype,"_toneMappingEnabled",void 0),x([O()],r.prototype,"_toneMappingType",void 0),x([O()],r.prototype,"_contrast",void 0),x([O()],r.prototype,"vignetteStretch",void 0),x([O()],r.prototype,"vignetteCentreX",void 0),x([O()],r.prototype,"vignetteCentreY",void 0),x([O()],r.prototype,"vignetteWeight",void 0),x([Eh()],r.prototype,"vignetteColor",void 0),x([O()],r.prototype,"vignetteCameraFov",void 0),x([O()],r.prototype,"_vignetteBlendMode",void 0),x([O()],r.prototype,"_vignetteEnabled",void 0),x([O()],r.prototype,"_skipFinalColorClamp",void 0),x([O()],r.prototype,"_applyByPostProcess",void 0),x([O()],r.prototype,"_isEnabled",void 0),r}();te._ImageProcessingConfigurationParser=mr.Parse;v();var it=function(){function r(e,t,i,n,o,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=n,this.sourceEvent=o,this.additionalData=a}return r.CreateNew=function(e,t,i){var n=e.getScene();return new r(e,n.pointerX,n.pointerY,n.meshUnderPointer||e,t,i)},r.CreateNewFromSprite=function(e,t,i,n){return new r(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,n)},r.CreateNewFromScene=function(e,t){return new r(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)},r.CreateNewFromPrimitive=function(e,t,i,n){return new r(e,t.x,t.y,null,i,n)},r}();v();var Ta=function(){function r(e){this._vertexBuffers={},this._scene=e}return r.prototype._prepareBuffers=function(){if(!this._vertexBuffers[b.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[b.PositionKind]=new b(this._scene.getEngine(),e,b.PositionKind,!1,!1,2),this._buildIndexBuffer()}},r.prototype._buildIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)},r.prototype._rebuild=function(){var e=this._vertexBuffers[b.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())},r.prototype._prepareFrame=function(e,t){e===void 0&&(e=null),t===void 0&&(t=null);var i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(function(n){return n!=null}),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)},r.prototype.directRender=function(e,t,i,n,o,a){var s;t===void 0&&(t=null),i===void 0&&(i=!1),n===void 0&&(n=0),o===void 0&&(o=0),a===void 0&&(a=!1);for(var f=this._scene.getEngine(),u=0;u<e.length;u++){u<e.length-1?e[u+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?f.bindFramebuffer(t,n,void 0,void 0,i,o):a||f.restoreDefaultFramebuffer(),(s=f._debugInsertMarker)===null||s===void 0||s.call(f,"post process ".concat(e[u].name," output")));var l=e[u],h=l.apply();h&&(l.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),f.bindBuffers(this._vertexBuffers,this._indexBuffer,h),f.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(h))}f.setDepthBuffer(!0),f.setDepthWrite(!0)},r.prototype._finalizeFrame=function(e,t,i,n,o){var a;o===void 0&&(o=!1);var s=this._scene.activeCamera;if(!!s&&(n=n||s._postProcesses.filter(function(p){return p!=null}),!(n.length===0||!this._scene.postProcessesEnabled))){for(var f=this._scene.getEngine(),u=0,l=n.length;u<l;u++){var h=n[u];if(u<l-1?h._outputTexture=n[u+1].activate(s,t==null?void 0:t.texture):(t?(f.bindFramebuffer(t,i,void 0,void 0,o),h._outputTexture=t):(f.restoreDefaultFramebuffer(),h._outputTexture=null),(a=f._debugInsertMarker)===null||a===void 0||a.call(f,"post process ".concat(n[u].name," output"))),e)break;var c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),f.bindBuffers(this._vertexBuffers,this._indexBuffer,c),f.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}f.setDepthBuffer(!0),f.setDepthWrite(!0),f.setAlphaMode(0)}},r.prototype.dispose=function(){var e=this._vertexBuffers[b.PositionKind];e&&(e.dispose(),this._vertexBuffers[b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},r}();v();v();var Ih=function(){function r(e,t,i,n,o){i===void 0&&(i=null),n===void 0&&(n=null),o===void 0&&(o=null),this.index=e,this._opaqueSubMeshes=new st(256),this._transparentSubMeshes=new st(256),this._alphaTestSubMeshes=new st(256),this._depthOnlySubMeshes=new st(256),this._particleSystems=new st(256),this._spriteManagers=new st(256),this._empty=!0,this._edgesRenderers=new Nt(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=o}return Object.defineProperty(r.prototype,"opaqueSortCompareFn",{set:function(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=r.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaTestSortCompareFn",{set:function(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=r.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"transparentSortCompareFn",{set:function(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=r.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted},enumerable:!1,configurable:!0}),r.prototype.render=function(e,t,i,n){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}var o=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(o.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),o.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);var a=o.getStencilBuffer();if(o.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(o.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){var s=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);s.length&&this._renderTransparent(s)}else this._renderTransparent(this._transparentSubMeshes);o.setAlphaMode(0)}if(o.setStencilBuffer(!1),this._edgesRenderers.length){for(var f=0;f<this._edgesRenderers.length;f++)this._edgesRenderers.data[f].render();o.setAlphaMode(0)}o.setStencilBuffer(a)},r.prototype._renderOpaqueSorted=function(e){return r._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},r.prototype._renderAlphaTestSorted=function(e){return r._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},r.prototype._renderTransparentSorted=function(e){return r._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)},r._RenderSorted=function(e,t,i,n){var o=0,a,s=i?i.globalPosition:r._ZeroVector;if(n)for(;o<e.length;o++)a=e.data[o],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=E.Distance(a.getBoundingInfo().boundingSphere.centerWorld,s);var f=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&f.sort(t);var u=f[0].getMesh().getScene();for(o=0;o<f.length;o++)if(a=f[o],!(u._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(u._frustumPlanes))){if(n){var l=a.getMaterial();if(l&&l.needDepthPrePass){var h=l.getScene().getEngine();h.setColorWrite(!1),h.setAlphaMode(0),a.render(!1),h.setColorWrite(!0)}}a.render(n)}},r.defaultTransparentSortCompare=function(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:r.backToFrontSortCompare(e,t)},r.backToFrontSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0},r.frontToBackSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0},r.PainterSortCompare=function(e,t){var i=e.getMesh(),n=t.getMesh();return i.material&&n.material?i.material.uniqueId-n.material.uniqueId:i.uniqueId-n.uniqueId},r.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset(),this._empty=!0},r.prototype.dispose=function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},r.prototype.dispatch=function(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)},r.prototype.dispatchSprites=function(e){this._spriteManagers.push(e),this._empty=!1},r.prototype.dispatchParticles=function(e){this._particleSystems.push(e),this._empty=!1},r.prototype._renderParticles=function(e){if(this._particleSystems.length!==0){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var i=0;i<this._particleSystems.length;i++){var n=this._particleSystems.data[i];if((t&&t.layerMask&n.layerMask)!==0){var o=n.emitter;(!o.position||!e||e.indexOf(o)!==-1)&&this._scene._activeParticles.addCount(n.render(),!1)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},r.prototype._renderSprites=function(){if(!(!this._scene.spritesEnabled||this._spriteManagers.length===0)){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},r._ZeroVector=E.Zero(),r}();var Sv=function(){function r(){}return r}();var Dh=function(){function r(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new Sv,this._scene=e;for(var t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}return r.prototype._clearDepthStencilBuffer=function(e,t){e===void 0&&(e=!0),t===void 0&&(t=!0),!this._depthStencilBufferAlreadyCleaned&&(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)},r.prototype.render=function(e,t,i,n){var o=this._renderingGroupInfo;if(o.scene=this._scene,o.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(var a=0;a<this._scene.spriteManagers.length;a++){var s=this._scene.spriteManagers[a];this.dispatchSprites(s)}for(var a=r.MIN_RENDERINGGROUPS;a<r.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===r.MIN_RENDERINGGROUPS;var f=this._renderingGroups[a];if(!(!f||f._empty)){var u=Math.pow(2,a);if(o.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(o,u),r.AUTOCLEAR){var l=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];l&&l.autoClear&&this._clearDepthStencilBuffer(l.depth,l.stencil)}for(var h=0,c=this._scene._beforeRenderingGroupDrawStage;h<c.length;h++){var p=c[h];p.action(a)}f.render(e,n,i,t);for(var d=0,m=this._scene._afterRenderingGroupDrawStage;d<m.length;d++){var p=m[d];p.action(a)}this._scene.onAfterRenderingGroupObservable.notifyObservers(o,u)}}},r.prototype.reset=function(){for(var e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.prepare()}},r.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null},r.prototype.freeRenderingGroups=function(){for(var e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.dispose()}},r.prototype._prepareRenderingGroup=function(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Ih(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))},r.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchSprites(e)},r.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchParticles(e)},r.prototype.dispatch=function(e,t,i){t===void 0&&(t=e.getMesh());var n=t.renderingGroupId||0;this._prepareRenderingGroup(n),this._renderingGroups[n].dispatch(e,t,i)},r.prototype.setRenderingOrder=function(e,t,i,n){if(t===void 0&&(t=null),i===void 0&&(i=null),n===void 0&&(n=null),this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=n,this._renderingGroups[e]){var o=this._renderingGroups[e];o.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],o.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],o.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}},r.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,n){i===void 0&&(i=!0),n===void 0&&(n=!0),this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:n}},r.prototype.getAutoClearDepthStencilSetup=function(e){return this._autoClearDepthStencil[e]},r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r}();v();var Lr=function(){function r(){}return r.NAME_EFFECTLAYER="EffectLayer",r.NAME_LAYER="Layer",r.NAME_LENSFLARESYSTEM="LensFlareSystem",r.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",r.NAME_PARTICLESYSTEM="ParticleSystem",r.NAME_GAMEPAD="Gamepad",r.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",r.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",r.NAME_PREPASSRENDERER="PrePassRenderer",r.NAME_DEPTHRENDERER="DepthRenderer",r.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",r.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",r.NAME_SPRITE="Sprite",r.NAME_SUBSURFACE="SubSurface",r.NAME_OUTLINERENDERER="Outline",r.NAME_PROCEDURALTEXTURE="ProceduralTexture",r.NAME_SHADOWGENERATOR="ShadowGenerator",r.NAME_OCTREE="Octree",r.NAME_PHYSICSENGINE="PhysicsEngine",r.NAME_AUDIO="Audio",r.STEP_ISREADYFORMESH_EFFECTLAYER=0,r.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,r.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_PREPASS=0,r.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_LAYER=2,r.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,r.STEP_BEFORERENDERTARGETDRAW_LAYER=1,r.STEP_BEFORERENDERINGMESH_PREPASS=0,r.STEP_BEFORERENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGMESH_PREPASS=0,r.STEP_AFTERRENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,r.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,r.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,r.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,r.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,r.STEP_BEFORECLEAR_PREPASS=1,r.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_LAYER=1,r.STEP_AFTERCAMERADRAW_PREPASS=0,r.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,r.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,r.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,r.STEP_AFTERCAMERADRAW_LAYER=4,r.STEP_AFTERRENDER_AUDIO=0,r.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,r.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,r.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,r.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,r.STEP_POINTERMOVE_SPRITE=0,r.STEP_POINTERDOWN_SPRITE=0,r.STEP_POINTERUP_SPRITE=0,r}();var Ne=function(r){Y(e,r);function e(t){return r.apply(this,t)||this}return e.Create=function(){return Object.create(e.prototype)},e.prototype.registerStep=function(t,i,n){for(var o=0,a=Number.MAX_VALUE;o<this.length;o++){var s=this[o];if(a=s.index,t<a)break}this.splice(o,0,{index:t,component:i,action:n.bind(i)})},e.prototype.clear=function(){this.length=0},e}(Array);v();v();var ne=function(){function r(){}return r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64,r}();var Oh=function(){function r(e,t){this.type=e,this.event=t}return r}();var Fh=function(r){Y(e,r);function e(t,i,n,o){var a=r.call(this,t,i)||this;return a.ray=null,a.skipOnPointerObservable=!1,a.localPosition=new _e(n,o),a}return e}(Oh);var mi=function(r){Y(e,r);function e(t,i,n){var o=r.call(this,t,i)||this;return o.pickInfo=n,o}return e}(Oh);v();var gi=function(){function r(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}return Object.defineProperty(r,"HasTriggers",{get:function(){for(var e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e))return!0;return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r,"HasPickTriggers",{get:function(){for(var e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e)){var t=parseInt(e);if(t>=1&&t<=7)return!0}return!1},enumerable:!1,configurable:!0}),r.HasSpecificTrigger=function(e){for(var t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t)){var i=parseInt(t);if(i===e)return!0}return!1},r.Triggers={},r}();v();var Hi=function(){function r(){}return r.KEYDOWN=1,r.KEYUP=2,r}();var Kn=function(){function r(e,t){this.type=e,this.event=t}return r}();var Aa=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i)||this;return n.type=t,n.event=i,n.skipOnKeyboardObservable=!1,n}return Object.defineProperty(e.prototype,"skipOnPointerObservable",{get:function(){return this.skipOnKeyboardObservable},set:function(t){this.skipOnKeyboardObservable=t},enumerable:!1,configurable:!0}),e}(Kn);v();var X;(function(r){r[r.Generic=0]="Generic",r[r.Keyboard=1]="Keyboard",r[r.Mouse=2]="Mouse",r[r.Touch=3]="Touch",r[r.DualShock=4]="DualShock",r[r.Xbox=5]="Xbox",r[r.Switch=6]="Switch",r[r.DualSense=7]="DualSense"})(X||(X={}));var ee;(function(r){r[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.Move=12]="Move"})(ee||(ee={}));var Ki;(function(r){r[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.DeltaHorizontal=10]="DeltaHorizontal",r[r.DeltaVertical=11]="DeltaVertical"})(Ki||(Ki={}));var wh;(function(r){r[r.Cross=0]="Cross",r[r.Circle=1]="Circle",r[r.Square=2]="Square",r[r.Triangle=3]="Triangle",r[r.L1=4]="L1",r[r.R1=5]="R1",r[r.L2=6]="L2",r[r.R2=7]="R2",r[r.Share=8]="Share",r[r.Options=9]="Options",r[r.L3=10]="L3",r[r.R3=11]="R3",r[r.DPadUp=12]="DPadUp",r[r.DPadDown=13]="DPadDown",r[r.DPadLeft=14]="DPadLeft",r[r.DPadRight=15]="DPadRight",r[r.Home=16]="Home",r[r.TouchPad=17]="TouchPad",r[r.LStickXAxis=18]="LStickXAxis",r[r.LStickYAxis=19]="LStickYAxis",r[r.RStickXAxis=20]="RStickXAxis",r[r.RStickYAxis=21]="RStickYAxis"})(wh||(wh={}));var Lh;(function(r){r[r.Cross=0]="Cross",r[r.Circle=1]="Circle",r[r.Square=2]="Square",r[r.Triangle=3]="Triangle",r[r.L1=4]="L1",r[r.R1=5]="R1",r[r.L2=6]="L2",r[r.R2=7]="R2",r[r.Create=8]="Create",r[r.Options=9]="Options",r[r.L3=10]="L3",r[r.R3=11]="R3",r[r.DPadUp=12]="DPadUp",r[r.DPadDown=13]="DPadDown",r[r.DPadLeft=14]="DPadLeft",r[r.DPadRight=15]="DPadRight",r[r.Home=16]="Home",r[r.TouchPad=17]="TouchPad",r[r.LStickXAxis=18]="LStickXAxis",r[r.LStickYAxis=19]="LStickYAxis",r[r.RStickXAxis=20]="RStickXAxis",r[r.RStickYAxis=21]="RStickYAxis"})(Lh||(Lh={}));var Bh;(function(r){r[r.A=0]="A",r[r.B=1]="B",r[r.X=2]="X",r[r.Y=3]="Y",r[r.LB=4]="LB",r[r.RB=5]="RB",r[r.LT=6]="LT",r[r.RT=7]="RT",r[r.Back=8]="Back",r[r.Start=9]="Start",r[r.LS=10]="LS",r[r.RS=11]="RS",r[r.DPadUp=12]="DPadUp",r[r.DPadDown=13]="DPadDown",r[r.DPadLeft=14]="DPadLeft",r[r.DPadRight=15]="DPadRight",r[r.Home=16]="Home",r[r.LStickXAxis=17]="LStickXAxis",r[r.LStickYAxis=18]="LStickYAxis",r[r.RStickXAxis=19]="RStickXAxis",r[r.RStickYAxis=20]="RStickYAxis"})(Bh||(Bh={}));var Nh;(function(r){r[r.B=0]="B",r[r.A=1]="A",r[r.Y=2]="Y",r[r.X=3]="X",r[r.L=4]="L",r[r.R=5]="R",r[r.ZL=6]="ZL",r[r.ZR=7]="ZR",r[r.Minus=8]="Minus",r[r.Plus=9]="Plus",r[r.LS=10]="LS",r[r.RS=11]="RS",r[r.DPadUp=12]="DPadUp",r[r.DPadDown=13]="DPadDown",r[r.DPadLeft=14]="DPadLeft",r[r.DPadRight=15]="DPadRight",r[r.Home=16]="Home",r[r.Capture=17]="Capture",r[r.LStickXAxis=18]="LStickXAxis",r[r.LStickYAxis=19]="LStickYAxis",r[r.RStickXAxis=20]="RStickXAxis",r[r.RStickYAxis=21]="RStickYAxis"})(Nh||(Nh={}));v();v();v();v();v();var Uh;(function(r){r[r.PointerMove=0]="PointerMove",r[r.PointerDown=1]="PointerDown",r[r.PointerUp=2]="PointerUp"})(Uh||(Uh={}));var jn=function(){function r(){}return r.DOM_DELTA_PIXEL=0,r.DOM_DELTA_LINE=1,r.DOM_DELTA_PAGE=2,r}();var or=function(){function r(){}return r.CreateDeviceEvent=function(e,t,i,n,o,a){switch(e){case X.Keyboard:return this._CreateKeyboardEvent(i,n,o,a);case X.Mouse:if(i===ee.MouseWheelX||i===ee.MouseWheelY||i===ee.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,o,a);case X.Touch:return this._CreatePointerEvent(e,t,i,n,o,a);default:throw"Unable to generate event for device ".concat(X[e])}},r._CreatePointerEvent=function(e,t,i,n,o,a){var s=this._CreateMouseEvent(e,t,i,n,o,a);return e===X.Mouse?(s.deviceType=X.Mouse,s.pointerId=1,s.pointerType="mouse"):(s.deviceType=X.Touch,s.pointerId=t,s.pointerType="touch"),i===ee.Move?s.type="pointermove":i>=ee.LeftClick&&i<=ee.RightClick&&(s.type=n===1?"pointerdown":"pointerup",s.button=i-2),s},r._CreateWheelEvent=function(e,t,i,n,o,a){var s=this._CreateMouseEvent(e,t,i,n,o,a);switch(s.type="wheel",s.deltaMode=jn.DOM_DELTA_PIXEL,s.deltaX=0,s.deltaY=0,s.deltaZ=0,i){case ee.MouseWheelX:s.deltaX=n;break;case ee.MouseWheelY:s.deltaY=n;break;case ee.MouseWheelZ:s.deltaZ=n;break}return s},r._CreateMouseEvent=function(e,t,i,n,o,a){var s=this._CreateEvent(a),f=o.pollInput(e,t,ee.Horizontal),u=o.pollInput(e,t,ee.Vertical);return a?(s.movementX=0,s.movementY=0,s.offsetX=s.movementX-a.getBoundingClientRect().x,s.offsetY=s.movementY-a.getBoundingClientRect().y):(s.movementX=o.pollInput(e,t,Ki.DeltaHorizontal),s.movementY=o.pollInput(e,t,Ki.DeltaVertical),s.offsetX=0,s.offsetY=0),this._CheckNonCharacterKeys(s,o),s.clientX=f,s.clientY=u,s.x=f,s.y=u,s.deviceType=e,s.deviceSlot=t,s.inputIndex=i,s},r._CreateKeyboardEvent=function(e,t,i,n){var o=this._CreateEvent(n);return this._CheckNonCharacterKeys(o,i),o.deviceType=X.Keyboard,o.deviceSlot=0,o.inputIndex=e,o.type=t===1?"keydown":"keyup",o.key=String.fromCharCode(e),o.keyCode=e,o},r._CheckNonCharacterKeys=function(e,t){var i=t.isDeviceAvailable(X.Keyboard),n=i&&t.pollInput(X.Keyboard,0,18)===1,o=i&&t.pollInput(X.Keyboard,0,17)===1,a=i&&(t.pollInput(X.Keyboard,0,91)===1||t.pollInput(X.Keyboard,0,92)===1||t.pollInput(X.Keyboard,0,93)===1),s=i&&t.pollInput(X.Keyboard,0,16)===1;e.altKey=n,e.ctrlKey=o,e.metaKey=a,e.shiftKey=s},r._CreateEvent=function(e){var t={};return t.preventDefault=function(){},t.target=e,t},r}();var kh=function(){function r(e,t,i){var n=this;this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,function(o,a,s,f){var u=or.CreateDeviceEvent(o,a,s,f,n);i(o,a,u)}):this._createDummyNativeInput()}return r.prototype.pollInput=function(e,t,i){return this._nativeInput.pollInput(e,t,i)},r.prototype.isDeviceAvailable=function(e){return e===X.Mouse||e===X.Touch},r.prototype.dispose=function(){this._nativeInput.dispose()},r.prototype._createDummyNativeInput=function(){var e={pollInput:function(){return 0},isDeviceAvailable:function(){return!1},dispose:function(){}};return e},r}();v();var Vh=255,Wh=Object.keys(ee).length/2,Gh=function(){function r(e,t,i,n){var o=this;this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=he.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=function(a){},this._keyboardUpEvent=function(a){},this._keyboardBlurEvent=function(a){},this._pointerMoveEvent=function(a){},this._pointerDownEvent=function(a){},this._pointerUpEvent=function(a){},this._pointerCancelEvent=function(a){},this._pointerWheelEvent=function(a){},this._pointerBlurEvent=function(a){},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Ni.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=function(a){},this._gamepadDisconnectedEvent=function(a){},this._eventPrefix=he.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=n,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=function(){o._enableEvents()})}return r.prototype.pollInput=function(e,t,i){var n=this._inputs[e][t];if(!n)throw"Unable to find device ".concat(X[e]);e>=X.DualShock&&e<=X.DualSense&&this._updateDevice(e,t,i);var o=n[i];if(o===void 0)throw"Unable to find input ".concat(i," for device ").concat(X[e]," in slot ").concat(t);return i===ee.Move&&he.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),o},r.prototype.isDeviceAvailable=function(e){return this._inputs[e]!==void 0},r.prototype.dispose=function(){this._onDeviceConnected=function(){},this._onDeviceDisconnected=function(){},this._onInputChanged=function(){},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()},r.prototype._enableEvents=function(){var e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(var t=0,i=this._inputs;t<i.length;t++){var n=i[t];if(n)for(var o in n){var a=+o,s=n[a];if(s)for(var f=0;f<s.length;f++)s[f]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}},r.prototype._disableEvents=function(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1},r.prototype._checkForConnectedDevices=function(){if(navigator.getGamepads)for(var e=navigator.getGamepads(),t=0,i=e;t<i.length;t++){var n=i[t];n&&this._addGamePad(n)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(X.Mouse,0,0,0)},r.prototype._addGamePad=function(e){var t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t},r.prototype._addPointerDevice=function(e,t,i,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Wh);var o=this._inputs[e][t];o[0]=i,o[1]=n},r.prototype._registerDevice=function(e,t,i){if(t===void 0)throw"Unable to register device ".concat(X[e]," to undefined slot.");if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){var n=new Array(i);n.fill(0),this._inputs[e][t]=n,this._onDeviceConnected(e,t)}},r.prototype._unregisterDevice=function(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))},r.prototype._handleKeyActions=function(){var e=this;this._keyboardDownEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(X.Keyboard,0,Vh));var i=e._inputs[X.Keyboard][0];if(i){i[t.keyCode]=1;var n=t;n.inputIndex=t.keyCode,e._usingMacOS&&t.metaKey&&t.key!=="Meta"&&(e._metaKeys.includes(t.keyCode)||e._metaKeys.push(t.keyCode)),e._onInputChanged(X.Keyboard,0,n)}},this._keyboardUpEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(X.Keyboard,0,Vh));var i=e._inputs[X.Keyboard][0];if(i){i[t.keyCode]=0;var n=t;if(n.inputIndex=t.keyCode,e._usingMacOS&&t.key==="Meta"&&e._metaKeys.length>0){for(var o=0,a=e._metaKeys;o<a.length;o++){var s=a[o],f=or.CreateDeviceEvent(X.Keyboard,0,s,0,e,e._elementToAttachTo);i[s]=0,e._onInputChanged(X.Keyboard,0,f)}e._metaKeys.splice(0,e._metaKeys.length)}e._onInputChanged(X.Keyboard,0,n)}},this._keyboardBlurEvent=function(){if(e._keyboardActive){for(var t=e._inputs[X.Keyboard][0],i=0;i<t.length;i++)if(t[i]!==0){t[i]=0;var n=or.CreateDeviceEvent(X.Keyboard,0,i,0,e,e._elementToAttachTo);e._onInputChanged(X.Keyboard,0,n)}e._usingMacOS&&e._metaKeys.splice(0,e._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)},r.prototype._handlePointerActions=function(){var e=this;this._maxTouchPoints=Ni.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(var t=0;t<this._maxTouchPoints;t++)this._activeTouchIds[t]=-1;this._pointerMoveEvent=function(a){var s=e._getPointerType(a),f=s===X.Mouse?0:e._activeTouchIds.indexOf(a.pointerId);e._inputs[s]||(e._inputs[s]={}),e._inputs[s][f]||e._addPointerDevice(s,f,a.clientX,a.clientY);var u=e._inputs[s][f];if(u){u[ee.Horizontal]=a.clientX,u[ee.Vertical]=a.clientY;var l=a;l.inputIndex=ee.Move,e._onInputChanged(s,f,l),!e._usingSafari&&a.button!==-1&&(l.inputIndex=a.button+2,u[a.button+2]=u[a.button+2]?0:1,e._onInputChanged(s,f,l))}},this._pointerDownEvent=function(a){var s=e._getPointerType(a),f=s===X.Mouse?0:a.pointerId;if(s===X.Touch){var u=e._activeTouchIds.indexOf(-1);if(u>=0)f=u,e._activeTouchIds[u]=a.pointerId;else{he.Warn("Max number of touches exceeded.  Ignoring touches in excess of ".concat(e._maxTouchPoints));return}}e._inputs[s]||(e._inputs[s]={}),e._inputs[s][f]?s===X.Touch&&e._onDeviceConnected(s,f):e._addPointerDevice(s,f,a.clientX,a.clientY);var l=e._inputs[s][f];if(l){var h=l[ee.Horizontal],c=l[ee.Vertical];if(s===X.Mouse){if(e._mouseId===-1&&(a.pointerId===void 0?e._mouseId=e._isUsingFirefox?0:1:e._mouseId=a.pointerId),!document.pointerLockElement)try{e._elementToAttachTo.setPointerCapture(e._mouseId)}catch(d){}}else if(a.pointerId&&!document.pointerLockElement)try{e._elementToAttachTo.setPointerCapture(a.pointerId)}catch(d){}l[ee.Horizontal]=a.clientX,l[ee.Vertical]=a.clientY,l[a.button+2]=1;var p=a;p.inputIndex=a.button+2,e._onInputChanged(s,f,p),(h!==a.clientX||c!==a.clientY)&&(p.inputIndex=ee.Move,e._onInputChanged(s,f,p))}},this._pointerUpEvent=function(a){var s,f,u,l,h,c=e._getPointerType(a),p=c===X.Mouse?0:e._activeTouchIds.indexOf(a.pointerId);if(c===X.Touch){if(p===-1)return;e._activeTouchIds[p]=-1}var d=(s=e._inputs[c])===null||s===void 0?void 0:s[p];if(d&&d[a.button+2]!==0){var m=d[ee.Horizontal],_=d[ee.Vertical];d[ee.Horizontal]=a.clientX,d[ee.Vertical]=a.clientY,d[a.button+2]=0;var y=a;(m!==a.clientX||_!==a.clientY)&&(y.inputIndex=ee.Move,e._onInputChanged(c,p,y)),y.inputIndex=a.button+2,c===X.Mouse&&e._mouseId>=0&&((u=(f=e._elementToAttachTo).hasPointerCapture)===null||u===void 0?void 0:u.call(f,e._mouseId))?e._elementToAttachTo.releasePointerCapture(e._mouseId):a.pointerId&&((h=(l=e._elementToAttachTo).hasPointerCapture)===null||h===void 0?void 0:h.call(l,a.pointerId))&&e._elementToAttachTo.releasePointerCapture(a.pointerId),e._onInputChanged(c,p,y),c===X.Touch&&e._onDeviceDisconnected(c,p)}},this._pointerCancelEvent=function(a){var s,f,u,l;if(a.pointerType==="mouse"){var h=e._inputs[X.Mouse][0];e._mouseId>=0&&((f=(s=e._elementToAttachTo).hasPointerCapture)===null||f===void 0?void 0:f.call(s,e._mouseId))&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var c=ee.LeftClick;c<=ee.BrowserForward;c++)if(h[c]===1){h[c]=0;var p=or.CreateDeviceEvent(X.Mouse,0,c,0,e,e._elementToAttachTo);e._onInputChanged(X.Mouse,0,p)}}else{var d=e._activeTouchIds.indexOf(a.pointerId);!((l=(u=e._elementToAttachTo).hasPointerCapture)===null||l===void 0)&&l.call(u,a.pointerId)&&e._elementToAttachTo.releasePointerCapture(a.pointerId),e._inputs[X.Touch][d][ee.LeftClick]=0;var p=or.CreateDeviceEvent(X.Touch,d,ee.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(X.Touch,d,p),e._activeTouchIds[d]=-1,e._onDeviceDisconnected(X.Touch,d)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";var i=!1,n=function(){};try{var o=Object.defineProperty({},"passive",{get:function(){i=!0}});this._elementToAttachTo.addEventListener("test",n,o),this._elementToAttachTo.removeEventListener("test",n,o)}catch(a){}this._pointerBlurEvent=function(){var a,s,f,u,l;if(e.isDeviceAvailable(X.Mouse)){var h=e._inputs[X.Mouse][0];e._mouseId>=0&&((s=(a=e._elementToAttachTo).hasPointerCapture)===null||s===void 0?void 0:s.call(a,e._mouseId))&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var c=ee.LeftClick;c<=ee.BrowserForward;c++)if(h[c]===1){h[c]=0;var p=or.CreateDeviceEvent(X.Mouse,0,c,0,e,e._elementToAttachTo);e._onInputChanged(X.Mouse,0,p)}}if(e.isDeviceAvailable(X.Touch))for(var h=e._inputs[X.Touch],d=0;d<e._activeTouchIds.length;d++){var m=e._activeTouchIds[d];if(!((u=(f=e._elementToAttachTo).hasPointerCapture)===null||u===void 0)&&u.call(f,m)&&e._elementToAttachTo.releasePointerCapture(m),m!==-1&&((l=h[d])===null||l===void 0?void 0:l[ee.LeftClick])===1){h[d][ee.LeftClick]=0;var p=or.CreateDeviceEvent(X.Touch,d,ee.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(X.Touch,d,p),e._activeTouchIds[d]=-1,e._onDeviceDisconnected(X.Touch,d)}}},this._pointerWheelEvent=function(a){var s=X.Mouse,f=0;e._inputs[s]||(e._inputs[s]=[]),e._inputs[s][f]||(e._pointerActive=!0,e._registerDevice(s,f,Wh));var u=e._inputs[s][f];if(u){u[ee.MouseWheelX]=a.deltaX||0,u[ee.MouseWheelY]=a.deltaY||a.wheelDelta||0,u[ee.MouseWheelZ]=a.deltaZ||0;var l=a;u[ee.MouseWheelX]!==0&&(l.inputIndex=ee.MouseWheelX,e._onInputChanged(s,f,l)),u[ee.MouseWheelY]!==0&&(l.inputIndex=ee.MouseWheelY,e._onInputChanged(s,f,l)),u[ee.MouseWheelZ]!==0&&(l.inputIndex=ee.MouseWheelZ,e._onInputChanged(s,f,l))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,i?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(function(){if(e.isDeviceAvailable(X.Mouse)){var a=e._inputs[X.Mouse][0];a[ee.MouseWheelX]=0,a[ee.MouseWheelY]=0,a[ee.MouseWheelZ]=0}})},r.prototype._handleGamepadActions=function(){var e=this;this._gamepadConnectedEvent=function(t){e._addGamePad(t.gamepad)},this._gamepadDisconnectedEvent=function(t){if(e._gamepads){var i=e._getGamepadDeviceType(t.gamepad.id),n=t.gamepad.index;e._unregisterDevice(i,n),delete e._gamepads[n]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)},r.prototype._updateDevice=function(e,t,i){var n=navigator.getGamepads()[t];if(n&&e===this._gamepads[t]){var o=this._inputs[e][t];i>=n.buttons.length?o[i]=n.axes[i-n.buttons.length].valueOf():o[i]=n.buttons[i].value}},r.prototype._getGamepadDeviceType=function(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?X.DualSense:X.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?X.Xbox:e.indexOf("057e")!==-1?X.Switch:X.Generic},r.prototype._getPointerType=function(e){var t=X.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=X.Touch),t},r}();v();var Sa=function(){function r(e,t,i){i===void 0&&(i=0),this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new U,this._deviceInputSystem=e}return r.prototype.getInput=function(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)},r}();var zh=function(){function r(e){var t=this;this._registeredManagers=new Array,this._refCount=0,this.registerManager=function(s){for(var f=0;f<t._devices.length;f++){var u=t._devices[f];for(var l in u){var h=+l;s._addDevice(new Sa(t._deviceInputSystem,f,h))}}t._registeredManagers.push(s)},this.unregisterManager=function(s){var f=t._registeredManagers.indexOf(s);f>-1&&t._registeredManagers.splice(f,1)};var i=Object.keys(X).length/2;this._devices=new Array(i);var n=function(s,f){t._devices[s]||(t._devices[s]=new Array),t._devices[s][f]||(t._devices[s][f]=f);for(var u=0,l=t._registeredManagers;u<l.length;u++){var h=l[u],c=new Sa(t._deviceInputSystem,s,f);h._addDevice(c)}},o=function(s,f){var u;!((u=t._devices[s])===null||u===void 0)&&u[f]&&delete t._devices[s][f];for(var l=0,h=t._registeredManagers;l<h.length;l++){var c=h[l];c._removeDevice(s,f)}},a=function(s,f,u){if(u)for(var l=0,h=t._registeredManagers;l<h.length;l++){var c=h[l];c._onInputChanged(s,f,u)}};typeof _native!="undefined"?this._deviceInputSystem=new kh(n,o,a):this._deviceInputSystem=new Gh(e,n,o,a)}return r.prototype.dispose=function(){this._deviceInputSystem.dispose()},r}();var Xh=function(){function r(e){var t=this,i=Object.keys(X).length/2;this._devices=new Array(i),this._firstDevice=new Array(i),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new zh(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new U(function(n){for(var o=0,a=t._devices;o<a.length;o++){var s=a[o];if(s)for(var f=0,u=s;f<u.length;f++){var l=u[f];l&&t.onDeviceConnectedObservable.notifyObserver(n,l)}}}),this.onDeviceDisconnectedObservable=new U,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(function(){t.dispose()})}return r.prototype.getDeviceSource=function(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]},r.prototype.getDeviceSources=function(e){return this._devices[e]?this._devices[e].filter(function(t){return!!t}):[]},r.prototype.dispose=function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)},r.prototype._addDevice=function(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)},r.prototype._removeDevice=function(e,t){var i,n,o=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(o),!((n=this._devices[e])===null||n===void 0)&&n[t]&&delete this._devices[e][t],this._updateFirstDevices(e)},r.prototype._onInputChanged=function(e,t,i){var n,o;(o=(n=this._devices[e])===null||n===void 0?void 0:n[t])===null||o===void 0||o.onInputChangedObservable.notifyObservers(i)},r.prototype._updateFirstDevices=function(e){switch(e){case X.Keyboard:case X.Mouse:this._firstDevice[e]=0;break;case X.Touch:case X.DualSense:case X.DualShock:case X.Xbox:case X.Switch:case X.Generic:{delete this._firstDevice[e];var t=this._devices[e];if(t){for(var i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}},r}();var Hh=function(){function r(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(r.prototype,"singleClick",{get:function(){return this._singleClick},set:function(e){this._singleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(e){this._doubleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ignore",{get:function(){return this._ignore},set:function(e){this._ignore=e},enumerable:!1,configurable:!0}),r}(),Yt=function(){function r(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new _e(0,0),this._previousStartingPointerPosition=new _e(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._deviceSourceManager=null,this._scene=e||le.LastCreatedScene,this._scene}return Object.defineProperty(r.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!1,configurable:!0}),r.prototype.getMeshUnderPointerByPointerId=function(e){return this._meshUnderPointerId[e]||null},Object.defineProperty(r.prototype,"unTranslatedPointer",{get:function(){return new _e(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"pointerX",{get:function(){return this._pointerX},set:function(e){this._pointerX=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"pointerY",{get:function(){return this._pointerY},set:function(e){this._pointerY=e},enumerable:!1,configurable:!0}),r.prototype._updatePointerPosition=function(e){var t=this._scene.getEngine().getInputElementClientRect();!t||(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},r.prototype._processPointerMove=function(e,t){var i=this._scene,n=i.getEngine(),o=n.getInputElement();o&&(o.tabIndex=n.canvasTabIndex,i.doNotHandleCursors||(o.style.cursor=i.defaultCursor));var a=!!(e&&e.hit&&e.pickedMesh);if(a){if(i.setPointerOverMesh(e.pickedMesh,t.pointerId,e),!i.doNotHandleCursors&&o&&this._pointerOverMesh){var s=this._pointerOverMesh._getActionManagerForTrigger();s&&s.hasPointerTriggers&&(o.style.cursor=s.hoverCursor||i.hoverCursor)}}else i.setPointerOverMesh(null,t.pointerId,e);for(var f=0,u=i._pointerMoveStage;f<u.length;f++){var l=u[f];e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,a,o)}if(e){var h=t.type==="wheel"||t.type==="mousewheel"||t.type==="DOMMouseScroll"?ne.POINTERWHEEL:ne.POINTERMOVE;if(i.onPointerMove&&i.onPointerMove(t,e,h),i.onPointerObservable.hasObservers()){var c=new mi(h,t,e);this._setRayOnPointerInfo(c),i.onPointerObservable.notifyObservers(c,h)}}},r.prototype._setRayOnPointerInfo=function(e){var t=this._scene;e.pickInfo&&!e.pickInfo._pickingUnavailable&&(e.pickInfo.ray||(e.pickInfo.ray=t.createPickingRay(e.event.offsetX,e.event.offsetY,B.Identity(),t.activeCamera)))},r.prototype._checkPrePointerObservable=function(e,t,i){var n=this._scene,o=new Fh(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(o.ray=e.ray,e.originMesh&&(o.nearInteractionPickingInfo=e)),n.onPrePointerObservable.notifyObservers(o,i),!!o.skipOnPointerObservable},r.prototype.simulatePointerMove=function(e,t){var i=new PointerEvent("pointermove",t);i.inputIndex=ee.Move,!this._checkPrePointerObservable(e,i,ne.POINTERMOVE)&&this._processPointerMove(e,i)},r.prototype.simulatePointerDown=function(e,t){var i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,ne.POINTERDOWN)&&this._processPointerDown(e,i)},r.prototype._processPointerDown=function(e,t){var i=this,n=this._scene;if(e&&e.hit&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;var o=e.pickedMesh._getActionManagerForTrigger();if(o){if(o.hasPickTriggers)switch(o.processTrigger(5,it.CreateNew(e.pickedMesh,t)),t.button){case 0:o.processTrigger(2,it.CreateNew(e.pickedMesh,t));break;case 1:o.processTrigger(4,it.CreateNew(e.pickedMesh,t));break;case 2:o.processTrigger(3,it.CreateNew(e.pickedMesh,t));break}o.hasSpecificTrigger(8)&&window.setTimeout(function(){var h=n.pick(i._unTranslatedPointerX,i._unTranslatedPointerY,function(c){return c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===i._pickedDownMesh},!1,n.cameraToUseForPointers);h&&h.hit&&h.pickedMesh&&o&&i._totalPointersPressed!==0&&Date.now()-i._startingPointerTime>r.LongPressDelay&&!i._isPointerSwiping()&&(i._startingPointerTime=0,o.processTrigger(8,it.CreateNew(h.pickedMesh,t)))},r.LongPressDelay)}}else for(var a=0,s=n._pointerDownStage;a<s.length;a++){var f=s[a];e=f.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t)}if(e){var u=ne.POINTERDOWN;if(n.onPointerDown&&n.onPointerDown(t,e,u),n.onPointerObservable.hasObservers()){var l=new mi(u,t,e);this._setRayOnPointerInfo(l),n.onPointerObservable.notifyObservers(l,u)}}},r.prototype._isPointerSwiping=function(){return Math.abs(this._startingPointerPosition.x-this._pointerX)>r.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>r.DragMovementThreshold},r.prototype.simulatePointerUp=function(e,t,i){var n=new PointerEvent("pointerup",t);n.inputIndex=ee.Move;var o=new Hh;i?o.doubleClick=!0:o.singleClick=!0,!this._checkPrePointerObservable(e,n,ne.POINTERUP)&&this._processPointerUp(e,n,o)},r.prototype._processPointerUp=function(e,t,i){var n=this._scene;if(e&&e.hit&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(t,e),i.singleClick&&!i.ignore&&n.onPointerObservable.hasObservers())){var o=ne.POINTERPICK,a=new mi(o,t,e);this._setRayOnPointerInfo(a),n.onPointerObservable.notifyObservers(a,o)}var s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,it.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,it.CreateNew(e.pickedMesh,t,e));var f=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&f&&f.processTrigger(6,it.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(var u=0,l=n._pointerUpStage;u<l.length;u++){var h=l[u];e=h.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t)}if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){var c=this._pickedDownMesh._getActionManagerForTrigger(16);c&&c.processTrigger(16,it.CreateNew(this._pickedDownMesh,t))}var p=0;if(n.onPointerObservable.hasObservers()){if(!i.ignore&&!i.hasSwiped&&(i.singleClick&&n.onPointerObservable.hasSpecificMask(ne.POINTERTAP)?p=ne.POINTERTAP:i.doubleClick&&n.onPointerObservable.hasSpecificMask(ne.POINTERDOUBLETAP)&&(p=ne.POINTERDOUBLETAP),p)){var a=new mi(p,t,e);this._setRayOnPointerInfo(a),n.onPointerObservable.notifyObservers(a,p)}if(!i.ignore){p=ne.POINTERUP;var a=new mi(p,t,e);this._setRayOnPointerInfo(a),n.onPointerObservable.notifyObservers(a,p)}}n.onPointerUp&&!i.ignore&&n.onPointerUp(t,e,p)},r.prototype.isPointerCaptured=function(e){return e===void 0&&(e=0),this._pointerCaptures[e]},r.prototype.attachControl=function(e,t,i,n){var o=this;e===void 0&&(e=!0),t===void 0&&(t=!0),i===void 0&&(i=!0),n===void 0&&(n=null);var a=this._scene,s=a.getEngine();n||(n=s.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new Xh(s),this._initActionManager=function(f){if(!o._meshPickProceed){var u=a.skipPointerUpPicking?null:a.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);o._currentPickResult=u,u&&(f=u.hit&&u.pickedMesh?u.pickedMesh._getActionManagerForTrigger():null),o._meshPickProceed=!0}return f},this._delayedSimpleClick=function(f,u,l){(Date.now()-o._previousStartingPointerTime>r.DoubleClickDelay&&!o._doubleClickOccured||f!==o._previousButtonPressed)&&(o._doubleClickOccured=!1,u.singleClick=!0,u.ignore=!1,l(u,o._currentPickResult))},this._initClickEvent=function(f,u,l,h){var c=new Hh;o._currentPickResult=null;var p=null,d=f.hasSpecificMask(ne.POINTERPICK)||u.hasSpecificMask(ne.POINTERPICK)||f.hasSpecificMask(ne.POINTERTAP)||u.hasSpecificMask(ne.POINTERTAP)||f.hasSpecificMask(ne.POINTERDOUBLETAP)||u.hasSpecificMask(ne.POINTERDOUBLETAP);!d&&gi&&(p=o._initActionManager(p,c),p&&(d=p.hasPickTriggers));var m=!1;if(d){var _=l.button;if(c.hasSwiped=o._isPointerSwiping(),!c.hasSwiped){var y=!r.ExclusiveDoubleClickMode;y||(y=!f.hasSpecificMask(ne.POINTERDOUBLETAP)&&!u.hasSpecificMask(ne.POINTERDOUBLETAP),y&&!gi.HasSpecificTrigger(6)&&(p=o._initActionManager(p,c),p&&(y=!p.hasSpecificTrigger(6)))),y?(Date.now()-o._previousStartingPointerTime>r.DoubleClickDelay||_!==o._previousButtonPressed)&&(c.singleClick=!0,h(c,o._currentPickResult),m=!0):(o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,o._delayedSimpleClickTimeout=window.setTimeout(o._delayedSimpleClick.bind(o,_,c,h),r.DoubleClickDelay));var g=f.hasSpecificMask(ne.POINTERDOUBLETAP)||u.hasSpecificMask(ne.POINTERDOUBLETAP);!g&&gi.HasSpecificTrigger(6)&&(p=o._initActionManager(p,c),p&&(g=p.hasSpecificTrigger(6))),g&&(_===o._previousButtonPressed&&Date.now()-o._previousStartingPointerTime<r.DoubleClickDelay&&!o._doubleClickOccured?(!c.hasSwiped&&!o._isPointerSwiping()?(o._previousStartingPointerTime=0,o._doubleClickOccured=!0,c.doubleClick=!0,c.ignore=!1,r.ExclusiveDoubleClickMode&&o._previousDelayedSimpleClickTimeout&&clearTimeout(o._previousDelayedSimpleClickTimeout),o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,h(c,o._currentPickResult)):(o._doubleClickOccured=!1,o._previousStartingPointerTime=o._startingPointerTime,o._previousStartingPointerPosition.x=o._startingPointerPosition.x,o._previousStartingPointerPosition.y=o._startingPointerPosition.y,o._previousButtonPressed=_,r.ExclusiveDoubleClickMode?(o._previousDelayedSimpleClickTimeout&&clearTimeout(o._previousDelayedSimpleClickTimeout),o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,h(c,o._previousPickResult)):h(c,o._currentPickResult)),m=!0):(o._doubleClickOccured=!1,o._previousStartingPointerTime=o._startingPointerTime,o._previousStartingPointerPosition.x=o._startingPointerPosition.x,o._previousStartingPointerPosition.y=o._startingPointerPosition.y,o._previousButtonPressed=_))}}m||h(c,o._currentPickResult)},this._onPointerMove=function(f){if(f.pointerId===void 0&&(f.pointerId=0),o._updatePointerPosition(f),!o._checkPrePointerObservable(null,f,f.type==="wheel"||f.type==="mousewheel"||f.type==="DOMMouseScroll"?ne.POINTERWHEEL:ne.POINTERMOVE)&&!(!a.cameraToUseForPointers&&!a.activeCamera)){if(a.skipPointerMovePicking){o._processPointerMove(new bt,f);return}a.pointerMovePredicate||(a.pointerMovePredicate=function(l){return l.isPickable&&l.isVisible&&l.isReady()&&l.isEnabled()&&(l.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||l._getActionManagerForTrigger()!==null)&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&l.layerMask)!==0)});var u=a.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,a.pointerMovePredicate,!1,a.cameraToUseForPointers,a.pointerMoveTrianglePredicate);o._processPointerMove(u,f)}},this._onPointerDown=function(f){if(o._totalPointersPressed++,o._pickedDownMesh=null,o._meshPickProceed=!1,f.pointerId===void 0&&(f.pointerId=0),o._updatePointerPosition(f),a.preventDefaultOnPointerDown&&n&&(f.preventDefault(),n.focus()),o._startingPointerPosition.x=o._pointerX,o._startingPointerPosition.y=o._pointerY,o._startingPointerTime=Date.now(),!o._checkPrePointerObservable(null,f,ne.POINTERDOWN)&&!(!a.cameraToUseForPointers&&!a.activeCamera)){o._pointerCaptures[f.pointerId]=!0,a.pointerDownPredicate||(a.pointerDownPredicate=function(l){return l.isPickable&&l.isVisible&&l.isReady()&&l.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&l.layerMask)!==0)}),o._pickedDownMesh=null;var u;a.skipPointerDownPicking?u=new bt:u=a.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),o._processPointerDown(u,f)}},this._onPointerUp=function(f){o._totalPointersPressed!==0&&(o._totalPointersPressed--,o._pickedUpMesh=null,o._meshPickProceed=!1,f.pointerId===void 0&&(f.pointerId=0),o._updatePointerPosition(f),a.preventDefaultOnPointerUp&&n&&(f.preventDefault(),n.focus()),o._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,f,function(u,l){a.onPrePointerObservable.hasObservers()&&!u.ignore&&(!u.hasSwiped&&(u.singleClick&&a.onPrePointerObservable.hasSpecificMask(ne.POINTERTAP)&&o._checkPrePointerObservable(null,f,ne.POINTERTAP)||u.doubleClick&&a.onPrePointerObservable.hasSpecificMask(ne.POINTERDOUBLETAP)&&o._checkPrePointerObservable(null,f,ne.POINTERDOUBLETAP))||o._checkPrePointerObservable(null,f,ne.POINTERUP))||(o._pointerCaptures[f.pointerId]=!1,!(!a.cameraToUseForPointers&&!a.activeCamera)&&(a.pointerUpPredicate||(a.pointerUpPredicate=function(h){return h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&h.layerMask)!==0)}),!o._meshPickProceed&&(gi&&gi.HasTriggers||a.onPointerObservable.hasObservers())&&o._initActionManager(null,u),l||(l=o._currentPickResult),o._processPointerUp(l,f,u),o._previousPickResult=o._currentPickResult))}))},this._onKeyDown=function(f){var u=Hi.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){var l=new Aa(u,f);if(a.onPreKeyboardObservable.notifyObservers(l,u),l.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){var l=new Kn(u,f);a.onKeyboardObservable.notifyObservers(l,u)}a.actionManager&&a.actionManager.processTrigger(14,it.CreateNewFromScene(a,f))},this._onKeyUp=function(f){var u=Hi.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){var l=new Aa(u,f);if(a.onPreKeyboardObservable.notifyObservers(l,u),l.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){var l=new Kn(u,f);a.onKeyboardObservable.notifyObservers(l,u)}a.actionManager&&a.actionManager.processTrigger(15,it.CreateNewFromScene(a,f))},this._deviceSourceManager.onDeviceConnectedObservable.add(function(f){f.deviceType===X.Mouse?f.onInputChangedObservable.add(function(u){u.inputIndex===ee.LeftClick||u.inputIndex===ee.MiddleClick||u.inputIndex===ee.RightClick||u.inputIndex===ee.BrowserBack||u.inputIndex===ee.BrowserForward?t&&f.getInput(u.inputIndex)===1?o._onPointerDown(u):e&&f.getInput(u.inputIndex)===0&&o._onPointerUp(u):i&&(u.inputIndex===ee.Move||u.inputIndex===ee.MouseWheelX||u.inputIndex===ee.MouseWheelY||u.inputIndex===ee.MouseWheelZ)&&o._onPointerMove(u)}):f.deviceType===X.Touch?f.onInputChangedObservable.add(function(u){u.inputIndex===ee.LeftClick&&(t&&f.getInput(u.inputIndex)===1?o._onPointerDown(u):e&&f.getInput(u.inputIndex)===0&&o._onPointerUp(u)),i&&u.inputIndex===ee.Move&&o._onPointerMove(u)}):f.deviceType===X.Keyboard&&f.onInputChangedObservable.add(function(u){u.type==="keydown"?o._onKeyDown(u):u.type==="keyup"&&o._onKeyUp(u)})}),this._alreadyAttached=!0},r.prototype.detachControl=function(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)},r.prototype.setPointerOverMesh=function(e,t,i){if(t===void 0&&(t=0),this._meshUnderPointerId[t]!==e){var n=this._meshUnderPointerId[t],o;n&&(o=n._getActionManagerForTrigger(10),o&&o.processTrigger(10,it.CreateNew(n,void 0,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,o=e._getActionManagerForTrigger(9),o&&o.processTrigger(9,it.CreateNew(e,void 0,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}},r.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},r.prototype._invalidateMesh=function(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(var t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]},r.DragMovementThreshold=10,r.LongPressDelay=500,r.DoubleClickDelay=300,r.ExclusiveDoubleClickMode=!1,r}();v();var Kh=function(){function r(){}return Object.defineProperty(r,"UniqueId",{get:function(){var e=this._UniqueIdCounter;return this._UniqueIdCounter++,e},enumerable:!1,configurable:!0}),r._UniqueIdCounter=1,r}();v();var Fe=function(){function r(){}return r.CompareLightsPriority=function(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority},r.FALLOFF_DEFAULT=0,r.FALLOFF_PHYSICAL=1,r.FALLOFF_GLTF=2,r.FALLOFF_STANDARD=3,r.LIGHTMAP_DEFAULT=0,r.LIGHTMAP_SPECULAR=1,r.LIGHTMAP_SHADOWSONLY=2,r.INTENSITYMODE_AUTOMATIC=0,r.INTENSITYMODE_LUMINOUSPOWER=1,r.INTENSITYMODE_LUMINOUSINTENSITY=2,r.INTENSITYMODE_ILLUMINANCE=3,r.INTENSITYMODE_LUMINANCE=4,r.LIGHTTYPEID_POINTLIGHT=0,r.LIGHTTYPEID_DIRECTIONALLIGHT=1,r.LIGHTTYPEID_SPOTLIGHT=2,r.LIGHTTYPEID_HEMISPHERICLIGHT=3,r}();v();var Ma=function(){function r(e,t){r.IsAvailable&&(this._observer=new window.ComputePressureObserver(e,t))}return Object.defineProperty(r,"IsAvailable",{get:function(){var e,t;return Me()&&"ComputePressureObserver"in window&&((t=(e=window.ComputePressureObserver)===null||e===void 0?void 0:e.supportedSources)===null||t===void 0?void 0:t.includes("cpu"))},enumerable:!1,configurable:!0}),r.prototype.observe=function(e){var t,i;!((t=this._observer)===null||t===void 0)&&t.observe&&((i=this._observer)===null||i===void 0||i.observe(e).catch(function(){}))},r.prototype.unobserve=function(e){var t,i;try{!((t=this._observer)===null||t===void 0)&&t.unobserve&&((i=this._observer)===null||i===void 0||i.unobserve(e))}catch(n){}},r}();var ue=function(r){Y(e,r);function e(t,i){var n=r.call(this)||this;n._inputManager=new Yt(n),n.cameraToUseForPointers=null,n._isScene=!0,n._blockEntityCollection=!1,n.autoClear=!0,n.autoClearDepthAndStencil=!0,n.clearColor=new Ae(.2,.2,.3,1),n.ambientColor=new de(0,0,0),n.environmentIntensity=1,n._forceWireframe=!1,n._skipFrustumClipping=!1,n._forcePointsCloud=!1,n.animationsEnabled=!0,n._animationPropertiesOverride=null,n.useConstantAnimationDeltaTime=!1,n.constantlyUpdateMeshUnderPointer=!1,n.hoverCursor="pointer",n.defaultCursor="",n.doNotHandleCursors=!1,n.preventDefaultOnPointerDown=!0,n.preventDefaultOnPointerUp=!0,n.metadata=null,n.reservedDataStore=null,n.disableOfflineSupportExceptionRules=new Array,n.onDisposeObservable=new U,n._onDisposeObserver=null,n.onBeforeRenderObservable=new U,n._onBeforeRenderObserver=null,n.onAfterRenderObservable=new U,n.onAfterRenderCameraObservable=new U,n._onAfterRenderObserver=null,n.onBeforeAnimationsObservable=new U,n.onAfterAnimationsObservable=new U,n.onBeforeDrawPhaseObservable=new U,n.onAfterDrawPhaseObservable=new U,n.onReadyObservable=new U,n.onBeforeCameraRenderObservable=new U,n._onBeforeCameraRenderObserver=null,n.onAfterCameraRenderObservable=new U,n._onAfterCameraRenderObserver=null,n.onBeforeActiveMeshesEvaluationObservable=new U,n.onAfterActiveMeshesEvaluationObservable=new U,n.onBeforeParticlesRenderingObservable=new U,n.onAfterParticlesRenderingObservable=new U,n.onDataLoadedObservable=new U,n.onNewCameraAddedObservable=new U,n.onCameraRemovedObservable=new U,n.onNewLightAddedObservable=new U,n.onLightRemovedObservable=new U,n.onNewGeometryAddedObservable=new U,n.onGeometryRemovedObservable=new U,n.onNewTransformNodeAddedObservable=new U,n.onTransformNodeRemovedObservable=new U,n.onNewMeshAddedObservable=new U,n.onMeshRemovedObservable=new U,n.onNewSkeletonAddedObservable=new U,n.onSkeletonRemovedObservable=new U,n.onNewMaterialAddedObservable=new U,n.onNewMultiMaterialAddedObservable=new U,n.onMaterialRemovedObservable=new U,n.onMultiMaterialRemovedObservable=new U,n.onNewTextureAddedObservable=new U,n.onTextureRemovedObservable=new U,n.onBeforeRenderTargetsRenderObservable=new U,n.onAfterRenderTargetsRenderObservable=new U,n.onBeforeStepObservable=new U,n.onAfterStepObservable=new U,n.onActiveCameraChanged=new U,n.onBeforeRenderingGroupObservable=new U,n.onAfterRenderingGroupObservable=new U,n.onMeshImportedObservable=new U,n.onAnimationFileImportedObservable=new U,n._registeredForLateAnimationBindings=new Nt(256),n.skipPointerMovePicking=!1,n.skipPointerDownPicking=!1,n.skipPointerUpPicking=!1,n.onPrePointerObservable=new U,n.onPointerObservable=new U,n.onPreKeyboardObservable=new U,n.onKeyboardObservable=new U,n._useRightHandedSystem=!1,n._timeAccumulator=0,n._currentStepId=0,n._currentInternalStep=0,n._fogEnabled=!0,n._fogMode=e.FOGMODE_NONE,n.fogColor=new de(.2,.2,.3),n.fogDensity=.1,n.fogStart=0,n.fogEnd=1e3,n.needsPreviousWorldMatrices=!1,n._shadowsEnabled=!0,n._lightsEnabled=!0,n.activeCameras=new Array,n._texturesEnabled=!0,n.physicsEnabled=!0,n.particlesEnabled=!0,n.spritesEnabled=!0,n._skeletonsEnabled=!0,n.lensFlaresEnabled=!0,n.collisionsEnabled=!0,n.gravity=new E(0,-9.807,0),n.postProcessesEnabled=!0,n.renderTargetsEnabled=!0,n.dumpNextRenderTargets=!1,n.customRenderTargets=new Array,n.importedMeshesFiles=new Array,n.probesEnabled=!0,n._meshesForIntersections=new Nt(256),n.proceduralTexturesEnabled=!0,n._totalVertices=new Fr,n._activeIndices=new Fr,n._activeParticles=new Fr,n._activeBones=new Fr,n._animationTime=0,n.animationTimeScale=1,n._renderId=0,n._frameId=0,n._executeWhenReadyTimeoutId=null,n._intermediateRendering=!1,n._defaultFrameBufferCleared=!1,n._viewUpdateFlag=-1,n._projectionUpdateFlag=-1,n._toBeDisposed=new Array(256),n._activeRequests=new Array,n._pendingData=new Array,n._isDisposed=!1,n.dispatchAllSubMeshesOfActiveMeshes=!1,n._activeMeshes=new st(256),n._processedMaterials=new st(256),n._renderTargets=new Nt(256),n._materialsRenderTargets=new Nt(256),n._activeParticleSystems=new st(256),n._activeSkeletons=new Nt(32),n._softwareSkinnedMeshes=new Nt(32),n._activeAnimatables=new Array,n._transformMatrix=B.Zero(),n.requireLightSorting=!1,n._components=[],n._serializableComponents=[],n._transientComponents=[],n._beforeCameraUpdateStage=Ne.Create(),n._beforeClearStage=Ne.Create(),n._beforeRenderTargetClearStage=Ne.Create(),n._gatherRenderTargetsStage=Ne.Create(),n._gatherActiveCameraRenderTargetsStage=Ne.Create(),n._isReadyForMeshStage=Ne.Create(),n._beforeEvaluateActiveMeshStage=Ne.Create(),n._evaluateSubMeshStage=Ne.Create(),n._preActiveMeshStage=Ne.Create(),n._cameraDrawRenderTargetStage=Ne.Create(),n._beforeCameraDrawStage=Ne.Create(),n._beforeRenderTargetDrawStage=Ne.Create(),n._beforeRenderingGroupDrawStage=Ne.Create(),n._beforeRenderingMeshStage=Ne.Create(),n._afterRenderingMeshStage=Ne.Create(),n._afterRenderingGroupDrawStage=Ne.Create(),n._afterCameraDrawStage=Ne.Create(),n._afterRenderTargetDrawStage=Ne.Create(),n._afterRenderStage=Ne.Create(),n._pointerMoveStage=Ne.Create(),n._pointerDownStage=Ne.Create(),n._pointerUpStage=Ne.Create(),n._geometriesByUniqueId=null,n._defaultMeshCandidates={data:[],length:0},n._defaultSubMeshCandidates={data:[],length:0},n._preventFreeActiveMeshesAndRenderingGroups=!1,n._activeMeshesFrozen=!1,n._activeMeshesFrozenButKeepClipping=!1,n._skipEvaluateActiveMeshesCompletely=!1,n._allowPostProcessClearColor=!0,n.getDeterministicFrameTime=function(){return n._engine.getTimeStep()},n._blockMaterialDirtyMechanism=!1,n._perfCollector=null,n.onComputePressureChanged=new U;var o=Vt({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},i);return n._engine=t||le.LastCreatedEngine,o.virtual?n._engine._virtualScenes.push(n):(le._LastCreatedScene=n,n._engine.scenes.push(n)),n._uid=null,n._renderingManager=new Dh(n),Ta&&(n.postProcessManager=new Ta(n)),Me()&&n.attachControl(),n._createUbo(),mr&&(n._imageProcessingConfiguration=new mr),n.setDefaultCandidateProviders(),o.useGeometryUniqueIdsMap&&(n._geometriesByUniqueId={}),n.useMaterialMeshMap=o.useMaterialMeshMap,n.useClonedMeshMap=o.useClonedMeshMap,(!i||!i.virtual)&&n._engine.onNewSceneAddedObservable.notifyObservers(n),Ma.IsAvailable&&(n._computePressureObserver=new Ma(function(a){n.onComputePressureChanged.notifyObservers(a)},{cpuUtilizationThresholds:[.25,.5,.75,.9],cpuSpeedThresholds:[.5]}),n._computePressureObserver.observe("cpu")),n}return e.DefaultMaterialFactory=function(t){throw Q("StandardMaterial")},e.CollisionCoordinatorFactory=function(){throw Q("DefaultCollisionCoordinator")},Object.defineProperty(e.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forceWireframe",{get:function(){return this._forceWireframe},set:function(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skipFrustumClipping",{get:function(){return this._skipFrustumClipping},set:function(t){this._skipFrustumClipping!==t&&(this._skipFrustumClipping=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"afterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beforeCameraRender",{set:function(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"afterCameraRender",{set:function(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unTranslatedPointer",{get:function(){return this._inputManager.unTranslatedPointer},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DragMovementThreshold",{get:function(){return Yt.DragMovementThreshold},set:function(t){Yt.DragMovementThreshold=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LongPressDelay",{get:function(){return Yt.LongPressDelay},set:function(t){Yt.LongPressDelay=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DoubleClickDelay",{get:function(){return Yt.DoubleClickDelay},set:function(t){Yt.DoubleClickDelay=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ExclusiveDoubleClickMode",{get:function(){return Yt.ExclusiveDoubleClickMode},set:function(t){Yt.ExclusiveDoubleClickMode=t},enumerable:!1,configurable:!0}),e.prototype.bindEyePosition=function(t,i,n){var o;i===void 0&&(i="vEyePosition"),n===void 0&&(n=!1);var a=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(o=this.activeCamera.globalPosition)!==null&&o!==void 0?o:this.activeCamera.devicePosition,s=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return L.Vector4[0].set(a.x,a.y,a.z,s?-1:1),t&&(n?t.setFloat3(i,L.Vector4[0].x,L.Vector4[0].y,L.Vector4[0].z):t.setVector4(i,L.Vector4[0])),L.Vector4[0]},e.prototype.finalizeSceneUbo=function(){var t=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),t.update(),t},Object.defineProperty(e.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),e.prototype.setStepId=function(t){this._currentStepId=t},e.prototype.getStepId=function(){return this._currentStepId},e.prototype.getInternalStep=function(){return this._currentInternalStep},Object.defineProperty(e.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fogMode",{get:function(){return this._fogMode},set:function(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"prePass",{get:function(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeCamera",{get:function(){return this._activeCamera},set:function(t){t!==this._activeCamera&&(this._activeCamera=t,this.onActiveCameraChanged.notifyObservers(this))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=e.DefaultMaterialFactory(this)),this._defaultMaterial},set:function(t){this._defaultMaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(8))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionCoordinator",{get:function(){return this._collisionCoordinator||(this._collisionCoordinator=e.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:!1,configurable:!0}),e.prototype._registerTransientComponents=function(){if(this._transientComponents.length>0){for(var t=0,i=this._transientComponents;t<i.length;t++){var n=i[t];n.register()}this._transientComponents.length=0}},e.prototype._addComponent=function(t){this._components.push(t),this._transientComponents.push(t);var i=t;i.addFromContainer&&i.serialize&&this._serializableComponents.push(i)},e.prototype._getComponent=function(t){for(var i=0,n=this._components;i<n.length;i++){var o=n[i];if(o.name===t)return o}return null},e.prototype.getClassName=function(){return"Scene"},e.prototype._getDefaultMeshCandidates=function(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates},e.prototype._getDefaultSubMeshCandidates=function(t){return this._defaultSubMeshCandidates.data=t.subMeshes,this._defaultSubMeshCandidates.length=t.subMeshes.length,this._defaultSubMeshCandidates},e.prototype.setDefaultCandidateProviders=function(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)},Object.defineProperty(e.prototype,"meshUnderPointer",{get:function(){return this._inputManager.meshUnderPointer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerX",{get:function(){return this._inputManager.pointerX},set:function(t){this._inputManager.pointerX=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerY",{get:function(){return this._inputManager.pointerY},set:function(t){this._inputManager.pointerY=t},enumerable:!1,configurable:!0}),e.prototype.getCachedMaterial=function(){return this._cachedMaterial},e.prototype.getCachedEffect=function(){return this._cachedEffect},e.prototype.getCachedVisibility=function(){return this._cachedVisibility},e.prototype.isCachedMaterialInvalid=function(t,i,n){return n===void 0&&(n=1),this._cachedEffect!==i||this._cachedMaterial!==t||this._cachedVisibility!==n},e.prototype.getEngine=function(){return this._engine},e.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(e.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!1,configurable:!0}),e.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(e.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!1,configurable:!0}),e.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(e.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!1,configurable:!0}),e.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(e.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!1,configurable:!0}),e.prototype.getActiveMeshes=function(){return this._activeMeshes},e.prototype.getAnimationRatio=function(){return this._animationRatio!==void 0?this._animationRatio:1},e.prototype.getRenderId=function(){return this._renderId},e.prototype.getFrameId=function(){return this._frameId},e.prototype.incrementRenderId=function(){this._renderId++},e.prototype._createUbo=function(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())},e.prototype.simulatePointerMove=function(t,i){return this._inputManager.simulatePointerMove(t,i),this},e.prototype.simulatePointerDown=function(t,i){return this._inputManager.simulatePointerDown(t,i),this},e.prototype.simulatePointerUp=function(t,i,n){return this._inputManager.simulatePointerUp(t,i,n),this},e.prototype.isPointerCaptured=function(t){return t===void 0&&(t=0),this._inputManager.isPointerCaptured(t)},e.prototype.attachControl=function(t,i,n){t===void 0&&(t=!0),i===void 0&&(i=!0),n===void 0&&(n=!0),this._inputManager.attachControl(t,i,n)},e.prototype.detachControl=function(){this._inputManager.detachControl()},e.prototype.isReady=function(t){if(t===void 0&&(t=!0),this._isDisposed)return!1;var i,n=this.getEngine(),o=!0;for(this._pendingData.length>0&&(o=!1),t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){var a=this.meshes[i];if(!(!a.subMeshes||a.subMeshes.length===0)){if(!a.isReady(!0)){o=!1;continue}for(var s=a.hasThinInstances||a.getClassName()==="InstancedMesh"||a.getClassName()==="InstancedLinesMesh"||n.getCaps().instancedArrays&&a.instances.length>0,f=0,u=this._isReadyForMeshStage;f<u.length;f++){var l=u[f];l.action(a,s)||(o=!1)}if(!!t){var h=a.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(var c=0,p=a.subMeshes;c<p.length;c++){var d=p[c],m=d.getMaterial();m&&m.hasRenderTargetTextures&&m.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(m)===-1&&(this._processedMaterials.push(m),this._materialsRenderTargets.concatWithNoDuplicate(m.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}}}if(!o||!n.areAllEffectsReady())return!1;if(t)for(i=0;i<this._materialsRenderTargets.length;++i){var _=this._materialsRenderTargets.data[i];if(!_.isReadyForRendering())return!1}for(i=0;i<this.geometries.length;i++){var y=this.geometries[i];if(y.delayLoadState===2)return!1}if(this.activeCameras&&this.activeCameras.length>0)for(var g=0,T=this.activeCameras;g<T.length;g++){var A=T[g];if(!A.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(var M=0,C=this.particleSystems;M<C.length;M++){var P=C[M];if(!P.isReady())return!1}return!0},e.prototype.resetCachedMaterial=function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null},e.prototype.registerBeforeRender=function(t){this.onBeforeRenderObservable.add(t)},e.prototype.unregisterBeforeRender=function(t){this.onBeforeRenderObservable.removeCallback(t)},e.prototype.registerAfterRender=function(t){this.onAfterRenderObservable.add(t)},e.prototype.unregisterAfterRender=function(t){this.onAfterRenderObservable.removeCallback(t)},e.prototype._executeOnceBeforeRender=function(t){var i=this,n=function(){t(),setTimeout(function(){i.unregisterBeforeRender(n)})};this.registerBeforeRender(n)},e.prototype.executeOnceBeforeRender=function(t,i){var n=this;i!==void 0?setTimeout(function(){n._executeOnceBeforeRender(t)},i):this._executeOnceBeforeRender(t)},e.prototype.addPendingData=function(t){this._pendingData.push(t)},e.prototype.removePendingData=function(t){var i=this.isLoading,n=this._pendingData.indexOf(t);n!==-1&&this._pendingData.splice(n,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)},e.prototype.getWaitingItemsCount=function(){return this._pendingData.length},Object.defineProperty(e.prototype,"isLoading",{get:function(){return this._pendingData.length>0},enumerable:!1,configurable:!0}),e.prototype.executeWhenReady=function(t,i){i===void 0&&(i=!1),this.onReadyObservable.add(t),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(i)},e.prototype.whenReadyAsync=function(t){var i=this;return t===void 0&&(t=!1),new Promise(function(n){i.executeWhenReady(function(){n()},t)})},e.prototype._checkIsReady=function(t){var i=this;if(t===void 0&&(t=!1),this._registerTransientComponents(),this.isReady(t)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(function(){i._checkIsReady(t)},100)},Object.defineProperty(e.prototype,"animatables",{get:function(){return this._activeAnimatables},enumerable:!1,configurable:!0}),e.prototype.resetLastAnimationTimeFrame=function(){this._animationTimeLast=Wt.Now},e.prototype.getViewMatrix=function(){return this._viewMatrix},e.prototype.getProjectionMatrix=function(){return this._projectionMatrix},e.prototype.getTransformMatrix=function(){return this._transformMatrix},e.prototype.setTransformMatrix=function(t,i,n,o){!n&&!o&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===t.updateFlag&&this._projectionUpdateFlag===i.updateFlag)&&(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=t,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?_i.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=_i.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(n,o):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))},e.prototype.getSceneUniformBuffer=function(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo},e.prototype.createSceneUniformBuffer=function(t){var i=new vr(this._engine,void 0,!1,t!=null?t:"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i},e.prototype.setSceneUniformBuffer=function(t){this._sceneUbo=t,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1},e.prototype.getUniqueId=function(){return Kh.UniqueId},e.prototype.addMesh=function(t,i){var n=this;i===void 0&&(i=!1),!this._blockEntityCollection&&(this.meshes.push(t),t._resyncLightSources(),t.parent||t._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(function(o){n.addMesh(o)}))},e.prototype.removeMesh=function(t,i){var n=this;i===void 0&&(i=!1);var o=this.meshes.indexOf(t);return o!==-1&&(this.meshes[o]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(t),this.onMeshRemovedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(function(a){n.removeMesh(a)}),o},e.prototype.addTransformNode=function(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneTransformNodesArray!==-1||(t._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(t),t.parent||t._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(t))},e.prototype.removeTransformNode=function(t){var i=t._indexInSceneTransformNodesArray;if(i!==-1){if(i!==this.transformNodes.length-1){var n=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=n,n._indexInSceneTransformNodesArray=i}t._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),t.parent||t._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(t),i},e.prototype.removeSkeleton=function(t){var i=this.skeletons.indexOf(t);return i!==-1&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(t),this._executeActiveContainerCleanup(this._activeSkeletons)),i},e.prototype.removeMorphTargetManager=function(t){var i=this.morphTargetManagers.indexOf(t);return i!==-1&&this.morphTargetManagers.splice(i,1),i},e.prototype.removeLight=function(t){var i=this.lights.indexOf(t);if(i!==-1){for(var n=0,o=this.meshes;n<o.length;n++){var a=o[n];a._removeLightSource(t,!1)}this.lights.splice(i,1),this.sortLightsByPriority(),t.parent||t._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(t),i},e.prototype.removeCamera=function(t){var i=this.cameras.indexOf(t);if(i!==-1&&(this.cameras.splice(i,1),t.parent||t._removeFromSceneRootNodes()),this.activeCameras){var n=this.activeCameras.indexOf(t);n!==-1&&this.activeCameras.splice(n,1)}return this.activeCamera===t&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(t),i},e.prototype.removeParticleSystem=function(t){var i=this.particleSystems.indexOf(t);return i!==-1&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i},e.prototype.removeAnimation=function(t){var i=this.animations.indexOf(t);return i!==-1&&this.animations.splice(i,1),i},e.prototype.stopAnimation=function(t,i,n){},e.prototype.removeAnimationGroup=function(t){var i=this.animationGroups.indexOf(t);return i!==-1&&this.animationGroups.splice(i,1),i},e.prototype.removeMultiMaterial=function(t){var i=this.multiMaterials.indexOf(t);return i!==-1&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),i},e.prototype.removeMaterial=function(t){var i=t._indexInSceneMaterialArray;if(i!==-1&&i<this.materials.length){if(i!==this.materials.length-1){var n=this.materials[this.materials.length-1];this.materials[i]=n,n._indexInSceneMaterialArray=i}t._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),i},e.prototype.removeActionManager=function(t){var i=this.actionManagers.indexOf(t);return i!==-1&&this.actionManagers.splice(i,1),i},e.prototype.removeTexture=function(t){var i=this.textures.indexOf(t);return i!==-1&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(t),i},e.prototype.addLight=function(t){if(!this._blockEntityCollection){this.lights.push(t),this.sortLightsByPriority(),t.parent||t._addToSceneRootNodes();for(var i=0,n=this.meshes;i<n.length;i++){var o=n[i];o.lightSources.indexOf(t)===-1&&(o.lightSources.push(t),o._resyncLightSources())}this.onNewLightAddedObservable.notifyObservers(t)}},e.prototype.sortLightsByPriority=function(){this.requireLightSorting&&this.lights.sort(Fe.CompareLightsPriority)},e.prototype.addCamera=function(t){this._blockEntityCollection||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t._addToSceneRootNodes())},e.prototype.addSkeleton=function(t){this._blockEntityCollection||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))},e.prototype.addParticleSystem=function(t){this._blockEntityCollection||this.particleSystems.push(t)},e.prototype.addAnimation=function(t){this._blockEntityCollection||this.animations.push(t)},e.prototype.addAnimationGroup=function(t){this._blockEntityCollection||this.animationGroups.push(t)},e.prototype.addMultiMaterial=function(t){this._blockEntityCollection||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))},e.prototype.addMaterial=function(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneMaterialArray!==-1||(t._indexInSceneMaterialArray=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))},e.prototype.addMorphTargetManager=function(t){this._blockEntityCollection||this.morphTargetManagers.push(t)},e.prototype.addGeometry=function(t){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=this.geometries.length),this.geometries.push(t))},e.prototype.addActionManager=function(t){this.actionManagers.push(t)},e.prototype.addTexture=function(t){this._blockEntityCollection||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))},e.prototype.switchActiveCamera=function(t,i){i===void 0&&(i=!0);var n=this._engine.getInputElement();!n||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,i&&t.attachControl())},e.prototype.setActiveCameraById=function(t){var i=this.getCameraById(t);return i?(this.activeCamera=i,i):null},e.prototype.setActiveCameraByName=function(t){var i=this.getCameraByName(t);return i?(this.activeCamera=i,i):null},e.prototype.getAnimationGroupByName=function(t){for(var i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===t)return this.animationGroups[i];return null},e.prototype.getMaterialByUniqueID=function(t){for(var i=0;i<this.materials.length;i++)if(this.materials[i].uniqueId===t)return this.materials[i];return null},e.prototype.getMaterialById=function(t){for(var i=0;i<this.materials.length;i++)if(this.materials[i].id===t)return this.materials[i];return null},e.prototype.getLastMaterialById=function(t,i){i===void 0&&(i=!1);for(var n=this.materials.length-1;n>=0;n--)if(this.materials[n].id===t)return this.materials[n];if(i){for(var n=this.multiMaterials.length-1;n>=0;n--)if(this.multiMaterials[n].id===t)return this.multiMaterials[n]}return null},e.prototype.getMaterialByName=function(t){for(var i=0;i<this.materials.length;i++)if(this.materials[i].name===t)return this.materials[i];return null},e.prototype.getTextureByUniqueId=function(t){for(var i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===t)return this.textures[i];return null},e.prototype.getTextureByName=function(t){for(var i=0;i<this.textures.length;i++)if(this.textures[i].name===t)return this.textures[i];return null},e.prototype.getCameraById=function(t){for(var i=0;i<this.cameras.length;i++)if(this.cameras[i].id===t)return this.cameras[i];return null},e.prototype.getCameraByUniqueId=function(t){for(var i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===t)return this.cameras[i];return null},e.prototype.getCameraByName=function(t){for(var i=0;i<this.cameras.length;i++)if(this.cameras[i].name===t)return this.cameras[i];return null},e.prototype.getBoneById=function(t){for(var i=0;i<this.skeletons.length;i++)for(var n=this.skeletons[i],o=0;o<n.bones.length;o++)if(n.bones[o].id===t)return n.bones[o];return null},e.prototype.getBoneByName=function(t){for(var i=0;i<this.skeletons.length;i++)for(var n=this.skeletons[i],o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];return null},e.prototype.getLightByName=function(t){for(var i=0;i<this.lights.length;i++)if(this.lights[i].name===t)return this.lights[i];return null},e.prototype.getLightById=function(t){for(var i=0;i<this.lights.length;i++)if(this.lights[i].id===t)return this.lights[i];return null},e.prototype.getLightByUniqueId=function(t){for(var i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===t)return this.lights[i];return null},e.prototype.getParticleSystemById=function(t){for(var i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===t)return this.particleSystems[i];return null},e.prototype.getGeometryById=function(t){for(var i=0;i<this.geometries.length;i++)if(this.geometries[i].id===t)return this.geometries[i];return null},e.prototype._getGeometryByUniqueId=function(t){if(this._geometriesByUniqueId){var i=this._geometriesByUniqueId[t];if(i!==void 0)return this.geometries[i]}else for(var i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===t)return this.geometries[i];return null},e.prototype.pushGeometry=function(t,i){return!i&&this._getGeometryByUniqueId(t.uniqueId)?!1:(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),!0)},e.prototype.removeGeometry=function(t){var i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[t.uniqueId],i===void 0)return!1}else if(i=this.geometries.indexOf(t),i<0)return!1;if(i!==this.geometries.length-1){var n=this.geometries[this.geometries.length-1];n&&(this.geometries[i]=n,this._geometriesByUniqueId&&(this._geometriesByUniqueId[n.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0},e.prototype.getGeometries=function(){return this.geometries},e.prototype.getMeshById=function(t){for(var i=0;i<this.meshes.length;i++)if(this.meshes[i].id===t)return this.meshes[i];return null},e.prototype.getMeshesById=function(t){return this.meshes.filter(function(i){return i.id===t})},e.prototype.getTransformNodeById=function(t){for(var i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null},e.prototype.getTransformNodeByUniqueId=function(t){for(var i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===t)return this.transformNodes[i];return null},e.prototype.getTransformNodesById=function(t){return this.transformNodes.filter(function(i){return i.id===t})},e.prototype.getMeshByUniqueId=function(t){for(var i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===t)return this.meshes[i];return null},e.prototype.getLastMeshById=function(t){for(var i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];return null},e.prototype.getLastEntryById=function(t){var i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===t)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===t)return this.lights[i];return null},e.prototype.getNodeById=function(t){var i=this.getMeshById(t);if(i)return i;var n=this.getTransformNodeById(t);if(n)return n;var o=this.getLightById(t);if(o)return o;var a=this.getCameraById(t);if(a)return a;var s=this.getBoneById(t);return s||null},e.prototype.getNodeByName=function(t){var i=this.getMeshByName(t);if(i)return i;var n=this.getTransformNodeByName(t);if(n)return n;var o=this.getLightByName(t);if(o)return o;var a=this.getCameraByName(t);if(a)return a;var s=this.getBoneByName(t);return s||null},e.prototype.getMeshByName=function(t){for(var i=0;i<this.meshes.length;i++)if(this.meshes[i].name===t)return this.meshes[i];return null},e.prototype.getTransformNodeByName=function(t){for(var i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===t)return this.transformNodes[i];return null},e.prototype.getLastSkeletonById=function(t){for(var i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===t)return this.skeletons[i];return null},e.prototype.getSkeletonByUniqueId=function(t){for(var i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===t)return this.skeletons[i];return null},e.prototype.getSkeletonById=function(t){for(var i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===t)return this.skeletons[i];return null},e.prototype.getSkeletonByName=function(t){for(var i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===t)return this.skeletons[i];return null},e.prototype.getMorphTargetManagerById=function(t){for(var i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===t)return this.morphTargetManagers[i];return null},e.prototype.getMorphTargetById=function(t){for(var i=0;i<this.morphTargetManagers.length;++i)for(var n=this.morphTargetManagers[i],o=0;o<n.numTargets;++o){var a=n.getTarget(o);if(a.id===t)return a}return null},e.prototype.getMorphTargetByName=function(t){for(var i=0;i<this.morphTargetManagers.length;++i)for(var n=this.morphTargetManagers[i],o=0;o<n.numTargets;++o){var a=n.getTarget(o);if(a.name===t)return a}return null},e.prototype.getPostProcessByName=function(t){for(var i=0;i<this.postProcesses.length;++i){var n=this.postProcesses[i];if(n.name===t)return n}return null},e.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid||(this._uid=he.RandomId()),this._uid},enumerable:!1,configurable:!0}),e.prototype.addExternalData=function(t,i){return this._externalData||(this._externalData=new Ea),this._externalData.add(t,i)},e.prototype.getExternalData=function(t){return this._externalData?this._externalData.get(t):null},e.prototype.getOrAddExternalDataWithFactory=function(t,i){return this._externalData||(this._externalData=new Ea),this._externalData.getOrAddWithFactory(t,i)},e.prototype.removeExternalData=function(t){return this._externalData.remove(t)},e.prototype._evaluateSubMesh=function(t,i,n){if(n.hasInstances||n.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh||i.subMeshes.length===1||t.isInFrustum(this._frustumPlanes)){for(var o=0,a=this._evaluateSubMeshStage;o<a.length;o++){var s=a[o];s.action(i,t)}var f=t.getMaterial();f!=null&&(f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures())),this._renderingManager.dispatch(t,i,f))}},e.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()},Object.defineProperty(e.prototype,"blockfreeActiveMeshesAndRenderingGroups",{get:function(){return this._preventFreeActiveMeshesAndRenderingGroups},set:function(t){this._preventFreeActiveMeshesAndRenderingGroups!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=t)},enumerable:!1,configurable:!0}),e.prototype.freeActiveMeshes=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(var t=0;t<this.activeCameras.length;t++){var i=this.activeCameras[t];i&&i._activeMeshes&&i._activeMeshes.dispose()}},e.prototype.freeRenderingGroups=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(var t=0;t<this.textures.length;t++){var i=this.textures[t];i&&i.renderList&&i.freeRenderingGroups()}},e.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},e.prototype.freezeActiveMeshes=function(t,i,n,o,a){var s=this;return t===void 0&&(t=!1),o===void 0&&(o=!0),a===void 0&&(a=!1),this.executeWhenReady(function(){if(!s.activeCamera){n&&n("No active camera found");return}if(s._frustumPlanes||s.updateTransformMatrix(),s._evaluateActiveMeshes(),s._activeMeshesFrozen=!0,s._activeMeshesFrozenButKeepClipping=a,s._skipEvaluateActiveMeshesCompletely=t,o)for(var f=0;f<s._activeMeshes.length;f++)s._activeMeshes.data[f]._freeze();i&&i()}),this},e.prototype.unfreezeActiveMeshes=function(){for(var t=0;t<this.meshes.length;t++){var i=this.meshes[t];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(var t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._unFreeze();return this._activeMeshesFrozen=!1,this},e.prototype._executeActiveContainerCleanup=function(t){var i=this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1;!i&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(function(){return t.dispose()})},e.prototype._evaluateActiveMeshes=function(){var t;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((t=this.activeCamera)===null||t===void 0||t._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely)for(var i=this._activeMeshes.length,n=0;n<i;n++){var o=this._activeMeshes.data[n];o.computeWorldMatrix()}if(this._activeParticleSystems)for(var a=this._activeParticleSystems.length,n=0;n<a;n++)this._activeParticleSystems.data[n].animate();return}if(!!this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(var s=0,f=this._beforeEvaluateActiveMeshStage;s<f.length;s++){var u=f[s];u.action()}for(var l=this.getActiveMeshCandidates(),h=l.length,n=0;n<h;n++){var o=l.data[n];if(o._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,!o.isBlocked&&(this._totalVertices.addCount(o.getTotalVertices(),!1),!(!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent))){o.computeWorldMatrix(),o.actionManager&&o.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(o);var c=this.customLODSelector?this.customLODSelector(o,this.activeCamera):o.getLOD(this.activeCamera);if(o._internalAbstractMeshDataInfo._currentLOD=c,o._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,c!=null&&(c!==o&&c.billboardMode!==0&&c.computeWorldMatrix(),o._preActivate(),o.isVisible&&o.visibility>0&&(o.layerMask&this.activeCamera.layerMask)!==0&&(this._skipFrustumClipping||o.alwaysSelectAsActiveMesh||o.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(o),this.activeCamera._activeMeshes.push(o),c!==o&&c._activate(this._renderId,!1);for(var p=0,d=this._preActiveMeshStage;p<d.length;p++){var u=d[p];u.action(o)}o._activate(this._renderId,!1)&&(o.isAnInstance?o._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=o):c._internalAbstractMeshDataInfo._onlyForInstances=!1,c._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(o,c)),o._postActivate()}}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var m=0;m<this.particleSystems.length;m++){var _=this.particleSystems[m];if(!(!_.isStarted()||!_.emitter)){var y=_.emitter;(!y.position||y.isEnabled())&&(this._activeParticleSystems.push(_),_.animate(),this._renderingManager.dispatchParticles(_))}}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}},e.prototype._activeMesh=function(t,i){if(this._skeletonsEnabled&&i.skeleton!==null&&i.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i)),i&&i.subMeshes&&i.subMeshes.length>0)for(var n=this.getActiveSubMeshCandidates(i),o=n.length,a=0;a<o;a++){var s=n.data[a];this._evaluateSubMesh(s,i,t)}},e.prototype.updateTransformMatrix=function(t){if(!!this.activeCamera)if(this.activeCamera._renderingMultiview){var i=this.activeCamera._rigCameras[0],n=this.activeCamera._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(t),n.getViewMatrix(),n.getProjectionMatrix(t))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))},e.prototype._bindFrameBuffer=function(t,i){i===void 0&&(i=!0),t&&t._multiviewTexture?t._multiviewTexture._bindFrameBuffer():t&&t.outputRenderTarget?t.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(t)},e.prototype._clearFrameBuffer=function(t){if(!(t&&t._multiviewTexture))if(t&&t.outputRenderTarget){var i=t.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):i.skipInitialClear||(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())},e.prototype._renderForCamera=function(t,i,n){var o,a,s;if(n===void 0&&(n=!0),!(t&&t._skipRendering)){var f=this._engine;if(this._activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");if(f.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&n){var u=!0;t._renderingMultiview&&t.outputRenderTarget&&(u=t.outputRenderTarget.skipInitialClear,this.autoClear&&(t.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),t._renderingMultiview&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=u)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var l=0;l<this._softwareSkinnedMeshes.length;l++){var h=this._softwareSkinnedMeshes.data[l];h.applySkeleton(h.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(var c=0,p=this._gatherActiveCameraRenderTargetsStage;c<p.length;c++){var d=p[c];d.action(this._renderTargets)}var m=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){he.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var _=0;_<this._renderTargets.length;_++){var y=this._renderTargets.data[_];if(y._shouldRender()){this._renderId++;var g=y.activeCamera&&y.activeCamera!==this.activeCamera;y.render(g,this.dumpNextRenderTargets),m=!0}}he.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(var T=0,A=this._cameraDrawRenderTargetStage;T<A.length;T++){var d=A[T];m=d.action(this.activeCamera)||m}this._intermediateRendering=!1}this._engine.currentRenderPassId=(s=(a=(o=t.outputRenderTarget)===null||o===void 0?void 0:o.renderPassId)!==null&&a!==void 0?a:t.renderPassId)!==null&&s!==void 0?s:0,m&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!t._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(var M=0,C=this._beforeCameraDrawStage;M<C.length;M++){var d=C[M];d.action(this.activeCamera)}this.onBeforeDrawPhaseObservable.notifyObservers(this),f.snapshotRendering&&f.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(var P=0,R=this._afterCameraDrawStage;P<R.length;P++){var d=R[P];d.action(this.activeCamera)}if(this.postProcessManager&&!t._multiviewTexture){var F=t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(t.isIntermediate,F)}this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}},e.prototype._processSubCameras=function(t,i){if(i===void 0&&(i=!0),t.cameraRigMode===0||t._renderingMultiview){t._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(t,void 0,i),this.onAfterRenderCameraObservable.notifyObservers(t);return}if(t._useMultiviewToSingleView)this._renderMultiviewToSingleView(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(var n=0;n<t._rigCameras.length;n++)this._renderForCamera(t._rigCameras[n],t)}this._activeCamera=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)},e.prototype._checkIntersections=function(){for(var t=0;t<this._meshesForIntersections.length;t++){var i=this._meshesForIntersections.data[t];if(!!i.actionManager)for(var n=function(a){var s=i.actionManager.actions[a];if(s.trigger===12||s.trigger===13){var f=s.getTriggerParameter(),u=f.mesh?f.mesh:f,l=u.intersectsMesh(i,f.usePreciseIntersection),h=i._intersectionsInProgress.indexOf(u);l&&h===-1?s.trigger===12?(s._executeCurrent(it.CreateNew(i,void 0,u)),i._intersectionsInProgress.push(u)):s.trigger===13&&i._intersectionsInProgress.push(u):!l&&h>-1&&(s.trigger===13&&s._executeCurrent(it.CreateNew(i,void 0,u)),(!i.actionManager.hasSpecificTrigger(13,function(c){var p=c.mesh?c.mesh:c;return u===p})||s.trigger===13)&&i._intersectionsInProgress.splice(h,1))}},o=0;i.actionManager&&o<i.actionManager.actions.length;o++)n(o)}},e.prototype._advancePhysicsEngineStep=function(t){},e.prototype._animate=function(){},e.prototype.animate=function(){if(this._engine.isDeterministicLockStep()){var t=Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime))+this._timeAccumulator,i=this._engine.getTimeStep(),n=1e3/i/1e3,o=0,a=this._engine.getLockstepMaxSteps(),s=Math.floor(t/i);for(s=Math.min(s,a);t>0&&o<s;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*n,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,o++,t-=i;this._timeAccumulator=t<0?0:t}else{var t=this.useConstantAnimationDeltaTime?16:Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime));this._animationRatio=t*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}},e.prototype._clear=function(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)},e.prototype._checkCameraRenderTarget=function(t){var i;if((t==null?void 0:t.outputRenderTarget)&&!(t!=null&&t.isRigCamera)&&(t.outputRenderTarget._cleared=!1),!((i=t==null?void 0:t.rigCameras)===null||i===void 0)&&i.length)for(var n=0;n<t.rigCameras.length;++n){var o=t.rigCameras[n].outputRenderTarget;o&&(o._cleared=!1)}},e.prototype.resetDrawCache=function(t){if(!!this.meshes)for(var i=0,n=this.meshes;i<n.length;i++){var o=n[i];o.resetDrawCache(t)}},e.prototype.render=function(t,i){var n,o,a;if(t===void 0&&(t=!0),i===void 0&&(i=!1),!this.isDisposed){this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((n=this.activeCameras)===null||n===void 0)&&n.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(var s=0,f=this._beforeCameraUpdateStage;s<f.length;s++){var u=f[s];u.action()}if(t){if(this.activeCameras&&this.activeCameras.length>0)for(var l=0;l<this.activeCameras.length;l++){var h=this.activeCameras[l];if(h.update(),h.cameraRigMode!==0)for(var c=0;c<h._rigCameras.length;c++)h._rigCameras[c].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(var c=0;c<this.activeCamera._rigCameras.length;c++)this.activeCamera._rigCameras[c].update()}this.onBeforeRenderObservable.notifyObservers(this);var p=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var d=!((o=this.activeCameras)===null||o===void 0)&&o.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){he.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(var m=0;m<this.customRenderTargets.length;m++){var _=this.customRenderTargets[m];if(_._shouldRender()){if(this._renderId++,this.activeCamera=_.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");p.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),_.render(d!==this.activeCamera,this.dumpNextRenderTargets)}}he.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(a=d==null?void 0:d.renderPassId)!==null&&a!==void 0?a:0,this.activeCamera=d,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(var y=0,g=this._beforeClearStage;y<g.length;y++){var u=g[y];u.action()}this._clearFrameBuffer(this.activeCamera);for(var T=0,A=this._gatherRenderTargetsStage;T<A.length;T++){var u=A[T];u.action(this._renderTargets)}var M=this._activeCamera;if(this.activeCameras&&this.activeCameras.length>0)for(var l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._activeCamera=M,this._checkIntersections();for(var C=0,P=this._afterRenderStage;C<P.length;C++){var u=P[C];u.action()}if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(var c=0;c<this._toBeDisposed.length;c++){var R=this._toBeDisposed[c];R&&R.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}},e.prototype.freezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].freeze()},e.prototype.unfreezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].unfreeze()},e.prototype.dispose=function(){var t;if(!this.isDisposed){this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;for(var i=this._activeRequests.slice(),n=0,o=i;n<o.length;n++){var a=o[n];a.abort()}this._activeRequests.length=0,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onComputePressureChanged.clear(),(t=this._computePressureObserver)===null||t===void 0||t.unobserve("cpu"),this._computePressureObserver=void 0,this.detachControl();var s=this._engine.getInputElement();if(s)for(var f=0;f<this.cameras.length;f++)this.cameras[f].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,function(l){return l.dispose(!0)}),this._disposeList(this.transformNodes,function(l){return l.dispose(!0)}),this._disposeList(this.cameras),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);var u=this._engine.scenes.indexOf(this);u>-1&&this._engine.scenes.splice(u,1),le._LastCreatedScene===this&&(this._engine.scenes.length>0?le._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:le._LastCreatedScene=null),u=this._engine._virtualScenes.indexOf(this),u>-1&&this._engine._virtualScenes.splice(u,1),this._engine.wipeCaches(!0),this._isDisposed=!0}},e.prototype._disposeList=function(t,i){var n=t.slice(0);i=i!=null?i:function(f){return f.dispose()};for(var o=0,a=n;o<a.length;o++){var s=a[o];i(s)}t.length=0},Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),e.prototype.clearCachedVertexData=function(){for(var t=0;t<this.meshes.length;t++){var i=this.meshes[t],n=i.geometry;n&&n.clearCachedData()}},e.prototype.cleanCachedTextureBuffer=function(){for(var t=0,i=this.textures;t<i.length;t++){var n=i[t],o=n._buffer;o&&(n._buffer=null)}},e.prototype.getWorldExtends=function(t){var i=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return t=t||function(){return!0},this.meshes.filter(t).forEach(function(o){if(o.computeWorldMatrix(!0),!(!o.subMeshes||o.subMeshes.length===0||o.infiniteDistance)){var a=o.getBoundingInfo(),s=a.boundingBox.minimumWorld,f=a.boundingBox.maximumWorld;E.CheckExtends(s,i,n),E.CheckExtends(f,i,n)}}),{min:i,max:n}},e.prototype.createPickingRay=function(t,i,n,o,a){throw a===void 0&&(a=!1),Q("Ray")},e.prototype.createPickingRayToRef=function(t,i,n,o,a,s,f){throw s===void 0&&(s=!1),f===void 0&&(f=!1),Q("Ray")},e.prototype.createPickingRayInCameraSpace=function(t,i,n){throw Q("Ray")},e.prototype.createPickingRayInCameraSpaceToRef=function(t,i,n,o){throw Q("Ray")},e.prototype.pick=function(t,i,n,o,a,s){var f=new bt;return f._pickingUnavailable=!0,f},e.prototype.pickWithBoundingInfo=function(t,i,n,o,a){var s=new bt;return s._pickingUnavailable=!0,s},e.prototype.pickWithRay=function(t,i,n,o){throw Q("Ray")},e.prototype.multiPick=function(t,i,n,o,a){throw Q("Ray")},e.prototype.multiPickWithRay=function(t,i,n){throw Q("Ray")},e.prototype.setPointerOverMesh=function(t,i,n){this._inputManager.setPointerOverMesh(t,i,n)},e.prototype.getPointerOverMesh=function(){return this._inputManager.getPointerOverMesh()},e.prototype._rebuildGeometries=function(){for(var t=0,i=this.geometries;t<i.length;t++){var n=i[t];n._rebuild()}for(var o=0,a=this.meshes;o<a.length;o++){var s=a[o];s._rebuild()}this.postProcessManager&&this.postProcessManager._rebuild();for(var f=0,u=this._components;f<u.length;f++){var l=u[f];l.rebuild()}for(var h=0,c=this.particleSystems;h<c.length;h++){var p=c[h];p.rebuild()}if(this.spriteManagers)for(var d=0,m=this.spriteManagers;d<m.length;d++){var _=m[d];_.rebuild()}},e.prototype._rebuildTextures=function(){for(var t=0,i=this.textures;t<i.length;t++){var n=i[t];n._rebuild()}this.markAllMaterialsAsDirty(1)},e.prototype._getByTags=function(t,i,n){if(i===void 0)return t;var o=[];n=n||function(f){};for(var a in t){var s=t[a];Ee&&Ee.MatchesQuery(s,i)&&(o.push(s),n(s))}return o},e.prototype.getMeshesByTags=function(t,i){return this._getByTags(this.meshes,t,i)},e.prototype.getCamerasByTags=function(t,i){return this._getByTags(this.cameras,t,i)},e.prototype.getLightsByTags=function(t,i){return this._getByTags(this.lights,t,i)},e.prototype.getMaterialByTags=function(t,i){return this._getByTags(this.materials,t,i).concat(this._getByTags(this.multiMaterials,t,i))},e.prototype.getTransformNodesByTags=function(t,i){return this._getByTags(this.transformNodes,t,i)},e.prototype.setRenderingOrder=function(t,i,n,o){i===void 0&&(i=null),n===void 0&&(n=null),o===void 0&&(o=null),this._renderingManager.setRenderingOrder(t,i,n,o)},e.prototype.setRenderingAutoClearDepthStencil=function(t,i,n,o){n===void 0&&(n=!0),o===void 0&&(o=!0),this._renderingManager.setRenderingAutoClearDepthStencil(t,i,n,o)},e.prototype.getAutoClearDepthStencilSetup=function(t){return this._renderingManager.getAutoClearDepthStencilSetup(t)},Object.defineProperty(e.prototype,"blockMaterialDirtyMechanism",{get:function(){return this._blockMaterialDirtyMechanism},set:function(t){this._blockMaterialDirtyMechanism!==t&&(this._blockMaterialDirtyMechanism=t,t||this.markAllMaterialsAsDirty(63))},enumerable:!1,configurable:!0}),e.prototype.markAllMaterialsAsDirty=function(t,i){if(!this._blockMaterialDirtyMechanism)for(var n=0,o=this.materials;n<o.length;n++){var a=o[n];i&&!i(a)||a.markAsDirty(t)}},e.prototype._loadFile=function(t,i,n,o,a,s,f){var u=this,l=rr(t,i,n,o?this.offlineProvider:void 0,a,s,f);return this._activeRequests.push(l),l.onCompleteObservable.add(function(h){u._activeRequests.splice(u._activeRequests.indexOf(h),1)}),l},e.prototype._loadFileAsync=function(t,i,n,o,a){var s=this;return new Promise(function(f,u){s._loadFile(t,function(l){f(l)},i,n,o,function(l,h){u(h)},a)})},e.prototype._requestFile=function(t,i,n,o,a,s,f){var u=this,l=Un(t,i,n,o?this.offlineProvider:void 0,a,s,f);return this._activeRequests.push(l),l.onCompleteObservable.add(function(h){u._activeRequests.splice(u._activeRequests.indexOf(h),1)}),l},e.prototype._requestFileAsync=function(t,i,n,o,a){var s=this;return new Promise(function(f,u){s._requestFile(t,function(l){f(l)},i,n,o,function(l){u(l)},a)})},e.prototype._readFile=function(t,i,n,o,a){var s=this,f=Dr(t,i,n,o,a);return this._activeRequests.push(f),f.onCompleteObservable.add(function(u){s._activeRequests.splice(s._activeRequests.indexOf(u),1)}),f},e.prototype._readFileAsync=function(t,i,n){var o=this;return new Promise(function(a,s){o._readFile(t,function(f){a(f)},i,n,function(f){s(f)})})},e.prototype.getPerfCollector=function(){throw Q("performanceViewerSceneExtension")},e.FOGMODE_NONE=0,e.FOGMODE_EXP=1,e.FOGMODE_EXP2=2,e.FOGMODE_LINEAR=3,e.MinDeltaTime=1,e.MaxDeltaTime=1e3,e}(Ch);ue.prototype.setActiveCameraByID=function(r){return this.setActiveCameraById(r)};ue.prototype.getLastMaterialByID=function(r){return this.getLastMaterialById(r)};ue.prototype.getMaterialByID=function(r){return this.getMaterialById(r)};ue.prototype.getTextureByUniqueID=function(r){return this.getTextureByUniqueId(r)};ue.prototype.getCameraByID=function(r){return this.getCameraById(r)};ue.prototype.getCameraByUniqueID=function(r){return this.getCameraByUniqueId(r)};ue.prototype.getBoneByID=function(r){return this.getBoneById(r)};ue.prototype.getLightByID=function(r){return this.getLightById(r)};ue.prototype.getLightByUniqueID=function(r){return this.getLightByUniqueId(r)};ue.prototype.getParticleSystemByID=function(r){return this.getParticleSystemById(r)};ue.prototype.getGeometryByID=function(r){return this.getGeometryById(r)};ue.prototype.getMeshByID=function(r){return this.getMeshById(r)};ue.prototype.getMeshesByID=function(r){return this.getMeshesById(r)};ue.prototype.getTransformNodeByID=function(r){return this.getTransformNodeById(r)};ue.prototype.getTransformNodeByUniqueID=function(r){return this.getTransformNodeByUniqueId(r)};ue.prototype.getTransformNodesByID=function(r){return this.getTransformNodesById(r)};ue.prototype.getMeshByUniqueID=function(r){return this.getMeshByUniqueId(r)};ue.prototype.getLastMeshByID=function(r){return this.getLastMeshById(r)};ue.prototype.getLastEntryByID=function(r){return this.getLastEntryById(r)};ue.prototype.getNodeByID=function(r){return this.getNodeById(r)};ue.prototype.getLastSkeletonByID=function(r){return this.getLastSkeletonById(r)};v();var jh=function(){function r(){}return r.BindClipPlane=function(e,t){if(t.clipPlane){var i=t.clipPlane;e.setFloat4("vClipPlane",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane2){var i=t.clipPlane2;e.setFloat4("vClipPlane2",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane3){var i=t.clipPlane3;e.setFloat4("vClipPlane3",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane4){var i=t.clipPlane4;e.setFloat4("vClipPlane4",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane5){var i=t.clipPlane5;e.setFloat4("vClipPlane5",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane6){var i=t.clipPlane6;e.setFloat4("vClipPlane6",i.normal.x,i.normal.y,i.normal.z,i.d)}},r}();var se=function(){function r(){}return r.BindSceneUniformBuffer=function(e,t){t.bindToEffect(e,"Scene")},r.PrepareDefinesForMergedUV=function(e,t,i){t._needUVs=!0,t[i]=!0,e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0},r.BindTextureMatrix=function(e,t,i){var n=e.getTextureMatrix();t.updateMatrix(i+"Matrix",n)},r.GetFogState=function(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==ue.FOGMODE_NONE},r.PrepareDefinesForMisc=function(e,t,i,n,o,a,s){s._areMiscDirty&&(s.LOGARITHMICDEPTH=i,s.POINTSIZE=n,s.FOG=o&&this.GetFogState(e,t),s.NONUNIFORMSCALING=e.nonUniformScaling,s.ALPHATEST=a)},r.PrepareDefinesForFrameBoundValues=function(e,t,i,n,o,a){o===void 0&&(o=null),a===void 0&&(a=!1);var s=!1,f=!1,u=!1,l=!1,h=!1,c=!1,p=!1;f=o==null?e.clipPlane!==void 0&&e.clipPlane!==null:o,u=o==null?e.clipPlane2!==void 0&&e.clipPlane2!==null:o,l=o==null?e.clipPlane3!==void 0&&e.clipPlane3!==null:o,h=o==null?e.clipPlane4!==void 0&&e.clipPlane4!==null:o,c=o==null?e.clipPlane5!==void 0&&e.clipPlane5!==null:o,p=o==null?e.clipPlane6!==void 0&&e.clipPlane6!==null:o,i.CLIPPLANE!==f&&(i.CLIPPLANE=f,s=!0),i.CLIPPLANE2!==u&&(i.CLIPPLANE2=u,s=!0),i.CLIPPLANE3!==l&&(i.CLIPPLANE3=l,s=!0),i.CLIPPLANE4!==h&&(i.CLIPPLANE4=h,s=!0),i.CLIPPLANE5!==c&&(i.CLIPPLANE5=c,s=!0),i.CLIPPLANE6!==p&&(i.CLIPPLANE6=p,s=!0),i.DEPTHPREPASS!==!t.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,s=!0),i.INSTANCES!==n&&(i.INSTANCES=n,s=!0),i.INSTANCESCOLOR&&!i.INSTANCES&&(i.INSTANCESCOLOR=!1,s=!0),i.THIN_INSTANCES!==a&&(i.THIN_INSTANCES=a,s=!0),s&&i.markAsUnprocessed()},r.PrepareDefinesForBones=function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;var i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;var n=e.getScene().prePassRenderer;if(n&&n.enabled){var o=n.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=o}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0},r.PrepareDefinesForMorphTargets=function(e,t){var i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)},r.PrepareDefinesForBakedVertexAnimation=function(e,t){var i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)},r.PrepareDefinesForAttributes=function(e,t,i,n,o,a,s){if(o===void 0&&(o=!1),a===void 0&&(a=!0),s===void 0&&(s=!0),!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(b.NormalKind),t._needNormals&&e.isVerticesDataPresent(b.TangentKind)&&(t.TANGENT=!0);for(var f=1;f<=6;++f)t["UV"+f]=t._needUVs?e.isVerticesDataPresent("uv".concat(f===1?"":f)):!1;if(i){var u=e.useVertexColors&&e.isVerticesDataPresent(b.ColorKind);t.VERTEXCOLOR=u,t.VERTEXALPHA=e.hasVertexAlpha&&u&&a}return e.isVerticesDataPresent(b.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,t),o&&this.PrepareDefinesForMorphTargets(e,t),s&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0},r.PrepareDefinesForMultiview=function(e,t){if(e.activeCamera){var i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}},r.PrepareDefinesForOIT=function(e,t,i){var n=t.ORDER_INDEPENDENT_TRANSPARENCY,o=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==t.ORDER_INDEPENDENT_TRANSPARENCY||o!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()},r.PrepareDefinesForPrePass=function(e,t,i){var n=t.PREPASS;if(!!t._arePrePassDirty){var o=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(var a=0;a<o.length;a++){var s=e.prePassRenderer.getIndex(o[a].type);s!==-1?(t[o[a].define]=!0,t[o[a].index]=s):t[o[a].define]=!1}}else{t.PREPASS=!1;for(var a=0;a<o.length;a++)t[o[a].define]=!1}t.PREPASS!=n&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}},r.PrepareDefinesForLight=function(e,t,i,n,o,a,s){switch(s.needNormals=!0,o["LIGHT"+n]===void 0&&(s.needRebuild=!0),o["LIGHT"+n]=!0,o["SPOTLIGHT"+n]=!1,o["HEMILIGHT"+n]=!1,o["POINTLIGHT"+n]=!1,o["DIRLIGHT"+n]=!1,i.prepareLightSpecificDefines(o,n),o["LIGHT_FALLOFF_PHYSICAL"+n]=!1,o["LIGHT_FALLOFF_GLTF"+n]=!1,o["LIGHT_FALLOFF_STANDARD"+n]=!1,i.falloffType){case Fe.FALLOFF_GLTF:o["LIGHT_FALLOFF_GLTF"+n]=!0;break;case Fe.FALLOFF_PHYSICAL:o["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case Fe.FALLOFF_STANDARD:o["LIGHT_FALLOFF_STANDARD"+n]=!0;break}if(a&&!i.specular.equalsFloats(0,0,0)&&(s.specularEnabled=!0),o["SHADOW"+n]=!1,o["SHADOWCSM"+n]=!1,o["SHADOWCSMDEBUG"+n]=!1,o["SHADOWCSMNUM_CASCADES"+n]=!1,o["SHADOWCSMUSESHADOWMAXZ"+n]=!1,o["SHADOWCSMNOBLEND"+n]=!1,o["SHADOWCSM_RIGHTHANDED"+n]=!1,o["SHADOWPCF"+n]=!1,o["SHADOWPCSS"+n]=!1,o["SHADOWPOISSON"+n]=!1,o["SHADOWESM"+n]=!1,o["SHADOWCLOSEESM"+n]=!1,o["SHADOWCUBE"+n]=!1,o["SHADOWLOWQUALITY"+n]=!1,o["SHADOWMEDIUMQUALITY"+n]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){var f=i.getShadowGenerator();if(f){var u=f.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(s.shadowEnabled=!0,f.prepareDefines(o,n))}}i.lightmapMode!=Fe.LIGHTMAP_DEFAULT?(s.lightmapMode=!0,o["LIGHTMAPEXCLUDED"+n]=!0,o["LIGHTMAPNOSPECULAR"+n]=i.lightmapMode==Fe.LIGHTMAP_SHADOWSONLY):(o["LIGHTMAPEXCLUDED"+n]=!1,o["LIGHTMAPNOSPECULAR"+n]=!1)},r.PrepareDefinesForLights=function(e,t,i,n,o,a){if(o===void 0&&(o=4),a===void 0&&(a=!1),!i._areLightsDirty)return i._needNormals;var s=0,f={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!a)for(var u=0,l=t.lightSources;u<l.length;u++){var h=l[u];if(this.PrepareDefinesForLight(e,t,h,s,i,n,f),s++,s===o)break}i.SPECULARTERM=f.specularEnabled,i.SHADOWS=f.shadowEnabled;for(var c=s;c<o;c++)i["LIGHT"+c]!==void 0&&(i["LIGHT"+c]=!1,i["HEMILIGHT"+c]=!1,i["POINTLIGHT"+c]=!1,i["DIRLIGHT"+c]=!1,i["SPOTLIGHT"+c]=!1,i["SHADOW"+c]=!1,i["SHADOWCSM"+c]=!1,i["SHADOWCSMDEBUG"+c]=!1,i["SHADOWCSMNUM_CASCADES"+c]=!1,i["SHADOWCSMUSESHADOWMAXZ"+c]=!1,i["SHADOWCSMNOBLEND"+c]=!1,i["SHADOWCSM_RIGHTHANDED"+c]=!1,i["SHADOWPCF"+c]=!1,i["SHADOWPCSS"+c]=!1,i["SHADOWPOISSON"+c]=!1,i["SHADOWESM"+c]=!1,i["SHADOWCLOSEESM"+c]=!1,i["SHADOWCUBE"+c]=!1,i["SHADOWLOWQUALITY"+c]=!1,i["SHADOWMEDIUMQUALITY"+c]=!1);var p=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(f.needRebuild=!0),i.SHADOWFLOAT=f.shadowEnabled&&(p.textureFloatRender&&p.textureFloatLinearFiltering||p.textureHalfFloatRender&&p.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=f.lightmapMode,f.needRebuild&&i.rebuild(),f.needNormals},r.PrepareUniformsAndSamplersForLight=function(e,t,i,n,o,a){o===void 0&&(o=null),a===void 0&&(a=!1),o&&o.push("Light"+e),!a&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))},r.PrepareUniformsAndSamplersList=function(e,t,i,n){n===void 0&&(n=4);var o,a=null;if(e.uniformsNames){var s=e;o=s.uniformsNames,a=s.uniformBuffersNames,t=s.samplers,i=s.defines,n=s.maxSimultaneousLights||0}else o=e,t||(t=[]);for(var f=0;f<n&&i["LIGHT"+f];f++)this.PrepareUniformsAndSamplersForLight(f,o,t,i["PROJECTEDLIGHTTEXTURE"+f],a);i.NUM_MORPH_INFLUENCERS&&o.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(o.push("bakedVertexAnimationSettings"),o.push("bakedVertexAnimationTextureSizeInverted"),o.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))},r.HandleFallbacksForShadows=function(e,t,i,n){i===void 0&&(i=4),n===void 0&&(n=0);for(var o=0,a=0;a<i&&e["LIGHT"+a];a++)a>0&&(o=n+a,t.addFallback(o,"LIGHT"+a)),e.SHADOWS||(e["SHADOW"+a]&&t.addFallback(n,"SHADOW"+a),e["SHADOWPCF"+a]&&t.addFallback(n,"SHADOWPCF"+a),e["SHADOWPCSS"+a]&&t.addFallback(n,"SHADOWPCSS"+a),e["SHADOWPOISSON"+a]&&t.addFallback(n,"SHADOWPOISSON"+a),e["SHADOWESM"+a]&&t.addFallback(n,"SHADOWESM"+a),e["SHADOWCLOSEESM"+a]&&t.addFallback(n,"SHADOWCLOSEESM"+a));return o++},r.PrepareAttributesForMorphTargetsInfluencers=function(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)},r.PrepareAttributesForMorphTargets=function(e,t,i){var n=i.NUM_MORPH_INFLUENCERS;if(n>0&&le.LastCreatedEngine){var o=le.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(a!=null&&a.isUsingTextureForTargets)return;for(var s=a&&a.supportsNormals&&i.NORMAL,f=a&&a.supportsTangents&&i.TANGENT,u=a&&a.supportsUVs&&i.UV1,l=0;l<n;l++)e.push(b.PositionKind+l),s&&e.push(b.NormalKind+l),f&&e.push(b.TangentKind+l),u&&e.push(b.UVKind+"_"+l),e.length>o&&q.Error("Cannot add more vertex attributes for mesh "+t.name)}},r.PrepareAttributesForBakedVertexAnimation=function(e,t,i){var n=i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES;n&&e.push("bakedVertexAnimationSettingsInstanced")},r.PrepareAttributesForBones=function(e,t,i,n){i.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,t),e.push(b.MatricesIndicesKind),e.push(b.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(b.MatricesIndicesExtraKind),e.push(b.MatricesWeightsExtraKind)))},r.PrepareAttributesForInstances=function(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(b.ColorInstanceKind)},r.PushAttributesForInstances=function(e,t){t===void 0&&(t=!1),e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))},r.BindLightProperties=function(e,t,i){e.transferToEffect(t,i+"")},r.BindLight=function(e,t,i,n,o,a){a===void 0&&(a=!0),e._bindLight(t,i,n,o,a)},r.BindLights=function(e,t,i,n,o){o===void 0&&(o=4);for(var a=Math.min(t.lightSources.length,o),s=0;s<a;s++){var f=t.lightSources[s];this.BindLight(f,s,e,i,typeof n=="boolean"?n:n.SPECULARTERM,t.receiveShadows)}},r.BindFogParameters=function(e,t,i,n){n===void 0&&(n=!1),e.fogEnabled&&t.applyFog&&e.fogMode!==ue.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))},r.BindBonesParameters=function(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){var n=e.skeleton;if(n.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){var o=n.getTransformMatrixTexture(e);t.setTexture("boneSampler",o),t.setFloat("boneTextureWidth",4*(n.bones.length+1))}else{var a=n.getTransformMatrices(e);a&&(t.setMatrices("mBones",a),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=a.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),r._CopyBonesTransformationMatrices(a,i.previousBones[e.uniqueId])))}}},r._CopyBonesTransformationMatrices=function(e,t){return t.set(e),t},r.BindMorphTargetParameters=function(e,t){var i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)},r.BindLogDepth=function(e,t,i){if(!e||e.LOGARITHMICDEPTH){var n=i.activeCamera;n.mode===Ye.ORTHOGRAPHIC_CAMERA&&q.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}},r.BindClipPlane=function(e,t){jh.BindClipPlane(e,t)},r._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},r._TempFogColor=de.Black(),r}();v();var Yh=function(){function r(){this.reset()}return r.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681},Object.defineProperty(r.prototype,"func",{get:function(){return this._func},set:function(e){this._func=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"funcRef",{get:function(){return this._funcRef},set:function(e){this._funcRef=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"funcMask",{get:function(){return this._funcMask},set:function(e){this._funcMask=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(e){this._opStencilFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(e){this._opDepthFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"MaterialStencilState"},r.prototype.copyTo=function(e){te.Clone(function(){return e},this)},r.prototype.serialize=function(){return te.Serialize(this)},r.prototype.parse=function(e,t,i){var n=this;te.Parse(function(){return n},e,t,i)},x([O()],r.prototype,"func",null),x([O()],r.prototype,"funcRef",null),x([O()],r.prototype,"funcMask",null),x([O()],r.prototype,"opStencilFail",null),x([O()],r.prototype,"opDepthFail",null),x([O()],r.prototype,"opStencilDepthPass",null),x([O()],r.prototype,"mask",null),x([O()],r.prototype,"enabled",null),r}();v();var qe;(function(r){r[r.Created=1]="Created",r[r.Disposed=2]="Disposed",r[r.GetDefineNames=4]="GetDefineNames",r[r.PrepareUniformBuffer=8]="PrepareUniformBuffer",r[r.IsReadyForSubMesh=16]="IsReadyForSubMesh",r[r.PrepareDefines=32]="PrepareDefines",r[r.BindForSubMesh=64]="BindForSubMesh",r[r.PrepareEffect=128]="PrepareEffect",r[r.GetAnimatables=256]="GetAnimatables",r[r.GetActiveTextures=512]="GetActiveTextures",r[r.HasTexture=1024]="HasTexture",r[r.FillRenderTargetTextures=2048]="FillRenderTargetTextures",r[r.HasRenderTargetTextures=4096]="HasRenderTargetTextures",r[r.HardBindForSubMesh=8192]="HardBindForSubMesh"})(qe||(qe={}));var De=function(){function r(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Yh,this._useUBO=!1,this._fillMode=r.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=function(){},this._callbackPluginEventIsReadyForSubMesh=function(){},this._callbackPluginEventPrepareDefines=function(){},this._callbackPluginEventPrepareDefinesBeforeAttributes=function(){},this._callbackPluginEventHardBindForSubMesh=function(){},this._callbackPluginEventBindForSubMesh=function(){},this._callbackPluginEventHasRenderTargetTextures=function(){},this._callbackPluginEventFillRenderTargetTextures=function(){},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;var n=t||le.LastCreatedScene;!n||(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||he.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new li(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=r.ClockWiseSideOrientation:this.sideOrientation=r.CounterClockWiseSideOrientation,this._uniformBuffer=new vr(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),r.OnEventObservable.notifyObservers(this,qe.Created))}return Object.defineProperty(r.prototype,"canRenderToMRT",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alpha",{get:function(){return this._alpha},set:function(e){if(this._alpha!==e){var t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(r.MiscDirtyFlag)}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(r.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cullBackFaces",{get:function(){return this._cullBackFaces},set:function(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(r.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasRenderTargetTextures",{get:function(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new U),this._onBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onBind",{set:function(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onUnBindObservable",{get:function(){return this._onUnBindObservable||(this._onUnBindObservable=new U),this._onUnBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onEffectCreatedObservable",{get:function(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new U),this._onEffectCreatedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaMode",{get:function(){return this._alphaMode},set:function(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(r.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isPrePassCapable",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(r.MiscDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wireframe",{get:function(){switch(this._fillMode){case r.WireFrameFillMode:case r.LineListDrawMode:case r.LineLoopDrawMode:case r.LineStripDrawMode:return!0}return this._scene.forceWireframe},set:function(e){this.fillMode=e?r.WireFrameFillMode:r.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"pointsCloud",{get:function(){switch(this._fillMode){case r.PointFillMode:case r.PointListDrawMode:return!0}return this._scene.forcePointsCloud},set:function(e){this.fillMode=e?r.PointFillMode:r.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fillMode",{get:function(){return this._fillMode},set:function(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(r.MiscDirtyFlag))},enumerable:!1,configurable:!0}),r.prototype._getDrawWrapper=function(){return this._drawWrapper},r.prototype._setDrawWrapper=function(e){this._drawWrapper=e},r.prototype.toString=function(e){var t="Name: "+this.name;return t},r.prototype.getClassName=function(){return"Material"},Object.defineProperty(r.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!1,configurable:!0}),r.prototype.freeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!0},r.prototype.unfreeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!1},r.prototype.isReady=function(e,t){return!0},r.prototype.isReadyForSubMesh=function(e,t,i){var n=t.materialDefines;return n?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1},r.prototype.getEffect=function(){return this._drawWrapper.effect},r.prototype.getScene=function(){return this._scene},Object.defineProperty(r.prototype,"transparencyMode",{get:function(){return this._transparencyMode},set:function(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===r.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_disableAlphaBlending",{get:function(){return this._transparencyMode===r.MATERIAL_OPAQUE||this._transparencyMode===r.MATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),r.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1},r.prototype.needAlphaBlendingForMesh=function(e){return this._disableAlphaBlending&&e.visibility>=1?!1:this.needAlphaBlending()||e.visibility<1||e.hasVertexAlpha},r.prototype.needAlphaTesting=function(){return!!this._forceAlphaTest},r.prototype._shouldTurnAlphaTestOn=function(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()},r.prototype.getAlphaTestTexture=function(){return null},r.prototype.markDirty=function(){for(var e=this.getScene().meshes,t=0,i=e;t<i.length;t++){var n=i[t];if(!!n.subMeshes)for(var o=0,a=n.subMeshes;o<a.length;o++){var s=a[o];s.getMaterial()===this&&(!s.effect||(s.effect._wasPreviouslyReady=!1,s.effect._wasPreviouslyUsingInstances=null))}}},r.prototype._preBind=function(e,t){t===void 0&&(t=null);var i=this._scene.getEngine(),n=t==null?this.sideOrientation:t,o=n===r.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,o,this.cullBackFaces,this.stencil,this.zOffsetUnits),o},r.prototype.bind=function(e,t){},r.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(qe.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0},r.prototype.bindForSubMesh=function(e,t,i){var n=i.effect;!n||(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo))},r.prototype.bindOnlyWorldMatrix=function(e){},r.prototype.bindView=function(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())},r.prototype.bindViewProjection=function(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))},r.prototype.bindEyePosition=function(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)},r.prototype._afterBind=function(e,t){if(t===void 0&&(t=null),this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,se.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){var i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){var i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){var i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}},r.prototype.unbind=function(){if(this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0){var e=this._scene.getEngine();e.setDepthFunction(this._cachedDepthFunctionState)}if(this.disableDepthWrite){var e=this._scene.getEngine();e.setDepthWrite(this._cachedDepthWriteState)}if(this.disableColorWrite){var e=this._scene.getEngine();e.setColorWrite(this._cachedColorWriteState)}},r.prototype.getAnimatables=function(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(qe.GetAnimatables,this._eventInfo),this._eventInfo.animatables},r.prototype.getActiveTextures=function(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(qe.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures},r.prototype.hasTexture=function(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(qe.HasTexture,this._eventInfo),this._eventInfo.hasTexture},r.prototype.clone=function(e){return null},r.prototype.getBindedMeshes=function(){var e=this;if(this.meshMap){var t=new Array;for(var i in this.meshMap){var n=this.meshMap[i];n&&t.push(n)}return t}else{var o=this._scene.meshes;return o.filter(function(a){return a.material===e})}},r.prototype.forceCompilation=function(e,t,i,n){var o=this,a=Vt({clipPlane:!1,useInstances:!1},i),s=this.getScene(),f=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;var u=function(){if(!(!o._scene||!o._scene.getEngine())){var l=s.clipPlane;if(a.clipPlane&&(s.clipPlane=new pi(0,0,0,1)),o._storeEffectOnSubMeshes){var h=!0,c=null;if(e.subMeshes){var p=new Bt(0,0,0,0,0,e,void 0,!1,!1);p.materialDefines&&(p.materialDefines._renderId=-1),o.isReadyForSubMesh(e,p,a.useInstances)||(p.effect&&p.effect.getCompilationError()&&p.effect.allFallbacksProcessed()?c=p.effect.getCompilationError():(h=!1,setTimeout(u,16)))}h&&(o.allowShaderHotSwapping=f,c&&n&&n(c),t&&t(o))}else o.isReady()?(o.allowShaderHotSwapping=f,t&&t(o)):setTimeout(u,16);a.clipPlane&&(s.clipPlane=l)}};u()},r.prototype.forceCompilationAsync=function(e,t){var i=this;return new Promise(function(n,o){i.forceCompilation(e,function(){n()},t,function(a){o(a)})})},r.prototype.markAsDirty=function(e){this.getScene().blockMaterialDirtyMechanism||(r._DirtyCallbackArray.length=0,e&r.TextureDirtyFlag&&r._DirtyCallbackArray.push(r._TextureDirtyCallBack),e&r.LightDirtyFlag&&r._DirtyCallbackArray.push(r._LightsDirtyCallBack),e&r.FresnelDirtyFlag&&r._DirtyCallbackArray.push(r._FresnelDirtyCallBack),e&r.AttributesDirtyFlag&&r._DirtyCallbackArray.push(r._AttributeDirtyCallBack),e&r.MiscDirtyFlag&&r._DirtyCallbackArray.push(r._MiscDirtyCallBack),e&r.PrePassDirtyFlag&&r._DirtyCallbackArray.push(r._PrePassDirtyCallBack),r._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(r._RunDirtyCallBacks),this.getScene().resetCachedMaterial())},r.prototype.resetDrawCache=function(){for(var e=this.getScene().meshes,t=0,i=e;t<i.length;t++){var n=i[t];if(!!n.subMeshes)for(var o=0,a=n.subMeshes;o<a.length;o++){var s=a[o];s.getMaterial()===this&&s.resetDrawCache()}}},r.prototype._markAllSubMeshesAsDirty=function(e){if(!this.getScene().blockMaterialDirtyMechanism)for(var t=this.getScene().meshes,i=0,n=t;i<n.length;i++){var o=n[i];if(!!o.subMeshes)for(var a=0,s=o.subMeshes;a<s.length;a++){var f=s[a];if(f.getMaterial(!1)===this)for(var u=0,l=f._drawWrappers;u<l.length;u++){var h=l[u];!h||!h.defines||!h.defines.markAllAsDirty||this._materialContext===h.materialContext&&e(h.defines)}}}},r.prototype._markScenePrePassDirty=function(){if(!this.getScene().blockMaterialDirtyMechanism){var e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}},r.prototype._markAllSubMeshesAsAllDirty=function(){this._markAllSubMeshesAsDirty(r._AllDirtyCallBack)},r.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(r._ImageProcessingDirtyCallBack)},r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(r._TextureDirtyCallBack)},r.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(r._FresnelDirtyCallBack)},r.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty(r._FresnelAndMiscDirtyCallBack)},r.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(r._LightsDirtyCallBack)},r.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(r._AttributeDirtyCallBack)},r.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(r._MiscDirtyCallBack)},r.prototype._markAllSubMeshesAsPrePassDirty=function(){this._markAllSubMeshesAsDirty(r._MiscDirtyCallBack)},r.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty(r._TextureAndMiscDirtyCallBack)},r.prototype.setPrePassRenderer=function(e){return!1},r.prototype.dispose=function(e,t,i){var n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(qe.Disposed,this._eventInfo),this._parentContainer){var o=this._parentContainer.materials.indexOf(this);o>-1&&this._parentContainer.materials.splice(o,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(var a in this.meshMap){var s=this.meshMap[a];s&&(s.material=null,this.releaseVertexArrayObject(s,e))}else for(var f=n.meshes,u=0,l=f;u<l.length;u++){var s=l[u];s.material===this&&!s.sourceMesh&&(s.material=null,this.releaseVertexArrayObject(s,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear()},r.prototype.releaseVertexArrayObject=function(e,t){if(e.geometry){var i=e.geometry;if(this._storeEffectOnSubMeshes)for(var n=0,o=e.subMeshes;n<o.length;n++){var a=o[n];i._releaseVertexArrayObject(a.effect),t&&a.effect&&a.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}},r.prototype.serialize=function(){var e=te.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e},r.Parse=function(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return q.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;var n=he.Instantiate(e.customType),o=n.Parse(e,t,i);return o._loadedUniqueId=e.uniqueId,o},r.TriangleFillMode=0,r.WireFrameFillMode=1,r.PointFillMode=2,r.PointListDrawMode=3,r.LineListDrawMode=4,r.LineLoopDrawMode=5,r.LineStripDrawMode=6,r.TriangleStripDrawMode=7,r.TriangleFanDrawMode=8,r.ClockWiseSideOrientation=0,r.CounterClockWiseSideOrientation=1,r.TextureDirtyFlag=1,r.LightDirtyFlag=2,r.FresnelDirtyFlag=4,r.AttributesDirtyFlag=8,r.MiscDirtyFlag=16,r.PrePassDirtyFlag=32,r.AllDirtyFlag=63,r.MATERIAL_OPAQUE=0,r.MATERIAL_ALPHATEST=1,r.MATERIAL_ALPHABLEND=2,r.MATERIAL_ALPHATESTANDBLEND=3,r.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,r.MATERIAL_NORMALBLENDMETHOD_RNM=1,r.OnEventObservable=new U,r._AllDirtyCallBack=function(e){return e.markAllAsDirty()},r._ImageProcessingDirtyCallBack=function(e){return e.markAsImageProcessingDirty()},r._TextureDirtyCallBack=function(e){return e.markAsTexturesDirty()},r._FresnelDirtyCallBack=function(e){return e.markAsFresnelDirty()},r._MiscDirtyCallBack=function(e){return e.markAsMiscDirty()},r._PrePassDirtyCallBack=function(e){return e.markAsPrePassDirty()},r._LightsDirtyCallBack=function(e){return e.markAsLightDirty()},r._AttributeDirtyCallBack=function(e){return e.markAsAttributesDirty()},r._FresnelAndMiscDirtyCallBack=function(e){r._FresnelDirtyCallBack(e),r._MiscDirtyCallBack(e)},r._TextureAndMiscDirtyCallBack=function(e){r._TextureDirtyCallBack(e),r._MiscDirtyCallBack(e)},r._DirtyCallbackArray=[],r._RunDirtyCallBacks=function(e){for(var t=0,i=r._DirtyCallbackArray;t<i.length;t++){var n=i[t];n(e)}},x([O()],r.prototype,"id",void 0),x([O()],r.prototype,"uniqueId",void 0),x([O()],r.prototype,"name",void 0),x([O()],r.prototype,"metadata",void 0),x([O()],r.prototype,"checkReadyOnEveryCall",void 0),x([O()],r.prototype,"checkReadyOnlyOnce",void 0),x([O()],r.prototype,"state",void 0),x([O("alpha")],r.prototype,"_alpha",void 0),x([O("backFaceCulling")],r.prototype,"_backFaceCulling",void 0),x([O("cullBackFaces")],r.prototype,"_cullBackFaces",void 0),x([O()],r.prototype,"sideOrientation",void 0),x([O("alphaMode")],r.prototype,"_alphaMode",void 0),x([O()],r.prototype,"_needDepthPrePass",void 0),x([O()],r.prototype,"disableDepthWrite",void 0),x([O()],r.prototype,"disableColorWrite",void 0),x([O()],r.prototype,"forceDepthWrite",void 0),x([O()],r.prototype,"depthFunction",void 0),x([O()],r.prototype,"separateCullingPass",void 0),x([O("fogEnabled")],r.prototype,"_fogEnabled",void 0),x([O()],r.prototype,"pointSize",void 0),x([O()],r.prototype,"zOffset",void 0),x([O()],r.prototype,"zOffsetUnits",void 0),x([O()],r.prototype,"pointsCloud",null),x([O()],r.prototype,"fillMode",null),x([O()],r.prototype,"transparencyMode",null),r}();v();var Yn=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i,!0)||this;return n._waitingSubMaterialsUniqueIds=[],n.getScene().multiMaterials.push(n),n.subMaterials=new Array,n._storeEffectOnSubMeshes=!0,n}return Object.defineProperty(e.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(t){this._subMaterials=t,this._hookArray(t)},enumerable:!1,configurable:!0}),e.prototype.getChildren=function(){return this.subMaterials},e.prototype._hookArray=function(t){var i=this,n=t.push;t.push=function(){for(var a=[],s=0;s<arguments.length;s++)a[s]=arguments[s];var f=n.apply(t,a);return i._markAllSubMeshesAsTexturesDirty(),f};var o=t.splice;t.splice=function(a,s){var f=o.apply(t,[a,s]);return i._markAllSubMeshesAsTexturesDirty(),f}},e.prototype.getSubMaterial=function(t){return t<0||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]},e.prototype.getActiveTextures=function(){var t;return(t=r.prototype.getActiveTextures.call(this)).concat.apply(t,this.subMaterials.map(function(i){return i?i.getActiveTextures():[]}))},e.prototype.hasTexture=function(t){var i;if(r.prototype.hasTexture.call(this,t))return!0;for(var n=0;n<this.subMaterials.length;n++)if(!((i=this.subMaterials[n])===null||i===void 0)&&i.hasTexture(t))return!0;return!1},e.prototype.getClassName=function(){return"MultiMaterial"},e.prototype.isReadyForSubMesh=function(t,i,n){for(var o=0;o<this.subMaterials.length;o++){var a=this.subMaterials[o];if(a){if(a._storeEffectOnSubMeshes){if(!a.isReadyForSubMesh(t,i,n))return!1;continue}if(!a.isReady(t))return!1}}return!0},e.prototype.clone=function(t,i){for(var n=new e(t,this.getScene()),o=0;o<this.subMaterials.length;o++){var a=null,s=this.subMaterials[o];i&&s?a=s.clone(t+"-"+s.name):a=this.subMaterials[o],n.subMaterials.push(a)}return n},e.prototype.serialize=function(){var t={};t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,Ee&&(t.tags=Ee.GetTags(this)),t.materialsUniqueIds=[],t.materials=[];for(var i=0;i<this.subMaterials.length;i++){var n=this.subMaterials[i];n?(t.materialsUniqueIds.push(n.uniqueId),t.materials.push(n.id)):(t.materialsUniqueIds.push(null),t.materials.push(null))}return t},e.prototype.dispose=function(t,i,n){var o=this.getScene();if(!!o){if(n)for(var a=0;a<this.subMaterials.length;a++){var s=this.subMaterials[a];s&&s.dispose(t,i)}var f=o.multiMaterials.indexOf(this);f>=0&&o.multiMaterials.splice(f,1),r.prototype.dispose.call(this,t,i)}},e.ParseMultiMaterial=function(t,i){var n=new e(t.name,i);return n.id=t.id,n._loadedUniqueId=t.uniqueId,Ee&&Ee.AddTagsTo(n,t.tags),t.materialsUniqueIds?n._waitingSubMaterialsUniqueIds=t.materialsUniqueIds:t.materials.forEach(function(o){return n.subMaterials.push(i.getLastMaterialById(o))}),n},e}(De);Ke("BABYLON.MultiMaterial",Yn);v();var qh=function(){function r(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}return r}();var Qh=function(){function r(){}return r}();var Mv=function(){function r(){this.visibleInstances={},this.batchCache=new Zh,this.batchCacheReplacementModeInFrozenMode=new Zh,this.instancesBufferSize=32*16*4}return r}(),Zh=function(){function r(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}return r}();var Rv=function(){function r(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}return r}(),xv=function(){function r(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}return r}(),H=function(r){Y(e,r);function e(t,i,n,o,a,s){i===void 0&&(i=null),n===void 0&&(n=null),o===void 0&&(o=null),s===void 0&&(s=!0);var f=r.call(this,t,i)||this;if(f._internalMeshDataInfo=new xv,f.delayLoadState=0,f.instances=new Array,f._creationDataStorage=null,f._geometry=null,f._instanceDataStorage=new Mv,f._thinInstanceDataStorage=new Rv,f._shouldGenerateFlatShading=!1,f._originalBuilderSideOrientation=e.DEFAULTSIDE,f.overrideMaterialSideOrientation=null,f.ignoreCameraMaxZ=!1,i=f.getScene(),f._onBeforeDraw=function(y,g,T){y&&T&&(f._uniformBuffer?f.transferToEffect(g):T.bindOnlyWorldMatrix(g))},o){if(o._geometry&&o._geometry.applyToMesh(f),oi.DeepCopy(o,f,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),f._internalMeshDataInfo._source=o,i.useClonedMeshMap&&(o._internalMeshDataInfo.meshMap||(o._internalMeshDataInfo.meshMap={}),o._internalMeshDataInfo.meshMap[f.uniqueId]=f),f._originalBuilderSideOrientation=o._originalBuilderSideOrientation,f._creationDataStorage=o._creationDataStorage,o._ranges){var u=o._ranges;for(var l in u)!Object.prototype.hasOwnProperty.call(u,l)||!u[l]||f.createAnimationRange(l,u[l].from,u[l].to)}if(o.metadata&&o.metadata.clone?f.metadata=o.metadata.clone():f.metadata=o.metadata,Ee&&Ee.HasTags(o)&&Ee.AddTagsTo(f,Ee.GetTags(o,!0)),f.setEnabled(o.isEnabled(!1)),f.parent=o.parent,f.setPivotMatrix(o.getPivotMatrix()),f.id=t+"."+o.id,f.material=o.material,!a)for(var h=o.getDescendants(!0),c=0;c<h.length;c++){var p=h[c];p.clone&&p.clone(t+"."+p.name,f)}if(o.morphTargetManager&&(f.morphTargetManager=o.morphTargetManager),i.getPhysicsEngine){var d=i.getPhysicsEngine();if(s&&d){var m=d.getImpostorForPhysicsObject(o);m&&(f.physicsImpostor=m.clone(f))}}for(var c=0;c<i.particleSystems.length;c++){var _=i.particleSystems[c];_.emitter===o&&_.clone(_.name,f)}f.skeleton=o.skeleton,f.refreshBoundingInfo(!0,!0),f.computeWorldMatrix(!0)}return n!==null&&(f.parent=n),f._instanceDataStorage.hardwareInstancedRendering=f.getEngine().getCaps().instancedArrays,f._internalMeshDataInfo._onMeshReadyObserverAdded=function(y){y.unregisterOnNextCall=!0,f.isReady(!0)?f.onMeshReadyObservable.notifyObservers(f):f._internalMeshDataInfo._checkReadinessObserver||(f._internalMeshDataInfo._checkReadinessObserver=f._scene.onBeforeRenderObservable.add(function(){f.isReady(!0)&&(f._scene.onBeforeRenderObservable.remove(f._internalMeshDataInfo._checkReadinessObserver),f._internalMeshDataInfo._checkReadinessObserver=null,f.onMeshReadyObservable.notifyObservers(f))}))},f.onMeshReadyObservable=new U(f._internalMeshDataInfo._onMeshReadyObserverAdded),o&&o.onClonedObservable.notifyObservers(f),f}return e._GetDefaultSideOrientation=function(t){return t||e.FRONTSIDE},Object.defineProperty(e.prototype,"useLODScreenCoverage",{get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(t){this._internalMeshDataInfo._useLODScreenCoverage=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(t&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(b.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(b.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRenderObservable",{get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new U),this._internalMeshDataInfo._onBeforeRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeBindObservable",{get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new U),this._internalMeshDataInfo._onBeforeBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRenderObservable",{get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new U),this._internalMeshDataInfo._onAfterRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBetweenPassObservable",{get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new U),this._internalMeshDataInfo._onBetweenPassObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeDrawObservable",{get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new U),this._internalMeshDataInfo._onBeforeDrawObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeDraw",{set:function(t){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasInstances",{get:function(){return this.instances.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasThinInstances",{get:function(){var t;return((t=this._thinInstanceDataStorage.instancesCount)!==null&&t!==void 0?t:0)>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forcedInstanceCount",{get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(t){this._internalMeshDataInfo._forcedInstanceCount=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"source",{get:function(){return this._internalMeshDataInfo._source},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cloneMeshMap",{get:function(){return this._internalMeshDataInfo.meshMap},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(t){this._unIndexed!==t&&(this._unIndexed=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"worldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesData},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"previousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesPreviousData},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"manualUpdateOfWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.manualUpdate},set:function(t){this._instanceDataStorage.manualUpdate=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"manualUpdateOfPreviousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(t){this._instanceDataStorage.previousManualUpdate=t},enumerable:!1,configurable:!0}),e.prototype.instantiateHierarchy=function(t,i,n){t===void 0&&(t=null);var o=this.getTotalVertices()===0||i&&i.doNotInstantiate&&(i.doNotInstantiate===!0||i.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),t||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));o.parent=t||this.parent,o.position=this.position.clone(),o.scaling=this.scaling.clone(),this.rotationQuaternion?o.rotationQuaternion=this.rotationQuaternion.clone():o.rotation=this.rotation.clone(),n&&n(this,o);for(var a=0,s=this.getChildTransformNodes(!0);a<s.length;a++){var f=s[a];f.instantiateHierarchy(o,i,n)}return o},e.prototype.getClassName=function(){return"Mesh"},Object.defineProperty(e.prototype,"_isMesh",{get:function(){return!0},enumerable:!1,configurable:!0}),e.prototype.toString=function(t){var i=r.prototype.toString.call(this,t);if(i+=", n vertices: "+this.getTotalVertices(),i+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)i+=", animation[0]: "+this.animations[n].toString(t);if(t)if(this._geometry){var o=this.getIndices(),a=this.getVerticesData(b.PositionKind);a&&o&&(i+=", flat shading: "+(a.length/3===o.length?"YES":"NO"))}else i+=", flat shading: UNKNOWN";return i},e.prototype._unBindEffect=function(){r.prototype._unBindEffect.call(this);for(var t=0,i=this.instances;t<i.length;t++){var n=i[t];n._unBindEffect()}},Object.defineProperty(e.prototype,"hasLODLevels",{get:function(){return this._internalMeshDataInfo._LODLevels.length>0},enumerable:!1,configurable:!0}),e.prototype.getLODLevels=function(){return this._internalMeshDataInfo._LODLevels},e.prototype._sortLODLevels=function(){var t=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(function(i,n){return i.distanceOrScreenCoverage<n.distanceOrScreenCoverage?t:i.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-t:0})},e.prototype.addLODLevel=function(t,i){if(i&&i._masterMesh)return q.Warn("You cannot use a mesh as LOD level twice"),this;var n=new qh(t,i);return this._internalMeshDataInfo._LODLevels.push(n),i&&(i._masterMesh=this),this._sortLODLevels(),this},e.prototype.getLODLevelAtDistance=function(t){for(var i=this._internalMeshDataInfo,n=0;n<i._LODLevels.length;n++){var o=i._LODLevels[n];if(o.distanceOrScreenCoverage===t)return o.mesh}return null},e.prototype.removeLODLevel=function(t){for(var i=this._internalMeshDataInfo,n=0;n<i._LODLevels.length;n++)i._LODLevels[n].mesh===t&&(i._LODLevels.splice(n,1),t&&(t._masterMesh=null));return this._sortLODLevels(),this},e.prototype.getLOD=function(t,i){var n=this._internalMeshDataInfo;if(!n._LODLevels||n._LODLevels.length===0)return this;var o;if(i)o=i;else{var a=this.getBoundingInfo();o=a.boundingSphere}var s=o.centerWorld.subtract(t.globalPosition).length(),f=n._useLODScreenCoverage,u=s,l=1;if(f){var h=t.screenArea,c=o.radiusWorld*t.minZ/s;c=c*c*Math.PI,u=c/h,l=-1}if(l*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>l*u)return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,this),this;for(var p=0;p<n._LODLevels.length;p++){var d=n._LODLevels[p];if(l*d.distanceOrScreenCoverage<l*u){if(d.mesh){if(d.mesh.delayLoadState===4)return d.mesh._checkDelayState(),this;if(d.mesh.delayLoadState===2)return this;d.mesh._preActivate(),d.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,d.mesh),d.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,this),this},Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),e.prototype.getTotalVertices=function(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()},e.prototype.getVerticesData=function(t,i,n){var o,a;if(!this._geometry)return null;var s=(a=(o=this._userInstancedBuffersStorage)===null||o===void 0?void 0:o.vertexBuffers[t])===null||a===void 0?void 0:a.getFloatData(this._geometry.getTotalVertices(),n||i&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(t,i,n)),s},e.prototype.getVertexBuffer=function(t){var i,n;return this._geometry?(n=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[t])!==null&&n!==void 0?n:this._geometry.getVertexBuffer(t):null},e.prototype.isVerticesDataPresent=function(t){var i;return this._geometry?((i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[t])!==void 0||this._geometry.isVerticesDataPresent(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},e.prototype.isVertexBufferUpdatable=function(t){var i,n;return this._geometry?((n=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[t])===null||n===void 0?void 0:n.isUpdatable())||this._geometry.isVertexBufferUpdatable(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},e.prototype.getVerticesDataKinds=function(){if(!this._geometry){var t=new Array;return this._delayInfo&&this._delayInfo.forEach(function(o){t.push(o)}),t}var i=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var n in this._userInstancedBuffersStorage.vertexBuffers)i.push(n);return i},e.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},e.prototype.getIndices=function(t,i){return this._geometry?this._geometry.getIndices(t,i):[]},Object.defineProperty(e.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==void 0},enumerable:!1,configurable:!0}),e.prototype.isReady=function(t,i){var n,o,a,s,f,u;if(t===void 0&&(t=!1),i===void 0&&(i=!1),this.delayLoadState===2||!r.prototype.isReady.call(this,t))return!1;if(!this.subMeshes||this.subMeshes.length===0||!t)return!0;var l=this.getEngine(),h=this.getScene(),c=i||l.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var p=this.material||h.defaultMaterial;if(p){if(p._storeEffectOnSubMeshes)for(var d=0,m=this.subMeshes;d<m.length;d++){var _=m[d],y=_.getMaterial();if(y){if(y._storeEffectOnSubMeshes){if(!y.isReadyForSubMesh(this,_,c))return!1}else if(!y.isReady(this,c))return!1}}else if(!p.isReady(this,c))return!1}for(var g=l.currentRenderPassId,T=0,A=this.lightSources;T<A.length;T++){var M=A[T],C=M.getShadowGenerator();if(C&&(!(!((n=C.getShadowMap())===null||n===void 0)&&n.renderList)||((o=C.getShadowMap())===null||o===void 0?void 0:o.renderList)&&((s=(a=C.getShadowMap())===null||a===void 0?void 0:a.renderList)===null||s===void 0?void 0:s.indexOf(this))!==-1)){C.getShadowMap()&&(l.currentRenderPassId=C.getShadowMap().renderPassId);for(var P=0,R=this.subMeshes;P<R.length;P++){var _=R[P];if(!C.isReady(_,c,(u=(f=_.getMaterial())===null||f===void 0?void 0:f.needAlphaBlendingForMesh(this))!==null&&u!==void 0?u:!1))return l.currentRenderPassId=g,!1}l.currentRenderPassId=g}}for(var F=0,I=this._internalMeshDataInfo._LODLevels;F<I.length;F++){var D=I[F];if(D.mesh&&!D.mesh.isReady(c))return!1}return!0},Object.defineProperty(e.prototype,"areNormalsFrozen",{get:function(){return this._internalMeshDataInfo._areNormalsFrozen},enumerable:!1,configurable:!0}),e.prototype.freezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this},e.prototype.unfreezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this},Object.defineProperty(e.prototype,"overridenInstanceCount",{set:function(t){this._instanceDataStorage.overridenInstanceCount=t},enumerable:!1,configurable:!0}),e.prototype._preActivate=function(){var t=this._internalMeshDataInfo,i=this.getScene().getRenderId();return t._preActivateId===i?this:(t._preActivateId=i,this._instanceDataStorage.visibleInstances=null,this)},e.prototype._preActivateForIntermediateRendering=function(t){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=t),this},e.prototype._registerInstanceForRenderId=function(t,i){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:i,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[i]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=i,this._instanceDataStorage.visibleInstances[i]=new Array),this._instanceDataStorage.visibleInstances[i].push(t),this},e.prototype._afterComputeWorldMatrix=function(){r.prototype._afterComputeWorldMatrix.call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))},e.prototype._postActivate=function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))},e.prototype.refreshBoundingInfo=function(t,i){if(t===void 0&&(t=!1),i===void 0&&(i=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(t,i),n),this},e.prototype._createGlobalSubMesh=function(t){var i=this.getTotalVertices();if(!i||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var n=this.getIndices();if(!n)return null;var o=n.length,a=!1;if(t)a=!0;else for(var s=0,f=this.subMeshes;s<f.length;s++){var u=f[s];if(u.indexStart+u.indexCount>o){a=!0;break}if(u.verticesStart+u.verticesCount>i){a=!0;break}}if(!a)return this.subMeshes[0]}return this.releaseSubMeshes(),new Bt(0,0,i,0,this.getTotalIndices(),this)},e.prototype.subdivide=function(t){if(!(t<1)){for(var i=this.getTotalIndices(),n=i/t|0,o=0;n%3!==0;)n++;this.releaseSubMeshes();for(var a=0;a<t&&!(o>=i);a++)Bt.CreateFromIndices(0,o,a===t-1?i-o:n,this),o+=n;this.synchronizeInstances()}},e.prototype.setVerticesData=function(t,i,n,o){if(n===void 0&&(n=!1),this._geometry)this._geometry.setVerticesData(t,i,n,o);else{var a=new re;a.set(i,t);var s=this.getScene();new nr(nr.RandomId(),s,a,n,this)}return this},e.prototype.removeVerticesData=function(t){!this._geometry||this._geometry.removeVerticesData(t)},e.prototype.markVerticesDataAsUpdatable=function(t,i){i===void 0&&(i=!0);var n=this.getVertexBuffer(t);!n||n.isUpdatable()===i||this.setVerticesData(t,this.getVerticesData(t),i)},e.prototype.setVerticesBuffer=function(t,i){return i===void 0&&(i=!0),this._geometry||(this._geometry=nr.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(t,null,i),this},e.prototype.updateVerticesData=function(t,i,n,o){return this._geometry?(o?(this.makeGeometryUnique(),this.updateVerticesData(t,i,n,!1)):this._geometry.updateVerticesData(t,i,n),this):this},e.prototype.updateMeshPositions=function(t,i){i===void 0&&(i=!0);var n=this.getVerticesData(b.PositionKind);if(!n)return this;if(t(n),this.updateVerticesData(b.PositionKind,n,!1,!1),i){var o=this.getIndices(),a=this.getVerticesData(b.NormalKind);if(!a)return this;re.ComputeNormals(n,o,a),this.updateVerticesData(b.NormalKind,a,!1,!1)}return this},e.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;var t=this._geometry,i=this._geometry.copy(nr.RandomId());return t.releaseForMesh(this,!0),i.applyToMesh(this),this},e.prototype.setIndices=function(t,i,n){if(i===void 0&&(i=null),n===void 0&&(n=!1),this._geometry)this._geometry.setIndices(t,i,n);else{var o=new re;o.indices=t;var a=this.getScene();new nr(nr.RandomId(),a,o,n,this)}return this},e.prototype.updateIndices=function(t,i,n){return n===void 0&&(n=!1),this._geometry?(this._geometry.updateIndices(t,i,n),this):this},e.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},e.prototype._bind=function(t,i,n){if(!this._geometry)return this;var o=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(i);var a;if(this._unIndexed)a=null;else switch(n){case De.PointFillMode:a=null;break;case De.WireFrameFillMode:a=t._getLinesIndexBuffer(this.getIndices(),o);break;default:case De.TriangleFillMode:a=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(i,a):this._geometry._bind(i,a,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this},e.prototype._draw=function(t,i,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var o=this.getScene(),a=o.getEngine();return this._unIndexed||i==De.PointFillMode?a.drawArraysType(i,t.verticesStart,t.verticesCount,this.forcedInstanceCount||n):i==De.WireFrameFillMode?a.drawElementsType(i,0,t._linesIndexCount,this.forcedInstanceCount||n):a.drawElementsType(i,t.indexStart,t.indexCount,this.forcedInstanceCount||n),this},e.prototype.registerBeforeRender=function(t){return this.onBeforeRenderObservable.add(t),this},e.prototype.unregisterBeforeRender=function(t){return this.onBeforeRenderObservable.removeCallback(t),this},e.prototype.registerAfterRender=function(t){return this.onAfterRenderObservable.add(t),this},e.prototype.unregisterAfterRender=function(t){return this.onAfterRenderObservable.removeCallback(t),this},e.prototype._getInstancesRenderList=function(t,i){if(i===void 0&&(i=!1),this._instanceDataStorage.isFrozen){if(i)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[t]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[t]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var n=this.getScene(),o=n._isInIntermediateRendering(),a=o?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,s=this._instanceDataStorage.batchCache;if(s.mustReturn=!1,s.renderSelf[t]=i||!a&&this.isEnabled()&&this.isVisible,s.visibleInstances[t]=null,this._instanceDataStorage.visibleInstances&&!i){var f=this._instanceDataStorage.visibleInstances,u=n.getRenderId(),l=o?f.intermediateDefaultRenderId:f.defaultRenderId;s.visibleInstances[t]=f[u],!s.visibleInstances[t]&&l&&(s.visibleInstances[t]=f[l])}return s.hardwareInstancedRendering[t]=!i&&this._instanceDataStorage.hardwareInstancedRendering&&s.visibleInstances[t]!==null&&s.visibleInstances[t]!==void 0,this._instanceDataStorage.previousBatch=s,s},e.prototype._renderWithInstances=function(t,i,n,o,a){var s,f=n.visibleInstances[t._id];if(!f)return this;for(var u=this._instanceDataStorage,l=u.instancesBufferSize,h=u.instancesBuffer,c=u.instancesPreviousBuffer,p=f.length+1,d=p*16*4;u.instancesBufferSize<d;)u.instancesBufferSize*=2;(!u.instancesData||l!=u.instancesBufferSize)&&(u.instancesData=new Float32Array(u.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousData||l!=u.instancesBufferSize)&&(u.instancesPreviousData=new Float32Array(u.instancesBufferSize/4));var m=0,_=0,y=n.renderSelf[t._id],g=!h||l!==u.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!u.isFrozen||g)){var T=this.getWorldMatrix();if(y&&(this._scene.needsPreviousWorldMatrices&&(u.masterMeshPreviousWorldMatrix?(u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,m),u.masterMeshPreviousWorldMatrix.copyFrom(T)):(u.masterMeshPreviousWorldMatrix=T.clone(),u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,m))),T.copyToArray(u.instancesData,m),m+=16,_++),f){if(e.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((s=t.getMaterial())===null||s===void 0?void 0:s.needAlphaBlendingForMesh(t.getRenderingMesh()))){for(var A=this._scene.activeCamera.globalPosition,M=0;M<f.length;M++){var C=f[M];C._distanceToCamera=E.Distance(C.getBoundingInfo().boundingSphere.centerWorld,A)}f.sort(function(F,I){return F._distanceToCamera>I._distanceToCamera?-1:F._distanceToCamera<I._distanceToCamera?1:0})}for(var M=0;M<f.length;M++){var P=f[M],R=P.getWorldMatrix();R.copyToArray(u.instancesData,m),this._scene.needsPreviousWorldMatrices&&(P._previousWorldMatrix?(P._previousWorldMatrix.copyToArray(u.instancesPreviousData,m),P._previousWorldMatrix.copyFrom(R)):(P._previousWorldMatrix=R.clone(),P._previousWorldMatrix.copyToArray(u.instancesPreviousData,m))),m+=16,_++}}}else _=(y?1:0)+f.length;return g?(h&&h.dispose(),c&&c.dispose(),h=new Or(a,u.instancesData,!0,16,!1,!0),u.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(c=new Or(a,u.instancesPreviousData,!0,16,!1,!0),u.instancesPreviousBuffer=c,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=c.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=c.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=c.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=c.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(h.updateDirectly(u.instancesData,0,_),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&c.updateDirectly(u.instancesPreviousData,0,_)),this._processInstancedBuffers(f,y),this.getScene()._activeIndices.addCount(t.indexCount*_,!1),a._currentDrawContext&&(a._currentDrawContext.useInstancing=!0),this._bind(t,o,i),this._draw(t,i,_),this._scene.needsPreviousWorldMatrices&&!g&&this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.previousManualUpdate&&c.updateDirectly(u.instancesData,0,_),a.unbindInstanceAttributes(),this},e.prototype._renderWithThinInstances=function(t,i,n,o){var a,s,f=(s=(a=this._thinInstanceDataStorage)===null||a===void 0?void 0:a.instancesCount)!==null&&s!==void 0?s:0;this.getScene()._activeIndices.addCount(t.indexCount*f,!1),o._currentDrawContext&&(o._currentDrawContext.useInstancing=!0),this._bind(t,n,i),this._draw(t,i,f),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,f):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),o.unbindInstanceAttributes()},e.prototype._processInstancedBuffers=function(t,i){},e.prototype._processRendering=function(t,i,n,o,a,s,f,u){var l=this.getScene(),h=l.getEngine();if(s&&i.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(i,o,n,h),this;if(s)this._renderWithInstances(i,o,a,n,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);var c=0;a.renderSelf[i._id]&&(f&&f(!1,t.getWorldMatrix(),u),c++,this._draw(i,o,this._instanceDataStorage.overridenInstanceCount));var p=a.visibleInstances[i._id];if(p){var d=p.length;c+=d;for(var m=0;m<d;m++){var _=p[m],y=_.getWorldMatrix();f&&f(!0,y,u),this._draw(i,o)}}l._activeIndices.addCount(i.indexCount*c,!1)}return this},e.prototype._rebuild=function(t){if(t===void 0&&(t=!1),this._instanceDataStorage.instancesBuffer&&(t&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var i in this._userInstancedBuffersStorage.vertexBuffers){var n=this._userInstancedBuffersStorage.vertexBuffers[i];n&&(t&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,r.prototype._rebuild.call(this,t)},e.prototype._freeze=function(){if(!!this.subMeshes){for(var t=0;t<this.subMeshes.length;t++)this._getInstancesRenderList(t);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}},e.prototype._unFreeze=function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null},e.prototype.render=function(t,i,n){var o,a,s,f=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var u=this._getInstancesRenderList(t._id,!!n);if(u.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var l=f.getEngine(),h=0,c=null;this.ignoreCameraMaxZ&&f.activeCamera&&!f._isInIntermediateRendering()&&(h=f.activeCamera.maxZ,c=f.activeCamera,f.activeCamera.maxZ=0,f.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var p=u.hardwareInstancedRendering[t._id]||t.getRenderingMesh().hasThinInstances,d=this._instanceDataStorage,m=t.getMaterial();if(!m)return c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this;if(!d.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==m){if(m._storeEffectOnSubMeshes){if(!m.isReadyForSubMesh(this,t,p))return c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this}else if(!m.isReady(this,p))return c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=m}else if(m._storeEffectOnSubMeshes&&!(!((o=t.effect)===null||o===void 0)&&o._wasPreviouslyReady)||!m._storeEffectOnSubMeshes&&!(!((a=m.getEffect())===null||a===void 0)&&a._wasPreviouslyReady))return c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this;i&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var _;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?_=t._drawWrapper:_=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();for(var y=(s=_==null?void 0:_.effect)!==null&&s!==void 0?s:null,g=0,T=f._beforeRenderingMeshStage;g<T.length;g++){var A=T[g];A.action(this,t,u,y)}if(!_||!y)return c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this;var M=n||this,C;if(!d.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){var P=M._getWorldMatrixDeterminant();C=this.overrideMaterialSideOrientation,C==null&&(C=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),P<0&&(C=C===De.ClockWiseSideOrientation?De.CounterClockWiseSideOrientation:De.ClockWiseSideOrientation),d.sideOrientation=C}else C=d.sideOrientation;var R=this._internalMeshDataInfo._effectiveMaterial._preBind(_,C);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);var F=f.forcePointsCloud?De.PointFillMode:f.forceWireframe?De.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),p||this._bind(t,y,F);var I=this._internalMeshDataInfo._effectiveMaterial,D=M.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(D,this,t):I.bind(D,this),!I.backFaceCulling&&I.separateCullingPass&&(l.setState(!0,I.zOffset,!1,!R,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,t,y,F,u,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,I.zOffset,!1,R,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(t)),this._processRendering(this,t,y,F,u,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(var V=0,k=f._afterRenderingMeshStage;V<k.length;V++){var A=k[V];A.action(this,t,u,y)}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),c&&(c.maxZ=h,f.updateTransformMatrix(!0)),this},e.prototype.cleanMatrixWeights=function(){this.isVerticesDataPresent(b.MatricesWeightsKind)&&(this.isVerticesDataPresent(b.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())},e.prototype._normalizeSkinFourWeights=function(){for(var t=this.getVerticesData(b.MatricesWeightsKind),i=t.length,n=0;n<i;n+=4){var o=t[n]+t[n+1]+t[n+2]+t[n+3];if(o===0)t[n]=1;else{var a=1/o;t[n]*=a,t[n+1]*=a,t[n+2]*=a,t[n+3]*=a}}this.setVerticesData(b.MatricesWeightsKind,t)},e.prototype._normalizeSkinWeightsAndExtra=function(){for(var t=this.getVerticesData(b.MatricesWeightsExtraKind),i=this.getVerticesData(b.MatricesWeightsKind),n=i.length,o=0;o<n;o+=4){var a=i[o]+i[o+1]+i[o+2]+i[o+3];if(a+=t[o]+t[o+1]+t[o+2]+t[o+3],a===0)i[o]=1;else{var s=1/a;i[o]*=s,i[o+1]*=s,i[o+2]*=s,i[o+3]*=s,t[o]*=s,t[o+1]*=s,t[o+2]*=s,t[o+3]*=s}}this.setVerticesData(b.MatricesWeightsKind,i),this.setVerticesData(b.MatricesWeightsKind,t)},e.prototype.validateSkinning=function(){var t=this.getVerticesData(b.MatricesWeightsExtraKind),i=this.getVerticesData(b.MatricesWeightsKind);if(i===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};for(var n=i.length,o=0,a=0,s=0,f=0,u=t===null?4:8,l=new Array,h=0;h<=u;h++)l[h]=0;for(var c=.001,h=0;h<n;h+=4){for(var p=i[h],d=p,m=d===0?0:1,_=1;_<u;_++){var y=_<4?i[h+_]:t[h+_-4];y>p&&o++,y!==0&&m++,d+=y,p=y}if(l[m]++,m>s&&(s=m),d===0)a++;else{for(var g=1/d,T=0,_=0;_<u;_++)_<4?T+=Math.abs(i[h+_]-i[h+_]*g):T+=Math.abs(t[h+_-4]-t[h+_-4]*g);T>c&&f++}}for(var A=this.skeleton.bones.length,M=this.getVerticesData(b.MatricesIndicesKind),C=this.getVerticesData(b.MatricesIndicesExtraKind),P=0,h=0;h<n;h+=4)for(var _=0;_<u;_++){var R=_<4?M[h+_]:C[h+_-4];(R>=A||R<0)&&P++}var F="Number of Weights = "+n/4+`
Maximum influences = `+s+`
Missing Weights = `+a+`
Not Sorted = `+o+`
Not Normalized = `+f+`
WeightCounts = [`+l+`]
Number of bones = `+A+`
Bad Bone Indices = `+P;return{skinned:!0,valid:a===0&&f===0&&P===0,report:F}},e.prototype._checkDelayState=function(){var t=this.getScene();return this._geometry?this._geometry.load(t):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(t)),this},e.prototype._queueLoad=function(t){var i=this;t.addPendingData(this);var n=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return he.LoadFile(this.delayLoadingFile,function(o){o instanceof ArrayBuffer?i._delayLoadingFunction(o,i):i._delayLoadingFunction(JSON.parse(o),i),i.instances.forEach(function(a){a.refreshBoundingInfo(),a._syncSubMeshes()}),i.delayLoadState=1,t.removePendingData(i)},function(){},t.offlineProvider,n),this},e.prototype.isInFrustum=function(t){return this.delayLoadState===2||!r.prototype.isInFrustum.call(this,t)?!1:(this._checkDelayState(),!0)},e.prototype.setMaterialById=function(t){var i=this.getScene().materials,n;for(n=i.length-1;n>-1;n--)if(i[n].id===t)return this.material=i[n],this;var o=this.getScene().multiMaterials;for(n=o.length-1;n>-1;n--)if(o[n].id===t)return this.material=o[n],this;return this},e.prototype.getAnimatables=function(){var t=new Array;return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t},e.prototype.bakeTransformIntoVertices=function(t){if(!this.isVerticesDataPresent(b.PositionKind))return this;var i=this.subMeshes.splice(0);this._resetPointsArrayCache();var n=this.getVerticesData(b.PositionKind),o=new Array,a;for(a=0;a<n.length;a+=3)E.TransformCoordinates(E.FromArray(n,a),t).toArray(o,a);if(this.setVerticesData(b.PositionKind,o,this.getVertexBuffer(b.PositionKind).isUpdatable()),this.isVerticesDataPresent(b.NormalKind)){for(n=this.getVerticesData(b.NormalKind),o=[],a=0;a<n.length;a+=3)E.TransformNormal(E.FromArray(n,a),t).normalize().toArray(o,a);this.setVerticesData(b.NormalKind,o,this.getVertexBuffer(b.NormalKind).isUpdatable())}return t.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=i,this},e.prototype.bakeCurrentTransformIntoVertices=function(t){return t===void 0&&(t=!0),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(t),this},Object.defineProperty(e.prototype,"_positions",{get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null},enumerable:!1,configurable:!0}),e.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},e.prototype._generatePointsArray=function(){return this._geometry?this._geometry._generatePointsArray():!1},e.prototype.clone=function(t,i,n,o){return t===void 0&&(t=""),i===void 0&&(i=null),o===void 0&&(o=!0),new e(t,this.getScene(),i,this,n,o)},e.prototype.dispose=function(t,i){i===void 0&&(i=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(var o in n.meshMap){var a=n.meshMap[o];a&&(a._internalMeshDataInfo._source=null,n.meshMap[o]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else for(var s=this.getScene().meshes,f=0,u=s;f<u.length;f++){var l=u[f],a=l;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}n._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),r.prototype.dispose.call(this,t,i)},e.prototype._disposeInstanceSpecificData=function(){},e.prototype._disposeThinInstanceSpecificData=function(){},e.prototype._invalidateInstanceVertexArrayObject=function(){},e.prototype.applyDisplacementMap=function(t,i,n,o,a,s,f){var u=this;f===void 0&&(f=!1);var l=this.getScene(),h=function(c){var p=c.width,d=c.height,m=u.getEngine().createCanvas(p,d),_=m.getContext("2d");_.drawImage(c,0,0);var y=_.getImageData(0,0,p,d).data;u.applyDisplacementMapFromBuffer(y,p,d,i,n,a,s,f),o&&o(u)};return he.LoadImage(t,h,function(){},l.offlineProvider),this},e.prototype.applyDisplacementMapFromBuffer=function(t,i,n,o,a,s,f,u){if(u===void 0&&(u=!1),!this.isVerticesDataPresent(b.PositionKind)||!this.isVerticesDataPresent(b.NormalKind)||!this.isVerticesDataPresent(b.UVKind))return q.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var l=this.getVerticesData(b.PositionKind,!0,!0),h=this.getVerticesData(b.NormalKind),c=this.getVerticesData(b.UVKind),p=E.Zero(),d=E.Zero(),m=_e.Zero();s=s||_e.Zero(),f=f||new _e(1,1);for(var _=0;_<l.length;_+=3){E.FromArrayToRef(l,_,p),E.FromArrayToRef(h,_,d),_e.FromArrayToRef(c,_/3*2,m);var y=Math.abs(m.x*f.x+s.x%1)*(i-1)%i|0,g=Math.abs(m.y*f.y+s.y%1)*(n-1)%n|0,T=(y+g*i)*4,A=t[T]/255,M=t[T+1]/255,C=t[T+2]/255,P=A*.3+M*.59+C*.11;d.normalize(),d.scaleInPlace(o+(a-o)*P),p=p.add(d),p.toArray(l,_)}return re.ComputeNormals(l,this.getIndices(),h),u?(this.setVerticesData(b.PositionKind,l),this.setVerticesData(b.NormalKind,h),this.setVerticesData(b.UVKind,c)):(this.updateVerticesData(b.PositionKind,l),this.updateVerticesData(b.NormalKind,h)),this},e.prototype.convertToFlatShadedMesh=function(){var t=this.getVerticesDataKinds(),i={},n={},o={},a=!1,s,f;for(s=0;s<t.length;s++){f=t[s];var u=this.getVertexBuffer(f),l=u.getData();if(!((l instanceof Array||l instanceof Float32Array)&&l.length===0)){if(f===b.NormalKind){a=u.isUpdatable(),t.splice(s,1),s--;continue}i[f]=u,n[f]=this.getVerticesData(f),o[f]=[]}}var h=this.subMeshes.slice(0),c=this.getIndices(),p=this.getTotalIndices(),d;for(d=0;d<p;d++){var m=c[d];for(s=0;s<t.length;s++)if(f=t[s],!!i[f])for(var _=i[f].getStrideSize(),y=0;y<_;y++)o[f].push(n[f][m*_+y])}var g=[],T=o[b.PositionKind],A=this.getScene().useRightHandedSystem,M;for(A?M=this.overrideMaterialSideOrientation===1:M=this.overrideMaterialSideOrientation===0,d=0;d<p;d+=3){c[d]=d,c[d+1]=d+1,c[d+2]=d+2;var C=E.FromArray(T,d*3),P=E.FromArray(T,(d+1)*3),R=E.FromArray(T,(d+2)*3),F=C.subtract(P),I=R.subtract(P),D=E.Normalize(E.Cross(F,I));M&&D.scaleInPlace(-1);for(var V=0;V<3;V++)g.push(D.x),g.push(D.y),g.push(D.z)}for(this.setIndices(c),this.setVerticesData(b.NormalKind,g,a),s=0;s<t.length;s++)f=t[s],o[f]&&this.setVerticesData(f,o[f],i[f].isUpdatable());this.releaseSubMeshes();for(var k=0;k<h.length;k++){var w=h[k];Bt.AddToMesh(w.materialIndex,w.indexStart,w.indexCount,w.indexStart,w.indexCount,this)}return this.synchronizeInstances(),this},e.prototype.convertToUnIndexedMesh=function(){var t=this.getVerticesDataKinds(),i={},n={},o={},a,s;for(a=0;a<t.length;a++){s=t[a];var f=this.getVertexBuffer(s);i[s]=f,n[s]=i[s].getData(),o[s]=[]}var u=this.subMeshes.slice(0),l=this.getIndices(),h=this.getTotalIndices(),c;for(c=0;c<h;c++){var p=l[c];for(a=0;a<t.length;a++){s=t[a];for(var d=i[s].getStrideSize(),m=0;m<d;m++)o[s].push(n[s][p*d+m])}}for(c=0;c<h;c+=3)l[c]=c,l[c+1]=c+1,l[c+2]=c+2;for(this.setIndices(l),a=0;a<t.length;a++)s=t[a],this.setVerticesData(s,o[s],i[s].isUpdatable(),i[s].getStrideSize());this.releaseSubMeshes();for(var _=0;_<u.length;_++){var y=u[_];Bt.AddToMesh(y.materialIndex,y.indexStart,y.indexCount,y.indexStart,y.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this},e.prototype.flipFaces=function(t){t===void 0&&(t=!1);var i=re.ExtractFromMesh(this),n;if(t&&this.isVerticesDataPresent(b.NormalKind)&&i.normals)for(n=0;n<i.normals.length;n++)i.normals[n]*=-1;if(i.indices){var o=void 0;for(n=0;n<i.indices.length;n+=3)o=i.indices[n+1],i.indices[n+1]=i.indices[n+2],i.indices[n+2]=o}return i.applyToMesh(this,this.isVertexBufferUpdatable(b.PositionKind)),this},e.prototype.increaseVertices=function(t){t===void 0&&(t=1);var i=re.ExtractFromMesh(this),n=i.indices&&!Array.isArray(i.indices)&&Array.from?Array.from(i.indices):i.indices,o=i.positions&&!Array.isArray(i.positions)&&Array.from?Array.from(i.positions):i.positions,a=i.uvs&&!Array.isArray(i.uvs)&&Array.from?Array.from(i.uvs):i.uvs,s=i.normals&&!Array.isArray(i.normals)&&Array.from?Array.from(i.normals):i.normals;if(!n||!o)q.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{i.indices=n,i.positions=o,a&&(i.uvs=a),s&&(i.normals=s);for(var f=t+1,u=new Array,l=0;l<f+1;l++)u[l]=new Array;var h=void 0,c=void 0,p=new E(0,0,0),d=new E(0,0,0),m=new _e(0,0),_=new Array,y=new Array,g=new Array,T=void 0,A=o.length,M=void 0;a&&(M=a.length);var C=void 0;s&&(C=s.length);for(var l=0;l<n.length;l+=3){y[0]=n[l],y[1]=n[l+1],y[2]=n[l+2];for(var P=0;P<3;P++)if(h=y[P],c=y[(P+1)%3],g[h]===void 0&&g[c]===void 0?(g[h]=new Array,g[c]=new Array):(g[h]===void 0&&(g[h]=new Array),g[c]===void 0&&(g[c]=new Array)),g[h][c]===void 0&&g[c][h]===void 0){g[h][c]=[],p.x=(o[3*c]-o[3*h])/f,p.y=(o[3*c+1]-o[3*h+1])/f,p.z=(o[3*c+2]-o[3*h+2])/f,s&&(d.x=(s[3*c]-s[3*h])/f,d.y=(s[3*c+1]-s[3*h+1])/f,d.z=(s[3*c+2]-s[3*h+2])/f),a&&(m.x=(a[2*c]-a[2*h])/f,m.y=(a[2*c+1]-a[2*h+1])/f),g[h][c].push(h);for(var R=1;R<f;R++)g[h][c].push(o.length/3),o[A++]=o[3*h]+R*p.x,o[A++]=o[3*h+1]+R*p.y,o[A++]=o[3*h+2]+R*p.z,s&&(s[C++]=s[3*h]+R*d.x,s[C++]=s[3*h+1]+R*d.y,s[C++]=s[3*h+2]+R*d.z),a&&(a[M++]=a[2*h]+R*m.x,a[M++]=a[2*h+1]+R*m.y);g[h][c].push(c),g[c][h]=new Array,T=g[h][c].length;for(var F=0;F<T;F++)g[c][h][F]=g[h][c][T-1-F]}u[0][0]=n[l],u[1][0]=g[n[l]][n[l+1]][1],u[1][1]=g[n[l]][n[l+2]][1];for(var R=2;R<f;R++){u[R][0]=g[n[l]][n[l+1]][R],u[R][R]=g[n[l]][n[l+2]][R],p.x=(o[3*u[R][R]]-o[3*u[R][0]])/R,p.y=(o[3*u[R][R]+1]-o[3*u[R][0]+1])/R,p.z=(o[3*u[R][R]+2]-o[3*u[R][0]+2])/R,s&&(d.x=(s[3*u[R][R]]-s[3*u[R][0]])/R,d.y=(s[3*u[R][R]+1]-s[3*u[R][0]+1])/R,d.z=(s[3*u[R][R]+2]-s[3*u[R][0]+2])/R),a&&(m.x=(a[2*u[R][R]]-a[2*u[R][0]])/R,m.y=(a[2*u[R][R]+1]-a[2*u[R][0]+1])/R);for(var P=1;P<R;P++)u[R][P]=o.length/3,o[A++]=o[3*u[R][0]]+P*p.x,o[A++]=o[3*u[R][0]+1]+P*p.y,o[A++]=o[3*u[R][0]+2]+P*p.z,s&&(s[C++]=s[3*u[R][0]]+P*d.x,s[C++]=s[3*u[R][0]+1]+P*d.y,s[C++]=s[3*u[R][0]+2]+P*d.z),a&&(a[M++]=a[2*u[R][0]]+P*m.x,a[M++]=a[2*u[R][0]+1]+P*m.y)}u[f]=g[n[l+1]][n[l+2]],_.push(u[0][0],u[1][0],u[1][1]);for(var R=1;R<f;R++){var P=void 0;for(P=0;P<R;P++)_.push(u[R][P],u[R+1][P],u[R+1][P+1]),_.push(u[R][P],u[R+1][P+1],u[R][P+1]);_.push(u[R][P],u[R+1][P],u[R+1][P+1])}}i.indices=_,i.applyToMesh(this,this.isVertexBufferUpdatable(b.PositionKind))}},e.prototype.forceSharedVertices=function(){var t=re.ExtractFromMesh(this),i=t.uvs,n=t.indices,o=t.positions,a=t.colors;if(n===void 0||o===void 0||n===null||o===null)q.Warn("VertexData contains empty entries");else{for(var s=new Array,f=new Array,u=new Array,l=new Array,h=new Array,c=0,p={},d=void 0,m=void 0,_=0;_<n.length;_+=3){m=[n[_],n[_+1],n[_+2]],h=new Array;for(var y=0;y<3;y++){h[y]="";for(var g=0;g<3;g++)Math.abs(o[3*m[y]+g])<1e-8&&(o[3*m[y]+g]=0),h[y]+=o[3*m[y]+g]+"|"}if(!(h[0]==h[1]||h[0]==h[2]||h[1]==h[2]))for(var y=0;y<3;y++){if(d=p[h[y]],d===void 0){p[h[y]]=c,d=c++;for(var g=0;g<3;g++)s.push(o[3*m[y]+g]);if(a!=null)for(var g=0;g<4;g++)l.push(a[4*m[y]+g]);if(i!=null)for(var g=0;g<2;g++)u.push(i[2*m[y]+g])}f.push(d)}}var T=new Array;re.ComputeNormals(s,f,T),t.positions=s,t.indices=f,t.normals=T,i!=null&&(t.uvs=u),a!=null&&(t.colors=l),t.applyToMesh(this,this.isVertexBufferUpdatable(b.PositionKind))}},e._instancedMeshFactory=function(t,i){throw Q("InstancedMesh")},e._PhysicsImpostorParser=function(t,i,n){throw Q("PhysicsImpostor")},e.prototype.createInstance=function(t){return e._instancedMeshFactory(t,this)},e.prototype.synchronizeInstances=function(){for(var t=0;t<this.instances.length;t++){var i=this.instances[t];i._syncSubMeshes()}return this},e.prototype.optimizeIndices=function(t){var i=this,n=this.getIndices(),o=this.getVerticesData(b.PositionKind);if(!o||!n)return this;for(var a=new Array,s=0;s<o.length;s=s+3)a.push(E.FromArray(o,s));var f=new Array;return ch.SyncAsyncForLoop(a.length,40,function(u){for(var l=a.length-1-u,h=a[l],c=0;c<l;++c){var p=a[c];if(h.equals(p)){f[l]=c;break}}},function(){for(var u=0;u<n.length;++u)n[u]=f[n[u]]||n[u];var l=i.subMeshes.slice(0);i.setIndices(n),i.subMeshes=l,t&&t(i)}),this},e.prototype.serialize=function(t){t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,t.type=this.getClassName(),Ee&&Ee.HasTags(this)&&(t.tags=Ee.GetTags(this)),t.position=this.position.asArray(),this.rotationQuaternion?t.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(t.rotation=this.rotation.asArray()),t.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?t.pivotMatrix=this.getPivotMatrix().asArray():t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(!1),t.isVisible=this.isVisible,t.infiniteDistance=this.infiniteDistance,t.pickable=this.isPickable,t.receiveShadows=this.receiveShadows,t.billboardMode=this.billboardMode,t.visibility=this.visibility,t.checkCollisions=this.checkCollisions,t.isBlocker=this.isBlocker,t.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(t),t.isUnIndexed=this.isUnIndexed;var i=this._geometry;if(i&&this.subMeshes){t.geometryUniqueId=i.uniqueId,t.geometryId=i.id,t.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var o=this.subMeshes[n];t.subMeshes.push({materialIndex:o.materialIndex,verticesStart:o.verticesStart,verticesCount:o.verticesCount,indexStart:o.indexStart,indexCount:o.indexCount})}}if(this.material?this.material.doNotSerialize||(t.materialUniqueId=this.material.uniqueId,t.materialId=this.material.id):(this.material=null,t.materialUniqueId=this._scene.defaultMaterial.uniqueId,t.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(t.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(t.skeletonId=this.skeleton.id,t.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Lr.NAME_PHYSICSENGINE)){var a=this.getPhysicsImpostor();a&&(t.physicsMass=a.getParam("mass"),t.physicsFriction=a.getParam("friction"),t.physicsRestitution=a.getParam("mass"),t.physicsImpostor=a.type)}this.metadata&&(t.metadata=this.metadata),t.instances=[];for(var s=0;s<this.instances.length;s++){var f=this.instances[s];if(!f.doNotSerialize){var u={name:f.name,id:f.id,isEnabled:f.isEnabled(!1),isVisible:f.isVisible,isPickable:f.isPickable,checkCollisions:f.checkCollisions,position:f.position.asArray(),scaling:f.scaling.asArray()};if(f.parent&&f.parent._serializeAsParent(u),f.rotationQuaternion?u.rotationQuaternion=f.rotationQuaternion.asArray():f.rotation&&(u.rotation=f.rotation.asArray()),this.getScene()._getComponent(Lr.NAME_PHYSICSENGINE)){var a=f.getPhysicsImpostor();a&&(u.physicsMass=a.getParam("mass"),u.physicsFriction=a.getParam("friction"),u.physicsRestitution=a.getParam("mass"),u.physicsImpostor=a.type)}f.metadata&&(u.metadata=f.metadata),t.instances.push(u),te.AppendSerializedAnimations(f,u),u.ranges=f.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(t.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var l={data:{},sizes:{},strides:{}};for(var h in this._userThinInstanceBuffersStorage.data)l.data[h]=Array.from(this._userThinInstanceBuffersStorage.data[h]),l.sizes[h]=this._userThinInstanceBuffersStorage.sizes[h],l.strides[h]=this._userThinInstanceBuffersStorage.strides[h];t.thinInstances.userThinInstance=l}te.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.layerMask=this.layerMask,t.alphaIndex=this.alphaIndex,t.hasVertexAlpha=this.hasVertexAlpha,t.overlayAlpha=this.overlayAlpha,t.overlayColor=this.overlayColor.asArray(),t.renderOverlay=this.renderOverlay,t.applyFog=this.applyFog,this.actionManager&&(t.actions=this.actionManager.serialize(this.name))},e.prototype._syncGeometryWithMorphTargetManager=function(){if(!!this.geometry){this._markSubMeshesAsAttributesDirty();var t=this._internalAbstractMeshDataInfo._morphTargetManager;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices()){q.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(t.isUsingTextureForTargets)return;for(var i=0;i<t.numInfluencers;i++){var n=t.getActiveTarget(i),o=n.getPositions();if(!o){q.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(b.PositionKind+i,o,!1,3);var a=n.getNormals();a&&this.geometry.setVerticesData(b.NormalKind+i,a,!1,3);var s=n.getTangents();s&&this.geometry.setVerticesData(b.TangentKind+i,s,!1,3);var f=n.getUVs();f&&this.geometry.setVerticesData(b.UVKind+"_"+i,f,!1,2)}}else for(var i=0;this.geometry.isVerticesDataPresent(b.PositionKind+i);)this.geometry.removeVerticesData(b.PositionKind+i),this.geometry.isVerticesDataPresent(b.NormalKind+i)&&this.geometry.removeVerticesData(b.NormalKind+i),this.geometry.isVerticesDataPresent(b.TangentKind+i)&&this.geometry.removeVerticesData(b.TangentKind+i),this.geometry.isVerticesDataPresent(b.UVKind+i)&&this.geometry.removeVerticesData(b.UVKind+"_"+i),i++}},e.Parse=function(t,i,n){var o;if(t.type&&t.type==="LinesMesh"?o=e._LinesMeshParser(t,i):t.type&&t.type==="GroundMesh"?o=e._GroundMeshParser(t,i):t.type&&t.type==="GoldbergMesh"?o=e._GoldbergMeshParser(t,i):o=new e(t.name,i),o.id=t.id,o._waitingParsedUniqueId=t.uniqueId,Ee&&Ee.AddTagsTo(o,t.tags),o.position=E.FromArray(t.position),t.metadata!==void 0&&(o.metadata=t.metadata),t.rotationQuaternion?o.rotationQuaternion=ie.FromArray(t.rotationQuaternion):t.rotation&&(o.rotation=E.FromArray(t.rotation)),o.scaling=E.FromArray(t.scaling),t.localMatrix?o.setPreTransformMatrix(B.FromArray(t.localMatrix)):t.pivotMatrix&&o.setPivotMatrix(B.FromArray(t.pivotMatrix)),o.setEnabled(t.isEnabled),o.isVisible=t.isVisible,o.infiniteDistance=t.infiniteDistance,o.showBoundingBox=t.showBoundingBox,o.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,t.applyFog!==void 0&&(o.applyFog=t.applyFog),t.pickable!==void 0&&(o.isPickable=t.pickable),t.alphaIndex!==void 0&&(o.alphaIndex=t.alphaIndex),o.receiveShadows=t.receiveShadows,o.billboardMode=t.billboardMode,t.visibility!==void 0&&(o.visibility=t.visibility),o.checkCollisions=t.checkCollisions,o.overrideMaterialSideOrientation=t.overrideMaterialSideOrientation,t.isBlocker!==void 0&&(o.isBlocker=t.isBlocker),o._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(o._waitingData.freezeWorldMatrix=t.freezeWorldMatrix),t.parentId!==void 0&&(o._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=t.parentInstanceIndex),t.actions!==void 0&&(o._waitingData.actions=t.actions),t.overlayAlpha!==void 0&&(o.overlayAlpha=t.overlayAlpha),t.overlayColor!==void 0&&(o.overlayColor=de.FromArray(t.overlayColor)),t.renderOverlay!==void 0&&(o.renderOverlay=t.renderOverlay),o.isUnIndexed=!!t.isUnIndexed,o.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(o.delayLoadState=4,o.delayLoadingFile=n+t.delayLoadingFile,o.buildBoundingInfo(E.FromArray(t.boundingBoxMinimum),E.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(o._binaryInfo=t._binaryInfo),o._delayInfo=[],t.hasUVs&&o._delayInfo.push(b.UVKind),t.hasUVs2&&o._delayInfo.push(b.UV2Kind),t.hasUVs3&&o._delayInfo.push(b.UV3Kind),t.hasUVs4&&o._delayInfo.push(b.UV4Kind),t.hasUVs5&&o._delayInfo.push(b.UV5Kind),t.hasUVs6&&o._delayInfo.push(b.UV6Kind),t.hasColors&&o._delayInfo.push(b.ColorKind),t.hasMatricesIndices&&o._delayInfo.push(b.MatricesIndicesKind),t.hasMatricesWeights&&o._delayInfo.push(b.MatricesWeightsKind),o._delayLoadingFunction=nr._ImportGeometry,Hn.ForceFullSceneLoadingForIncremental&&o._checkDelayState()):nr._ImportGeometry(t,o),t.materialUniqueId?o._waitingMaterialId=t.materialUniqueId:t.materialId&&(o._waitingMaterialId=t.materialId),t.morphTargetManagerId>-1&&(o.morphTargetManager=i.getMorphTargetManagerById(t.morphTargetManagerId)),t.skeletonId!==void 0&&t.skeletonId!==null&&(o.skeleton=i.getLastSkeletonById(t.skeletonId),t.numBoneInfluencers&&(o.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(var a=0;a<t.animations.length;a++){var s=t.animations[a],f=wt("BABYLON.Animation");f&&o.animations.push(f.Parse(s))}gt.ParseAnimationRanges(o,t,i)}if(t.autoAnimate&&i.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?o.layerMask=Math.abs(parseInt(t.layerMask)):o.layerMask=268435455,t.physicsImpostor&&e._PhysicsImpostorParser(i,o,t),t.lodMeshIds&&(o._waitingData.lods={ids:t.lodMeshIds,distances:t.lodDistances?t.lodDistances:null,coverages:t.lodCoverages?t.lodCoverages:null}),t.instances)for(var u=0;u<t.instances.length;u++){var l=t.instances[u],h=o.createInstance(l.name);if(l.id&&(h.id=l.id),Ee&&(l.tags?Ee.AddTagsTo(h,l.tags):Ee.AddTagsTo(h,t.tags)),h.position=E.FromArray(l.position),l.metadata!==void 0&&(h.metadata=l.metadata),l.parentId!==void 0&&(h._waitingParentId=l.parentId),l.parentInstanceIndex!==void 0&&(h._waitingParentInstanceIndex=l.parentInstanceIndex),l.isEnabled!==void 0&&l.isEnabled!==null&&h.setEnabled(l.isEnabled),l.isVisible!==void 0&&l.isVisible!==null&&(h.isVisible=l.isVisible),l.isPickable!==void 0&&l.isPickable!==null&&(h.isPickable=l.isPickable),l.rotationQuaternion?h.rotationQuaternion=ie.FromArray(l.rotationQuaternion):l.rotation&&(h.rotation=E.FromArray(l.rotation)),h.scaling=E.FromArray(l.scaling),l.checkCollisions!=null&&l.checkCollisions!=null&&(h.checkCollisions=l.checkCollisions),l.pickable!=null&&l.pickable!=null&&(h.isPickable=l.pickable),l.showBoundingBox!=null&&l.showBoundingBox!=null&&(h.showBoundingBox=l.showBoundingBox),l.showSubMeshesBoundingBox!=null&&l.showSubMeshesBoundingBox!=null&&(h.showSubMeshesBoundingBox=l.showSubMeshesBoundingBox),l.alphaIndex!=null&&l.showSubMeshesBoundingBox!=null&&(h.alphaIndex=l.alphaIndex),l.physicsImpostor&&e._PhysicsImpostorParser(i,h,l),l.animations){for(var a=0;a<l.animations.length;a++){var s=l.animations[a],f=wt("BABYLON.Animation");f&&h.animations.push(f.Parse(s))}gt.ParseAnimationRanges(h,l,i),l.autoAnimate&&i.beginAnimation(h,l.autoAnimateFrom,l.autoAnimateTo,l.autoAnimateLoop,l.autoAnimateSpeed||1)}}if(t.thinInstances){var c=t.thinInstances;if(o.thinInstanceEnablePicking=!!c.enablePicking,c.matrixData?(o.thinInstanceSetBuffer("matrix",new Float32Array(c.matrixData),16,!1),o._thinInstanceDataStorage.matrixBufferSize=c.matrixBufferSize,o._thinInstanceDataStorage.instancesCount=c.instancesCount):o._thinInstanceDataStorage.matrixBufferSize=c.matrixBufferSize,t.thinInstances.userThinInstance){var p=t.thinInstances.userThinInstance;for(var d in p.data)o.thinInstanceSetBuffer(d,new Float32Array(p.data[d]),p.strides[d],!1),o._userThinInstanceBuffersStorage.sizes[d]=p.sizes[d]}}return o},e.prototype.setPositionsForCPUSkinning=function(){var t=this._internalMeshDataInfo;if(!t._sourcePositions){var i=this.getVerticesData(b.PositionKind);if(!i)return t._sourcePositions;t._sourcePositions=new Float32Array(i),this.isVertexBufferUpdatable(b.PositionKind)||this.setVerticesData(b.PositionKind,i,!0)}return t._sourcePositions},e.prototype.setNormalsForCPUSkinning=function(){var t=this._internalMeshDataInfo;if(!t._sourceNormals){var i=this.getVerticesData(b.NormalKind);if(!i)return t._sourceNormals;t._sourceNormals=new Float32Array(i),this.isVertexBufferUpdatable(b.NormalKind)||this.setVerticesData(b.NormalKind,i,!0)}return t._sourceNormals},e.prototype.applySkeleton=function(t){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(b.PositionKind))return this;if(!this.isVerticesDataPresent(b.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(b.MatricesWeightsKind))return this;var i=this.isVerticesDataPresent(b.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){var o=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=o}i&&!n._sourceNormals&&this.setNormalsForCPUSkinning();var a=this.getVerticesData(b.PositionKind);if(!a)return this;a instanceof Float32Array||(a=new Float32Array(a));var s=this.getVerticesData(b.NormalKind);if(i){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}var f=this.getVerticesData(b.MatricesIndicesKind),u=this.getVerticesData(b.MatricesWeightsKind);if(!u||!f)return this;for(var l=this.numBoneInfluencers>4,h=l?this.getVerticesData(b.MatricesIndicesExtraKind):null,c=l?this.getVerticesData(b.MatricesWeightsExtraKind):null,p=t.getTransformMatrices(this),d=E.Zero(),m=new B,_=new B,y=0,g,T=0;T<a.length;T+=3,y+=4){var A=void 0;for(g=0;g<4;g++)A=u[y+g],A>0&&(B.FromFloat32ArrayToRefScaled(p,Math.floor(f[y+g]*16),A,_),m.addToSelf(_));if(l)for(g=0;g<4;g++)A=c[y+g],A>0&&(B.FromFloat32ArrayToRefScaled(p,Math.floor(h[y+g]*16),A,_),m.addToSelf(_));E.TransformCoordinatesFromFloatsToRef(n._sourcePositions[T],n._sourcePositions[T+1],n._sourcePositions[T+2],m,d),d.toArray(a,T),i&&(E.TransformNormalFromFloatsToRef(n._sourceNormals[T],n._sourceNormals[T+1],n._sourceNormals[T+2],m,d),d.toArray(s,T)),m.reset()}return this.updateVerticesData(b.PositionKind,a),i&&this.updateVerticesData(b.NormalKind,s),this},e.MinMax=function(t){var i=null,n=null;return t.forEach(function(o){var a=o.getBoundingInfo(),s=a.boundingBox;!i||!n?(i=s.minimumWorld,n=s.maximumWorld):(i.minimizeInPlace(s.minimumWorld),n.maximizeInPlace(s.maximumWorld))}),!i||!n?{min:E.Zero(),max:E.Zero()}:{min:i,max:n}},e.Center=function(t){var i=t instanceof Array?e.MinMax(t):t;return E.Center(i.min,i.max)},e.MergeMeshes=function(t,i,n,o,a,s){return i===void 0&&(i=!0),Wi(e._MergeMeshesCoroutine(t,i,n,o,a,s,!1))},e.MergeMeshesAsync=function(t,i,n,o,a,s){return i===void 0&&(i=!0),vh(e._MergeMeshesCoroutine(t,i,n,o,a,s,!0),ph())},e._MergeMeshesCoroutine=function(t,i,n,o,a,s,f){var u,l,h,c,p,d,m,_,y,z,z,z,g,T,A,M,C,P,R,F,I,D,V,k,w,G,K,j,W,z;return i===void 0&&(i=!0),Lt(this,function(oe){switch(oe.label){case 0:if(t=t.filter(Boolean),t.length===0)return[2,null];if(!n){for(l=0,u=0;u<t.length;u++)if(l+=t[u].getTotalVertices(),l>=65536)return q.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),[2,null]}for(s&&(a=!1),h=new Array,c=new Array,p=new Array,d=t[0].overrideMaterialSideOrientation,u=0;u<t.length;u++){if(m=t[u],m.isAnInstance)return q.Warn("Cannot merge instance meshes."),[2,null];if(d!==m.overrideMaterialSideOrientation)return q.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),[2,null];if(a&&p.push(m.getTotalIndices()),s)if(m.material)if(_=m.material,_ instanceof Yn){for(y=0;y<_.subMaterials.length;y++)h.indexOf(_.subMaterials[y])<0&&h.push(_.subMaterials[y]);for(z=0;z<m.subMeshes.length;z++)c.push(h.indexOf(_.subMaterials[m.subMeshes[z].materialIndex])),p.push(m.subMeshes[z].indexCount)}else for(h.indexOf(_)<0&&h.push(_),z=0;z<m.subMeshes.length;z++)c.push(h.indexOf(_)),p.push(m.subMeshes[z].indexCount);else for(z=0;z<m.subMeshes.length;z++)c.push(0),p.push(m.subMeshes[z].indexCount)}return g=t[0],T=function(be){var Pe=be.computeWorldMatrix(!0),ze=re.ExtractFromMesh(be,!1,!1);return[ze,Pe]},A=T(g),M=A[0],C=A[1],f?[4]:[3,2];case 1:oe.sent(),oe.label=2;case 2:P=new Array(t.length-1),R=1,oe.label=3;case 3:return R<t.length?(P[R-1]=T(t[R]),f?[4]:[3,5]):[3,6];case 4:oe.sent(),oe.label=5;case 5:return R++,[3,3];case 6:F=M._mergeCoroutine(C,P,n,f,!i),I=F.next(),oe.label=7;case 7:return I.done?[3,10]:f?[4]:[3,9];case 8:oe.sent(),oe.label=9;case 9:return I=F.next(),[3,7];case 10:D=I.value,o||(o=new e(g.name+"_merged",g.getScene())),V=D._applyToCoroutine(o,void 0,f),k=V.next(),oe.label=11;case 11:return k.done?[3,14]:f?[4]:[3,13];case 12:oe.sent(),oe.label=13;case 13:return k=V.next(),[3,11];case 14:if(o.checkCollisions=g.checkCollisions,o.overrideMaterialSideOrientation=g.overrideMaterialSideOrientation,i)for(u=0;u<t.length;u++)t[u].dispose();if(a||s){for(o.releaseSubMeshes(),u=0,w=0;u<p.length;)Bt.CreateFromIndices(0,w,p[u],o,void 0,!1),w+=p[u],u++;for(G=0,K=o.subMeshes;G<K.length;G++)j=K[G],j.refreshBoundingInfo();o.computeWorldMatrix(!0)}if(s){for(W=new Yn(g.name+"_merged",g.getScene()),W.subMaterials=h,z=0;z<o.subMeshes.length;z++)o.subMeshes[z].materialIndex=c[z];o.material=W}else o.material=g.material;return[2,o]}})},e.prototype.addInstance=function(t){t._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(t)},e.prototype.removeInstance=function(t){var i=t._indexInSourceMeshInstanceArray;if(i!=-1){if(i!==this.instances.length-1){var n=this.instances[this.instances.length-1];this.instances[i]=n,n._indexInSourceMeshInstanceArray=i}t._indexInSourceMeshInstanceArray=-1,this.instances.pop()}},e.prototype._shouldConvertRHS=function(){return this.overrideMaterialSideOrientation===De.CounterClockWiseSideOrientation},e.FRONTSIDE=re.FRONTSIDE,e.BACKSIDE=re.BACKSIDE,e.DOUBLESIDE=re.DOUBLESIDE,e.DEFAULTSIDE=re.DEFAULTSIDE,e.NO_CAP=0,e.CAP_START=1,e.CAP_END=2,e.CAP_ALL=3,e.NO_FLIP=0,e.FLIP_TILE=1,e.ROTATE_TILE=2,e.FLIP_ROW=3,e.ROTATE_ROW=4,e.FLIP_N_ROTATE_TILE=5,e.FLIP_N_ROTATE_ROW=6,e.CENTER=0,e.LEFT=1,e.RIGHT=2,e.TOP=3,e.BOTTOM=4,e.INSTANCEDMESH_SORT_TRANSPARENT=!1,e._GroundMeshParser=function(t,i){throw Q("GroundMesh")},e._GoldbergMeshParser=function(t,i){throw Q("GoldbergMesh")},e._LinesMeshParser=function(t,i){throw Q("LinesMesh")},e}(wr);Ke("BABYLON.Mesh",H);H.prototype.setMaterialByID=function(r){return this.setMaterialById(r)};H.CreateDisc=H.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateBox=H.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateSphere=H.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateCylinder=H.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateTorusKnot=H.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateTorus=H.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreatePlane=H.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateGround=H.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateTiledGround=H.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateGroundFromHeightMap=H.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateTube=H.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreatePolyhedron=H.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateIcoSphere=H.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateDecal=H.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")};H.CreateCapsule=H.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")};H.ExtendToGoldberg=H.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")};function Jh(r){var e=new Array,t=new Array,i=new Array,n=new Array,o=r.radius||.5,a=r.tessellation||64,s=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,f=r.sideOrientation===0?0:r.sideOrientation||re.DEFAULTSIDE;e.push(0,0,0),n.push(.5,.5);for(var u=Math.PI*2*s,l=s===1?u/a:u/(a-1),h=0,c=0;c<a;c++){var p=Math.cos(h),d=Math.sin(h),m=(p+1)/2,_=(1-d)/2;e.push(o*p,o*d,0),n.push(m,Oe.UseOpenGLOrientationForUV?1-_:_),h+=l}s===1&&(e.push(e[3],e[4],e[5]),n.push(n[2],Oe.UseOpenGLOrientationForUV?1-n[3]:n[3]));for(var y=e.length/3,g=1;g<y-1;g++)t.push(g+1,0,g);re.ComputeNormals(e,t,i),re._ComputeSides(f,e,t,i,n,r.frontUVs,r.backUVs);var T=new re;return T.indices=t,T.positions=e,T.normals=i,T.uvs=n,T}function Ra(r,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var i=new H(r,t);e.sideOrientation=H._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation;var n=Jh(e);return n.applyToMesh(i,e.updatable),i}re.CreateDisc=Jh;H.CreateDisc=function(r,e,t,i,n,o){i===void 0&&(i=null);var a={radius:e,tessellation:t,sideOrientation:o,updatable:n};return Ra(r,a,i)};v();H._instancedMeshFactory=function(r,e){var t=new xa(r,e);if(e.instancedBuffers){t.instancedBuffers={};for(var i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};var xa=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i.getScene())||this;n._indexInSourceMeshInstanceArray=-1,n._distanceToCamera=0,i.addInstance(n),n._sourceMesh=i,n._unIndexed=i._unIndexed,n.position.copyFrom(i.position),n.rotation.copyFrom(i.rotation),n.scaling.copyFrom(i.scaling),i.rotationQuaternion&&(n.rotationQuaternion=i.rotationQuaternion.clone()),n.animations=i.animations.slice();for(var o=0,a=i.getAnimationRanges();o<a.length;o++){var s=a[o];s!=null&&n.createAnimationRange(s.name,s.from,s.to)}return n.infiniteDistance=i.infiniteDistance,n.setPivotMatrix(i.getPivotMatrix()),n.refreshBoundingInfo(!0,!0),n._syncSubMeshes(),n}return e.prototype.getClassName=function(){return"InstancedMesh"},Object.defineProperty(e.prototype,"lightSources",{get:function(){return this._sourceMesh._lightSources},enumerable:!1,configurable:!0}),e.prototype._resyncLightSources=function(){},e.prototype._resyncLightSource=function(){},e.prototype._removeLightSource=function(){},Object.defineProperty(e.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},set:function(t){!this._sourceMesh||t===this._sourceMesh.renderingGroupId||q.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")},enumerable:!1,configurable:!0}),e.prototype.getTotalVertices=function(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0},e.prototype.getTotalIndices=function(){return this._sourceMesh.getTotalIndices()},Object.defineProperty(e.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!1,configurable:!0}),e.prototype.createInstance=function(t){return this._sourceMesh.createInstance(t)},e.prototype.isReady=function(t){return t===void 0&&(t=!1),this._sourceMesh.isReady(t,!0)},e.prototype.getVerticesData=function(t,i){return this._sourceMesh.getVerticesData(t,i)},e.prototype.setVerticesData=function(t,i,n,o){return this.sourceMesh&&this.sourceMesh.setVerticesData(t,i,n,o),this.sourceMesh},e.prototype.updateVerticesData=function(t,i,n,o){return this.sourceMesh&&this.sourceMesh.updateVerticesData(t,i,n,o),this.sourceMesh},e.prototype.setIndices=function(t,i){return i===void 0&&(i=null),this.sourceMesh&&this.sourceMesh.setIndices(t,i),this.sourceMesh},e.prototype.isVerticesDataPresent=function(t){return this._sourceMesh.isVerticesDataPresent(t)},e.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(e.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!1,configurable:!0}),e.prototype.refreshBoundingInfo=function(t,i){if(t===void 0&&(t=!1),i===void 0&&(i=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(t,i),n),this},e.prototype._preActivate=function(){return this._currentLOD&&this._currentLOD._preActivate(),this},e.prototype._activate=function(t,i){if(r.prototype._activate.call(this,t,i),this._sourceMesh.subMeshes||q.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){var n=this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0;if(n)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,t),i){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1},e.prototype._postActivate=function(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)},e.prototype.getWorldMatrix=function(){if(this._currentLOD&&this._currentLOD.billboardMode!==rt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new B);var t=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,L.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(L.Vector3[7]),this._currentLOD._masterMesh=t,this._billboardWorldMatrix}return r.prototype.getWorldMatrix.call(this)},Object.defineProperty(e.prototype,"isAnInstance",{get:function(){return!0},enumerable:!1,configurable:!0}),e.prototype.getLOD=function(t){if(!t)return this;var i=this.sourceMesh.getLODLevels();if(!i||i.length===0)this._currentLOD=this.sourceMesh;else{var n=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(t,n.boundingSphere)}return this._currentLOD},e.prototype._preActivateForIntermediateRendering=function(t){return this.sourceMesh._preActivateForIntermediateRendering(t)},e.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var t=0;t<this._sourceMesh.subMeshes.length;t++)this._sourceMesh.subMeshes[t].clone(this,this._sourceMesh);return this},e.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},e.prototype._updateBoundingInfo=function(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},e.prototype.clone=function(t,i,n){i===void 0&&(i=null);var o=this._sourceMesh.createInstance(t);if(oi.DeepCopy(this,o,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),i&&(o.parent=i),!n)for(var a=0;a<this.getScene().meshes.length;a++){var s=this.getScene().meshes[a];s.parent===this&&s.clone(s.name,o)}return o.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(o),o},e.prototype.dispose=function(t,i){i===void 0&&(i=!1),this._sourceMesh.removeInstance(this),r.prototype.dispose.call(this,t,i)},e.prototype._serializeAsParent=function(t){r.prototype._serializeAsParent.call(this,t),t.parentId=this._sourceMesh.uniqueId,t.parentInstanceIndex=this._indexInSourceMeshInstanceArray},e}(wr);H.prototype.registerInstancedBuffer=function(r,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[r])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(var n=0,o=this.instances;n<o.length;n++){var a=o[n];a.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[r]=null,this._userInstancedBuffersStorage.strides[r]=e,this._userInstancedBuffersStorage.sizes[r]=e*32,this._userInstancedBuffersStorage.data[r]=new Float32Array(this._userInstancedBuffersStorage.sizes[r]),this._userInstancedBuffersStorage.vertexBuffers[r]=new b(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,e,!0);for(var s=0,f=this.instances;s<f.length;s++){var a=f[s];a.instancedBuffers[r]=null}this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};H.prototype._processInstancedBuffers=function(r,e){var t=r.length;for(var i in this.instancedBuffers){for(var n=this._userInstancedBuffersStorage.sizes[i],o=this._userInstancedBuffersStorage.strides[i],a=(t+1)*o;n<a;)n*=2;this._userInstancedBuffersStorage.data[i].length!=n&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[i]=n,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));var s=this._userInstancedBuffersStorage.data[i],f=0;if(e){var u=this.instancedBuffers[i];u.toArray?u.toArray(s,f):u.copyToArray?u.copyToArray(s,f):s[f]=u,f+=o}for(var l=0;l<t;l++){var h=r[l],u=h.instancedBuffers[i];u.toArray?u.toArray(s,f):u.copyToArray?u.copyToArray(s,f):s[f]=u,f+=o}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(s,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new b(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,o,!0),this._invalidateInstanceVertexArrayObject())}};H.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(var r in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[r]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};H.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var r in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[r]&&this._userInstancedBuffersStorage.vertexBuffers[r].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};function $h(r,e){var t=e,i=r.rendering.getScene(),n=Ra("shadow",{radius:.75,tessellation:30},i);n.rotation.x=Math.PI/2;var o=r.rendering.makeStandardMaterial("shadowMat");return o.diffuseColor=de.Black(),o.ambientColor=de.Black(),o.alpha=.5,n.material=o,n.setEnabled(!1),o.freeze(),i.removeMesh(n),{name:"shadow",order:80,state:{size:.5,_mesh:null},onAdd:function(a,s){var f=n.createInstance("shadow_instance");r.rendering.addMeshToScene(f),f.setEnabled(!1),s._mesh=f},onRemove:function(a,s){s._mesh.dispose()},system:function(s,f){for(var u=r.camera._localGetPosition(),l=t,h=0;h<f.length;h++){var c=f[h],p=r.ents.getPositionData(c.__id),d=r.ents.getPhysics(c.__id);Cv(r,p,d,c._mesh,c.size,l,u)}},renderSystem:function(a,s){for(var f=0;f<s.length;f++){var u=s[f],l=r.ents.getPositionData(u.__id)._renderPosition,h=u._mesh.position;h.x=l[0],h.z=l[2]}}}}var Pa=ji.default.fromValues(0,0,0),Pv=ji.default.fromValues(0,-1,0);function Cv(r,e,t,i,n,o,a){var s;if(t&&t.body.resting[1]<0)s=e._localPosition[1];else{var f=r._localPick(e._localPosition,Pv,o);if(!f){i.setEnabled(!1);return}s=f.position[1]-r.worldOriginOffset[1]}s=Math.round(s),ji.default.copy(Pa,e._localPosition),Pa[1]=s;var u=ji.default.squaredDistance(a,Pa),l=.01+.1*(u/1600);l>.1&&(l=.1),i.position.y=s+l;var h=e._localPosition[1]-s,c=n*.7*(1-h/o);i.scaling.copyFromFloats(c,c,c),i.setEnabled(!0)}v();function ec(r){var e="smoothCamera";return{name:e,order:99,state:{time:100.1},onAdd:null,onRemove:null,system:function(t,i){for(var n=0;n<i.length;n++){var o=i[n];o.time-=t,o.time<0&&r.ents.removeComponent(o.__id,e)}}}}var Iv={shadowDistance:10},qn=class extends rc.default{constructor(e,t){super(),t=Object.assign({},Iv,t);var i={shadow:t.shadowDistance};this.noa=e,this.names={};var n={collideEntities:cl,collideTerrain:dl,fadeOnZoom:pl,followsEntity:_l,mesh:ml,movement:gl,physics:Au,position:bu,receivesInputs:yl,shadow:$h,smoothCamera:ec};Object.keys(n).forEach(o=>{var a=i[o]||void 0,s=n[o],f=s(e,a);this.names[o]=this.createComponent(f)}),this.cameraSmoothed=this.getComponentAccessor(this.names.smoothCamera),this.hasPhysics=this.getComponentAccessor(this.names.physics),this.hasPosition=this.getComponentAccessor(this.names.position),this.getPositionData=this.getStateAccessor(this.names.position),this.getPosition=o=>{var a=this.getPositionData(o);return a?a.position:null},this.getPhysics=this.getStateAccessor(this.names.physics),this.getPhysicsBody=o=>{var a=this.getPhysics(o);return a?a.body:null},this.hasMesh=this.getComponentAccessor(this.names.mesh),this.getMeshData=this.getStateAccessor(this.names.mesh),this.getMovement=this.getStateAccessor(this.names.movement),this.getCollideTerrain=this.getStateAccessor(this.names.collideTerrain),this.getCollideEntities=this.getStateAccessor(this.names.collideEntities),this.onPairwiseEntityCollision=function(o,a){}}setPosition(e,t,i=0,n=0){typeof t=="number"&&(t=[t,i,n]);var o=this.noa.globalToLocal(t,null,[]);this._localSetPosition(e,o)}setEntitySize(e,t,i,n){var o=this.getPositionData(e);o.width=(t+n)/2,o.height=i,this._updateDerivedPositionData(e,o)}_rebaseOrigin(e){for(var t of this.getStatesList(this.names.position)){var i=t._localPosition,n=t.width/2;Ca(i,0,-n,n,t.__id),Ca(i,1,0,t.height,t.__id),Ca(i,2,-n,n,t.__id),Br.default.subtract(i,i,e),this._updateDerivedPositionData(t.__id,t)}}_localGetPosition(e){return this.getPositionData(e)._localPosition}_localSetPosition(e,t){var i=this.getPositionData(e);Br.default.copy(i._localPosition,t),this._updateDerivedPositionData(e,i)}_updateDerivedPositionData(e,t){Br.default.copy(t._renderPosition,t._localPosition);var i=this.noa.worldOriginOffset;Br.default.add(t.position,t._localPosition,i),_n(t);var n=this.getPhysics(e);n&&Zo(n,t)}addComponentAgain(e,t,i){this.hasComponent(e,t)&&this.removeComponent(e,t),this.addComponent(e,t,i)}isTerrainBlocked(e,t,i){for(var n=this.noa.worldOriginOffset,o=Math.floor(e-n[0]),a=Math.floor(t-n[1]),s=Math.floor(i-n[2]),f=[o+.001,a+.001,s+.001,o+.999,a+.999,s+.999],u=this.getStatesList(this.names.collideTerrain),l=0;l<u.length;l++){var h=u[l].__id,c=this.getPositionData(h)._extents;if(tc(f,c))return!0}return!1}getEntitiesInAABB(e,t){var i=this.noa.worldOriginOffset,n=[e.base[0]-i[0],e.base[1]-i[1],e.base[2]-i[2],e.max[0]-i[0],e.max[1]-i[1],e.max[2]-i[2]],o;if(t){o=[];for(var a of this.getStatesList(t)){var s=this.getPositionData(a.__id);s&&o.push(s)}}else o=this.getStatesList(this.names.position);for(var f=[],u=0;u<o.length;u++){var l=o[u];tc(n,l._extents)&&f.push(l.__id)}return f}add(e=null,t=1,i=1,n=null,o=null,a=!1,s=!1){var f=this,u=this.createEntity();if(this.addComponent(u,this.names.position,{position:e||Br.default.create(),width:t,height:i}),a){this.addComponent(u,this.names.physics);var l=this.getPhysics(u).body,h=this.names.smoothCamera;l.onStep=function(){f.addComponentAgain(u,h)}}return n&&(o||(o=Br.default.create()),this.addComponent(u,this.names.mesh,{mesh:n,offset:o})),s&&this.addComponent(u,this.names.shadow,{size:t}),u}};function Ca(r,e,t,i,n){var o=r[e]+t,a=r[e]+i;Math.abs(o-Math.round(o))<.002&&(r[e]+=.002),Math.abs(a-Math.round(a))<.001&&(r[e]-=.001)}function tc(r,e){return!(r[0]>e[3]||r[1]>e[4]||r[2]>e[5]||r[3]<e[0]||r[4]<e[1]||r[5]<e[2])}v();Ut();v();H.prototype.thinInstanceAdd=function(r,e){if(e===void 0&&(e=!0),!this.getScene().getEngine().getCaps().instancedArrays)return q.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(r)?r.length:1);var t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(r))for(var i=0;i<r.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r[i],i===r.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r,e);return t};H.prototype.thinInstanceAddSelf=function(r){return r===void 0&&(r=!0),this.thinInstanceAdd(B.IdentityReadOnly,r)};H.prototype.thinInstanceRegisterAttribute=function(r,e){r===b.ColorKind&&(r=b.ColorInstanceKind),this.removeVerticesData(r),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[r]=e,this._userThinInstanceBuffersStorage.sizes[r]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[r]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[r]),this._userThinInstanceBuffersStorage.vertexBuffers[r]=new b(this.getEngine(),this._userThinInstanceBuffersStorage.data[r],r,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])};H.prototype.thinInstanceSetMatrixAt=function(r,e,t){if(t===void 0&&(t=!0),!this._thinInstanceDataStorage.matrixData||r>=this._thinInstanceDataStorage.instancesCount)return!1;var i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,r*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[r]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};H.prototype.thinInstanceSetAttributeAt=function(r,e,t,i){return i===void 0&&(i=!0),r===b.ColorKind&&(r=b.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[r]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(r,0),this._userThinInstanceBuffersStorage.data[r].set(t,e*this._userThinInstanceBuffersStorage.strides[r]),i&&this.thinInstanceBufferUpdated(r),!0)};Object.defineProperty(H.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(r){var e,t,i=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,n=i?i.length/16:0;r<=n&&(this._thinInstanceDataStorage.instancesCount=r)},enumerable:!0,configurable:!0});H.prototype._thinInstanceCreateMatrixBuffer=function(r,e,t){t===void 0&&(t=!1),r===b.ColorKind&&(r=b.ColorInstanceKind);for(var i=new Or(this.getEngine(),e,!t,16,!1,!0),n=0;n<4;n++)this.setVerticesBuffer(i.createVertexBuffer(r+n,n*4,4));return i};H.prototype.thinInstanceSetBuffer=function(r,e,t,i){var n,o,a;t===void 0&&(t=0),i===void 0&&(i=!1),t=t||16,r==="matrix"?((n=this._thinInstanceDataStorage.matrixBuffer)===null||n===void 0||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):r==="previousMatrix"?((o=this._thinInstanceDataStorage.previousMatrixBuffer)===null||o===void 0||o.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(r===b.ColorKind&&(r=b.ColorInstanceKind),e===null?!((a=this._userThinInstanceBuffersStorage)===null||a===void 0)&&a.data[r]&&(this.removeVerticesData(r),delete this._userThinInstanceBuffersStorage.data[r],delete this._userThinInstanceBuffersStorage.strides[r],delete this._userThinInstanceBuffersStorage.sizes[r],delete this._userThinInstanceBuffersStorage.vertexBuffers[r]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[r]=e,this._userThinInstanceBuffersStorage.strides[r]=t,this._userThinInstanceBuffersStorage.sizes[r]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new b(this.getEngine(),e,r,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])))};H.prototype.thinInstanceBufferUpdated=function(r){var e,t,i;r==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):r==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(r===b.ColorKind&&(r=b.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(this._userThinInstanceBuffersStorage.data[r],0))};H.prototype.thinInstancePartialBufferUpdate=function(r,e,t){var i;r==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(r===b.ColorKind&&(r=b.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(e,t))};H.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];var r=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(var e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=B.FromArray(r,e*16)}return this._thinInstanceDataStorage.worldMatrices};H.prototype.thinInstanceRefreshBoundingInfo=function(r,e,t){if(r===void 0&&(r=!1),e===void 0&&(e=!1),t===void 0&&(t=!1),!(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)){var i=this._thinInstanceDataStorage.boundingVectors;r&&(i.length=0,this.refreshBoundingInfo(e,t));var n=this.getBoundingInfo(),o=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(var a=0;a<n.boundingBox.vectors.length;++a)i.push(n.boundingBox.vectors[a].clone());L.Vector3[0].setAll(Number.POSITIVE_INFINITY),L.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(var s=0;s<this._thinInstanceDataStorage.instancesCount;++s){B.FromArrayToRef(o,s*16,L.Matrix[0]);for(var a=0;a<i.length;++a)E.TransformCoordinatesToRef(i[a],L.Matrix[0],L.Vector3[2]),L.Vector3[0].minimizeInPlace(L.Vector3[2]),L.Vector3[1].maximizeInPlace(L.Vector3[2])}n.reConstruct(L.Vector3[0],L.Vector3[1]),this._updateBoundingInfo()}};H.prototype._thinInstanceUpdateBufferSize=function(r,e){var t,i,n;e===void 0&&(e=1),r===b.ColorKind&&(r=b.ColorInstanceKind);var o=r==="matrix";if(!(!o&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[r]))){for(var a=o?16:this._userThinInstanceBuffersStorage.strides[r],s=o?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[r],f=o?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[r],u=(this._thinInstanceDataStorage.instancesCount+e)*a,l=s;l<u;)l*=2;if(!f||s!=l){if(!f)f=new Float32Array(l);else{var h=new Float32Array(l);h.set(f,0),f=h}o?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",f,!1),this._thinInstanceDataStorage.matrixData=f,this._thinInstanceDataStorage.matrixBufferSize=l,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",f,!1))):((n=this._userThinInstanceBuffersStorage.vertexBuffers[r])===null||n===void 0||n.dispose(),this._userThinInstanceBuffersStorage.data[r]=f,this._userThinInstanceBuffersStorage.sizes[r]=l,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new b(this.getEngine(),f,r,!0,!1,a,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r]))}}};H.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};H.prototype._disposeThinInstanceSpecificData=function(){var r;!((r=this._thinInstanceDataStorage)===null||r===void 0)&&r.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};Ut();var sc=Nv,ac=0;function Nv(r){this.rootNode=new rt("objectMeshRoot",r.rendering._scene);var e=[0,0,0],t=!1,i=new rt(""),n={},o=a=>{if(n[a])return n[a];var s=r.registry._blockMeshLookup[a];for(var f in n){var u=n[f].mesh;if(u===s||u.geometry===s.geometry)return n[a]=n[f]}return n[a]=new yi(r,s)};this.initChunk=function(a){a._objectBlocks={}},this.setObjectBlock=function(a,s,f,u,l){var h=a.x+f,c=a.y+u,p=a.z+l,d=nt(h,c,p),m=a._objectBlocks[d]||0;if(m!==s){if(m>0){var _=o(m);_.removeInstance(a,d)}if(s>0){var y=r.registry._blockHandlerLookup[s],g=y&&y.onCustomMeshCreate;g&&(i.position.copyFromFloats(.5,0,.5),i.scaling.setAll(1),i.rotation.setAll(0),g(i,h,c,p));var T=o(s),A=g?i:null;T.addInstance(a,d,f,u,l,A,e)}m>0&&!s&&delete a._objectBlocks[d],s>0&&(a._objectBlocks[d]=s)}},this.buildObjectMeshes=function(){Da("start");for(var a in n){var s=n[a];s.updateMatrix(),s.count===0&&s.dispose(),s.disposed&&delete n[a]}Da("rebuilt"),Da("end")},this.disposeChunk=function(a){for(var s in a._objectBlocks){var f=a._objectBlocks[s];if(f>0){var u=o(f);u.removeInstance(a,s)}}a._objectBlocks=null,t=!0},this.tick=function(){t&&(this.buildObjectMeshes(),t=!1)},this._rebaseOrigin=function(a){e[0]+=a[0],e[1]+=a[1],e[2]+=a[2];for(var s in n)n[s].rebased=!1;for(var f in n){var u=n[f];if(!u.rebased){for(var l=0;l<u.count;l++){var h=l<<4;u.buffer[h+12]-=a[0],u.buffer[h+13]-=a[1],u.buffer[h+14]-=a[2]}u.rebased=!0,u.dirty=!0}}t=!0}}function yi(r,e){this.mesh=e,this.buffer=null,this.capacity=0,this.count=0,this.dirty=!1,this.rebased=!0,this.disposed=!1,this.keyToIndex={},this.locToKey=[],this.mesh.position.setAll(0),this.mesh.parent=r._objectMesher.rootNode,this.mesh.isVisible=!0,r.rendering.addMeshToScene(this.mesh,!1),this.mesh.doNotSyncBoundingInfo=!0,this.mesh.alwaysSelectAsActiveMesh=!0}yi.prototype.dispose=function(){this.disposed||(this.mesh.thinInstanceCount=0,this.setCapacity(0),this.mesh.isVisible=!1,this.mesh=null,this.keyToIndex=null,this.locToKey=null,this.disposed=!0)};yi.prototype.addInstance=function(r,e,t,i,n,o,a){Uv(this);var s=this.count<<4;if(this.locToKey[this.count]=e,this.keyToIndex[e]=s,o){o.position.x+=r.x-a[0]+t,o.position.y+=r.y-a[1]+i,o.position.z+=r.z-a[2]+n,o.computeWorldMatrix(!0);var f=o._localMatrix._m;Oa(f,0,this.buffer,s)}else{var u=Vv;u[12]=r.x-a[0]+t+.5,u[13]=r.y-a[1]+i,u[14]=r.z-a[2]+n+.5,Oa(u,0,this.buffer,s)}this.count++,this.dirty=!0};yi.prototype.removeInstance=function(r,e){var t=this.keyToIndex[e];if(!(t>=0))throw"tried to remove object instance not in storage";delete this.keyToIndex[e];var i=t>>4,n=this.count-1;if(i!==n){var o=n<<4;Oa(this.buffer,o,this.buffer,t);var a=this.locToKey[n];this.keyToIndex[a]=t,this.locToKey[i]=a}this.count--,this.dirty=!0,kv(this)};yi.prototype.updateMatrix=function(){!this.dirty||(this.mesh.thinInstanceCount=this.count,this.mesh.thinInstanceBufferUpdated("matrix"),this.mesh.isVisible=this.count>0,this.dirty=!1)};yi.prototype.setCapacity=function(r=4){if(this.capacity=r,r===0)this.buffer=null;else{var e=new Float32Array(this.capacity*16);if(this.buffer)for(var t=Math.min(this.buffer.length,e.length),i=0;i<t;i++)e[i]=this.buffer[i];this.buffer=e}this.mesh.thinInstanceSetBuffer("matrix",this.buffer),this.mesh.thinInstanceCount=this.count,this.dirty=!1};function Uv(r){if(!(r.count<r.capacity)){var e=Math.max(8,r.capacity*2);r.setCapacity(e)}}function kv(r){r.count>r.capacity*.4||r.capacity<100||(r.setCapacity(Math.round(r.capacity/2)),r.locToKey.length=Math.min(r.locToKey.length,r.capacity))}var Vv=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Oa(r,e,t,i){for(var n=0;n<16;n++)t[i+n]=r[e+n]}var Da=ac?ar(ac,"Object meshing"):()=>{};v();var Ec=He(on());v();v();v();v();v();var Fa=function(){function r(e,t){this.width=e,this.height=t}return r.prototype.toString=function(){return"{W: ".concat(this.width,", H: ").concat(this.height,"}")},r.prototype.getClassName=function(){return"Size"},r.prototype.getHashCode=function(){var e=this.width|0;return e=e*397^(this.height|0),e},r.prototype.copyFrom=function(e){this.width=e.width,this.height=e.height},r.prototype.copyFromFloats=function(e,t){return this.width=e,this.height=t,this},r.prototype.set=function(e,t){return this.copyFromFloats(e,t)},r.prototype.multiplyByFloats=function(e,t){return new r(this.width*e,this.height*t)},r.prototype.clone=function(){return new r(this.width,this.height)},r.prototype.equals=function(e){return e?this.width===e.width&&this.height===e.height:!1},Object.defineProperty(r.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!1,configurable:!0}),r.Zero=function(){return new r(0,0)},r.prototype.add=function(e){var t=new r(this.width+e.width,this.height+e.height);return t},r.prototype.subtract=function(e){var t=new r(this.width-e.width,this.height-e.height);return t},r.Lerp=function(e,t,i){var n=e.width+(t.width-e.width)*i,o=e.height+(t.height-e.height)*i;return new r(n,o)},r}();var fc=function(){function r(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Fa.Zero(),this._cachedBaseSize=Fa.Zero(),this._initialSamplingMode=2,this._texture=e,this._texture&&(this._engine=this._texture.getEngine())}return Object.defineProperty(r.prototype,"wrapU",{get:function(){return this._wrapU},set:function(e){this._wrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapV",{get:function(){return this._wrapV},set:function(e){this._wrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"coordinatesMode",{get:function(){return 0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:!1},set:function(e){!this._texture||(this._texture.isCube=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(e){!this._texture||(this._texture.is3D=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(e){!this._texture||(this._texture.is2DArray=e)},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ThinTexture"},r.prototype.isReady=function(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1},r.prototype.delayLoad=function(){},r.prototype.getInternalTexture=function(){return this._texture},r.prototype.getSize=function(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize},r.prototype.getBaseSize=function(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)},Object.defineProperty(r.prototype,"samplingMode",{get:function(){return this._texture?this._texture.samplingMode:this._initialSamplingMode},enumerable:!1,configurable:!0}),r.prototype.updateSamplingMode=function(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)},r.prototype.releaseInternalTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null)},r.prototype.dispose=function(){this._texture&&(this.releaseInternalTexture(),this._engine=null)},r}();var uc=function(r){Y(e,r);function e(t,i){i===void 0&&(i=null);var n=r.call(this,null)||this;return n.metadata=null,n.reservedDataStore=null,n._hasAlpha=!1,n._getAlphaFromRGB=!1,n.level=1,n._coordinatesIndex=0,n._coordinatesMode=0,n.wrapR=1,n.anisotropicFilteringLevel=e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,n._isCube=!1,n._gammaSpace=!0,n.invertZ=!1,n.lodLevelInAlpha=!1,n.isRenderTarget=!1,n._prefiltered=!1,n._forceSerialize=!1,n.animations=new Array,n.onDisposeObservable=new U,n._onDisposeObserver=null,n._scene=null,n._uid=null,n._parentContainer=null,n._loadingError=!1,t?e._IsScene(t)?n._scene=t:n._engine=t:n._scene=le.LastCreatedScene,n._scene&&(n.uniqueId=n._scene.getUniqueId(),n._scene.addTexture(n),n._engine=n._scene.getEngine()),n._texture=i,n._uid=null,n}return Object.defineProperty(e.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(t){var i=this;this._hasAlpha!==t&&(this._hasAlpha=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(i)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"getAlphaFromRGB",{get:function(){return this._getAlphaFromRGB},set:function(t){var i=this;this._getAlphaFromRGB!==t&&(this._getAlphaFromRGB=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(i)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"coordinatesIndex",{get:function(){return this._coordinatesIndex},set:function(t){var i=this;this._coordinatesIndex!==t&&(this._coordinatesIndex=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(i)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(t){var i=this;this._coordinatesMode!==t&&(this._coordinatesMode=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(i)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapU",{get:function(){return this._wrapU},set:function(t){this._wrapU=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapV",{get:function(){return this._wrapV},set:function(t){this._wrapV=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:this._isCube},set:function(t){this._texture?this._texture.isCube=t:this._isCube=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(t){!this._texture||(this._texture.is3D=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(t){!this._texture||(this._texture.is2DArray=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gammaSpace",{get:function(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer},set:function(t){if(this._texture){if(this._texture._gammaSpace===t)return;this._texture._gammaSpace=t}else{if(this._gammaSpace===t)return;this._gammaSpace=t}this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRGBD",{get:function(){return this._texture!=null&&this._texture._isRGBD},set:function(t){this._texture&&(this._texture._isRGBD=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"noMipmap",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lodGenerationOffset",{get:function(){return this._texture?this._texture._lodGenerationOffset:0},set:function(t){this._texture&&(this._texture._lodGenerationOffset=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lodGenerationScale",{get:function(){return this._texture?this._texture._lodGenerationScale:0},set:function(t){this._texture&&(this._texture._lodGenerationScale=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"linearSpecularLOD",{get:function(){return this._texture?this._texture._linearSpecularLOD:!1},set:function(t){this._texture&&(this._texture._linearSpecularLOD=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"irradianceTexture",{get:function(){return this._texture?this._texture._irradianceTexture:null},set:function(t){this._texture&&(this._texture._irradianceTexture=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid||(this._uid=Wn()),this._uid},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return this.name},e.prototype.getClassName=function(){return"BaseTexture"},Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBlocking",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingError",{get:function(){return this._loadingError},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype._getEngine=function(){return this._engine},e.prototype.checkTransformsAreIdentical=function(t){return t!==null},e.prototype.getTextureMatrix=function(){return B.IdentityReadOnly},e.prototype.getReflectionTextureMatrix=function(){return B.IdentityReadOnly},e.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()||this.loadingError},e.prototype.scale=function(t){},Object.defineProperty(e.prototype,"canRescale",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype._getFromCache=function(t,i,n,o,a,s){var f=this._getEngine();if(!f)return null;for(var u=f._getUseSRGBBuffer(!!a,i),l=f.getLoadedTexturesCache(),h=0;h<l.length;h++){var c=l[h];if((a===void 0||u===c._useSRGBBuffer)&&(o===void 0||o===c.invertY)&&c.url===t&&c.generateMipMaps===!i&&(!n||n===c.samplingMode)&&(s===void 0||s===c.isCube))return c.incrementReferences(),c}return null},e.prototype._rebuild=function(){},e.prototype.clone=function(){return null},Object.defineProperty(e.prototype,"textureType",{get:function(){return this._texture&&this._texture.type!==void 0?this._texture.type:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureFormat",{get:function(){return this._texture&&this._texture.format!==void 0?this._texture.format:5},enumerable:!1,configurable:!0}),e.prototype._markAllSubMeshesAsTexturesDirty=function(){var t=this.getScene();!t||t.markAllMaterialsAsDirty(1)},e.prototype.readPixels=function(t,i,n,o,a,s,f,u,l){if(t===void 0&&(t=0),i===void 0&&(i=0),n===void 0&&(n=null),o===void 0&&(o=!0),a===void 0&&(a=!1),s===void 0&&(s=0),f===void 0&&(f=0),u===void 0&&(u=Number.MAX_VALUE),l===void 0&&(l=Number.MAX_VALUE),!this._texture)return null;var h=this._getEngine();if(!h)return null;var c=this.getSize(),p=c.width,d=c.height;i!==0&&(p=p/Math.pow(2,i),d=d/Math.pow(2,i),p=Math.round(p),d=Math.round(d)),u=Math.min(p,u),l=Math.min(d,l);try{return this._texture.isCube?h._readTexturePixels(this._texture,u,l,t,i,n,o,a,s,f):h._readTexturePixels(this._texture,u,l,-1,i,n,o,a,s,f)}catch(m){return null}},e.prototype._readPixelsSync=function(t,i,n,o,a){if(t===void 0&&(t=0),i===void 0&&(i=0),n===void 0&&(n=null),o===void 0&&(o=!0),a===void 0&&(a=!1),!this._texture)return null;var s=this.getSize(),f=s.width,u=s.height,l=this._getEngine();if(!l)return null;i!=0&&(f=f/Math.pow(2,i),u=u/Math.pow(2,i),f=Math.round(f),u=Math.round(u));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,f,u,t,i,n,o,a):l._readTexturePixelsSync(this._texture,f,u,-1,i,n,o,a)}catch(h){return null}},Object.defineProperty(e.prototype,"_lodTextureHigh",{get:function(){return this._texture?this._texture._lodTextureHigh:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_lodTextureMid",{get:function(){return this._texture?this._texture._lodTextureMid:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_lodTextureLow",{get:function(){return this._texture?this._texture._lodTextureLow:null},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);var t=this._scene.textures.indexOf(this);if(t>=0&&this._scene.textures.splice(t,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){var i=this._parentContainer.textures.indexOf(this);i>-1&&this._parentContainer.textures.splice(i,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,r.prototype.dispose.call(this)},e.prototype.serialize=function(){if(!this.name)return null;var t=te.Serialize(this);return te.AppendSerializedAnimations(this,t),t},e.WhenAllReady=function(t,i){var n=t.length;if(n===0){i();return}for(var o=0;o<t.length;o++){var a=t[o];if(a.isReady())--n===0&&i();else{var s=a.onLoadObservable;s?s.addOnce(function(){--n===0&&i()}):--n===0&&i()}}},e._IsScene=function(t){return t.getClassName()==="Scene"},e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,x([O()],e.prototype,"uniqueId",void 0),x([O()],e.prototype,"name",void 0),x([O()],e.prototype,"metadata",void 0),x([O("hasAlpha")],e.prototype,"_hasAlpha",void 0),x([O("getAlphaFromRGB")],e.prototype,"_getAlphaFromRGB",void 0),x([O()],e.prototype,"level",void 0),x([O("coordinatesIndex")],e.prototype,"_coordinatesIndex",void 0),x([O("coordinatesMode")],e.prototype,"_coordinatesMode",void 0),x([O()],e.prototype,"wrapU",null),x([O()],e.prototype,"wrapV",null),x([O()],e.prototype,"wrapR",void 0),x([O()],e.prototype,"anisotropicFilteringLevel",void 0),x([O()],e.prototype,"isCube",null),x([O()],e.prototype,"is3D",null),x([O()],e.prototype,"is2DArray",null),x([O()],e.prototype,"gammaSpace",null),x([O()],e.prototype,"invertZ",void 0),x([O()],e.prototype,"lodLevelInAlpha",void 0),x([O()],e.prototype,"lodGenerationOffset",null),x([O()],e.prototype,"lodGenerationScale",null),x([O()],e.prototype,"linearSpecularLOD",null),x([at()],e.prototype,"irradianceTexture",null),x([O()],e.prototype,"isRenderTarget",void 0),e}(fc);v();function lc(r,e,t){t===void 0&&(t=!1);var i=e.width,n=e.height;if(r instanceof Float32Array){for(var o=r.byteLength/r.BYTES_PER_ELEMENT,a=new Uint8Array(o);--o>=0;){var s=r[o];s<0?s=0:s>1&&(s=1),a[o]=s*255}r=a}var f=document.createElement("canvas");f.width=i,f.height=n;var u=f.getContext("2d");if(!u)return null;var l=u.createImageData(i,n),h=l.data;if(h.set(r),u.putImageData(l,0,0),t){var c=document.createElement("canvas");c.width=i,c.height=n;var p=c.getContext("2d");return p?(p.translate(0,n),p.scale(1,-1),p.drawImage(f,0,0),c.toDataURL("image/png")):null}return f.toDataURL("image/png")}function hc(r,e,t){e===void 0&&(e=0),t===void 0&&(t=0);var i=r.getInternalTexture();if(!i)return null;var n=r._readPixelsSync(e,t);return n?lc(n,r.getSize(),i.invertY):null}function cc(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=0),ii(this,void 0,void 0,function(){var i,n;return Lt(this,function(o){switch(o.label){case 0:return i=r.getInternalTexture(),i?[4,r.readPixels(e,t)]:[2,null];case 1:return n=o.sent(),n?[2,lc(n,r.getSize(),i.invertY)]:[2,null]}})})}var Ie=function(r){Y(e,r);function e(t,i,n,o,a,s,f,u,l,h,c,p,d,m){a===void 0&&(a=e.TRILINEAR_SAMPLINGMODE),s===void 0&&(s=null),f===void 0&&(f=null),u===void 0&&(u=null),l===void 0&&(l=!1);var _=this,y,g,T,A,M,C,P,R,F;_=r.call(this,i)||this,_.url=null,_.uOffset=0,_.vOffset=0,_.uScale=1,_.vScale=1,_.uAng=0,_.vAng=0,_.wAng=0,_.uRotationCenter=.5,_.vRotationCenter=.5,_.wRotationCenter=.5,_.homogeneousRotationInUVTransform=!1,_.inspectableCustomProperties=null,_._noMipmap=!1,_._invertY=!1,_._rowGenerationMatrix=null,_._cachedTextureMatrix=null,_._projectionModeMatrix=null,_._t0=null,_._t1=null,_._t2=null,_._cachedUOffset=-1,_._cachedVOffset=-1,_._cachedUScale=0,_._cachedVScale=0,_._cachedUAng=-1,_._cachedVAng=-1,_._cachedWAng=-1,_._cachedProjectionMatrixId=-1,_._cachedURotationCenter=-1,_._cachedVRotationCenter=-1,_._cachedWRotationCenter=-1,_._cachedHomogeneousRotationInUVTransform=!1,_._cachedCoordinatesMode=-1,_._buffer=null,_._deleteBuffer=!1,_._format=null,_._delayedOnLoad=null,_._delayedOnError=null,_.onLoadObservable=new U,_._isBlocking=!0,_.name=t||"",_.url=t;var I,D=!1,V=null;typeof n=="object"&&n!==null?(I=(y=n.noMipmap)!==null&&y!==void 0?y:!1,o=(g=n.invertY)!==null&&g!==void 0?g:!Oe.UseOpenGLOrientationForUV,a=(T=n.samplingMode)!==null&&T!==void 0?T:e.TRILINEAR_SAMPLINGMODE,s=(A=n.onLoad)!==null&&A!==void 0?A:null,f=(M=n.onError)!==null&&M!==void 0?M:null,u=(C=n.buffer)!==null&&C!==void 0?C:null,l=(P=n.deleteBuffer)!==null&&P!==void 0?P:!1,h=n.format,c=n.mimeType,p=n.loaderOptions,d=n.creationFlags,D=(R=n.useSRGBBuffer)!==null&&R!==void 0?R:!1,V=(F=n.internalTexture)!==null&&F!==void 0?F:null):I=!!n,_._noMipmap=I,_._invertY=o===void 0?!Oe.UseOpenGLOrientationForUV:o,_._initialSamplingMode=a,_._buffer=u,_._deleteBuffer=l,_._mimeType=c,_._loaderOptions=p,_._creationFlags=d,_._useSRGBBuffer=D,_._forcedExtension=m,h&&(_._format=h);var k=_.getScene(),w=_._getEngine();if(!w)return _;w.onBeforeTextureInitObservable.notifyObservers(_);var G=function(){_._texture&&(_._texture._invertVScale&&(_.vScale*=-1,_.vOffset+=1),_._texture._cachedWrapU!==null&&(_.wrapU=_._texture._cachedWrapU,_._texture._cachedWrapU=null),_._texture._cachedWrapV!==null&&(_.wrapV=_._texture._cachedWrapV,_._texture._cachedWrapV=null),_._texture._cachedWrapR!==null&&(_.wrapR=_._texture._cachedWrapR,_._texture._cachedWrapR=null)),_.onLoadObservable.hasObservers()&&_.onLoadObservable.notifyObservers(_),s&&s(),!_.isBlocking&&k&&k.resetCachedMaterial()},K=function(W,z){_._loadingError=!0,_._errorObject={message:W,exception:z},f&&f(W,z),e.OnTextureLoadErrorObservable.notifyObservers(_)};if(!_.url)return _._delayedOnLoad=G,_._delayedOnError=K,_;if(_._texture=V!=null?V:_._getFromCache(_.url,I,a,_._invertY,D),_._texture)if(_._texture.isReady)Ir.SetImmediate(function(){return G()});else{var j=_._texture.onLoadedObservable.add(G);_._texture.onErrorObservable.add(function(W){var z;K(W.message,W.exception),(z=_._texture)===null||z===void 0||z.onLoadedObservable.remove(j)})}else if(!k||!k.useDelayedTextureLoading){try{_._texture=w.createTexture(_.url,I,_._invertY,k,a,G,K,_._buffer,void 0,_._format,_._forcedExtension,c,p,d,D)}catch(W){throw K("error loading",W),W}l&&(_._buffer=null)}else _.delayLoadState=4,_._delayedOnLoad=G,_._delayedOnError=K;return _}return Object.defineProperty(e.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mimeType",{get:function(){return this._mimeType},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(t){this._isBlocking=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"invertY",{get:function(){return this._invertY},enumerable:!1,configurable:!0}),e.prototype.updateURL=function(t,i,n,o){i===void 0&&(i=null),this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=t),this.url=t,this._buffer=i,this._forcedExtension=o,this.delayLoadState=4,n&&(this._delayedOnLoad=n),this.delayLoad()},e.prototype.delayLoad=function(){if(this.delayLoadState===4){var t=this.getScene();!t||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?Ir.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=t.getEngine().createTexture(this.url,this._noMipmap,this._invertY,t,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}},e.prototype._prepareRowForTextureGeneration=function(t,i,n,o){t*=this._cachedUScale,i*=this._cachedVScale,t-=this.uRotationCenter*this._cachedUScale,i-=this.vRotationCenter*this._cachedVScale,n-=this.wRotationCenter,E.TransformCoordinatesFromFloatsToRef(t,i,n,this._rowGenerationMatrix,o),o.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,o.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,o.z+=this.wRotationCenter},e.prototype.checkTransformsAreIdentical=function(t){return t!==null&&this.uOffset===t.uOffset&&this.vOffset===t.vOffset&&this.uScale===t.uScale&&this.vScale===t.vScale&&this.uAng===t.uAng&&this.vAng===t.vAng&&this.wAng===t.wAng},e.prototype.getTextureMatrix=function(t){var i=this;if(t===void 0&&(t=1),this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*t===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*t,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=B.Zero(),this._rowGenerationMatrix=new B,this._t0=E.Zero(),this._t1=E.Zero(),this._t2=E.Zero()),B.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(B.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,L.Matrix[0]),B.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,L.Matrix[1]),B.ScalingToRef(this._cachedUScale,this._cachedVScale,0,L.Matrix[2]),B.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,L.Matrix[3]),L.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(L.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),B.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));var n=this.getScene();return n?(n.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(i)}),this._cachedTextureMatrix):this._cachedTextureMatrix},e.prototype.getReflectionTextureMatrix=function(){var t=this,i=this.getScene();if(!i)return this._cachedTextureMatrix;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)if(this.coordinatesMode===e.PROJECTION_MODE){if(this._cachedProjectionMatrixId===i.getProjectionMatrix().updateFlag)return this._cachedTextureMatrix}else return this._cachedTextureMatrix;this._cachedTextureMatrix||(this._cachedTextureMatrix=B.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=B.Zero());var n=this._cachedCoordinatesMode!==this.coordinatesMode;switch(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case e.PLANAR_MODE:{B.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break}case e.PROJECTION_MODE:{B.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);var o=i.getProjectionMatrix();this._cachedProjectionMatrixId=o.updateFlag,o.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break}default:B.IdentityToRef(this._cachedTextureMatrix);break}return n&&i.markAllMaterialsAsDirty(1,function(a){return a.getActiveTextures().indexOf(t)!==-1}),this._cachedTextureMatrix},e.prototype.clone=function(){var t=this,i={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return te.Clone(function(){return new e(t._texture?t._texture.url:null,t.getScene(),i)},this)},e.prototype.serialize=function(){var t=this.name;e.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");var i=r.prototype.serialize.call(this);return i?((e.SerializeBuffers||e.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(i.base64String=this._buffer,i.name=i.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?i.base64String="data:image/png;base64,"+On(this._buffer):(e.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(i.base64String=!this._engine||this._engine._features.supportSyncTextureRead?hc(this):cc(this))),i.invertY=this._invertY,i.samplingMode=this.samplingMode,i._creationFlags=this._creationFlags,i._useSRGBBuffer=this._useSRGBBuffer,this.name=t,i):null},e.prototype.getClassName=function(){return"Texture"},e.prototype.dispose=function(){r.prototype.dispose.call(this),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null},e.Parse=function(t,i,n){if(t.customType){var o=hi.Instantiate(t.customType),a=o.Parse(t,i,n);return t.samplingMode&&a.updateSamplingMode&&a._samplingMode&&a._samplingMode!==t.samplingMode&&a.updateSamplingMode(t.samplingMode),a}if(t.isCube&&!t.isRenderTarget)return e._CubeTextureParser(t,i,n);if(!t.name&&!t.isRenderTarget)return null;var s=function(u){if(u&&u._texture&&(u._texture._cachedWrapU=null,u._texture._cachedWrapV=null,u._texture._cachedWrapR=null),t.samplingMode){var l=t.samplingMode;u&&u.samplingMode!==l&&u.updateSamplingMode(l)}if(u&&t.animations)for(var h=0;h<t.animations.length;h++){var c=t.animations[h],p=wt("BABYLON.Animation");p&&u.animations.push(p.Parse(c))}},f=te.Parse(function(){var u,l,h,c=!0;if(t.noMipmap&&(c=!1),t.mirrorPlane){var p=e._CreateMirror(t.name,t.renderTargetSize,i,c);return p._waitingRenderList=t.renderList,p.mirrorPlane=pi.FromArray(t.mirrorPlane),s(p),p}else if(t.isRenderTarget){var d=null;if(t.isCube){if(i.reflectionProbes)for(var m=0;m<i.reflectionProbes.length;m++){var _=i.reflectionProbes[m];if(_.name===t.name)return _.cubeTexture}}else d=e._CreateRenderTargetTexture(t.name,t.renderTargetSize,i,c,(u=t._creationFlags)!==null&&u!==void 0?u:0),d._waitingRenderList=t.renderList;return s(d),d}else{var y;if(t.base64String)y=e.CreateFromBase64String(t.base64String,t.name,i,!c,t.invertY,t.samplingMode,function(){s(y)},(l=t._creationFlags)!==null&&l!==void 0?l:0,(h=t._useSRGBBuffer)!==null&&h!==void 0?h:!1);else{var g=void 0;t.name&&t.name.indexOf("://")>0?g=t.name:g=n+t.name,t.url&&(t.url.startsWith("data:")||e.UseSerializedUrlIfAny)&&(g=t.url),y=new e(g,i,!c,t.invertY,t.samplingMode,function(){s(y)})}return y}},t,i);return f},e.CreateFromBase64String=function(t,i,n,o,a,s,f,u,l,h){return s===void 0&&(s=e.TRILINEAR_SAMPLINGMODE),f===void 0&&(f=null),u===void 0&&(u=null),l===void 0&&(l=5),new e("data:"+i,n,o,a,s,f,u,t,!1,l,void 0,void 0,h)},e.LoadFromDataString=function(t,i,n,o,a,s,f,u,l,h,c){return o===void 0&&(o=!1),s===void 0&&(s=!0),f===void 0&&(f=e.TRILINEAR_SAMPLINGMODE),u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=5),t.substr(0,5)!=="data:"&&(t="data:"+t),new e(t,n,a,s,f,u,l,i,o,h,void 0,void 0,c)},e.SerializeBuffers=!0,e.ForceSerializeBuffers=!1,e.OnTextureLoadErrorObservable=new U,e._CubeTextureParser=function(t,i,n){throw Q("CubeTexture")},e._CreateMirror=function(t,i,n,o){throw Q("MirrorTexture")},e._CreateRenderTargetTexture=function(t,i,n,o,a){throw Q("RenderTargetTexture")},e.NEAREST_SAMPLINGMODE=1,e.NEAREST_NEAREST_MIPLINEAR=8,e.BILINEAR_SAMPLINGMODE=2,e.LINEAR_LINEAR_MIPNEAREST=11,e.TRILINEAR_SAMPLINGMODE=3,e.LINEAR_LINEAR_MIPLINEAR=3,e.NEAREST_NEAREST_MIPNEAREST=4,e.NEAREST_LINEAR_MIPNEAREST=5,e.NEAREST_LINEAR_MIPLINEAR=6,e.NEAREST_LINEAR=7,e.NEAREST_NEAREST=1,e.LINEAR_NEAREST_MIPNEAREST=9,e.LINEAR_NEAREST_MIPLINEAR=10,e.LINEAR_LINEAR=2,e.LINEAR_NEAREST=12,e.EXPLICIT_MODE=0,e.SPHERICAL_MODE=1,e.PLANAR_MODE=2,e.CUBIC_MODE=3,e.PROJECTION_MODE=4,e.SKYBOX_MODE=5,e.INVCUBIC_MODE=6,e.EQUIRECTANGULAR_MODE=7,e.FIXED_EQUIRECTANGULAR_MODE=8,e.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.CLAMP_ADDRESSMODE=0,e.WRAP_ADDRESSMODE=1,e.MIRROR_ADDRESSMODE=2,e.UseSerializedUrlIfAny=!1,x([O()],e.prototype,"url",void 0),x([O()],e.prototype,"uOffset",void 0),x([O()],e.prototype,"vOffset",void 0),x([O()],e.prototype,"uScale",void 0),x([O()],e.prototype,"vScale",void 0),x([O()],e.prototype,"uAng",void 0),x([O()],e.prototype,"vAng",void 0),x([O()],e.prototype,"wAng",void 0),x([O()],e.prototype,"uRotationCenter",void 0),x([O()],e.prototype,"vRotationCenter",void 0),x([O()],e.prototype,"wRotationCenter",void 0),x([O()],e.prototype,"homogeneousRotationInUVTransform",void 0),x([O()],e.prototype,"isBlocking",null),e}(uc);Ke("BABYLON.Texture",Ie);te._TextureParser=Ie.Parse;v();v();var dc=function(){function r(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}return r.prototype._addPlugin=function(e){for(var t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)throw'Plugin "'.concat(e.name,'" already added to the material "').concat(this._material.name,'"!');if(this._material._uniformBufferLayoutBuilt)throw'The plugin "'.concat(e.name,`" can't be added to the material "`).concat(this._material.name,'" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.');var i=e.getClassName();r._MaterialPluginClassToMainDefine[i]||(r._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++r._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort(function(f,u){return f.priority-u.priority}),this._codeInjectionPoints={};var n={};n[r._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(var o=0,a=this._plugins;o<a.length;o++){var s=a[o];s.collectDefines(n),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"))}this._defineNamesFromPlugins=n},r.prototype._activatePlugin=function(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort(function(t,i){return t.priority-i.priority}),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(function(t,i){return t.priority-i.priority}),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))},r.prototype.getPlugin=function(e){for(var t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null},r.prototype._handlePluginEventIsReadyForSubMesh=function(e){for(var t=!0,i=0,n=this._activePlugins;i<n.length;i++){var o=n[i];t=t&&o.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh)}e.isReadyForSubMesh=t},r.prototype._handlePluginEventPrepareDefinesBeforeAttributes=function(e){for(var t=0,i=this._activePlugins;t<i.length;t++){var n=i[t];n.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}},r.prototype._handlePluginEventPrepareDefines=function(e){for(var t=0,i=this._activePlugins;t<i.length;t++){var n=i[t];n.prepareDefines(e.defines,this._scene,e.mesh)}},r.prototype._handlePluginEventHardBindForSubMesh=function(e){for(var t=0,i=this._activePluginsForExtraEvents;t<i.length;t++){var n=i[t];n.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}},r.prototype._handlePluginEventBindForSubMesh=function(e){for(var t=0,i=this._activePlugins;t<i.length;t++){var n=i[t];n.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}},r.prototype._handlePluginEventHasRenderTargetTextures=function(e){for(var t=!1,i=0,n=this._activePluginsForExtraEvents;i<n.length;i++){var o=n[i];if(t=o.hasRenderTargetTextures(),t)break}e.hasRenderTargetTextures=t},r.prototype._handlePluginEventFillRenderTargetTextures=function(e){for(var t=0,i=this._activePluginsForExtraEvents;t<i.length;t++){var n=i[t];n.fillRenderTargetTextures(e.renderTargets)}},r.prototype._handlePluginEvent=function(e,t){var i,n,o;switch(e){case qe.GetActiveTextures:{for(var a=t,s=0,f=this._activePlugins;s<f.length;s++){var u=f[s];u.getActiveTextures(a.activeTextures)}break}case qe.GetAnimatables:{for(var a=t,l=0,h=this._activePlugins;l<h.length;l++){var u=h[l];u.getAnimatables(a.animatables)}break}case qe.HasTexture:{for(var a=t,c=!1,p=0,d=this._activePlugins;p<d.length;p++){var u=d[p];if(c=u.hasTexture(a.texture),c)break}a.hasTexture=c;break}case qe.Disposed:{for(var a=t,m=0,_=this._plugins;m<_.length;m++){var u=_[m];u.dispose(a.forceDisposeTextures)}break}case qe.GetDefineNames:{var a=t;a.defineNames=this._defineNamesFromPlugins;break}case qe.PrepareEffect:{for(var a=t,y=0,g=this._activePlugins;y<g.length;y++){var u=g[y];a.fallbackRank=u.addFallbacks(a.defines,a.fallbacks,a.fallbackRank),u.getAttributes(a.attributes,this._scene,a.mesh)}this._uniformList.length>0&&(i=a.uniforms).push.apply(i,this._uniformList),this._samplerList.length>0&&(n=a.samplers).push.apply(n,this._samplerList),this._uboList.length>0&&(o=a.uniformBuffersNames).push.apply(o,this._uboList),a.customCode=this._injectCustomCode(a.customCode);break}case qe.PrepareUniformBuffer:{var a=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(var T=0,A=this._plugins;T<A.length;T++){var u=A[T],M=u.getUniforms();if(M){if(M.ubo)for(var C=0,P=M.ubo;C<P.length;C++){var R=P[C];a.ubo.addUniform(R.name,R.size),this._uboDeclaration+="".concat(R.type," ").concat(R.name,`;\r
`),this._uniformList.push(R.name)}M.vertex&&(this._vertexDeclaration+=M.vertex+`\r
`),M.fragment&&(this._fragmentDeclaration+=M.fragment+`\r
`)}u.getSamplers(this._samplerList),u.getUniformBuffersNames(this._uboList)}break}}},r.prototype._collectPointNames=function(e,t){if(!!t)for(var i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0},r.prototype._injectCustomCode=function(e){var t=this;return function(i,n){var o;e&&(n=e(i,n)),t._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",t._uboDeclaration)),t._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",t._vertexDeclaration)),t._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",t._fragmentDeclaration));var a=(o=t._codeInjectionPoints)===null||o===void 0?void 0:o[i];if(!a)return n;for(var s in a){for(var f="",u=0,l=t._activePlugins;u<l.length;u++){var h=l[u],c=h.getCustomCode(i);c!=null&&c[s]&&(f+=c[s]+`\r
`)}if(f.length>0)if(s.charAt(0)==="!")for(var p=new RegExp(s.substring(1),"g"),d=p.exec(n);d!==null;){for(var m=f,_=0;_<d.length;++_)m=m.replace("$"+_,d[_]);n=n.replace(d[0],m),d=p.exec(n)}else{var y="#define "+s;n=n.replace(y,`\r
`+f+`\r
`+y)}}return n}},r._MaterialPluginClassToMainDefine={},r._MaterialPluginCounter=0,r}();var Zn=function(){function r(e,t,i,n,o,a){o===void 0&&(o=!0),a===void 0&&(a=!1),this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new dc(e)),this._pluginDefineNames=n,this._pluginManager=e.pluginManager,o&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}return r.prototype._enable=function(e){e&&this._pluginManager._activatePlugin(this)},r.prototype.getClassName=function(){return"MaterialPluginBase"},r.prototype.isReadyForSubMesh=function(e,t,i,n){return!0},r.prototype.hardBindForSubMesh=function(e,t,i,n){},r.prototype.bindForSubMesh=function(e,t,i,n){},r.prototype.dispose=function(e){},r.prototype.getCustomCode=function(e){return null},r.prototype.collectDefines=function(e){if(!!this._pluginDefineNames)for(var t=0,i=Object.keys(this._pluginDefineNames);t<i.length;t++){var n=i[t];if(n[0]!=="_"){var o=typeof this._pluginDefineNames[n];e[n]={type:o==="number"?"number":o==="string"?"string":o==="boolean"?"boolean":"object",default:this._pluginDefineNames[n]}}}},r.prototype.prepareDefinesBeforeAttributes=function(e,t,i){},r.prototype.prepareDefines=function(e,t,i){},r.prototype.hasTexture=function(e){return!1},r.prototype.hasRenderTargetTextures=function(){return!1},r.prototype.fillRenderTargetTextures=function(e){},r.prototype.getActiveTextures=function(e){},r.prototype.getAnimatables=function(e){},r.prototype.addFallbacks=function(e,t,i){return i},r.prototype.getSamplers=function(e){},r.prototype.getAttributes=function(e,t,i){},r.prototype.getUniformBuffersNames=function(e){},r.prototype.getUniforms=function(){return{}},r.prototype.copyTo=function(e){te.Clone(function(){return e},this)},r.prototype.serialize=function(){return te.Serialize(this)},r.prototype.parse=function(e,t,i){var n=this;te.Parse(function(){return n},e,t,i)},x([O()],r.prototype,"name",void 0),x([O()],r.prototype,"priority",void 0),x([O()],r.prototype,"registerForExtraEvents",void 0),r}();v();v();me.prototype.updateRawTexture=function(r,e,t,i,n,o,a){if(n===void 0&&(n=null),o===void 0&&(o=0),a===void 0&&(a=!1),!!r){var s=this._getRGBABufferInternalSizedFormat(o,t,a),f=this._getInternalFormat(t),u=this._getWebGLTextureType(o);this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.type=o,r.invertY=i,r._compression=n),r.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],r.width,r.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r.width,r.height,0,f,u,e),r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0}};me.prototype.createRawTexture=function(r,e,t,i,n,o,a,s,f,u,l){s===void 0&&(s=null),f===void 0&&(f=0),u===void 0&&(u=0),l===void 0&&(l=!1);var h=new zt(this,Le.Raw);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=n,h.samplingMode=a,h.invertY=o,h._compression=s,h.type=f,h._useSRGBBuffer=this._getUseSRGBBuffer(l,!n),this._doNotHandleContextLost||(h._bufferView=r),this.updateRawTexture(h,r,i,o,s,f,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);var c=this._getSamplingParameters(a,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,c.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,c.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h};me.prototype.createRawCubeTexture=function(r,e,t,i,n,o,a,s){s===void 0&&(s=null);var f=this._gl,u=new zt(this,Le.CubeRaw);u.isCube=!0,u.format=t,u.type=i,this._doNotHandleContextLost||(u._bufferViewArray=r);var l=this._getWebGLTextureType(i),h=this._getInternalFormat(t);h===f.RGB&&(h=f.RGBA),l===f.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,a=1,q.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):l===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,a=1,q.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):l===f.FLOAT&&!this._caps.textureFloatRender?(n=!1,q.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):l===f.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,q.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var c=e,p=c;u.width=c,u.height=p;var d=!this.needPOTTextures||he.IsExponentOfTwo(u.width)&&he.IsExponentOfTwo(u.height);d||(n=!1),r&&this.updateRawCubeTexture(u,r,t,i,o,s),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,u,!0),r&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var m=this._getSamplingParameters(a,n);return f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,m.mag),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,m.min),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null),u.generateMipMaps=n,u.samplingMode=a,u};me.prototype.updateRawCubeTexture=function(r,e,t,i,n,o,a){o===void 0&&(o=null),a===void 0&&(a=0),r._bufferViewArray=e,r.format=t,r.type=i,r.invertY=n,r._compression=o;var s=this._gl,f=this._getWebGLTextureType(i),u=this._getInternalFormat(t),l=this._getRGBABufferInternalSizedFormat(i),h=!1;u===s.RGB&&(u=s.RGBA,h=!0),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,r,!0),this._unpackFlipY(n===void 0?!0:!!n),r.width%4!==0&&s.pixelStorei(s.UNPACK_ALIGNMENT,1);for(var c=0;c<6;c++){var p=e[c];o?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,this.getCaps().s3tc[o],r.width,r.height,0,p):(h&&(p=pc(p,r.width,r.height,i)),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,l,r.width,r.height,0,u,f,p))}var d=!this.needPOTTextures||he.IsExponentOfTwo(r.width)&&he.IsExponentOfTwo(r.height);d&&r.generateMipMaps&&a===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),r.isReady=!0};me.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,n,o,a,s,f,u,l,h){var c=this;f===void 0&&(f=null),u===void 0&&(u=null),l===void 0&&(l=3),h===void 0&&(h=!1);var p=this._gl,d=this.createRawCubeTexture(null,t,i,n,!o,h,l,null);e==null||e.addPendingData(d),d.url=r,this._internalTexturesCache.push(d);var m=function(y,g){e==null||e.removePendingData(d),u&&y&&u(y.status+" "+y.statusText,g)},_=function(y){var g=d.width,T=a(y);if(!!T){if(s){var A=c._getWebGLTextureType(n),M=c._getInternalFormat(i),C=c._getRGBABufferInternalSizedFormat(n),P=!1;M===p.RGB&&(M=p.RGBA,P=!0),c._bindTextureDirectly(p.TEXTURE_CUBE_MAP,d,!0),c._unpackFlipY(!1);for(var R=s(T),F=0;F<R.length;F++)for(var I=g>>F,D=0;D<6;D++){var V=R[F][D];P&&(V=pc(V,I,I,n)),p.texImage2D(D,F,C,I,I,0,M,A,V)}c._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null)}else c.updateRawCubeTexture(d,T,i,n,h);d.isReady=!0,e==null||e.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),f&&f()}};return this._loadFile(r,function(y){_(y)},void 0,e==null?void 0:e.offlineProvider,!0,m),d};function pc(r,e,t,i){var n,o=1;i===1?n=new Float32Array(e*t*4):i===2?(n=new Uint16Array(e*t*4),o=15360):i===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(var a=0;a<e;a++)for(var s=0;s<t;s++){var f=(s*e+a)*3,u=(s*e+a)*4;n[u+0]=r[f+0],n[u+1]=r[f+1],n[u+2]=r[f+2],n[u+3]=o}return n}function _c(r){return function(e,t,i,n,o,a,s,f,u,l){u===void 0&&(u=null),l===void 0&&(l=0);var h=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,c=r?Le.Raw3D:Le.Raw2DArray,p=new zt(this,c);p.baseWidth=t,p.baseHeight=i,p.baseDepth=n,p.width=t,p.height=i,p.depth=n,p.format=o,p.type=l,p.generateMipMaps=a,p.samplingMode=f,r?p.is3D=!0:p.is2DArray=!0,this._doNotHandleContextLost||(p._bufferView=e),r?this.updateRawTexture3D(p,e,o,s,u,l):this.updateRawTexture2DArray(p,e,o,s,u,l),this._bindTextureDirectly(h,p,!0);var d=this._getSamplingParameters(f,a);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,d.min),a&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(p),p}}me.prototype.createRawTexture2DArray=_c(!1);me.prototype.createRawTexture3D=_c(!0);function vc(r){return function(e,t,i,n,o,a){o===void 0&&(o=null),a===void 0&&(a=0);var s=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=this._getWebGLTextureType(a),u=this._getInternalFormat(i),l=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(s,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=n,e._compression=o),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),o&&t?this._gl.compressedTexImage3D(s,0,this.getCaps().s3tc[o],e.width,e.height,e.depth,0,t):this._gl.texImage3D(s,0,l,e.width,e.height,e.depth,0,u,f,t),e.generateMipMaps&&this._gl.generateMipmap(s),this._bindTextureDirectly(s,null),e.isReady=!0}}me.prototype.updateRawTexture2DArray=vc(!1);me.prototype.updateRawTexture3D=vc(!0);var mc=function(r){Y(e,r);function e(t,i,n,o,a,s,f,u,l,h){f===void 0&&(f=!0),u===void 0&&(u=!1),l===void 0&&(l=Ie.TRILINEAR_SAMPLINGMODE),h===void 0&&(h=0);var c=r.call(this,null,s,!f,u)||this;return c.format=a,c._texture=s.getEngine().createRawTexture2DArray(t,i,n,o,a,f,u,l,null,h),c._depth=o,c.is2DArray=!0,c}return Object.defineProperty(e.prototype,"depth",{get:function(){return this._depth},enumerable:!1,configurable:!0}),e.prototype.update=function(t){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,t,this._texture.format,this._texture.invertY,null,this._texture.type)},e.CreateRGBATexture=function(t,i,n,o,a,s,f,u,l){return s===void 0&&(s=!0),f===void 0&&(f=!1),u===void 0&&(u=3),l===void 0&&(l=0),new e(t,i,n,o,5,a,s,f,u,l)},e}(Ie);var Qn=class{constructor(e){this._defaultMat=e.rendering.makeStandardMaterial("base-terrain"),this._defaultMat.freeze(),this.noa=e,this._idCounter=1e3,this._blockMatIDtoTerrainID={},this._terrainIDtoMatObject={},this._texURLtoTerrainID={},this._renderMatToTerrainID=new Map}getTerrainMatId(e){if(e in this._blockMatIDtoTerrainID)return this._blockMatIDtoTerrainID[e];var t=Wv(this,e);if(!(t in this._terrainIDtoMatObject)){var i=Gv(this,e);this._terrainIDtoMatObject[t]=i}return this._blockMatIDtoTerrainID[e]=t,t}getMaterial(e=1){return this._terrainIDtoMatObject[e]}};function Wv(r,e=0){var t=r.noa.registry.getMaterialData(e);if(t.renderMat){var i=t.renderMat;return r._renderMatToTerrainID.has(i)||r._renderMatToTerrainID.set(i,r._idCounter++),r._renderMatToTerrainID.get(i)}if(t.texture){var n=t.texture;return n in r._texURLtoTerrainID||(r._texURLtoTerrainID[n]=r._idCounter++),r._texURLtoTerrainID[n]}var o=t.alpha;return o>0&&o<1?10+Math.round(o*100):1}function Gv(r,e=0){var t=r.noa.registry.getMaterialData(e);if(t.renderMat)return t.renderMat;if(!t.texture){var i=t.alpha>0&&t.alpha<1;if(!i)return r._defaultMat;var n="terrain-alpha-"+e,o=r.noa.rendering.makeStandardMaterial(n);return o.alpha=t.alpha,o.freeze(),o}var a=r.noa.rendering.getScene(),s=r.noa.rendering.makeStandardMaterial("terrain-textured-"+e),f=t.texture,u=Ie.NEAREST_SAMPLINGMODE,l=new Ie(f,a,!0,!1,u);return t.texHasAlpha&&(l.hasAlpha=!0),s.diffuseTexture=l,t.atlasIndex>=0&&new wa(s,l),s.freeze(),s}var wa=class extends Zn{constructor(e,t){var i=200,n={NOA_TWOD_ARRAY_TEXTURE:!1};super(e,"TestPlugin",i,n),this._enable(!0),this._atlasTextureArray=null,t.onLoadObservable.add(o=>{this.setTextureArrayData(o)})}setTextureArrayData(e){var{width:t,height:i}=e.getSize(),n=Math.round(i/t);i=t;var o=e._readPixelsSync(),a=Re.TEXTUREFORMAT_RGBA,s=!0,f=!1,u=Ie.NEAREST_SAMPLINGMODE,l=e.getScene();this._atlasTextureArray=new mc(o,t,i,n,a,l,s,f,u)}prepareDefines(e,t,i){e.NOA_TWOD_ARRAY_TEXTURE=!0}getClassName(){return"TerrainMaterialPluginName"}getSamplers(e){e.push("atlasTexture")}getAttributes(e){e.push("texAtlasIndices")}getUniforms(){return{ubo:[]}}bindForSubMesh(e,t,i,n){this._atlasTextureArray&&e.setTexture("atlasTexture",this._atlasTextureArray)}getCustomCode(e){return e==="vertex"?{CUSTOM_VERTEX_MAIN_BEGIN:`
                texAtlasIndex = texAtlasIndices;
            `,CUSTOM_VERTEX_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                attribute float texAtlasIndices;
                varying float texAtlasIndex;
            `}:e==="fragment"?{"!baseColor\\=texture2D\\(diffuseSampler,vDiffuseUV\\+uvOffset\\);":"baseColor = texture(atlasTexture, vec3(vDiffuseUV, texAtlasIndex));",CUSTOM_FRAGMENT_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                varying float texAtlasIndex;
            `}:null}};Ut();var gc=0;function La(r){var e=new Qn(r);this._defaultMaterial=e._defaultMat;var t=new Xv(r,e),i=new Hv(r,e);this.initChunk=function(n){n._terrainMeshes.length=0},this.disposeChunk=function(n){n._terrainMeshes.forEach(o=>o.dispose()),n._terrainMeshes.length=0},this.meshChunk=function(n,o=!1){Zi("start"),n._terrainMeshes.forEach(f=>f.dispose()),n._terrainMeshes.length=0,Zi("cleanup");var a=t.mesh(n,o);Zi("geom");var s=i.buildMesh(n,a,o);Zi("build"),Zi("end"),s.forEach(f=>{r.rendering.addMeshToScene(f,!0,n.pos,this),f.cullingStrategy=H.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,n._terrainMeshes.push(f)})}}function zv(){this.terrainID=0,this.numFaces=0,this.matIDs=[],this.dirs=[],this.is=[],this.js=[],this.ks=[],this.wids=[],this.hts=[],this.packedAO=[]}function Xv(r,e){var t=new Int16Array(16),i=new Int16Array(16),n=e.getTerrainMatId.bind(e),o=T=>1,a=n;this.mesh=function(T,A){var M=T.size;a=A?o:n;var C=T._isEmpty||T._isFull,P={};yc.reset();for(var R=0;R<3;++R){var F=R===2?0:2,I=R===1?0:1,D=T._neighbors.data.map(be=>be&&be.voxels?be.voxels.transpose(R,F,I):null),V=(0,Ec.default)(D,[3,3,3]).lo(1,1,1).transpose(R,F,I);t.length<M*M&&(t=new Int16Array(M*M),i=new Int16Array(M*M)),s(V,M);var k=V.get(-1,0,0),w=V.get(0,0,0);if(k){var G=k.lo(M,0,0),K=m(R,G,-1,w,0);K>0&&_(0,R,F,I,M,M,K,P)}if(!C)for(var j=0;j<M-1;j++){if(R===1){var W=T._wholeLayerVoxel[j];if(W>=0&&W===T._wholeLayerVoxel[j+1])continue}var z=R===1?null:T._wholeLayerVoxel,oe=m(R,w,j,w,j+1,z);oe>0&&_(j+1,R,F,I,M,M,oe,P)}}return P};function s(T,A){if(c=T.get(0,0,0),p=T,h=r.registry._solidityLookup,f.length!==A+1){f=[],u=[],l=[];for(var M=-1;M<A+1;M++){var C=M<0?0:M<A?1:2;f[M]=[-1,0,1][C]|0,u[M]=[A-1,M,0][C]|0,l[M]=[0,M,A-1][C]|0}}}var f=[],u=[],l=[],h,c,p;function d(T,A,M){var C=f[T]|0,P=f[A]|0,R=f[M]|0;if((C|P|R)===0)return h[c.get(T,A,M)];var F=p.get(C,P,R);if(F){var I=u[T]|0,D=u[A]|0,V=u[M]|0;return h[F.get(I,D,V)]}else{var k=l[T]|0,w=l[A]|0,G=l[M]|0;return h[c.get(k,w,G)]}}function m(T,A,M,C,P,R=null){for(var F=A.shape[1],I=t,D=i,V=r.rendering.useAO,k=r.rendering.revAoVal===r.rendering.aoVals[0],w=r.registry._opacityLookup,G=r.registry.getBlockFaceMaterial,K=T*2,j=0,W=A.index(M,0,0),z=A.stride[1],oe=A.stride[2],be=C.index(P,0,0),Pe=C.stride[1],ze=C.stride[2],$e=0,ft=0;ft<F;++ft){var ut=W,lt=be;if(W+=oe,be+=ze,R&&R[ft]>=0){j+=F;continue}for(var ht=0;ht<F;ht++,j++,ut+=z,lt+=Pe){var Xe=A.data[ut],Ze=C.data[lt];if(Xe!==Ze){var St=w[Xe],Mt=w[Ze];if(!(St&&Mt)){var ot=G(Xe,K),ct=G(Ze,K+1);ot!==ct&&(St||ct===0?(I[j]=ot,V&&(D[j]=bc(d,P,M,ht,ft,k)),$e++):(Mt||ot===0)&&(I[j]=-ct,V&&(D[j]=bc(d,M,P,ht,ft,k)),$e++))}}}}return $e}function _(T,A,M,C,P,R,F,I){var D=r.rendering.useAO,V=t,k=i,w=0,G=A*2,K=[0,0,0];K[A]=T;for(var j=D?y:g,W=0;W<R;++W)for(var z=1,oe=1,be=0;be<P;be+=z,w+=z){var Pe=V[w]|0;if(!Pe){z=1;continue}var ze=k[w]|0;for(z=1;z<P-be&&j(w+z,V,Pe,k,ze);++z);e:for(oe=1;oe<R-W;++oe)for(var $e=0;$e<z;++$e){var ft=w+$e+oe*P;if(!j(ft,V,Pe,k,ze))break e}var ut=Math.abs(Pe),lt=a(ut);if(!(lt in I)){var ht=yc.get();ht.numFaces=0,ht.terrainID=lt,I[lt]=ht}var Xe=I[lt],Ze=Xe.numFaces;Xe.numFaces++,Xe.matIDs[Ze]=ut,K[M]=be,K[C]=W,Xe.is[Ze]=K[0],Xe.js[Ze]=K[1],Xe.ks[Ze]=K[2],Xe.wids[Ze]=z,Xe.hts[Ze]=oe,Xe.packedAO[Ze]=ze,Xe.dirs[Ze]=Pe>0?G:G+1;for(var St=0;St<oe;++St)for(var Mt=0;Mt<z;++Mt)V[w+Mt+St*P]=0;if(F-=z*oe,F===0)return}}function y(T,A,M,C,P){return!(M!==A[T]||P!==C[T])}function g(T,A,M,C,P){return M===A[T]}}var yc=(()=>{var r=[],e=0,t=()=>(e>=r.length&&r.push(new zv),e++,r[e-1]),i=()=>{e=0};return{get:t,reset:i}})();function Hv(r,e){this.buildMesh=function(c,p,d){var m=r.rendering.getScene(),_=r.rendering.useAO,y=r.rendering.aoVals,g=r.rendering.revAoVal,T=r.registry._matAtlasIndexLookup,A=r.registry._materialColorLookup,M=[1,1,1],C=[];for(var P in p){var R=p[P],F=R.terrainID,I=!1;if(!d){var D=T[R.matIDs[0]];I=D>=0}for(var V=[],k=[],w=[],G=[],K=[],j=[],W=0;W<R.numFaces;W++){var z=R.matIDs[W],oe=R.dirs[W],be=R.is[W],Pe=R.js[W],ze=R.ks[W],$e=R.wids[W],ft=R.hts[W],ut=oe/2|0,lt=oe%2?-1:1;t(V,W,be,Pe,ze,ut,$e,ft),i(K,W,ut,$e,ft,lt);var ht=[0,0,0];ht[ut]=lt,n(w,W,ht);var Xe=R.packedAO[W],[Ze,St,Mt,ot]=Kv(Xe),ct=f(Ze,St,Mt,ot);if(o(k,W,ut,lt,ct),I){var Ot=T[z];s(j,W,Ot)}var Pt=A[z]||M;_?l(G,W,Pt,y,g,Ze,St,Mt,ot):u(G,W,Pt)}var Wr=`chunk_${c.requestID}_${F}`,Gr=new H(Wr,m),zr=new re;zr.positions=V,zr.indices=k,zr.normals=w,zr.colors=G,zr.uvs=K,zr.applyToMesh(Gr),I&&Gr.setVerticesData("texAtlasIndices",j,!1,1),d||(Gr.material=e.getMaterial(F)),C.push(Gr)}return C};function t(c,p,d,m,_,y,g,T){var A=p*12,M=[d,m,_],C=[0,0,0],P=[0,0,0];C[y===2?0:2]=g,P[y===1?0:1]=T;for(var R=0;R<3;R++)c[A+R]=M[R],c[A+3+R]=M[R]+C[R],c[A+6+R]=M[R]+C[R]+P[R],c[A+9+R]=M[R]+P[R]}function i(c,p,d,m,_,y){for(var g=p*8,T=0,A=0;A<8;A++)c[g+A]=T;d===0?(c[g+1]=c[g+3]=_-T,c[g+2]=c[g+4]=y*m):d===1?(c[g+1]=c[g+7]=m-T,c[g+4]=c[g+6]=y*_):(c[g+1]=c[g+3]=_-T,c[g+2]=c[g+4]=-y*m)}function n(c,p,d){for(var m=p*12,_=0;_<12;_++)c[m+_]=d[_%3]}function o(c,p,d,m,_){var y=p*6,g=p*4;d===0&&(m=-m);var T=m<0?0:1;_||(T+=2);for(var A=a[T],M=0;M<6;M++)c[y+M]=g+A[M]}var a=[[0,1,2,0,2,3],[0,2,1,0,3,2],[1,2,3,1,3,0],[1,3,2,1,0,3]];function s(c,p,d){for(var m=p*4,_=0;_<4;_++)c[m+_]=d}function f(c,p,d,m){return c===d?m===p?m===2:!0:m===p?!1:c+d>m+p}function u(c,p,d){for(var m=p*16,_=0;_<16;_+=4)c[m+_]=d[0],c[m+_+1]=d[1],c[m+_+2]=d[2],c[m+_+3]=1}function l(c,p,d,m,_,y,g,T,A){var M=p*16;h(c,M,d,y,m,_),h(c,M+4,d,A,m,_),h(c,M+8,d,T,m,_),h(c,M+12,d,g,m,_)}function h(c,p,d,m,_,y){var g=m===0?y:_[m-1];c[p]=d[0]*g,c[p+1]=d[1]*g,c[p+2]=d[2]*g,c[p+3]=1}}function bc(r,e,t,i,n,o=!1){var a=1,s=1,f=1,u=1;r(e,i+1,n)&&(++f,++u),r(e,i-1,n)&&(++a,++s),r(e,i,n+1)&&(++s,++u),r(e,i,n-1)&&(++a,++f);var l=r(e,i,n);return l?(u=u===3||r(e,i+1,n+1)?3:2,s=s===3||r(e,i-1,n+1)?3:2,f=f===3||r(e,i+1,n-1)?3:2,a=a===3||r(e,i-1,n-1)?3:2,u<<6|f<<4|s<<2|a):o?(u===1&&r(e,i+1,n+1)&&(u=2),s===1&&r(e,i-1,n+1)&&(s=2),f===1&&r(e,i+1,n-1)&&(f=2),a===1&&r(e,i-1,n-1)&&(a=2),u<<6|f<<4|s<<2|a):(u===1&&(r(e,i+1,n+1)?u=2:(!r(t,i,n+1)||!r(t,i+1,n)||!r(t,i+1,n+1))&&(u=0)),f===1&&(r(e,i+1,n-1)?f=2:(!r(t,i,n-1)||!r(t,i+1,n)||!r(t,i+1,n-1))&&(f=0)),s===1&&(r(e,i-1,n+1)?s=2:(!r(t,i,n+1)||!r(t,i-1,n)||!r(t,i-1,n+1))&&(s=0)),a===1&&(r(e,i-1,n-1)?a=2:(!r(t,i,n-1)||!r(t,i-1,n)||!r(t,i-1,n-1))&&(a=0)),u<<6|f<<4|s<<2|a)}function Kv(r){var e=r&3,t=r>>2&3,i=r>>4&3,n=r>>6&3;return[e,t,n,i]}var Zi=gc?ar(gc,"Meshing"):()=>{};v();var jv={texturePath:""},Yv=(1<<16)-1,Jn=class{constructor(e,t){t=Object.assign({},jv,t),this.noa=e,this._texturePath=t.texturePath;var i={},n=[!1],o=[!1],a=[!1],s=[!1],f=[null],u=[null],l=[null],h=[!1],c=[0,0,0,0,0,0],p=[null],d=[-1],m=[];this.registerBlock=function(_=1,y=null){var g=new Qv(y&&y.fluid),T=Object.assign({},g,y||{});if(_<1||_>Yv)throw"Block id out of range: "+_;for(;_>n.length;)this.registerBlock(n.length,{});n[_]=!!T.solid,o[_]=!!T.opaque,a[_]=!!T.fluid,s[_]=!!T.blockMesh,u[_]=T.blockMesh||null;var A=T.material||null,M;if(!A)M=[null,null,null,null,null,null];else if(typeof A=="string")M=[A,A,A,A,A,A];else if(A.length&&A.length==2)M=[A[1],A[1],A[0],A[0],A[1],A[1]];else if(A.length&&A.length==3)M=[A[2],A[2],A[0],A[1],A[2],A[2]];else if(A.length&&A.length==6)M=A;else throw"Invalid material parameter: "+A;for(var C=0;C<6;++C)c[_*6+C]=qv(this,i,M[C],!0);f[_]={},a[_]&&(f[_].fluidDensity=T.fluidDensity,f[_].viscosity=T.viscosity);var P=T.onLoad||T.onUnload||T.onSet||T.onUnset||T.onCustomMeshCreate;l[_]=P?new Zv(T):null;var R=n[_]&&o[_]&&!P&&!a[_]&&!s[_];return h[_]=R,_},this.registerMaterial=function(_="?",y=null){if(Array.isArray(y)||arguments[2])throw'This API changed signatures in v0.33, please use: `noa.registry.registerMaterial("name", optionsObj)`';var g=Object.assign(new Jv,y||{}),T=i[_]||m.length;i[_]=T;var A=g.textureURL?this._texturePath+g.textureURL:"",M=1,C=g.color||[1,1,1];return C.length===4&&(M=C.pop()),A&&(C=null),p[T]=C,d[T]=g.atlasIndex,m[T]={color:C,alpha:M,texture:A,texHasAlpha:!!g.texHasAlpha,atlasIndex:g.atlasIndex,renderMat:g.renderMaterial},T},this.getBlockSolidity=function(_){return n[_]},this.getBlockOpacity=function(_){return o[_]},this.getBlockFluidity=function(_){return a[_]},this.getBlockProps=function(_){return f[_]},this.getBlockFaceMaterial=function(_,y){return c[_*6+y]},this.getMaterialData=function(_){return m[_]},this._solidityLookup=n,this._opacityLookup=o,this._fluidityLookup=a,this._objectLookup=s,this._blockMeshLookup=u,this._blockHandlerLookup=l,this._blockIsPlainLookup=h,this._materialColorLookup=p,this._matAtlasIndexLookup=d,this.registerMaterial("dirt",{color:[.4,.3,0]}),this.registerBlock(1,{material:"dirt"})}};function qv(r,e,t,i){if(!t)return 0;var n=e[t];return n===void 0&&i&&(n=r.registerMaterial(t)),n}function Zv(r){this.onLoad=r.onLoad||null,this.onUnload=r.onUnload||null,this.onSet=r.onSet||null,this.onUnset=r.onUnset||null,this.onCustomMeshCreate=r.onCustomMeshCreate||null}function Qv(r=!1){this.solid=!r,this.opaque=!r,this.fluid=!1,this.material=null,this.blockMesh=null,this.fluidDensity=1,this.viscosity=.5,this.onLoad=null,this.onUnload=null,this.onSet=null,this.onUnset=null,this.onCustomMeshCreate=null}function Jv(){this.color=null,this.textureURL=null,this.texHasAlpha=!1,this.atlasIndex=-1,this.renderMaterial=null}v();v();v();v();var $n=function(){function r(e,t,i,n,o,a){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=n,this._maxDepth=o,this._creationFunc=a,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}return Object.defineProperty(r.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!1,configurable:!0}),r.prototype.addEntry=function(e){if(this.blocks){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},r.prototype.removeEntry=function(e){if(this.blocks){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.removeEntry(e)}return}var n=this.entries.indexOf(e);n>-1&&this.entries.splice(n,1)},r.prototype.addEntries=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addEntry(i)}},r.prototype.select=function(e,t,i){if(di.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.select(e,t,i)}return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}},r.prototype.intersects=function(e,t,i,n){if(di.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var a=this.blocks[o];a.intersects(e,t,i,n)}return}n?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},r.prototype.intersectsRay=function(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){var n=this.blocks[i];n.intersectsRay(e,t)}return}t.concatWithNoDuplicate(this.entries)}},r.prototype.createInnerBlocks=function(){r._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},r._CreateBlocks=function(e,t,i,n,o,a,s,f){s.blocks=new Array;for(var u=new E((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2),l=0;l<2;l++)for(var h=0;h<2;h++)for(var c=0;c<2;c++){var p=e.add(u.multiplyByFloats(l,h,c)),d=e.add(u.multiplyByFloats(l+1,h+1,c+1)),m=new r(p,d,n,o+1,a,f);m.addEntries(i),s.blocks.push(m)}},r}();var Nr=function(){function r(e,t,i){i===void 0&&(i=2),this.maxDepth=i,this.dynamicContent=new Array,this._maxBlockCapacity=t||64,this._selectionContent=new Nt(1024),this._creationFunc=e}return r.prototype.update=function(e,t,i){$n._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},r.prototype.addMesh=function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}},r.prototype.removeMesh=function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.removeEntry(e)}},r.prototype.select=function(e,t){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){var n=this.blocks[i];n.select(e,this._selectionContent,t)}return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},r.prototype.intersects=function(e,t,i){this._selectionContent.reset();for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.intersects(e,t,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},r.prototype.intersectsRay=function(e){this._selectionContent.reset();for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.intersectsRay(e,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},r.CreationFuncForMeshes=function(e,t){var i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},r.CreationFuncForSubMeshes=function(e,t){var i=e.getBoundingInfo();i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},r}();v();v();var Dt=function(){function r(e,t,i){i===void 0&&(i=Number.MAX_VALUE),this.origin=e,this.direction=t,this.length=i}return r.prototype.clone=function(){return new r(this.origin.clone(),this.direction.clone(),this.length)},r.prototype.intersectsBoxMinMax=function(e,t,i){i===void 0&&(i=0);var n=r._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),o=r._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),a=0,s=Number.MAX_VALUE,f,u,l,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>o.x)return!1}else if(f=1/this.direction.x,u=(n.x-this.origin.x)*f,l=(o.x-this.origin.x)*f,l===-1/0&&(l=1/0),u>l&&(h=u,u=l,l=h),a=Math.max(u,a),s=Math.min(l,s),a>s)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>o.y)return!1}else if(f=1/this.direction.y,u=(n.y-this.origin.y)*f,l=(o.y-this.origin.y)*f,l===-1/0&&(l=1/0),u>l&&(h=u,u=l,l=h),a=Math.max(u,a),s=Math.min(l,s),a>s)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>o.z)return!1}else if(f=1/this.direction.z,u=(n.z-this.origin.z)*f,l=(o.z-this.origin.z)*f,l===-1/0&&(l=1/0),u>l&&(h=u,u=l,l=h),a=Math.max(u,a),s=Math.min(l,s),a>s)return!1;return!0},r.prototype.intersectsBox=function(e,t){return t===void 0&&(t=0),this.intersectsBoxMinMax(e.minimum,e.maximum,t)},r.prototype.intersectsSphere=function(e,t){t===void 0&&(t=0);var i=e.center.x-this.origin.x,n=e.center.y-this.origin.y,o=e.center.z-this.origin.z,a=i*i+n*n+o*o,s=e.radius+t,f=s*s;if(a<=f)return!0;var u=i*this.direction.x+n*this.direction.y+o*this.direction.z;if(u<0)return!1;var l=a-u*u;return l<=f},r.prototype.intersectsTriangle=function(e,t,i){var n=r._TmpVector3[0],o=r._TmpVector3[1],a=r._TmpVector3[2],s=r._TmpVector3[3],f=r._TmpVector3[4];t.subtractToRef(e,n),i.subtractToRef(e,o),E.CrossToRef(this.direction,o,a);var u=E.Dot(n,a);if(u===0)return null;var l=1/u;this.origin.subtractToRef(e,s);var h=E.Dot(s,a)*l;if(h<0||h>1)return null;E.CrossToRef(s,n,f);var c=E.Dot(this.direction,f)*l;if(c<0||h+c>1)return null;var p=E.Dot(o,f)*l;return p>this.length?null:new Gi(1-h-c,h,p)},r.prototype.intersectsPlane=function(e){var t,i=E.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;var n=E.Dot(e.normal,this.origin);return t=(-e.d-n)/i,t<0?t<-999999997475243e-21?null:0:t},r.prototype.intersectsAxis=function(e,t){switch(t===void 0&&(t=0),e){case"y":{var i=(this.origin.y-t)/this.direction.y;return i>0?null:new E(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{var i=(this.origin.x-t)/this.direction.x;return i>0?null:new E(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{var i=(this.origin.z-t)/this.direction.z;return i>0?null:new E(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}},r.prototype.intersectsMesh=function(e,t){var i=L.Matrix[0];return e.getWorldMatrix().invertToRef(i),this._tmpRay?r.TransformToRef(this,i,this._tmpRay):this._tmpRay=r.Transform(this,i),e.intersects(this._tmpRay,t)},r.prototype.intersectsMeshes=function(e,t,i){i?i.length=0:i=[];for(var n=0;n<e.length;n++){var o=this.intersectsMesh(e[n],t);o.hit&&i.push(o)}return i.sort(this._comparePickingInfo),i},r.prototype._comparePickingInfo=function(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0},r.prototype.intersectionSegment=function(e,t,i){var n=this.origin,o=L.Vector3[0],a=L.Vector3[1],s=L.Vector3[2],f=L.Vector3[3];t.subtractToRef(e,o),this.direction.scaleToRef(r._Rayl,s),n.addToRef(s,a),e.subtractToRef(n,f);var u=E.Dot(o,o),l=E.Dot(o,s),h=E.Dot(s,s),c=E.Dot(o,f),p=E.Dot(s,f),d=u*h-l*l,m,_=d,y,g=d;d<r._Smallnum?(m=0,_=1,y=p,g=h):(m=l*p-h*c,y=u*p-l*c,m<0?(m=0,y=p,g=h):m>_&&(m=_,y=p+l,g=h)),y<0?(y=0,-c<0?m=0:-c>u?m=_:(m=-c,_=u)):y>g&&(y=g,-c+l<0?m=0:-c+l>u?m=_:(m=-c+l,_=u));var T=Math.abs(m)<r._Smallnum?0:m/_,A=Math.abs(y)<r._Smallnum?0:y/g,M=L.Vector3[4];s.scaleToRef(A,M);var C=L.Vector3[5];o.scaleToRef(T,C),C.addInPlace(f);var P=L.Vector3[6];C.subtractToRef(M,P);var R=A>0&&A<=this.length&&P.lengthSquared()<i*i;return R?C.length():-1},r.prototype.update=function(e,t,i,n,o,a,s,f){if(f===void 0&&(f=!1),f){r._RayDistant||(r._RayDistant=r.Zero()),r._RayDistant.unprojectRayToRef(e,t,i,n,B.IdentityReadOnly,a,s);var u=L.Matrix[0];o.invertToRef(u),r.TransformToRef(r._RayDistant,u,this)}else this.unprojectRayToRef(e,t,i,n,o,a,s);return this},r.Zero=function(){return new r(E.Zero(),E.Zero())},r.CreateNew=function(e,t,i,n,o,a,s){var f=r.Zero();return f.update(e,t,i,n,o,a,s)},r.CreateNewFromTo=function(e,t,i){i===void 0&&(i=B.IdentityReadOnly);var n=t.subtract(e),o=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),r.Transform(new r(e,n,o),i)},r.Transform=function(e,t){var i=new r(new E(0,0,0),new E(0,0,0));return r.TransformToRef(e,t,i),i},r.TransformToRef=function(e,t,i){E.TransformCoordinatesToRef(e.origin,t,i.origin),E.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;var n=i.direction,o=n.length();if(!(o===0||o===1)){var a=1/o;n.x*=a,n.y*=a,n.z*=a,i.length*=o}},r.prototype.unprojectRayToRef=function(e,t,i,n,o,a,s){var f,u=L.Matrix[0];o.multiplyToRef(a,u),u.multiplyToRef(s,u),u.invert();var l=L.Vector3[0];l.x=e/i*2-1,l.y=-(t/n*2-1),l.z=!((f=le.LastCreatedEngine)===null||f===void 0)&&f.isNDCHalfZRange?0:-1;var h=L.Vector3[1].copyFromFloats(l.x,l.y,1-1e-8),c=L.Vector3[2],p=L.Vector3[3];E._UnprojectFromInvertedMatrixToRef(l,u,c),E._UnprojectFromInvertedMatrixToRef(h,u,p),this.origin.copyFrom(c),p.subtractToRef(c,this.direction),this.direction.normalize()},r._TmpVector3=Be.BuildArray(6,E.Zero),r._RayDistant=r.Zero(),r._Smallnum=1e-8,r._Rayl=1e9,r}();ue.prototype.createPickingRay=function(r,e,t,i,n){n===void 0&&(n=!1);var o=Dt.Zero();return this.createPickingRayToRef(r,e,t,o,i,n),o};ue.prototype.createPickingRayToRef=function(r,e,t,i,n,o,a){o===void 0&&(o=!1),a===void 0&&(a=!1);var s=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}var f=n.viewport,u=f.toGlobal(s.getRenderWidth(),s.getRenderHeight());return r=r/s.getHardwareScalingLevel()-u.x,e=e/s.getHardwareScalingLevel()-(s.getRenderHeight()-u.y-u.height),i.update(r,e,u.width,u.height,t||B.IdentityReadOnly,o?B.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),a),this};ue.prototype.createPickingRayInCameraSpace=function(r,e,t){var i=Dt.Zero();return this.createPickingRayInCameraSpaceToRef(r,e,i,t),i};ue.prototype.createPickingRayInCameraSpaceToRef=function(r,e,t,i){if(!bt)return this;var n=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}var o=i.viewport,a=o.toGlobal(n.getRenderWidth(),n.getRenderHeight()),s=B.Identity();return r=r/n.getHardwareScalingLevel()-a.x,e=e/n.getHardwareScalingLevel()-(n.getRenderHeight()-a.y-a.height),t.update(r,e,a.width,a.height,s,s,i.getProjectionMatrix()),this};ue.prototype._internalPickForMesh=function(r,e,t,i,n,o,a,s){var f=e(i,t.enableDistantPicking),u=t.intersects(f,n,a,o,i,s);return!u||!u.hit||!n&&r!=null&&u.distance>=r.distance?null:u};ue.prototype._internalPick=function(r,e,t,i,n){if(!bt)return null;for(var o=null,a=0;a<this.meshes.length;a++){var s=this.meshes[a];if(e){if(!e(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var f=s.getWorldMatrix();if(s.hasThinInstances&&s.thinInstanceEnablePicking){var u=this._internalPickForMesh(o,r,s,f,!0,!0,n);if(u){if(i)return u;for(var l=L.Matrix[1],h=s.thinInstanceGetWorldMatrices(),c=0;c<h.length;c++){var p=h[c];p.multiplyToRef(f,l);var d=this._internalPickForMesh(o,r,s,l,t,i,n,!0);if(d&&(o=d,o.thinInstanceIndex=c,t))return o}}}else{var u=this._internalPickForMesh(o,r,s,f,t,i,n);if(u&&(o=u,t))return o}}return o||new bt};ue.prototype._internalMultiPick=function(r,e,t){if(!bt)return null;for(var i=new Array,n=0;n<this.meshes.length;n++){var o=this.meshes[n];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var a=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){var s=this._internalPickForMesh(null,r,o,a,!0,!0,t);if(s)for(var f=L.Matrix[1],u=o.thinInstanceGetWorldMatrices(),l=0;l<u.length;l++){var h=u[l];h.multiplyToRef(a,f);var c=this._internalPickForMesh(null,r,o,f,!1,!1,t,!0);c&&(c.thinInstanceIndex=l,i.push(c))}}else{var s=this._internalPickForMesh(null,r,o,a,!1,!1,t);s&&i.push(s)}}return i};ue.prototype.pickWithBoundingInfo=function(r,e,t,i,n){var o=this;if(!bt)return null;var a=this._internalPick(function(s){return o._tempPickingRay||(o._tempPickingRay=Dt.Zero()),o.createPickingRayToRef(r,e,s,o._tempPickingRay,n||null),o._tempPickingRay},t,i,!0);return a&&(a.ray=this.createPickingRay(r,e,B.Identity(),n||null)),a};ue.prototype.pick=function(r,e,t,i,n,o,a){var s=this;if(a===void 0&&(a=!1),!bt)return null;var f=this._internalPick(function(u,l){return s._tempPickingRay||(s._tempPickingRay=Dt.Zero()),s.createPickingRayToRef(r,e,u,s._tempPickingRay,n||null,!1,l),s._tempPickingRay},t,i,!1,o);return f&&(f.ray=this.createPickingRay(r,e,B.Identity(),n||null)),f};ue.prototype.pickWithRay=function(r,e,t,i){var n=this,o=this._internalPick(function(a){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=B.Identity()),a.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=Dt.Zero()),Dt.TransformToRef(r,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform},e,t,!1,i);return o&&(o.ray=r),o};ue.prototype.multiPick=function(r,e,t,i,n){var o=this;return this._internalMultiPick(function(a){return o.createPickingRay(r,e,a,i||null)},t,n)};ue.prototype.multiPickWithRay=function(r,e,t){var i=this;return this._internalMultiPick(function(n){return i._pickWithRayInverseMatrix||(i._pickWithRayInverseMatrix=B.Identity()),n.invertToRef(i._pickWithRayInverseMatrix),i._cachedRayForTransform||(i._cachedRayForTransform=Dt.Zero()),Dt.TransformToRef(r,i._pickWithRayInverseMatrix,i._cachedRayForTransform),i._cachedRayForTransform},e,t)};Ye.prototype.getForwardRay=function(r,e,t){return r===void 0&&(r=100),this.getForwardRayToRef(new Dt(E.Zero(),E.Zero(),r),r,e,t)};Ye.prototype.getForwardRayToRef=function(r,e,t,i){return e===void 0&&(e=100),t||(t=this.getWorldMatrix()),r.length=e,i?r.origin.copyFrom(i):r.origin.copyFrom(this.position),L.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),E.TransformNormalToRef(L.Vector3[2],t,L.Vector3[3]),E.NormalizeToRef(L.Vector3[3],r.direction),r};ue.prototype.createOrUpdateSelectionOctree=function(r,e){r===void 0&&(r=64),e===void 0&&(e=2);var t=this._getComponent(Lr.NAME_OCTREE);t||(t=new eo(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new Nr(Nr.CreationFuncForMeshes,r,e));var i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(ue.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});wr.prototype.createOrUpdateSubmeshesOctree=function(r,e){r===void 0&&(r=64),e===void 0&&(e=2);var t=this.getScene(),i=t._getComponent(Lr.NAME_OCTREE);i||(i=new eo(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new Nr(Nr.CreationFuncForSubMeshes,r,e)),this.computeWorldMatrix(!0);var n=this.getBoundingInfo(),o=n.boundingBox;return this._submeshesOctree.update(o.minimumWorld,o.maximumWorld,this.subMeshes),this._submeshesOctree};var eo=function(){function r(e){this.name=Lr.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Dt(E.Zero(),new E(1,1,1)),e=e||le.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}return r.prototype.register=function(){var e=this;this.scene.onMeshRemovedObservable.add(function(t){var i=e.scene.selectionOctree;if(i!=null){var n=i.dynamicContent.indexOf(t);n!==-1&&i.dynamicContent.splice(n,1)}}),this.scene.onMeshImportedObservable.add(function(t){var i=e.scene.selectionOctree;i!=null&&i.addMesh(t)})},r.prototype.getActiveMeshCandidates=function(){if(this.scene._selectionOctree){var e=this.scene._selectionOctree.select(this.scene.frustumPlanes);return e}return this.scene._getDefaultMeshCandidates()},r.prototype.getActiveSubMeshCandidates=function(e){if(e._submeshesOctree&&e.useOctreeForRenderingSelection){var t=e._submeshesOctree.select(this.scene.frustumPlanes);return t}return this.scene._getDefaultSubMeshCandidates(e)},r.prototype.getIntersectingSubMeshCandidates=function(e,t){if(e._submeshesOctree&&e.useOctreeForPicking){Dt.TransformToRef(t,e.getWorldMatrix(),this._tempRay);var i=e._submeshesOctree.intersectsRay(this._tempRay);return i}return this.scene._getDefaultSubMeshCandidates(e)},r.prototype.getCollidingSubMeshCandidates=function(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){var i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z),n=e._submeshesOctree.intersects(t._basePointWorld,i);return n}return this.scene._getDefaultSubMeshCandidates(e)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){},r}();Ut();var to=class{constructor(e,t){var i=e._scene;i._addComponent(new eo(i));var n=new Nr(a);i._selectionOctree=n,n.blocks=[];var o={};this.rebase=l=>{f(n,l)},this.includesMesh=l=>l._noaContainingBlock||l._noaIsDynamicContent,this.addMesh=(l,h,c,p)=>{if(!h){l._noaIsDynamicContent=!0,n.dynamicContent.push(l);return}var d=Math.floor(c[0]/s),m=Math.floor(c[1]/s),_=Math.floor(c[2]/s),y=nt(d,m,_),g=o[y];if(!g){var T=[d*s,m*s,_*s],A=[0,0,0];e.noa.globalToLocal(T,null,A),g=u(A,s),n.blocks.push(g),o[y]=g,g._noaMapKey=y}g.entries.push(l),l._noaContainingBlock=g,l.alwaysSelectAsActiveMesh=!0},this.removeMesh=l=>{if(l._noaIsDynamicContent&&(l._noaIsDynamicContent=null,Yi(n.dynamicContent,l)),l._noaContainingBlock){l._noaContainingChunk=null;var h=l._noaContainingBlock;Yi(h.entries,l),h.entries.length===0&&(delete o[h._noaMapKey],Yi(n.blocks,h))}};var a=()=>{},s=t*e.noa.world._chunkSize,f=(l,h)=>{l.blocks.forEach(c=>{c.minPoint.subtractInPlace(h),c.maxPoint.subtractInPlace(h),c._boundingVectors.forEach(p=>p.subtractInPlace(h)),c.blocks&&f(c,h)})},u=(l,h)=>{var c=new E(l[0],l[1],l[2]),p=new E(l[0]+h,l[1]+h,l[2]+h);return new $n(c,p,void 0,void 0,void 0,a)}}};v();v();var Tc=function(r){Y(e,r);function e(t,i,n,o){o===void 0&&(o=!0);var a=r.call(this,t,i,n,o)||this;return a._tmpUpVector=E.Zero(),a._tmpTargetVector=E.Zero(),a.cameraDirection=new E(0,0,0),a.cameraRotation=new _e(0,0),a.ignoreParentScaling=!1,a.updateUpVectorFromRotation=!1,a._tmpQuaternion=new ie,a.rotation=new E(0,0,0),a.speed=2,a.noRotationConstraint=!1,a.invertRotation=!1,a.inverseRotationSpeed=.2,a.lockedTarget=null,a._currentTarget=E.Zero(),a._initialFocalDistance=1,a._viewMatrix=B.Zero(),a._camMatrix=B.Zero(),a._cameraTransformMatrix=B.Zero(),a._cameraRotationMatrix=B.Zero(),a._referencePoint=new E(0,0,1),a._transformedReferencePoint=E.Zero(),a._defaultUp=E.Up(),a._cachedRotationZ=0,a._cachedQuaternionRotationZ=0,a}return e.prototype.getFrontPosition=function(t){this.getWorldMatrix();var i=this.getTarget().subtract(this.position);return i.normalize(),i.scaleInPlace(t),this.globalPosition.add(i)},e.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},e.prototype.storeState=function(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),r.prototype.storeState.call(this)},e.prototype._restoreStateValues=function(){return r.prototype._restoreStateValues.call(this)?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1},e.prototype._initCache=function(){r.prototype._initCache.call(this),this._cache.lockedTarget=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new ie(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},e.prototype._updateCache=function(t){t||r.prototype._updateCache.call(this);var i=this._getLockedTargetPosition();i?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(i):this._cache.lockedTarget=i.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},e.prototype._isSynchronizedViewMatrix=function(){if(!r.prototype._isSynchronizedViewMatrix.call(this))return!1;var t=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},e.prototype._computeLocalCameraSpeed=function(){var t=this.getEngine();return this.speed*Math.sqrt(t.getDeltaTime()/(t.getFps()*100))},e.prototype.setTarget=function(t){this.upVector.normalize(),this._initialFocalDistance=t.subtract(this.position).length(),this.position.z===t.z&&(this.position.z+=ye),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),B.LookAtLHToRef(this.position,t,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var i=t.subtract(this.position);i.x>=0?this.rotation.y=-Math.atan(i.z/i.x)+Math.PI/2:this.rotation.y=-Math.atan(i.z/i.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&ie.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},Object.defineProperty(e.prototype,"target",{get:function(){return this.getTarget()},set:function(t){this.setTarget(t)},enumerable:!1,configurable:!0}),e.prototype.getTarget=function(){return this._currentTarget},e.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},e.prototype._updatePosition=function(){if(this.parent){this.parent.getWorldMatrix().invertToRef(L.Matrix[0]),E.TransformNormalToRef(this.cameraDirection,L.Matrix[0],L.Vector3[0]),this.position.addInPlace(L.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)},e.prototype._checkInputs=function(){var t=this.invertRotation?-this.inverseRotationSpeed:1,i=this._decideIfNeedsToMove(),n=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(i&&this._updatePosition(),n){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*t,this.rotation.y+=this.cameraRotation.y*t,!this.noRotationConstraint){var o=1.570796;this.rotation.x>o&&(this.rotation.x=o),this.rotation.x<-o&&(this.rotation.x=-o)}if(this.rotationQuaternion){var a=this.rotation.lengthSquared();a&&ie.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}}i&&(Math.abs(this.cameraDirection.x)<this.speed*ye&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*ye&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*ye&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),n&&(Math.abs(this.cameraRotation.x)<this.speed*ye&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*ye&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),r.prototype._checkInputs.call(this)},e.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):B.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)},e.prototype._rotateUpVectorWithCameraRotationMatrix=function(){return E.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this},e.prototype._getViewMatrix=function(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),E.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?zi.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(ie.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),zi.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix},e.prototype._computeViewMatrix=function(t,i,n){if(this.ignoreParentScaling){if(this.parent){var o=this.parent.getWorldMatrix();E.TransformCoordinatesToRef(t,o,this._globalPosition),E.TransformCoordinatesToRef(i,o,this._tmpTargetVector),E.TransformNormalToRef(n,o,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(i),this._tmpUpVector.copyFrom(n);this.getScene().useRightHandedSystem?B.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):B.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?B.LookAtRHToRef(t,i,n,this._viewMatrix):B.LookAtLHToRef(t,i,n,this._viewMatrix),this.parent){var o=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(o,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t)},e.prototype.createRigCamera=function(t,i){if(this.cameraRigMode!==Ye.RIG_MODE_NONE){var n=new e(t,this.position.clone(),this.getScene());return n.isRigCamera=!0,n.rigParent=this,(this.cameraRigMode===Ye.RIG_MODE_VR||this.cameraRigMode===Ye.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new ie),n._cameraRigParams={},n.rotationQuaternion=new ie),n.mode=this.mode,n.orthoLeft=this.orthoLeft,n.orthoRight=this.orthoRight,n.orthoTop=this.orthoTop,n.orthoBottom=this.orthoBottom,n}return null},e.prototype._updateRigCameras=function(){var t=this._rigCameras[0],i=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ye.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ye.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ye.RIG_MODE_STEREOSCOPIC_INTERLACED:{var n=this.cameraRigMode===Ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,o=this.cameraRigMode===Ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,t),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*o,i);break}case Ye.RIG_MODE_VR:t.rotationQuaternion?(t.rotationQuaternion.copyFrom(this.rotationQuaternion),i.rotationQuaternion.copyFrom(this.rotationQuaternion)):(t.rotation.copyFrom(this.rotation),i.rotation.copyFrom(this.rotation)),t.position.copyFrom(this.position),i.position.copyFrom(this.position);break}r.prototype._updateRigCameras.call(this)},e.prototype._getRigCamPositionAndTarget=function(t,i){var n=this.getTarget();n.subtractToRef(this.position,e._TargetFocalPoint),e._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);var o=e._TargetFocalPoint.addInPlace(this.position);B.TranslationToRef(-o.x,-o.y,-o.z,e._TargetTransformMatrix),e._TargetTransformMatrix.multiplyToRef(B.RotationAxis(i.upVector,t),e._RigCamTransformMatrix),B.TranslationToRef(o.x,o.y,o.z,e._TargetTransformMatrix),e._RigCamTransformMatrix.multiplyToRef(e._TargetTransformMatrix,e._RigCamTransformMatrix),E.TransformCoordinatesToRef(this.position,e._RigCamTransformMatrix,i.position),i.setTarget(o)},e.prototype.getClassName=function(){return"TargetCamera"},e._RigCamTransformMatrix=new B,e._TargetTransformMatrix=new B,e._TargetFocalPoint=new E,x([At()],e.prototype,"rotation",void 0),x([O()],e.prototype,"speed",void 0),x([yh("lockedTargetId")],e.prototype,"lockedTarget",void 0),e}(Ye);v();v();var qt={},Ac=function(){function r(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=function(){}}return r.prototype.add=function(e){var t=e.getSimpleName();if(this.attached[t]){q.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl()},r.prototype.remove=function(e){for(var t in this.attached){var i=this.attached[t];i===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}},r.prototype.removeByType=function(e){for(var t in this.attached){var i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}},r.prototype._addCheckInputs=function(e){var t=this.checkInputs;return function(){t(),e()}},r.prototype.attachInput=function(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)},r.prototype.attachElement=function(e){if(e===void 0&&(e=!1),!this.attachedToElement){e=Ye.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(var t in this.attached)this.attached[t].attachControl(e)}},r.prototype.detachElement=function(e){e===void 0&&(e=!1);for(var t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1},r.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var e in this.attached){var t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}},r.prototype.clear=function(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=function(){}},r.prototype.serialize=function(e){var t={};for(var i in this.attached){var n=this.attached[i],o=te.Serialize(n);t[n.getClassName()]=o}e.inputsmgr=t},r.prototype.parse=function(e){var t=e.inputsmgr;if(t){this.clear();var i=function(f){var u=qt[f];if(u){var l=t[f],h=te.Parse(function(){return new u},l,null);n.add(h)}},n=this;for(var o in t)i(o)}else{var a=function(f){var u=qt[s.attached[f].getClassName()];if(u){var l=te.Parse(function(){return new u},e,null);s.remove(s.attached[f]),s.add(l)}},s=this;for(var o in this.attached)a(o)}},r}();v();var Ba=function(){function r(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this._keys=new Array}return r.prototype.attachControl=function(e){var t=this;e=he.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){t._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(i){var n=i.event;if(!n.metaKey){if(i.type===Hi.KEYDOWN){if(t.keysUp.indexOf(n.keyCode)!==-1||t.keysDown.indexOf(n.keyCode)!==-1||t.keysLeft.indexOf(n.keyCode)!==-1||t.keysRight.indexOf(n.keyCode)!==-1||t.keysUpward.indexOf(n.keyCode)!==-1||t.keysDownward.indexOf(n.keyCode)!==-1||t.keysRotateLeft.indexOf(n.keyCode)!==-1||t.keysRotateRight.indexOf(n.keyCode)!==-1){var o=t._keys.indexOf(n.keyCode);o===-1&&t._keys.push(n.keyCode),e||n.preventDefault()}}else if(t.keysUp.indexOf(n.keyCode)!==-1||t.keysDown.indexOf(n.keyCode)!==-1||t.keysLeft.indexOf(n.keyCode)!==-1||t.keysRight.indexOf(n.keyCode)!==-1||t.keysUpward.indexOf(n.keyCode)!==-1||t.keysDownward.indexOf(n.keyCode)!==-1||t.keysRotateLeft.indexOf(n.keyCode)!==-1||t.keysRotateRight.indexOf(n.keyCode)!==-1){var o=t._keys.indexOf(n.keyCode);o>=0&&t._keys.splice(o,1),e||n.preventDefault()}}}))},r.prototype.detachControl=function(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0},r.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var e=this.camera,t=0;t<this._keys.length;t++){var i=this._keys[t],n=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-n,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,n):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(n,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-n):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,n,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-n,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),E.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}},r.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},r.prototype._onLostFocus=function(){this._keys.length=0},r.prototype.getSimpleName=function(){return"keyboard"},r.prototype._getLocalRotation=function(){var e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e},x([O()],r.prototype,"keysUp",void 0),x([O()],r.prototype,"keysUpward",void 0),x([O()],r.prototype,"keysDown",void 0),x([O()],r.prototype,"keysDownward",void 0),x([O()],r.prototype,"keysLeft",void 0),x([O()],r.prototype,"keysRight",void 0),x([O()],r.prototype,"rotationSpeed",void 0),x([O()],r.prototype,"keysRotateLeft",void 0),x([O()],r.prototype,"keysRotateRight",void 0),r}();qt.FreeCameraKeyboardMoveInput=Ba;v();var Na=function(){function r(e){e===void 0&&(e=!0),this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new U,this._allowCameraRotation=!0,this._currentActiveButton=-1}return r.prototype.attachControl=function(e){var t=this;e=he.BackCompatCameraNoPreventDefault(arguments);var i=this.camera.getEngine(),n=i.getInputElement();this._pointerInput||(this._pointerInput=function(o){var a=o.event,s=a.pointerType==="touch";if(!i.isInVRExclusivePointerMode&&!(!t.touchEnabled&&s)&&!(o.type!==ne.POINTERMOVE&&t.buttons.indexOf(a.button)===-1)){var f=a.srcElement||a.target;if(o.type===ne.POINTERDOWN&&(t._currentActiveButton===-1||s)){try{f==null||f.setPointerCapture(a.pointerId)}catch(h){}t._currentActiveButton===-1&&(t._currentActiveButton=a.button),t._previousPosition={x:a.clientX,y:a.clientY},e||(a.preventDefault(),n&&n.focus()),i.isPointerLock&&t._onMouseMove&&t._onMouseMove(o.event)}else if(o.type===ne.POINTERUP&&(t._currentActiveButton===a.button||s)){try{f==null||f.releasePointerCapture(a.pointerId)}catch(h){}t._currentActiveButton=-1,t._previousPosition=null,e||a.preventDefault()}else if(o.type===ne.POINTERMOVE){if(i.isPointerLock&&t._onMouseMove)t._onMouseMove(o.event);else if(t._previousPosition){var u=a.clientX-t._previousPosition.x,l=a.clientY-t._previousPosition.y;t.camera.getScene().useRightHandedSystem&&(u*=-1),t.camera.parent&&t.camera.parent._getWorldMatrixDeterminant()<0&&(u*=-1),t._allowCameraRotation&&(t.camera.cameraRotation.y+=u/t.angularSensibility,t.camera.cameraRotation.x+=l/t.angularSensibility),t.onPointerMovedObservable.notifyObservers({offsetX:u,offsetY:l}),t._previousPosition={x:a.clientX,y:a.clientY},e||a.preventDefault()}}}}),this._onMouseMove=function(o){if(!!i.isPointerLock&&!i.isInVRExclusivePointerMode){var a=o.movementX||o.mozMovementX||o.webkitMovementX||o.msMovementX||0;t.camera.getScene().useRightHandedSystem&&(a*=-1),t.camera.parent&&t.camera.parent._getWorldMatrixDeterminant()<0&&(a*=-1),t.camera.cameraRotation.y+=a/t.angularSensibility;var s=o.movementY||o.mozMovementY||o.webkitMovementY||o.msMovementY||0;t.camera.cameraRotation.x+=s/t.angularSensibility,t._previousPosition=null,e||o.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,ne.POINTERDOWN|ne.POINTERUP|ne.POINTERMOVE),n&&(this._contextMenuBind=this.onContextMenu.bind(this),n.addEventListener("contextmenu",this._contextMenuBind,!1))},r.prototype.onContextMenu=function(e){e.preventDefault()},r.prototype.detachControl=function(){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this._contextMenuBind){var e=this.camera.getEngine(),t=e.getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1},r.prototype.getClassName=function(){return"FreeCameraMouseInput"},r.prototype.getSimpleName=function(){return"mouse"},x([O()],r.prototype,"buttons",void 0),x([O()],r.prototype,"angularSensibility",void 0),r}();qt.FreeCameraMouseInput=Na;v();v();var Sc=function(){function r(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new U,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}return r.prototype.attachControl=function(e){var t=this;e=he.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(i){if(i.type===ne.POINTERWHEEL){var n=i.event,o=n.deltaMode===jn.DOM_DELTA_LINE?t._ffMultiplier:1;n.deltaY!==void 0?(t._wheelDeltaX+=t.wheelPrecisionX*o*n.deltaX/t._normalize,t._wheelDeltaY-=t.wheelPrecisionY*o*n.deltaY/t._normalize,t._wheelDeltaZ+=t.wheelPrecisionZ*o*n.deltaZ/t._normalize):n.wheelDeltaY!==void 0?(t._wheelDeltaX+=t.wheelPrecisionX*o*n.wheelDeltaX/t._normalize,t._wheelDeltaY-=t.wheelPrecisionY*o*n.wheelDeltaY/t._normalize,t._wheelDeltaZ+=t.wheelPrecisionZ*o*n.wheelDeltaZ/t._normalize):n.wheelDelta&&(t._wheelDeltaY-=t.wheelPrecisionY*n.wheelDelta/t._normalize),n.preventDefault&&(e||n.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,ne.POINTERWHEEL)},r.prototype.detachControl=function(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()},r.prototype.checkInputs=function(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0},r.prototype.getClassName=function(){return"BaseCameraMouseWheelInput"},r.prototype.getSimpleName=function(){return"mousewheel"},x([O()],r.prototype,"wheelPrecisionX",void 0),x([O()],r.prototype,"wheelPrecisionY",void 0),x([O()],r.prototype,"wheelPrecisionZ",void 0),r}();var Te;(function(r){r[r.MoveRelative=0]="MoveRelative",r[r.RotateRelative=1]="RotateRelative",r[r.MoveScene=2]="MoveScene"})(Te||(Te={}));var Ua=function(r){Y(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t._moveRelative=E.Zero(),t._rotateRelative=E.Zero(),t._moveScene=E.Zero(),t._wheelXAction=Te.MoveRelative,t._wheelXActionCoordinate=_r.X,t._wheelYAction=Te.MoveRelative,t._wheelYActionCoordinate=_r.Z,t._wheelZAction=null,t._wheelZActionCoordinate=null,t}return e.prototype.getClassName=function(){return"FreeCameraMouseWheelInput"},Object.defineProperty(e.prototype,"wheelXMoveRelative",{get:function(){return this._wheelXAction!==Te.MoveRelative?null:this._wheelXActionCoordinate},set:function(t){t===null&&this._wheelXAction!==Te.MoveRelative||(this._wheelXAction=Te.MoveRelative,this._wheelXActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelYMoveRelative",{get:function(){return this._wheelYAction!==Te.MoveRelative?null:this._wheelYActionCoordinate},set:function(t){t===null&&this._wheelYAction!==Te.MoveRelative||(this._wheelYAction=Te.MoveRelative,this._wheelYActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelZMoveRelative",{get:function(){return this._wheelZAction!==Te.MoveRelative?null:this._wheelZActionCoordinate},set:function(t){t===null&&this._wheelZAction!==Te.MoveRelative||(this._wheelZAction=Te.MoveRelative,this._wheelZActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelXRotateRelative",{get:function(){return this._wheelXAction!==Te.RotateRelative?null:this._wheelXActionCoordinate},set:function(t){t===null&&this._wheelXAction!==Te.RotateRelative||(this._wheelXAction=Te.RotateRelative,this._wheelXActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelYRotateRelative",{get:function(){return this._wheelYAction!==Te.RotateRelative?null:this._wheelYActionCoordinate},set:function(t){t===null&&this._wheelYAction!==Te.RotateRelative||(this._wheelYAction=Te.RotateRelative,this._wheelYActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelZRotateRelative",{get:function(){return this._wheelZAction!==Te.RotateRelative?null:this._wheelZActionCoordinate},set:function(t){t===null&&this._wheelZAction!==Te.RotateRelative||(this._wheelZAction=Te.RotateRelative,this._wheelZActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelXMoveScene",{get:function(){return this._wheelXAction!==Te.MoveScene?null:this._wheelXActionCoordinate},set:function(t){t===null&&this._wheelXAction!==Te.MoveScene||(this._wheelXAction=Te.MoveScene,this._wheelXActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelYMoveScene",{get:function(){return this._wheelYAction!==Te.MoveScene?null:this._wheelYActionCoordinate},set:function(t){t===null&&this._wheelYAction!==Te.MoveScene||(this._wheelYAction=Te.MoveScene,this._wheelYActionCoordinate=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelZMoveScene",{get:function(){return this._wheelZAction!==Te.MoveScene?null:this._wheelZActionCoordinate},set:function(t){t===null&&this._wheelZAction!==Te.MoveScene||(this._wheelZAction=Te.MoveScene,this._wheelZActionCoordinate=t)},enumerable:!1,configurable:!0}),e.prototype.checkInputs=function(){if(!(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)){this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);var t=B.Zero();this.camera.getViewMatrix().invertToRef(t);var i=E.Zero();E.TransformNormalToRef(this._moveRelative,t,i),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(i),this.camera.cameraDirection.addInPlace(this._moveScene),r.prototype.checkInputs.call(this)}},e.prototype._updateCamera=function(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)},e.prototype._updateCameraProperty=function(t,i,n){if(t!==0&&!(i===null||n===null)){var o=null;switch(i){case Te.MoveRelative:o=this._moveRelative;break;case Te.RotateRelative:o=this._rotateRelative;break;case Te.MoveScene:o=this._moveScene;break}switch(n){case _r.X:o.set(t,0,0);break;case _r.Y:o.set(0,t,0);break;case _r.Z:o.set(0,0,t);break}}},x([O()],e.prototype,"wheelXMoveRelative",null),x([O()],e.prototype,"wheelYMoveRelative",null),x([O()],e.prototype,"wheelZMoveRelative",null),x([O()],e.prototype,"wheelXRotateRelative",null),x([O()],e.prototype,"wheelYRotateRelative",null),x([O()],e.prototype,"wheelZRotateRelative",null),x([O()],e.prototype,"wheelXMoveScene",null),x([O()],e.prototype,"wheelYMoveScene",null),x([O()],e.prototype,"wheelZMoveScene",null),e}(Sc);qt.FreeCameraMouseWheelInput=Ua;v();var ka=function(){function r(e){e===void 0&&(e=!1),this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=he.IsSafari()}return r.prototype.attachControl=function(e){var t=this;e=he.BackCompatCameraNoPreventDefault(arguments);var i=null;if(this._pointerInput===void 0&&(this._onLostFocus=function(){t._offsetX=null,t._offsetY=null},this._pointerInput=function(a){var s=a.event,f=s.pointerType==="mouse"||t._isSafari&&typeof s.pointerType=="undefined";if(!(!t.allowMouse&&f)){if(a.type===ne.POINTERDOWN){if(e||s.preventDefault(),t._pointerPressed.push(s.pointerId),t._pointerPressed.length!==1)return;i={x:s.clientX,y:s.clientY}}else if(a.type===ne.POINTERUP){e||s.preventDefault();var u=t._pointerPressed.indexOf(s.pointerId);if(u===-1||(t._pointerPressed.splice(u,1),u!=0))return;i=null,t._offsetX=null,t._offsetY=null}else if(a.type===ne.POINTERMOVE){if(e||s.preventDefault(),!i)return;var u=t._pointerPressed.indexOf(s.pointerId);if(u!=0)return;t._offsetX=s.clientX-i.x,t._offsetY=-(s.clientY-i.y)}}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,ne.POINTERDOWN|ne.POINTERUP|ne.POINTERMOVE),this._onLostFocus){var n=this.camera.getEngine(),o=n.getInputElement();o&&o.addEventListener("blur",this._onLostFocus)}},r.prototype.detachControl=function(){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){var e=this.camera.getEngine(),t=e.getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}},r.prototype.checkInputs=function(){if(!(this._offsetX===null||this._offsetY===null)&&!(this._offsetX===0&&this._offsetY===0)){var e=this.camera;e.cameraRotation.y=this._offsetX/this.touchAngularSensibility;var t=this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1;if(t)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{var i=e._computeLocalCameraSpeed(),n=new E(0,0,this.touchMoveSensibility!==0?i*this._offsetY/this.touchMoveSensibility:0);B.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(E.TransformCoordinates(n,e._cameraRotationMatrix))}}},r.prototype.getClassName=function(){return"FreeCameraTouchInput"},r.prototype.getSimpleName=function(){return"touch"},x([O()],r.prototype,"touchAngularSensibility",void 0),x([O()],r.prototype,"touchMoveSensibility",void 0),r}();qt.FreeCameraTouchInput=ka;var Mc=function(r){Y(e,r);function e(t){var i=r.call(this,t)||this;return i._mouseInput=null,i._mouseWheelInput=null,i}return e.prototype.addKeyboard=function(){return this.add(new Ba),this},e.prototype.addMouse=function(t){return t===void 0&&(t=!0),this._mouseInput||(this._mouseInput=new Na(t),this.add(this._mouseInput)),this},e.prototype.removeMouse=function(){return this._mouseInput&&this.remove(this._mouseInput),this},e.prototype.addMouseWheel=function(){return this._mouseWheelInput||(this._mouseWheelInput=new Ua,this.add(this._mouseWheelInput)),this},e.prototype.removeMouseWheel=function(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this},e.prototype.addTouch=function(){return this.add(new ka),this},e.prototype.clear=function(){r.prototype.clear.call(this),this._mouseInput=null},e}(Ac);var Rc=function(r){Y(e,r);function e(t,i,n,o){o===void 0&&(o=!0);var a=r.call(this,t,i,n,o)||this;return a.ellipsoid=new E(.5,1,.5),a.ellipsoidOffset=new E(0,0,0),a.checkCollisions=!1,a.applyGravity=!1,a._needMoveForGravity=!1,a._oldPosition=E.Zero(),a._diffPosition=E.Zero(),a._newPosition=E.Zero(),a._collisionMask=-1,a._onCollisionPositionChange=function(s,f,u){u===void 0&&(u=null);var l=function(h){a._newPosition.copyFrom(h),a._newPosition.subtractToRef(a._oldPosition,a._diffPosition),a._diffPosition.length()>Re.CollisionsEpsilon&&(a.position.addInPlace(a._diffPosition),a.onCollide&&u&&a.onCollide(u))};l(f)},a.inputs=new Mc(a),a.inputs.addKeyboard().addMouse(),a}return Object.defineProperty(e.prototype,"angularSensibility",{get:function(){var t=this.inputs.attached.mouse;return t?t.angularSensibility:0},set:function(t){var i=this.inputs.attached.mouse;i&&(i.angularSensibility=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysUp",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysUp:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysUp=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysUpward",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysUpward:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysUpward=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysDown",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysDown:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysDown=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysDownward",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysDownward:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysDownward=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysLeft",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysLeft:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysLeft=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysRight",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRight:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysRight=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysRotateLeft",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRotateLeft:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysRotateLeft=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysRotateRight",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRotateRight:[]},set:function(t){var i=this.inputs.attached.keyboard;i&&(i.keysRotateRight=t)},enumerable:!1,configurable:!0}),e.prototype.attachControl=function(t,i){i=he.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)},e.prototype.detachControl=function(){this.inputs.detachElement(),this.cameraDirection=new E(0,0,0),this.cameraRotation=new _e(0,0)},Object.defineProperty(e.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),e.prototype._collideWithWorld=function(t){var i;this.parent?i=E.TransformCoordinates(this.position,this.parent.getWorldMatrix()):i=this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var o=t;this.applyGravity&&(o=t.add(this.getScene().gravity)),n.getNewPosition(this._oldPosition,o,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},e.prototype._checkInputs=function(){this._localDirection||(this._localDirection=E.Zero(),this._transformedDirection=E.Zero()),this.inputs.checkInputs(),r.prototype._checkInputs.call(this)},e.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},e.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):r.prototype._updatePosition.call(this)},e.prototype.dispose=function(){this.inputs.clear(),r.prototype.dispose.call(this)},e.prototype.getClassName=function(){return"FreeCamera"},x([At()],e.prototype,"ellipsoid",void 0),x([At()],e.prototype,"ellipsoidOffset",void 0),x([O()],e.prototype,"checkCollisions",void 0),x([O()],e.prototype,"applyGravity",void 0),e}(Tc);v();v();var Va=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i)||this;return n.diffuse=new de(1,1,1),n.specular=new de(1,1,1),n.falloffType=e.FALLOFF_DEFAULT,n.intensity=1,n._range=Number.MAX_VALUE,n._inverseSquaredRange=0,n._photometricScale=1,n._intensityMode=e.INTENSITYMODE_AUTOMATIC,n._radius=1e-5,n.renderPriority=0,n._shadowEnabled=!0,n._excludeWithLayerMask=0,n._includeOnlyWithLayerMask=0,n._lightmapMode=0,n._excludedMeshesIds=new Array,n._includedOnlyMeshesIds=new Array,n._isLight=!0,n.getScene().addLight(n),n._uniformBuffer=new vr(n.getScene().getEngine(),void 0,void 0,t),n._buildUniformLayout(),n.includedOnlyMeshes=new Array,n.excludedMeshes=new Array,n._resyncMeshes(),n}return Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t,this._inverseSquaredRange=1/(this.range*this.range)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(t){this._intensityMode=t,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled!==t&&(this._shadowEnabled=t,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(t){this._includedOnlyMeshes=t,this._hookArrayForIncludedOnly(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(t){this._excludedMeshes=t,this._hookArrayForExcluded(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(t){this._excludeWithLayerMask=t,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(t){this._includeOnlyWithLayerMask=t,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(t){this._lightmapMode!==t&&(this._lightmapMode=t,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),e.prototype.transferTexturesToEffect=function(t,i){return this},e.prototype._bindLight=function(t,i,n,o,a){a===void 0&&(a=!0);var s=t.toString(),f=!1;if(this._uniformBuffer.bindToEffect(n,"Light"+s),this._renderId!==i.getRenderId()||this._lastUseSpecular!==o||!this._uniformBuffer.useUbo){this._renderId=i.getRenderId(),this._lastUseSpecular=o;var u=this.getScaledIntensity();this.transferToEffect(n,s),this.diffuse.scaleToRef(u,Li.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Li.Color3[0],this.range,s),o&&(this.specular.scaleToRef(u,Li.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Li.Color3[1],this.radius,s)),f=!0}if(this.transferTexturesToEffect(n,s),i.shadowsEnabled&&this.shadowEnabled&&a){var l=this.getShadowGenerator();l&&(l.bindShadowLight(s,n),f=!0)}f?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()},e.prototype.getClassName=function(){return"Light"},e.prototype.toString=function(t){var i="Name: "+this.name;if(i+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var n=0;n<this.animations.length;n++)i+=", animation[0]: "+this.animations[n].toString(t);return i},e.prototype._syncParentEnabledState=function(){r.prototype._syncParentEnabledState.call(this),this.isDisposed()||this._resyncMeshes()},e.prototype.setEnabled=function(t){r.prototype.setEnabled.call(this,t),this._resyncMeshes()},e.prototype.getShadowGenerator=function(){return this._shadowGenerator},e.prototype.getAbsolutePosition=function(){return E.Zero()},e.prototype.canAffectMesh=function(t){return t?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(t)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(t)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&t.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&t.layerMask):!0},e.prototype.dispose=function(t,i){if(i===void 0&&(i=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this._parentContainer){var n=this._parentContainer.lights.indexOf(this);n>-1&&this._parentContainer.lights.splice(n,1),this._parentContainer=null}for(var o=0,a=this.getScene().meshes;o<a.length;o++){var s=a[o];s._removeLightSource(this,!0)}this._uniformBuffer.dispose(),this.getScene().removeLight(this),r.prototype.dispose.call(this,t,i)},e.prototype.getTypeID=function(){return 0},e.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},e.prototype.clone=function(t,i){i===void 0&&(i=null);var n=e.GetConstructorFromName(this.getTypeID(),t,this.getScene());if(!n)return null;var o=te.Clone(n,this);return t&&(o.name=t),i&&(o.parent=i),o.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(o),o},e.prototype.serialize=function(){var t=te.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(t),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach(function(i){t.excludedMeshesIds.push(i.id)})),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(i){t.includedOnlyMeshesIds.push(i.id)})),te.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t},e.GetConstructorFromName=function(t,i,n){var o=gt.Construct("Light_Type_"+t,i,n);return o||null},e.Parse=function(t,i){var n=e.GetConstructorFromName(t.type,t.name,i);if(!n)return null;var o=te.Parse(n,t,i);if(t.excludedMeshesIds&&(o._excludedMeshesIds=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(o._includedOnlyMeshesIds=t.includedOnlyMeshesIds),t.parentId!==void 0&&(o._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=t.parentInstanceIndex),t.falloffType!==void 0&&(o.falloffType=t.falloffType),t.lightmapMode!==void 0&&(o.lightmapMode=t.lightmapMode),t.animations){for(var a=0;a<t.animations.length;a++){var s=t.animations[a],f=wt("BABYLON.Animation");f&&o.animations.push(f.Parse(s))}gt.ParseAnimationRanges(o,t,i)}return t.autoAnimate&&i.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&o.setEnabled(t.isEnabled),o},e.prototype._hookArrayForExcluded=function(t){var i=this,n=t.push;t.push=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];for(var h=n.apply(t,u),c=0,p=u;c<p.length;c++){var d=p[c];d._resyncLightSource(i)}return h};var o=t.splice;t.splice=function(u,l){for(var h=o.apply(t,[u,l]),c=0,p=h;c<p.length;c++){var d=p[c];d._resyncLightSource(i)}return h};for(var a=0,s=t;a<s.length;a++){var f=s[a];f._resyncLightSource(this)}},e.prototype._hookArrayForIncludedOnly=function(t){var i=this,n=t.push;t.push=function(){for(var a=[],s=0;s<arguments.length;s++)a[s]=arguments[s];var f=n.apply(t,a);return i._resyncMeshes(),f};var o=t.splice;t.splice=function(a,s){var f=o.apply(t,[a,s]);return i._resyncMeshes(),f},this._resyncMeshes()},e.prototype._resyncMeshes=function(){for(var t=0,i=this.getScene().meshes;t<i.length;t++){var n=i[t];n._resyncLightSource(this)}},e.prototype._markMeshesAsLightDirty=function(){for(var t=0,i=this.getScene().meshes;t<i.length;t++){var n=i[t];n.lightSources.indexOf(this)!==-1&&n._markSubMeshesAsLightDirty()}},e.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},e.prototype._getPhotometricScale=function(){var t=0,i=this.getTypeID(),n=this.intensityMode;switch(n===e.INTENSITYMODE_AUTOMATIC&&(i===e.LIGHTTYPEID_DIRECTIONALLIGHT?n=e.INTENSITYMODE_ILLUMINANCE:n=e.INTENSITYMODE_LUMINOUSINTENSITY),i){case e.LIGHTTYPEID_POINTLIGHT:case e.LIGHTTYPEID_SPOTLIGHT:switch(n){case e.INTENSITYMODE_LUMINOUSPOWER:t=1/(4*Math.PI);break;case e.INTENSITYMODE_LUMINOUSINTENSITY:t=1;break;case e.INTENSITYMODE_LUMINANCE:t=this.radius*this.radius;break}break;case e.LIGHTTYPEID_DIRECTIONALLIGHT:switch(n){case e.INTENSITYMODE_ILLUMINANCE:t=1;break;case e.INTENSITYMODE_LUMINANCE:{var o=this.radius;o=Math.max(o,.001);var a=2*Math.PI*(1-Math.cos(o));t=a;break}}break;case e.LIGHTTYPEID_HEMISPHERICLIGHT:t=1;break}return t},e.prototype._reorderLightsInScene=function(){var t=this.getScene();this._renderPriority!=0&&(t.requireLightSorting=!0),this.getScene().sortLightsByPriority()},e.FALLOFF_DEFAULT=Fe.FALLOFF_DEFAULT,e.FALLOFF_PHYSICAL=Fe.FALLOFF_PHYSICAL,e.FALLOFF_GLTF=Fe.FALLOFF_GLTF,e.FALLOFF_STANDARD=Fe.FALLOFF_STANDARD,e.LIGHTMAP_DEFAULT=Fe.LIGHTMAP_DEFAULT,e.LIGHTMAP_SPECULAR=Fe.LIGHTMAP_SPECULAR,e.LIGHTMAP_SHADOWSONLY=Fe.LIGHTMAP_SHADOWSONLY,e.INTENSITYMODE_AUTOMATIC=Fe.INTENSITYMODE_AUTOMATIC,e.INTENSITYMODE_LUMINOUSPOWER=Fe.INTENSITYMODE_LUMINOUSPOWER,e.INTENSITYMODE_LUMINOUSINTENSITY=Fe.INTENSITYMODE_LUMINOUSINTENSITY,e.INTENSITYMODE_ILLUMINANCE=Fe.INTENSITYMODE_ILLUMINANCE,e.INTENSITYMODE_LUMINANCE=Fe.INTENSITYMODE_LUMINANCE,e.LIGHTTYPEID_POINTLIGHT=Fe.LIGHTTYPEID_POINTLIGHT,e.LIGHTTYPEID_DIRECTIONALLIGHT=Fe.LIGHTTYPEID_DIRECTIONALLIGHT,e.LIGHTTYPEID_SPOTLIGHT=Fe.LIGHTTYPEID_SPOTLIGHT,e.LIGHTTYPEID_HEMISPHERICLIGHT=Fe.LIGHTTYPEID_HEMISPHERICLIGHT,x([Ht()],e.prototype,"diffuse",void 0),x([Ht()],e.prototype,"specular",void 0),x([O()],e.prototype,"falloffType",void 0),x([O()],e.prototype,"intensity",void 0),x([O()],e.prototype,"range",null),x([O()],e.prototype,"intensityMode",null),x([O()],e.prototype,"radius",null),x([O()],e.prototype,"_renderPriority",void 0),x([ve("_reorderLightsInScene")],e.prototype,"renderPriority",void 0),x([O("shadowEnabled")],e.prototype,"_shadowEnabled",void 0),x([O("excludeWithLayerMask")],e.prototype,"_excludeWithLayerMask",void 0),x([O("includeOnlyWithLayerMask")],e.prototype,"_includeOnlyWithLayerMask",void 0),x([O("lightmapMode")],e.prototype,"_lightmapMode",void 0),e}(gt);gt.AddNodeConstructor("Light_Type_3",function(r,e){return function(){return new Wa(r,E.Zero(),e)}});var Wa=function(r){Y(e,r);function e(t,i,n){var o=r.call(this,t,n)||this;return o.groundColor=new de(0,0,0),o.direction=i||E.Up(),o}return e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},e.prototype.getClassName=function(){return"HemisphericLight"},e.prototype.setDirectionToTarget=function(t){return this.direction=E.Normalize(t.subtract(E.Zero())),this.direction},e.prototype.getShadowGenerator=function(){return null},e.prototype.transferToEffect=function(t,i){var n=E.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",n.x,n.y,n.z,0,i),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),i),this},e.prototype.transferToNodeMaterialEffect=function(t,i){var n=E.Normalize(this.direction);return t.setFloat3(i,n.x,n.y,n.z),this},e.prototype.computeWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix},e.prototype.getTypeID=function(){return Va.LIGHTTYPEID_HEMISPHERICLIGHT},e.prototype.prepareLightSpecificDefines=function(t,i){t["HEMILIGHT"+i]=!0},x([Ht()],e.prototype,"groundColor",void 0),x([At()],e.prototype,"direction",void 0),e}(Va);v();v();var ro=function(){function r(){this.previousWorldMatrices={},this.previousBones={}}return r.AddUniforms=function(e){e.push("previousWorld","previousViewProjection","mPreviousBones")},r.AddSamplers=function(e){},r.prototype.bindForSubMesh=function(e,t,i,n,o){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());var a=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=n.clone()}},r}();v();var io=function(r){Y(e,r);function e(t,i,n){n===void 0&&(n=!0);var o=r.call(this,t,i)||this;return o._normalMatrix=new B,o._storeEffectOnSubMeshes=n,o}return e.prototype.getEffect=function(){return this._storeEffectOnSubMeshes?this._activeEffect:r.prototype.getEffect.call(this)},e.prototype.isReady=function(t,i){return t?!this._storeEffectOnSubMeshes||!t.subMeshes||t.subMeshes.length===0?!0:this.isReadyForSubMesh(t,t.subMeshes[0],i):!1},e.prototype._isReadyForSubMesh=function(t){var i=t.materialDefines;return!!(!this.checkReadyOnEveryCall&&t.effect&&i&&i._renderId===this.getScene().getRenderId())},e.prototype.bindOnlyWorldMatrix=function(t){this._activeEffect.setMatrix("world",t)},e.prototype.bindOnlyNormalMatrix=function(t){this._activeEffect.setMatrix("normalMatrix",t)},e.prototype.bind=function(t,i){!i||this.bindForSubMesh(t,i,i.subMeshes[0])},e.prototype._afterBind=function(t,i){i===void 0&&(i=null),r.prototype._afterBind.call(this,t,i),this.getScene()._cachedEffect=i},e.prototype._mustRebind=function(t,i,n){return n===void 0&&(n=1),t.isCachedMaterialInvalid(this,i,n)},e}(De);v();var xe=function(){function r(){}return Object.defineProperty(r,"DiffuseTextureEnabled",{get:function(){return this._DiffuseTextureEnabled},set:function(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"DetailTextureEnabled",{get:function(){return this._DetailTextureEnabled},set:function(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"AmbientTextureEnabled",{get:function(){return this._AmbientTextureEnabled},set:function(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"OpacityTextureEnabled",{get:function(){return this._OpacityTextureEnabled},set:function(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ReflectionTextureEnabled",{get:function(){return this._ReflectionTextureEnabled},set:function(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"EmissiveTextureEnabled",{get:function(){return this._EmissiveTextureEnabled},set:function(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"SpecularTextureEnabled",{get:function(){return this._SpecularTextureEnabled},set:function(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"BumpTextureEnabled",{get:function(){return this._BumpTextureEnabled},set:function(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LightmapTextureEnabled",{get:function(){return this._LightmapTextureEnabled},set:function(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RefractionTextureEnabled",{get:function(){return this._RefractionTextureEnabled},set:function(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ColorGradingTextureEnabled",{get:function(){return this._ColorGradingTextureEnabled},set:function(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"FresnelEnabled",{get:function(){return this._FresnelEnabled},set:function(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,Re.MarkAllMaterialsAsDirty(4))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ClearCoatTextureEnabled",{get:function(){return this._ClearCoatTextureEnabled},set:function(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ClearCoatBumpTextureEnabled",{get:function(){return this._ClearCoatBumpTextureEnabled},set:function(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ClearCoatTintTextureEnabled",{get:function(){return this._ClearCoatTintTextureEnabled},set:function(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"SheenTextureEnabled",{get:function(){return this._SheenTextureEnabled},set:function(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"AnisotropicTextureEnabled",{get:function(){return this._AnisotropicTextureEnabled},set:function(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ThicknessTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RefractionIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"TranslucencyIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(r,"IridescenceTextureEnabled",{get:function(){return this._IridescenceTextureEnabled},set:function(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,Re.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),r._DiffuseTextureEnabled=!0,r._DetailTextureEnabled=!0,r._AmbientTextureEnabled=!0,r._OpacityTextureEnabled=!0,r._ReflectionTextureEnabled=!0,r._EmissiveTextureEnabled=!0,r._SpecularTextureEnabled=!0,r._BumpTextureEnabled=!0,r._LightmapTextureEnabled=!0,r._RefractionTextureEnabled=!0,r._ColorGradingTextureEnabled=!0,r._FresnelEnabled=!0,r._ClearCoatTextureEnabled=!0,r._ClearCoatBumpTextureEnabled=!0,r._ClearCoatTintTextureEnabled=!0,r._SheenTextureEnabled=!0,r._AnisotropicTextureEnabled=!0,r._ThicknessTextureEnabled=!0,r._RefractionIntensityTextureEnabled=!0,r._TranslucencyIntensityTextureEnabled=!0,r._IridescenceTextureEnabled=!0,r}();v();v();var $v="defaultFragmentDeclaration",em=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;N.IncludesShadersStore[$v]=em;v();v();var tm="sceneUboDeclaration",rm=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;N.IncludesShadersStore[tm]=rm;v();var im="meshUboDeclaration",nm=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;N.IncludesShadersStore[im]=nm;var om="defaultUboDeclaration",am=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;N.IncludesShadersStore[om]=am;v();var sm="prePassDeclaration",fm=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;N.IncludesShadersStore[sm]=fm;v();var um="oitDeclaration",lm=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;N.IncludesShadersStore[um]=lm;v();var hm="mainUVVaryingDeclaration",cm=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;N.IncludesShadersStore[hm]=cm;v();var dm="helperFunctions",pm=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float dither=mix(-varianceAmount/255.0,varianceAmount/255.0,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;N.IncludesShadersStore[dm]=pm;v();var _m="lightFragmentDeclaration",vm=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;N.IncludesShadersStore[_m]=vm;v();var mm="lightUboDeclaration",gm=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;N.IncludesShadersStore[mm]=gm;v();var ym="lightsFragmentFunctions",bm=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;N.IncludesShadersStore[ym]=bm;v();var Em="shadowsFragmentFunctions",Tm=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uv));
#else
float shadow=texture2D(shadowSampler,uv).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;
#else
if (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=texture2D(shadowSampler,uvDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;N.IncludesShadersStore[Em]=Tm;v();var Am="samplerFragmentDeclaration",Sm=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;N.IncludesShadersStore[Am]=Sm;v();var Mm="fresnelFunction",Rm=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;N.IncludesShadersStore[Mm]=Rm;v();var xm="reflectionFunction",Pm=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;N.IncludesShadersStore[xm]=Pm;v();var Cm="imageProcessingDeclaration",Im=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#ifdef VIGNETTE
uniform vec2 vInverseScreenSize;
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
`;N.IncludesShadersStore[Cm]=Im;v();var Dm="imageProcessingFunctions",Om=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
vec4 applyImageProcessing(vec4 result) {
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
return result;
}`;N.IncludesShadersStore[Dm]=Om;v();var Fm="bumpFragmentMainFunctions",wm=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;N.IncludesShadersStore[Fm]=wm;v();var Lm="bumpFragmentFunctions",Bm=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
break;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;N.IncludesShadersStore[Lm]=Bm;v();var Nm="clipPlaneFragmentDeclaration",Um=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;N.IncludesShadersStore[Nm]=Um;v();var km="logDepthDeclaration",Vm=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;N.IncludesShadersStore[km]=Vm;v();var Wm="fogFragmentDeclaration",Gm=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;N.IncludesShadersStore[Wm]=Gm;v();var zm="oitFragment",Xm=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;N.IncludesShadersStore[zm]=Xm;v();var Hm="clipPlaneFragment",Km=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;N.IncludesShadersStore[Hm]=Km;v();var jm="bumpFragment",Ym=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;N.IncludesShadersStore[jm]=Ym;v();var qm="depthPrePass",Zm=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;N.IncludesShadersStore[qm]=Zm;v();var Qm="lightFragment",Jm=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;N.IncludesShadersStore[Qm]=Jm;v();var $m="logDepthFragment",eg=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;N.IncludesShadersStore[$m]=eg;v();var tg="fogFragment",rg=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;N.IncludesShadersStore[tg]=rg;var ig="defaultPixelShader",ng=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<oitFragment>
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=textureCube(refractionCubeSampler,refractionVector);
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor)*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularColor,1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;N.ShadersStore[ig]=ng;v();v();var og="defaultVertexDeclaration",ag=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;N.IncludesShadersStore[og]=ag;v();var sg="uvAttributeDeclaration",fg=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;N.IncludesShadersStore[sg]=fg;v();var ug="bonesDeclaration",lg=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;N.IncludesShadersStore[ug]=lg;v();var hg="bakedVertexAnimationDeclaration",cg=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;N.IncludesShadersStore[hg]=cg;v();var dg="instancesDeclaration",pg=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;N.IncludesShadersStore[dg]=pg;v();var _g="prePassVertexDeclaration",vg=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;N.IncludesShadersStore[_g]=vg;v();var mg="samplerVertexDeclaration",gg=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;N.IncludesShadersStore[mg]=gg;v();var yg="bumpVertexDeclaration",bg=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;N.IncludesShadersStore[yg]=bg;v();var Eg="clipPlaneVertexDeclaration",Tg=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;N.IncludesShadersStore[Eg]=Tg;v();var Ag="fogVertexDeclaration",Sg=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;N.IncludesShadersStore[Ag]=Sg;v();var Mg="lightVxFragmentDeclaration",Rg=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;N.IncludesShadersStore[Mg]=Rg;v();var xg="lightVxUboDeclaration",Pg=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;N.IncludesShadersStore[xg]=Pg;v();var Cg="morphTargetsVertexGlobalDeclaration",Ig=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;N.IncludesShadersStore[Cg]=Ig;v();var Dg="morphTargetsVertexDeclaration",Og=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;N.IncludesShadersStore[Dg]=Og;v();var Fg="morphTargetsVertexGlobal",wg=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;N.IncludesShadersStore[Fg]=wg;v();var Lg="morphTargetsVertex",Bg=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;N.IncludesShadersStore[Lg]=Bg;v();var Ng="instancesVertex",Ug=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;N.IncludesShadersStore[Ng]=Ug;v();var kg="bonesVertex",Vg=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;N.IncludesShadersStore[kg]=Vg;v();var Wg="bakedVertexAnimation",Gg=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;N.IncludesShadersStore[Wg]=Gg;v();var zg="prePassVertex",Xg=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;N.IncludesShadersStore[zg]=Xg;v();var Hg="uvVariableDeclaration",Kg=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;N.IncludesShadersStore[Hg]=Kg;v();var jg="samplerVertexImplementation",Yg=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;N.IncludesShadersStore[jg]=Yg;v();var qg="bumpVertex",Zg=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;N.IncludesShadersStore[qg]=Zg;v();var Qg="clipPlaneVertex",Jg=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;N.IncludesShadersStore[Qg]=Jg;v();var $g="fogVertex",ey=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;N.IncludesShadersStore[$g]=ey;v();var ty="shadowsVertex",ry=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;N.IncludesShadersStore[ty]=ry;v();var iy="vertexColorMixing",ny=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;N.IncludesShadersStore[iy]=ny;v();var oy="pointCloudVertex",ay=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;N.IncludesShadersStore[oy]=ay;v();var sy="logDepthVertex",fy=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;N.IncludesShadersStore[sy]=fy;var uy="defaultVertexShader",ly=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;N.ShadersStore[uy]=ly;v();var no=function(){function r(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}return r.prototype.unBindMesh=function(){this._mesh=null},r.prototype.addFallback=function(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)},r.prototype.addCPUSkinningFallback=function(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)},Object.defineProperty(r.prototype,"hasMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!1,configurable:!0}),r.prototype.reduce=function(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;for(var i=this._mesh.getScene(),n=0;n<i.meshes.length;n++){var o=i.meshes[n];if(!o.material){!this._mesh.material&&o.computeBonesUsingShaders&&o.numBoneInfluencers>0&&(o.computeBonesUsingShaders=!1);continue}if(!(!o.computeBonesUsingShaders||o.numBoneInfluencers===0)){if(o.material.getEffect()===t)o.computeBonesUsingShaders=!1;else if(o.subMeshes)for(var a=0,s=o.subMeshes;a<s.length;a++){var f=s[a],u=f.effect;if(u===t){o.computeBonesUsingShaders=!1;break}}}}}else{var l=this._defines[this._currentRank];if(l)for(var n=0;n<l.length;n++)e=e.replace("#define "+l[n],"");this._currentRank++}return e},r}();v();var hy=function(r){Y(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t.DETAIL=!1,t.DETAILDIRECTUV=0,t.DETAIL_NORMALBLENDMETHOD=0,t}return e}(vi);var xc=function(r){Y(e,r);function e(t,i){i===void 0&&(i=!0);var n=r.call(this,t,"DetailMap",140,new hy,i)||this;return n._texture=null,n.diffuseBlendLevel=1,n.roughnessBlendLevel=1,n.bumpLevel=1,n._normalBlendMethod=De.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,n._isEnabled=!1,n.isEnabled=!1,n._internalMarkAllSubMeshesAsTexturesDirty=t._dirtyCallbacks[1],n}return e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype.isReadyForSubMesh=function(t,i,n){return this._isEnabled?!(t._areTexturesDirty&&i.texturesEnabled&&n.getCaps().standardDerivatives&&this._texture&&xe.DetailTextureEnabled&&!this._texture.isReady()):!0},e.prototype.prepareDefines=function(t,i){if(this._isEnabled){t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;var n=i.getEngine();t._areTexturesDirty&&(n.getCaps().standardDerivatives&&this._texture&&xe.DetailTextureEnabled&&this._isEnabled?(se.PrepareDefinesForMergedUV(this._texture,t,"DETAIL"),t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):t.DETAIL=!1)}else t.DETAIL=!1},e.prototype.bindForSubMesh=function(t,i){if(!!this._isEnabled){var n=this._material.isFrozen;(!t.useUbo||!n||!t.isSync)&&this._texture&&xe.DetailTextureEnabled&&(t.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),se.BindTextureMatrix(this._texture,t,"detail")),i.texturesEnabled&&this._texture&&xe.DetailTextureEnabled&&t.setTexture("detailSampler",this._texture)}},e.prototype.hasTexture=function(t){return this._texture===t},e.prototype.getActiveTextures=function(t){this._texture&&t.push(this._texture)},e.prototype.getAnimatables=function(t){this._texture&&this._texture.animations&&this._texture.animations.length>0&&t.push(this._texture)},e.prototype.dispose=function(t){var i;t&&((i=this._texture)===null||i===void 0||i.dispose())},e.prototype.getClassName=function(){return"DetailMapConfiguration"},e.prototype.getSamplers=function(t){t.push("detailSampler")},e.prototype.getUniforms=function(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}},x([at("detailTexture"),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"texture",void 0),x([O()],e.prototype,"diffuseBlendLevel",void 0),x([O()],e.prototype,"roughnessBlendLevel",void 0),x([O()],e.prototype,"bumpLevel",void 0),x([O(),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"normalBlendMethod",void 0),x([O(),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isEnabled",void 0),e}(Zn);var Ga={effect:null,subMesh:null},cy=function(r){Y(e,r);function e(t){var i=r.call(this,t)||this;return i.MAINUV1=!1,i.MAINUV2=!1,i.MAINUV3=!1,i.MAINUV4=!1,i.MAINUV5=!1,i.MAINUV6=!1,i.DIFFUSE=!1,i.DIFFUSEDIRECTUV=0,i.BAKED_VERTEX_ANIMATION_TEXTURE=!1,i.AMBIENT=!1,i.AMBIENTDIRECTUV=0,i.OPACITY=!1,i.OPACITYDIRECTUV=0,i.OPACITYRGB=!1,i.REFLECTION=!1,i.EMISSIVE=!1,i.EMISSIVEDIRECTUV=0,i.SPECULAR=!1,i.SPECULARDIRECTUV=0,i.BUMP=!1,i.BUMPDIRECTUV=0,i.PARALLAX=!1,i.PARALLAXOCCLUSION=!1,i.SPECULAROVERALPHA=!1,i.CLIPPLANE=!1,i.CLIPPLANE2=!1,i.CLIPPLANE3=!1,i.CLIPPLANE4=!1,i.CLIPPLANE5=!1,i.CLIPPLANE6=!1,i.ALPHATEST=!1,i.DEPTHPREPASS=!1,i.ALPHAFROMDIFFUSE=!1,i.POINTSIZE=!1,i.FOG=!1,i.SPECULARTERM=!1,i.DIFFUSEFRESNEL=!1,i.OPACITYFRESNEL=!1,i.REFLECTIONFRESNEL=!1,i.REFRACTIONFRESNEL=!1,i.EMISSIVEFRESNEL=!1,i.FRESNEL=!1,i.NORMAL=!1,i.TANGENT=!1,i.UV1=!1,i.UV2=!1,i.UV3=!1,i.UV4=!1,i.UV5=!1,i.UV6=!1,i.VERTEXCOLOR=!1,i.VERTEXALPHA=!1,i.NUM_BONE_INFLUENCERS=0,i.BonesPerMesh=0,i.BONETEXTURE=!1,i.BONES_VELOCITY_ENABLED=!1,i.INSTANCES=!1,i.THIN_INSTANCES=!1,i.INSTANCESCOLOR=!1,i.GLOSSINESS=!1,i.ROUGHNESS=!1,i.EMISSIVEASILLUMINATION=!1,i.LINKEMISSIVEWITHDIFFUSE=!1,i.REFLECTIONFRESNELFROMSPECULAR=!1,i.LIGHTMAP=!1,i.LIGHTMAPDIRECTUV=0,i.OBJECTSPACE_NORMALMAP=!1,i.USELIGHTMAPASSHADOWMAP=!1,i.REFLECTIONMAP_3D=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_OPPOSITEZ=!1,i.INVERTCUBICMAP=!1,i.LOGARITHMICDEPTH=!1,i.REFRACTION=!1,i.REFRACTIONMAP_3D=!1,i.REFLECTIONOVERALPHA=!1,i.TWOSIDEDLIGHTING=!1,i.SHADOWFLOAT=!1,i.MORPHTARGETS=!1,i.MORPHTARGETS_NORMAL=!1,i.MORPHTARGETS_TANGENT=!1,i.MORPHTARGETS_UV=!1,i.NUM_MORPH_INFLUENCERS=0,i.MORPHTARGETS_TEXTURE=!1,i.NONUNIFORMSCALING=!1,i.PREMULTIPLYALPHA=!1,i.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,i.ALPHABLEND=!0,i.PREPASS=!1,i.PREPASS_IRRADIANCE=!1,i.PREPASS_IRRADIANCE_INDEX=-1,i.PREPASS_ALBEDO_SQRT=!1,i.PREPASS_ALBEDO_SQRT_INDEX=-1,i.PREPASS_DEPTH=!1,i.PREPASS_DEPTH_INDEX=-1,i.PREPASS_NORMAL=!1,i.PREPASS_NORMAL_INDEX=-1,i.PREPASS_POSITION=!1,i.PREPASS_POSITION_INDEX=-1,i.PREPASS_VELOCITY=!1,i.PREPASS_VELOCITY_INDEX=-1,i.PREPASS_REFLECTIVITY=!1,i.PREPASS_REFLECTIVITY_INDEX=-1,i.SCENE_MRT_COUNT=0,i.RGBDLIGHTMAP=!1,i.RGBDREFLECTION=!1,i.RGBDREFRACTION=!1,i.IMAGEPROCESSING=!1,i.VIGNETTE=!1,i.VIGNETTEBLENDMODEMULTIPLY=!1,i.VIGNETTEBLENDMODEOPAQUE=!1,i.TONEMAPPING=!1,i.TONEMAPPING_ACES=!1,i.CONTRAST=!1,i.COLORCURVES=!1,i.COLORGRADING=!1,i.COLORGRADING3D=!1,i.SAMPLER3DGREENDEPTH=!1,i.SAMPLER3DBGRMAP=!1,i.IMAGEPROCESSINGPOSTPROCESS=!1,i.SKIPFINALCOLORCLAMP=!1,i.MULTIVIEW=!1,i.ORDER_INDEPENDENT_TRANSPARENCY=!1,i.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,i.IS_REFLECTION_LINEAR=!1,i.IS_REFRACTION_LINEAR=!1,i.EXPOSURE=!1,i.rebuild(),i}return e.prototype.setReflectionMode=function(t){for(var i=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"],n=0,o=i;n<o.length;n++){var a=o[n];this[a]=a===t}},e}(vi);var oo=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i)||this;return n._diffuseTexture=null,n._ambientTexture=null,n._opacityTexture=null,n._reflectionTexture=null,n._emissiveTexture=null,n._specularTexture=null,n._bumpTexture=null,n._lightmapTexture=null,n._refractionTexture=null,n.ambientColor=new de(0,0,0),n.diffuseColor=new de(1,1,1),n.specularColor=new de(1,1,1),n.emissiveColor=new de(0,0,0),n.specularPower=64,n._useAlphaFromDiffuseTexture=!1,n._useEmissiveAsIllumination=!1,n._linkEmissiveWithDiffuse=!1,n._useSpecularOverAlpha=!1,n._useReflectionOverAlpha=!1,n._disableLighting=!1,n._useObjectSpaceNormalMap=!1,n._useParallax=!1,n._useParallaxOcclusion=!1,n.parallaxScaleBias=.05,n._roughness=0,n.indexOfRefraction=.98,n.invertRefractionY=!0,n.alphaCutOff=.4,n._useLightmapAsShadowmap=!1,n._useReflectionFresnelFromSpecular=!1,n._useGlossinessFromSpecularMapAlpha=!1,n._maxSimultaneousLights=4,n._invertNormalMapX=!1,n._invertNormalMapY=!1,n._twoSidedLighting=!1,n._renderTargets=new st(16),n._worldViewProjectionMatrix=B.Zero(),n._globalAmbientColor=new de(0,0,0),n._cacheHasRenderTargetTextures=!1,n.detailMap=new xc(n),n._attachImageProcessingConfiguration(null),n.prePassConfiguration=new ro,n.getRenderTargetTextures=function(){return n._renderTargets.reset(),e.ReflectionTextureEnabled&&n._reflectionTexture&&n._reflectionTexture.isRenderTarget&&n._renderTargets.push(n._reflectionTexture),e.RefractionTextureEnabled&&n._refractionTexture&&n._refractionTexture.isRenderTarget&&n._renderTargets.push(n._refractionTexture),n._eventInfo.renderTargets=n._renderTargets,n._callbackPluginEventFillRenderTargetTextures(n._eventInfo),n._renderTargets},n}return Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),e.prototype._attachImageProcessingConfiguration=function(t){var i=this;t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),t?this._imageProcessingConfiguration=t:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(e.prototype,"isPrePassCapable",{get:function(){return!this.disableDepthWrite},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this._imageProcessingConfiguration.colorGradingTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(t){this._imageProcessingConfiguration.colorCurves=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasRenderTargetTextures",{get:function(){return e.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||e.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"StandardMaterial"},Object.defineProperty(e.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()},enumerable:!1,configurable:!0}),e.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled},e.prototype.needAlphaTesting=function(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===De.MATERIAL_ALPHATEST)},e.prototype._shouldUseAlphaFromDiffuseTexture=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==De.MATERIAL_OPAQUE},e.prototype._hasAlphaChannel=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null},e.prototype.getAlphaTestTexture=function(){return this._diffuseTexture},e.prototype.isReadyForSubMesh=function(t,i,n){if(n===void 0&&(n=!1),this._uniformBufferLayoutBuilt||this.buildUniformLayout(),i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady&&i.effect._wasPreviouslyUsingInstances===n)return!0;i.materialDefines||(this._callbackPluginEventGeneric(qe.GetDefineNames,this._eventInfo),i.materialDefines=new cy(this._eventInfo.defineNames));var o=this.getScene(),a=i.materialDefines;if(this._isReadyForSubMesh(i))return!0;var s=o.getEngine();a._needNormals=se.PrepareDefinesForLights(o,t,a,!0,this._maxSimultaneousLights,this._disableLighting),se.PrepareDefinesForMultiview(o,a);var f=this.needAlphaBlendingForMesh(t)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(o,a,this.canRenderToMRT&&!f),se.PrepareDefinesForOIT(o,a,f),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(var u=1;u<=6;++u)a["MAINUV"+u]=!1;if(o.texturesEnabled){if(this._diffuseTexture&&e.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE");else return!1;else a.DIFFUSE=!1;if(this._ambientTexture&&e.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._ambientTexture,a,"AMBIENT");else return!1;else a.AMBIENT=!1;if(this._opacityTexture&&e.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else a.OPACITY=!1;if(this._reflectionTexture&&e.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Ie.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Ie.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Ie.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Ie.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Ie.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Ie.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Ie.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Ie.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Ie.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Ie.CUBIC_MODE:case Ie.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC");break}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&e.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._emissiveTexture,a,"EMISSIVE");else return!1;else a.EMISSIVE=!1;if(this._lightmapTexture&&e.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else a.LIGHTMAP=!1;if(this._specularTexture&&e.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else a.SPECULAR=!1;if(o.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&e.BumpTextureEnabled){if(this._bumpTexture.isReady())se.PrepareDefinesForMergedUV(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&e.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,a.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(t)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(a._areFresnelDirty&&(e.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),se.PrepareDefinesForMisc(t,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t)||this._forceAlphaTest,a),se.PrepareDefinesForFrameBoundValues(o,s,a,n,null,i.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=t,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(t,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo),a.isDirty){var l=a._areLightsDisposed;a.markAsProcessed();var h=new no;a.REFLECTION&&h.addFallback(0,"REFLECTION"),a.SPECULAR&&h.addFallback(0,"SPECULAR"),a.BUMP&&h.addFallback(0,"BUMP"),a.PARALLAX&&h.addFallback(1,"PARALLAX"),a.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&h.addFallback(1,"FOG"),a.POINTSIZE&&h.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),se.HandleFallbacksForShadows(a,h,this._maxSimultaneousLights),a.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&h.addFallback(4,"FRESNEL"),a.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");var c=[b.PositionKind];a.NORMAL&&c.push(b.NormalKind),a.TANGENT&&c.push(b.TangentKind);for(var u=1;u<=6;++u)a["UV"+u]&&c.push("uv".concat(u===1?"":u));a.VERTEXCOLOR&&c.push(b.ColorKind),se.PrepareAttributesForBones(c,t,a,h),se.PrepareAttributesForInstances(c,a),se.PrepareAttributesForMorphTargets(c,t,a),se.PrepareAttributesForBakedVertexAnimation(c,t,a);var p="default",d=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],m=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=d,this._eventInfo.attributes=c,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=t,this._callbackPluginEventGeneric(qe.PrepareEffect,this._eventInfo),ro.AddUniforms(d),ro.AddSamplers(m),mr&&(mr.PrepareUniforms(d,a),mr.PrepareSamplers(m,a)),se.PrepareUniformsAndSamplersList({uniformsNames:d,uniformBuffersNames:_,samplers:m,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});var y={};this.customShaderNameResolve&&(p=this.customShaderNameResolve(p,d,_,m,a,c,y));var g=a.toString(),T=i.effect,A=o.getEngine().createEffect(p,{attributes:c,uniformsNames:d,uniformBuffersNames:_,samplers:m,defines:g,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS},processFinalCode:y.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS},s);if(A)if(this._onEffectCreatedObservable&&(Ga.effect=A,Ga.subMesh=i,this._onEffectCreatedObservable.notifyObservers(Ga)),this.allowShaderHotSwapping&&T&&!A.isReady()){if(A=T,a.markAsUnprocessed(),l)return a._areLightsDisposed=!0,!1}else o.resetCachedMaterial(),i.setEffect(A,a,this._materialContext)}return!i.effect||!i.effect.isReady()?!1:(a._renderId=o.getRenderId(),i.effect._wasPreviouslyReady=!0,i.effect._wasPreviouslyUsingInstances=n,!0)},e.prototype.buildUniformLayout=function(){var t=this._uniformBuffer;t.addUniform("diffuseLeftColor",4),t.addUniform("diffuseRightColor",4),t.addUniform("opacityParts",4),t.addUniform("reflectionLeftColor",4),t.addUniform("reflectionRightColor",4),t.addUniform("refractionLeftColor",4),t.addUniform("refractionRightColor",4),t.addUniform("emissiveLeftColor",4),t.addUniform("emissiveRightColor",4),t.addUniform("vDiffuseInfos",2),t.addUniform("vAmbientInfos",2),t.addUniform("vOpacityInfos",2),t.addUniform("vReflectionInfos",2),t.addUniform("vReflectionPosition",3),t.addUniform("vReflectionSize",3),t.addUniform("vEmissiveInfos",2),t.addUniform("vLightmapInfos",2),t.addUniform("vSpecularInfos",2),t.addUniform("vBumpInfos",3),t.addUniform("diffuseMatrix",16),t.addUniform("ambientMatrix",16),t.addUniform("opacityMatrix",16),t.addUniform("reflectionMatrix",16),t.addUniform("emissiveMatrix",16),t.addUniform("lightmapMatrix",16),t.addUniform("specularMatrix",16),t.addUniform("bumpMatrix",16),t.addUniform("vTangentSpaceParams",2),t.addUniform("pointSize",1),t.addUniform("alphaCutOff",1),t.addUniform("refractionMatrix",16),t.addUniform("vRefractionInfos",4),t.addUniform("vRefractionPosition",3),t.addUniform("vRefractionSize",3),t.addUniform("vSpecularColor",4),t.addUniform("vEmissiveColor",3),t.addUniform("vDiffuseColor",4),t.addUniform("vAmbientColor",3),r.prototype.buildUniformLayout.call(this)},e.prototype.bindForSubMesh=function(t,i,n){var o,a=this.getScene(),s=n.materialDefines;if(!!s){var f=n.effect;if(!!f){this._activeEffect=f,i.getMeshUniformBuffer().bindToEffect(f,"Mesh"),i.transferToEffect(t),this._uniformBuffer.bindToEffect(f,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,a,i,t,this.isFrozen),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var u=this._mustRebind(a,f,i.visibility);se.BindBonesParameters(i,f);var l=this._uniformBuffer;if(u){if(this.bindViewProjection(f),!l.useUbo||!this.isFrozen||!l.isSync){if(e.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new de(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),a.texturesEnabled){if(this._diffuseTexture&&e.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&e.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),se.BindTextureMatrix(this._ambientTexture,l,"ambient")),this._opacityTexture&&e.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&e.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var h=this._reflectionTexture;l.updateVector3("vReflectionPosition",h.boundingBoxPosition),l.updateVector3("vReflectionSize",h.boundingBoxSize)}if(this._emissiveTexture&&e.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&e.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,l,"lightmap")),this._specularTexture&&e.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),se.BindTextureMatrix(this._specularTexture,l,"specular")),this._bumpTexture&&a.getEngine().getCaps().standardDerivatives&&e.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,l,"bump"),a._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&e.RefractionTextureEnabled){var c=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){var h=this._refractionTexture;l.updateVector3("vRefractionPosition",h.boundingBoxPosition),l.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),s.SPECULARTERM&&l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",e.EmissiveTextureEnabled?this.emissiveColor:de.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),a.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}a.texturesEnabled&&(this._diffuseTexture&&e.DiffuseTextureEnabled&&f.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&e.AmbientTextureEnabled&&f.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&e.OpacityTextureEnabled&&f.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&e.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?f.setTexture("reflectionCubeSampler",this._reflectionTexture):f.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&e.EmissiveTextureEnabled&&f.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&e.LightmapTextureEnabled&&f.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&e.SpecularTextureEnabled&&f.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&a.getEngine().getCaps().standardDerivatives&&e.BumpTextureEnabled&&f.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&e.RefractionTextureEnabled&&(this._refractionTexture.isCube?f.setTexture("refractionCubeSampler",this._refractionTexture):f.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(f),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),se.BindClipPlane(f,a),this.bindEyePosition(f)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(u||!this.isFrozen)&&(a.lightsEnabled&&!this._disableLighting&&se.BindLights(a,i,f,s,this._maxSimultaneousLights),(a.fogEnabled&&i.applyFog&&a.fogMode!==ue.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||i.receiveShadows||s.PREPASS)&&this.bindView(f),se.BindFogParameters(a,i,f),s.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(i,f),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((o=i.bakedVertexAnimationManager)===null||o===void 0||o.bind(f,s.INSTANCES)),this.useLogarithmicDepth&&se.BindLogDepth(s,f,a),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect),l.update()}}},e.prototype.getAnimatables=function(){var t=r.prototype.getAnimatables.call(this);return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&t.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&t.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&t.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&t.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&t.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&t.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&t.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&t.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&t.push(this._refractionTexture),t},e.prototype.getActiveTextures=function(){var t=r.prototype.getActiveTextures.call(this);return this._diffuseTexture&&t.push(this._diffuseTexture),this._ambientTexture&&t.push(this._ambientTexture),this._opacityTexture&&t.push(this._opacityTexture),this._reflectionTexture&&t.push(this._reflectionTexture),this._emissiveTexture&&t.push(this._emissiveTexture),this._specularTexture&&t.push(this._specularTexture),this._bumpTexture&&t.push(this._bumpTexture),this._lightmapTexture&&t.push(this._lightmapTexture),this._refractionTexture&&t.push(this._refractionTexture),t},e.prototype.hasTexture=function(t){return!!(r.prototype.hasTexture.call(this,t)||this._diffuseTexture===t||this._ambientTexture===t||this._opacityTexture===t||this._reflectionTexture===t||this._emissiveTexture===t||this._specularTexture===t||this._bumpTexture===t||this._lightmapTexture===t||this._refractionTexture===t)},e.prototype.dispose=function(t,i){var n,o,a,s,f,u,l,h,c;i&&((n=this._diffuseTexture)===null||n===void 0||n.dispose(),(o=this._ambientTexture)===null||o===void 0||o.dispose(),(a=this._opacityTexture)===null||a===void 0||a.dispose(),(s=this._reflectionTexture)===null||s===void 0||s.dispose(),(f=this._emissiveTexture)===null||f===void 0||f.dispose(),(u=this._specularTexture)===null||u===void 0||u.dispose(),(l=this._bumpTexture)===null||l===void 0||l.dispose(),(h=this._lightmapTexture)===null||h===void 0||h.dispose(),(c=this._refractionTexture)===null||c===void 0||c.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),r.prototype.dispose.call(this,t,i)},e.prototype.clone=function(t){var i=this,n=te.Clone(function(){return new e(t,i.getScene())},this);return n.name=t,n.id=t,this.stencil.copyTo(n.stencil),n},e.Parse=function(t,i,n){var o=te.Parse(function(){return new e(t.name,i)},t,i,n);return t.stencil&&o.stencil.parse(t.stencil,i,n),o},Object.defineProperty(e,"DiffuseTextureEnabled",{get:function(){return xe.DiffuseTextureEnabled},set:function(t){xe.DiffuseTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DetailTextureEnabled",{get:function(){return xe.DetailTextureEnabled},set:function(t){xe.DetailTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"AmbientTextureEnabled",{get:function(){return xe.AmbientTextureEnabled},set:function(t){xe.AmbientTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"OpacityTextureEnabled",{get:function(){return xe.OpacityTextureEnabled},set:function(t){xe.OpacityTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ReflectionTextureEnabled",{get:function(){return xe.ReflectionTextureEnabled},set:function(t){xe.ReflectionTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"EmissiveTextureEnabled",{get:function(){return xe.EmissiveTextureEnabled},set:function(t){xe.EmissiveTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"SpecularTextureEnabled",{get:function(){return xe.SpecularTextureEnabled},set:function(t){xe.SpecularTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BumpTextureEnabled",{get:function(){return xe.BumpTextureEnabled},set:function(t){xe.BumpTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LightmapTextureEnabled",{get:function(){return xe.LightmapTextureEnabled},set:function(t){xe.LightmapTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"RefractionTextureEnabled",{get:function(){return xe.RefractionTextureEnabled},set:function(t){xe.RefractionTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ColorGradingTextureEnabled",{get:function(){return xe.ColorGradingTextureEnabled},set:function(t){xe.ColorGradingTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"FresnelEnabled",{get:function(){return xe.FresnelEnabled},set:function(t){xe.FresnelEnabled=t},enumerable:!1,configurable:!0}),x([at("diffuseTexture")],e.prototype,"_diffuseTexture",void 0),x([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"diffuseTexture",void 0),x([at("ambientTexture")],e.prototype,"_ambientTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"ambientTexture",void 0),x([at("opacityTexture")],e.prototype,"_opacityTexture",void 0),x([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"opacityTexture",void 0),x([at("reflectionTexture")],e.prototype,"_reflectionTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionTexture",void 0),x([at("emissiveTexture")],e.prototype,"_emissiveTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"emissiveTexture",void 0),x([at("specularTexture")],e.prototype,"_specularTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"specularTexture",void 0),x([at("bumpTexture")],e.prototype,"_bumpTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"bumpTexture",void 0),x([at("lightmapTexture")],e.prototype,"_lightmapTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"lightmapTexture",void 0),x([at("refractionTexture")],e.prototype,"_refractionTexture",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"refractionTexture",void 0),x([Ht("ambient")],e.prototype,"ambientColor",void 0),x([Ht("diffuse")],e.prototype,"diffuseColor",void 0),x([Ht("specular")],e.prototype,"specularColor",void 0),x([Ht("emissive")],e.prototype,"emissiveColor",void 0),x([O()],e.prototype,"specularPower",void 0),x([O("useAlphaFromDiffuseTexture")],e.prototype,"_useAlphaFromDiffuseTexture",void 0),x([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"useAlphaFromDiffuseTexture",void 0),x([O("useEmissiveAsIllumination")],e.prototype,"_useEmissiveAsIllumination",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useEmissiveAsIllumination",void 0),x([O("linkEmissiveWithDiffuse")],e.prototype,"_linkEmissiveWithDiffuse",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"linkEmissiveWithDiffuse",void 0),x([O("useSpecularOverAlpha")],e.prototype,"_useSpecularOverAlpha",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useSpecularOverAlpha",void 0),x([O("useReflectionOverAlpha")],e.prototype,"_useReflectionOverAlpha",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useReflectionOverAlpha",void 0),x([O("disableLighting")],e.prototype,"_disableLighting",void 0),x([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"disableLighting",void 0),x([O("useObjectSpaceNormalMap")],e.prototype,"_useObjectSpaceNormalMap",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useObjectSpaceNormalMap",void 0),x([O("useParallax")],e.prototype,"_useParallax",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useParallax",void 0),x([O("useParallaxOcclusion")],e.prototype,"_useParallaxOcclusion",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useParallaxOcclusion",void 0),x([O()],e.prototype,"parallaxScaleBias",void 0),x([O("roughness")],e.prototype,"_roughness",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"roughness",void 0),x([O()],e.prototype,"indexOfRefraction",void 0),x([O()],e.prototype,"invertRefractionY",void 0),x([O()],e.prototype,"alphaCutOff",void 0),x([O("useLightmapAsShadowmap")],e.prototype,"_useLightmapAsShadowmap",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useLightmapAsShadowmap",void 0),x([ci("diffuseFresnelParameters")],e.prototype,"_diffuseFresnelParameters",void 0),x([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"diffuseFresnelParameters",void 0),x([ci("opacityFresnelParameters")],e.prototype,"_opacityFresnelParameters",void 0),x([ve("_markAllSubMeshesAsFresnelAndMiscDirty")],e.prototype,"opacityFresnelParameters",void 0),x([ci("reflectionFresnelParameters")],e.prototype,"_reflectionFresnelParameters",void 0),x([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"reflectionFresnelParameters",void 0),x([ci("refractionFresnelParameters")],e.prototype,"_refractionFresnelParameters",void 0),x([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"refractionFresnelParameters",void 0),x([ci("emissiveFresnelParameters")],e.prototype,"_emissiveFresnelParameters",void 0),x([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"emissiveFresnelParameters",void 0),x([O("useReflectionFresnelFromSpecular")],e.prototype,"_useReflectionFresnelFromSpecular",void 0),x([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"useReflectionFresnelFromSpecular",void 0),x([O("useGlossinessFromSpecularMapAlpha")],e.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useGlossinessFromSpecularMapAlpha",void 0),x([O("maxSimultaneousLights")],e.prototype,"_maxSimultaneousLights",void 0),x([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"maxSimultaneousLights",void 0),x([O("invertNormalMapX")],e.prototype,"_invertNormalMapX",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"invertNormalMapX",void 0),x([O("invertNormalMapY")],e.prototype,"_invertNormalMapY",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"invertNormalMapY",void 0),x([O("twoSidedLighting")],e.prototype,"_twoSidedLighting",void 0),x([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"twoSidedLighting",void 0),x([O()],e.prototype,"useLogarithmicDepth",null),e}(io);Ke("BABYLON.StandardMaterial",oo);ue.DefaultMaterialFactory=function(r){return new oo("default material",r)};v();v();v();var za={effect:null,subMesh:null},Xa=function(r){Y(e,r);function e(t,i,n,o,a){o===void 0&&(o={}),a===void 0&&(a=!0);var s=r.call(this,t,i,a)||this;return s._textures={},s._textureArrays={},s._externalTextures={},s._floats={},s._ints={},s._floatsArrays={},s._colors3={},s._colors3Arrays={},s._colors4={},s._colors4Arrays={},s._vectors2={},s._vectors3={},s._vectors4={},s._quaternions={},s._quaternionsArrays={},s._matrices={},s._matrixArrays={},s._matrices3x3={},s._matrices2x2={},s._vectors2Arrays={},s._vectors3Arrays={},s._vectors4Arrays={},s._uniformBuffers={},s._textureSamplers={},s._storageBuffers={},s._cachedWorldViewMatrix=new B,s._cachedWorldViewProjectionMatrix=new B,s._multiview=!1,s._shaderPath=n,s._options=Vt({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},o),s}return Object.defineProperty(e.prototype,"shaderPath",{get:function(){return this._shaderPath},set:function(t){this._shaderPath=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ShaderMaterial"},e.prototype.needAlphaBlending=function(){return this.alpha<1||this._options.needAlphaBlending},e.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},e.prototype._checkUniform=function(t){this._options.uniforms.indexOf(t)===-1&&this._options.uniforms.push(t)},e.prototype.setTexture=function(t,i){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._textures[t]=i,this},e.prototype.setTextureArray=function(t,i){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._checkUniform(t),this._textureArrays[t]=i,this},e.prototype.setExternalTexture=function(t,i){return this._options.externalTextures.indexOf(t)===-1&&this._options.externalTextures.push(t),this._externalTextures[t]=i,this},e.prototype.setFloat=function(t,i){return this._checkUniform(t),this._floats[t]=i,this},e.prototype.setInt=function(t,i){return this._checkUniform(t),this._ints[t]=i,this},e.prototype.setFloats=function(t,i){return this._checkUniform(t),this._floatsArrays[t]=i,this},e.prototype.setColor3=function(t,i){return this._checkUniform(t),this._colors3[t]=i,this},e.prototype.setColor3Array=function(t,i){return this._checkUniform(t),this._colors3Arrays[t]=i.reduce(function(n,o){return o.toArray(n,n.length),n},[]),this},e.prototype.setColor4=function(t,i){return this._checkUniform(t),this._colors4[t]=i,this},e.prototype.setColor4Array=function(t,i){return this._checkUniform(t),this._colors4Arrays[t]=i.reduce(function(n,o){return o.toArray(n,n.length),n},[]),this},e.prototype.setVector2=function(t,i){return this._checkUniform(t),this._vectors2[t]=i,this},e.prototype.setVector3=function(t,i){return this._checkUniform(t),this._vectors3[t]=i,this},e.prototype.setVector4=function(t,i){return this._checkUniform(t),this._vectors4[t]=i,this},e.prototype.setQuaternion=function(t,i){return this._checkUniform(t),this._quaternions[t]=i,this},e.prototype.setQuaternionArray=function(t,i){return this._checkUniform(t),this._quaternionsArrays[t]=i.reduce(function(n,o){return o.toArray(n,n.length),n},[]),this},e.prototype.setMatrix=function(t,i){return this._checkUniform(t),this._matrices[t]=i,this},e.prototype.setMatrices=function(t,i){this._checkUniform(t);for(var n=new Float32Array(i.length*16),o=0;o<i.length;o++){var a=i[o];a.copyToArray(n,o*16)}return this._matrixArrays[t]=n,this},e.prototype.setMatrix3x3=function(t,i){return this._checkUniform(t),this._matrices3x3[t]=i,this},e.prototype.setMatrix2x2=function(t,i){return this._checkUniform(t),this._matrices2x2[t]=i,this},e.prototype.setArray2=function(t,i){return this._checkUniform(t),this._vectors2Arrays[t]=i,this},e.prototype.setArray3=function(t,i){return this._checkUniform(t),this._vectors3Arrays[t]=i,this},e.prototype.setArray4=function(t,i){return this._checkUniform(t),this._vectors4Arrays[t]=i,this},e.prototype.setUniformBuffer=function(t,i){return this._options.uniformBuffers.indexOf(t)===-1&&this._options.uniformBuffers.push(t),this._uniformBuffers[t]=i,this},e.prototype.setTextureSampler=function(t,i){return this._options.samplerObjects.indexOf(t)===-1&&this._options.samplerObjects.push(t),this._textureSamplers[t]=i,this},e.prototype.setStorageBuffer=function(t,i){return this._options.storageBuffers.indexOf(t)===-1&&this._options.storageBuffers.push(t),this._storageBuffers[t]=i,this},e.prototype.isReadyForSubMesh=function(t,i,n){return this.isReady(t,n,i)},e.prototype.isReady=function(t,i,n){var o,a,s,f,u=n&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(u){if(n.effect&&n.effect._wasPreviouslyReady)return!0}else{var l=this._drawWrapper.effect;if(l&&l._wasPreviouslyReady&&l._wasPreviouslyUsingInstances===i)return!0}var h=this.getScene(),c=h.getEngine(),p=[],d=[],m=new no,_=this._shaderPath,y=this._options.uniforms,g=this._options.uniformBuffers,T=this._options.samplers;c.getCaps().multiview&&h.activeCamera&&h.activeCamera.outputRenderTarget&&h.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,p.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(var A=0;A<this._options.defines.length;A++){var M=this._options.defines[A].indexOf("#define")===0?this._options.defines[A]:"#define ".concat(this._options.defines[A]);p.push(M)}for(var A=0;A<this._options.attributes.length;A++)d.push(this._options.attributes[A]);if(t&&t.isVerticesDataPresent(b.ColorKind)&&(d.push(b.ColorKind),p.push("#define VERTEXCOLOR")),i&&(p.push("#define INSTANCES"),se.PushAttributesForInstances(d),t!=null&&t.hasThinInstances&&(p.push("#define THIN_INSTANCES"),t&&t.isVerticesDataPresent(b.ColorInstanceKind)&&(d.push(b.ColorInstanceKind),p.push("#define INSTANCESCOLOR")))),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton){d.push(b.MatricesIndicesKind),d.push(b.MatricesWeightsKind),t.numBoneInfluencers>4&&(d.push(b.MatricesIndicesExtraKind),d.push(b.MatricesWeightsExtraKind));var C=t.skeleton;p.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers),m.addCPUSkinningFallback(0,t),C.isUsingTextureForMatrices?(p.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(p.push("#define BonesPerMesh "+(C.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else p.push("#define NUM_BONE_INFLUENCERS 0");var P=0,R=t?t.morphTargetManager:null;if(R){var F=R.supportsUVs&&p.indexOf("#define UV1")!==-1,I=R.supportsTangents&&p.indexOf("#define TANGENT")!==-1,D=R.supportsNormals&&p.indexOf("#define NORMAL")!==-1;P=R.numInfluencers,F&&p.push("#define MORPHTARGETS_UV"),I&&p.push("#define MORPHTARGETS_TANGENT"),D&&p.push("#define MORPHTARGETS_NORMAL"),P>0&&p.push("#define MORPHTARGETS"),R.isUsingTextureForTargets&&(p.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),p.push("#define NUM_MORPH_INFLUENCERS "+P);for(var A=0;A<P;A++)d.push(b.PositionKind+A),D&&d.push(b.NormalKind+A),I&&d.push(b.TangentKind+A),F&&d.push(b.UVKind+"_"+A);P>0&&(y=y.slice(),y.push("morphTargetInfluences"),y.push("morphTargetTextureInfo"),y.push("morphTargetTextureIndices"))}else p.push("#define NUM_MORPH_INFLUENCERS 0");if(t){var V=t.bakedVertexAnimationManager;V&&V.isEnabled&&(p.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),se.PrepareAttributesForBakedVertexAnimation(d,t,p)}for(var k in this._textures)if(!this._textures[k].isReady())return!1;t&&this._shouldTurnAlphaTestOn(t)&&p.push("#define ALPHATEST"),(this._options.useClipPlane===null&&!!h.clipPlane||this._options.useClipPlane)&&(p.push("#define CLIPPLANE"),y.indexOf("vClipPlane")===-1&&y.push("vClipPlane")),(this._options.useClipPlane===null&&!!h.clipPlane2||this._options.useClipPlane)&&(p.push("#define CLIPPLANE2"),y.indexOf("vClipPlane2")===-1&&y.push("vClipPlane2")),(this._options.useClipPlane===null&&!!h.clipPlane3||this._options.useClipPlane)&&(p.push("#define CLIPPLANE3"),y.indexOf("vClipPlane3")===-1&&y.push("vClipPlane3")),(this._options.useClipPlane===null&&!!h.clipPlane4||this._options.useClipPlane)&&(p.push("#define CLIPPLANE4"),y.indexOf("vClipPlane4")===-1&&y.push("vClipPlane4")),(this._options.useClipPlane===null&&!!h.clipPlane5||this._options.useClipPlane)&&(p.push("#define CLIPPLANE5"),y.indexOf("vClipPlane5")===-1&&y.push("vClipPlane5")),(this._options.useClipPlane===null&&!!h.clipPlane6||this._options.useClipPlane)&&(p.push("#define CLIPPLANE6"),y.indexOf("vClipPlane6")===-1&&y.push("vClipPlane6")),this.customShaderNameResolve&&(y=y.slice(),g=g.slice(),T=T.slice(),_=this.customShaderNameResolve(_,y,g,T,p,d));var w=u?n._getDrawWrapper():this._drawWrapper,G=(o=w==null?void 0:w.effect)!==null&&o!==void 0?o:null,K=(a=w==null?void 0:w.defines)!==null&&a!==void 0?a:null,j=p.join(`
`),W=G;return K!==j&&(W=c.createEffect(_,{attributes:d,uniformsNames:y,uniformBuffersNames:g,samplers:T,defines:j,fallbacks:m,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:P},shaderLanguage:this._options.shaderLanguage},c),u?n.setEffect(W,j,this._materialContext):w&&w.setEffect(W,j),this._onEffectCreatedObservable&&(za.effect=W,za.subMesh=(s=n!=null?n:t==null?void 0:t.subMeshes[0])!==null&&s!==void 0?s:null,this._onEffectCreatedObservable.notifyObservers(za))),W._wasPreviouslyUsingInstances=!!i,!((f=!(W!=null&&W.isReady()))!==null&&f!==void 0)||f?!1:(G!==W&&h.resetCachedMaterial(),W._wasPreviouslyReady=!0,!0)},e.prototype.bindOnlyWorldMatrix=function(t,i){var n=this.getScene(),o=i!=null?i:this.getEffect();!o||(this._options.uniforms.indexOf("world")!==-1&&o.setMatrix("world",t),this._options.uniforms.indexOf("worldView")!==-1&&(t.multiplyToRef(n.getViewMatrix(),this._cachedWorldViewMatrix),o.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(t.multiplyToRef(n.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),o.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))},e.prototype.bindForSubMesh=function(t,i,n){var o;this.bind(t,i,(o=n._drawWrapperOverride)===null||o===void 0?void 0:o.effect,n)},e.prototype.bind=function(t,i,n,o){var a,s=o&&this._storeEffectOnSubMeshes,f=n!=null?n:s?o.effect:this.getEffect();if(!!f){this._activeEffect=f,this.bindOnlyWorldMatrix(t,n);var u=this._options.uniformBuffers,l=!1;if(f&&u&&u.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(var h=0;h<u.length;++h){var c=u[h];switch(c){case"Mesh":i&&(i.getMeshUniformBuffer().bindToEffect(f,"Mesh"),i.transferToEffect(t));break;case"Scene":se.BindSceneUniformBuffer(f,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),l=!0;break}}var p=i&&s?this._mustRebind(this.getScene(),f,i.visibility):this.getScene().getCachedMaterial()!==this;if(f&&p){!l&&this._options.uniforms.indexOf("view")!==-1&&f.setMatrix("view",this.getScene().getViewMatrix()),!l&&this._options.uniforms.indexOf("projection")!==-1&&f.setMatrix("projection",this.getScene().getProjectionMatrix()),!l&&this._options.uniforms.indexOf("viewProjection")!==-1&&(f.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&f.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&f.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),se.BindBonesParameters(i,f),se.BindClipPlane(f,this.getScene());var d;for(d in this._textures)f.setTexture(d,this._textures[d]);for(d in this._textureArrays)f.setTextureArray(d,this._textureArrays[d]);for(d in this._externalTextures)f.setExternalTexture(d,this._externalTextures[d]);for(d in this._ints)f.setInt(d,this._ints[d]);for(d in this._floats)f.setFloat(d,this._floats[d]);for(d in this._floatsArrays)f.setArray(d,this._floatsArrays[d]);for(d in this._colors3)f.setColor3(d,this._colors3[d]);for(d in this._colors3Arrays)f.setArray3(d,this._colors3Arrays[d]);for(d in this._colors4){var m=this._colors4[d];f.setFloat4(d,m.r,m.g,m.b,m.a)}for(d in this._colors4Arrays)f.setArray4(d,this._colors4Arrays[d]);for(d in this._vectors2)f.setVector2(d,this._vectors2[d]);for(d in this._vectors3)f.setVector3(d,this._vectors3[d]);for(d in this._vectors4)f.setVector4(d,this._vectors4[d]);for(d in this._quaternions)f.setQuaternion(d,this._quaternions[d]);for(d in this._matrices)f.setMatrix(d,this._matrices[d]);for(d in this._matrixArrays)f.setMatrices(d,this._matrixArrays[d]);for(d in this._matrices3x3)f.setMatrix3x3(d,this._matrices3x3[d]);for(d in this._matrices2x2)f.setMatrix2x2(d,this._matrices2x2[d]);for(d in this._vectors2Arrays)f.setArray2(d,this._vectors2Arrays[d]);for(d in this._vectors3Arrays)f.setArray3(d,this._vectors3Arrays[d]);for(d in this._vectors4Arrays)f.setArray4(d,this._vectors4Arrays[d]);for(d in this._quaternionsArrays)f.setArray4(d,this._quaternionsArrays[d]);for(d in this._uniformBuffers){var _=this._uniformBuffers[d].getBuffer();_&&f.bindUniformBuffer(_,d)}for(d in this._textureSamplers)f.setTextureSampler(d,this._textureSamplers[d]);for(d in this._storageBuffers)f.setStorageBuffer(d,this._storageBuffers[d])}if(f&&i&&(p||!this.isFrozen)){var y=i.morphTargetManager;y&&y.numInfluencers>0&&se.BindMorphTargetParameters(i,f);var g=i.bakedVertexAnimationManager;g&&g.isEnabled&&((a=i.bakedVertexAnimationManager)===null||a===void 0||a.bind(f,!!f._wasPreviouslyUsingInstances))}this._afterBind(i,f)}},e.prototype.getActiveTextures=function(){var t=r.prototype.getActiveTextures.call(this);for(var i in this._textures)t.push(this._textures[i]);for(var n in this._textureArrays)for(var o=this._textureArrays[n],a=0;a<o.length;a++)t.push(o[a]);return t},e.prototype.hasTexture=function(t){if(r.prototype.hasTexture.call(this,t))return!0;for(var i in this._textures)if(this._textures[i]===t)return!0;for(var n in this._textureArrays)for(var o=this._textureArrays[n],a=0;a<o.length;a++)if(o[a]===t)return!0;return!1},e.prototype.clone=function(t){var i=this,n=te.Clone(function(){return new e(t,i.getScene(),i._shaderPath,i._options,i._storeEffectOnSubMeshes)},this);n.name=t,n.id=t,typeof n._shaderPath=="object"&&(n._shaderPath=Vt({},n._shaderPath)),this._options=Vt({},this._options),Object.keys(this._options).forEach(function(a){var s=i._options[a];Array.isArray(s)&&(i._options[a]=s.slice(0))}),this.stencil.copyTo(n.stencil);for(var o in this._textures)n.setTexture(o,this._textures[o]);for(var o in this._textureArrays)n.setTextureArray(o,this._textureArrays[o]);for(var o in this._externalTextures)n.setExternalTexture(o,this._externalTextures[o]);for(var o in this._ints)n.setInt(o,this._ints[o]);for(var o in this._floats)n.setFloat(o,this._floats[o]);for(var o in this._floatsArrays)n.setFloats(o,this._floatsArrays[o]);for(var o in this._colors3)n.setColor3(o,this._colors3[o]);for(var o in this._colors3Arrays)n._colors3Arrays[o]=this._colors3Arrays[o];for(var o in this._colors4)n.setColor4(o,this._colors4[o]);for(var o in this._colors4Arrays)n._colors4Arrays[o]=this._colors4Arrays[o];for(var o in this._vectors2)n.setVector2(o,this._vectors2[o]);for(var o in this._vectors3)n.setVector3(o,this._vectors3[o]);for(var o in this._vectors4)n.setVector4(o,this._vectors4[o]);for(var o in this._quaternions)n.setQuaternion(o,this._quaternions[o]);for(var o in this._quaternionsArrays)n._quaternionsArrays[o]=this._quaternionsArrays[o];for(var o in this._matrices)n.setMatrix(o,this._matrices[o]);for(var o in this._matrixArrays)n._matrixArrays[o]=this._matrixArrays[o].slice();for(var o in this._matrices3x3)n.setMatrix3x3(o,this._matrices3x3[o]);for(var o in this._matrices2x2)n.setMatrix2x2(o,this._matrices2x2[o]);for(var o in this._vectors2Arrays)n.setArray2(o,this._vectors2Arrays[o]);for(var o in this._vectors3Arrays)n.setArray3(o,this._vectors3Arrays[o]);for(var o in this._vectors4Arrays)n.setArray4(o,this._vectors4Arrays[o]);for(var o in this._uniformBuffers)n.setUniformBuffer(o,this._uniformBuffers[o]);for(var o in this._textureSamplers)n.setTextureSampler(o,this._textureSamplers[o]);for(var o in this._storageBuffers)n.setStorageBuffer(o,this._storageBuffers[o]);return n},e.prototype.dispose=function(t,i,n){if(i){var o;for(o in this._textures)this._textures[o].dispose();for(o in this._textureArrays)for(var a=this._textureArrays[o],s=0;s<a.length;s++)a[s].dispose()}this._textures={},r.prototype.dispose.call(this,t,i,n)},e.prototype.serialize=function(){var t=te.Serialize(this);t.customType="BABYLON.ShaderMaterial",t.uniqueId=this.uniqueId,t.options=this._options,t.shaderPath=this._shaderPath,t.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;var i;t.stencil=this.stencil.serialize(),t.textures={};for(i in this._textures)t.textures[i]=this._textures[i].serialize();t.textureArrays={};for(i in this._textureArrays){t.textureArrays[i]=[];for(var n=this._textureArrays[i],o=0;o<n.length;o++)t.textureArrays[i].push(n[o].serialize())}t.ints={};for(i in this._ints)t.ints[i]=this._ints[i];t.floats={};for(i in this._floats)t.floats[i]=this._floats[i];t.FloatArrays={};for(i in this._floatsArrays)t.FloatArrays[i]=this._floatsArrays[i];t.colors3={};for(i in this._colors3)t.colors3[i]=this._colors3[i].asArray();t.colors3Arrays={};for(i in this._colors3Arrays)t.colors3Arrays[i]=this._colors3Arrays[i];t.colors4={};for(i in this._colors4)t.colors4[i]=this._colors4[i].asArray();t.colors4Arrays={};for(i in this._colors4Arrays)t.colors4Arrays[i]=this._colors4Arrays[i];t.vectors2={};for(i in this._vectors2)t.vectors2[i]=this._vectors2[i].asArray();t.vectors3={};for(i in this._vectors3)t.vectors3[i]=this._vectors3[i].asArray();t.vectors4={};for(i in this._vectors4)t.vectors4[i]=this._vectors4[i].asArray();t.quaternions={};for(i in this._quaternions)t.quaternions[i]=this._quaternions[i].asArray();t.matrices={};for(i in this._matrices)t.matrices[i]=this._matrices[i].asArray();t.matrixArray={};for(i in this._matrixArrays)t.matrixArray[i]=this._matrixArrays[i];t.matrices3x3={};for(i in this._matrices3x3)t.matrices3x3[i]=this._matrices3x3[i];t.matrices2x2={};for(i in this._matrices2x2)t.matrices2x2[i]=this._matrices2x2[i];t.vectors2Arrays={};for(i in this._vectors2Arrays)t.vectors2Arrays[i]=this._vectors2Arrays[i];t.vectors3Arrays={};for(i in this._vectors3Arrays)t.vectors3Arrays[i]=this._vectors3Arrays[i];t.vectors4Arrays={};for(i in this._vectors4Arrays)t.vectors4Arrays[i]=this._vectors4Arrays[i];t.quaternionsArrays={};for(i in this._quaternionsArrays)t.quaternionsArrays[i]=this._quaternionsArrays[i];return t},e.Parse=function(t,i,n){var o=te.Parse(function(){return new e(t.name,i,t.shaderPath,t.options,t.storeEffectOnSubMeshes)},t,i,n),a;t.stencil&&o.stencil.parse(t.stencil,i,n);for(a in t.textures)o.setTexture(a,Ie.Parse(t.textures[a],i,n));for(a in t.textureArrays){for(var s=t.textureArrays[a],f=new Array,u=0;u<s.length;u++)f.push(Ie.Parse(s[u],i,n));o.setTextureArray(a,f)}for(a in t.ints)o.setInt(a,t.ints[a]);for(a in t.floats)o.setFloat(a,t.floats[a]);for(a in t.floatsArrays)o.setFloats(a,t.floatsArrays[a]);for(a in t.colors3)o.setColor3(a,de.FromArray(t.colors3[a]));for(a in t.colors3Arrays){var l=t.colors3Arrays[a].reduce(function(h,c,p){return p%3===0?h.push([c]):h[h.length-1].push(c),h},[]).map(function(h){return de.FromArray(h)});o.setColor3Array(a,l)}for(a in t.colors4)o.setColor4(a,Ae.FromArray(t.colors4[a]));for(a in t.colors4Arrays){var l=t.colors4Arrays[a].reduce(function(c,p,d){return d%4===0?c.push([p]):c[c.length-1].push(p),c},[]).map(function(c){return Ae.FromArray(c)});o.setColor4Array(a,l)}for(a in t.vectors2)o.setVector2(a,_e.FromArray(t.vectors2[a]));for(a in t.vectors3)o.setVector3(a,E.FromArray(t.vectors3[a]));for(a in t.vectors4)o.setVector4(a,It.FromArray(t.vectors4[a]));for(a in t.quaternions)o.setQuaternion(a,ie.FromArray(t.quaternions[a]));for(a in t.matrices)o.setMatrix(a,B.FromArray(t.matrices[a]));for(a in t.matrixArray)o._matrixArrays[a]=new Float32Array(t.matrixArray[a]);for(a in t.matrices3x3)o.setMatrix3x3(a,t.matrices3x3[a]);for(a in t.matrices2x2)o.setMatrix2x2(a,t.matrices2x2[a]);for(a in t.vectors2Arrays)o.setArray2(a,t.vectors2Arrays[a]);for(a in t.vectors3Arrays)o.setArray3(a,t.vectors3Arrays[a]);for(a in t.vectors4Arrays)o.setArray4(a,t.vectors4Arrays[a]);for(a in t.quaternionsArrays)o.setArray4(a,t.quaternionsArrays[a]);return o},e.ParseFromFileAsync=function(t,i,n,o){var a=this;return o===void 0&&(o=""),new Promise(function(s,f){var u=new er;u.addEventListener("readystatechange",function(){if(u.readyState==4)if(u.status==200){var l=JSON.parse(u.responseText),h=a.Parse(l,n||le.LastCreatedScene,o);t&&(h.name=t),s(h)}else f("Unable to load the ShaderMaterial")}),u.open("GET",i),u.send()})},e.ParseFromSnippetAsync=function(t,i,n){var o=this;return n===void 0&&(n=""),new Promise(function(a,s){var f=new er;f.addEventListener("readystatechange",function(){if(f.readyState==4)if(f.status==200){var u=JSON.parse(JSON.parse(f.responseText).jsonPayload),l=JSON.parse(u.shaderMaterial),h=o.Parse(l,i||le.LastCreatedScene,n);h.snippetId=t,a(h)}else s("Unable to load the snippet "+t)}),f.open("GET",o.SnippetUrl+"/"+t.replace(/#/g,"/")),f.send()})},e.SnippetUrl="https://snippet.babylonjs.com",e.CreateFromSnippetAsync=e.ParseFromSnippetAsync,e}(io);Ke("BABYLON.ShaderMaterial",Xa);v();var dy="colorPixelShader",py=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;N.ShadersStore[dy]=py;v();var _y="colorVertexShader",vy=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;N.ShadersStore[_y]=vy;H._LinesMeshParser=function(r,e){return ao.Parse(r,e)};var ao=function(r){Y(e,r);function e(t,i,n,o,a,s,f,u){i===void 0&&(i=null),n===void 0&&(n=null),o===void 0&&(o=null);var l=r.call(this,t,i,n,o,a)||this;l.useVertexColor=s,l.useVertexAlpha=f,l.color=new de(1,1,1),l.alpha=1,o&&(l.color=o.color.clone(),l.alpha=o.alpha,l.useVertexColor=o.useVertexColor,l.useVertexAlpha=o.useVertexAlpha),l.intersectionThreshold=.1;var h=[],c={attributes:[b.PositionKind],uniforms:["vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","world","viewProjection"],needAlphaBlending:!0,defines:h,useClipPlane:null};return f===!1?c.needAlphaBlending=!1:c.defines.push("#define VERTEXALPHA"),s?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(b.ColorKind)):(c.uniforms.push("color"),l._color4=new Ae),u?l.material=u:l.material=new Xa("colorShader",l.getScene(),"color",c,!1),l}return e.prototype._isShaderMaterial=function(t){return t.getClassName()==="ShaderMaterial"},e.prototype.isReady=function(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?r.prototype.isReady.call(this):!1},e.prototype.getClassName=function(){return"LinesMesh"},Object.defineProperty(e.prototype,"material",{get:function(){return this._lineMaterial},set:function(t){this._lineMaterial=t,this._lineMaterial.fillMode=De.LineListDrawMode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"checkCollisions",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),e.prototype._bind=function(){if(!this._geometry)return this;var t=this._lineMaterial.getEffect(),i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,i),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){var n=this.color,o=n.r,a=n.g,s=n.b;this._color4.set(o,a,s,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this},e.prototype._draw=function(t,i,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var o=this.getScene().getEngine();return this._unIndexed?o.drawArraysType(De.LineListDrawMode,t.verticesStart,t.verticesCount,n):o.drawElementsType(De.LineListDrawMode,t.indexStart,t.indexCount,n),this},e.prototype.dispose=function(t){this._lineMaterial.dispose(!1,!1,!0),r.prototype.dispose.call(this,t)},e.prototype.clone=function(t,i,n){return i===void 0&&(i=null),new e(t,this.getScene(),i,this,n)},e.prototype.createInstance=function(t){var i=new my(t,this);if(this.instancedBuffers){i.instancedBuffers={};for(var n in this.instancedBuffers)i.instancedBuffers[n]=this.instancedBuffers[n]}return i},e.prototype.serialize=function(t){r.prototype.serialize.call(this,t),t.color=this.color.asArray(),t.alpha=this.alpha},e.Parse=function(t,i){var n=new e(t.name,i);return n.color=de.FromArray(t.color),n.alpha=t.alpha,n},e}(H);var my=function(r){Y(e,r);function e(t,i){var n=r.call(this,t,i)||this;return n.intersectionThreshold=i.intersectionThreshold,n}return e.prototype.getClassName=function(){return"InstancedLinesMesh"},e}(xa);function Pc(r){for(var e=[],t=[],i=r.lines,n=r.colors,o=[],a=0,s=0;s<i.length;s++)for(var f=i[s],u=0;u<f.length;u++){if(t.push(f[u].x,f[u].y,f[u].z),n){var l=n[s];o.push(l[u].r,l[u].g,l[u].b,l[u].a)}u>0&&(e.push(a-1),e.push(a)),a++}var h=new re;return h.indices=e,h.positions=t,n&&(h.colors=o),h}function Cc(r){var e=r.dashSize||3,t=r.gapSize||1,i=r.dashNb||200,n=r.points,o=new Array,a=new Array,s=E.Zero(),f=0,u=0,l=0,h=0,c=0,p=0,d=0;for(d=0;d<n.length-1;d++)n[d+1].subtractToRef(n[d],s),f+=s.length();for(l=f/i,h=e*l/(e+t),d=0;d<n.length-1;d++){n[d+1].subtractToRef(n[d],s),u=Math.floor(s.length()/l),s.normalize();for(var m=0;m<u;m++)c=l*m,o.push(n[d].x+c*s.x,n[d].y+c*s.y,n[d].z+c*s.z),o.push(n[d].x+(c+h)*s.x,n[d].y+(c+h)*s.y,n[d].z+(c+h)*s.z),a.push(p,p+1),p+=2}var _=new re;return _.positions=o,_.indices=a,_}function gy(r,e,t){var i=e.instance,n=e.lines,o=e.colors;if(i){var a=i.getVerticesData(b.PositionKind),s=void 0,f=void 0;o&&(s=i.getVerticesData(b.ColorKind));for(var u=0,l=0,h=0;h<n.length;h++)for(var c=n[h],p=0;p<c.length;p++)a[u]=c[p].x,a[u+1]=c[p].y,a[u+2]=c[p].z,o&&s&&(f=o[h],s[l]=f[p].r,s[l+1]=f[p].g,s[l+2]=f[p].b,s[l+3]=f[p].a,l+=4),u+=3;return i.updateVerticesData(b.PositionKind,a,!1,!1),o&&s&&i.updateVerticesData(b.ColorKind,s,!1,!1),i}var d=!!o,m=new ao(r,t,null,void 0,void 0,d,e.useVertexAlpha,e.material),_=Pc(e);return _.applyToMesh(m,e.updatable),m}function Ha(r,e,t){t===void 0&&(t=null);var i=e.colors?[e.colors]:null,n=gy(r,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t);return n}function yy(r,e,t){t===void 0&&(t=null);var i=e.points,n=e.instance,o=e.gapSize||1,a=e.dashSize||3;if(n){var s=function(l){var h=E.Zero(),c=l.length/6,p=0,d=0,m=0,_=0,y=0,g=0,T=0,A=0;for(T=0;T<i.length-1;T++)i[T+1].subtractToRef(i[T],h),p+=h.length();m=p/c;var M=n._creationDataStorage.dashSize,C=n._creationDataStorage.gapSize;for(_=M*m/(M+C),T=0;T<i.length-1;T++)for(i[T+1].subtractToRef(i[T],h),d=Math.floor(h.length()/m),h.normalize(),A=0;A<d&&g<l.length;)y=m*A,l[g]=i[T].x+y*h.x,l[g+1]=i[T].y+y*h.y,l[g+2]=i[T].z+y*h.z,l[g+3]=i[T].x+(y+_)*h.x,l[g+4]=i[T].y+(y+_)*h.y,l[g+5]=i[T].z+(y+_)*h.z,g+=6,A++;for(;g<l.length;)l[g]=i[T].x,l[g+1]=i[T].y,l[g+2]=i[T].z,g+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&q.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),n.updateMeshPositions(s,!1),n}var f=new ao(r,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material),u=Cc(e);return u.applyToMesh(f,e.updatable),f._creationDataStorage=new Qh,f._creationDataStorage.dashSize=a,f._creationDataStorage.gapSize=o,f}re.CreateLineSystem=Pc;re.CreateDashedLines=Cc;H.CreateLines=function(r,e,t,i,n){t===void 0&&(t=null),i===void 0&&(i=!1),n===void 0&&(n=null);var o={points:e,updatable:i,instance:n};return Ha(r,o,t)};H.CreateDashedLines=function(r,e,t,i,n,o,a,s){o===void 0&&(o=null);var f={points:e,dashSize:t,gapSize:i,dashNb:n,updatable:a,instance:s};return yy(r,f,o)};v();function Ic(r){var e=[],t=[],i=[],n=[],o=r.width||r.size||1,a=r.height||r.size||1,s=r.sideOrientation===0?0:r.sideOrientation||re.DEFAULTSIDE,f=o/2,u=a/2;t.push(-f,-u,0),i.push(0,0,-1),n.push(0,Oe.UseOpenGLOrientationForUV?1:0),t.push(f,-u,0),i.push(0,0,-1),n.push(1,Oe.UseOpenGLOrientationForUV?1:0),t.push(f,u,0),i.push(0,0,-1),n.push(1,Oe.UseOpenGLOrientationForUV?0:1),t.push(-f,u,0),i.push(0,0,-1),n.push(0,Oe.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),re._ComputeSides(s,t,e,i,n,r.frontUVs,r.backUVs);var l=new re;return l.indices=e,l.positions=t,l.normals=i,l.uvs=n,l}function bi(r,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var i=new H(r,t);e.sideOrientation=H._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation;var n=Ic(e);return n.applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}re.CreatePlane=Ic;H.CreatePlane=function(r,e,t,i,n){var o={size:e,width:e,height:e,sideOrientation:n,updatable:i};return bi(r,o,t)};Ut();var by=Tt(),Ey=0,Ty={showFPS:!1,antiAlias:!0,clearColor:[.8,.9,1],ambientColor:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],groundLightColor:[.5,.5,.5],useAO:!0,AOmultipliers:[.93,.8,.5],reverseAOmultiplier:1,preserveDrawingBuffer:!0,octreeBlockSize:2,renderOnResize:!0},Qe=class{constructor(e,t,i){t=Object.assign({},Ty,t),this.noa=e,this.renderOnResize=!!t.renderOnResize,this.useAO=!!t.useAO,this.aoVals=t.AOmultipliers,this.revAoVal=t.reverseAOmultiplier,this.meshingCutoffTime=6,this._scene=null,this._engine=null,this._octreeManager=null,this.initScene(i,t),t.showFPS&&Ry()}initScene(e,t){this._engine=new Re(e,t.antiAlias,{preserveDrawingBuffer:t.preserveDrawingBuffer}),this._scene=new ue(this._engine);var i=this._scene;i.detachControl();var n=Math.round(t.octreeBlockSize);this._octreeManager=new to(this,n),this._cameraHolder=new rt("camHolder",i),this._camera=new Rc("camera",new E(0,0,0),i),this._camera.parent=this._cameraHolder,this._camera.minZ=.01,this._camScreen=bi("camScreen",{size:10},i),this.addMeshToScene(this._camScreen),this._camScreen.position.z=.1,this._camScreen.parent=this._camera,this._camScreenMat=this.makeStandardMaterial("camscreenmat"),this._camScreen.material=this._camScreenMat,this._camScreen.setEnabled(!1),this._camScreenMat.freeze(),this._camLocBlock=0;var o=new E(.1,1,.3);this._light=new Wa("light",o,i);function a(s){return new de(s[0],s[1],s[2])}i.clearColor=Ae.FromColor3(a(t.clearColor)),i.ambientColor=a(t.ambientColor),this._light.diffuse=a(t.lightDiffuse),this._light.specular=a(t.lightSpecular),this._light.groundColor=a(t.groundLightColor),i.skipPointerMovePicking=!0}};Qe.prototype.getScene=function(){return this._scene};Qe.prototype.tick=function(r){};Qe.prototype.render=function(){Ei("start"),Ay(this),Ei("updateCamera"),this._engine.beginFrame(),Ei("beginFrame"),this._scene.render(),Ei("render"),Dc(),this._engine.endFrame(),Ei("endFrame"),Ei("end")};Qe.prototype.postRender=function(){};Qe.prototype.resize=function(){this._engine.resize(),this.noa._paused&&this.renderOnResize&&this._scene.render()};Qe.prototype.highlightBlockFace=function(r,e,t){var i=My(this);if(r){this.noa.globalToLocal(e,null,Ur);for(var n=by.dist(this.noa.camera._localGetPosition(),Ur),o=.001+.001*n,a=0;a<3;a++)t[a]===0?Ur[a]+=.5:Ur[a]+=t[a]>0?1+o:-o;i.position.copyFromFloats(Ur[0],Ur[1],Ur[2]),i.rotation.x=t[1]?Math.PI/2:0,i.rotation.y=t[0]?Math.PI/2:0}i.setEnabled(r)};var Ur=[];Qe.prototype.addMeshToScene=function(r,e=!1,t=null,i=null){if(!this._octreeManager.includesMesh(r)){if(!r.parent){t||(t=[r.position.x,r.position.y,r.position.z]);var n=[];this.noa.globalToLocal(t,null,n),r.position.copyFromFloats(n[0],n[1],n[2])}e&&(r.freezeWorldMatrix(),r.freezeNormals&&r.freezeNormals(),r.doNotSyncBoundingInfo=!0),this._octreeManager.addMesh(r,e,t,i),r.onDisposeObservable.add(()=>{this._octreeManager.removeMesh(r)})}};Qe.prototype.makeStandardMaterial=function(r){var e=new oo(r,this._scene);return e.specularColor.copyFromFloats(0,0,0),e.ambientColor.copyFromFloats(1,1,1),e.diffuseColor.copyFromFloats(1,1,1),this.postMaterialCreationHook(e),e};Qe.prototype.postMaterialCreationHook=function(r){};Qe.prototype.prepareChunkForRendering=function(r){};Qe.prototype.disposeChunkForRendering=function(r){};Qe.prototype._rebaseOrigin=function(r){var e=new E(r[0],r[1],r[2]);this._scene.meshes.forEach(t=>{t.parent||(t.position.subtractInPlace(e),t.isWorldMatrixFrozen&&t.freezeWorldMatrix())}),this._octreeManager.rebase(e)};function Ay(r){var e=r.noa.camera,t=e._localGetTargetPosition();r._cameraHolder.position.copyFromFloats(t[0],t[1],t[2]),r._cameraHolder.rotation.x=e.pitch,r._cameraHolder.rotation.y=e.heading,r._camera.position.z=-e.currentZoom;var i=e._localGetPosition(),n=r.noa.worldOriginOffset,o=Math.floor(i[0]+n[0]),a=Math.floor(i[1]+n[1]),s=Math.floor(i[2]+n[2]),f=r.noa.getBlock(o,a,s);Sy(r,f)}function Sy(r,e){if(e!==r._camLocBlock){if(e===0)r._camScreen.setEnabled(!1);else{var t=r.noa.registry.getBlockFaceMaterial(e,0);if(t){var i=r.noa.registry.getMaterialData(t),n=i.color,o=i.alpha;n&&o&&o<1&&(r._camScreenMat.diffuseColor.set(0,0,0),r._camScreenMat.ambientColor.set(n[0],n[1],n[2]),r._camScreenMat.alpha=o,r._camScreen.setEnabled(!0))}}r._camLocBlock=e}}function My(r){var e=r._highlightMesh;if(!e){e=bi("highlight",{size:1},r._scene);var t=r.makeStandardMaterial("highlightMat");t.backFaceCulling=!1,t.emissiveColor=new de(1,1,1),t.alpha=.2,t.freeze(),e.material=t;var i=.5,n=Ha("hightlightLines",{points:[new E(i,i,0),new E(i,-i,0),new E(-i,-i,0),new E(-i,i,0),new E(i,i,0)]},r._scene);n.color=new de(1,1,1),n.parent=e,r.addMeshToScene(e),r.addMeshToScene(n),r._highlightMesh=e}return e}Qe.prototype.debug_SceneCheck=function(){var r=this._scene.meshes,e=this._scene._selectionOctree,t=e.dynamicContent,i=[],n=0,o=0,a=this._scene.materials,s=[];a.forEach(p=>{p.subMaterials?p.subMaterials.forEach(d=>s.push(d)):s.push(p)}),e.blocks.forEach(function(p){n++,p.entries.forEach(d=>i.push(d))}),r.forEach(function(p){if(p.isDisposed&&l(p,"disposed mesh in scene"),!h(p)){if(c(p,t,i)&&l(p,"non-empty mesh missing from octree"),!p.material){l(p,"non-empty scene mesh with no material");return}o+=p.subMeshes?p.subMeshes.length:1;var d=p.material.subMaterials||[p.material];d.forEach(function(m){c(m,d)&&l(m,"mesh material not in scene")})}});var f=[];s.forEach(p=>{var d=!1;r.forEach(m=>{if(m.material===p&&(d=!0),!!m.material){var _=m.material.subMaterials||[m.material];_.includes(p)&&(d=!0)}}),d||f.push(p.name)}),f.length&&console.warn("Materials unused by any mesh: ",f.join(", ")),t.forEach(function(p){c(p,r)&&l(p,"octree/dynamic mesh not in scene")}),i.forEach(function(p){c(p,r)&&l(p,"octree block mesh not in scene")});var u=Math.round(10*i.length/n)/10;console.log("meshes - octree:",i.length,"  dynamic:",t.length,"   subMeshes:",o,"   avg meshes/octreeBlock:",u);function l(p,d){console.warn(p.name+" --- "+d)}function h(p){return p.getIndices().length===0}function c(p,d,m){return!(!p||d.includes(p)||m&&m.includes(p))}return"done."};Qe.prototype.debug_MeshCount=function(){var r={};this._scene.meshes.forEach(t=>{var i=t.name||"";i=i.replace(/-\d+.*/,"#"),i=i.replace(/\d+.*/,"#"),i=i.replace(/(rotHolder|camHolder|camScreen)/,"rendering use"),i=i.replace(/atlas sprite .*/,"atlas sprites"),r[i]=r[i]||0,r[i]++});for(var e in r)console.log("   "+(r[e]+"       ").substr(0,7)+e)};var Ei=Ey?ar(200,"render internals"):()=>{},Dc=function(){};function Ry(){var r=document.createElement("div");r.id="noa_fps",r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.zIndex="0",r.style.color="white",r.style.backgroundColor="rgba(0,0,0,0.5)",r.style.font="14px monospace",r.style.textAlign="center",r.style.minWidth="2em",r.style.margin="4px",document.body.appendChild(r);var e=1e3,t=0,i=0,n=performance.now(),o=n;Dc=function(){t++;var a=performance.now();if(a-o>i&&(i=a-o),o=a,!(a-n<e)){var s=Math.round(t/(a-n)*1e3),f=Math.round(1/i*1e3);r.innerHTML=s+"<br>"+f,t=0,i=0,n=a}}}v();v();v();var xy=dn(),gr=Tt(),Py=0,fo=class{constructor(e,t,i,n,o,a,s){this.aabb=new xy(e.base,e.vec),this.mass=t,this.friction=i,this.restitution=n,this.gravityMultiplier=o,this.onCollide=a,this.autoStep=!!s,this.airDrag=-1,this.fluidDrag=-1,this.onStep=null,this.velocity=gr.create(),this.resting=[0,0,0],this.inFluid=!1,this._ratioInFluid=0,this._forces=gr.create(),this._impulses=gr.create(),this._sleepFrameCount=10}setPosition(e){so(e),gr.subtract(e,e,this.aabb.base),this.aabb.translate(e),this._markActive()}getPosition(){return gr.clone(this.aabb.base)}applyForce(e){so(e),gr.add(this._forces,this._forces,e),this._markActive()}applyImpulse(e){so(e),gr.add(this._impulses,this._impulses,e),this._markActive()}_markActive(){this._sleepFrameCount=10}atRestX(){return this.resting[0]}atRestY(){return this.resting[1]}atRestZ(){return this.resting[2]}},so=r=>{};Py&&(so=r=>{if(isNaN(gr.length(r)))throw"Vector with NAN: "+r});var Bc=dn(),pe=Tt(),ho=Ko();var Cy=0;function Iy(){this.airDrag=.1,this.fluidDrag=.4,this.fluidDensity=2,this.gravity=[0,-10,0],this.minBounceImpulse=.5}function Ji(r,e,t){r=Object.assign(new Iy,r),this.gravity=r.gravity||[0,-10,0],this.airDrag=r.airDrag||.1,this.fluidDensity=r.fluidDensity||2,this.fluidDrag=r.fluidDrag||.4,this.minBounceImpulse=r.minBounceImpulse,this.bodies=[],this.testSolid=e,this.testFluid=t}Ji.prototype.addBody=function(r,e,t,i,n,o){r=r||new Bc([0,0,0],[1,1,1]),typeof e=="undefined"&&(e=1),typeof t=="undefined"&&(t=1),typeof i=="undefined"&&(i=0),typeof n=="undefined"&&(n=1);var a=new fo(r,e,t,i,n,o);return this.bodies.push(a),a};Ji.prototype.removeBody=function(r){var e=this.bodies.indexOf(r);e<0||(this.bodies.splice(e,1),r.aabb=r.onCollide=null)};var uo=pe.create(),kr=pe.create(),Ka=pe.create(),sr=pe.create(),Oc=pe.create();Ji.prototype.tick=function(r){r=r/1e3;var e=co(0,pe.squaredLength(this.gravity));this.bodies.forEach(t=>Dy(this,t,r,e))};function Dy(r,e,t,i){if(pe.copy(Oc,e.resting),e.mass<=0){pe.set(e.velocity,0,0,0),pe.set(e._forces,0,0,0),pe.set(e._impulses,0,0,0);return}var n=i||e.gravityMultiplier===0;if(!Ly(r,e,t,n)){e._sleepFrameCount--,Oy(r,e),Qi(e._forces),Qi(e._impulses),Qi(e.velocity),Qi(e.resting),pe.scale(uo,e._forces,1/e.mass),pe.scaleAndAdd(uo,uo,r.gravity,e.gravityMultiplier),pe.scale(kr,e._impulses,1/e.mass),pe.scaleAndAdd(kr,kr,uo,t),pe.add(e.velocity,e.velocity,kr),e.friction&&(ja(0,e,kr),ja(1,e,kr),ja(2,e,kr));var o=e.airDrag>=0?e.airDrag:r.airDrag;e.inFluid&&(o=e.fluidDrag>=0?e.fluidDrag:r.fluidDrag,o*=1-ls(1-e.ratioInFluid,2));var a=Math.max(1-o*t/e.mass,0);pe.scale(e.velocity,e.velocity,a),pe.scale(Ka,e.velocity,t),pe.set(e._forces,0,0,0),pe.set(e._impulses,0,0,0),e.autoStep&&Uc(Fc,e.aabb),Nc(r,e.aabb,Ka,e.resting),e.autoStep&&wy(r,e,Fc,Ka);for(var s=0;s<3;++s)sr[s]=0,e.resting[s]&&(Oc[s]||(sr[s]=-e.velocity[s]),e.velocity[s]=0);var f=pe.length(sr);f>.001&&(pe.scale(sr,sr,e.mass),e.onCollide&&e.onCollide(sr),e.restitution>0&&f>r.minBounceImpulse&&(pe.scale(sr,sr,e.restitution),e.applyImpulse(sr)));var u=pe.squaredLength(e.velocity);u>1e-5&&e._markActive()}}function Oy(r,e){var t=e.aabb,i=Math.floor(t.base[0]),n=Math.floor(t.base[2]),o=Math.floor(t.base[1]),a=Math.floor(t.max[1]);if(!r.testFluid(i,o,n)){e.inFluid=!1,e.ratioInFluid=0;return}for(var s=1,f=o+1;f<=a&&r.testFluid(i,f,n);)s++,f++;var u=o+s,l=u-t.base[1],h=l/t.vec[1];h>1&&(h=1);var c=t.vec[0]*t.vec[1]*t.vec[2],p=c*h,d=Fy;pe.scale(d,r.gravity,-r.fluidDensity*p),e.applyForce(d),e.inFluid=!0,e.ratioInFluid=h}var Fy=pe.create();function ja(r,e,t){var i=e.resting[r],n=t[r];if(i!==0&&!(i*n<=0)){pe.copy(Ya,e.velocity),Ya[r]=0;var o=pe.length(Ya);if(!co(o,0)){var a=Math.abs(e.friction*n),s=o>a?(o-a)/o:0;e.velocity[(r+1)%3]*=s,e.velocity[(r+2)%3]*=s}}}var Ya=pe.create();function Nc(r,e,t,i){return pe.set(i,0,0,0),ho(r.testSolid,e,t,function(n,o,a,s){i[o]=a,s[o]=0})}var Fc=new Bc([],[]),qa=pe.create(),lo=pe.create(),wc=pe.create(),Za=pe.create();function wy(r,e,t,i){if(!(e.resting[1]>=0&&!e.inFluid)){var n=e.resting[0]!==0,o=e.resting[2]!==0;if(!!(n||o)){var a=Math.abs(i[0]/i[2]),s=4;if(!(!n&&a>s)&&!(!o&&a<1/s)){pe.add(lo,t.base,i);var f=r.testSolid;ho(f,t,i,function(c,p,d,m){if(p===1)m[p]=0;else return!0});var u=e.aabb.base[1],l=Math.floor(u+1.001)-u;pe.set(wc,0,l,0);var h=!1;ho(f,t,wc,function(c,p,d,m){return h=!0,!0}),!h&&(pe.subtract(Za,lo,t.base),Za[1]=0,Nc(r,t,Za,qa),!(n&&!co(t.base[0],lo[0]))&&(o&&!co(t.base[2],lo[2])||(Uc(e.aabb,t),e.resting[0]=qa[0],e.resting[2]=qa[2],e.onStep&&e.onStep())))}}}}function Ly(r,e,t,i){if(e._sleepFrameCount>0)return!1;if(i)return!0;var n=!1,o=.5*t*t*e.gravityMultiplier;return pe.scale(Lc,r.gravity,o),ho(r.testSolid,e.aabb,Lc,function(){return n=!0,!0},!0),n}var Lc=pe.create();function co(r,e){return Math.abs(r-e)<1e-5}function Uc(r,e){for(var t=0;t<3;t++)r.base[t]=e.base[t],r.max[t]=e.max[t],r.vec[t]=e.vec[t]}var Qi=function(r){};Cy&&(Qi=function(r){if(isNaN(pe.length(r)))throw"Vector with NAN: "+r});var By={gravity:[0,-10,0],airDrag:.1},po=class extends Ji{constructor(e,t){t=Object.assign({},By,t);var i=e.world,n=e.registry._solidityLookup,o=e.registry._fluidityLookup,a=e.worldOriginOffset,s=(u,l,h)=>{var c=i.getBlockID(u+a[0],l+a[1],h+a[2]);return n[c]},f=(u,l,h)=>{var c=i.getBlockID(u+a[0],l+a[1],h+a[2]);return o[c]};super(t,s,f)}};v();var Xc=He(Mi());v();Ut();var kc=on(),vo=yr;function yr(r,e,t,i,n,o,a,s=-1){this.noa=r,this.isDisposed=!1,this.requestID=e,this.voxels=a,this.i=t,this.j=i,this.k=n,this.size=o,this.x=t*o,this.y=i*o,this.z=n*o,this.pos=[this.x,this.y,this.z],this._terrainDirty=!1,this._objectsDirty=!1,this._terrainMeshes=[],r._terrainMesher.initChunk(this),r._objectMesher.initChunk(this),this._isFull=!1,this._isEmpty=!1,this._wholeLayerVoxel=Array(o).fill(-1),s>=0&&(this.voxels.data.fill(s,0,this.voxels.size),this._wholeLayerVoxel.fill(s));var f=Array.from(Array(27),()=>null);this._neighbors=kc(f,[3,3,3]).lo(1,1,1),this._neighbors.set(0,0,0,this),this._neighborCount=0,this._timesMeshed=0,this._blockHandlerLocs=new Ue,Vc(this)}yr._createVoxelArray=function(r){var e=new Uint16Array(r*r*r);return kc(e,[r,r,r])};yr.prototype._updateVoxelArray=function(r,e=-1){Wc(this,"onUnload"),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels=r,this._terrainDirty=!1,this._objectsDirty=!1,this._blockHandlerLocs.empty(),this.noa._objectMesher.initChunk(this),this.noa._terrainMesher.initChunk(this),e>=0?this._wholeLayerVoxel.fill(e):this._wholeLayerVoxel.fill(-1),Vc(this)};yr.prototype.get=function(r,e,t){return this.voxels.get(r,e,t)};yr.prototype.getSolidityAt=function(r,e,t){var i=this.noa.registry._solidityLookup;return i[this.voxels.get(r,e,t)]};yr.prototype.set=function(r,e,t,i){var n=this.voxels.get(r,e,t);if(i!==n){this.voxels.set(r,e,t,i);var o=this.noa.registry._solidityLookup,a=this.noa.registry._objectLookup,s=this.noa.registry._opacityLookup,f=this.noa.registry._blockHandlerLookup;s[i]||(this._isFull=!1),i!==0&&(this._isEmpty=!1),this._wholeLayerVoxel[e]!==i&&(this._wholeLayerVoxel[e]=-1);var u=f[n],l=f[i];u&&_o(this,u,"onUnset",r,e,t),l?(_o(this,l,"onSet",r,e,t),this._blockHandlerLocs.add(r,e,t)):this._blockHandlerLocs.remove(r,e,t);var h=this.noa._objectMesher,c=a[n],p=a[i];c&&h.setObjectBlock(this,0,r,e,t),p&&h.setObjectBlock(this,i,r,e,t);var d=o[n]!==o[i],m=s[n]!==s[i],_=!c&&n!==0,y=!p&&i!==0;if((c||p)&&(this._objectsDirty=!0),(d||m||_||y)&&(this._terrainDirty=!0),(this._terrainDirty||this._objectsDirty)&&this.noa.world._queueChunkForRemesh(this),d||m){for(var g=this.size-1,T=r===0?-1:0,A=e===0?-1:0,M=t===0?-1:0,C=r===g?1:0,P=e===g?1:0,R=t===g?1:0,F=T;F<=C;F++)for(var I=A;I<=P;I++)for(var D=M;D<=R;D++)if((F|I|D)!==0){var V=this._neighbors.get(F,I,D);!V||(V._terrainDirty=!0,this.noa.world._queueChunkForRemesh(V))}}}};function _o(r,e,t,i,n,o){var a=e[t];!a||a(r.x+i,r.y+n,r.z+o)}yr.prototype.updateMeshes=function(){this._terrainDirty&&(this.noa._terrainMesher.meshChunk(this),this._timesMeshed++,this._terrainDirty=!1),this._objectsDirty&&(this.noa._objectMesher.buildObjectMeshes(),this._objectsDirty=!1)};function Vc(r){for(var e=r.voxels,t=e.data,i=e.shape[0],n=r.noa.registry._opacityLookup,o=r.noa.registry._blockHandlerLookup,a=r.noa.registry._objectLookup,s=r.noa.registry._blockIsPlainLookup,f=r.noa._objectMesher,u=!0,l=!0,h=0;h<i;++h){var c=r._wholeLayerVoxel[h];if(c>=0&&!f[c]&&!o[c]){n[c]||(u=!1),c!==0&&(l=!1);continue}for(var p=e.get(0,h,0),d=0;d<i;++d)for(var m=e.index(d,h,0),_=0;_<i;++_,++m){var y=t[m];if(p>=0&&y!==p&&(p=-1),y===0){u=!1;continue}if(s[y]){l=!1;continue}u=u&&n[y],l=!1,a[y]&&(f.setObjectBlock(r,y,d,h,_),r._objectsDirty=!0);var g=o[y];g&&(r._blockHandlerLocs.add(d,h,_),_o(r,g,"onLoad",d,h,_))}p>=0&&(r._wholeLayerVoxel[h]=p)}r._isFull=u,r._isEmpty=l,r._terrainDirty=!r._isEmpty}yr.prototype.dispose=function(){Wc(this,"onUnload"),this._blockHandlerLocs.empty(),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels.data=null,this.voxels=null,this._neighbors.data=null,this._neighbors=null,this.isDisposed=!0};function Wc(r,e){var t=r.voxels,i=r.noa.registry._blockHandlerLookup;r._blockHandlerLocs.arr.forEach(([n,o,a])=>{var s=t.get(n,o,a);_o(r,i[s],e,n,o,a)})}Ut();Ut();var Ny=0,Uy=0,ky={chunkSize:24,chunkAddDistance:[2,2],chunkRemoveDistance:[3,3],worldGenWhilePaused:!1,manuallyControlChunkLoading:!1},Ge=class extends Xc.default{constructor(e,t){super(),t=Object.assign({},ky,t),this.noa=e,this.playerChunkLoaded=!1,this.Chunk=vo,this.manuallyControlChunkLoading=!!t.manuallyControlChunkLoading,this.chunkSortingDistFn=jc,this.minNeighborsToMesh=6,this.worldGenWhilePaused=!!t.worldGenWhilePaused,this.maxChunksPendingCreation=10,this.maxChunksPendingMeshing=10,this.maxProcessingPerTick=9,this.maxProcessingPerRender=5,this._chunkSize=t.chunkSize,this._chunkAddDistance=[2,2],this._chunkRemoveDistance=[3,3],this._addDistanceFn=null,this._remDistanceFn=null,this._prevWorldName="",this._prevPlayerChunkHash=0,this._chunkAddSearchFrom=0,this._prevSortingFn=null,this._chunksKnown=null,this._chunksPending=null,this._chunksToRequest=null,this._chunksToRemove=null,this._chunksToMesh=null,this._chunksToMeshFirst=null,this._chunksSortedLocs=null,Vy(this),this.setAddRemoveDistance(t.chunkAddDistance,t.chunkRemoveDistance),this._storage=new Ia;var i=this._chunkSize;this._coordsToChunkIndexes=Qy,this._coordsToChunkLocals=Jy;var n=(i&i-1)===0;n&&(this._coordShiftBits=Math.log2(i)|0,this._coordMask=i-1|0,this._coordsToChunkIndexes=$y,this._coordsToChunkLocals=e0)}};Ge.prototype.getBlockID=function(r,e,t){var[i,n,o]=this._coordsToChunkIndexes(r,e,t),a=this._storage.getChunkByIndexes(i,n,o);if(!a)return 0;var[s,f,u]=this._coordsToChunkLocals(r,e,t);return a.voxels.get(s,f,u)};Ge.prototype.getBlockSolidity=function(r,e,t){var[i,n,o]=this._coordsToChunkIndexes(r,e,t),a=this._storage.getChunkByIndexes(i,n,o);if(!a)return!1;var[s,f,u]=this._coordsToChunkLocals(r,e,t);return!!a.getSolidityAt(s,f,u)};Ge.prototype.getBlockOpacity=function(r,e,t){var i=this.getBlockID(r,e,t);return this.noa.registry.getBlockOpacity(i)};Ge.prototype.getBlockFluidity=function(r,e,t){var i=this.getBlockID(r,e,t);return this.noa.registry.getBlockFluidity(i)};Ge.prototype.getBlockProperties=function(r,e,t){var i=this.getBlockID(r,e,t);return this.noa.registry.getBlockProps(i)};Ge.prototype.setBlockID=function(r,e,t,i){var[n,o,a]=this._coordsToChunkIndexes(e,t,i),s=this._storage.getChunkByIndexes(n,o,a);if(!!s){var[f,u,l]=this._coordsToChunkLocals(e,t,i);return s.set(f,u,l,r,e,t,i)}};Ge.prototype.isBoxUnobstructed=function(r){for(var e=r.base,t=r.max,i=Math.floor(e[0]);i<t[0]+1;i++)for(var n=Math.floor(e[1]);n<t[1]+1;n++)for(var o=Math.floor(e[2]);o<t[2]+1;o++)if(this.getBlockSolidity(i,n,o))return!1;return!0};Ge.prototype.setChunkData=function(r,e,t=null,i=-1){Yy(this,r,e,t,i)};Ge.prototype.setAddRemoveDistance=function(r=2,e=3){var t=Array.isArray(r)?r:[r,r],i=Array.isArray(e)?e:[e,e],n=1;i[0]<t[0]+n&&(i[0]=t[0]+n),i[1]<t[1]+n&&(i[1]=t[1]+n),this._chunkAddDistance=t,this._chunkRemoveDistance=i,this._addDistanceFn=zc(t[0],t[1]),this._remDistanceFn=zc(i[0],i[1]),this._chunksSortedLocs.empty();for(var o=0;o<=t[0];o++)for(var a=0;a<=o;a++)for(var s=0;s<=t[1];s++)!this._addDistanceFn(o,s,a)||this._chunksSortedLocs.add(o,s,a);this._prevSortingFn=null,this._chunkAddSearchFrom=0};Ge.prototype.invalidateVoxelsInAABB=function(r){zy(this,r)};Ge.prototype.manuallyLoadChunk=function(r,e,t){if(!this.manuallyControlChunkLoading)throw Hc;var[i,n,o]=this._coordsToChunkIndexes(r,e,t);this._chunksKnown.add(i,n,o),this._chunksToRequest.add(i,n,o)};Ge.prototype.manuallyUnloadChunk=function(r,e,t){if(!this.manuallyControlChunkLoading)throw Hc;var[i,n,o]=this._coordsToChunkIndexes(r,e,t);this._chunksToRemove.add(i,n,o),this._chunksToMesh.remove(i,n,o),this._chunksToRequest.remove(i,n,o),this._chunksToMeshFirst.remove(i,n,o)};var Hc="Set `noa.world.manuallyControlChunkLoading` if you need this API";Ge.prototype.tick=function(){var r=performance.now(),[e,t,i]=Kc(this),n=nt(e,t,i),o=n!==this._prevPlayerChunkHash;o&&(this.emit("playerEnteredChunk",e,t,i),this._prevPlayerChunkHash=n,this._chunkAddSearchFrom=0),this._prevWorldName!==this.noa.worldName&&(Xy(this),this._prevWorldName=this.noa.worldName,this._chunkAddSearchFrom=0,mo(this)),fr("start"),Ai("start"),this.manuallyControlChunkLoading||(o&&(Gy(this,e,t,i),fr("remQueue")),Wy(this,e,t,i),fr("addQueue"));var a=Math.max(1,this.maxProcessingPerTick||0),s=!1,f=!1,u=!1;qi(a,()=>(s||(s=Ky(this)),fr("requests"),f||(f=Ja(this,!1)),fr("meshes"),u||(u=mo(this)||mo(this)||mo(this),fr("removes")),s&&f&&u),r);var l=performance.now()-r;a-=l,a>.5&&(Hy(this),fr("looking"),qi(a,()=>Ja(this,!1),r),fr("meshes"));var h=this._storage.getChunkByIndexes(e,t,i);this.playerChunkLoaded=!!h,Ai("end",this),fr("end")};Ge.prototype.render=function(){var r=this.maxProcessingPerRender;r>0&&qi(r,()=>Ja(this,!0))};Ge.prototype._getChunkByCoords=function(r,e,t){var[i,n,o]=this._coordsToChunkIndexes(r,e,t);return this._storage.getChunkByIndexes(i,n,o)};function Vy(r){r._chunksKnown=new Ue,r._chunksToMesh=new Ue,r._chunksPending=new Ue,r._chunksToRemove=new Ue,r._chunksToRequest=new Ue,r._chunksToMeshFirst=new Ue,r._chunksSortedLocs=new Ue}Ge.prototype._queueChunkForRemesh=function(r){bo(this,r)};function Kc(r){var[e,t,i]=r.noa.entities.getPosition(r.noa.playerEntity);return r._coordsToChunkIndexes(e,t,i)}function Wy(r,e,t,i){var n=r._chunksToRequest,o=r._chunkAddSearchFrom,a=r._chunksSortedLocs;if(!(o>=a.arr.length)&&!(r._chunksToRequest.count()>50)){r._prevSortingFn!==r.chunkSortingDistFn&&(r.chunkSortingDistFn||(r.chunkSortingDistFn=jc),yo(a,0,0,0,r.chunkSortingDistFn,!0),r._prevSortingFn=r.chunkSortingDistFn),Ti.removals=0,Ti.ci=e,Ti.cj=t,Ti.ck=i;for(var s=r._chunksSortedLocs.arr,f=o;f<s.length;f++){var[u,l,h]=s[f];if(go(r,Ti,u,l,h),Ti.removals===0){if(r._chunkAddSearchFrom=f+1,n.count()>100||f-o>50)break}else if(n.count()>50||f-o>5)break}yo(n,e,t,i,r.chunkSortingDistFn)}}var Ti={},go=(r,e,t,i,n)=>{Gc(r,e,e.ci+t,e.cj+i,e.ck+n),t!==n&&Gc(r,e,e.ci+n,e.cj+i,e.ck+t),t>0&&go(r,e,-t,i,n),i>0&&go(r,e,t,-i,n),n>0&&go(r,e,t,i,-n)},Gc=(r,e,t,i,n)=>{r._chunksKnown.includes(t,i,n)?r._chunksToRemove.includes(t,i,n)&&e.removals++:(r._chunksKnown.add(t,i,n),r._chunksToRequest.addToFront(t,i,n))};function Gy(r,e,t,i){var n=r._remDistanceFn,o=r._chunksToRemove;r._chunksKnown.forEach(([a,s,f])=>{o.includes(a,s,f)||n(a-e,s-t,f-i)||(r._chunksToRemove.add(a,s,f),r._chunksToMesh.remove(a,s,f),r._chunksToRequest.remove(a,s,f),r._chunksToMeshFirst.remove(a,s,f))}),yo(o,e,t,i,r.chunkSortingDistFn)}function zy(r,e){for(var t=r._coordsToChunkIndexes(e.base[0],e.base[1],e.base[2]),i=r._coordsToChunkIndexes(e.max[0],e.max[1],e.max[2]),n=0;n<3;n++)Number.isFinite(e.base[n])||(t[n]=e.base[n]),Number.isFinite(e.max[n])||(i[n]=e.max[n]);r._chunksKnown.forEach(o=>{for(var a=0;a<3;a++)if(o[a]<t[a]||o[a]>=i[a])return;r._chunksToRemove.add(o[0],o[1],o[2]),r._chunksToMesh.remove(o[0],o[1],o[2]),r._chunksToRequest.remove(o[0],o[1],o[2]),r._chunksToMeshFirst.remove(o[0],o[1],o[2])})}function Xy(r){r._chunksToRemove.copyFrom(r._chunksKnown),r._chunksToRequest.empty(),r._chunksToMesh.empty(),r._chunksToMeshFirst.empty();var[e,t,i]=Kc(r);yo(r._chunksToRemove,e,t,i,r.chunkSortingDistFn)}function Hy(r){var e=5,t=r._chunksToMesh.count()+r._chunksToMeshFirst.count();if(!(t>e))for(var i=r._chunksKnown.arr,n=Math.min(50,i.length),o=0;o<n;o++){Qa=(Qa+1)%i.length;var[a,s,f]=i[Qa],u=r._storage.getChunkByIndexes(a,s,f);if(!!u){var l=bo(r,u);if(l&&t++,t>e)return}}}var Qa=-1;function Ky(r){var e=r._chunksToRequest;if(e.isEmpty())return!0;var t=r._chunksPending.count(),i=r._chunksToMesh.count();if(t>=r.maxChunksPendingCreation||i>=r.maxChunksPendingMeshing)return!0;var[n,o,a]=e.pop();return jy(r,n,o,a),e.isEmpty()}function mo(r){var e=r._chunksToRemove;if(e.isEmpty())return!0;var[t,i,n]=e.pop();return qy(r,t,i,n),e.isEmpty()}function Ja(r,e){var t=r._chunksToMeshFirst;if(t.isEmpty()&&!e&&(t=r._chunksToMesh),t.isEmpty())return!0;var[i,n,o]=t.pop();if(!r._chunksToRemove.includes(i,n,o)){var a=r._storage.getChunkByIndexes(i,n,o);a&&Zy(r,a)}}function bo(r,e){if(!(e._terrainDirty||e._objectsDirty)||e._neighborCount<e.minNeighborsToMesh||r._chunksToMesh.includes(e.i,e.j,e.k)||r._chunksToMeshFirst.includes(e.i,e.j,e.k))return!1;var t=e._neighborCount===26?r._chunksToMeshFirst:r._chunksToMesh;return t.add(e.i,e.j,e.k),!0}function jy(r,e,t,i){var n=r._chunkSize,o=vo._createVoxelArray(r._chunkSize),a=r.noa.worldName,s=[e,t,i,a].join("|"),f=e*n,u=t*n,l=i*n;r._chunksPending.add(e,t,i),r.emit("worldDataNeeded",s,o,f,u,l,a),Ai("request")}function Yy(r,e,t,i,n){var o=e.split("|"),a=parseInt(o.shift()),s=parseInt(o.shift()),f=parseInt(o.shift()),u=o.join("|");if(r._chunksPending.remove(a,s,f),u===r.noa.worldName&&!!r._chunksKnown.includes(a,s,f)&&!r._chunksToRemove.includes(a,s,f)){var l=r._storage.getChunkByIndexes(a,s,f);if(l)l._updateVoxelArray(t,n);else{var h=r._chunkSize;l=new vo(r.noa,e,a,s,f,h,t,n),r._storage.storeChunkByIndexes(a,s,f,l),l.userData=i,r.noa.rendering.prepareChunkForRendering(l),r.emit("chunkAdded",l)}bo(r,l),Yc(r,a,s,f,l),Ai("receive")}}function qy(r,e,t,i){var n=r._storage.getChunkByIndexes(e,t,i);n&&(r.emit("chunkBeingRemoved",n.requestID,n.voxels,n.userData),r.noa.rendering.disposeChunkForRendering(n),n.dispose(),Ai("dispose"),Yc(r,e,t,i,null)),r._storage.removeChunkByIndexes(e,t,i),r._chunksKnown.remove(e,t,i),r._chunksToMesh.remove(e,t,i),r._chunksToMeshFirst.remove(e,t,i)}function Zy(r,e){r._chunksToMesh.remove(e.i,e.j,e.k),r._chunksToMeshFirst.remove(e.i,e.j,e.k),e.updateMeshes(),Ai("mesh")}function Qy(r,e,t){var i=this._chunkSize;return[Math.floor(r/i)|0,Math.floor(e/i)|0,Math.floor(t/i)|0]}function Jy(r,e,t){var i=this._chunkSize,n=r%i|0;n<0&&(n+=i);var o=e%i|0;o<0&&(o+=i);var a=t%i|0;return a<0&&(a+=i),[n,o,a]}function $y(r,e,t){var i=this._coordShiftBits;return[r>>i|0,e>>i|0,t>>i|0]}function e0(r,e,t){var i=this._coordMask;return[r&i|0,e&i|0,t&i|0]}function yo(r,e,t,i,n,o=!1){o?r.sortByDistance((a,s,f)=>-n(e-a,t-s,i-f)):r.sortByDistance((a,s,f)=>n(e-a,t-s,i-f))}var jc=(r,e,t)=>r*r+e*e+t*t;function Yc(r,e,t,i,n){for(var o=!n||n&&!n.isEmpty,a=-1;a<=1;a++)for(var s=-1;s<=1;s++)for(var f=-1;f<=1;f++)if((a|s|f)!==0){var u=r._storage.getChunkByIndexes(e+a,t+s,i+f);if(!!u){o&&(u._terrainDirty=!0),n&&!n._neighbors.get(a,s,f)&&(n._neighborCount++,n._neighbors.set(a,s,f,u));var l=u._neighbors.get(-a,-s,-f);n&&!l&&(u._neighborCount++,u._neighbors.set(-a,-s,-f,n),u._neighborCount===26&&bo(r,u)),!n&&l&&(u._neighborCount--,u._neighbors.set(-a,-s,-f,null))}}}function zc(r,e){var t=r*r,i=e*e;return r===e?(n,o,a)=>n*n+o*o+a*a<=t:r>e?(n,o,a)=>Math.abs(o)>e?!1:n*n+o*o+a*a<=t:(n,o,a)=>{var s=n*n+a*a;return s>t?!1:s+o*o<=i}}Ge.prototype.report=function(){console.log("World report - playerChunkLoaded: ",this.playerChunkLoaded),$i(this,"  known:     ",this._chunksKnown.arr,!0),$i(this,"  to request:",this._chunksToRequest.arr,0),$i(this,"  to remove: ",this._chunksToRemove.arr,0),$i(this,"  creating:  ",this._chunksPending.arr,0),$i(this,"  to mesh:   ",this._chunksToMesh.arr.concat(this._chunksToMeshFirst.arr),0)};function $i(r,e,t,i){var n=0,o=0,a=0,s=0,f=[];t.forEach(p=>{var d=r._storage.getChunkByIndexes(p[0],p[1],p[2]);!d||(a++,f.push(d._timesMeshed),d._isFull&&n++,d._isEmpty&&o++,d._neighborCount===26&&s++)});var u=t.length.toString().padEnd(8);if(u+=("exist: "+a).padEnd(12),u+=("full: "+n).padEnd(12),u+=("empty: "+o).padEnd(12),u+=("surr: "+s).padEnd(12),i){var l=f.reduce((p,d)=>p+d,0),h=f.reduce((p,d)=>Math.max(p,d),0),c=f.reduce((p,d)=>Math.min(p,d),0);u+="times meshed: avg "+(l/a).toFixed(2),u+="  max "+h,u+="  min "+c}console.log(e,u)}var fr=ar(Ny,"world ticks:",1),Ai=(r=>{if(!(r>0))return()=>{};var e=0,t={},i={},n=performance.now();return function(a,s){if(a!=="start"){if(a!=="end")return t[a]=(t[a]||0)+1;if(i.toreq=(i.toreq||0)+s._chunksToRequest.count(),i.toget=(i.toget||0)+s._chunksPending.count(),i.tomesh=(i.tomesh||0)+s._chunksToMesh.count()+s._chunksToMeshFirst.count(),i.tomesh1=(i.tomesh1||0)+s._chunksToMeshFirst.count(),i.torem=(i.torem||0)+s._chunksToRemove.count(),!(++e<r)){var f=performance.now(),u=f-n,l={};Object.keys(i).forEach(h=>{var c=Math.round((i[h]||0)/e);l[h]=`[${c}]`.padStart(5)}),Object.keys(t).forEach(h=>{var c=Math.round((t[h]||0)*1e3/u);l[h]=(""+c).padStart(3)}),console.log("chunk flow: ",`${l.toreq}-> ${l.request||0} req/s  `,`${l.toget}-> ${l.receive||0} got/s  `,`${l.tomesh}-> ${l.mesh||0} mesh/s  `,`${l.torem}-> ${l.dispose||0} rem/s  `,`(meshFirst: ${l.tomesh1.trim()})`),e=0,t={},i={},n=performance.now()}}}})(Uy);Ut();var qc={name:"noa-engine",version:"0.33.0",description:"Experimental voxel game engine",main:"src/index.js",typings:"dist/src/index.d.ts",files:["/src","/dist"],scripts:{build:"npm run types; npm run docs",types:"tsc",docs:"typedoc"},author:"Andy Hall (https://fenomas.com)",license:"MIT",repository:{type:"git",url:"https://github.com/fenomas/noa.git"},bugs:{url:"https://github.com/fenomas/noa/issues"},dependencies:{"aabb-3d":"fenomas/aabb-3d","box-intersect":"fenomas/box-intersect","ent-comp":"^0.10.1",events:"^3.3.0","fast-voxel-raycast":"^0.1.1","game-inputs":"^0.7.0","gl-vec3":"^1.1.3","micro-game-shell":"^0.6.0",ndarray:"^1.0.19","voxel-aabb-sweep":"^0.5.0","voxel-physics-engine":"^0.12.0"},peerDependencies:{"@babylonjs/core":"^5.11.0"},devDependencies:{eslint:"^8.3.0","js-beautify":"^1.14.0",typedoc:"^0.22.15",typescript:"^4.6.4"},keywords:["voxel","voxels","game","engine","game-engine"]};var r0=qc.version,Zc=0,Qc=0,i0={debug:!1,silent:!1,silentBabylon:!1,playerHeight:1.8,playerWidth:.6,playerStart:[0,10,0],playerAutoStep:!1,tickRate:30,maxRenderRate:0,blockTestDistance:10,stickyPointerLock:!0,dragCameraOutsidePointerLock:!0,stickyFullscreen:!1,skipDefaultHighlighting:!1,originRebaseDistance:25},Eo=class extends Jc.EventEmitter{constructor(e={}){if(super(),e=Object.assign({},i0,e),this.version=r0,!e.silent){var t=e.debug?" (debug)":"";console.log(`noa-engine v${this.version}${t}`)}this._paused=!1,this._dragOutsideLock=e.dragCameraOutsidePointerLock,this._originRebaseDistance=e.originRebaseDistance,this.worldOriginOffset=[0,0,0],this.positionInCurrentTick=0,this.worldName="default",this.timeScale=1,this.container=new cn(this,e),this.tickRate=this.container._shell.tickRate,Object.defineProperty(this,"tickRate",{get:()=>this.container._shell.tickRate}),this.maxRenderRate=this.container._shell.maxRenderRate,Object.defineProperty(this,"maxRenderRate",{get:()=>this.container._shell.maxRenderRate,set:s=>{this.container._shell.maxRenderRate=s||0}}),this.inputs=new ln(this,e,this.container.element),this.registry=new Jn(this,e),this.world=new Ge(this,e);var i=console.log;e.silentBabylon&&(console.log=()=>{}),this.rendering=new Qe(this,e,this.container.canvas),e.silentBabylon&&(console.log=i),this.physics=new po(this,e),this.entities=new qn(this,e),this.ents=this.entities;var n=this.entities;this.playerEntity=n.add(e.playerStart,e.playerWidth,e.playerHeight,null,null,!0,!0),n.addComponent(this.playerEntity,n.names.collideTerrain),n.addComponent(this.playerEntity,n.names.collideEntities);var o=n.getPhysics(this.playerEntity).body;if(o.gravityMultiplier=2,o.autoStep=e.playerAutoStep,n.addComponent(this.playerEntity,n.names.receivesInputs),n.addComponent(this.playerEntity,n.names.fadeOnZoom),n.addComponent(this.playerEntity,n.names.movement,{airJumps:1}),this.camera=new pn(this,e),this.blockTestDistance=e.blockTestDistance,this.blockTargetIdCheck=this.registry.getBlockSolidity,this.targetedBlock=null,e.skipDefaultHighlighting||(this.defaultBlockHighlightFunction=s=>{s?this.rendering.highlightBlockFace(!0,s.position,s.normal):this.rendering.highlightBlockFace(!1)},this.on("targetBlockChanged",this.defaultBlockHighlightFunction)),this._terrainMesher=new La(this),this._objectMesher=new sc(this),this._targetedBlockDat={blockID:0,position:Et.default.create(),normal:Et.default.create(),adjacent:Et.default.create()},this._prevTargetHash=0,this._pickPos=Et.default.create(),this._pickResult={_localPosition:Et.default.create(),position:[0,0,0],normal:[0,0,0]},e.debug){this.vec3=Et.default,this.ndarray=$a.default,n.getMovement(1).airJumps=999;var a=window;a.noa=this,a.vec3=Et.default,a.ndarray=$a.default,a.scene=this.rendering._scene}a0(this)}tick(e){if(e*=this.timeScale||1,this._paused){this.world.worldGenWhilePaused&&this.world.tick();return}if(br("start"),n0(this),this.world.tick(),br("world"),!this.world.playerChunkLoaded){this.rendering.tick(e);return}this.physics.tick(e),br("physics"),this._objectMesher.tick(),this.rendering.tick(e),br("rendering"),o0(this),br("targets"),this.entities.tick(e),br("entities"),this.emit("tick",e),br("tick event"),br("end");var t=this.inputs.pointerState;t.scrollx=t.scrolly=t.scrollz=0}render(e,t){if(e*=this.timeScale||1,this.positionInCurrentTick=t,this._paused){this.world.worldGenWhilePaused&&this.world.render();return}Er("start"),(this.container.hasPointerLock||!this.container.supportsPointerLock||this._dragOutsideLock&&this.inputs.state.fire)&&this.camera.applyInputsToCamera(),Er("init"),this.world.render(),Er("meshing"),this.camera.updateBeforeEntityRenderSystems(),this.entities.render(e),this.camera.updateAfterEntityRenderSystems(),Er("entities"),this.emit("beforeRender",e),Er("before render"),this.rendering.render(),this.rendering.postRender(),Er("render"),this.emit("afterRender",e),Er("after render"),Er("end"),this.inputs.pointerState.dx=this.inputs.pointerState.dy=0}setPaused(e=!1){this._paused=!!e,e||(this.inputs.pointerState.dx=this.inputs.pointerState.dy=0)}getBlock(e,t=0,i=0){return e.length?this.world.getBlockID(e[0],e[1],e[2]):this.world.getBlockID(e,t,i)}setBlock(e,t,i=0,n=0){return t.length?this.world.setBlockID(e,t[0],t[1],t[2]):this.world.setBlockID(e,t,i,n)}addBlock(e,t,i=0,n=0){return t.length?this.entities.isTerrainBlocked(t[0],t[1],t[2])?void 0:(this.world.setBlockID(e,t[0],t[1],t[2]),e):this.entities.isTerrainBlocked(t,i,n)?void 0:(this.world.setBlockID(e,t,i,n),e)}globalToLocal(e,t,i){var n=this.worldOriginOffset;if(t){for(var o=0;o<3;o++){var a=e[o]-n[o];a+=t[o],i[o]=a}return i}else return Et.default.subtract(i,e,n)}localToGlobal(e,t,i=null){var n=this.worldOriginOffset;if(i){for(var o=0;o<3;o++){var a=Math.floor(e[o]);t[o]=a+n[o],i[o]=e[o]-a}return t}else return Et.default.add(t,e,n)}pick(e=null,t=null,i=-1,n=null){if(i===0)return null;var o=this._pickPos;return e&&(this.globalToLocal(e,null,o),e=o),this._localPick(e,t,i,n)}_localPick(e=null,t=null,i=-1,n=null){if(i===0)return null;var o=n||this.registry.getBlockSolidity,a=this.world,s=this.worldOriginOffset,f=function(p,d,m){var _=a.getBlockID(p+s[0],d+s[1],m+s[2]);return o(_)};e||(e=this.camera._localGetTargetPosition()),t=t||this.camera.getDirection(),i=i||-1,i<0&&(i=this.blockTestDistance);var u=this._pickResult,l=u._localPosition,h=u.normal,c=(0,$c.default)(f,e,t,i,l,h);return c?(Et.default.scaleAndAdd(l,l,h,.01),this.localToGlobal(l,u.position),u):null}};function n0(r){var e=r.ents.getPositionData(r.playerEntity)._localPosition,t=r._originRebaseDistance;if(!(Et.default.sqrLen(e)<t*t)){for(var i=[],n=0;n<3;n++)i[n]=Math.floor(e[n]),r.worldOriginOffset[n]+=i[n];r.rendering._rebaseOrigin(i),r.entities._rebaseOrigin(i),r._objectMesher._rebaseOrigin(i)}}function o0(r){var e=0,t=r.blockTargetIdCheck||r.registry.getBlockSolidity,i=r._localPick(null,null,null,t);if(i){var n=r._targetedBlockDat;Et.default.floor(n.adjacent,i.position),Et.default.copy(n.normal,i.normal),Et.default.subtract(n.position,n.adjacent,n.normal),n.blockID=r.world.getBlockID(n.position[0],n.position[1],n.position[2]),r.targetedBlock=n;var o=n.position,a=n.normal,s=nt(o[0]+n.blockID,o[1],o[2]);s^=nt(a[0],a[1]+n.blockID,a[2]),e=s}else r.targetedBlock=null;e!=r._prevTargetHash&&(r.emit("targetBlockChanged",r.targetedBlock),r._prevTargetHash=e)}function a0(r){var e="0.27",t=(i,n,o)=>{var a=()=>{throw`This property changed in ${e} - ${o}`};Object.defineProperty(i,n,{get:a,set:a})};t(r,"getPlayerEyePosition","to get the camera/player offset see API docs for `noa.camera.cameraTarget`"),t(r,"setPlayerEyePosition","to set the camera/player offset see API docs for `noa.camera.cameraTarget`"),t(r,"getPlayerPosition","use `noa.ents.getPosition(noa.playerEntity)` or similar"),t(r,"getCameraVector","use `noa.camera.getDirection`"),t(r,"getPlayerMesh","use `noa.ents.getMeshData(noa.playerEntity).mesh` or similar"),t(r,"playerBody","use `noa.ents.getPhysicsBody(noa.playerEntity)`"),t(r.rendering,"zoomDistance","use `noa.camera.zoomDistance`"),t(r.rendering,"_currentZoom","use `noa.camera.currentZoom`"),t(r.rendering,"_cameraZoomSpeed","use `noa.camera.zoomSpeed`"),t(r.rendering,"getCameraVector","use `noa.camera.getDirection`"),t(r.rendering,"getCameraPosition","use `noa.camera.getLocalPosition`"),t(r.rendering,"getCameraRotation","use `noa.camera.heading` and `noa.camera.pitch`"),t(r.rendering,"setCameraRotation","to customize camera behavior see API docs for `noa.camera`"),e="0.28",t(r.rendering,"makeMeshInstance","removed, use Babylon's `mesh.createInstance`"),t(r.world,"_maxChunksPendingCreation",'use `maxChunksPendingCreation` (no "_")'),t(r.world,"_maxChunksPendingMeshing",'use `maxChunksPendingMeshing` (no "_")'),t(r.world,"_maxProcessingPerTick",'use `maxProcessingPerTick` (no "_")'),t(r.world,"_maxProcessingPerRender",'use `maxProcessingPerRender` (no "_")'),e="0.29",t(r,"_constants","removed, voxel IDs are no longer packed with bit flags"),e="0.30",t(r,"_tickRate","tickRate is now at `noa.tickRate`"),t(r.container,"_tickRate","tickRate is now at `noa.tickRate`"),e="0.31",t(r.world,"chunkSize","effectively an internal, so changed to `_chunkSize`"),t(r.world,"chunkAddDistance","set this with `noa.world.setAddRemoveDistance`"),t(r.world,"chunkRemoveDistance","set this with `noa.world.setAddRemoveDistance`")}var ed=(Ut(),xd(oc)).makeProfileHook,br=Zc>0?ed(Zc,"tick   "):()=>{},Er=Qc>0?ed(Qc,"render "):()=>{};var J=new Eo({debug:!0,showFPS:!0,inverseY:!0,inverseX:!1,chunkSize:32,chunkAddDistance:[2,1.5],blockTestDistance:50,texturePath:"textures/",playerStart:[.5,5,.5],playerHeight:1.4,playerWidth:.6,playerAutoStep:!0,useAO:!0,AOmultipliers:[.92,.8,.5],reverseAOmultiplier:1,manuallyControlChunkLoading:!1,originRebaseDistance:25});v();v();v();var Si;(function(r){r[r.CW=0]="CW",r[r.CCW=1]="CCW"})(Si||(Si={}));var EU=function(){function r(){}return r.Interpolate=function(e,t,i,n,o){for(var a=1-3*n+3*t,s=3*n-6*t,f=3*t,u=e,l=0;l<5;l++){var h=u*u,c=h*u,p=a*c+s*h+f*u,d=1/(3*a*h+2*s*u+f);u-=(p-e)*d,u=Math.min(1,Math.max(0,u))}return 3*Math.pow(1-u,2)*u*i+3*(1-u)*Math.pow(u,2)*o+Math.pow(u,3)},r}();var To=function(){function r(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}return r.prototype.degrees=function(){return this._radians*180/Math.PI},r.prototype.radians=function(){return this._radians},r.BetweenTwoPoints=function(e,t){var i=t.subtract(e),n=Math.atan2(i.y,i.x);return new r(n)},r.FromRadians=function(e){return new r(e)},r.FromDegrees=function(e){return new r(e*Math.PI/180)},r}();var s0=function(){function r(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;var n=Math.pow(t.x,2)+Math.pow(t.y,2),o=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2,a=(n-Math.pow(i.x,2)-Math.pow(i.y,2))/2,s=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new _e((o*(t.y-i.y)-a*(e.y-t.y))/s,((e.x-t.x)*a-(t.x-i.x)*o)/s),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=To.BetweenTwoPoints(this.centerPoint,this.startPoint);var f=this.startAngle.degrees(),u=To.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),l=To.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-f>180&&(u-=360),u-f<-180&&(u+=360),l-u>180&&(l-=360),l-u<-180&&(l+=360),this.orientation=u-f<0?Si.CW:Si.CCW,this.angle=To.FromDegrees(this.orientation===Si.CW?f-l:l-f)}return r}();var TU=function(){function r(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new _e(e,t))}return r.prototype.addLineTo=function(e,t){if(this.closed)return this;var i=new _e(e,t),n=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(n).length(),this},r.prototype.addArcTo=function(e,t,i,n,o){if(o===void 0&&(o=36),this.closed)return this;var a=this._points[this._points.length-1],s=new _e(e,t),f=new _e(i,n),u=new s0(a,s,f),l=u.angle.radians()/o;u.orientation===Si.CW&&(l*=-1);for(var h=u.startAngle.radians()+l,c=0;c<o;c++){var p=Math.cos(h)*u.radius+u.centerPoint.x,d=Math.sin(h)*u.radius+u.centerPoint.y;this.addLineTo(p,d),h+=l}return this},r.prototype.close=function(){return this.closed=!0,this},r.prototype.length=function(){var e=this._length;if(this.closed){var t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e},r.prototype.getPoints=function(){return this._points},r.prototype.getPointAtLengthPosition=function(e){if(e<0||e>1)return _e.Zero();for(var t=e*this.length(),i=0,n=0;n<this._points.length;n++){var o=(n+1)%this._points.length,a=this._points[n],s=this._points[o],f=s.subtract(a),u=f.length()+i;if(t>=i&&t<=u){var l=f.normalize(),h=t-i;return new _e(a.x+l.x*h,a.y+l.y*h)}i=u}return _e.Zero()},r.StartingAt=function(e,t){return new r(e,t)},r}();var AU=function(){function r(e,t,i,n){t===void 0&&(t=null),n===void 0&&(n=!1),this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:E.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:B.Identity()};for(var o=0;o<e.length;o++)this._curve[o]=e[o].clone();this._raw=i||!1,this._alignTangentsWithPath=n,this._compute(t,n)}return r.prototype.getCurve=function(){return this._curve},r.prototype.getPoints=function(){return this._curve},r.prototype.length=function(){return this._distances[this._distances.length-1]},r.prototype.getTangents=function(){return this._tangents},r.prototype.getNormals=function(){return this._normals},r.prototype.getBinormals=function(){return this._binormals},r.prototype.getDistances=function(){return this._distances},r.prototype.getPointAt=function(e){return this._updatePointAtData(e).point},r.prototype.getTangentAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?E.TransformCoordinates(E.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]},r.prototype.getNormalAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?E.TransformCoordinates(E.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]},r.prototype.getBinormalAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?E.TransformCoordinates(E.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]},r.prototype.getDistanceAt=function(e){return this.length()*e},r.prototype.getPreviousPointIndexAt=function(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex},r.prototype.getSubPositionAt=function(e){return this._updatePointAtData(e),this._pointAtData.subPosition},r.prototype.getClosestPositionTo=function(e){for(var t=Number.MAX_VALUE,i=0,n=0;n<this._curve.length-1;n++){var o=this._curve[n+0],a=this._curve[n+1].subtract(o).normalize(),s=this._distances[n+1]-this._distances[n+0],f=Math.min(Math.max(E.Dot(a,e.subtract(o).normalize()),0)*E.Distance(o,e)/s,1),u=E.Distance(o.add(a.scale(f*s)),e);u<t&&(t=u,i=(this._distances[n+0]+s*f)/this.length())}return i},r.prototype.slice=function(e,t){if(e===void 0&&(e=0),t===void 0&&(t=1),e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){var i=e;e=t,t=i}var n=this.getCurve(),o=this.getPointAt(e),a=this.getPreviousPointIndexAt(e),s=this.getPointAt(t),f=this.getPreviousPointIndexAt(t)+1,u=[];return e!==0&&(a++,u.push(o)),u.push.apply(u,n.slice(a,f)),(t!==1||e===1)&&u.push(s),new r(u,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)},r.prototype.update=function(e,t,i){t===void 0&&(t=null),i===void 0&&(i=!1);for(var n=0;n<e.length;n++)this._curve[n].x=e[n].x,this._curve[n].y=e[n].y,this._curve[n].z=e[n].z;return this._compute(t,i),this},r.prototype._compute=function(e,t){t===void 0&&(t=!1);var i=this._curve.length;if(!(i<2)){this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();var n=this._tangents[0],o=this._normalVector(n,e);this._normals[0]=o,this._raw||this._normals[0].normalize(),this._binormals[0]=E.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var a,s,f,u,l,h=1;h<i;h++)a=this._getLastNonNullVector(h),h<i-1&&(s=this._getFirstNonNullVector(h),this._tangents[h]=t?s:a.add(s),this._tangents[h].normalize()),this._distances[h]=this._distances[h-1]+this._curve[h].subtract(this._curve[h-1]).length(),f=this._tangents[h],l=this._binormals[h-1],this._normals[h]=E.Cross(l,f),this._raw||(this._normals[h].length()===0?(u=this._normals[h-1],this._normals[h]=u.clone()):this._normals[h].normalize()),this._binormals[h]=E.Cross(f,this._normals[h]),this._raw||this._binormals[h].normalize();this._pointAtData.id=NaN}},r.prototype._getFirstNonNullVector=function(e){for(var t=1,i=this._curve[e+t].subtract(this._curve[e]);i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i},r.prototype._getLastNonNullVector=function(e){for(var t=1,i=this._curve[e].subtract(this._curve[e-t]);i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i},r.prototype._normalVector=function(e,t){var i,n=e.length();if(n===0&&(n=1),t==null){var o=void 0;ae.WithinEpsilon(Math.abs(e.y)/n,1,ye)?ae.WithinEpsilon(Math.abs(e.x)/n,1,ye)?ae.WithinEpsilon(Math.abs(e.z)/n,1,ye)?o=E.Zero():o=new E(0,0,1):o=new E(1,0,0):o=new E(0,-1,0),i=E.Cross(e,o)}else i=E.Cross(e,t),E.CrossToRef(i,e,i);return i.normalize(),i},r.prototype._updatePointAtData=function(e,t){if(t===void 0&&(t=!1),this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;var i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);for(var n=i[0],o,a=0,s=e*this.length(),f=1;f<i.length;f++){o=i[f];var u=E.Distance(n,o);if(a+=u,a===s)return this._setPointAtData(e,1,o,f,t);if(a>s){var l=a-s,h=l/u,c=n.subtract(o),p=o.add(c.scaleInPlace(h));return this._setPointAtData(e,1-h,p,f-1,t)}n=o}return this._pointAtData},r.prototype._setPointAtData=function(e,t,i,n,o){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=n,this._pointAtData.interpolateReady=o,o&&this._updateInterpolationMatrix(),this._pointAtData},r.prototype._updateInterpolationMatrix=function(){this._pointAtData.interpolationMatrix=B.Identity();var e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){var t=e+1,i=this._tangents[e].clone(),n=this._normals[e].clone(),o=this._binormals[e].clone(),a=this._tangents[t].clone(),s=this._normals[t].clone(),f=this._binormals[t].clone(),u=ie.RotationQuaternionFromAxis(n,o,i),l=ie.RotationQuaternionFromAxis(s,f,a),h=ie.Slerp(u,l,this._pointAtData.subPosition);h.toRotationMatrix(this._pointAtData.interpolationMatrix)}},r}();var SU=function(){function r(e){this._length=0,this._points=e,this._length=this._computeLength(e)}return r.CreateQuadraticBezier=function(e,t,i,n){n=n>2?n:3;for(var o=new Array,a=function(f,u,l,h){var c=(1-f)*(1-f)*u+2*f*(1-f)*l+f*f*h;return c},s=0;s<=n;s++)o.push(new E(a(s/n,e.x,t.x,i.x),a(s/n,e.y,t.y,i.y),a(s/n,e.z,t.z,i.z)));return new r(o)},r.CreateCubicBezier=function(e,t,i,n,o){o=o>3?o:4;for(var a=new Array,s=function(u,l,h,c,p){var d=(1-u)*(1-u)*(1-u)*l+3*u*(1-u)*(1-u)*h+3*u*u*(1-u)*c+u*u*u*p;return d},f=0;f<=o;f++)a.push(new E(s(f/o,e.x,t.x,i.x,n.x),s(f/o,e.y,t.y,i.y,n.y),s(f/o,e.z,t.z,i.z,n.z)));return new r(a)},r.CreateHermiteSpline=function(e,t,i,n,o){for(var a=new Array,s=1/o,f=0;f<=o;f++)a.push(E.Hermite(e,t,i,n,f*s));return new r(a)},r.CreateCatmullRomSpline=function(e,t,i){var n=new Array,o=1/t,a=0;if(i){for(var s=e.length,f=0;f<s;f++){a=0;for(var u=0;u<t;u++)n.push(E.CatmullRom(e[f%s],e[(f+1)%s],e[(f+2)%s],e[(f+3)%s],a)),a+=o}n.push(n[0])}else{var l=new Array;l.push(e[0].clone()),Array.prototype.push.apply(l,e),l.push(e[e.length-1].clone());for(var f=0;f<l.length-3;f++){a=0;for(var u=0;u<t;u++)n.push(E.CatmullRom(l[f],l[f+1],l[f+2],l[f+3],a)),a+=o}f--,n.push(E.CatmullRom(l[f],l[f+1],l[f+2],l[f+3],a))}return new r(n)},r.ArcThru3Points=function(e,t,i,n,o,a){n===void 0&&(n=32),o===void 0&&(o=!1),a===void 0&&(a=!1);var s=new Array,f=t.subtract(e),u=i.subtract(t),l=e.subtract(i),h=E.Cross(f,u),c=h.length();if(c<Math.pow(10,-8))return new r(s);var p=f.lengthSquared(),d=u.lengthSquared(),m=l.lengthSquared(),_=h.lengthSquared(),y=f.length(),g=u.length(),T=l.length(),A=.5*y*g*T/c,M=E.Dot(f,l),C=E.Dot(f,u),P=E.Dot(u,l),R=-.5*d*M/_,F=-.5*m*C/_,I=-.5*p*P/_,D=e.scale(R).add(t.scale(F)).add(i.scale(I)),V=e.subtract(D),k=V.normalize(),w=E.Cross(h,k).normalize();if(a){for(var G=2*Math.PI/n,K=0;K<=2*Math.PI;K+=G)s.push(D.add(k.scale(A*Math.cos(K)).add(w.scale(A*Math.sin(K)))));s.push(e)}else{var G=1/n,K=0,j=E.Zero();do j=D.add(k.scale(A*Math.cos(K)).add(w.scale(A*Math.sin(K)))),s.push(j),K+=G;while(!j.equalsWithEpsilon(i,A*G*1.1));s.push(i),o&&s.push(e)}return new r(s)},r.prototype.getPoints=function(){return this._points},r.prototype.length=function(){return this._length},r.prototype.continue=function(e){for(var t=this._points[this._points.length-1],i=this._points.slice(),n=e.getPoints(),o=1;o<n.length;o++)i.push(n[o].subtract(n[0]).add(t));var a=new r(i);return a},r.prototype._computeLength=function(e){for(var t=0,i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t},r}();v();var xU=function(){function r(e,t){e===void 0&&(e=E.Zero()),t===void 0&&(t=E.Up()),this.position=e,this.normal=t}return r.prototype.clone=function(){return new r(this.position.clone(),this.normal.clone())},r}();var PU=function(){function r(e,t,i){e===void 0&&(e=E.Zero()),t===void 0&&(t=E.Up()),i===void 0&&(i=_e.Zero()),this.position=e,this.normal=t,this.uv=i}return r.prototype.clone=function(){return new r(this.position.clone(),this.normal.clone(),this.uv.clone())},r}();v();function td(r){var e=6,t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[],o=[],a=r.width||r.size||1,s=r.height||r.size||1,f=r.depth||r.size||1,u=r.wrap||!1,l=r.topBaseAt===void 0?1:r.topBaseAt,h=r.bottomBaseAt===void 0?0:r.bottomBaseAt;l=(l+4)%4,h=(h+4)%4;var c=[2,0,3,1],p=[2,0,1,3],d=c[l],m=p[h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(u){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];for(var y=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],g=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],T=[17,18,19,16],A=[22,23,20,21];d>0;)y.unshift(y.pop()),T.unshift(T.pop()),d--;for(;m>0;)g.unshift(g.pop()),A.unshift(A.pop()),m--;y=y.flat(),g=g.flat(),_=_.concat(y).concat(g),t.push(T[0],T[2],T[3],T[0],T[1],T[2]),t.push(A[0],A[2],A[3],A[0],A[1],A[2])}var M=[a/2,s/2,f/2];o=_.reduce(function(G,K,j){return G.concat(K*M[j%3])},[]);for(var C=r.sideOrientation===0?0:r.sideOrientation||re.DEFAULTSIDE,P=r.faceUV||new Array(6),R=r.faceColors,F=[],I=0;I<6;I++)P[I]===void 0&&(P[I]=new It(0,0,1,1)),R&&R[I]===void 0&&(R[I]=new Ae(1,1,1,1));for(var D=0;D<e;D++)if(n.push(P[D].z,Oe.UseOpenGLOrientationForUV?1-P[D].w:P[D].w),n.push(P[D].x,Oe.UseOpenGLOrientationForUV?1-P[D].w:P[D].w),n.push(P[D].x,Oe.UseOpenGLOrientationForUV?1-P[D].y:P[D].y),n.push(P[D].z,Oe.UseOpenGLOrientationForUV?1-P[D].y:P[D].y),R)for(var V=0;V<4;V++)F.push(R[D].r,R[D].g,R[D].b,R[D].a);re._ComputeSides(C,o,t,i,n,r.frontUVs,r.backUVs);var k=new re;if(k.indices=t,k.positions=o,k.normals=i,k.uvs=n,R){var w=C===re.DOUBLESIDE?F.concat(F):F;k.colors=w}return k}function es(r,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var i=new H(r,t);e.sideOrientation=H._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation;var n=td(e);return n.applyToMesh(i,e.updatable),i}re.CreateBox=td;H.CreateBox=function(r,e,t,i,n){t===void 0&&(t=null);var o={size:e,sideOrientation:n,updatable:i};return es(r,o,t)};var fe={},en=J.rendering.getScene(),ge=J.registry,Je=1;ge.registerMaterial("greenish",{color:[.2,.5,.2]});ge.registerMaterial("cloud",{color:[.9,.9,.92]});fe.green=ge.registerBlock(Je++,{material:"greenish"});fe.cloud=ge.registerBlock(Je++,{material:"cloud"});ge.registerMaterial("stone",{textureURL:"stone.png"});fe.stone=ge.registerBlock(Je++,{material:"stone"});ge.registerMaterial("a",{textureURL:"a.png"});ge.registerMaterial("b",{textureURL:"b.png"});ge.registerMaterial("c",{textureURL:"c.png"});fe.abc1=ge.registerBlock(Je++,{material:["a","b"]});fe.abc2=ge.registerBlock(Je++,{material:["a","b","c"]});fe.abc3=ge.registerBlock(Je++,{material:["a","b","c","a","b","c"]});var Tr="terrain_atlas.png";ge.registerMaterial("grass",{textureURL:Tr,atlasIndex:0});ge.registerMaterial("gside",{textureURL:Tr,atlasIndex:1});ge.registerMaterial("dirt",{textureURL:Tr,atlasIndex:2});ge.registerMaterial("stone",{textureURL:Tr,atlasIndex:3});fe.dirt=ge.registerBlock(Je++,{material:"dirt"});fe.grass=ge.registerBlock(Je++,{material:["grass","dirt","gside"]});fe.stone=ge.registerBlock(Je++,{material:"stone"});ge.registerMaterial("t1",{textureURL:"t1.png",texHasAlpha:!0});ge.registerMaterial("t2",{textureURL:"t2.png",texHasAlpha:!0});fe.transparent=ge.registerBlock(Je++,{material:["t1","t2"],opaque:!1});Tr="trans_atlas.png";var ts=!0;ge.registerMaterial("stonea",{textureURL:Tr,texHasAlpha:ts,atlasIndex:0});ge.registerMaterial("stonec",{textureURL:Tr,texHasAlpha:ts,atlasIndex:2});ge.registerMaterial("stonee",{textureURL:Tr,texHasAlpha:ts,atlasIndex:4});fe.stoneTrans=ge.registerBlock(Je++,{material:["stonea","stonee","stonec"],opaque:!1});ge.registerMaterial("water",{color:[.5,.5,.8,.7]});fe.water=ge.registerBlock(Je++,{material:"water",fluid:!0});var So=J.rendering.makeStandardMaterial("shinyDirtMat");So.specularColor.copyFromFloats(1,1,1);So.specularPower=32;So.bumpTexture=new Ie("textures/stone.png",en);ge.registerMaterial("shinyDirt",{color:[.45,.36,.22],renderMaterial:So});fe.shinyDirt=ge.registerBlock(Je++,{material:"shinyDirt"});var Mo=es("pole",{},en),rd=B.Scaling(.2,1,.2);rd.setTranslation(new E(0,.5,0));Mo.bakeTransformIntoVertices(rd);en.removeMesh(Mo);fe.pole=ge.registerBlock(Je++,{blockMesh:Mo,opaque:!1,onCustomMeshCreate:function(r,e,t,i){r.rotation.y=123.456*(e+32*i)%6.28}});fe.waterPole=ge.registerBlock(Je++,{blockMesh:Mo,solid:!0,opaque:!1,material:"water",fluid:!0});var id=r=>{var e=J.rendering.makeStandardMaterial("voxel_trans_"+r);e.backFaceCulling=!1,e.diffuseTexture=new Ie(`textures/${r}.png`),e.diffuseTexture.hasAlpha=!0;var t=bi("cross",{},en);t.material=e,t.rotation.y+=Math.PI/4,t.bakeTransformIntoVertices(B.Translation(0,.5,0));var i=t.clone();i.rotation.y+=Math.PI/2;var n=H.MergeMeshes([t,i],!0);return n};fe.custom1=ge.registerBlock(Je++,{blockMesh:id("t1"),opaque:!1});fe.custom2=ge.registerBlock(Je++,{blockMesh:id("t2"),opaque:!1});var Ao=J.rendering.makeStandardMaterial("windowMat");Ao.diffuseTexture=new Ie("textures/window.png",en);Ao.opacityTexture=Ao.diffuseTexture;ge.registerMaterial("window",{renderMaterial:Ao});fe.window=ge.registerBlock(Je++,{material:"window",opaque:!1});var xo="world1",ud="world2",ld=fd(),os={},l0=r=>!!os[r],h0=(r,e)=>{os[r]=ld.encode(e.data)},c0=(r,e)=>{ld.decode(os[r],e.data)};J.worldName=xo;J.inputs.bind("swap-world","KeyO");J.inputs.down.on("swap-world",function(){J.worldName=J.worldName===xo?ud:xo});J.world.on("chunkBeingRemoved",function(r,e,t){h0(r,e)});var is=[];J.world.on("worldDataNeeded",function(r,e,t,i,n,o){is.push({id:r,array:e,x:t,y:i,z:n,worldName:o})});setInterval(function(){if(is.length!==0){var r=is.shift();if(l0(r.id))c0(r.id,r.array);else{if(r.y<-50||r.y>50){var e=r.y>=0?0:fe.stone;return J.world.setChunkData(r.id,r.array,null,e)}d0(r.array,r.x,r.y,r.z,r.worldName)}J.world.setChunkData(r.id,r.array)}},10);function d0(r,e,t,i,n){n===xo&&p0(r,e,t,i),n===ud&&_0(r,e,t,i)}function p0(r,e,t,i){for(var n=0;n<r.shape[0];++n)for(var o=e+n,a=0;a<r.shape[2];++a){var s=i+a,f=ns(o,s,18,22);f+=ns(o,s+50,9,6)/2;for(var u=0;u<r.shape[1];++u){var l=hd(o,t+u,s,f);l&&r.set(n,u,a,l)}var h=v0(o,s,20,30);if(h>0){var c=h-2*Math.sin(o/17),p=h+3*Math.sin(s/22);for(u=0;u<r.shape[1];++u)t+u<c||t+u>p||r.set(n,u,a,fe.cloud)}}}function _0(r,e,t,i){for(var n=0;n<r.shape[0];++n)for(var o=0;o<r.shape[2];++o)for(var a=ns(e+n,i+o,20,40),s=0;s<r.shape[1];++s){var f=hd(e+n,t+s,i+o,a);f===fe.grass&&(f=fe.stone),f&&r.set(n,s,o,f)}}function ns(r,e,t,i){var n=1.7*Math.sin(r/t),o=2.2*Math.sin(e/i),a=Math.sqrt(r*r+e*e);return(n+o)*Math.min(1,a/100)}function v0(r,e,t,i){var n=5+5*Math.sin(5+r/t),o=6+4*Math.sin(8+e/i-r/35),a=3+7*Math.sin((r+e)/17);return n+o+a>20?35:-1}function hd(r,e,t,i){if(r>0&&t>0){var n=1;return(t==40||r==40)&&(n=20),e>=n?0:e<0?fe.stone:fe.green}return e<i?e<-2.2?fe.stone:e<0?fe.dirt:fe.grass:e>=0?0:fe.water}setTimeout(function(){m0()},1e3);function m0(){J.setBlock(fe.abc2,-7,4,3),J.setBlock(fe.transparent,-6,4,5),J.setBlock(fe.custom1,-5,4,7),J.setBlock(fe.custom2,-4,4,9),J.setBlock(fe.window,12,1,6),J.setBlock(fe.stoneTrans,14,1,6),J.setBlock(fe.waterPole,-18,-1,15),J.setBlock(fe.waterPole,-16,-1,15),J.setBlock(fe.waterPole,-14,-1,15),Vr(20,5,1,7,1,fe.pole),Vr(20,5,1,10,1,fe.pole),Vr(20,5,1,12,1,fe.pole),Vr(10,39,3,12,0,fe.pole),Vr(10,41,3,12,0,fe.pole),Vr(10,12,3,39,2,fe.pole),Vr(10,12,3,41,2,fe.pole);var r=4;g0(8,5,r,fe.shinyDirt)}function g0(r,e,t,i){for(var n=0;n<r;n++)J.setBlock(i,e+n,1,t+n),J.setBlock(i,r*2+e-n,1,t+n)}function Vr(r,e,t,i,n,o){for(var a=0;a<r;a++){var s=n===0?e:e+a,f=n===1?t:t+a,u=n===2?i:i+a;J.setBlock(o,s,f,u),n===0&&(f=t+r-a),n===1&&(s=e+r-a),n===2&&(s=e+r-a),J.setBlock(o,s,f,u)}}v();v();function cd(r){for(var e=r.segments||32,t=r.diameterX||r.diameter||1,i=r.diameterY||r.diameter||1,n=r.diameterZ||r.diameter||1,o=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,a=r.slice&&r.slice<=0?1:r.slice||1,s=r.sideOrientation===0?0:r.sideOrientation||re.DEFAULTSIDE,f=!!r.dedupTopBottomIndices,u=new E(t/2,i/2,n/2),l=2+e,h=2*l,c=[],p=[],d=[],m=[],_=0;_<=l;_++){for(var y=_/l,g=y*Math.PI*a,T=0;T<=h;T++){var A=T/h,M=A*Math.PI*2*o,C=B.RotationZ(-g),P=B.RotationY(M),R=E.TransformCoordinates(E.Up(),C),F=E.TransformCoordinates(R,P),I=F.multiply(u),D=F.divide(u).normalize();p.push(I.x,I.y,I.z),d.push(D.x,D.y,D.z),m.push(A,Oe.UseOpenGLOrientationForUV?1-y:y)}if(_>0)for(var V=p.length/3,k=V-2*(h+1);k+h+2<V;k++)f?(_>1&&(c.push(k),c.push(k+1),c.push(k+h+1)),(_<l||a<1)&&(c.push(k+h+1),c.push(k+1),c.push(k+h+2))):(c.push(k),c.push(k+1),c.push(k+h+1),c.push(k+h+1),c.push(k+1),c.push(k+h+2))}re._ComputeSides(s,p,c,d,m,r.frontUVs,r.backUVs);var w=new re;return w.indices=c,w.positions=p,w.normals=d,w.uvs=m,w}function y0(r,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var i=new H(r,t);e.sideOrientation=H._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation;var n=cd(e);return n.applyToMesh(i,e.updatable),i}re.CreateSphere=cd;H.CreateSphere=function(r,e,t,i,n,o){var a={segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:o,updatable:n};return y0(r,a,i)};var dd=J.playerEntity,pd=J.entities.getPositionData(dd),b0=pd.width,_d=pd.height,Po=H.CreateBox("player",1,J.rendering.getScene());Po.scaling.x=Po.scaling.z=b0;Po.scaling.y=_d;var E0=[0,_d/2,0];J.entities.addComponent(dd,J.entities.names.mesh,{mesh:Po,offset:E0});function vd(r){var e=r.entities,t=.2;as||(as=H.CreateSphere("ball",6,2*t,r.rendering.getScene()));var i=e.getPosition(r.playerEntity),n=[i[0],i[1]+.5,i[2]],o=2*t,a=2*t,s=as.createInstance("ball_instance"),f=[0,t,0],u=!0,l=!0,h=r.entities.add(n,o,a,s,f,u,l),c=e.getPhysicsBody(h);c.restitution=.8,c.friction=.7;for(var p=r.camera.getDirection(),d=[],m=0;m<3;m++)d[m]=5*p[m];d[1]+=1,c.applyImpulse(d),ss||(ss=(_,y)=>{for(var g=e.getPosition(_),T=e.getPosition(y),A=[],M=0;M<3;M++)A[M]=2*(g[M]-T[M]);var C=e.getPhysicsBody(_);C.applyImpulse(A)}),e.addComponent(h,e.names.collideEntities,{cylinder:!0,callback:_=>ss(h,_)}),fs||(fs=e.createComponent({name:"remove",system:(_,y)=>{var g=e.getPosition(r.playerEntity);y.forEach(T=>{for(var A=e.getPosition(T.__id),M=0,C=0;C<3;C++)M+=Math.abs(g[C]-A[C]);M>500&&e.deleteEntity(T.__id)})}})),e.addComponent(h,fs)}var as,ss,fs;v();J.inputs.down.on("fire",function(){if(J.targetedBlock){var r=J.targetedBlock.position;J.setBlock(0,r[0],r[1],r[2])}});var gd=1;J.inputs.down.on("alt-fire",function(){if(J.targetedBlock){var r=J.targetedBlock.adjacent;J.addBlock(gd,r[0],r[1],r[2])}});J.inputs.down.on("mid-fire",function(){J.targetedBlock&&(gd=J.targetedBlock.blockID)});J.inputs.bind("pause","KeyP");J.inputs.down.on("pause",function(){us=!us,J.setPaused(us)});var us=!1;J.inputs.bind("invert-mouse","KeyI");J.inputs.down.on("invert-mouse",function(){J.camera.inverseY=!J.camera.inverseY});J.inputs.bind("shoot","Digit1");var md=()=>vd(J),yd,bd;J.inputs.down.on("shoot",function(){md(),bd=setTimeout(()=>{yd=setInterval(md,50)},400)});J.inputs.up.on("shoot",function(){clearTimeout(bd),clearInterval(yd)});var T0=0;J.inputs.bind("slow","Digit3");J.inputs.down.on("slow",()=>{J.timeScale=[1,.1,2][++T0%3]});J.on("tick",function(r){var e=J.inputs.pointerState.scrolly;e!==0&&(J.camera.zoomDistance+=e>0?1:-1,J.camera.zoomDistance<0&&(J.camera.zoomDistance=0),J.camera.zoomDistance>10&&(J.camera.zoomDistance=10))});window.setViewDistance=(r=100)=>{r=r<50?50:r>5e3?5e3:r;var e=Math.max(1.5,r/J.world._chunkSize),t=Math.max(1.5,.5*e);J.world.setAddRemoveDistance([e,t],[e+1,t+1])};})();
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*!
 * ent-comp: a light, *fast* Entity Component System in JS
 * @url      github.com/andyhall/ent-comp
 * @author   Andy Hall <andy@fenomas.com>
 * @license  MIT
*/
/*!
 * noa: an experimental voxel game engine.
 * @url      github.com/fenomas/noa
 * @author   Andy Hall <andy@fenomas.com>
 * @license  MIT
 */
//# sourceMappingURL=bundle.js.map
