import{c as pi,d as nt,e as er,T as tr,f as di,E as Kr,R as mi,b as Wr,g as gi,O as _i,h as yi,V as fe,i as ki,S as Mi,F as Ci,a as Yr,H as wi,j as Li,k as Ti,l as bi}from"./babylon.939b618b.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();window&&!window.global&&(window.global=window.globalThis||{});var rr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},at={exports:{}},Ue=typeof Reflect=="object"?Reflect:null,_r=Ue&&typeof Ue.apply=="function"?Ue.apply:function(t,r,n){return Function.prototype.apply.call(t,r,n)},gt;Ue&&typeof Ue.ownKeys=="function"?gt=Ue.ownKeys:Object.getOwnPropertySymbols?gt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:gt=function(t){return Object.getOwnPropertyNames(t)};function Ei(e){console&&console.warn&&console.warn(e)}var Zr=Number.isNaN||function(t){return t!==t};function $(){$.init.call(this)}at.exports=$;at.exports.once=Ii;$.EventEmitter=$;$.prototype._events=void 0;$.prototype._eventsCount=0;$.prototype._maxListeners=void 0;var yr=10;function It(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty($,"defaultMaxListeners",{enumerable:!0,get:function(){return yr},set:function(e){if(typeof e!="number"||e<0||Zr(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");yr=e}});$.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};$.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Zr(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Xr(e){return e._maxListeners===void 0?$.defaultMaxListeners:e._maxListeners}$.prototype.getMaxListeners=function(){return Xr(this)};$.prototype.emit=function(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(r.length>0&&(o=r[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")_r(c,this,r);else for(var u=c.length,f=rn(c,u),n=0;n<u;++n)_r(f[n],this,r);return!0};function Qr(e,t,r,n){var i,s,o;if(It(r),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]),o===void 0)o=s[t]=r,++e._eventsCount;else if(typeof o=="function"?o=s[t]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),i=Xr(e),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,Ei(a)}return e}$.prototype.addListener=function(t,r){return Qr(this,t,r,!1)};$.prototype.on=$.prototype.addListener;$.prototype.prependListener=function(t,r){return Qr(this,t,r,!0)};function Fi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Jr(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=Fi.bind(n);return i.listener=r,n.wrapFn=i,i}$.prototype.once=function(t,r){return It(r),this.on(t,Jr(this,t,r)),this};$.prototype.prependOnceListener=function(t,r){return It(r),this.prependListener(t,Jr(this,t,r)),this};$.prototype.removeListener=function(t,r){var n,i,s,o,a;if(It(r),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===r||n.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===r||n[o].listener===r){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():Pi(n,s),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,a||r)}return this};$.prototype.off=$.prototype.removeListener;$.prototype.removeAllListeners=function(t){var r,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=n[t],typeof r=="function")this.removeListener(t,r);else if(r!==void 0)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this};function en(e,t,r){var n=e._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?r?[i.listener||i]:[i]:r?xi(i):rn(i,i.length)}$.prototype.listeners=function(t){return en(this,t,!0)};$.prototype.rawListeners=function(t){return en(this,t,!1)};$.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):tn.call(e,t)};$.prototype.listenerCount=tn;function tn(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}$.prototype.eventNames=function(){return this._eventsCount>0?gt(this._events):[]};function rn(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function Pi(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function xi(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function Ii(e,t){return new Promise(function(r,n){function i(o){e.removeListener(t,s),n(o)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),r([].slice.call(arguments))}nn(e,t,s,{once:!0}),t!=="error"&&Ai(e,i,{once:!0})})}function Ai(e,t,r){typeof e.on=="function"&&nn(e,"error",t,r)}function nn(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){n.once&&e.removeEventListener(t,i),r(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var sn=1e-6,on=Ri;function Ri(){var e=new Float32Array(3);return e[0]=0,e[1]=0,e[2]=0,e}var Oi=Si;function Si(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}var an=Di;function Di(e,t,r){var n=new Float32Array(3);return n[0]=e,n[1]=t,n[2]=r,n}var un=Bi;function Bi(e,t){var r=t[0],n=t[1],i=t[2],s=r*r+n*n+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s),e}var cn=Ui;function Ui(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var $i=Ni,kr=an,Mr=un,zi=cn;function Ni(e,t){var r=kr(e[0],e[1],e[2]),n=kr(t[0],t[1],t[2]);Mr(r,r),Mr(n,n);var i=zi(r,n);return i>1?0:Math.acos(i)}var qi=Vi;function Vi(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var Hi=ji;function ji(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e}var Gi=Ki,Ut=sn;function Ki(e,t){var r=e[0],n=e[1],i=e[2],s=t[0],o=t[1],a=t[2];return Math.abs(r-s)<=Ut*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-o)<=Ut*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-a)<=Ut*Math.max(1,Math.abs(i),Math.abs(a))}var Wi=Yi;function Yi(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var Zi=Xi;function Xi(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}var fn=Qi;function Qi(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}var ln={exports:{}};(function(e){e.exports=fn})(ln);var hn=Ji;function Ji(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}var vn={exports:{}};(function(e){e.exports=hn})(vn);var pn=es;function es(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}var dn={exports:{}};(function(e){e.exports=pn})(dn);var ts=rs;function rs(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}var ns=is;function is(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}var ss=os;function os(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}var as=us;function us(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}var cs=fs;function fs(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}var ls=hs;function hs(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}var vs=ps;function ps(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e}var mn=ds;function ds(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)}var gn={exports:{}};(function(e){e.exports=mn})(gn);var _n=ms;function ms(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}var yn={exports:{}};(function(e){e.exports=_n})(yn);var kn=gs;function gs(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)}var Mn={exports:{}};(function(e){e.exports=kn})(Mn);var Cn=_s;function _s(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}var wn={exports:{}};(function(e){e.exports=Cn})(wn);var ys=ks;function ks(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}var Ms=Cs;function Cs(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}var ws=Ls;function Ls(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[0],a=r[1],c=r[2];return e[0]=i*c-s*a,e[1]=s*o-n*c,e[2]=n*a-i*o,e}var Ts=bs;function bs(e,t,r,n){var i=t[0],s=t[1],o=t[2];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=o+n*(r[2]-o),e}var Es=Fs;function Fs(e,t){t=t||1;var r=Math.random()*2*Math.PI,n=Math.random()*2-1,i=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=n*t,e}var Ps=xs;function xs(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[3]*n+r[7]*i+r[11]*s+r[15];return o=o||1,e[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/o,e[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/o,e[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/o,e}var Is=As;function As(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=n*r[0]+i*r[3]+s*r[6],e[1]=n*r[1]+i*r[4]+s*r[7],e[2]=n*r[2]+i*r[5]+s*r[8],e}var Rs=Os;function Os(e,t,r){var n=t[0],i=t[1],s=t[2],o=r[0],a=r[1],c=r[2],u=r[3],f=u*n+a*s-c*i,v=u*i+c*n-o*s,d=u*s+o*i-a*n,m=-o*n-a*i-c*s;return e[0]=f*u+m*-o+v*-c-d*-a,e[1]=v*u+m*-a+d*-o-f*-c,e[2]=d*u+m*-c+f*-a-v*-o,e}var Ss=Ds;function Ds(e,t,r,n){var i=r[1],s=r[2],o=t[1]-i,a=t[2]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=t[0],e[1]=i+o*u-a*c,e[2]=s+o*c+a*u,e}var Bs=Us;function Us(e,t,r,n){var i=r[0],s=r[2],o=t[0]-i,a=t[2]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=i+a*c+o*u,e[1]=t[1],e[2]=s+a*u-o*c,e}var $s=zs;function zs(e,t,r,n){var i=r[0],s=r[1],o=t[0]-i,a=t[1]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=i+o*u-a*c,e[1]=s+o*c+a*u,e[2]=t[2],e}var Ns=qs,ke=on();function qs(e,t,r,n,i,s){var o,a;for(t||(t=3),r||(r=0),n?a=Math.min(n*t+r,e.length):a=e.length,o=r;o<a;o+=t)ke[0]=e[o],ke[1]=e[o+1],ke[2]=e[o+2],i(ke,ke,s),e[o]=ke[0],e[o+1]=ke[1],e[o+2]=ke[2];return e}var w={EPSILON:sn,create:on,clone:Oi,angle:$i,fromValues:an,copy:qi,set:Hi,equals:Gi,exactEquals:Wi,add:Zi,subtract:fn,sub:ln.exports,multiply:hn,mul:vn.exports,divide:pn,div:dn.exports,min:ts,max:ns,floor:ss,ceil:as,round:cs,scale:ls,scaleAndAdd:vs,distance:mn,dist:gn.exports,squaredDistance:_n,sqrDist:yn.exports,length:kn,len:Mn.exports,squaredLength:Cn,sqrLen:wn.exports,negate:ys,inverse:Ms,normalize:un,dot:cn,cross:ws,lerp:Ts,random:Es,transformMat4:Ps,transformMat3:Is,transformQuat:Rs,rotateX:Ss,rotateY:Bs,rotateZ:$s,forEach:Ns};function Vs(e){for(var t=new Array(e),r=0;r<e;++r)t[r]=r;return t}var Hs=Vs;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var js=function(e){return e!=null&&(Ln(e)||Gs(e)||!!e._isBuffer)};function Ln(e){return!!e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function Gs(e){return typeof e.readFloatLE=="function"&&typeof e.slice=="function"&&Ln(e.slice(0,0))}var Ks=Hs,Ws=js,Ys=typeof Float64Array<"u";function Zs(e,t){return e[0]-t[0]}function Xs(){var e=this.stride,t=new Array(e.length),r;for(r=0;r<t.length;++r)t[r]=[Math.abs(e[r]),r];t.sort(Zs);var n=new Array(t.length);for(r=0;r<n.length;++r)n[r]=t[r][1];return n}function Qs(e,t){var r=["View",t,"d",e].join("");t<0&&(r="View_Nil"+e);var n=e==="generic";if(t===-1){var i="function "+r+"(a){this.data=a;};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+r+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+r+"(a){return new "+r+"(a);}",p=new Function(i);return p()}else if(t===0){var i="function "+r+"(a,d) {this.data = a;this.offset = d};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+r+"_copy() {return new "+r+"(this.data,this.offset)};proto.pick=function "+r+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+r+"_get(){return "+(n?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+r+"_set(v){return "+(n?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+r+"(a,b,c,d){return new "+r+"(a,d)}",p=new Function("TrivialArray",i);return p(wt[e][0])}var i=["'use strict'"],s=Ks(t),o=s.map(function(l){return"i"+l}),a="this.offset+"+s.map(function(l){return"this.stride["+l+"]*i"+l}).join("+"),c=s.map(function(l){return"b"+l}).join(","),u=s.map(function(l){return"c"+l}).join(",");i.push("function "+r+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+r+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+r+"_size(){return "+s.map(function(l){return"this.shape["+l+"]"}).join("*"),"}})"),t===1?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+r+"_order(){"),t===2?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):t===3&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+r+"_set("+o.join(",")+",v){"),n?i.push("return this.data.set("+a+",v)}"):i.push("return this.data["+a+"]=v}"),i.push("proto.get=function "+r+"_get("+o.join(",")+"){"),n?i.push("return this.data.get("+a+")}"):i.push("return this.data["+a+"]}"),i.push("proto.index=function "+r+"_index(",o.join(),"){return "+a+"}"),i.push("proto.hi=function "+r+"_hi("+o.join(",")+"){return new "+r+"(this.data,"+s.map(function(l){return["(typeof i",l,"!=='number'||i",l,"<0)?this.shape[",l,"]:i",l,"|0"].join("")}).join(",")+","+s.map(function(l){return"this.stride["+l+"]"}).join(",")+",this.offset)}");var f=s.map(function(l){return"a"+l+"=this.shape["+l+"]"}),v=s.map(function(l){return"c"+l+"=this.stride["+l+"]"});i.push("proto.lo=function "+r+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+f.join(",")+","+v.join(","));for(var d=0;d<t;++d)i.push("if(typeof i"+d+"==='number'&&i"+d+">=0){d=i"+d+"|0;b+=c"+d+"*d;a"+d+"-=d}");i.push("return new "+r+"(this.data,"+s.map(function(l){return"a"+l}).join(",")+","+s.map(function(l){return"c"+l}).join(",")+",b)}"),i.push("proto.step=function "+r+"_step("+o.join(",")+"){var "+s.map(function(l){return"a"+l+"=this.shape["+l+"]"}).join(",")+","+s.map(function(l){return"b"+l+"=this.stride["+l+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var d=0;d<t;++d)i.push("if(typeof i"+d+"==='number'){d=i"+d+"|0;if(d<0){c+=b"+d+"*(a"+d+"-1);a"+d+"=ceil(-a"+d+"/d)}else{a"+d+"=ceil(a"+d+"/d)}b"+d+"*=d}");i.push("return new "+r+"(this.data,"+s.map(function(l){return"a"+l}).join(",")+","+s.map(function(l){return"b"+l}).join(",")+",c)}");for(var m=new Array(t),h=new Array(t),d=0;d<t;++d)m[d]="a[i"+d+"]",h[d]="b[i"+d+"]";i.push("proto.transpose=function "+r+"_transpose("+o+"){"+o.map(function(l,y){return l+"=("+l+"===undefined?"+y+":"+l+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+r+"(this.data,"+m.join(",")+","+h.join(",")+",this.offset)}"),i.push("proto.pick=function "+r+"_pick("+o+"){var a=[],b=[],c=this.offset");for(var d=0;d<t;++d)i.push("if(typeof i"+d+"==='number'&&i"+d+">=0){c=(c+this.stride["+d+"]*i"+d+")|0}else{a.push(this.shape["+d+"]);b.push(this.stride["+d+"])}");i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+r+"(data,shape,stride,offset){return new "+r+"(data,"+s.map(function(l){return"shape["+l+"]"}).join(",")+","+s.map(function(l){return"stride["+l+"]"}).join(",")+",offset)}");var p=new Function("CTOR_LIST","ORDER",i.join(`
`));return p(wt[e],Xs)}function Js(e){if(Ws(e))return"buffer";if(Ys)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}var wt={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function eo(e,t,r,n){if(e===void 0){var u=wt.array[0];return u([])}else typeof e=="number"&&(e=[e]);t===void 0&&(t=[e.length]);var i=t.length;if(r===void 0){r=new Array(i);for(var s=i-1,o=1;s>=0;--s)r[s]=o,o*=t[s]}if(n===void 0){n=0;for(var s=0;s<i;++s)r[s]<0&&(n-=(t[s]-1)*r[s])}for(var a=Js(e),c=wt[a];c.length<=i+1;)c.push(Qs(a,c.length-1));var u=c[i+1];return u(e,t,r,n)}var it=eo;function to(e,t,r,n,i,s,o,a,c,u){for(var f=0,v=Math.floor,d=v(t)|0,m=v(r)|0,h=v(n)|0,p=i>0?1:-1,l=s>0?1:-1,y=o>0?1:-1,g=Math.abs(1/i),_=Math.abs(1/s),k=Math.abs(1/o),M=p>0?d+1-t:t-d,T=l>0?m+1-r:r-m,E=y>0?h+1-n:n-h,L=g<1/0?g*M:1/0,F=_<1/0?_*T:1/0,C=k<1/0?k*E:1/0,b=-1;f<=a;){var A=e(d,m,h);if(A)return c&&(c[0]=t+f*i,c[1]=r+f*s,c[2]=n+f*o),u&&(u[0]=u[1]=u[2]=0,b===0&&(u[0]=-p),b===1&&(u[1]=-l),b===2&&(u[2]=-y)),A;L<F?L<C?(d+=p,f=L,L+=g,b=0):(h+=y,f=C,C+=k,b=2):F<C?(m+=l,f=F,F+=_,b=1):(h+=y,f=C,C+=k,b=2)}return c&&(c[0]=t+f*i,c[1]=r+f*s,c[2]=n+f*o),u&&(u[0]=u[1]=u[2]=0),0}function ro(e,t,r,n,i,s){var o=+t[0],a=+t[1],c=+t[2],u=+r[0],f=+r[1],v=+r[2],d=Math.sqrt(u*u+f*f+v*v);if(d===0)throw new Error("Can't raycast along a zero vector");return u/=d,f/=d,v/=d,typeof n>"u"?n=64:n=+n,to(e,o,a,c,u,f,v,n,i,s)}var no=ro,Lt={exports:{}},$e=typeof Reflect=="object"?Reflect:null,Cr=$e&&typeof $e.apply=="function"?$e.apply:function(t,r,n){return Function.prototype.apply.call(t,r,n)},_t;$e&&typeof $e.ownKeys=="function"?_t=$e.ownKeys:Object.getOwnPropertySymbols?_t=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:_t=function(t){return Object.getOwnPropertyNames(t)};function io(e){console&&console.warn&&console.warn(e)}var Tn=Number.isNaN||function(t){return t!==t};function z(){z.init.call(this)}Lt.exports=z;Lt.exports.once=uo;z.EventEmitter=z;z.prototype._events=void 0;z.prototype._eventsCount=0;z.prototype._maxListeners=void 0;var wr=10;function At(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(z,"defaultMaxListeners",{enumerable:!0,get:function(){return wr},set:function(e){if(typeof e!="number"||e<0||Tn(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");wr=e}});z.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};z.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Tn(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function bn(e){return e._maxListeners===void 0?z.defaultMaxListeners:e._maxListeners}z.prototype.getMaxListeners=function(){return bn(this)};z.prototype.emit=function(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(r.length>0&&(o=r[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")Cr(c,this,r);else for(var u=c.length,f=In(c,u),n=0;n<u;++n)Cr(f[n],this,r);return!0};function En(e,t,r,n){var i,s,o;if(At(r),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]),o===void 0)o=s[t]=r,++e._eventsCount;else if(typeof o=="function"?o=s[t]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),i=bn(e),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,io(a)}return e}z.prototype.addListener=function(t,r){return En(this,t,r,!1)};z.prototype.on=z.prototype.addListener;z.prototype.prependListener=function(t,r){return En(this,t,r,!0)};function so(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Fn(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=so.bind(n);return i.listener=r,n.wrapFn=i,i}z.prototype.once=function(t,r){return At(r),this.on(t,Fn(this,t,r)),this};z.prototype.prependOnceListener=function(t,r){return At(r),this.prependListener(t,Fn(this,t,r)),this};z.prototype.removeListener=function(t,r){var n,i,s,o,a;if(At(r),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===r||n.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===r||n[o].listener===r){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():oo(n,s),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,a||r)}return this};z.prototype.off=z.prototype.removeListener;z.prototype.removeAllListeners=function(t){var r,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=n[t],typeof r=="function")this.removeListener(t,r);else if(r!==void 0)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this};function Pn(e,t,r){var n=e._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?r?[i.listener||i]:[i]:r?ao(i):In(i,i.length)}z.prototype.listeners=function(t){return Pn(this,t,!0)};z.prototype.rawListeners=function(t){return Pn(this,t,!1)};z.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):xn.call(e,t)};z.prototype.listenerCount=xn;function xn(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}z.prototype.eventNames=function(){return this._eventsCount>0?_t(this._events):[]};function In(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function oo(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function ao(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function uo(e,t){return new Promise(function(r,n){function i(o){e.removeListener(t,s),n(o)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),r([].slice.call(arguments))}An(e,t,s,{once:!0}),t!=="error"&&co(e,i,{once:!0})})}function co(e,t,r){typeof e.on=="function"&&An(e,"error",t,r)}function An(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){n.once&&e.removeEventListener(t,i),r(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}const fo="game-inputs",lo="0.7.0",ho="Simple library to abstract key/mouse events for games.",vo="src/inputs.js",po="dist/src/inputs.d.ts",mo=["/src","/dist"],go={start:"cd docs/ && webpack serve",build:"tsc; cd docs/ && webpack"},_o="Andy Hall",yo="ISC",ko=["game","inputs","key","mouse","events"],Mo={events:"^3.3.0"},Co={type:"git",url:"https://github.com/fenomas/game-inputs"},wo={url:"https://github.com/fenomas/game-inputs/issues"},Lo={name:fo,version:lo,description:ho,main:vo,typings:po,files:mo,scripts:go,author:_o,license:yo,keywords:ko,dependencies:Mo,repository:Co,bugs:wo};var To=Lo.version;function bo(){this.preventDefaults=!1,this.stopPropagation=!1,this.allowContextMenu=!1,this.disabled=!1}class Eo{constructor(t,r){this.version=To;var n=Object.assign({},new bo,r||{});this.element=t||document,this.preventDefaults=!!n.preventDefaults,this.stopPropagation=!!n.stopPropagation,this.allowContextMenu=!!n.allowContextMenu,this.disabled=!!n.disabled,this.filterEvents=(i,s)=>!0,this.down=new Lt.exports.EventEmitter,this.up=new Lt.exports.EventEmitter,this.state={},this.pointerState={dx:0,dy:0,scrollx:0,scrolly:0,scrollz:0},this.pressCount={},this.releaseCount={},this._keyBindmap={},this._keyStates={},this._bindPressCount={},this._touches={lastX:0,lastY:0,currID:null},document.readyState!=="loading"?Lr(this):document.addEventListener("DOMContentLoaded",i=>{Lr(this)},{once:!0})}bind(t,...r){r.forEach(n=>{var i=this._keyBindmap[n]||[];i.includes(t)||(i.push(t),this._keyBindmap[n]=i)}),this.state[t]=!!this.state[t],this.pressCount[t]=this.pressCount[t]||0,this.releaseCount[t]=this.releaseCount[t]||0}unbind(t){for(var r in this._keyBindmap){var n=this._keyBindmap[r],i=n.indexOf(t);i>-1&&n.splice(i,1)}}getBindings(){var t={};for(var r in this._keyBindmap){var n=this._keyBindmap[r];n.forEach(i=>{t[i]=t[i]||[],t[i].push(r)})}return t}tick(){$t(this.pointerState),$t(this.pressCount),$t(this.releaseCount)}}function $t(e){for(var t in e)e[t]=0}function Lr(e){window.addEventListener("keydown",Tr.bind(null,e,!0),!1),window.addEventListener("keyup",Tr.bind(null,e,!1),!1);var t={passive:!0};window.PointerEvent?(e.element.addEventListener("pointerdown",ct.bind(null,e,!0),t),window.document.addEventListener("pointerup",ct.bind(null,e,!1),t),e.element.addEventListener("pointermove",br.bind(null,e),t)):(e.element.addEventListener("mousedown",ct.bind(null,e,!0),t),window.document.addEventListener("mouseup",ct.bind(null,e,!1),t),e.element.addEventListener("mousemove",br.bind(null,e),t)),e.element.addEventListener("wheel",Fo.bind(null,e),t),e.element.addEventListener("contextmenu",Po.bind(null,e),!1),window.addEventListener("blur",xo.bind(null,e),!1)}function Tr(e,t,r){ur(r.code,t,e,r)}function ct(e,t,r){if("pointerId"in r)if(t){if(e._touches.currID!==null)return;e._touches.currID=r.pointerId}else{if(e._touches.currID!==r.pointerId)return;e._touches.currID=null}var n="button"in r?r.button+1:1;return ur("Mouse"+n,t,e,r),!1}function br(e,t){if(!("pointerId"in t&&e._touches.currID!==null&&e._touches.currID!==t.pointerId)){var r=t.movementX||t.mozMovementX||0,n=t.movementY||t.mozMovementY||0;e.pointerState.dx+=r,e.pointerState.dy+=n}}function Fo(e,t){var r=1;switch(t.deltaMode){case 0:r=1;break;case 1:r=12;break;case 2:r=e.element.clientHeight||window.innerHeight;break}e.pointerState.scrollx+=(t.deltaX||0)*r,e.pointerState.scrolly+=(t.deltaY||0)*r,e.pointerState.scrollz+=(t.deltaZ||0)*r}function Po(e,t){if(!e.allowContextMenu)return t.preventDefault(),!1}function xo(e){for(var t in e._keyStates)!e._keyStates[t]||/^Mouse\d/.test(t)||ur(t,!1,e,{code:t,note:"This is a mocked KeyboardEvent made by the 'game-inputs' module",preventDefault:()=>{},stopPropagation:()=>{}})}function ur(e,t,r,n){var i=r._keyBindmap[e];if(!!i){var s=r._keyStates[e];Rn(s,t)&&(r._keyStates[e]=t,i.forEach(o=>{var a=r.filterEvents?r.filterEvents(n,o):!0;!a||Io(o,t,r,n)})),"button"in n||(r.preventDefaults&&!n.defaultPrevented&&n.preventDefault(),r.stopPropagation&&n.stopPropagation())}}function Io(e,t,r,n){var i=t?r.pressCount:r.releaseCount;i[e]=(i[e]||0)+1;var s=r._bindPressCount[e]||0;s+=t?1:-1,s<0&&(s=0),r._bindPressCount[e]=s;var o=r.state[e];if(Rn(o,s)){r.state[e]=s>0;var a=t?r.down:r.up;r.disabled||a.emit(e,n)}}function Rn(e,t){return e?!t:t}var Ao={preventDefaults:!1,stopPropagation:!1,allowContextMenu:!1},Ro={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],left:["KeyA","ArrowLeft"],right:["KeyD","ArrowRight"],fire:"Mouse1","mid-fire":["Mouse2","KeyQ"],"alt-fire":["Mouse3","KeyE"],jump:"Space"};class Oo extends Eo{constructor(t,r,n){r=Object.assign({},Ao,r),super(n,r);var i=r.bindings||Ro;for(var s in i){var o=Array.isArray(i[s])?i[s]:[i[s]];this.bind(s,...o)}}}class So{constructor(t=null,r=10,n=100){this.stickyPointerLock=!1,this.stickyFullscreen=!1,this.tickRate=30,this.maxRenderRate=0,this.pointerLock=!1,this.fullscreen=!1,this.onTick=function(i){},this.onRender=function(){},this.onInit=function(){},this.onResize=function(){},this.onPointerLockChanged=function(i){},this.onFullscreenChanged=function(i){},this.onPointerLockError=function(i){},$o(()=>{Do(this,r,n),Uo(this,t),this.onInit()})}}function Do(e,t,r){e._nowObject=performance||Date,e._skipFramesAfter=r,e._renderAccum=0;var n=e._nowObject.now();e._lastTick=n,e._lastRender=n,e._frameCB=Bo.bind(null,e),requestAnimationFrame(e._frameCB),t>0&&(e._intervalCB=On.bind(null,e),e._interval=setInterval(e._intervalCB,t))}function On(e){for(var t=e._nowObject.now(),r=t+e._skipFramesAfter,n=1e3/e.tickRate;e._lastTick+n<t;)if(e.onTick(n),e._lastTick+=n,t=e._nowObject.now(),t>r){e._lastTick=t;return}}function Bo(e){requestAnimationFrame(e._frameCB),On(e);var t=e._nowObject.now(),r=t-e._lastRender;if(e._lastRender=t,e.maxRenderRate>0){e._renderAccum+=r;var n=1e3/e.maxRenderRate;if(e._renderAccum<n)return;e._renderAccum=Math.min(e._renderAccum-n,n)}var i=1e3/e.tickRate,s=(t-e._lastTick)/i;e.onRender(r,s,i)}function Uo(e,t){if(!!t){var r=!1,n=!1,i=c=>{if(r=t===document.pointerLockElement,!!c!==r)if(c){var u=t.requestPointerLock();u&&u.catch&&u.catch(f=>{})}else document.exitPointerLock()},s=c=>{n=t===document.fullscreenElement,!!c!==n&&(c?t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};document.addEventListener("pointerlockchange",c=>{r=t===document.pointerLockElement,e.onPointerLockChanged(r)}),document.addEventListener("fullscreenchange",c=>{n=t===document.fullscreenElement,e.onFullscreenChanged(n)}),document.addEventListener("pointerlockerror",c=>{r=t===document.pointerLockElement,e.onPointerLockError(c)}),Object.defineProperty(e,"pointerLock",{get:()=>r,set:i}),Object.defineProperty(e,"fullscreen",{get:()=>n,set:s}),t.addEventListener("click",c=>{e.stickyPointerLock&&i(!0),e.stickyFullscreen&&s(!0)});var o=()=>e.onResize();if(window.ResizeObserver){var a=new ResizeObserver(o);a.observe(t)}else window.addEventListener("resize",o)}}var $o=e=>{if(document.readyState==="loading"){var t=()=>{document.removeEventListener("readystatechange",t),e()};document.addEventListener("readystatechange",t)}else setTimeout(e,1)};class zo extends at.exports.EventEmitter{constructor(t,r){super(),r=r||{},this.noa=t;var n=r.domElement||null;typeof n=="string"&&(n=document.querySelector(n)),this.element=n||No(),this.canvas=qo(this.element),Ho(this.canvas),this.supportsPointerLock=!1,this.pointerInGame=!1,this.isFocused=!!document.hasFocus(),this.hasPointerLock=!1;var i=10;this._shell=new So(this.element,i),this._shell.tickRate=r.tickRate,this._shell.maxRenderRate=r.maxRenderRate,this._shell.stickyPointerLock=r.stickyPointerLock,this._shell.stickyFullscreen=r.stickyFullscreen,this._shell.onTick=t.tick.bind(t),this._shell.onRender=t.render.bind(t),this._shell.onPointerLockChanged=s=>{this.hasPointerLock=s,this.emit(s?"gainedPointerLock":"lostPointerLock"),s&&(this.pointerInGame=!0)},this._shell.onInit=()=>{this._shell.onResize=t.rendering.resize.bind(t.rendering),Vo(this),this.element.addEventListener("mouseenter",()=>{this.pointerInGame=!0}),this.element.addEventListener("mouseleave",()=>{this.pointerInGame=!1}),window.addEventListener("focus",()=>{this.isFocused=!0}),window.addEventListener("blur",()=>{this.isFocused=!1});var s=()=>{this.pointerInGame=!0,this.isFocused=!0,this.element.removeEventListener("mousedown",s)};this.element.addEventListener("mousedown",s),this.emit("DOMready"),this._shell.onInit=null}}appendTo(t){this.element.appendChild(t)}setPointerLock(t=!1){this._shell.pointerLock=!!t}}function No(){var e=document.createElement("div");return e.tabIndex=1,e.style.position="fixed",e.style.left="0px",e.style.right="0px",e.style.top="0px",e.style.bottom="0px",e.style.height="100%",e.style.overflow="hidden",document.body.appendChild(e),document.body.style.overflow="hidden",document.body.style.height="100%",e.id="noa-container",e}function qo(e){var t=e.querySelector("canvas");return t||(t=document.createElement("canvas"),t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.height="100%",t.style.width="100%",t.id="noa-canvas",e.insertBefore(t,e.firstChild)),t}function Vo(e){var t="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(t){e.supportsPointerLock=!0;var r=function(n){e.supportsPointerLock=!1,document.removeEventListener(n.type,r)};document.addEventListener("touchmove",r)}}function Ho(e){var t=5,r=setInterval(()=>{var n=e.width;e.width=n+1,e.width=n,t--<0&&clearInterval(r)},100)}var Rt=Ve,G=w;function Ve(e,t){if(!(this instanceof Ve))return new Ve(e,t);var r=G.create();G.add(r,e,t),this.base=G.min(G.create(),e,r),this.vec=G.clone(t),this.max=G.max(G.create(),e,r),this.mag=G.length(this.vec)}var jo=Ve,Q=jo.prototype;Q.width=function(){return this.vec[0]};Q.height=function(){return this.vec[1]};Q.depth=function(){return this.vec[2]};Q.x0=function(){return this.base[0]};Q.y0=function(){return this.base[1]};Q.z0=function(){return this.base[2]};Q.x1=function(){return this.max[0]};Q.y1=function(){return this.max[1]};Q.z1=function(){return this.max[2]};Q.translate=function(e){return G.add(this.max,this.max,e),G.add(this.base,this.base,e),this};Q.setPosition=function(e){return G.add(this.max,e,this.vec),G.copy(this.base,e),this};Q.expand=function(e){var t=G.create(),r=G.create();return G.max(t,e.max,this.max),G.min(r,e.base,this.base),G.subtract(t,t,r),new Ve(r,t)};Q.intersects=function(e){return!(e.base[0]>this.max[0]||e.base[1]>this.max[1]||e.base[2]>this.max[2]||e.max[0]<this.base[0]||e.max[1]<this.base[1]||e.max[2]<this.base[2])};Q.touches=function(e){var t=this.union(e);return t!==null&&(t.width()==0||t.height()==0||t.depth()==0)};Q.union=function(e){if(!this.intersects(e))return null;var t=Math.max(e.base[0],this.base[0]),r=Math.max(e.base[1],this.base[1]),n=Math.max(e.base[2],this.base[2]),i=Math.min(e.max[0],this.max[0]),s=Math.min(e.max[1],this.max[1]),o=Math.min(e.max[2],this.max[2]);return new Ve([t,r,n],[i-t,s-r,o-n])};var Go=[],Ko=[],Wo=[],Yo=[],Zo=[],Xo=[],Qo=[],Jo=[],ea=[],ta=[],ra=[],na=[];function ia(e,t,r,n,i,s){var o=Go,a=Ko,c=Wo,u=Yo,f=Zo,v=Xo,d=Jo,m=Math.floor,h=0,p=0,l=0,y=0,g=0;if(k(),l===0)return 0;for(y=E();p<=l;){if(M(y)){var _=T();if(_)return h}y=E()}for(h+=l,g=0;g<3;g++)n[g]+=r[g],i[g]+=r[g];return h;function k(){if(p=0,l=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),l!==0)for(var C=0;C<3;C++){var b=r[C]>=0;u[C]=b?1:-1;var A=b?i[C]:n[C];o[C]=b?n[C]:i[C],a[C]=L(A,u[C]),c[C]=F(o[C],u[C]),d[C]=r[C]/l,f[C]=Math.abs(1/d[C]);var S=b?a[C]+1-A:A-a[C];v[C]=f[C]<1/0?f[C]*S:1/0}}function M(C){for(var b=u[0],A=C===0?a[0]:c[0],S=a[0]+b,P=u[1],x=C===1?a[1]:c[1],U=a[1]+P,R=u[2],I=C===2?a[2]:c[2],D=a[2]+R,V=A;V!=S;V+=b)for(var j=x;j!=U;j+=P)for(var ee=I;ee!=D;ee+=R)if(e(V,j,ee))return!0;return!1}function T(){h+=p;var C=u[y],b=p/l,A=ra;for(g=0;g<3;g++){var S=r[g]*b;n[g]+=S,i[g]+=S,A[g]=r[g]-S}C>0?i[y]=Math.round(i[y]):n[y]=Math.round(n[y]);var P=t(h,y,C,A);if(P)return!0;for(g=0;g<3;g++)r[g]=A[g];return k(),l===0}function E(){var C=v[0]<v[1]?v[0]<v[2]?0:2:v[1]<v[2]?1:2,b=v[C]-p;for(p=v[C],a[C]+=u[C],v[C]+=f[C],g=0;g<3;g++)o[g]+=b*d[g],c[g]=F(o[g],u[g]);return C}function L(C,b){return m(C-b*s)}function F(C,b){return m(C+b*s)}}function sa(e,t,r,n,i,s){for(var o=Qo,a=ea,c=ta,u=na,f=0;f<3;f++)o[f]=+r[f],c[f]=+t.max[f],a[f]=+t.base[f];s||(s=1e-10);var v=ia(e,n,o,a,c,s);if(!i){for(f=0;f<3;f++)u[f]=r[f]>0?c[f]-t.max[f]:a[f]-t.base[f];t.translate(u)}return v}var st=sa,oa={inverseX:!1,inverseY:!1,sensitivityX:10,sensitivityY:10,initialZoom:0,zoomSpeed:.2},zt=[w.create(),w.create(),w.create()],aa=w.create();class ua{constructor(t,r){r=Object.assign({},oa,r),this.noa=t,this.sensitivityX=+r.sensitivityX,this.sensitivityY=+r.sensitivityY,this.inverseX=!!r.inverseX,this.inverseY=!!r.inverseY,this.inputsDisabled=!1,this.heading=0,this.pitch=0,this.cameraTarget=this.noa.ents.createEntity(["position"]);var n=.9*t.ents.getPositionData(t.playerEntity).height;t.ents.addComponent(this.cameraTarget,"followsEntity",{entity:t.playerEntity,offset:[0,n,0]}),this.zoomDistance=r.initialZoom,this.zoomSpeed=r.zoomSpeed,this.currentZoom=r.initialZoom,this._dirVector=w.fromValues(0,0,1)}_localGetTargetPosition(){var t=this.noa.ents.getPositionData(this.cameraTarget),r=zt[0];return w.copy(r,t._renderPosition)}_localGetPosition(){var t=this._localGetTargetPosition();return this.currentZoom===0?t:w.scaleAndAdd(t,t,this._dirVector,-this.currentZoom)}getTargetPosition(){var t=this._localGetTargetPosition(),r=zt[1];return this.noa.localToGlobal(t,r)}getPosition(){var t=this._localGetPosition(),r=zt[2];return this.noa.localToGlobal(t,r)}getDirection(){return this._dirVector}applyInputsToCamera(){var t=this.noa.inputs.pointerState;fa(t);var r=.0066*Math.PI/180,n=t.dy*this.sensitivityY*r,i=t.dx*this.sensitivityX*r;this.inverseY&&(n=-n),this.inverseX&&(i=-i),this.inputsDisabled&&(i=n=0);var s=2*Math.PI;this.heading+=i<0?i+s:i,this.heading>s&&(this.heading-=s);var o=Math.PI/2-.001;this.pitch=Math.max(-o,Math.min(o,this.pitch+n)),w.set(this._dirVector,0,0,1);var a=this._dirVector,c=aa;w.rotateX(a,a,c,this.pitch),w.rotateY(a,a,c,this.heading)}updateBeforeEntityRenderSystems(){this.currentZoom+=(this.zoomDistance-this.currentZoom)*this.zoomSpeed}updateAfterEntityRenderSystems(){var t=ca(this);this.currentZoom>t&&(this.currentZoom=t)}}function ca(e){e._sweepBox||(e._sweepBox=new Rt([0,0,0],[.2,.2,.2]),e._sweepGetVoxel=e.noa.world.getBlockSolidity.bind(e.noa.world),e._sweepVec=w.create(),e._sweepHit=()=>!0);var t=w.copy(e._sweepVec,e._localGetTargetPosition());w.add(t,t,e.noa.worldOriginOffset);for(var r=0;r<3;r++)t[r]-=.1;e._sweepBox.setPosition(t);var n=Math.max(e.zoomDistance,e.currentZoom)+.1;return w.scale(e._sweepVec,e.getDirection(),-n),st(e._sweepGetVoxel,e._sweepBox,e._sweepVec,e._sweepHit,!0)}function fa(e){var t=e.dx,r=e.dy,n=Math.abs(t)>400&&Math.abs(t/Ye)>4,i=Math.abs(r)>400&&Math.abs(r/Ze)>4;n||i?(e.dx=Ye,e.dy=Ze,Ye=(Ye+t)/2,Ze=(Ze+r)/2):(Ye=t||1,Ze=r||1)}var Ye=0,Ze=0,la=class{constructor(){this.list=[],this.hash={},this._map={},this._pendingRemovals=[]}add(t,r){if(typeof this._map[t]=="number"){var n=this._map[t];this.hash[t]=r,this.list[n]=r}else this._map[t]=this.list.length,this.hash[t]=r,this.list.push(r)}remove(t){var r=this._map[t];this.hash[t]=null,this.list[r]=null,this._pendingRemovals.push(t)}dispose(){this.list=null,this.hash=null,this._map=null,this._pendingRemovals.length=0}flush(){for(var t=0;t<this._pendingRemovals.length;t++){var r=this._pendingRemovals[t];this.hash[r]===null&&ha(this,r)}this._pendingRemovals.length=0}};function ha(e,t){var r=e._map[t];if(delete e.hash[t],delete e._map[t],r===e.list.length-1)e.list.pop();else{var n=e.list.pop();if(e.list[r]=n,n===null||n[0]===null){var i=e.list.length;for(var s in e._map)if(e._map[s]===i){e._map[s]=r;return}}else{var o=n.__id||n[0].__id;e._map[o]=r}}}var va=da,pa=la;/*!
 * ent-comp: a light, *fast* Entity Component System in JS
 * @url      github.com/andyhall/ent-comp
 * @author   Andy Hall <andy@fenomas.com>
 * @license  MIT
*/function da(){var e=this;this.components={},this.comps=this.components;var t=this.components,r=1,n={},i=[],s=[],o={timeout:!1,removals:[],multiComps:[]};this._storage=n,this._systems=i,this._renderSystems=s,this.createEntity=function(h){var p=r++;return Array.isArray(h)&&h.forEach(l=>e.addComponent(p,l)),p},this.deleteEntity=function(h){return Object.keys(n).forEach(p=>{var l=n[p];l.hash[h]&&a(h,p)}),e},this.createComponent=function(h){if(!h)throw"Missing component definition";var p=h.name;if(!p)throw"Component definition must have a name property.";if(typeof p!="string")throw"Component name must be a string.";if(p==="")throw"Component name must be a non-empty string.";if(n[p])throw`Component ${p} already exists.`;var l={};return l.name=p,l.multi=!!h.multi,l.order=isNaN(h.order)?99:h.order,l.state=h.state||{},l.onAdd=h.onAdd||null,l.onRemove=h.onRemove||null,l.system=h.system||null,l.renderSystem=h.renderSystem||null,t[p]=l,n[p]=new pa,n[p]._pendingMultiCleanup=!1,n[p]._multiCleanupIDs=l.multi?[]:null,l.system&&(i.push(p),i.sort((y,g)=>t[y].order-t[g].order)),l.renderSystem&&(s.push(p),s.sort((y,g)=>t[y].order-t[g].order)),p},this.deleteComponent=function(h){var p=n[h];if(!p)throw`Unknown component: ${h}`;p.flush(),p.list.forEach(g=>{if(!!g){var _=g.__id||g[0].__id;a(_,h)}});var l=i.indexOf(h),y=s.indexOf(h);return l>-1&&i.splice(l,1),y>-1&&s.splice(y,1),n[h].dispose(),delete n[h],delete t[h],e},this.addComponent=function(h,p,l){var y=t[p],g=n[p];if(!g)throw`Unknown component: ${p}.`;if(g.hash[h]&&!y.multi)throw`Entity ${h} already has component: ${p}.`;var _=Object.assign({},{__id:h},y.state,l);if(_.__id=h,y.multi){var k=g.hash[h];k||(k=[],g.add(h,k)),k.push(_)}else g.add(h,_);return y.onAdd&&y.onAdd(h,_),this},this.hasComponent=function(h,p){var l=n[p];if(!l)throw`Unknown component: ${p}.`;return!!l.hash[h]},this.removeComponent=function(h,p){var l=n[p];if(!l)throw`Unknown component: ${p}.`;return a(h,p),e},this.getState=function(h,p){var l=n[p];if(!l)throw`Unknown component: ${p}.`;return l.hash[h]},this.getStatesList=function(h){var p=n[h];if(!p)throw`Unknown component: ${h}.`;return v(),p.list},this.getStateAccessor=function(h){if(!n[h])throw`Unknown component: ${h}.`;var p=n[h].hash;return l=>p[l]},this.getComponentAccessor=function(h){if(!n[h])throw`Unknown component: ${h}.`;var p=n[h].hash;return l=>!!p[l]},this.tick=function(h){v();for(var p=0;p<i.length;p++){var l=i[p],y=t[l],g=n[l];y.system(h,g.list),v()}return e},this.render=function(h){v();for(var p=0;p<s.length;p++){var l=s[p],y=t[l],g=n[l];y.renderSystem(h,g.list),v()}return e},this.removeMultiComponent=function(h,p,l){var y=t[p],g=n[p];if(!g)throw`Unknown component: ${p}.`;if(!y.multi)throw"removeMultiComponent called on non-multi component";return c(h,y,g,l),e};function a(h,p){var l=t[p],y=n[p],g=y.hash[h];!g||(y.remove(h),l.onRemove&&(l.multi?(g.forEach(_=>{_&&l.onRemove(h,_)}),g.length=0):l.onRemove(h,g)),o.removals.push(y),u())}function c(h,p,l,y){var g=l.hash[h];if(!!g){var _=g[y];!_||(g[y]=null,p.onRemove&&p.onRemove(h,_),o.multiComps.push({entID:h,data:l}),u())}}function u(){o.timeout||(o.timeout=!0,setTimeout(f,1))}function f(){o.timeout=!1,v()}function v(){o.multiComps.length&&d(o.multiComps),o.removals.length&&m(o.removals)}function d(h){for(var p=0;p<h.length;p++){var{entID:l,data:y}=h[p],g=y.hash[l];if(!!g){for(var _=0;_<g.length;_++)g[_]||(g.splice(_,1),_--);g.length===0&&(y.remove(l),o.removals.push(y))}}h.length=0}function m(h){for(var p=0;p<h.length;p++){var l=h[p];l.flush()}h.length=0}}class ma{constructor(){this.position=null,this.width=.8,this.height=.8,this._localPosition=null,this._renderPosition=null,this._extents=null}}function ga(e){return{name:"position",order:60,state:new ma,onAdd:function(t,r){var n=[0,0,0];r.position&&w.copy(n,r.position),r.position=n,r._localPosition=w.create(),r._renderPosition=w.create(),r._extents=new Float32Array(6),e.globalToLocal(r.position,null,r._localPosition),w.copy(r._renderPosition,r._localPosition),nr(r)},onRemove:null,system:function(t,r){for(var n=e.worldOriginOffset,i=0;i<r.length;i++){var s=r[i];w.add(s.position,s._localPosition,n),nr(s)}}}}function nr(e){var t=e.width/2,r=e._localPosition,n=e._extents;n[0]=r[0]-t,n[1]=r[1],n[2]=r[2]-t,n[3]=r[0]+t,n[4]=r[1]+e.height,n[5]=r[2]+t}class _a{constructor(){this.body=null}}function ya(e){return{name:"physics",order:40,state:new _a,onAdd:function(t,r){r.body=e.physics.addBody();var n=e.ents.getPositionData(r.__id);Sn(r,n)},onRemove:function(t,r){if(e.ents.hasPosition(r.__id)){var n=e.ents.getPositionData(r.__id);Er(r,n),Fr(r,n,0,!1)}e.physics.removeBody(r.body)},system:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],s=e.ents.getPositionData(i.__id);Er(i,s)}},renderSystem:function(t,r){var n=e.positionInCurrentTick,i=1e3/e.container._shell.tickRate;i*=e.timeScale;for(var s=n*i,o=(s-i)/1e3,a=0;a<r.length;a++){var c=r[a],u=c.__id,f=e.ents.getPositionData(u),v=e.ents.cameraSmoothed(u);Fr(c,f,o,v)}}}}var ft=w.create();function Sn(e,t){var r=e.body.aabb,n=t._extents;w.copy(r.base,n),w.set(r.vec,t.width,t.height,t.width),w.add(r.max,r.base,r.vec)}function Er(e,t){var r=e.body.aabb.base,n=t.width/2;w.set(t._localPosition,r[0]+n,r[1],r[2]+n)}function Fr(e,t,r,n){var i=e.body.velocity;w.scaleAndAdd(ft,t._localPosition,i,r),n&&w.lerp(ft,t._renderPosition,ft,.3),w.copy(t._renderPosition,ft)}var B={},N={},cr=32;N.INT_BITS=cr;N.INT_MAX=2147483647;N.INT_MIN=-1<<cr-1;N.sign=function(e){return(e>0)-(e<0)};N.abs=function(e){var t=e>>cr-1;return(e^t)-t};N.min=function(e,t){return t^(e^t)&-(e<t)};N.max=function(e,t){return e^(e^t)&-(e<t)};N.isPow2=function(e){return!(e&e-1)&&!!e};N.log2=function(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,t|=r,t|e>>1};N.log10=function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0};N.popCount=function(e){return e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),(e+(e>>>4)&252645135)*16843009>>>24};function Dn(e){var t=32;return e&=-e,e&&t--,e&65535&&(t-=16),e&16711935&&(t-=8),e&252645135&&(t-=4),e&858993459&&(t-=2),e&1431655765&&(t-=1),t}N.countTrailingZeros=Dn;N.nextPow2=function(e){return e+=e===0,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+1};N.prevPow2=function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e-(e>>>1)};N.parity=function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,e&=15,27030>>>e&1};var Je=new Array(256);(function(e){for(var t=0;t<256;++t){var r=t,n=t,i=7;for(r>>>=1;r;r>>>=1)n<<=1,n|=r&1,--i;e[t]=n<<i&255}})(Je);N.reverse=function(e){return Je[e&255]<<24|Je[e>>>8&255]<<16|Je[e>>>16&255]<<8|Je[e>>>24&255]};N.interleave2=function(e,t){return e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t&=65535,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e|t<<1};N.deinterleave2=function(e,t){return e=e>>>t&1431655765,e=(e|e>>>1)&858993459,e=(e|e>>>2)&252645135,e=(e|e>>>4)&16711935,e=(e|e>>>16)&65535,e<<16>>16};N.interleave3=function(e,t,r){return e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,e|=t<<1,r&=1023,r=(r|r<<16)&4278190335,r=(r|r<<8)&251719695,r=(r|r<<4)&3272356035,r=(r|r<<2)&1227133513,e|r<<2};N.deinterleave3=function(e,t){return e=e>>>t&1227133513,e=(e|e>>>2)&3272356035,e=(e|e>>>4)&251719695,e=(e|e>>>8)&4278190335,e=(e|e>>>16)&1023,e<<22>>22};N.nextCombination=function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>Dn(e)+1};function Bn(e,t,r){var n=e[r]|0;if(n<=0)return[];var i=new Array(n),s;if(r===e.length-1)for(s=0;s<n;++s)i[s]=t;else for(s=0;s<n;++s)i[s]=Bn(e,t,r+1);return i}function ka(e,t){var r,n;for(r=new Array(e),n=0;n<e;++n)r[n]=t;return r}function Ma(e,t){switch(typeof t>"u"&&(t=0),typeof e){case"number":if(e>0)return ka(e|0,t);break;case"object":if(typeof e.length=="number")return Bn(e,t,0);break}return[]}var Ca=Ma;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var wa=function(t){return t!=null&&t.constructor!=null&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t)},He=N,te=Ca,La=wa;rr.__TYPEDARRAY_POOL||(rr.__TYPEDARRAY_POOL={UINT8:te([32,0]),UINT16:te([32,0]),UINT32:te([32,0]),INT8:te([32,0]),INT16:te([32,0]),INT32:te([32,0]),FLOAT:te([32,0]),DOUBLE:te([32,0]),DATA:te([32,0]),UINT8C:te([32,0]),BUFFER:te([32,0])});var Ta=typeof Uint8ClampedArray<"u",Z=rr.__TYPEDARRAY_POOL;Z.UINT8C||(Z.UINT8C=te([32,0]));Z.BUFFER||(Z.BUFFER=te([32,0]));var Ot=Z.DATA,fr=Z.BUFFER;B.free=function(t){if(La(t))fr[He.log2(t.length)].push(t);else{if(Object.prototype.toString.call(t)!=="[object ArrayBuffer]"&&(t=t.buffer),!t)return;var r=t.length||t.byteLength,n=He.log2(r)|0;Ot[n].push(t)}};function Un(e){if(!!e){var t=e.length||e.byteLength,r=He.log2(t);Ot[r].push(e)}}function ba(e){Un(e.buffer)}B.freeUint8=B.freeUint16=B.freeUint32=B.freeInt8=B.freeInt16=B.freeInt32=B.freeFloat32=B.freeFloat=B.freeFloat64=B.freeDouble=B.freeUint8Clamped=B.freeDataView=ba;B.freeArrayBuffer=Un;B.freeBuffer=function(t){fr[He.log2(t.length)].push(t)};B.malloc=function(t,r){if(r===void 0||r==="arraybuffer")return ne(t);switch(r){case"uint8":return lr(t);case"uint16":return $n(t);case"uint32":return zn(t);case"int8":return Nn(t);case"int16":return qn(t);case"int32":return Vn(t);case"float":case"float32":return Hn(t);case"double":case"float64":return jn(t);case"uint8_clamped":return Gn(t);case"buffer":throw"Buffer not supported";case"data":case"dataview":return Kn(t);default:return null}return null};function ne(t){var t=He.nextPow2(t),r=He.log2(t),n=Ot[r];return n.length>0?n.pop():new ArrayBuffer(t)}B.mallocArrayBuffer=ne;function lr(e){return new Uint8Array(ne(e),0,e)}B.mallocUint8=lr;function $n(e){return new Uint16Array(ne(2*e),0,e)}B.mallocUint16=$n;function zn(e){return new Uint32Array(ne(4*e),0,e)}B.mallocUint32=zn;function Nn(e){return new Int8Array(ne(e),0,e)}B.mallocInt8=Nn;function qn(e){return new Int16Array(ne(2*e),0,e)}B.mallocInt16=qn;function Vn(e){return new Int32Array(ne(4*e),0,e)}B.mallocInt32=Vn;function Hn(e){return new Float32Array(ne(4*e),0,e)}B.mallocFloat32=B.mallocFloat=Hn;function jn(e){return new Float64Array(ne(8*e),0,e)}B.mallocFloat64=B.mallocDouble=jn;function Gn(e){return Ta?new Uint8ClampedArray(ne(e),0,e):lr(e)}B.mallocUint8Clamped=Gn;function Kn(e){return new DataView(ne(e),0,e)}B.mallocDataView=Kn;B.clearCache=function(){for(var t=0;t<32;++t)Z.UINT8[t].length=0,Z.UINT16[t].length=0,Z.UINT32[t].length=0,Z.INT8[t].length=0,Z.INT16[t].length=0,Z.INT32[t].length=0,Z.FLOAT[t].length=0,Z.DOUBLE[t].length=0,Z.UINT8C[t].length=0,Ot[t].length=0,fr[t].length=0};var Ea=Fa,yt=32;function Fa(e,t){t<=4*yt?kt(0,t-1,e):Mt(0,t-1,e)}function kt(e,t,r){for(var n=2*(e+1),i=e+1;i<=t;++i){for(var s=r[n++],o=r[n++],a=i,c=n-2;a-- >e;){var u=r[c-2],f=r[c-1];if(u<s)break;if(u===s&&f<o)break;r[c]=u,r[c+1]=f,c-=2}r[c]=s,r[c+1]=o}}function Pr(e,t,r){e*=2,t*=2;var n=r[e],i=r[e+1];r[e]=r[t],r[e+1]=r[t+1],r[t]=n,r[t+1]=i}function xr(e,t,r){e*=2,t*=2,r[e]=r[t],r[e+1]=r[t+1]}function Pa(e,t,r,n){e*=2,t*=2,r*=2;var i=n[e],s=n[e+1];n[e]=n[t],n[e+1]=n[t+1],n[t]=n[r],n[t+1]=n[r+1],n[r]=i,n[r+1]=s}function Ir(e,t,r,n,i){e*=2,t*=2,i[e]=i[t],i[t]=r,i[e+1]=i[t+1],i[t+1]=n}function de(e,t,r){e*=2,t*=2;var n=r[e],i=r[t];return n<i?!1:n===i?r[e+1]>r[t+1]:!0}function lt(e,t,r,n){e*=2;var i=n[e];return i<t?!0:i===t?n[e+1]<r:!1}function Mt(e,t,r){var n=(t-e+1)/6|0,i=e+n,s=t-n,o=e+t>>1,a=o-n,c=o+n,u=i,f=a,v=o,d=c,m=s,h=e+1,p=t-1,l=0;de(u,f,r)&&(l=u,u=f,f=l),de(d,m,r)&&(l=d,d=m,m=l),de(u,v,r)&&(l=u,u=v,v=l),de(f,v,r)&&(l=f,f=v,v=l),de(u,d,r)&&(l=u,u=d,d=l),de(v,d,r)&&(l=v,v=d,d=l),de(f,m,r)&&(l=f,f=m,m=l),de(f,v,r)&&(l=f,f=v,v=l),de(d,m,r)&&(l=d,d=m,m=l);for(var y=r[2*f],g=r[2*f+1],_=r[2*d],k=r[2*d+1],M=2*u,T=2*v,E=2*m,L=2*i,F=2*o,C=2*s,b=0;b<2;++b){var A=r[M+b],S=r[T+b],P=r[E+b];r[L+b]=A,r[F+b]=S,r[C+b]=P}xr(a,e,r),xr(c,t,r);for(var x=h;x<=p;++x)if(lt(x,y,g,r))x!==h&&Pr(x,h,r),++h;else if(!lt(x,_,k,r))for(;;)if(lt(p,_,k,r)){lt(p,y,g,r)?(Pa(x,h,p,r),++h,--p):(Pr(x,p,r),--p);break}else{if(--p<x)break;continue}Ir(e,h-1,y,g,r),Ir(t,p+1,_,k,r),h-2-e<=yt?kt(e,h-2,r):Mt(e,h-2,r),t-(p+2)<=yt?kt(p+2,t,r):Mt(p+2,t,r),p-h<=yt?kt(h,p,r):Mt(h,p,r)}var Wn={init:Ia,sweepBipartite:Aa,sweepComplete:Ra,scanBipartite:Oa,scanComplete:Sa},q=B,xa=N,St=Ea,re=1<<28,xe=1024,K=q.mallocInt32(xe),_e=q.mallocInt32(xe),ye=q.mallocInt32(xe),Fe=q.mallocInt32(xe),ze=q.mallocInt32(xe),rt=q.mallocInt32(xe),O=q.mallocDouble(xe*8);function Ia(e){var t=xa.nextPow2(e);K.length<t&&(q.free(K),K=q.mallocInt32(t)),_e.length<t&&(q.free(_e),_e=q.mallocInt32(t)),ye.length<t&&(q.free(ye),ye=q.mallocInt32(t)),Fe.length<t&&(q.free(Fe),Fe=q.mallocInt32(t)),ze.length<t&&(q.free(ze),ze=q.mallocInt32(t)),rt.length<t&&(q.free(rt),rt=q.mallocInt32(t));var r=8*t;O.length<r&&(q.free(O),O=q.mallocDouble(r))}function Ne(e,t,r,n){var i=t[n],s=e[r-1];e[i]=s,t[s]=i}function qe(e,t,r,n){e[r]=n,t[n]=r}function Aa(e,t,r,n,i,s,o,a,c,u){for(var f=0,v=2*e,d=e-1,m=v-1,h=r;h<n;++h){var p=s[h],l=v*h;O[f++]=i[l+d],O[f++]=-(p+1),O[f++]=i[l+m],O[f++]=p}for(var h=o;h<a;++h){var p=u[h]+re,y=v*h;O[f++]=c[y+d],O[f++]=-p,O[f++]=c[y+m],O[f++]=p}var g=f>>>1;St(O,g);for(var _=0,k=0,h=0;h<g;++h){var M=O[2*h+1]|0;if(M>=re)M=M-re|0,Ne(ye,Fe,k--,M);else if(M>=0)Ne(K,_e,_--,M);else if(M<=-re){M=-M-re|0;for(var T=0;T<_;++T){var E=t(K[T],M);if(E!==void 0)return E}qe(ye,Fe,k++,M)}else{M=-M-1|0;for(var T=0;T<k;++T){var E=t(M,ye[T]);if(E!==void 0)return E}qe(K,_e,_++,M)}}}function Ra(e,t,r,n,i,s,o,a,c,u){for(var f=0,v=2*e,d=e-1,m=v-1,h=r;h<n;++h){var p=s[h]+1<<1,l=v*h;O[f++]=i[l+d],O[f++]=-p,O[f++]=i[l+m],O[f++]=p}for(var h=o;h<a;++h){var p=u[h]+1<<1,y=v*h;O[f++]=c[y+d],O[f++]=-p|1,O[f++]=c[y+m],O[f++]=p|1}var g=f>>>1;St(O,g);for(var _=0,k=0,M=0,h=0;h<g;++h){var T=O[2*h+1]|0,E=T&1;if(h<g-1&&T>>1===O[2*h+3]>>1&&(E=2,h+=1),T<0){for(var L=-(T>>1)-1,F=0;F<M;++F){var C=t(ze[F],L);if(C!==void 0)return C}if(E!==0)for(var F=0;F<_;++F){var C=t(K[F],L);if(C!==void 0)return C}if(E!==1)for(var F=0;F<k;++F){var C=t(ye[F],L);if(C!==void 0)return C}E===0?qe(K,_e,_++,L):E===1?qe(ye,Fe,k++,L):E===2&&qe(ze,rt,M++,L)}else{var L=(T>>1)-1;E===0?Ne(K,_e,_--,L):E===1?Ne(ye,Fe,k--,L):E===2&&Ne(ze,rt,M--,L)}}}function Oa(e,t,r,n,i,s,o,a,c,u,f,v){var d=0,m=2*e,h=t,p=t+e,l=1,y=1;n?y=re:l=re;for(var g=i;g<s;++g){var _=g+l,k=m*g;O[d++]=o[k+h],O[d++]=-_,O[d++]=o[k+p],O[d++]=_}for(var g=c;g<u;++g){var _=g+y,M=m*g;O[d++]=f[M+h],O[d++]=-_}var T=d>>>1;St(O,T);for(var E=0,g=0;g<T;++g){var L=O[2*g+1]|0;if(L<0){var _=-L,F=!1;if(_>=re?(F=!n,_-=re):(F=!!n,_-=1),F)qe(K,_e,E++,_);else{var C=v[_],b=m*_,A=f[b+t+1],S=f[b+t+1+e];e:for(var P=0;P<E;++P){var x=K[P],U=m*x;if(!(S<o[U+t+1]||o[U+t+1+e]<A)){for(var R=t+2;R<e;++R)if(f[b+R+e]<o[U+R]||o[U+R+e]<f[b+R])continue e;var I=a[x],D;if(n?D=r(C,I):D=r(I,C),D!==void 0)return D}}}}else Ne(K,_e,E--,L-l)}}function Sa(e,t,r,n,i,s,o,a,c,u,f){for(var v=0,d=2*e,m=t,h=t+e,p=n;p<i;++p){var l=p+re,y=d*p;O[v++]=s[y+m],O[v++]=-l,O[v++]=s[y+h],O[v++]=l}for(var p=a;p<c;++p){var l=p+1,g=d*p;O[v++]=u[g+m],O[v++]=-l}var _=v>>>1;St(O,_);for(var k=0,p=0;p<_;++p){var M=O[2*p+1]|0;if(M<0){var l=-M;if(l>=re)K[k++]=l-re;else{l-=1;var T=f[l],E=d*l,L=u[E+t+1],F=u[E+t+1+e];e:for(var C=0;C<k;++C){var b=K[C],A=o[b];if(A===T)break;var S=d*b;if(!(F<s[S+t+1]||s[S+t+1+e]<L)){for(var P=t+2;P<e;++P)if(u[E+P+e]<s[S+P]||s[S+P+e]<u[E+P])continue e;var x=r(A,T);if(x!==void 0)return x}}}}else{for(var l=M-re,C=k-1;C>=0;--C)if(K[C]===l){for(var P=C+1;P<k;++P)K[P-1]=K[P];break}--k}}}var hr={},Ee="d",De="ax",Yn="vv",Nt="fp",Xe="es",Tt="rs",vr="re",et="rb",Zn="ri",Re="rp",bt="bs",pr="be",tt="bb",Xn="bi",Oe="bp",qt="rv",Vt="Q",ir=[Ee,De,Yn,Tt,vr,et,Zn,bt,pr,tt,Xn];function Da(e,t,r){var n="bruteForce"+(e?"Red":"Blue")+(t?"Flip":"")+(r?"Full":""),i=["function ",n,"(",ir.join(),"){","var ",Xe,"=2*",Ee,";"],s="for(var i="+Tt+","+Re+"="+Xe+"*"+Tt+";i<"+vr+";++i,"+Re+"+="+Xe+"){var x0="+et+"["+De+"+"+Re+"],x1="+et+"["+De+"+"+Re+"+"+Ee+"],xi="+Zn+"[i];",o="for(var j="+bt+","+Oe+"="+Xe+"*"+bt+";j<"+pr+";++j,"+Oe+"+="+Xe+"){var y0="+tt+"["+De+"+"+Oe+"],"+(r?"y1="+tt+"["+De+"+"+Oe+"+"+Ee+"],":"")+"yi="+Xn+"[j];";return e?i.push(s,Vt,":",o):i.push(o,Vt,":",s),r?i.push("if(y1<x0||x1<y0)continue;"):t?i.push("if(y0<=x0||x1<y0)continue;"):i.push("if(y0<x0||x1<y0)continue;"),i.push("for(var k="+De+"+1;k<"+Ee+";++k){var r0="+et+"[k+"+Re+"],r1="+et+"[k+"+Ee+"+"+Re+"],b0="+tt+"[k+"+Oe+"],b1="+tt+"[k+"+Ee+"+"+Oe+"];if(r1<b0||b1<r0)continue "+Vt+";}var "+qt+"="+Yn+"("),t?i.push("yi,xi"):i.push("xi,yi"),i.push(");if("+qt+"!==void 0)return "+qt+";}}}"),{name:n,code:i.join("")}}function Qn(e){var t="bruteForce"+(e?"Full":"Partial"),r=[],n=ir.slice();e||n.splice(3,0,Nt);var i=["function "+t+"("+n.join()+"){"];function s(c,u){var f=Da(c,u,e);r.push(f.code),i.push("return "+f.name+"("+ir.join()+");")}i.push("if("+vr+"-"+Tt+">"+pr+"-"+bt+"){"),e?(s(!0,!1),i.push("}else{"),s(!1,!1)):(i.push("if("+Nt+"){"),s(!0,!0),i.push("}else{"),s(!0,!1),i.push("}}else{if("+Nt+"){"),s(!1,!0),i.push("}else{"),s(!1,!1),i.push("}")),i.push("}}return "+t);var o=r.join("")+i.join(""),a=new Function(o);return a()}hr.partial=Qn(!1);hr.full=Qn(!0);var Jn=Ua,Ba="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function Ua(e,t){var r="abcdef".split("").concat(t),n=[];return e.indexOf("lo")>=0&&n.push("lo=e[k+n]"),e.indexOf("hi")>=0&&n.push("hi=e[k+o]"),r.push(Ba.replace("_",n.join()).replace("$",e)),Function.apply(void 0,r)}var $a=Va,za=Jn,Ar=za("lo<p0",["p0"]),Na=8;function qa(e,t,r,n,i,s){for(var o=2*e,a=o*(r+1)+t,c=r+1;c<n;++c,a+=o)for(var u=i[a],f=c,v=o*(c-1);f>r&&i[v+t]>u;--f,v-=o){for(var d=v,m=v+o,h=0;h<o;++h,++d,++m){var p=i[d];i[d]=i[m],i[m]=p}var l=s[f];s[f]=s[f-1],s[f-1]=l}}function Va(e,t,r,n,i,s){if(n<=r+1)return r;for(var o=r,a=n,c=n+r>>>1,u=2*e,f=c,v=i[u*c+t];o<a;){if(a-o<Na){qa(e,t,o,a,i,s),v=i[u*c+t];break}var d=a-o,m=Math.random()*d+o|0,h=i[u*m+t],p=Math.random()*d+o|0,l=i[u*p+t],y=Math.random()*d+o|0,g=i[u*y+t];h<=l?g>=l?(f=p,v=l):h>=g?(f=m,v=h):(f=y,v=g):l>=g?(f=p,v=l):g>=h?(f=m,v=h):(f=y,v=g);for(var M=u*(a-1),T=u*f,_=0;_<u;++_,++M,++T){var k=i[M];i[M]=i[T],i[T]=k}var E=s[a-1];s[a-1]=s[f],s[f]=E,f=Ar(e,t,o,a-1,i,s,v);for(var M=u*(a-1),T=u*f,_=0;_<u;++_,++M,++T){var k=i[M];i[M]=i[T],i[T]=k}var E=s[a-1];if(s[a-1]=s[f],s[f]=E,c<f){for(a=f-1;o<a&&i[u*(a-1)+t]===v;)a-=1;a+=1}else if(f<c)for(o=f+1;o<a&&i[u*o+t]===v;)o+=1;else break}return Ar(e,t,r,c,i,s,i[u*c+t])}var Ha=nu,Be=B,Ht=N,ei=hr,ja=ei.partial,Ga=ei.full,Me=Wn,Ka=$a,Ge=Jn,Rr=128,Wa=1<<22,Ya=1<<22,Za=Ge("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),Or=Ge("lo===p0",["p0"]),Xa=Ge("lo<p0",["p0"]),Qa=Ge("hi<=p0",["p0"]),Sr=Ge("lo<=p0&&p0<=hi",["p0"]),Ja=Ge("lo<p0&&p0<=hi",["p0"]),dr=6,mr=2,ti=1024,X=Be.mallocInt32(ti),Pe=Be.mallocDouble(ti);function eu(e,t){var r=8*Ht.log2(t+1)*(e+1)|0,n=Ht.nextPow2(dr*r);X.length<n&&(Be.free(X),X=Be.mallocInt32(n));var i=Ht.nextPow2(mr*r);Pe.length<i&&(Be.free(Pe),Pe=Be.mallocDouble(i))}function oe(e,t,r,n,i,s,o,a,c){var u=dr*e;X[u]=t,X[u+1]=r,X[u+2]=n,X[u+3]=i,X[u+4]=s,X[u+5]=o;var f=mr*e;Pe[f]=a,Pe[f+1]=c}function tu(e,t,r,n,i,s,o,a,c,u,f){var v=2*e,d=c*v,m=u[d+t];e:for(var h=i,p=i*v;h<s;++h,p+=v){var l=o[p+t],y=o[p+t+e];if(!(m<l||y<m)&&!(n&&m===l)){for(var g=a[h],_=t+1;_<e;++_){var l=o[p+_],y=o[p+_+e],k=u[d+_],M=u[d+_+e];if(y<k||M<l)continue e}var T;if(n?T=r(f,g):T=r(g,f),T!==void 0)return T}}}function ru(e,t,r,n,i,s,o,a,c,u){var f=2*e,v=a*f,d=c[v+t];e:for(var m=n,h=n*f;m<i;++m,h+=f){var p=o[m];if(p!==u){var l=s[h+t],y=s[h+t+e];if(!(d<l||y<d)){for(var g=t+1;g<e;++g){var l=s[h+g],y=s[h+g+e],_=c[v+g],k=c[v+g+e];if(y<_||k<l)continue e}var M=r(p,u);if(M!==void 0)return M}}}}function nu(e,t,r,n,i,s,o,a,c){eu(e,n+o);var u=0,f=2*e,v;for(oe(u++,0,0,n,0,o,r?16:0,-1/0,1/0),r||oe(u++,0,0,o,0,n,1,-1/0,1/0);u>0;){u-=1;var d=u*dr,m=X[d],h=X[d+1],p=X[d+2],l=X[d+3],y=X[d+4],g=X[d+5],_=u*mr,k=Pe[_],M=Pe[_+1],T=g&1,E=!!(g&16),L=i,F=s,C=a,b=c;if(T&&(L=a,F=c,C=i,b=s),!(g&2&&(p=Xa(e,m,h,p,L,F,M),h>=p))&&!(g&4&&(h=Qa(e,m,h,p,L,F,k),h>=p))){var A=p-h,S=y-l;if(E){if(e*A*(A+S)<Ya){if(v=Me.scanComplete(e,m,t,h,p,L,F,l,y,C,b),v!==void 0)return v;continue}}else if(e*Math.min(A,S)<Rr){if(v=ja(e,m,t,T,h,p,L,F,l,y,C,b),v!==void 0)return v;continue}else if(e*A*S<Wa){if(v=Me.scanBipartite(e,m,t,T,h,p,L,F,l,y,C,b),v!==void 0)return v;continue}var P=Za(e,m,h,p,L,F,k,M);if(h<P)if(e*(P-h)<Rr){if(v=Ga(e,m+1,t,h,P,L,F,l,y,C,b),v!==void 0)return v}else if(m===e-2){if(T?v=Me.sweepBipartite(e,t,l,y,C,b,h,P,L,F):v=Me.sweepBipartite(e,t,h,P,L,F,l,y,C,b),v!==void 0)return v}else oe(u++,m+1,h,P,l,y,T,-1/0,1/0),oe(u++,m+1,l,y,h,P,T^1,-1/0,1/0);if(P<p){var x=Ka(e,m,l,y,C,b),U=C[f*x+m],R=Or(e,m,x,y,C,b,U);if(R<y&&oe(u++,m,P,p,R,y,(T|4)+(E?16:0),U,M),l<x&&oe(u++,m,P,p,l,x,(T|2)+(E?16:0),k,U),x+1===R){if(E?v=ru(e,m,t,P,p,L,F,x,C,b[x]):v=tu(e,m,t,T,P,p,L,F,x,C,b[x]),v!==void 0)return v}else if(x<R){var I;if(E){if(I=Sr(e,m,P,p,L,F,U),P<I){var D=Or(e,m,P,I,L,F,U);if(m===e-2){if(P<D&&(v=Me.sweepComplete(e,t,P,D,L,F,x,R,C,b),v!==void 0)||D<I&&(v=Me.sweepBipartite(e,t,D,I,L,F,x,R,C,b),v!==void 0))return v}else P<D&&oe(u++,m+1,P,D,x,R,16,-1/0,1/0),D<I&&(oe(u++,m+1,D,I,x,R,0,-1/0,1/0),oe(u++,m+1,x,R,D,I,1,-1/0,1/0))}}else T?I=Ja(e,m,P,p,L,F,U):I=Sr(e,m,P,p,L,F,U),P<I&&(m===e-2?T?v=Me.sweepBipartite(e,t,x,R,C,b,P,I,L,F):v=Me.sweepBipartite(e,t,P,I,L,F,x,R,C,b):(oe(u++,m+1,P,I,x,R,T,-1/0,1/0),oe(u++,m+1,x,R,P,I,T^1,-1/0,1/0)))}}}}}var iu=cu,Ce=B,ht=Wn,su=Ha;function ou(e,t){for(var r=0;r<e;++r)if(!(t[r]<=t[r+e]))return!0;return!1}function Dr(e,t,r,n){for(var i=0,s=0,o=0,a=e.length;o<a;++o){var c=e[o];if(!ou(t,c)){for(var u=0;u<2*t;++u)r[i++]=c[u];n[s++]=o}}return s}function Et(e,t,r,n){var i=e.length,s=t.length;if(!(i<=0||s<=0)){var o=e[0].length>>>1;if(!(o<=0)){var a,c=Ce.mallocDouble(2*o*i),u=Ce.mallocInt32(i);if(i=Dr(e,o,c,u),i>0){if(o===1&&n)ht.init(i),a=ht.sweepComplete(o,r,0,i,c,u,0,i,c,u);else{var f=Ce.mallocDouble(2*o*s),v=Ce.mallocInt32(s);s=Dr(t,o,f,v),s>0&&(ht.init(i+s),o===1?a=ht.sweepBipartite(o,r,0,i,c,u,0,s,f,v):a=su(o,r,n,i,c,u,s,f,v),Ce.free(f),Ce.free(v))}Ce.free(c),Ce.free(u)}return a}}}var ot;function ri(e,t){ot.push([e,t])}function au(e){return ot=[],Et(e,e,ri,!0),ot}function uu(e,t){return ot=[],Et(e,t,ri,!1),ot}function cu(e,t,r){switch(arguments.length){case 1:return au(e);case 2:return typeof t=="function"?Et(e,e,t,!0):uu(e,t);case 3:return Et(e,t,r,!1);default:throw new Error("box-intersect: Invalid arguments")}}function fu(e){var t=[];return{name:"collideEntities",order:70,state:{cylinder:!1,collideBits:1,collideMask:1,callback:null},onAdd:null,onRemove:null,system:function(c,u){for(var f=e.ents,v=0;v<u.length;v++){var d=u[v].__id,m=f.getPositionData(d);t[v]=m._extents}t.length=u.length,iu(t,function(h,p){var l=u[h],y=u[p];if(!(!l||!y)){var g=t[h],_=t[p];n(l,y,g,_)&&r(e,l,y)}})}};function r(a,c,u){var f=c.__id,v=u.__id;c.collideMask&u.collideBits&&c.callback&&c.callback(v),u.collideMask&c.collideBits&&u.callback&&u.callback(f),a.ents.onPairwiseEntityCollision(f,v)}function n(a,c,u,f){return a.cylinder?c.cylinder?i(u,f):s(u,f):c.cylinder?s(f,u):!0}function i(a,c){var u=(a[3]-a[0])/2,f=(c[3]-c[0])/2,v=a[0]+u-(c[0]+f),d=a[2]+u-(c[2]+f),m=v*v+d*d,h=u+f;return m<=h*h}function s(a,c){var u=(a[3]-a[0])/2,f=a[0]+u,v=a[2]+u,d=o(f,c[0],c[3]),m=o(v,c[2],c[5]),h=d-f,p=m-v,l=h*h+p*p;return l<=u*u}function o(a,c,u){return a<c?c:a>u?u:a}}function lu(e){return{name:"collideTerrain",order:0,state:{callback:null},onAdd:function(t,r){var n=e.entities;if(n.hasPhysics(t)){var i=n.getPhysics(t).body;i.onCollide=function(o){var a=e.ents.getCollideTerrain(t).callback;a&&a(o,t)}}},onRemove:function(t,r){var n=e.entities;n.hasPhysics(t)&&(n.getPhysics(t).body.onCollide=null)}}}function hu(e){return{name:"fadeOnZoom",order:99,state:{cutoff:1.5},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.camera.currentZoom,s=e.entities,o=0;o<n.length;o++)vu(n[o],i,s)}}}function vu(e,t,r){if(!!r.hasMesh(e.__id)){var n=t>e.cutoff;r.getMeshData(e.__id).mesh.visibility=n}}function pu(e){return{name:"followsEntity",order:50,state:{entity:0,offset:null,onTargetMissing:null},onAdd:function(n,i){var s=w.create();i.offset=i.offset?w.copy(s,i.offset):s,t(i),r(i)},onRemove:null,system:function(i,s){for(var o=0;o<s.length;o++)t(s[o])},renderSystem:function(i,s){for(var o=0;o<s.length;o++)r(s[o])}};function t(n){var i=n.__id,s=e.ents.getPositionData(i),o=e.ents.getPositionData(n.entity);o?w.add(s._localPosition,o._localPosition,n.offset):(n.onTargetMissing&&n.onTargetMissing(i),e.ents.removeComponent(i,e.ents.names.followsEntity))}function r(n){var i=n.__id,s=e.ents.getPositionData(i),o=e.ents.getPositionData(n.entity);o&&w.add(s._renderPosition,o._renderPosition,n.offset)}}function du(e){return{name:"mesh",order:100,state:{mesh:null,offset:null},onAdd:function(t,r){var n=e.ents.getPositionData(t);if(r.mesh)e.rendering.addMeshToScene(r.mesh,!1,n.position);else throw new Error("Mesh component added without a mesh - probably a bug!");r.offset||(r.offset=w.create());var i=n._renderPosition;r.mesh.position.copyFromFloats(i[0]+r.offset[0],i[1]+r.offset[1],i[2]+r.offset[2])},onRemove:function(t,r){r.mesh.dispose()},renderSystem:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],s=i.__id,o=e.ents.getPositionData(s)._renderPosition;i.mesh.position.copyFromFloats(o[0]+i.offset[0],o[1]+i.offset[1],o[2]+i.offset[2])}}}}function mu(){this.heading=0,this.running=!1,this.jumping=!1,this.maxSpeed=10,this.moveForce=30,this.responsiveness=15,this.runningFriction=0,this.standingFriction=2,this.airMoveMult=.5,this.jumpImpulse=10,this.jumpForce=12,this.jumpTime=500,this.airJumps=1,this._jumpCount=0,this._currjumptime=0,this._isJumping=!1}function gu(e){return{name:"movement",order:30,state:new mu,onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,s=0;s<n.length;s++){var o=n[s],a=i.getPhysics(o.__id);a&&Mu(r,o,a.body)}}}}var _u=w.create(),yu=w.create(),ku=w.create();function Mu(e,t,r){var n=r.atRestY()<0,i=n||t._jumpCount<t.airJumps;if(n&&(t._isJumping=!1,t._jumpCount=0),t.jumping)if(t._isJumping){if(t._currjumptime>0){var s=t.jumpForce;t._currjumptime<e&&(s*=t._currjumptime/e),r.applyForce([0,s,0]),t._currjumptime-=e}}else i&&(t._isJumping=!0,n||t._jumpCount++,t._currjumptime=t.jumpTime,r.applyImpulse([0,t.jumpImpulse,0]),!n&&r.velocity[1]<0&&(r.velocity[1]=0));else t._isJumping=!1;var o=_u,a=yu;if(t.running){var c=t.maxSpeed;w.set(o,0,0,c),w.rotateY(o,o,ku,t.heading),w.subtract(a,o,r.velocity),a[1]=0;var u=w.length(a);if(w.normalize(a,a),u>0){var f=t.moveForce;n||(f*=t.airMoveMult);var v=t.responsiveness*u;f>v&&(f=v),w.scale(a,a,f),r.applyForce(a)}r.friction=t.runningFriction}else r.friction=t.standingFriction}function Cu(e){return{name:"receivesInputs",order:20,state:{},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,s=e.inputs.state,o=e.camera.heading,a=0;a<n.length;a++){var c=n[a],u=i.getMovement(c.__id);wu(u,s,o)}}}}function wu(e,t,r){e.jumping=!!t.jump;var n=t.forward?t.backward?0:1:t.backward?-1:0,i=t.right?t.left?0:1:t.left?-1:0;(n|i)===0?e.running=!1:(e.running=!0,n?(n==-1&&(r+=Math.PI),i&&(r+=Math.PI/4*n*i)):r+=i*Math.PI/2,e.heading=r)}function Lu(e,t){var r=t,n=e.rendering.getScene(),i=pi("shadow",{radius:.75,tessellation:30},n);i.rotation.x=Math.PI/2;var s=e.rendering.makeStandardMaterial("shadowMat");return s.diffuseColor=nt.Black(),s.ambientColor=nt.Black(),s.alpha=.5,i.material=s,i.setEnabled(!1),s.freeze(),n.removeMesh(i),{name:"shadow",order:80,state:{size:.5,_mesh:null},onAdd:function(o,a){var c=i.createInstance("shadow_instance");e.rendering.addMeshToScene(c),c.setEnabled(!1),a._mesh=c},onRemove:function(o,a){a._mesh.dispose()},system:function(a,c){for(var u=e.camera._localGetPosition(),f=r,v=0;v<c.length;v++){var d=c[v],m=e.ents.getPositionData(d.__id),h=e.ents.getPhysics(d.__id);bu(e,m,h,d._mesh,d.size,f,u)}},renderSystem:function(o,a){for(var c=0;c<a.length;c++){var u=a[c],f=e.ents.getPositionData(u.__id)._renderPosition,v=u._mesh.position;v.x=f[0],v.z=f[2]}}}}var jt=w.fromValues(0,0,0),Tu=w.fromValues(0,-1,0);function bu(e,t,r,n,i,s,o){var a;if(r&&r.body.resting[1]<0)a=t._localPosition[1];else{var c=e._localPick(t._localPosition,Tu,s);if(!c){n.setEnabled(!1);return}a=c.position[1]-e.worldOriginOffset[1]}a=Math.round(a),w.copy(jt,t._localPosition),jt[1]=a;var u=w.squaredDistance(o,jt),f=.01+.1*(u/1600);f>.1&&(f=.1),n.position.y=a+f;var v=t._localPosition[1]-a,d=i*.7*(1-v/s);n.scaling.copyFromFloats(d,d,d),n.setEnabled(!0)}function Eu(e){var t="smoothCamera";return{name:t,order:99,state:{time:100.1},onAdd:null,onRemove:null,system:function(r,n){for(var i=0;i<n.length;i++){var s=n[i];s.time-=r,s.time<0&&e.ents.removeComponent(s.__id,t)}}}}var Fu={shadowDistance:10};class Pu extends va{constructor(t,r){super(),r=Object.assign({},Fu,r);var n={shadow:r.shadowDistance};this.noa=t,this.names={};var i={collideEntities:fu,collideTerrain:lu,fadeOnZoom:hu,followsEntity:pu,mesh:du,movement:gu,physics:ya,position:ga,receivesInputs:Cu,shadow:Lu,smoothCamera:Eu};Object.keys(i).forEach(s=>{var o=n[s]||void 0,a=i[s],c=a(t,o);this.names[s]=this.createComponent(c)}),this.cameraSmoothed=this.getComponentAccessor(this.names.smoothCamera),this.hasPhysics=this.getComponentAccessor(this.names.physics),this.hasPosition=this.getComponentAccessor(this.names.position),this.getPositionData=this.getStateAccessor(this.names.position),this.getPosition=s=>{var o=this.getPositionData(s);return o?o.position:null},this.getPhysics=this.getStateAccessor(this.names.physics),this.getPhysicsBody=s=>{var o=this.getPhysics(s);return o?o.body:null},this.hasMesh=this.getComponentAccessor(this.names.mesh),this.getMeshData=this.getStateAccessor(this.names.mesh),this.getMovement=this.getStateAccessor(this.names.movement),this.getCollideTerrain=this.getStateAccessor(this.names.collideTerrain),this.getCollideEntities=this.getStateAccessor(this.names.collideEntities),this.onPairwiseEntityCollision=function(s,o){}}setPosition(t,r,n=0,i=0){typeof r=="number"&&(r=[r,n,i]);var s=this.noa.globalToLocal(r,null,[]);this._localSetPosition(t,s)}setEntitySize(t,r,n,i){var s=this.getPositionData(t);s.width=(r+i)/2,s.height=n,this._updateDerivedPositionData(t,s)}_rebaseOrigin(t){for(var r of this.getStatesList(this.names.position)){var n=r._localPosition,i=r.width/2;Gt(n,0,-i,i,r.__id),Gt(n,1,0,r.height,r.__id),Gt(n,2,-i,i,r.__id),w.subtract(n,n,t),this._updateDerivedPositionData(r.__id,r)}}_localGetPosition(t){return this.getPositionData(t)._localPosition}_localSetPosition(t,r){var n=this.getPositionData(t);w.copy(n._localPosition,r),this._updateDerivedPositionData(t,n)}_updateDerivedPositionData(t,r){w.copy(r._renderPosition,r._localPosition);var n=this.noa.worldOriginOffset;w.add(r.position,r._localPosition,n),nr(r);var i=this.getPhysics(t);i&&Sn(i,r)}addComponentAgain(t,r,n){this.hasComponent(t,r)&&this.removeComponent(t,r),this.addComponent(t,r,n)}isTerrainBlocked(t,r,n){for(var i=this.noa.worldOriginOffset,s=Math.floor(t-i[0]),o=Math.floor(r-i[1]),a=Math.floor(n-i[2]),c=[s+.001,o+.001,a+.001,s+.999,o+.999,a+.999],u=this.getStatesList(this.names.collideTerrain),f=0;f<u.length;f++){var v=u[f].__id,d=this.getPositionData(v)._extents;if(Br(c,d))return!0}return!1}getEntitiesInAABB(t,r){var n=this.noa.worldOriginOffset,i=[t.base[0]-n[0],t.base[1]-n[1],t.base[2]-n[2],t.max[0]-n[0],t.max[1]-n[1],t.max[2]-n[2]],s;if(r){s=[];for(var o of this.getStatesList(r)){var a=this.getPositionData(o.__id);a&&s.push(a)}}else s=this.getStatesList(this.names.position);for(var c=[],u=0;u<s.length;u++){var f=s[u];Br(i,f._extents)&&c.push(f.__id)}return c}add(t=null,r=1,n=1,i=null,s=null,o=!1,a=!1){var c=this,u=this.createEntity();if(this.addComponent(u,this.names.position,{position:t||w.create(),width:r,height:n}),o){this.addComponent(u,this.names.physics);var f=this.getPhysics(u).body,v=this.names.smoothCamera;f.onStep=function(){c.addComponentAgain(u,v)}}return i&&(s||(s=w.create()),this.addComponent(u,this.names.mesh,{mesh:i,offset:s})),a&&this.addComponent(u,this.names.shadow,{size:r}),u}}function Gt(e,t,r,n,i){var s=e[t]+r,o=e[t]+n;Math.abs(s-Math.round(s))<.002&&(e[t]+=.002),Math.abs(o-Math.round(o))<.001&&(e[t]-=.001)}function Br(e,t){return!(e[0]>t[3]||e[1]>t[4]||e[2]>t[5]||e[3]<t[0]||e[4]<t[1]||e[5]<t[2])}function Kt(e,t){var r=e.indexOf(t);r<0||(r===e.length-1?e.pop():e[r]=e.pop())}function sr(e,t,r){var n=r||performance.now(),i=t();if(!i){var s=performance.now(),o=s-r,a=n+e-o/2;if(!(s>a)){for(var c=1e3,u=0;u<c;u++)if(t()||performance.now()>a)return}}}function le(e,t,r){return e&1023|(t&1023)<<10|(r&1023)<<20}function xu(){var e={};this.getChunkByIndexes=(t,r,n)=>e[le(t,r,n)]||null,this.storeChunkByIndexes=(t,r,n,i)=>{e[le(t,r,n)]=i},this.removeChunkByIndexes=(t,r,n)=>{delete e[le(t,r,n)]}}class we{constructor(){this.arr=[],this.hash={}}forEach(t,r){this.arr.forEach(t,r)}includes(t,r,n){var i=le(t,r,n);return!!this.hash[i]}add(t,r,n,i=!1){var s=le(t,r,n);this.hash[s]||(i?this.arr.unshift([t,r,n,s]):this.arr.push([t,r,n,s]),this.hash[s]=!0)}removeByIndex(t){var r=this.arr[t];delete this.hash[r[3]],this.arr.splice(t,1)}remove(t,r,n){var i=le(t,r,n);if(!!this.hash[i]){delete this.hash[i];for(var s=0;s<this.arr.length;s++)if(i===this.arr[s][3]){this.arr.splice(s,1);return}throw"internal bug with location queue - hash value overlapped"}}count(){return this.arr.length}isEmpty(){return this.arr.length===0}empty(){this.arr=[],this.hash={}}pop(){var t=this.arr.pop();return delete this.hash[t[3]],t}copyFrom(t){this.arr=t.arr.slice(),this.hash={};for(var r in t.hash)this.hash[r]=!0}sortByDistance(t,r=!1,n=!1){var i=this.arr.length,s=n&&i>1e3;if(!s){Ur(this.arr,t,r);return}var o=this.arr.slice(0,100).concat(this.arr.slice(i-100));Ur(o,t,r);for(var a=0;a<100;a++)this.arr[a]=o[a],this.arr[i-a]=o[200-a]}}function Ur(e,t,r){var n={};for(var i of e)n[i[3]]=t(i[0],i[1],i[2]);r?e.sort((s,o)=>n[s[3]]-n[o[3]]):e.sort((s,o)=>n[o[3]]-n[s[3]]),n=null}function Iu(e,t="",r){if(!(e>0))return()=>{};var n={},i=0,s=0,o=0,a=0,c=()=>{i=s=performance.now(),o++},u=v=>{var d=performance.now();n[v]=(n[v]||0)+(d-s),s=d},f=()=>{if(a+=performance.now()-i,!(o<e)){var v=`${t}: ${(a/e).toFixed(2)}ms  --  `;v+=Object.keys(n).map(d=>r&&n[d]/a<.05?"":`${d}: ${(n[d]/o).toFixed(2)}ms`).join("  "),console.log(v+`    (avg over ${e} runs)`),n={},o=a=0}};return v=>{v==="start"?c():v==="end"?f():u(v)}}function Au(e){this.rootNode=new er("objectMeshRoot",e.rendering._scene);var t=[0,0,0],r=!1,n=new er(""),i={},s=o=>{if(i[o])return i[o];var a=e.registry._blockMeshLookup[o];for(var c in i){var u=i[c].mesh;if(u===a||u.geometry===a.geometry)return i[o]=i[c]}return i[o]=new Ke(e,a)};this.initChunk=function(o){o._objectBlocks={}},this.setObjectBlock=function(o,a,c,u,f){var v=o.x+c,d=o.y+u,m=o.z+f,h=`${v}:${d}:${m}`,p=o._objectBlocks[h]||0;if(p!==a){if(p>0){var l=s(p);l.removeInstance(o,h)}if(a>0){var y=e.registry._blockHandlerLookup[a],g=y&&y.onCustomMeshCreate;g&&(n.position.copyFromFloats(.5,0,.5),n.scaling.setAll(1),n.rotation.setAll(0),g(n,v,d,m));var _=s(a),k=g?n:null;_.addInstance(o,h,c,u,f,k,t)}p>0&&!a&&delete o._objectBlocks[h],a>0&&(o._objectBlocks[h]=a)}},this.buildObjectMeshes=function(){for(var o in i){var a=i[o];a.updateMatrix(),a.count===0&&a.dispose(),a.disposed&&delete i[o]}},this.disposeChunk=function(o){for(var a in o._objectBlocks){var c=o._objectBlocks[a];if(c>0){var u=s(c);u.removeInstance(o,a)}}o._objectBlocks=null,r=!0},this.tick=function(){r&&(this.buildObjectMeshes(),r=!1)},this._rebaseOrigin=function(o){t[0]+=o[0],t[1]+=o[1],t[2]+=o[2];for(var a in i)i[a].rebased=!1;for(var c in i){var u=i[c];if(!u.rebased){for(var f=0;f<u.count;f++){var v=f<<4;u.buffer[v+12]-=o[0],u.buffer[v+13]-=o[1],u.buffer[v+14]-=o[2]}u.rebased=!0,u.dirty=!0}}r=!0}}function Ke(e,t){this.mesh=t,this.buffer=null,this.capacity=0,this.count=0,this.dirty=!1,this.rebased=!0,this.disposed=!1,this.keyToIndex={},this.locToKey=[],this.mesh.position.setAll(0),this.mesh.parent=e._objectMesher.rootNode,this.mesh.isVisible=!0,e.rendering.addMeshToScene(this.mesh,!1),this.mesh.doNotSyncBoundingInfo=!0,this.mesh.alwaysSelectAsActiveMesh=!0}Ke.prototype.dispose=function(){this.disposed||(this.mesh.thinInstanceCount=0,this.setCapacity(0),this.mesh.isVisible=!1,this.mesh=null,this.keyToIndex=null,this.locToKey=null,this.disposed=!0)};Ke.prototype.addInstance=function(e,t,r,n,i,s,o){Ru(this);var a=this.count<<4;if(this.locToKey[this.count]=t,this.keyToIndex[t]=a,s){s.position.x+=e.x-o[0]+r,s.position.y+=e.y-o[1]+n,s.position.z+=e.z-o[2]+i,s.computeWorldMatrix(!0);var c=s._localMatrix._m;or(c,0,this.buffer,a)}else{var u=Su;u[12]=e.x-o[0]+r+.5,u[13]=e.y-o[1]+n,u[14]=e.z-o[2]+i+.5,or(u,0,this.buffer,a)}this.count++,this.dirty=!0};Ke.prototype.removeInstance=function(e,t){var r=this.keyToIndex[t];if(!(r>=0))throw"tried to remove object instance not in storage";delete this.keyToIndex[t];var n=r>>4,i=this.count-1;if(n!==i){var s=i<<4;or(this.buffer,s,this.buffer,r);var o=this.locToKey[i];this.keyToIndex[o]=r,this.locToKey[n]=o}this.count--,this.dirty=!0,Ou(this)};Ke.prototype.updateMatrix=function(){!this.dirty||(this.mesh.thinInstanceCount=this.count,this.mesh.thinInstanceBufferUpdated("matrix"),this.mesh.isVisible=this.count>0,this.dirty=!1)};Ke.prototype.setCapacity=function(e=4){if(this.capacity=e,e===0)this.buffer=null;else{var t=new Float32Array(this.capacity*16);if(this.buffer)for(var r=Math.min(this.buffer.length,t.length),n=0;n<r;n++)t[n]=this.buffer[n];this.buffer=t}this.mesh.thinInstanceSetBuffer("matrix",this.buffer),this.mesh.thinInstanceCount=this.count,this.dirty=!1};function Ru(e){if(!(e.count<e.capacity)){var t=Math.max(8,e.capacity*2);e.setCapacity(t)}}function Ou(e){e.count>e.capacity*.4||e.capacity<100||(e.setCapacity(Math.round(e.capacity/2)),e.locToKey.length=Math.min(e.locToKey.length,e.capacity))}var Su=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function or(e,t,r,n){for(var i=0;i<16;i++)r[n+i]=e[t+i]}class Du{constructor(t){this._defaultMat=t.rendering.makeStandardMaterial("base-terrain"),this._defaultMat.freeze(),this.noa=t,this._idCounter=1e3,this._blockMatIDtoTerrainID={},this._terrainIDtoMatObject={},this._texURLtoTerrainID={},this._renderMatToTerrainID=new Map}getTerrainMatId(t){if(t in this._blockMatIDtoTerrainID)return this._blockMatIDtoTerrainID[t];var r=Bu(this,t);if(!(r in this._terrainIDtoMatObject)){var n=Uu(this,t);this._terrainIDtoMatObject[r]=n}return this._blockMatIDtoTerrainID[t]=r,r}getMaterial(t=1){return this._terrainIDtoMatObject[t]}}function Bu(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat){var n=r.renderMat;return e._renderMatToTerrainID.has(n)||e._renderMatToTerrainID.set(n,e._idCounter++),e._renderMatToTerrainID.get(n)}if(r.texture){var i=r.texture;return i in e._texURLtoTerrainID||(e._texURLtoTerrainID[i]=e._idCounter++),e._texURLtoTerrainID[i]}var s=r.alpha;return s>0&&s<1?10+Math.round(s*100):1}function Uu(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat)return r.renderMat;if(!r.texture){var n=r.alpha>0&&r.alpha<1;if(!n)return e._defaultMat;var i="terrain-alpha-"+t,s=e.noa.rendering.makeStandardMaterial(i);return s.alpha=r.alpha,s.freeze(),s}var o=e.noa.rendering.getScene(),a=e.noa.rendering.makeStandardMaterial("terrain-textured-"+t),c=r.texture,u=tr.NEAREST_SAMPLINGMODE,f=new tr(c,o,!0,!1,u);return r.texHasAlpha&&(f.hasAlpha=!0),a.diffuseTexture=f,r.atlasIndex>=0&&new $u(a,f),a.freeze(),a}class $u extends di{constructor(t,r){var n=200,i={NOA_TWOD_ARRAY_TEXTURE:!1};super(t,"TestPlugin",n,i),this._enable(!0),this._atlasTextureArray=null,r.onLoadObservable.add(s=>{this.setTextureArrayData(s)})}setTextureArrayData(t){var{width:r,height:n}=t.getSize(),i=Math.round(n/r);n=r;var s=t._readPixelsSync(),o=Kr.TEXTUREFORMAT_RGBA,a=!0,c=!1,u=tr.NEAREST_SAMPLINGMODE,f=t.getScene();this._atlasTextureArray=new mi(s,r,n,i,o,f,a,c,u)}prepareDefines(t,r,n){t.NOA_TWOD_ARRAY_TEXTURE=!0}getClassName(){return"TerrainMaterialPluginName"}getSamplers(t){t.push("atlasTexture")}getAttributes(t){t.push("texAtlasIndices")}getUniforms(){return{ubo:[]}}bindForSubMesh(t,r,n,i){this._atlasTextureArray&&t.setTexture("atlasTexture",this._atlasTextureArray)}getCustomCode(t){return t==="vertex"?{CUSTOM_VERTEX_MAIN_BEGIN:`
                texAtlasIndex = texAtlasIndices;
            `,CUSTOM_VERTEX_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                attribute float texAtlasIndices;
                varying float texAtlasIndex;
            `}:t==="fragment"?{"!baseColor\\=texture2D\\(diffuseSampler,vDiffuseUV\\+uvOffset\\);":"baseColor = texture(atlasTexture, vec3(vDiffuseUV, texAtlasIndex));",CUSTOM_FRAGMENT_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                varying float texAtlasIndex;
            `}:null}}function zu(e){var t=new Du(e);this._defaultMaterial=t._defaultMat;var r=new qu(e,t),n=new Vu(e,t);this.initChunk=function(i){i._terrainMeshes.length=0},this.disposeChunk=function(i){i._terrainMeshes.forEach(s=>s.dispose()),i._terrainMeshes.length=0},this.meshChunk=function(i,s=!1){i._terrainMeshes.forEach(c=>c.dispose()),i._terrainMeshes.length=0;var o=r.mesh(i,s),a=n.buildMesh(i,o,s);a.forEach(c=>{e.rendering.addMeshToScene(c,!0,i.pos,this),c.cullingStrategy=Wr.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,i._terrainMeshes.push(c)})}}function Nu(){this.terrainID=0,this.numFaces=0,this.matIDs=[],this.dirs=[],this.is=[],this.js=[],this.ks=[],this.wids=[],this.hts=[],this.packedAO=[]}function qu(e,t){var r=new Int16Array(16),n=new Int16Array(16),i=t.getTerrainMatId.bind(t),s=_=>1,o=i;this.mesh=function(_,k){var M=_.size;o=k?s:i;var T=_._isEmpty||_._isFull,E={};$r.reset();for(var L=0;L<3;++L){var F=L===2?0:2,C=L===1?0:1,b=_._neighbors.data.map(j=>j&&j.voxels?j.voxels.transpose(L,F,C):null),A=it(b,[3,3,3]).lo(1,1,1).transpose(L,F,C);r.length<M*M&&(r=new Int16Array(M*M),n=new Int16Array(M*M)),a(A,M);var S=A.get(-1,0,0),P=A.get(0,0,0);if(S){var x=S.lo(M,0,0),U=p(L,x,-1,P,0);U>0&&l(0,L,F,C,M,M,U,E)}if(!T)for(var R=0;R<M-1;R++){if(L===1){var I=_._wholeLayerVoxel[R];if(I>=0&&I===_._wholeLayerVoxel[R+1])continue}var D=L===1?null:_._wholeLayerVoxel,V=p(L,P,R,P,R+1,D);V>0&&l(R+1,L,F,C,M,M,V,E)}}return E};function a(_,k){if(d=_.get(0,0,0),m=_,v=e.registry._solidityLookup,c.length!==k+1){c=[],u=[],f=[];for(var M=-1;M<k+1;M++){var T=M<0?0:M<k?1:2;c[M]=[-1,0,1][T]|0,u[M]=[k-1,M,0][T]|0,f[M]=[0,M,k-1][T]|0}}}var c=[],u=[],f=[],v,d,m;function h(_,k,M){var T=c[_]|0,E=c[k]|0,L=c[M]|0;if((T|E|L)===0)return v[d.get(_,k,M)];var F=m.get(T,E,L);if(F){var C=u[_]|0,b=u[k]|0,A=u[M]|0;return v[F.get(C,b,A)]}else{var S=f[_]|0,P=f[k]|0,x=f[M]|0;return v[d.get(S,P,x)]}}function p(_,k,M,T,E,L=null){for(var F=k.shape[1],C=r,b=n,A=e.rendering.useAO,S=e.rendering.revAoVal===e.rendering.aoVals[0],P=e.registry._opacityLookup,x=e.registry.getBlockFaceMaterial,U=_*2,R=0,I=k.index(M,0,0),D=k.stride[1],V=k.stride[2],j=T.index(E,0,0),ee=T.stride[1],Le=T.stride[2],ae=0,ue=0;ue<F;++ue){var ce=I,ie=j;if(I+=V,j+=Le,L&&L[ue]>=0){R+=F;continue}for(var se=0;se<F;se++,R++,ce+=D,ie+=ee){var W=k.data[ce],Y=T.data[ie];if(W!==Y){var ve=P[W],pe=P[Y];if(!(ve&&pe)){var Ie=x(W,U),We=x(Y,U+1);Ie!==We&&(ve||We===0?(C[R]=Ie,A&&(b[R]=zr(h,E,M,se,ue,S)),ae++):(pe||Ie===0)&&(C[R]=-We,A&&(b[R]=zr(h,M,E,se,ue,S)),ae++))}}}}return ae}function l(_,k,M,T,E,L,F,C){var b=e.rendering.useAO,A=r,S=n,P=0,x=k*2,U=[0,0,0];U[k]=_;for(var R=b?y:g,I=0;I<L;++I)for(var D=1,V=1,j=0;j<E;j+=D,P+=D){var ee=A[P]|0;if(!ee){D=1;continue}var Le=S[P]|0;for(D=1;D<E-j&&R(P+D,A,ee,S,Le);++D);e:for(V=1;V<L-I;++V)for(var ae=0;ae<D;++ae){var ue=P+ae+V*E;if(!R(ue,A,ee,S,Le))break e}var ce=Math.abs(ee),ie=o(ce);if(!(ie in C)){var se=$r.get();se.numFaces=0,se.terrainID=ie,C[ie]=se}var W=C[ie],Y=W.numFaces;W.numFaces++,W.matIDs[Y]=ce,U[M]=j,U[T]=I,W.is[Y]=U[0],W.js[Y]=U[1],W.ks[Y]=U[2],W.wids[Y]=D,W.hts[Y]=V,W.packedAO[Y]=Le,W.dirs[Y]=ee>0?x:x+1;for(var ve=0;ve<V;++ve)for(var pe=0;pe<D;++pe)A[P+pe+ve*E]=0;if(F-=D*V,F===0)return}}function y(_,k,M,T,E){return!(M!==k[_]||E!==T[_])}function g(_,k,M,T,E){return M===k[_]}}var $r=(()=>{var e=[],t=0,r=()=>(t>=e.length&&e.push(new Nu),t++,e[t-1]),n=()=>{t=0};return{get:r,reset:n}})();function Vu(e,t){this.buildMesh=function(d,m,h){var p=e.rendering.getScene(),l=e.rendering.useAO,y=e.rendering.aoVals,g=e.rendering.revAoVal,_=e.registry._matAtlasIndexLookup,k=e.registry._materialColorLookup,M=[1,1,1],T=[];for(var E in m){var L=m[E],F=L.terrainID,C=!1;if(!h){var b=_[L.matIDs[0]];C=b>=0}for(var A=[],S=[],P=[],x=[],U=[],R=[],I=0;I<L.numFaces;I++){var D=L.matIDs[I],V=L.dirs[I],j=L.is[I],ee=L.js[I],Le=L.ks[I],ae=L.wids[I],ue=L.hts[I],ce=V/2|0,ie=V%2?-1:1;r(A,I,j,ee,Le,ce,ae,ue),n(U,I,ce,ae,ue,ie);var se=[0,0,0];se[ce]=ie,i(P,I,se);var W=L.packedAO[I],[Y,ve,pe,Ie]=Hu(W),We=c(Y,ve,pe,Ie);if(s(S,I,ce,ie,We),C){var hi=_[D];a(R,I,hi)}var gr=k[D]||M;l?f(x,I,gr,y,g,Y,ve,pe,Ie):u(x,I,gr)}var vi=`chunk_${d.requestID}_${F}`,ut=new Wr(vi,p),Ae=new gi;Ae.positions=A,Ae.indices=S,Ae.normals=P,Ae.colors=x,Ae.uvs=U,Ae.applyToMesh(ut),C&&ut.setVerticesData("texAtlasIndices",R,!1,1),h||(ut.material=t.getMaterial(F)),T.push(ut)}return T};function r(d,m,h,p,l,y,g,_){var k=m*12,M=[h,p,l],T=[0,0,0],E=[0,0,0];T[y===2?0:2]=g,E[y===1?0:1]=_;for(var L=0;L<3;L++)d[k+L]=M[L],d[k+3+L]=M[L]+T[L],d[k+6+L]=M[L]+T[L]+E[L],d[k+9+L]=M[L]+E[L]}function n(d,m,h,p,l,y){for(var g=m*8,_=0,k=0;k<8;k++)d[g+k]=_;h===0?(d[g+1]=d[g+3]=l-_,d[g+2]=d[g+4]=y*p):h===1?(d[g+1]=d[g+7]=p-_,d[g+4]=d[g+6]=y*l):(d[g+1]=d[g+3]=l-_,d[g+2]=d[g+4]=-y*p)}function i(d,m,h){for(var p=m*12,l=0;l<12;l++)d[p+l]=h[l%3]}function s(d,m,h,p,l){var y=m*6,g=m*4;h===0&&(p=-p);var _=p<0?0:1;l||(_+=2);for(var k=o[_],M=0;M<6;M++)d[y+M]=g+k[M]}var o=[[0,1,2,0,2,3],[0,2,1,0,3,2],[1,2,3,1,3,0],[1,3,2,1,0,3]];function a(d,m,h){for(var p=m*4,l=0;l<4;l++)d[p+l]=h}function c(d,m,h,p){return d===h?p===m?p===2:!0:p===m?!1:d+h>p+m}function u(d,m,h){for(var p=m*16,l=0;l<16;l+=4)d[p+l]=h[0],d[p+l+1]=h[1],d[p+l+2]=h[2],d[p+l+3]=1}function f(d,m,h,p,l,y,g,_,k){var M=m*16;v(d,M,h,y,p,l),v(d,M+4,h,k,p,l),v(d,M+8,h,_,p,l),v(d,M+12,h,g,p,l)}function v(d,m,h,p,l,y){var g=p===0?y:l[p-1];d[m]=h[0]*g,d[m+1]=h[1]*g,d[m+2]=h[2]*g,d[m+3]=1}}function zr(e,t,r,n,i,s=!1){var o=1,a=1,c=1,u=1;e(t,n+1,i)&&(++c,++u),e(t,n-1,i)&&(++o,++a),e(t,n,i+1)&&(++a,++u),e(t,n,i-1)&&(++o,++c);var f=e(t,n,i);return f?(u=u===3||e(t,n+1,i+1)?3:2,a=a===3||e(t,n-1,i+1)?3:2,c=c===3||e(t,n+1,i-1)?3:2,o=o===3||e(t,n-1,i-1)?3:2,u<<6|c<<4|a<<2|o):s?(u===1&&e(t,n+1,i+1)&&(u=2),a===1&&e(t,n-1,i+1)&&(a=2),c===1&&e(t,n+1,i-1)&&(c=2),o===1&&e(t,n-1,i-1)&&(o=2),u<<6|c<<4|a<<2|o):(u===1&&(e(t,n+1,i+1)?u=2:(!e(r,n,i+1)||!e(r,n+1,i)||!e(r,n+1,i+1))&&(u=0)),c===1&&(e(t,n+1,i-1)?c=2:(!e(r,n,i-1)||!e(r,n+1,i)||!e(r,n+1,i-1))&&(c=0)),a===1&&(e(t,n-1,i+1)?a=2:(!e(r,n,i+1)||!e(r,n-1,i)||!e(r,n-1,i+1))&&(a=0)),o===1&&(e(t,n-1,i-1)?o=2:(!e(r,n,i-1)||!e(r,n-1,i)||!e(r,n-1,i-1))&&(o=0)),u<<6|c<<4|a<<2|o)}function Hu(e){var t=e&3,r=e>>2&3,n=e>>4&3,i=e>>6&3;return[t,r,i,n]}var ju={texturePath:""},Gu=(1<<16)-1;class Ku{constructor(t,r){r=Object.assign({},ju,r),this.noa=t,this._texturePath=r.texturePath;var n={},i=[!1],s=[!1],o=[!1],a=[!1],c=[null],u=[null],f=[null],v=[!1],d=[0,0,0,0,0,0],m=[null],h=[-1],p=[];this.registerBlock=function(l=1,y=null){var g=new Zu(y&&y.fluid),_=Object.assign({},g,y||{});if(l<1||l>Gu)throw"Block id out of range: "+l;for(;l>i.length;)this.registerBlock(i.length,{});i[l]=!!_.solid,s[l]=!!_.opaque,o[l]=!!_.fluid,a[l]=!!_.blockMesh,u[l]=_.blockMesh||null;var k=_.material||null,M;if(!k)M=[null,null,null,null,null,null];else if(typeof k=="string")M=[k,k,k,k,k,k];else if(k.length&&k.length==2)M=[k[1],k[1],k[0],k[0],k[1],k[1]];else if(k.length&&k.length==3)M=[k[2],k[2],k[0],k[1],k[2],k[2]];else if(k.length&&k.length==6)M=k;else throw"Invalid material parameter: "+k;for(var T=0;T<6;++T)d[l*6+T]=Wu(this,n,M[T],!0);c[l]={},o[l]&&(c[l].fluidDensity=_.fluidDensity,c[l].viscosity=_.viscosity);var E=_.onLoad||_.onUnload||_.onSet||_.onUnset||_.onCustomMeshCreate;f[l]=E?new Yu(_):null;var L=i[l]&&s[l]&&!E&&!o[l]&&!a[l];return v[l]=L,l},this.registerMaterial=function(l="?",y=null){if(Array.isArray(y)||arguments[2])throw'This API changed signatures in v0.33, please use: `noa.registry.registerMaterial("name", optionsObj)`';var g=Object.assign(new Xu,y||{}),_=n[l]||p.length;n[l]=_;var k=g.textureURL?this._texturePath+g.textureURL:"",M=1,T=g.color||[1,1,1];return T.length===4&&(M=T.pop()),k&&(T=null),m[_]=T,h[_]=g.atlasIndex,p[_]={color:T,alpha:M,texture:k,texHasAlpha:!!g.texHasAlpha,atlasIndex:g.atlasIndex,renderMat:g.renderMaterial},_},this.getBlockSolidity=function(l){return i[l]},this.getBlockOpacity=function(l){return s[l]},this.getBlockFluidity=function(l){return o[l]},this.getBlockProps=function(l){return c[l]},this.getBlockFaceMaterial=function(l,y){return d[l*6+y]},this.getMaterialData=function(l){return p[l]},this._solidityLookup=i,this._opacityLookup=s,this._fluidityLookup=o,this._objectLookup=a,this._blockMeshLookup=u,this._blockHandlerLookup=f,this._blockIsPlainLookup=v,this._materialColorLookup=m,this._matAtlasIndexLookup=h,this.registerMaterial("dirt",{color:[.4,.3,0]}),this.registerBlock(1,{material:"dirt"})}}function Wu(e,t,r,n){if(!r)return 0;var i=t[r];return i===void 0&&n&&(i=e.registerMaterial(r)),i}function Yu(e){this.onLoad=e.onLoad||null,this.onUnload=e.onUnload||null,this.onSet=e.onSet||null,this.onUnset=e.onUnset||null,this.onCustomMeshCreate=e.onCustomMeshCreate||null}function Zu(e=!1){this.solid=!e,this.opaque=!e,this.fluid=!1,this.material=null,this.blockMesh=null,this.fluidDensity=1,this.viscosity=.5,this.onLoad=null,this.onUnload=null,this.onSet=null,this.onUnset=null,this.onCustomMeshCreate=null}function Xu(){this.color=null,this.textureURL=null,this.texHasAlpha=!1,this.atlasIndex=-1,this.renderMaterial=null}class Qu{constructor(t,r){var n=t._scene;n._addComponent(new _i(n));var i=new yi(o);n._selectionOctree=i,i.blocks=[];var s={};this.rebase=f=>{c(i,f)},this.includesMesh=f=>f._noaContainingBlock||f._noaIsDynamicContent,this.addMesh=(f,v,d,m)=>{if(!v){f._noaIsDynamicContent=!0,i.dynamicContent.push(f);return}var h=Math.floor(d[0]/a),p=Math.floor(d[1]/a),l=Math.floor(d[2]/a),y=le(h,p,l),g=s[y];if(!g){var _=[h*a,p*a,l*a],k=[0,0,0];t.noa.globalToLocal(_,null,k),g=u(k,a),i.blocks.push(g),s[y]=g,g._noaMapKey=y}g.entries.push(f),f._noaContainingBlock=g,f.alwaysSelectAsActiveMesh=!0},this.removeMesh=f=>{if(f._noaIsDynamicContent&&(f._noaIsDynamicContent=null,Kt(i.dynamicContent,f)),f._noaContainingBlock){f._noaContainingChunk=null;var v=f._noaContainingBlock;Kt(v.entries,f),v.entries.length===0&&(delete s[v._noaMapKey],Kt(i.blocks,v))}};var o=()=>{},a=r*t.noa.world._chunkSize,c=(f,v)=>{f.blocks.forEach(d=>{d.minPoint.subtractInPlace(v),d.maxPoint.subtractInPlace(v),d._boundingVectors.forEach(m=>m.subtractInPlace(v)),d.blocks&&c(d,v)})},u=(f,v)=>{var d=new fe(f[0],f[1],f[2]),m=new fe(f[0]+v,f[1]+v,f[2]+v);return new ki(d,m,void 0,void 0,void 0,o)}}}var Ju={showFPS:!1,antiAlias:!0,clearColor:[.8,.9,1],ambientColor:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],groundLightColor:[.5,.5,.5],useAO:!0,AOmultipliers:[.93,.8,.5],reverseAOmultiplier:1,preserveDrawingBuffer:!0,octreeBlockSize:2,renderOnResize:!0};class J{constructor(t,r,n){r=Object.assign({},Ju,r),this.noa=t,this.renderOnResize=!!r.renderOnResize,this.useAO=!!r.useAO,this.aoVals=r.AOmultipliers,this.revAoVal=r.reverseAOmultiplier,this.meshingCutoffTime=6,this._scene=null,this._engine=null,this._octreeManager=null,this.initScene(n,r),r.showFPS&&nc()}initScene(t,r){this._engine=new Kr(t,r.antiAlias,{preserveDrawingBuffer:r.preserveDrawingBuffer}),this._scene=new Mi(this._engine);var n=this._scene;n.detachControl();var i=Math.round(r.octreeBlockSize);this._octreeManager=new Qu(this,i),this._cameraHolder=new er("camHolder",n),this._camera=new Ci("camera",new fe(0,0,0),n),this._camera.parent=this._cameraHolder,this._camera.minZ=.01,this._camScreen=Yr("camScreen",{size:10},n),this.addMeshToScene(this._camScreen),this._camScreen.position.z=.1,this._camScreen.parent=this._camera,this._camScreenMat=this.makeStandardMaterial("camscreenmat"),this._camScreen.material=this._camScreenMat,this._camScreen.setEnabled(!1),this._camScreenMat.freeze(),this._camLocBlock=0;var s=new fe(.1,1,.3);this._light=new wi("light",s,n);function o(a){return new nt(a[0],a[1],a[2])}n.clearColor=Li.FromColor3(o(r.clearColor)),n.ambientColor=o(r.ambientColor),this._light.diffuse=o(r.lightDiffuse),this._light.specular=o(r.lightSpecular),this._light.groundColor=o(r.groundLightColor),n.skipPointerMovePicking=!0}}J.prototype.getScene=function(){return this._scene};J.prototype.tick=function(e){};J.prototype.render=function(){ec(this),this._engine.beginFrame(),this._scene.render(),ni(),this._engine.endFrame()};J.prototype.postRender=function(){};J.prototype.resize=function(){this._engine.resize(),this.noa._paused&&this.renderOnResize&&this._scene.render()};J.prototype.highlightBlockFace=function(e,t,r){var n=rc(this);if(e){this.noa.globalToLocal(t,null,Te);for(var i=w.dist(this.noa.camera._localGetPosition(),Te),s=.001+.001*i,o=0;o<3;o++)r[o]===0?Te[o]+=.5:Te[o]+=r[o]>0?1+s:-s;n.position.copyFromFloats(Te[0],Te[1],Te[2]),n.rotation.x=r[1]?Math.PI/2:0,n.rotation.y=r[0]?Math.PI/2:0}n.setEnabled(e)};var Te=[];J.prototype.addMeshToScene=function(e,t=!1,r=null,n=null){if(!this._octreeManager.includesMesh(e)){if(!e.parent){r||(r=[e.position.x,e.position.y,e.position.z]);var i=[];this.noa.globalToLocal(r,null,i),e.position.copyFromFloats(i[0],i[1],i[2])}t&&(e.freezeWorldMatrix(),e.freezeNormals&&e.freezeNormals(),e.doNotSyncBoundingInfo=!0),this._octreeManager.addMesh(e,t,r,n),e.onDisposeObservable.add(()=>{this._octreeManager.removeMesh(e)})}};J.prototype.makeStandardMaterial=function(e){var t=new Ti(e,this._scene);return t.specularColor.copyFromFloats(0,0,0),t.ambientColor.copyFromFloats(1,1,1),t.diffuseColor.copyFromFloats(1,1,1),this.postMaterialCreationHook(t),t};J.prototype.postMaterialCreationHook=function(e){};J.prototype.prepareChunkForRendering=function(e){};J.prototype.disposeChunkForRendering=function(e){};J.prototype._rebaseOrigin=function(e){var t=new fe(e[0],e[1],e[2]);this._scene.meshes.forEach(r=>{r.parent||(r.position.subtractInPlace(t),r.isWorldMatrixFrozen&&r.freezeWorldMatrix())}),this._octreeManager.rebase(t)};function ec(e){var t=e.noa.camera,r=t._localGetTargetPosition();e._cameraHolder.position.copyFromFloats(r[0],r[1],r[2]),e._cameraHolder.rotation.x=t.pitch,e._cameraHolder.rotation.y=t.heading,e._camera.position.z=-t.currentZoom;var n=t._localGetPosition(),i=e.noa.worldOriginOffset,s=Math.floor(n[0]+i[0]),o=Math.floor(n[1]+i[1]),a=Math.floor(n[2]+i[2]),c=e.noa.getBlock(s,o,a);tc(e,c)}function tc(e,t){if(t!==e._camLocBlock){if(t===0)e._camScreen.setEnabled(!1);else{var r=e.noa.registry.getBlockFaceMaterial(t,0);if(r){var n=e.noa.registry.getMaterialData(r),i=n.color,s=n.alpha;i&&s&&s<1&&(e._camScreenMat.diffuseColor.set(0,0,0),e._camScreenMat.ambientColor.set(i[0],i[1],i[2]),e._camScreenMat.alpha=s,e._camScreen.setEnabled(!0))}}e._camLocBlock=t}}function rc(e){var t=e._highlightMesh;if(!t){t=Yr("highlight",{size:1},e._scene);var r=e.makeStandardMaterial("highlightMat");r.backFaceCulling=!1,r.emissiveColor=new nt(1,1,1),r.alpha=.2,r.freeze(),t.material=r;var n=.5,i=bi("hightlightLines",{points:[new fe(n,n,0),new fe(n,-n,0),new fe(-n,-n,0),new fe(-n,n,0),new fe(n,n,0)]},e._scene);i.color=new nt(1,1,1),i.parent=t,e.addMeshToScene(t),e.addMeshToScene(i),e._highlightMesh=t}return t}J.prototype.debug_SceneCheck=function(){var e=this._scene.meshes,t=this._scene._selectionOctree,r=t.dynamicContent,n=[],i=0,s=0,o=this._scene.materials,a=[];o.forEach(m=>{m.subMaterials?m.subMaterials.forEach(h=>a.push(h)):a.push(m)}),t.blocks.forEach(function(m){i++,m.entries.forEach(h=>n.push(h))}),e.forEach(function(m){if(m.isDisposed&&f(m,"disposed mesh in scene"),!v(m)){if(d(m,r,n)&&f(m,"non-empty mesh missing from octree"),!m.material){f(m,"non-empty scene mesh with no material");return}s+=m.subMeshes?m.subMeshes.length:1;var h=m.material.subMaterials||[m.material];h.forEach(function(p){d(p,h)&&f(p,"mesh material not in scene")})}});var c=[];a.forEach(m=>{var h=!1;e.forEach(p=>{if(p.material===m&&(h=!0),!!p.material){var l=p.material.subMaterials||[p.material];l.includes(m)&&(h=!0)}}),h||c.push(m.name)}),c.length&&console.warn("Materials unused by any mesh: ",c.join(", ")),r.forEach(function(m){d(m,e)&&f(m,"octree/dynamic mesh not in scene")}),n.forEach(function(m){d(m,e)&&f(m,"octree block mesh not in scene")});var u=Math.round(10*n.length/i)/10;console.log("meshes - octree:",n.length,"  dynamic:",r.length,"   subMeshes:",s,"   avg meshes/octreeBlock:",u);function f(m,h){console.warn(m.name+" --- "+h)}function v(m){return m.getIndices().length===0}function d(m,h,p){return!(!m||h.includes(m)||p&&p.includes(m))}return"done."};J.prototype.debug_MeshCount=function(){var e={};this._scene.meshes.forEach(r=>{var n=r.name||"";n=n.replace(/-\d+.*/,"#"),n=n.replace(/\d+.*/,"#"),n=n.replace(/(rotHolder|camHolder|camScreen)/,"rendering use"),n=n.replace(/atlas sprite .*/,"atlas sprites"),e[n]=e[n]||0,e[n]++});for(var t in e)console.log("   "+(e[t]+"       ").substr(0,7)+t)};var ni=function(){};function nc(){var e=document.createElement("div");e.id="noa_fps",e.style.position="absolute",e.style.top="0",e.style.right="0",e.style.zIndex="0",e.style.color="white",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.font="14px monospace",e.style.textAlign="center",e.style.minWidth="2em",e.style.margin="4px",document.body.appendChild(e);var t=1e3,r=0,n=0,i=performance.now(),s=i;ni=function(){r++;var o=performance.now();if(o-s>n&&(n=o-s),s=o,!(o-i<t)){var a=Math.round(r/(o-i)*1e3),c=Math.round(1/n*1e3);e.innerHTML=a+"<br>"+c,r=0,n=0,i=o}}}class ic{constructor(t,r,n,i,s,o,a){this.aabb=new Rt(t.base,t.vec),this.mass=r,this.friction=n,this.restitution=i,this.gravityMultiplier=s,this.onCollide=o,this.autoStep=!!a,this.airDrag=-1,this.fluidDrag=-1,this.onStep=null,this.velocity=w.create(),this.resting=[0,0,0],this.inFluid=!1,this._ratioInFluid=0,this._forces=w.create(),this._impulses=w.create(),this._sleepFrameCount=10}setPosition(t){w.subtract(t,t,this.aabb.base),this.aabb.translate(t),this._markActive()}getPosition(){return w.clone(this.aabb.base)}applyForce(t){w.add(this._forces,this._forces,t),this._markActive()}applyImpulse(t){w.add(this._impulses,this._impulses,t),this._markActive()}_markActive(){this._sleepFrameCount=10}atRestX(){return this.resting[0]}atRestY(){return this.resting[1]}atRestZ(){return this.resting[2]}}function sc(){this.airDrag=.1,this.fluidDrag=.4,this.fluidDensity=2,this.gravity=[0,-10,0],this.minBounceImpulse=.5}function Dt(e,t,r){e=Object.assign(new sc,e),this.gravity=e.gravity||[0,-10,0],this.airDrag=e.airDrag||.1,this.fluidDensity=e.fluidDensity||2,this.fluidDrag=e.fluidDrag||.4,this.minBounceImpulse=e.minBounceImpulse,this.bodies=[],this.testSolid=t,this.testFluid=r}Dt.prototype.addBody=function(e,t,r,n,i,s){e=e||new Rt([0,0,0],[1,1,1]),typeof t>"u"&&(t=1),typeof r>"u"&&(r=1),typeof n>"u"&&(n=0),typeof i>"u"&&(i=1);var o=new ic(e,t,r,n,i,s);return this.bodies.push(o),o};Dt.prototype.removeBody=function(e){var t=this.bodies.indexOf(e);t<0||(this.bodies.splice(t,1),e.aabb=e.onCollide=null)};var vt=w.create(),be=w.create(),Wt=w.create(),me=w.create(),Nr=w.create();Dt.prototype.tick=function(e){e=e/1e3;var t=Ft(0,w.squaredLength(this.gravity));this.bodies.forEach(r=>oc(this,r,e,t))};function oc(e,t,r,n){if(w.copy(Nr,t.resting),t.mass<=0){w.set(t.velocity,0,0,0),w.set(t._forces,0,0,0),w.set(t._impulses,0,0,0);return}var i=n||t.gravityMultiplier===0;if(!fc(e,t,r,i)){t._sleepFrameCount--,ac(e,t),dt(t._forces),dt(t._impulses),dt(t.velocity),dt(t.resting),w.scale(vt,t._forces,1/t.mass),w.scaleAndAdd(vt,vt,e.gravity,t.gravityMultiplier),w.scale(be,t._impulses,1/t.mass),w.scaleAndAdd(be,be,vt,r),w.add(t.velocity,t.velocity,be),t.friction&&(Yt(0,t,be),Yt(1,t,be),Yt(2,t,be));var s=t.airDrag>=0?t.airDrag:e.airDrag;t.inFluid&&(s=t.fluidDrag>=0?t.fluidDrag:e.fluidDrag,s*=1-(1-t.ratioInFluid)**2);var o=Math.max(1-s*r/t.mass,0);w.scale(t.velocity,t.velocity,o),w.scale(Wt,t.velocity,r),w.set(t._forces,0,0,0),w.set(t._impulses,0,0,0),t.autoStep&&si(qr,t.aabb),ii(e,t.aabb,Wt,t.resting),t.autoStep&&cc(e,t,qr,Wt);for(var a=0;a<3;++a)me[a]=0,t.resting[a]&&(Nr[a]||(me[a]=-t.velocity[a]),t.velocity[a]=0);var c=w.length(me);c>.001&&(w.scale(me,me,t.mass),t.onCollide&&t.onCollide(me),t.restitution>0&&c>e.minBounceImpulse&&(w.scale(me,me,t.restitution),t.applyImpulse(me)));var u=w.squaredLength(t.velocity);u>1e-5&&t._markActive()}}function ac(e,t){var r=t.aabb,n=Math.floor(r.base[0]),i=Math.floor(r.base[2]),s=Math.floor(r.base[1]),o=Math.floor(r.max[1]);if(!e.testFluid(n,s,i)){t.inFluid=!1,t.ratioInFluid=0;return}for(var a=1,c=s+1;c<=o&&e.testFluid(n,c,i);)a++,c++;var u=s+a,f=u-r.base[1],v=f/r.vec[1];v>1&&(v=1);var d=r.vec[0]*r.vec[1]*r.vec[2],m=d*v,h=uc;w.scale(h,e.gravity,-e.fluidDensity*m),t.applyForce(h),t.inFluid=!0,t.ratioInFluid=v}var uc=w.create();function Yt(e,t,r){var n=t.resting[e],i=r[e];if(n!==0&&!(n*i<=0)){w.copy(Zt,t.velocity),Zt[e]=0;var s=w.length(Zt);if(!Ft(s,0)){var o=Math.abs(t.friction*i),a=s>o?(s-o)/s:0;t.velocity[(e+1)%3]*=a,t.velocity[(e+2)%3]*=a}}}var Zt=w.create();function ii(e,t,r,n){return w.set(n,0,0,0),st(e.testSolid,t,r,function(i,s,o,a){n[s]=o,a[s]=0})}var qr=new Rt([],[]),Xt=w.create(),pt=w.create(),Vr=w.create(),Qt=w.create();function cc(e,t,r,n){if(!(t.resting[1]>=0&&!t.inFluid)){var i=t.resting[0]!==0,s=t.resting[2]!==0;if(!!(i||s)){var o=Math.abs(n[0]/n[2]),a=4;if(!(!i&&o>a)&&!(!s&&o<1/a)){w.add(pt,r.base,n);var c=e.testSolid;st(c,r,n,function(d,m,h,p){if(m===1)p[m]=0;else return!0});var u=t.aabb.base[1],f=Math.floor(u+1.001)-u;w.set(Vr,0,f,0);var v=!1;st(c,r,Vr,function(d,m,h,p){return v=!0,!0}),!v&&(w.subtract(Qt,pt,r.base),Qt[1]=0,ii(e,r,Qt,Xt),!(i&&!Ft(r.base[0],pt[0]))&&(s&&!Ft(r.base[2],pt[2])||(si(t.aabb,r),t.resting[0]=Xt[0],t.resting[2]=Xt[2],t.onStep&&t.onStep())))}}}}function fc(e,t,r,n){if(t._sleepFrameCount>0)return!1;if(n)return!0;var i=!1,s=.5*r*r*t.gravityMultiplier;return w.scale(Hr,e.gravity,s),st(e.testSolid,t.aabb,Hr,function(){return i=!0,!0},!0),i}var Hr=w.create();function Ft(e,t){return Math.abs(e-t)<1e-5}function si(e,t){for(var r=0;r<3;r++)e.base[r]=t.base[r],e.max[r]=t.max[r],e.vec[r]=t.vec[r]}var dt=function(e){},lc={gravity:[0,-10,0],airDrag:.1};class hc extends Dt{constructor(t,r){r=Object.assign({},lc,r);var n=t.world,i=t.registry._solidityLookup,s=t.registry._fluidityLookup,o=t.worldOriginOffset,a=(u,f,v)=>{var d=n.getBlockID(u+o[0],f+o[1],v+o[2]);return i[d]},c=(u,f,v)=>{var d=n.getBlockID(u+o[0],f+o[1],v+o[2]);return s[d]};super(r,a,c)}}function he(e,t,r,n,i,s,o,a=-1){this.noa=e,this.isDisposed=!1,this.requestID=t,this.voxels=o,this.i=r,this.j=n,this.k=i,this.size=s,this.x=r*s,this.y=n*s,this.z=i*s,this.pos=[this.x,this.y,this.z],this._terrainDirty=!1,this._objectsDirty=!1,this._terrainMeshes=[],e._terrainMesher.initChunk(this),e._objectMesher.initChunk(this),this._isFull=!1,this._isEmpty=!1,this._wholeLayerVoxel=Array(s).fill(-1),a>=0&&(this.voxels.data.fill(a,0,this.voxels.size),this._wholeLayerVoxel.fill(a));var c=Array.from(Array(27),()=>null);this._neighbors=it(c,[3,3,3]).lo(1,1,1),this._neighbors.set(0,0,0,this),this._neighborCount=0,this._timesMeshed=0,this._blockHandlerLocs=new we,oi(this)}he._createVoxelArray=function(e){var t=new Uint16Array(e*e*e);return it(t,[e,e,e])};he.prototype._updateVoxelArray=function(e,t=-1){ai(this,"onUnload"),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels=e,this._terrainDirty=!1,this._objectsDirty=!1,this._blockHandlerLocs.empty(),this.noa._objectMesher.initChunk(this),this.noa._terrainMesher.initChunk(this),t>=0?this._wholeLayerVoxel.fill(t):this._wholeLayerVoxel.fill(-1),oi(this)};he.prototype.get=function(e,t,r){return this.voxels.get(e,t,r)};he.prototype.getSolidityAt=function(e,t,r){var n=this.noa.registry._solidityLookup;return n[this.voxels.get(e,t,r)]};he.prototype.set=function(e,t,r,n){var i=this.voxels.get(e,t,r);if(n!==i){this.voxels.set(e,t,r,n);var s=this.noa.registry._solidityLookup,o=this.noa.registry._objectLookup,a=this.noa.registry._opacityLookup,c=this.noa.registry._blockHandlerLookup;a[n]||(this._isFull=!1),n!==0&&(this._isEmpty=!1),this._wholeLayerVoxel[t]!==n&&(this._wholeLayerVoxel[t]=-1);var u=c[i],f=c[n];u&&Pt(this,u,"onUnset",e,t,r),f?(Pt(this,f,"onSet",e,t,r),this._blockHandlerLocs.add(e,t,r)):this._blockHandlerLocs.remove(e,t,r);var v=this.noa._objectMesher,d=o[i],m=o[n];d&&v.setObjectBlock(this,0,e,t,r),m&&v.setObjectBlock(this,n,e,t,r);var h=s[i]!==s[n],p=a[i]!==a[n],l=!d&&i!==0,y=!m&&n!==0;if((d||m)&&(this._objectsDirty=!0),(h||p||l||y)&&(this._terrainDirty=!0),(this._terrainDirty||this._objectsDirty)&&this.noa.world._queueChunkForRemesh(this),h||p){for(var g=this.size-1,_=e===0?-1:0,k=t===0?-1:0,M=r===0?-1:0,T=e===g?1:0,E=t===g?1:0,L=r===g?1:0,F=_;F<=T;F++)for(var C=k;C<=E;C++)for(var b=M;b<=L;b++)if((F|C|b)!==0){var A=this._neighbors.get(F,C,b);!A||(A._terrainDirty=!0,this.noa.world._queueChunkForRemesh(A))}}}};function Pt(e,t,r,n,i,s){var o=t[r];!o||o(e.x+n,e.y+i,e.z+s)}he.prototype.updateMeshes=function(){this._terrainDirty&&(this.noa._terrainMesher.meshChunk(this),this._timesMeshed++,this._terrainDirty=!1),this._objectsDirty&&(this.noa._objectMesher.buildObjectMeshes(),this._objectsDirty=!1)};function oi(e){for(var t=e.voxels,r=t.data,n=t.shape[0],i=e.noa.registry._opacityLookup,s=e.noa.registry._blockHandlerLookup,o=e.noa.registry._objectLookup,a=e.noa.registry._blockIsPlainLookup,c=e.noa._objectMesher,u=!0,f=!0,v=0;v<n;++v){var d=e._wholeLayerVoxel[v];if(d>=0&&!c[d]&&!s[d]){i[d]||(u=!1),d!==0&&(f=!1);continue}for(var m=t.get(0,v,0),h=0;h<n;++h)for(var p=t.index(h,v,0),l=0;l<n;++l,++p){var y=r[p];if(m>=0&&y!==m&&(m=-1),y===0){u=!1;continue}if(a[y]){f=!1;continue}u=u&&i[y],f=!1,o[y]&&(c.setObjectBlock(e,y,h,v,l),e._objectsDirty=!0);var g=s[y];g&&(e._blockHandlerLocs.add(h,v,l),Pt(e,g,"onLoad",h,v,l))}m>=0&&(e._wholeLayerVoxel[v]=m)}e._isFull=u,e._isEmpty=f,e._terrainDirty=!e._isEmpty}he.prototype.dispose=function(){ai(this,"onUnload"),this._blockHandlerLocs.empty(),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels.data=null,this.voxels=null,this._neighbors.data=null,this._neighbors=null,this.isDisposed=!0};function ai(e,t){var r=e.voxels,n=e.noa.registry._blockHandlerLookup;e._blockHandlerLocs.arr.forEach(([i,s,o])=>{var a=r.get(i,s,o);Pt(e,n[a],t,i,s,o)})}var vc=0,pc=0,dc={chunkSize:24,chunkAddDistance:[2,2],chunkRemoveDistance:[3,3],worldGenWhilePaused:!1,manuallyControlChunkLoading:!1};class H extends at.exports{constructor(t,r){super(),r=Object.assign({},dc,r),this.noa=t,this.playerChunkLoaded=!1,this.Chunk=he,this.manuallyControlChunkLoading=!!r.manuallyControlChunkLoading,this.chunkSortingDistFn=fi,this.minNeighborsToMesh=6,this.worldGenWhilePaused=!!r.worldGenWhilePaused,this.maxChunksPendingCreation=10,this.maxChunksPendingMeshing=10,this.maxProcessingPerTick=9,this.maxProcessingPerRender=5,this._chunkSize=r.chunkSize,this._chunkAddDistance=[2,2],this._chunkRemoveDistance=[3,3],this._addDistanceFn=null,this._remDistanceFn=null,this._prevWorldName="",this._prevPlayerChunkHash=0,this._chunkAddSearchFrom=0,this._prevSortingFn=null,this._chunksKnown=null,this._chunksPending=null,this._chunksToRequest=null,this._chunksToRemove=null,this._chunksToMesh=null,this._chunksToMeshFirst=null,this._chunksSortedLocs=null,mc(this),this.setAddRemoveDistance(r.chunkAddDistance,r.chunkRemoveDistance),this._storage=new xu;var n=this._chunkSize;this._coordsToChunkIndexes=Ec,this._coordsToChunkLocals=Fc;var i=(n&n-1)===0;i&&(this._coordShiftBits=Math.log2(n)|0,this._coordMask=n-1|0,this._coordsToChunkIndexes=Pc,this._coordsToChunkLocals=xc)}}H.prototype.getBlockID=function(e,t,r){var[n,i,s]=this._coordsToChunkIndexes(e,t,r),o=this._storage.getChunkByIndexes(n,i,s);if(!o)return 0;var[a,c,u]=this._coordsToChunkLocals(e,t,r);return o.voxels.get(a,c,u)};H.prototype.getBlockSolidity=function(e,t,r){var[n,i,s]=this._coordsToChunkIndexes(e,t,r),o=this._storage.getChunkByIndexes(n,i,s);if(!o)return!1;var[a,c,u]=this._coordsToChunkLocals(e,t,r);return!!o.getSolidityAt(a,c,u)};H.prototype.getBlockOpacity=function(e,t,r){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockOpacity(n)};H.prototype.getBlockFluidity=function(e,t,r){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockFluidity(n)};H.prototype.getBlockProperties=function(e,t,r){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockProps(n)};H.prototype.setBlockID=function(e,t,r,n){var[i,s,o]=this._coordsToChunkIndexes(t,r,n),a=this._storage.getChunkByIndexes(i,s,o);if(!!a){var[c,u,f]=this._coordsToChunkLocals(t,r,n);return a.set(c,u,f,e,t,r,n)}};H.prototype.isBoxUnobstructed=function(e){for(var t=e.base,r=e.max,n=Math.floor(t[0]);n<r[0]+1;n++)for(var i=Math.floor(t[1]);i<r[1]+1;i++)for(var s=Math.floor(t[2]);s<r[2]+1;s++)if(this.getBlockSolidity(n,i,s))return!1;return!0};H.prototype.setChunkData=function(e,t,r=null,n=-1){Lc(this,e,t,r,n)};H.prototype.setAddRemoveDistance=function(e=2,t=3){var r=Array.isArray(e)?e:[e,e],n=Array.isArray(t)?t:[t,t],i=1;n[0]<r[0]+i&&(n[0]=r[0]+i),n[1]<r[1]+i&&(n[1]=r[1]+i),this._chunkAddDistance=r,this._chunkRemoveDistance=n,this._addDistanceFn=Gr(r[0],r[1]),this._remDistanceFn=Gr(n[0],n[1]),this._chunksSortedLocs.empty();for(var s=0;s<=r[0];s++)for(var o=0;o<=s;o++)for(var a=0;a<=r[1];a++)!this._addDistanceFn(s,a,o)||this._chunksSortedLocs.add(s,a,o);this._prevSortingFn=null,this._chunkAddSearchFrom=0};H.prototype.invalidateVoxelsInAABB=function(e){yc(this,e)};H.prototype.manuallyLoadChunk=function(e,t,r){if(!this.manuallyControlChunkLoading)throw ui;var[n,i,s]=this._coordsToChunkIndexes(e,t,r);this._chunksKnown.add(n,i,s),this._chunksToRequest.add(n,i,s)};H.prototype.manuallyUnloadChunk=function(e,t,r){if(!this.manuallyControlChunkLoading)throw ui;var[n,i,s]=this._coordsToChunkIndexes(e,t,r);this._chunksToRemove.add(n,i,s),this._chunksToMesh.remove(n,i,s),this._chunksToRequest.remove(n,i,s),this._chunksToMeshFirst.remove(n,i,s)};var ui="Set `noa.world.manuallyControlChunkLoading` if you need this API";H.prototype.tick=function(){var e=performance.now(),[t,r,n]=ci(this),i=le(t,r,n),s=i!==this._prevPlayerChunkHash;s&&(this.emit("playerEnteredChunk",t,r,n),this._prevPlayerChunkHash=i,this._chunkAddSearchFrom=0),this._prevWorldName!==this.noa.worldName&&(kc(this),this._prevWorldName=this.noa.worldName,this._chunkAddSearchFrom=0,mt(this)),ge("start"),je("start"),this.manuallyControlChunkLoading||(s&&(_c(this,t,r,n),ge("remQueue")),gc(this,t,r,n),ge("addQueue"));var o=Math.max(1,this.maxProcessingPerTick||0),a=!1,c=!1,u=!1;sr(o,()=>(a||(a=Cc(this)),ge("requests"),c||(c=ar(this,!1)),ge("meshes"),u||(u=mt(this)||mt(this)||mt(this),ge("removes")),a&&c&&u),e);var f=performance.now()-e;o-=f,o>.5&&(Mc(this),ge("looking"),sr(o,()=>ar(this,!1),e),ge("meshes"));var v=this._storage.getChunkByIndexes(t,r,n);this.playerChunkLoaded=!!v,je("end",this),ge("end")};H.prototype.render=function(){var e=this.maxProcessingPerRender;e>0&&sr(e,()=>ar(this,!0))};H.prototype._getChunkByCoords=function(e,t,r){var[n,i,s]=this._coordsToChunkIndexes(e,t,r);return this._storage.getChunkByIndexes(n,i,s)};function mc(e){e._chunksKnown=new we,e._chunksToMesh=new we,e._chunksPending=new we,e._chunksToRemove=new we,e._chunksToRequest=new we,e._chunksToMeshFirst=new we,e._chunksSortedLocs=new we}H.prototype._queueChunkForRemesh=function(e){Bt(this,e)};function ci(e){var[t,r,n]=e.noa.entities.getPosition(e.noa.playerEntity);return e._coordsToChunkIndexes(t,r,n)}function gc(e,t,r,n){var i=e._chunksToRequest,s=e._chunkAddSearchFrom,o=e._chunksSortedLocs;if(!(s>=o.arr.length)&&!(e._chunksToRequest.count()>50)){e._prevSortingFn!==e.chunkSortingDistFn&&(e.chunkSortingDistFn||(e.chunkSortingDistFn=fi),xt(o,0,0,0,e.chunkSortingDistFn,!0),e._prevSortingFn=e.chunkSortingDistFn),Se.removals=0,Se.ci=t,Se.cj=r,Se.ck=n;for(var a=e._chunksSortedLocs.arr,c=s;c<a.length;c++){var[u,f,v]=a[c];if(Ct(e,Se,u,f,v),Se.removals===0){if(e._chunkAddSearchFrom=c+1,i.count()>100||c-s>50)break}else if(i.count()>50||c-s>5)break}xt(i,t,r,n,e.chunkSortingDistFn,!1,!0)}}var Se={},Ct=(e,t,r,n,i)=>{jr(e,t,t.ci+r,t.cj+n,t.ck+i),r!==i&&jr(e,t,t.ci+i,t.cj+n,t.ck+r),r>0&&Ct(e,t,-r,n,i),n>0&&Ct(e,t,r,-n,i),i>0&&Ct(e,t,r,n,-i)},jr=(e,t,r,n,i)=>{e._chunksKnown.includes(r,n,i)?e._chunksToRemove.includes(r,n,i)&&t.removals++:(e._chunksKnown.add(r,n,i),e._chunksToRequest.add(r,n,i,!0))};function _c(e,t,r,n){var i=e._remDistanceFn,s=e._chunksToRemove;e._chunksKnown.forEach(([o,a,c])=>{s.includes(o,a,c)||i(o-t,a-r,c-n)||(e._chunksToRemove.add(o,a,c),e._chunksToMesh.remove(o,a,c),e._chunksToRequest.remove(o,a,c),e._chunksToMeshFirst.remove(o,a,c))}),xt(s,t,r,n,e.chunkSortingDistFn,!1,!0)}function yc(e,t){for(var r=e._coordsToChunkIndexes(t.base[0],t.base[1],t.base[2]),n=e._coordsToChunkIndexes(t.max[0],t.max[1],t.max[2]),i=0;i<3;i++)Number.isFinite(t.base[i])||(r[i]=t.base[i]),Number.isFinite(t.max[i])||(n[i]=t.max[i]);e._chunksKnown.forEach(s=>{for(var o=0;o<3;o++)if(s[o]<r[o]||s[o]>=n[o])return;e._chunksToRemove.add(s[0],s[1],s[2]),e._chunksToMesh.remove(s[0],s[1],s[2]),e._chunksToRequest.remove(s[0],s[1],s[2]),e._chunksToMeshFirst.remove(s[0],s[1],s[2])})}function kc(e){e._chunksToRemove.copyFrom(e._chunksKnown),e._chunksToRequest.empty(),e._chunksToMesh.empty(),e._chunksToMeshFirst.empty();var[t,r,n]=ci(e);xt(e._chunksToRemove,t,r,n,e.chunkSortingDistFn,!1,!0)}function Mc(e){var t=5,r=e._chunksToMesh.count()+e._chunksToMeshFirst.count();if(!(r>t))for(var n=e._chunksKnown.arr,i=Math.min(50,n.length),s=0;s<i;s++){Jt=(Jt+1)%n.length;var[o,a,c]=n[Jt],u=e._storage.getChunkByIndexes(o,a,c);if(!!u){var f=Bt(e,u);if(f&&r++,r>t)return}}}var Jt=-1;function Cc(e){var t=e._chunksToRequest;if(t.isEmpty())return!0;var r=e._chunksPending.count(),n=e._chunksToMesh.count();if(r>=e.maxChunksPendingCreation||n>=e.maxChunksPendingMeshing)return!0;var[i,s,o]=t.pop();return wc(e,i,s,o),t.isEmpty()}function mt(e){var t=e._chunksToRemove;if(t.isEmpty())return!0;var[r,n,i]=t.pop();return Tc(e,r,n,i),t.isEmpty()}function ar(e,t){var r=e._chunksToMeshFirst;if(r.isEmpty()&&!t&&(r=e._chunksToMesh),r.isEmpty())return!0;var[n,i,s]=r.pop();if(!e._chunksToRemove.includes(n,i,s)){var o=e._storage.getChunkByIndexes(n,i,s);o&&bc(e,o)}}function Bt(e,t){if(!(t._terrainDirty||t._objectsDirty)||t._neighborCount<t.minNeighborsToMesh||e._chunksToMesh.includes(t.i,t.j,t.k)||e._chunksToMeshFirst.includes(t.i,t.j,t.k))return!1;var r=t._neighborCount===26?e._chunksToMeshFirst:e._chunksToMesh;return r.add(t.i,t.j,t.k),!0}function wc(e,t,r,n){var i=e._chunkSize,s=he._createVoxelArray(e._chunkSize),o=e.noa.worldName,a=[t,r,n,o].join("|"),c=t*i,u=r*i,f=n*i;e._chunksPending.add(t,r,n),e.emit("worldDataNeeded",a,s,c,u,f,o),je("request")}function Lc(e,t,r,n,i){var s=t.split("|"),o=parseInt(s.shift()),a=parseInt(s.shift()),c=parseInt(s.shift()),u=s.join("|");if(e._chunksPending.remove(o,a,c),u===e.noa.worldName&&!!e._chunksKnown.includes(o,a,c)&&!e._chunksToRemove.includes(o,a,c)){var f=e._storage.getChunkByIndexes(o,a,c);if(f)f._updateVoxelArray(r,i);else{var v=e._chunkSize;f=new he(e.noa,t,o,a,c,v,r,i),e._storage.storeChunkByIndexes(o,a,c,f),f.userData=n,e.noa.rendering.prepareChunkForRendering(f),e.emit("chunkAdded",f)}Bt(e,f),li(e,o,a,c,f),je("receive")}}function Tc(e,t,r,n){var i=e._storage.getChunkByIndexes(t,r,n);i&&(e.emit("chunkBeingRemoved",i.requestID,i.voxels,i.userData),e.noa.rendering.disposeChunkForRendering(i),i.dispose(),je("dispose"),li(e,t,r,n,null)),e._storage.removeChunkByIndexes(t,r,n),e._chunksKnown.remove(t,r,n),e._chunksToMesh.remove(t,r,n),e._chunksToMeshFirst.remove(t,r,n)}function bc(e,t){e._chunksToMesh.remove(t.i,t.j,t.k),e._chunksToMeshFirst.remove(t.i,t.j,t.k),t.updateMeshes(),je("mesh")}function Ec(e,t,r){var n=this._chunkSize;return[Math.floor(e/n)|0,Math.floor(t/n)|0,Math.floor(r/n)|0]}function Fc(e,t,r){var n=this._chunkSize,i=e%n|0;i<0&&(i+=n);var s=t%n|0;s<0&&(s+=n);var o=r%n|0;return o<0&&(o+=n),[i,s,o]}function Pc(e,t,r){var n=this._coordShiftBits;return[e>>n|0,t>>n|0,r>>n|0]}function xc(e,t,r){var n=this._coordMask;return[e&n|0,t&n|0,r&n|0]}function xt(e,t,r,n,i,s=!1,o=!1){var a=(c,u,f)=>i(t-c,r-u,n-f);e.sortByDistance(a,s,o)}var fi=(e,t,r)=>e*e+t*t+r*r;function li(e,t,r,n,i){for(var s=!i||i&&!i.isEmpty,o=-1;o<=1;o++)for(var a=-1;a<=1;a++)for(var c=-1;c<=1;c++)if((o|a|c)!==0){var u=e._storage.getChunkByIndexes(t+o,r+a,n+c);if(!!u){s&&(u._terrainDirty=!0),i&&!i._neighbors.get(o,a,c)&&(i._neighborCount++,i._neighbors.set(o,a,c,u));var f=u._neighbors.get(-o,-a,-c);i&&!f&&(u._neighborCount++,u._neighbors.set(-o,-a,-c,i),u._neighborCount===26&&Bt(e,u)),!i&&f&&(u._neighborCount--,u._neighbors.set(-o,-a,-c,null))}}}function Gr(e,t){var r=e*e,n=t*t;return e===t?(i,s,o)=>i*i+s*s+o*o<=r:e>t?(i,s,o)=>Math.abs(s)>t?!1:i*i+s*s+o*o<=r:(i,s,o)=>{var a=i*i+o*o;return a>r?!1:a+s*s<=n}}H.prototype.report=function(){console.log("World report - playerChunkLoaded: ",this.playerChunkLoaded),Qe(this,"  known:     ",this._chunksKnown.arr,!0),Qe(this,"  to request:",this._chunksToRequest.arr,0),Qe(this,"  to remove: ",this._chunksToRemove.arr,0),Qe(this,"  creating:  ",this._chunksPending.arr,0),Qe(this,"  to mesh:   ",this._chunksToMesh.arr.concat(this._chunksToMeshFirst.arr),0)};function Qe(e,t,r,n){var i=0,s=0,o=0,a=0,c=[];r.forEach(m=>{var h=e._storage.getChunkByIndexes(m[0],m[1],m[2]);!h||(o++,c.push(h._timesMeshed),h._isFull&&i++,h._isEmpty&&s++,h._neighborCount===26&&a++)});var u=r.length.toString().padEnd(8);if(u+=("exist: "+o).padEnd(12),u+=("full: "+i).padEnd(12),u+=("empty: "+s).padEnd(12),u+=("surr: "+a).padEnd(12),n){var f=c.reduce((m,h)=>m+h,0),v=c.reduce((m,h)=>Math.max(m,h),0),d=c.reduce((m,h)=>Math.min(m,h),0);u+="times meshed: avg "+(f/o).toFixed(2),u+="  max "+v,u+="  min "+d}console.log(t,u)}var ge=Iu(vc,"world ticks:",1),je=(e=>{if(!(e>0))return()=>{};var t=0,r={},n={},i=performance.now();return function(o,a){if(o!=="start"){if(o!=="end")return r[o]=(r[o]||0)+1;if(n.toreq=(n.toreq||0)+a._chunksToRequest.count(),n.toget=(n.toget||0)+a._chunksPending.count(),n.tomesh=(n.tomesh||0)+a._chunksToMesh.count()+a._chunksToMeshFirst.count(),n.tomesh1=(n.tomesh1||0)+a._chunksToMeshFirst.count(),n.torem=(n.torem||0)+a._chunksToRemove.count(),!(++t<e)){var c=performance.now(),u=c-i,f={};Object.keys(n).forEach(v=>{var d=Math.round((n[v]||0)/t);f[v]=`[${d}]`.padStart(5)}),Object.keys(r).forEach(v=>{var d=Math.round((r[v]||0)*1e3/u);f[v]=(""+d).padStart(3)}),console.log("chunk flow: ",`${f.toreq}-> ${f.request||0} req/s  `,`${f.toget}-> ${f.receive||0} got/s  `,`${f.tomesh}-> ${f.mesh||0} mesh/s  `,`${f.torem}-> ${f.dispose||0} rem/s  `,`(meshFirst: ${f.tomesh1.trim()})`),t=0,r={},n={},i=performance.now()}}}})(pc);const Ic="noa-engine",Ac="0.33.0",Rc="Experimental voxel game engine",Oc="src/index.js",Sc="dist/src/index.d.ts",Dc=["/src","/dist"],Bc={build:"npm run types; npm run docs",types:"tsc",docs:"typedoc"},Uc="Andy Hall (https://fenomas.com)",$c="MIT",zc={type:"git",url:"https://github.com/fenomas/noa.git"},Nc={url:"https://github.com/fenomas/noa/issues"},qc={"aabb-3d":"fenomas/aabb-3d","box-intersect":"fenomas/box-intersect","ent-comp":"^0.10.1",events:"^3.3.0","fast-voxel-raycast":"^0.1.1","game-inputs":"^0.7.0","gl-vec3":"^1.1.3","micro-game-shell":"^0.7.0",ndarray:"^1.0.19","voxel-aabb-sweep":"^0.5.0","voxel-physics-engine":"^0.13.0"},Vc={"@babylonjs/core":"^5.11.0"},Hc={eslint:"^8.3.0","js-beautify":"^1.14.0",typedoc:"^0.22.15",typescript:"^4.6.4"},jc=["voxel","voxels","game","engine","game-engine"],Gc={name:Ic,version:Ac,description:Rc,main:Oc,typings:Sc,files:Dc,scripts:Bc,author:Uc,license:$c,repository:zc,bugs:Nc,dependencies:qc,peerDependencies:Vc,devDependencies:Hc,keywords:jc};var Kc=Gc.version,Wc={debug:!1,silent:!1,silentBabylon:!1,playerHeight:1.8,playerWidth:.6,playerStart:[0,10,0],playerAutoStep:!1,tickRate:30,maxRenderRate:0,blockTestDistance:10,stickyPointerLock:!0,dragCameraOutsidePointerLock:!0,stickyFullscreen:!1,skipDefaultHighlighting:!1,originRebaseDistance:25};class ef extends at.exports.EventEmitter{constructor(t={}){if(super(),t=Object.assign({},Wc,t),this.version=Kc,!t.silent){var r=t.debug?" (debug)":"";console.log(`noa-engine v${this.version}${r}`)}this._paused=!1,this._dragOutsideLock=t.dragCameraOutsidePointerLock,this._originRebaseDistance=t.originRebaseDistance,this.worldOriginOffset=[0,0,0],this.positionInCurrentTick=0,this.worldName="default",this.timeScale=1,this.container=new zo(this,t),this.tickRate=this.container._shell.tickRate,Object.defineProperty(this,"tickRate",{get:()=>this.container._shell.tickRate}),this.maxRenderRate=this.container._shell.maxRenderRate,Object.defineProperty(this,"maxRenderRate",{get:()=>this.container._shell.maxRenderRate,set:a=>{this.container._shell.maxRenderRate=a||0}}),this.inputs=new Oo(this,t,this.container.element),this.registry=new Ku(this,t),this.world=new H(this,t);var n=console.log;t.silentBabylon&&(console.log=()=>{}),this.rendering=new J(this,t,this.container.canvas),t.silentBabylon&&(console.log=n),this.physics=new hc(this,t),this.entities=new Pu(this,t),this.ents=this.entities;var i=this.entities;this.playerEntity=i.add(t.playerStart,t.playerWidth,t.playerHeight,null,null,!0,!0),i.addComponent(this.playerEntity,i.names.collideTerrain),i.addComponent(this.playerEntity,i.names.collideEntities);var s=i.getPhysics(this.playerEntity).body;if(s.gravityMultiplier=2,s.autoStep=t.playerAutoStep,i.addComponent(this.playerEntity,i.names.receivesInputs),i.addComponent(this.playerEntity,i.names.fadeOnZoom),i.addComponent(this.playerEntity,i.names.movement,{airJumps:1}),this.camera=new ua(this,t),this.blockTestDistance=t.blockTestDistance,this.blockTargetIdCheck=this.registry.getBlockSolidity,this.targetedBlock=null,t.skipDefaultHighlighting||(this.defaultBlockHighlightFunction=a=>{a?this.rendering.highlightBlockFace(!0,a.position,a.normal):this.rendering.highlightBlockFace(!1)},this.on("targetBlockChanged",this.defaultBlockHighlightFunction)),this._terrainMesher=new zu(this),this._objectMesher=new Au(this),this._targetedBlockDat={blockID:0,position:w.create(),normal:w.create(),adjacent:w.create()},this._prevTargetHash=0,this._pickPos=w.create(),this._pickResult={_localPosition:w.create(),position:[0,0,0],normal:[0,0,0]},t.debug){this.vec3=w,this.ndarray=it,i.getMovement(1).airJumps=999;var o=window;o.noa=this,o.vec3=w,o.ndarray=it,o.scene=this.rendering._scene}Xc(this)}tick(t){if(t*=this.timeScale||1,this._paused){this.world.worldGenWhilePaused&&this.world.tick();return}if(Yc(this),this.world.tick(),!this.world.playerChunkLoaded){this.rendering.tick(t);return}this.physics.tick(t),this._objectMesher.tick(),this.rendering.tick(t),Zc(this),this.entities.tick(t),this.emit("tick",t);var r=this.inputs.pointerState;r.scrollx=r.scrolly=r.scrollz=0}render(t,r){if(t*=this.timeScale||1,this.positionInCurrentTick=r,this._paused){this.world.worldGenWhilePaused&&this.world.render();return}(this.container.hasPointerLock||!this.container.supportsPointerLock||this._dragOutsideLock&&this.inputs.state.fire)&&this.camera.applyInputsToCamera(),this.world.render(),this.camera.updateBeforeEntityRenderSystems(),this.entities.render(t),this.camera.updateAfterEntityRenderSystems(),this.emit("beforeRender",t),this.rendering.render(),this.rendering.postRender(),this.emit("afterRender",t),this.inputs.pointerState.dx=this.inputs.pointerState.dy=0}setPaused(t=!1){this._paused=!!t,t||(this.inputs.pointerState.dx=this.inputs.pointerState.dy=0)}getBlock(t,r=0,n=0){return t.length?this.world.getBlockID(t[0],t[1],t[2]):this.world.getBlockID(t,r,n)}setBlock(t,r,n=0,i=0){return r.length?this.world.setBlockID(t,r[0],r[1],r[2]):this.world.setBlockID(t,r,n,i)}addBlock(t,r,n=0,i=0){return r.length?this.entities.isTerrainBlocked(r[0],r[1],r[2])?void 0:(this.world.setBlockID(t,r[0],r[1],r[2]),t):this.entities.isTerrainBlocked(r,n,i)?void 0:(this.world.setBlockID(t,r,n,i),t)}globalToLocal(t,r,n){var i=this.worldOriginOffset;if(r){for(var s=0;s<3;s++){var o=t[s]-i[s];o+=r[s],n[s]=o}return n}else return w.subtract(n,t,i)}localToGlobal(t,r,n=null){var i=this.worldOriginOffset;if(n){for(var s=0;s<3;s++){var o=Math.floor(t[s]);r[s]=o+i[s],n[s]=t[s]-o}return r}else return w.add(r,t,i)}pick(t=null,r=null,n=-1,i=null){if(n===0)return null;var s=this._pickPos;return t&&(this.globalToLocal(t,null,s),t=s),this._localPick(t,r,n,i)}_localPick(t=null,r=null,n=-1,i=null){if(n===0)return null;var s=i||this.registry.getBlockSolidity,o=this.world,a=this.worldOriginOffset,c=function(m,h,p){var l=o.getBlockID(m+a[0],h+a[1],p+a[2]);return s(l)};t||(t=this.camera._localGetTargetPosition()),r=r||this.camera.getDirection(),n=n||-1,n<0&&(n=this.blockTestDistance);var u=this._pickResult,f=u._localPosition,v=u.normal,d=no(c,t,r,n,f,v);return d?(w.scaleAndAdd(f,f,v,.01),this.localToGlobal(f,u.position),u):null}}function Yc(e){var t=e.ents.getPositionData(e.playerEntity)._localPosition,r=e._originRebaseDistance;if(!(w.sqrLen(t)<r*r)){for(var n=[],i=0;i<3;i++)n[i]=Math.floor(t[i]),e.worldOriginOffset[i]+=n[i];e.rendering._rebaseOrigin(n),e.entities._rebaseOrigin(n),e._objectMesher._rebaseOrigin(n)}}function Zc(e){var t=0,r=e.blockTargetIdCheck||e.registry.getBlockSolidity,n=e._localPick(null,null,null,r);if(n){var i=e._targetedBlockDat;w.floor(i.adjacent,n.position),w.copy(i.normal,n.normal),w.subtract(i.position,i.adjacent,i.normal),i.blockID=e.world.getBlockID(i.position[0],i.position[1],i.position[2]),e.targetedBlock=i;var s=i.position,o=i.normal,a=le(s[0]+i.blockID,s[1],s[2]);a^=le(o[0],o[1]+i.blockID,o[2]),t=a}else e.targetedBlock=null;t!=e._prevTargetHash&&(e.emit("targetBlockChanged",e.targetedBlock),e._prevTargetHash=t)}function Xc(e){var t="0.27",r=(n,i,s)=>{var o=()=>{throw`This property changed in ${t} - ${s}`};Object.defineProperty(n,i,{get:o,set:o})};r(e,"getPlayerEyePosition","to get the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"setPlayerEyePosition","to set the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"getPlayerPosition","use `noa.ents.getPosition(noa.playerEntity)` or similar"),r(e,"getCameraVector","use `noa.camera.getDirection`"),r(e,"getPlayerMesh","use `noa.ents.getMeshData(noa.playerEntity).mesh` or similar"),r(e,"playerBody","use `noa.ents.getPhysicsBody(noa.playerEntity)`"),r(e.rendering,"zoomDistance","use `noa.camera.zoomDistance`"),r(e.rendering,"_currentZoom","use `noa.camera.currentZoom`"),r(e.rendering,"_cameraZoomSpeed","use `noa.camera.zoomSpeed`"),r(e.rendering,"getCameraVector","use `noa.camera.getDirection`"),r(e.rendering,"getCameraPosition","use `noa.camera.getLocalPosition`"),r(e.rendering,"getCameraRotation","use `noa.camera.heading` and `noa.camera.pitch`"),r(e.rendering,"setCameraRotation","to customize camera behavior see API docs for `noa.camera`"),t="0.28",r(e.rendering,"makeMeshInstance","removed, use Babylon's `mesh.createInstance`"),r(e.world,"_maxChunksPendingCreation",'use `maxChunksPendingCreation` (no "_")'),r(e.world,"_maxChunksPendingMeshing",'use `maxChunksPendingMeshing` (no "_")'),r(e.world,"_maxProcessingPerTick",'use `maxProcessingPerTick` (no "_")'),r(e.world,"_maxProcessingPerRender",'use `maxProcessingPerRender` (no "_")'),t="0.29",r(e,"_constants","removed, voxel IDs are no longer packed with bit flags"),t="0.30",r(e,"_tickRate","tickRate is now at `noa.tickRate`"),r(e.container,"_tickRate","tickRate is now at `noa.tickRate`"),t="0.31",r(e.world,"chunkSize","effectively an internal, so changed to `_chunkSize`"),r(e.world,"chunkAddDistance","set this with `noa.world.setAddRemoveDistance`"),r(e.world,"chunkRemoveDistance","set this with `noa.world.setAddRemoveDistance`")}export{ef as E};
