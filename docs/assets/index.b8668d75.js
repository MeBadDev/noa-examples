import{c as vi,d as rt,e as Jt,T as er,f as di,E as Gr,R as pi,b as Kr,g as mi,O as gi,h as yi,V as le,i as _i,S as ki,F as Mi,a as Wr,H as Ci,j as wi,k as Li,l as Ti}from"./babylon.939b618b.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();window&&!window.global&&(window.global=window.globalThis||{});var tr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},at={exports:{}},Ue=typeof Reflect=="object"?Reflect:null,gr=Ue&&typeof Ue.apply=="function"?Ue.apply:function(t,r,n){return Function.prototype.apply.call(t,r,n)},mt;Ue&&typeof Ue.ownKeys=="function"?mt=Ue.ownKeys:Object.getOwnPropertySymbols?mt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:mt=function(t){return Object.getOwnPropertyNames(t)};function Ei(e){console&&console.warn&&console.warn(e)}var Yr=Number.isNaN||function(t){return t!==t};function $(){$.init.call(this)}at.exports=$;at.exports.once=Pi;$.EventEmitter=$;$.prototype._events=void 0;$.prototype._eventsCount=0;$.prototype._maxListeners=void 0;var yr=10;function Pt(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty($,"defaultMaxListeners",{enumerable:!0,get:function(){return yr},set:function(e){if(typeof e!="number"||e<0||Yr(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");yr=e}});$.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};$.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Yr(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Zr(e){return e._maxListeners===void 0?$.defaultMaxListeners:e._maxListeners}$.prototype.getMaxListeners=function(){return Zr(this)};$.prototype.emit=function(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var a;if(r.length>0&&(a=r[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")gr(c,this,r);else for(var u=c.length,l=tn(c,u),n=0;n<u;++n)gr(l[n],this,r);return!0};function Xr(e,t,r,n){var i,s,a;if(Pt(r),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),a===void 0)a=s[t]=r,++e._eventsCount;else if(typeof a=="function"?a=s[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),i=Zr(e),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=a.length,Ei(o)}return e}$.prototype.addListener=function(t,r){return Xr(this,t,r,!1)};$.prototype.on=$.prototype.addListener;$.prototype.prependListener=function(t,r){return Xr(this,t,r,!0)};function bi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Qr(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=bi.bind(n);return i.listener=r,n.wrapFn=i,i}$.prototype.once=function(t,r){return Pt(r),this.on(t,Qr(this,t,r)),this};$.prototype.prependOnceListener=function(t,r){return Pt(r),this.prependListener(t,Qr(this,t,r)),this};$.prototype.removeListener=function(t,r){var n,i,s,a,o;if(Pt(r),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===r||n.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if(typeof n!="function"){for(s=-1,a=n.length-1;a>=0;a--)if(n[a]===r||n[a].listener===r){o=n[a].listener,s=a;break}if(s<0)return this;s===0?n.shift():xi(n,s),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,o||r)}return this};$.prototype.off=$.prototype.removeListener;$.prototype.removeAllListeners=function(t){var r,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var s=Object.keys(n),a;for(i=0;i<s.length;++i)a=s[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=n[t],typeof r=="function")this.removeListener(t,r);else if(r!==void 0)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this};function Jr(e,t,r){var n=e._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?r?[i.listener||i]:[i]:r?Fi(i):tn(i,i.length)}$.prototype.listeners=function(t){return Jr(this,t,!0)};$.prototype.rawListeners=function(t){return Jr(this,t,!1)};$.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):en.call(e,t)};$.prototype.listenerCount=en;function en(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}$.prototype.eventNames=function(){return this._eventsCount>0?mt(this._events):[]};function tn(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function xi(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function Fi(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function Pi(e,t){return new Promise(function(r,n){function i(a){e.removeListener(t,s),n(a)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),r([].slice.call(arguments))}rn(e,t,s,{once:!0}),t!=="error"&&Ii(e,i,{once:!0})})}function Ii(e,t,r){typeof e.on=="function"&&rn(e,"error",t,r)}function rn(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){n.once&&e.removeEventListener(t,i),r(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var nn=1e-6,sn=Ai;function Ai(){var e=new Float32Array(3);return e[0]=0,e[1]=0,e[2]=0,e}var Ri=Oi;function Oi(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}var an=Si;function Si(e,t,r){var n=new Float32Array(3);return n[0]=e,n[1]=t,n[2]=r,n}var on=Di;function Di(e,t){var r=t[0],n=t[1],i=t[2],s=r*r+n*n+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s),e}var un=Bi;function Bi(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var Ui=zi,_r=an,kr=on,$i=un;function zi(e,t){var r=_r(e[0],e[1],e[2]),n=_r(t[0],t[1],t[2]);kr(r,r),kr(n,n);var i=$i(r,n);return i>1?0:Math.acos(i)}var qi=Ni;function Ni(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var Hi=Vi;function Vi(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e}var ji=Gi,Bt=nn;function Gi(e,t){var r=e[0],n=e[1],i=e[2],s=t[0],a=t[1],o=t[2];return Math.abs(r-s)<=Bt*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-a)<=Bt*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=Bt*Math.max(1,Math.abs(i),Math.abs(o))}var Ki=Wi;function Wi(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var Yi=Zi;function Zi(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}var cn=Xi;function Xi(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}var ln={exports:{}};(function(e){e.exports=cn})(ln);var fn=Qi;function Qi(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}var hn={exports:{}};(function(e){e.exports=fn})(hn);var vn=Ji;function Ji(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}var dn={exports:{}};(function(e){e.exports=vn})(dn);var es=ts;function ts(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}var rs=ns;function ns(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}var is=ss;function ss(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}var as=os;function os(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}var us=cs;function cs(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}var ls=fs;function fs(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}var hs=vs;function vs(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e}var pn=ds;function ds(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)}var mn={exports:{}};(function(e){e.exports=pn})(mn);var gn=ps;function ps(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}var yn={exports:{}};(function(e){e.exports=gn})(yn);var _n=ms;function ms(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)}var kn={exports:{}};(function(e){e.exports=_n})(kn);var Mn=gs;function gs(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}var Cn={exports:{}};(function(e){e.exports=Mn})(Cn);var ys=_s;function _s(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}var ks=Ms;function Ms(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}var Cs=ws;function ws(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],o=r[1],c=r[2];return e[0]=i*c-s*o,e[1]=s*a-n*c,e[2]=n*o-i*a,e}var Ls=Ts;function Ts(e,t,r,n){var i=t[0],s=t[1],a=t[2];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=a+n*(r[2]-a),e}var Es=bs;function bs(e,t){t=t||1;var r=Math.random()*2*Math.PI,n=Math.random()*2-1,i=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=n*t,e}var xs=Fs;function Fs(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[3]*n+r[7]*i+r[11]*s+r[15];return a=a||1,e[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/a,e[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/a,e[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/a,e}var Ps=Is;function Is(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=n*r[0]+i*r[3]+s*r[6],e[1]=n*r[1]+i*r[4]+s*r[7],e[2]=n*r[2]+i*r[5]+s*r[8],e}var As=Rs;function Rs(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],o=r[1],c=r[2],u=r[3],l=u*n+o*s-c*i,d=u*i+c*n-a*s,p=u*s+a*i-o*n,m=-a*n-o*i-c*s;return e[0]=l*u+m*-a+d*-c-p*-o,e[1]=d*u+m*-o+p*-a-l*-c,e[2]=p*u+m*-c+l*-o-d*-a,e}var Os=Ss;function Ss(e,t,r,n){var i=r[1],s=r[2],a=t[1]-i,o=t[2]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=t[0],e[1]=i+a*u-o*c,e[2]=s+a*c+o*u,e}var Ds=Bs;function Bs(e,t,r,n){var i=r[0],s=r[2],a=t[0]-i,o=t[2]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=i+o*c+a*u,e[1]=t[1],e[2]=s+o*u-a*c,e}var Us=$s;function $s(e,t,r,n){var i=r[0],s=r[1],a=t[0]-i,o=t[1]-s,c=Math.sin(n),u=Math.cos(n);return e[0]=i+a*u-o*c,e[1]=s+a*c+o*u,e[2]=t[2],e}var zs=qs,ke=sn();function qs(e,t,r,n,i,s){var a,o;for(t||(t=3),r||(r=0),n?o=Math.min(n*t+r,e.length):o=e.length,a=r;a<o;a+=t)ke[0]=e[a],ke[1]=e[a+1],ke[2]=e[a+2],i(ke,ke,s),e[a]=ke[0],e[a+1]=ke[1],e[a+2]=ke[2];return e}var w={EPSILON:nn,create:sn,clone:Ri,angle:Ui,fromValues:an,copy:qi,set:Hi,equals:ji,exactEquals:Ki,add:Yi,subtract:cn,sub:ln.exports,multiply:fn,mul:hn.exports,divide:vn,div:dn.exports,min:es,max:rs,floor:is,ceil:as,round:us,scale:ls,scaleAndAdd:hs,distance:pn,dist:mn.exports,squaredDistance:gn,sqrDist:yn.exports,length:_n,len:kn.exports,squaredLength:Mn,sqrLen:Cn.exports,negate:ys,inverse:ks,normalize:on,dot:un,cross:Cs,lerp:Ls,random:Es,transformMat4:xs,transformMat3:Ps,transformQuat:As,rotateX:Os,rotateY:Ds,rotateZ:Us,forEach:zs};function Ns(e){for(var t=new Array(e),r=0;r<e;++r)t[r]=r;return t}var Hs=Ns;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var Vs=function(e){return e!=null&&(wn(e)||js(e)||!!e._isBuffer)};function wn(e){return!!e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function js(e){return typeof e.readFloatLE=="function"&&typeof e.slice=="function"&&wn(e.slice(0,0))}var Gs=Hs,Ks=Vs,Ws=typeof Float64Array<"u";function Ys(e,t){return e[0]-t[0]}function Zs(){var e=this.stride,t=new Array(e.length),r;for(r=0;r<t.length;++r)t[r]=[Math.abs(e[r]),r];t.sort(Ys);var n=new Array(t.length);for(r=0;r<n.length;++r)n[r]=t[r][1];return n}function Xs(e,t){var r=["View",t,"d",e].join("");t<0&&(r="View_Nil"+e);var n=e==="generic";if(t===-1){var i="function "+r+"(a){this.data=a;};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+r+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+r+"(a){return new "+r+"(a);}",v=new Function(i);return v()}else if(t===0){var i="function "+r+"(a,d) {this.data = a;this.offset = d};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+r+"_copy() {return new "+r+"(this.data,this.offset)};proto.pick=function "+r+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+r+"_get(){return "+(n?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+r+"_set(v){return "+(n?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+r+"(a,b,c,d){return new "+r+"(a,d)}",v=new Function("TrivialArray",i);return v(Ct[e][0])}var i=["'use strict'"],s=Gs(t),a=s.map(function(h){return"i"+h}),o="this.offset+"+s.map(function(h){return"this.stride["+h+"]*i"+h}).join("+"),c=s.map(function(h){return"b"+h}).join(","),u=s.map(function(h){return"c"+h}).join(",");i.push("function "+r+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+r+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+r+"_size(){return "+s.map(function(h){return"this.shape["+h+"]"}).join("*"),"}})"),t===1?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+r+"_order(){"),t===2?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):t===3&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+r+"_set("+a.join(",")+",v){"),n?i.push("return this.data.set("+o+",v)}"):i.push("return this.data["+o+"]=v}"),i.push("proto.get=function "+r+"_get("+a.join(",")+"){"),n?i.push("return this.data.get("+o+")}"):i.push("return this.data["+o+"]}"),i.push("proto.index=function "+r+"_index(",a.join(),"){return "+o+"}"),i.push("proto.hi=function "+r+"_hi("+a.join(",")+"){return new "+r+"(this.data,"+s.map(function(h){return["(typeof i",h,"!=='number'||i",h,"<0)?this.shape[",h,"]:i",h,"|0"].join("")}).join(",")+","+s.map(function(h){return"this.stride["+h+"]"}).join(",")+",this.offset)}");var l=s.map(function(h){return"a"+h+"=this.shape["+h+"]"}),d=s.map(function(h){return"c"+h+"=this.stride["+h+"]"});i.push("proto.lo=function "+r+"_lo("+a.join(",")+"){var b=this.offset,d=0,"+l.join(",")+","+d.join(","));for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){d=i"+p+"|0;b+=c"+p+"*d;a"+p+"-=d}");i.push("return new "+r+"(this.data,"+s.map(function(h){return"a"+h}).join(",")+","+s.map(function(h){return"c"+h}).join(",")+",b)}"),i.push("proto.step=function "+r+"_step("+a.join(",")+"){var "+s.map(function(h){return"a"+h+"=this.shape["+h+"]"}).join(",")+","+s.map(function(h){return"b"+h+"=this.stride["+h+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'){d=i"+p+"|0;if(d<0){c+=b"+p+"*(a"+p+"-1);a"+p+"=ceil(-a"+p+"/d)}else{a"+p+"=ceil(a"+p+"/d)}b"+p+"*=d}");i.push("return new "+r+"(this.data,"+s.map(function(h){return"a"+h}).join(",")+","+s.map(function(h){return"b"+h}).join(",")+",c)}");for(var m=new Array(t),f=new Array(t),p=0;p<t;++p)m[p]="a[i"+p+"]",f[p]="b[i"+p+"]";i.push("proto.transpose=function "+r+"_transpose("+a+"){"+a.map(function(h,y){return h+"=("+h+"===undefined?"+y+":"+h+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+r+"(this.data,"+m.join(",")+","+f.join(",")+",this.offset)}"),i.push("proto.pick=function "+r+"_pick("+a+"){var a=[],b=[],c=this.offset");for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){c=(c+this.stride["+p+"]*i"+p+")|0}else{a.push(this.shape["+p+"]);b.push(this.stride["+p+"])}");i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+r+"(data,shape,stride,offset){return new "+r+"(data,"+s.map(function(h){return"shape["+h+"]"}).join(",")+","+s.map(function(h){return"stride["+h+"]"}).join(",")+",offset)}");var v=new Function("CTOR_LIST","ORDER",i.join(`
`));return v(Ct[e],Zs)}function Qs(e){if(Ks(e))return"buffer";if(Ws)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}var Ct={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function Js(e,t,r,n){if(e===void 0){var u=Ct.array[0];return u([])}else typeof e=="number"&&(e=[e]);t===void 0&&(t=[e.length]);var i=t.length;if(r===void 0){r=new Array(i);for(var s=i-1,a=1;s>=0;--s)r[s]=a,a*=t[s]}if(n===void 0){n=0;for(var s=0;s<i;++s)r[s]<0&&(n-=(t[s]-1)*r[s])}for(var o=Qs(e),c=Ct[o];c.length<=i+1;)c.push(Xs(o,c.length-1));var u=c[i+1];return u(e,t,r,n)}var nt=Js;function ea(e,t,r,n,i,s,a,o,c,u){for(var l=0,d=Math.floor,p=d(t)|0,m=d(r)|0,f=d(n)|0,v=i>0?1:-1,h=s>0?1:-1,y=a>0?1:-1,g=Math.abs(1/i),_=Math.abs(1/s),k=Math.abs(1/a),M=v>0?p+1-t:t-p,L=h>0?m+1-r:r-m,b=y>0?f+1-n:n-f,T=g<1/0?g*M:1/0,x=_<1/0?_*L:1/0,C=k<1/0?k*b:1/0,E=-1;l<=o;){var A=e(p,m,f);if(A)return c&&(c[0]=t+l*i,c[1]=r+l*s,c[2]=n+l*a),u&&(u[0]=u[1]=u[2]=0,E===0&&(u[0]=-v),E===1&&(u[1]=-h),E===2&&(u[2]=-y)),A;T<x?T<C?(p+=v,l=T,T+=g,E=0):(f+=y,l=C,C+=k,E=2):x<C?(m+=h,l=x,x+=_,E=1):(f+=y,l=C,C+=k,E=2)}return c&&(c[0]=t+l*i,c[1]=r+l*s,c[2]=n+l*a),u&&(u[0]=u[1]=u[2]=0),0}function ta(e,t,r,n,i,s){var a=+t[0],o=+t[1],c=+t[2],u=+r[0],l=+r[1],d=+r[2],p=Math.sqrt(u*u+l*l+d*d);if(p===0)throw new Error("Can't raycast along a zero vector");return u/=p,l/=p,d/=p,typeof n>"u"?n=64:n=+n,ea(e,a,o,c,u,l,d,n,i,s)}var ra=ta,wt={exports:{}},$e=typeof Reflect=="object"?Reflect:null,Mr=$e&&typeof $e.apply=="function"?$e.apply:function(t,r,n){return Function.prototype.apply.call(t,r,n)},gt;$e&&typeof $e.ownKeys=="function"?gt=$e.ownKeys:Object.getOwnPropertySymbols?gt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:gt=function(t){return Object.getOwnPropertyNames(t)};function na(e){console&&console.warn&&console.warn(e)}var Ln=Number.isNaN||function(t){return t!==t};function z(){z.init.call(this)}wt.exports=z;wt.exports.once=oa;z.EventEmitter=z;z.prototype._events=void 0;z.prototype._eventsCount=0;z.prototype._maxListeners=void 0;var Cr=10;function It(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(z,"defaultMaxListeners",{enumerable:!0,get:function(){return Cr},set:function(e){if(typeof e!="number"||e<0||Ln(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");Cr=e}});z.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};z.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Ln(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Tn(e){return e._maxListeners===void 0?z.defaultMaxListeners:e._maxListeners}z.prototype.getMaxListeners=function(){return Tn(this)};z.prototype.emit=function(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var a;if(r.length>0&&(a=r[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")Mr(c,this,r);else for(var u=c.length,l=Pn(c,u),n=0;n<u;++n)Mr(l[n],this,r);return!0};function En(e,t,r,n){var i,s,a;if(It(r),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),a===void 0)a=s[t]=r,++e._eventsCount;else if(typeof a=="function"?a=s[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),i=Tn(e),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=a.length,na(o)}return e}z.prototype.addListener=function(t,r){return En(this,t,r,!1)};z.prototype.on=z.prototype.addListener;z.prototype.prependListener=function(t,r){return En(this,t,r,!0)};function ia(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function bn(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=ia.bind(n);return i.listener=r,n.wrapFn=i,i}z.prototype.once=function(t,r){return It(r),this.on(t,bn(this,t,r)),this};z.prototype.prependOnceListener=function(t,r){return It(r),this.prependListener(t,bn(this,t,r)),this};z.prototype.removeListener=function(t,r){var n,i,s,a,o;if(It(r),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===r||n.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if(typeof n!="function"){for(s=-1,a=n.length-1;a>=0;a--)if(n[a]===r||n[a].listener===r){o=n[a].listener,s=a;break}if(s<0)return this;s===0?n.shift():sa(n,s),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,o||r)}return this};z.prototype.off=z.prototype.removeListener;z.prototype.removeAllListeners=function(t){var r,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var s=Object.keys(n),a;for(i=0;i<s.length;++i)a=s[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=n[t],typeof r=="function")this.removeListener(t,r);else if(r!==void 0)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this};function xn(e,t,r){var n=e._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?r?[i.listener||i]:[i]:r?aa(i):Pn(i,i.length)}z.prototype.listeners=function(t){return xn(this,t,!0)};z.prototype.rawListeners=function(t){return xn(this,t,!1)};z.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):Fn.call(e,t)};z.prototype.listenerCount=Fn;function Fn(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}z.prototype.eventNames=function(){return this._eventsCount>0?gt(this._events):[]};function Pn(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function sa(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function aa(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function oa(e,t){return new Promise(function(r,n){function i(a){e.removeListener(t,s),n(a)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),r([].slice.call(arguments))}In(e,t,s,{once:!0}),t!=="error"&&ua(e,i,{once:!0})})}function ua(e,t,r){typeof e.on=="function"&&In(e,"error",t,r)}function In(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){n.once&&e.removeEventListener(t,i),r(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}const ca="game-inputs",la="0.7.0",fa="Simple library to abstract key/mouse events for games.",ha="src/inputs.js",va="dist/src/inputs.d.ts",da=["/src","/dist"],pa={start:"cd docs/ && webpack serve",build:"tsc; cd docs/ && webpack"},ma="Andy Hall",ga="ISC",ya=["game","inputs","key","mouse","events"],_a={events:"^3.3.0"},ka={type:"git",url:"https://github.com/fenomas/game-inputs"},Ma={url:"https://github.com/fenomas/game-inputs/issues"},Ca={name:ca,version:la,description:fa,main:ha,typings:va,files:da,scripts:pa,author:ma,license:ga,keywords:ya,dependencies:_a,repository:ka,bugs:Ma};var wa=Ca.version;function La(){this.preventDefaults=!1,this.stopPropagation=!1,this.allowContextMenu=!1,this.disabled=!1}class Ta{constructor(t,r){this.version=wa;var n=Object.assign({},new La,r||{});this.element=t||document,this.preventDefaults=!!n.preventDefaults,this.stopPropagation=!!n.stopPropagation,this.allowContextMenu=!!n.allowContextMenu,this.disabled=!!n.disabled,this.filterEvents=(i,s)=>!0,this.down=new wt.exports.EventEmitter,this.up=new wt.exports.EventEmitter,this.state={},this.pointerState={dx:0,dy:0,scrollx:0,scrolly:0,scrollz:0},this.pressCount={},this.releaseCount={},this._keyBindmap={},this._keyStates={},this._bindPressCount={},this._touches={lastX:0,lastY:0,currID:null},document.readyState!=="loading"?wr(this):document.addEventListener("DOMContentLoaded",i=>{wr(this)},{once:!0})}bind(t,...r){r.forEach(n=>{var i=this._keyBindmap[n]||[];i.includes(t)||(i.push(t),this._keyBindmap[n]=i)}),this.state[t]=!!this.state[t],this.pressCount[t]=this.pressCount[t]||0,this.releaseCount[t]=this.releaseCount[t]||0}unbind(t){for(var r in this._keyBindmap){var n=this._keyBindmap[r],i=n.indexOf(t);i>-1&&n.splice(i,1)}}getBindings(){var t={};for(var r in this._keyBindmap){var n=this._keyBindmap[r];n.forEach(i=>{t[i]=t[i]||[],t[i].push(r)})}return t}tick(){Ut(this.pointerState),Ut(this.pressCount),Ut(this.releaseCount)}}function Ut(e){for(var t in e)e[t]=0}function wr(e){window.addEventListener("keydown",Lr.bind(null,e,!0),!1),window.addEventListener("keyup",Lr.bind(null,e,!1),!1);var t={passive:!0};window.PointerEvent?(e.element.addEventListener("pointerdown",ut.bind(null,e,!0),t),window.document.addEventListener("pointerup",ut.bind(null,e,!1),t),e.element.addEventListener("pointermove",Tr.bind(null,e),t)):(e.element.addEventListener("mousedown",ut.bind(null,e,!0),t),window.document.addEventListener("mouseup",ut.bind(null,e,!1),t),e.element.addEventListener("mousemove",Tr.bind(null,e),t)),e.element.addEventListener("wheel",Ea.bind(null,e),t),e.element.addEventListener("contextmenu",ba.bind(null,e),!1),window.addEventListener("blur",xa.bind(null,e),!1)}function Lr(e,t,r){ar(r.code,t,e,r)}function ut(e,t,r){if("pointerId"in r)if(t){if(e._touches.currID!==null)return;e._touches.currID=r.pointerId}else{if(e._touches.currID!==r.pointerId)return;e._touches.currID=null}var n="button"in r?r.button+1:1;return ar("Mouse"+n,t,e,r),!1}function Tr(e,t){if(!("pointerId"in t&&e._touches.currID!==null&&e._touches.currID!==t.pointerId)){var r=t.movementX||t.mozMovementX||0,n=t.movementY||t.mozMovementY||0;e.pointerState.dx+=r,e.pointerState.dy+=n}}function Ea(e,t){var r=1;switch(t.deltaMode){case 0:r=1;break;case 1:r=12;break;case 2:r=e.element.clientHeight||window.innerHeight;break}e.pointerState.scrollx+=(t.deltaX||0)*r,e.pointerState.scrolly+=(t.deltaY||0)*r,e.pointerState.scrollz+=(t.deltaZ||0)*r}function ba(e,t){if(!e.allowContextMenu)return t.preventDefault(),!1}function xa(e){for(var t in e._keyStates)!e._keyStates[t]||/^Mouse\d/.test(t)||ar(t,!1,e,{code:t,note:"This is a mocked KeyboardEvent made by the 'game-inputs' module",preventDefault:()=>{},stopPropagation:()=>{}})}function ar(e,t,r,n){var i=r._keyBindmap[e];if(!!i){var s=r._keyStates[e];An(s,t)&&(r._keyStates[e]=t,i.forEach(a=>{var o=r.filterEvents?r.filterEvents(n,a):!0;!o||Fa(a,t,r,n)})),"button"in n||(r.preventDefaults&&!n.defaultPrevented&&n.preventDefault(),r.stopPropagation&&n.stopPropagation())}}function Fa(e,t,r,n){var i=t?r.pressCount:r.releaseCount;i[e]=(i[e]||0)+1;var s=r._bindPressCount[e]||0;s+=t?1:-1,s<0&&(s=0),r._bindPressCount[e]=s;var a=r.state[e];if(An(a,s)){r.state[e]=s>0;var o=t?r.down:r.up;r.disabled||o.emit(e,n)}}function An(e,t){return e?!t:t}var Pa={preventDefaults:!1,stopPropagation:!1,allowContextMenu:!1},Ia={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],left:["KeyA","ArrowLeft"],right:["KeyD","ArrowRight"],fire:"Mouse1","mid-fire":["Mouse2","KeyQ"],"alt-fire":["Mouse3","KeyE"],jump:"Space"};class Aa extends Ta{constructor(t,r,n){r=Object.assign({},Pa,r),super(n,r);var i=r.bindings||Ia;for(var s in i){var a=Array.isArray(i[s])?i[s]:[i[s]];this.bind(s,...a)}}}class Ra{constructor(t=null,r=10){this.stickyPointerLock=!1,this.stickyFullscreen=!1,this.tickRate=30,this.maxRenderRate=0,this.maxTickTime=100,this.pointerLock=!1,this.fullscreen=!1,this.onTick=function(n){},this.onRender=function(n,i,s){},this.onInit=function(){},this.onResize=function(){},this.onPointerLockChanged=function(n=!1){},this.onFullscreenChanged=function(n=!1){},this.onPointerLockError=function(n){},this._data=new Oa(r),$a(()=>{Sa(this),Ba(this,t),this.onInit()})}}function Oa(e=10){this.nowObject=performance||Date,this.pollTime=e,this.renderAccum=0,this.lastTickStarted=0,this.lastFrameStarted=0,this.lastRenderStarted=0,this.avgTickTime=2,this.frameCB=null,this.intervalCB=null,this.intervalID=-1}function Sa(e){var t=e._data,r=t.nowObject.now();t.lastTickStarted=r,t.lastFrameStarted=r,t.lastRenderStarted=r,t.frameCB=()=>Da(e),t.intervalCB=()=>rr(e),requestAnimationFrame(t.frameCB),t.pollTime>0&&(t.intervalID=setInterval(t.intervalCB,t.pollTime))}function Da(e){var t=e._data;requestAnimationFrame(t.frameCB),rr(e);var r=t.nowObject.now(),n=r-t.lastFrameStarted;if(t.lastFrameStarted=r,e.maxRenderRate>0){t.renderAccum+=n;var i=1e3/e.maxRenderRate;if(t.renderAccum<i)return;t.renderAccum-=i,t.renderAccum>i&&(t.renderAccum=i)}var s=r-t.lastRenderStarted;t.lastRenderStarted=r;var a=1e3/e.tickRate,o=(r-t.lastTickStarted)/a;o<0&&(o=0),e.onRender(s,o,a),setTimeout(rr,0,e,!0)}function rr(e,t=!1){var r=e._data,n=r.nowObject.now(),i=n;t&&(i+=r.avgTickTime);var s=n+e.maxTickTime;s>n||(s=n+1);for(var a=1e3/e.tickRate;r.lastTickStarted+a<i;){e.onTick(a),r.lastTickStarted+=a;var o=r.nowObject.now();if(r.avgTickTime=Ua(r.avgTickTime,o-n),n=o,n>s){r.lastTickStarted=n;return}}}function Ba(e,t){if(!!t){var r=!1,n=!1,i=c=>{if(r=t===document.pointerLockElement,!!c!==r)if(c){var u=t.requestPointerLock();u&&u.catch&&u.catch(l=>{})}else document.exitPointerLock()},s=c=>{n=t===document.fullscreenElement,!!c!==n&&(c?t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};document.addEventListener("pointerlockchange",c=>{r=t===document.pointerLockElement,e.onPointerLockChanged(r)}),document.addEventListener("fullscreenchange",c=>{n=t===document.fullscreenElement,e.onFullscreenChanged(n)}),document.addEventListener("pointerlockerror",c=>{r=t===document.pointerLockElement,e.onPointerLockError(c)}),Object.defineProperty(e,"pointerLock",{get:()=>r,set:i}),Object.defineProperty(e,"fullscreen",{get:()=>n,set:s}),t.addEventListener("click",c=>{e.stickyPointerLock&&i(!0),e.stickyFullscreen&&s(!0)});var a=()=>e.onResize();if(window.ResizeObserver){var o=new ResizeObserver(a);o.observe(t)}else window.addEventListener("resize",a)}}function Ua(e,t){return t>e*4&&(t=e*4),t<e*.25&&(t=e*.25),.9*e+.1*t}function $a(e){if(document.readyState==="loading"){var t=()=>{document.removeEventListener("readystatechange",t),e()};document.addEventListener("readystatechange",t)}else setTimeout(e,0)}class za extends at.exports.EventEmitter{constructor(t,r){super(),r=r||{},this.noa=t;var n=r.domElement||null;typeof n=="string"&&(n=document.querySelector(n)),this.element=n||qa(),this.canvas=Na(this.element),Va(t,this.canvas),this.supportsPointerLock=!1,this.pointerInGame=!1,this.isFocused=!!document.hasFocus(),this.hasPointerLock=!1;var i=10;this._shell=new Ra(this.element,i),this._shell.tickRate=r.tickRate,this._shell.maxRenderRate=r.maxRenderRate,this._shell.stickyPointerLock=r.stickyPointerLock,this._shell.stickyFullscreen=r.stickyFullscreen,this._shell.maxTickTime=50,this._shell.onTick=t.tick.bind(t),this._shell.onRender=t.render.bind(t),this._shell.onPointerLockChanged=s=>{this.hasPointerLock=s,this.emit(s?"gainedPointerLock":"lostPointerLock"),s&&(this.pointerInGame=!0)},this._shell.onInit=()=>{this._shell.onResize=t.rendering.resize.bind(t.rendering),Ha(this),this.element.addEventListener("mouseenter",()=>{this.pointerInGame=!0}),this.element.addEventListener("mouseleave",()=>{this.pointerInGame=!1}),window.addEventListener("focus",()=>{this.isFocused=!0}),window.addEventListener("blur",()=>{this.isFocused=!1});var s=()=>{this.pointerInGame=!0,this.isFocused=!0,this.element.removeEventListener("mousedown",s)};this.element.addEventListener("mousedown",s),this.emit("DOMready"),this._shell.onInit=null}}appendTo(t){this.element.appendChild(t)}setPointerLock(t=!1){this._shell.pointerLock=!!t}}function qa(){var e=document.createElement("div");return e.tabIndex=1,e.style.position="fixed",e.style.left="0px",e.style.right="0px",e.style.top="0px",e.style.bottom="0px",e.style.height="100%",e.style.overflow="hidden",document.body.appendChild(e),document.body.style.overflow="hidden",document.body.style.height="100%",e.id="noa-container",e}function Na(e){var t=e.querySelector("canvas");return t||(t=document.createElement("canvas"),t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.height="100%",t.style.width="100%",t.id="noa-canvas",e.insertBefore(t,e.firstChild)),t}function Ha(e){var t="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(t){e.supportsPointerLock=!0;var r=function(n){e.supportsPointerLock=!1,document.removeEventListener(n.type,r)};document.addEventListener("touchmove",r)}}function Va(e,t){var r=0,n=()=>{var i=t.width;t.width=i+1,t.width=i,r++>10&&e.off("beforeRender",n)};e.on("beforeRender",n)}var At=He,G=w;function He(e,t){if(!(this instanceof He))return new He(e,t);var r=G.create();G.add(r,e,t),this.base=G.min(G.create(),e,r),this.vec=G.clone(t),this.max=G.max(G.create(),e,r),this.mag=G.length(this.vec)}var ja=He,Q=ja.prototype;Q.width=function(){return this.vec[0]};Q.height=function(){return this.vec[1]};Q.depth=function(){return this.vec[2]};Q.x0=function(){return this.base[0]};Q.y0=function(){return this.base[1]};Q.z0=function(){return this.base[2]};Q.x1=function(){return this.max[0]};Q.y1=function(){return this.max[1]};Q.z1=function(){return this.max[2]};Q.translate=function(e){return G.add(this.max,this.max,e),G.add(this.base,this.base,e),this};Q.setPosition=function(e){return G.add(this.max,e,this.vec),G.copy(this.base,e),this};Q.expand=function(e){var t=G.create(),r=G.create();return G.max(t,e.max,this.max),G.min(r,e.base,this.base),G.subtract(t,t,r),new He(r,t)};Q.intersects=function(e){return!(e.base[0]>this.max[0]||e.base[1]>this.max[1]||e.base[2]>this.max[2]||e.max[0]<this.base[0]||e.max[1]<this.base[1]||e.max[2]<this.base[2])};Q.touches=function(e){var t=this.union(e);return t!==null&&(t.width()==0||t.height()==0||t.depth()==0)};Q.union=function(e){if(!this.intersects(e))return null;var t=Math.max(e.base[0],this.base[0]),r=Math.max(e.base[1],this.base[1]),n=Math.max(e.base[2],this.base[2]),i=Math.min(e.max[0],this.max[0]),s=Math.min(e.max[1],this.max[1]),a=Math.min(e.max[2],this.max[2]);return new He([t,r,n],[i-t,s-r,a-n])};var Ga=[],Ka=[],Wa=[],Ya=[],Za=[],Xa=[],Qa=[],Ja=[],eo=[],to=[],ro=[],no=[];function io(e,t,r,n,i,s){var a=Ga,o=Ka,c=Wa,u=Ya,l=Za,d=Xa,p=Ja,m=Math.floor,f=0,v=0,h=0,y=0,g=0;if(k(),h===0)return 0;for(y=b();v<=h;){if(M(y)){var _=L();if(_)return f}y=b()}for(f+=h,g=0;g<3;g++)n[g]+=r[g],i[g]+=r[g];return f;function k(){if(v=0,h=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),h!==0)for(var C=0;C<3;C++){var E=r[C]>=0;u[C]=E?1:-1;var A=E?i[C]:n[C];a[C]=E?n[C]:i[C],o[C]=T(A,u[C]),c[C]=x(a[C],u[C]),p[C]=r[C]/h,l[C]=Math.abs(1/p[C]);var S=E?o[C]+1-A:A-o[C];d[C]=l[C]<1/0?l[C]*S:1/0}}function M(C){for(var E=u[0],A=C===0?o[0]:c[0],S=o[0]+E,F=u[1],P=C===1?o[1]:c[1],U=o[1]+F,R=u[2],I=C===2?o[2]:c[2],D=o[2]+R,H=A;H!=S;H+=E)for(var j=P;j!=U;j+=F)for(var ee=I;ee!=D;ee+=R)if(e(H,j,ee))return!0;return!1}function L(){f+=v;var C=u[y],E=v/h,A=ro;for(g=0;g<3;g++){var S=r[g]*E;n[g]+=S,i[g]+=S,A[g]=r[g]-S}C>0?i[y]=Math.round(i[y]):n[y]=Math.round(n[y]);var F=t(f,y,C,A);if(F)return!0;for(g=0;g<3;g++)r[g]=A[g];return k(),h===0}function b(){var C=d[0]<d[1]?d[0]<d[2]?0:2:d[1]<d[2]?1:2,E=d[C]-v;for(v=d[C],o[C]+=u[C],d[C]+=l[C],g=0;g<3;g++)a[g]+=E*p[g],c[g]=x(a[g],u[g]);return C}function T(C,E){return m(C-E*s)}function x(C,E){return m(C+E*s)}}function so(e,t,r,n,i,s){for(var a=Qa,o=eo,c=to,u=no,l=0;l<3;l++)a[l]=+r[l],c[l]=+t.max[l],o[l]=+t.base[l];s||(s=1e-10);var d=io(e,n,a,o,c,s);if(!i){for(l=0;l<3;l++)u[l]=r[l]>0?c[l]-t.max[l]:o[l]-t.base[l];t.translate(u)}return d}var it=so;function ao(){this.inverseX=!1,this.inverseY=!1,this.sensitivityMult=1,this.sensitivityMultOutsidePointerlock=0,this.sensitivityX=10,this.sensitivityY=10,this.initialZoom=0,this.zoomSpeed=.2}var $t=[w.create(),w.create(),w.create()],oo=w.create();class uo{constructor(t,r){r=Object.assign({},new ao,r),this.noa=t,this.sensitivityX=+r.sensitivityX,this.sensitivityY=+r.sensitivityY,this.inverseX=!!r.inverseX,this.inverseY=!!r.inverseY,this.sensitivityMult=r.sensitivityMult,this.sensitivityMultOutsidePointerlock=r.sensitivityMultOutsidePointerlock,this.heading=0,this.pitch=0,this.cameraTarget=this.noa.ents.createEntity(["position"]);var n=.9*t.ents.getPositionData(t.playerEntity).height;t.ents.addComponent(this.cameraTarget,"followsEntity",{entity:t.playerEntity,offset:[0,n,0]}),this.zoomDistance=r.initialZoom,this.zoomSpeed=r.zoomSpeed,this.currentZoom=r.initialZoom,this._dirVector=w.fromValues(0,0,1)}_localGetTargetPosition(){var t=this.noa.ents.getPositionData(this.cameraTarget),r=$t[0];return w.copy(r,t._renderPosition)}_localGetPosition(){var t=this._localGetTargetPosition();return this.currentZoom===0?t:w.scaleAndAdd(t,t,this._dirVector,-this.currentZoom)}getTargetPosition(){var t=this._localGetTargetPosition(),r=$t[1];return this.noa.localToGlobal(t,r)}getPosition(){var t=this._localGetPosition(),r=$t[2];return this.noa.localToGlobal(t,r)}getDirection(){return this._dirVector}applyInputsToCamera(){var t=this.sensitivityMult;if(this.noa.container.supportsPointerLock&&(this.noa.container.hasPointerLock||(t*=this.sensitivityMultOutsidePointerlock)),t!==0){var r=this.noa.inputs.pointerState;lo(r);var n=.0066*Math.PI/180,i=r.dx*this.sensitivityX*t*n,s=r.dy*this.sensitivityY*t*n;this.inverseX&&(i=-i),this.inverseY&&(s=-s);var a=2*Math.PI;this.heading+=i<0?i+a:i,this.heading>a&&(this.heading-=a);var o=Math.PI/2-.001;this.pitch=Math.max(-o,Math.min(o,this.pitch+s)),w.set(this._dirVector,0,0,1);var c=this._dirVector,u=oo;w.rotateX(c,c,u,this.pitch),w.rotateY(c,c,u,this.heading)}}updateBeforeEntityRenderSystems(){this.currentZoom+=(this.zoomDistance-this.currentZoom)*this.zoomSpeed}updateAfterEntityRenderSystems(){var t=co(this);this.currentZoom>t&&(this.currentZoom=t)}}function co(e){e._sweepBox||(e._sweepBox=new At([0,0,0],[.2,.2,.2]),e._sweepGetVoxel=e.noa.world.getBlockSolidity.bind(e.noa.world),e._sweepVec=w.create(),e._sweepHit=()=>!0);var t=w.copy(e._sweepVec,e._localGetTargetPosition());w.add(t,t,e.noa.worldOriginOffset);for(var r=0;r<3;r++)t[r]-=.1;e._sweepBox.setPosition(t);var n=Math.max(e.zoomDistance,e.currentZoom)+.1;return w.scale(e._sweepVec,e.getDirection(),-n),it(e._sweepGetVoxel,e._sweepBox,e._sweepVec,e._sweepHit,!0)}function lo(e){var t=e.dx,r=e.dy,n=Math.abs(t)>400&&Math.abs(t/Ye)>4,i=Math.abs(r)>400&&Math.abs(r/Ze)>4;n||i?(e.dx=Ye,e.dy=Ze,Ye=(Ye+t)/2,Ze=(Ze+r)/2):(Ye=t||1,Ze=r||1)}var Ye=0,Ze=0,fo=class{constructor(){this.list=[],this.hash={},this._map={},this._pendingRemovals=[]}add(t,r){if(typeof this._map[t]=="number"){var n=this._map[t];this.hash[t]=r,this.list[n]=r}else this._map[t]=this.list.length,this.hash[t]=r,this.list.push(r)}remove(t){var r=this._map[t];this.hash[t]=null,this.list[r]=null,this._pendingRemovals.push(t)}dispose(){this.list=null,this.hash=null,this._map=null,this._pendingRemovals.length=0}flush(){for(var t=0;t<this._pendingRemovals.length;t++){var r=this._pendingRemovals[t];this.hash[r]===null&&ho(this,r)}this._pendingRemovals.length=0}};function ho(e,t){var r=e._map[t];if(delete e.hash[t],delete e._map[t],r===e.list.length-1)e.list.pop();else{var n=e.list.pop();if(e.list[r]=n,n===null||n[0]===null){var i=e.list.length;for(var s in e._map)if(e._map[s]===i){e._map[s]=r;return}}else{var a=n.__id||n[0].__id;e._map[a]=r}}}var vo=mo,po=fo;/*!
 * ent-comp: a light, *fast* Entity Component System in JS
 * @url      github.com/fenomas/ent-comp
 * @author   Andy Hall <andy@fenomas.com>
 * @license  MIT
*/function mo(){var e=this;this.components={},this.comps=this.components;var t=this.components,r=1,n={},i=[],s=[],a={timeout:!1,removals:[],multiComps:[]};this._storage=n,this._systems=i,this._renderSystems=s,this.createEntity=function(f){var v=r++;return Array.isArray(f)&&f.forEach(h=>e.addComponent(v,h)),v},this.deleteEntity=function(f){return Object.keys(n).forEach(v=>{var h=n[v];h.hash[f]&&o(f,v)}),e},this.createComponent=function(f){if(!f)throw new Error("Missing component definition");var v=f.name;if(!v)throw new Error("Component definition must have a name property.");if(typeof v!="string")throw new Error("Component name must be a string.");if(v==="")throw new Error("Component name must be a non-empty string.");if(n[v])throw new Error(`Component ${v} already exists.`);var h={};return h.name=v,h.multi=!!f.multi,h.order=isNaN(f.order)?99:f.order,h.state=f.state||{},h.onAdd=f.onAdd||null,h.onRemove=f.onRemove||null,h.system=f.system||null,h.renderSystem=f.renderSystem||null,t[v]=h,n[v]=new po,n[v]._pendingMultiCleanup=!1,n[v]._multiCleanupIDs=h.multi?[]:null,h.system&&(i.push(v),i.sort((y,g)=>t[y].order-t[g].order)),h.renderSystem&&(s.push(v),s.sort((y,g)=>t[y].order-t[g].order)),v},this.overwriteComponent=function(f,v){var h=t[f];if(!h)throw new Error(`Unknown component: ${f}`);if(!v)throw new Error("Missing component definition");if(h.name!==v.name)throw new Error("Overwriting component must use the same name property.");var y={};y.name=f,y.multi=!!v.multi,y.order=isNaN(v.order)?99:v.order,y.state=v.state||{},y.onAdd=v.onAdd||null,y.onRemove=v.onRemove||null,y.system=v.system||null,y.renderSystem=v.renderSystem||null,t[f]=y,n[f]._pendingMultiCleanup=!1,n[f]._multiCleanupIDs=y.multi?[]:null;var g=i.indexOf(f);y.system&&g<0&&i.push(f),!y.system&&g>=0&&i.splice(g,1),i.sort((M,L)=>t[M].order-t[L].order);var _=s.indexOf(f);y.renderSystem&&_<0&&s.push(f),!y.renderSystem&&_>=0&&s.splice(_,1),s.sort((M,L)=>t[M].order-t[L].order);var k=y.state;return this.getStatesList(f).forEach(M=>{for(var L in k)L in M||(M[L]=k[L]);y.onAdd&&y.onAdd(M.__id,M)}),f},this.deleteComponent=function(f){var v=n[f];if(!v)throw new Error(`Unknown component: ${f}`);v.flush(),v.list.forEach(g=>{if(!!g){var _=g.__id||g[0].__id;o(_,f)}});var h=i.indexOf(f),y=s.indexOf(f);return h>-1&&i.splice(h,1),y>-1&&s.splice(y,1),n[f].dispose(),delete n[f],delete t[f],e},this.addComponent=function(f,v,h){var y=t[v],g=n[v];if(!g)throw new Error(`Unknown component: ${v}.`);if(g.hash[f]&&!y.multi)throw new Error(`Entity ${f} already has component: ${v}.`);var _=Object.assign({},{__id:f},y.state,h);if(_.__id=f,y.multi){var k=g.hash[f];k||(k=[],g.add(f,k)),k.push(_)}else g.add(f,_);return y.onAdd&&y.onAdd(f,_),this},this.hasComponent=function(f,v){var h=n[v];if(!h)throw new Error(`Unknown component: ${v}.`);return!!h.hash[f]},this.removeComponent=function(f,v){var h=n[v];if(!h)throw new Error(`Unknown component: ${v}.`);return o(f,v),e},this.getState=function(f,v){var h=n[v];if(!h)throw new Error(`Unknown component: ${v}.`);return h.hash[f]},this.getStatesList=function(f){var v=n[f];if(!v)throw new Error(`Unknown component: ${f}.`);return d(),v.list},this.getStateAccessor=function(f){if(!n[f])throw new Error(`Unknown component: ${f}.`);var v=n[f].hash;return h=>v[h]},this.getComponentAccessor=function(f){if(!n[f])throw new Error(`Unknown component: ${f}.`);var v=n[f].hash;return h=>!!v[h]},this.tick=function(f){d();for(var v=0;v<i.length;v++){var h=i[v],y=t[h],g=n[h];y.system(f,g.list),d()}return e},this.render=function(f){d();for(var v=0;v<s.length;v++){var h=s[v],y=t[h],g=n[h];y.renderSystem(f,g.list),d()}return e},this.removeMultiComponent=function(f,v,h){var y=t[v],g=n[v];if(!g)throw new Error(`Unknown component: ${v}.`);if(!y.multi)throw new Error("removeMultiComponent called on non-multi component");return c(f,y,g,h),e};function o(f,v){var h=t[v],y=n[v],g=y.hash[f];!g||(y.remove(f),h.onRemove&&(h.multi?(g.forEach(_=>{_&&h.onRemove(f,_)}),g.length=0):h.onRemove(f,g)),a.removals.push(y),u())}function c(f,v,h,y){var g=h.hash[f];if(!!g){var _=g[y];!_||(g[y]=null,v.onRemove&&v.onRemove(f,_),a.multiComps.push({entID:f,data:h}),u())}}function u(){a.timeout||(a.timeout=!0,setTimeout(l,1))}function l(){a.timeout=!1,d()}function d(){a.multiComps.length&&p(a.multiComps),a.removals.length&&m(a.removals)}function p(f){for(var v=0;v<f.length;v++){var{entID:h,data:y}=f[v],g=y.hash[h];if(!!g){for(var _=0;_<g.length;_++)g[_]||(g.splice(_,1),_--);g.length===0&&(y.remove(h),a.removals.push(y))}}f.length=0}function m(f){for(var v=0;v<f.length;v++){var h=f[v];h.flush()}f.length=0}}class go{constructor(){this.position=null,this.width=.8,this.height=.8,this._localPosition=null,this._renderPosition=null,this._extents=null}}function yo(e){return{name:"position",order:60,state:new go,onAdd:function(t,r){var n=[0,0,0];r.position&&w.copy(n,r.position),r.position=n,r._localPosition=w.create(),r._renderPosition=w.create(),r._extents=new Float32Array(6),e.globalToLocal(r.position,null,r._localPosition),w.copy(r._renderPosition,r._localPosition),nr(r)},onRemove:null,system:function(t,r){for(var n=e.worldOriginOffset,i=0;i<r.length;i++){var s=r[i];w.add(s.position,s._localPosition,n),nr(s)}}}}function nr(e){var t=e.width/2,r=e._localPosition,n=e._extents;n[0]=r[0]-t,n[1]=r[1],n[2]=r[2]-t,n[3]=r[0]+t,n[4]=r[1]+e.height,n[5]=r[2]+t}class _o{constructor(){this.body=null}}function ko(e){return{name:"physics",order:40,state:new _o,onAdd:function(t,r){r.body=e.physics.addBody();var n=e.ents.getPositionData(r.__id);Rn(r,n)},onRemove:function(t,r){if(e.ents.hasPosition(r.__id)){var n=e.ents.getPositionData(r.__id);Er(r,n),br(r,n,0,!1)}e.physics.removeBody(r.body)},system:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],s=e.ents.getPositionData(i.__id);Er(i,s)}},renderSystem:function(t,r){var n=e.positionInCurrentTick,i=1e3/e.container._shell.tickRate;i*=e.timeScale;for(var s=n*i,a=(s-i)/1e3,o=0;o<r.length;o++){var c=r[o],u=c.__id,l=e.ents.getPositionData(u),d=e.ents.cameraSmoothed(u);br(c,l,a,d)}}}}var ct=w.create();function Rn(e,t){var r=e.body.aabb,n=t._extents;w.copy(r.base,n),w.set(r.vec,t.width,t.height,t.width),w.add(r.max,r.base,r.vec)}function Er(e,t){var r=e.body.aabb.base,n=t.width/2;w.set(t._localPosition,r[0]+n,r[1],r[2]+n)}function br(e,t,r,n){var i=e.body.velocity;w.scaleAndAdd(ct,t._localPosition,i,r),n&&w.lerp(ct,t._renderPosition,ct,.3),w.copy(t._renderPosition,ct)}var B={},q={},or=32;q.INT_BITS=or;q.INT_MAX=2147483647;q.INT_MIN=-1<<or-1;q.sign=function(e){return(e>0)-(e<0)};q.abs=function(e){var t=e>>or-1;return(e^t)-t};q.min=function(e,t){return t^(e^t)&-(e<t)};q.max=function(e,t){return e^(e^t)&-(e<t)};q.isPow2=function(e){return!(e&e-1)&&!!e};q.log2=function(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,t|=r,t|e>>1};q.log10=function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0};q.popCount=function(e){return e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),(e+(e>>>4)&252645135)*16843009>>>24};function On(e){var t=32;return e&=-e,e&&t--,e&65535&&(t-=16),e&16711935&&(t-=8),e&252645135&&(t-=4),e&858993459&&(t-=2),e&1431655765&&(t-=1),t}q.countTrailingZeros=On;q.nextPow2=function(e){return e+=e===0,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+1};q.prevPow2=function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e-(e>>>1)};q.parity=function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,e&=15,27030>>>e&1};var Qe=new Array(256);(function(e){for(var t=0;t<256;++t){var r=t,n=t,i=7;for(r>>>=1;r;r>>>=1)n<<=1,n|=r&1,--i;e[t]=n<<i&255}})(Qe);q.reverse=function(e){return Qe[e&255]<<24|Qe[e>>>8&255]<<16|Qe[e>>>16&255]<<8|Qe[e>>>24&255]};q.interleave2=function(e,t){return e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t&=65535,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e|t<<1};q.deinterleave2=function(e,t){return e=e>>>t&1431655765,e=(e|e>>>1)&858993459,e=(e|e>>>2)&252645135,e=(e|e>>>4)&16711935,e=(e|e>>>16)&65535,e<<16>>16};q.interleave3=function(e,t,r){return e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,e|=t<<1,r&=1023,r=(r|r<<16)&4278190335,r=(r|r<<8)&251719695,r=(r|r<<4)&3272356035,r=(r|r<<2)&1227133513,e|r<<2};q.deinterleave3=function(e,t){return e=e>>>t&1227133513,e=(e|e>>>2)&3272356035,e=(e|e>>>4)&251719695,e=(e|e>>>8)&4278190335,e=(e|e>>>16)&1023,e<<22>>22};q.nextCombination=function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>On(e)+1};function Sn(e,t,r){var n=e[r]|0;if(n<=0)return[];var i=new Array(n),s;if(r===e.length-1)for(s=0;s<n;++s)i[s]=t;else for(s=0;s<n;++s)i[s]=Sn(e,t,r+1);return i}function Mo(e,t){var r,n;for(r=new Array(e),n=0;n<e;++n)r[n]=t;return r}function Co(e,t){switch(typeof t>"u"&&(t=0),typeof e){case"number":if(e>0)return Mo(e|0,t);break;case"object":if(typeof e.length=="number")return Sn(e,t,0);break}return[]}var wo=Co;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var Lo=function(t){return t!=null&&t.constructor!=null&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t)},Ve=q,te=wo,To=Lo;tr.__TYPEDARRAY_POOL||(tr.__TYPEDARRAY_POOL={UINT8:te([32,0]),UINT16:te([32,0]),UINT32:te([32,0]),INT8:te([32,0]),INT16:te([32,0]),INT32:te([32,0]),FLOAT:te([32,0]),DOUBLE:te([32,0]),DATA:te([32,0]),UINT8C:te([32,0]),BUFFER:te([32,0])});var Eo=typeof Uint8ClampedArray<"u",Z=tr.__TYPEDARRAY_POOL;Z.UINT8C||(Z.UINT8C=te([32,0]));Z.BUFFER||(Z.BUFFER=te([32,0]));var Rt=Z.DATA,ur=Z.BUFFER;B.free=function(t){if(To(t))ur[Ve.log2(t.length)].push(t);else{if(Object.prototype.toString.call(t)!=="[object ArrayBuffer]"&&(t=t.buffer),!t)return;var r=t.length||t.byteLength,n=Ve.log2(r)|0;Rt[n].push(t)}};function Dn(e){if(!!e){var t=e.length||e.byteLength,r=Ve.log2(t);Rt[r].push(e)}}function bo(e){Dn(e.buffer)}B.freeUint8=B.freeUint16=B.freeUint32=B.freeInt8=B.freeInt16=B.freeInt32=B.freeFloat32=B.freeFloat=B.freeFloat64=B.freeDouble=B.freeUint8Clamped=B.freeDataView=bo;B.freeArrayBuffer=Dn;B.freeBuffer=function(t){ur[Ve.log2(t.length)].push(t)};B.malloc=function(t,r){if(r===void 0||r==="arraybuffer")return ne(t);switch(r){case"uint8":return cr(t);case"uint16":return Bn(t);case"uint32":return Un(t);case"int8":return $n(t);case"int16":return zn(t);case"int32":return qn(t);case"float":case"float32":return Nn(t);case"double":case"float64":return Hn(t);case"uint8_clamped":return Vn(t);case"buffer":throw"Buffer not supported";case"data":case"dataview":return jn(t);default:return null}return null};function ne(t){var t=Ve.nextPow2(t),r=Ve.log2(t),n=Rt[r];return n.length>0?n.pop():new ArrayBuffer(t)}B.mallocArrayBuffer=ne;function cr(e){return new Uint8Array(ne(e),0,e)}B.mallocUint8=cr;function Bn(e){return new Uint16Array(ne(2*e),0,e)}B.mallocUint16=Bn;function Un(e){return new Uint32Array(ne(4*e),0,e)}B.mallocUint32=Un;function $n(e){return new Int8Array(ne(e),0,e)}B.mallocInt8=$n;function zn(e){return new Int16Array(ne(2*e),0,e)}B.mallocInt16=zn;function qn(e){return new Int32Array(ne(4*e),0,e)}B.mallocInt32=qn;function Nn(e){return new Float32Array(ne(4*e),0,e)}B.mallocFloat32=B.mallocFloat=Nn;function Hn(e){return new Float64Array(ne(8*e),0,e)}B.mallocFloat64=B.mallocDouble=Hn;function Vn(e){return Eo?new Uint8ClampedArray(ne(e),0,e):cr(e)}B.mallocUint8Clamped=Vn;function jn(e){return new DataView(ne(e),0,e)}B.mallocDataView=jn;B.clearCache=function(){for(var t=0;t<32;++t)Z.UINT8[t].length=0,Z.UINT16[t].length=0,Z.UINT32[t].length=0,Z.INT8[t].length=0,Z.INT16[t].length=0,Z.INT32[t].length=0,Z.FLOAT[t].length=0,Z.DOUBLE[t].length=0,Z.UINT8C[t].length=0,Rt[t].length=0,ur[t].length=0};var xo=Fo,yt=32;function Fo(e,t){t<=4*yt?_t(0,t-1,e):kt(0,t-1,e)}function _t(e,t,r){for(var n=2*(e+1),i=e+1;i<=t;++i){for(var s=r[n++],a=r[n++],o=i,c=n-2;o-- >e;){var u=r[c-2],l=r[c-1];if(u<s)break;if(u===s&&l<a)break;r[c]=u,r[c+1]=l,c-=2}r[c]=s,r[c+1]=a}}function xr(e,t,r){e*=2,t*=2;var n=r[e],i=r[e+1];r[e]=r[t],r[e+1]=r[t+1],r[t]=n,r[t+1]=i}function Fr(e,t,r){e*=2,t*=2,r[e]=r[t],r[e+1]=r[t+1]}function Po(e,t,r,n){e*=2,t*=2,r*=2;var i=n[e],s=n[e+1];n[e]=n[t],n[e+1]=n[t+1],n[t]=n[r],n[t+1]=n[r+1],n[r]=i,n[r+1]=s}function Pr(e,t,r,n,i){e*=2,t*=2,i[e]=i[t],i[t]=r,i[e+1]=i[t+1],i[t+1]=n}function pe(e,t,r){e*=2,t*=2;var n=r[e],i=r[t];return n<i?!1:n===i?r[e+1]>r[t+1]:!0}function lt(e,t,r,n){e*=2;var i=n[e];return i<t?!0:i===t?n[e+1]<r:!1}function kt(e,t,r){var n=(t-e+1)/6|0,i=e+n,s=t-n,a=e+t>>1,o=a-n,c=a+n,u=i,l=o,d=a,p=c,m=s,f=e+1,v=t-1,h=0;pe(u,l,r)&&(h=u,u=l,l=h),pe(p,m,r)&&(h=p,p=m,m=h),pe(u,d,r)&&(h=u,u=d,d=h),pe(l,d,r)&&(h=l,l=d,d=h),pe(u,p,r)&&(h=u,u=p,p=h),pe(d,p,r)&&(h=d,d=p,p=h),pe(l,m,r)&&(h=l,l=m,m=h),pe(l,d,r)&&(h=l,l=d,d=h),pe(p,m,r)&&(h=p,p=m,m=h);for(var y=r[2*l],g=r[2*l+1],_=r[2*p],k=r[2*p+1],M=2*u,L=2*d,b=2*m,T=2*i,x=2*a,C=2*s,E=0;E<2;++E){var A=r[M+E],S=r[L+E],F=r[b+E];r[T+E]=A,r[x+E]=S,r[C+E]=F}Fr(o,e,r),Fr(c,t,r);for(var P=f;P<=v;++P)if(lt(P,y,g,r))P!==f&&xr(P,f,r),++f;else if(!lt(P,_,k,r))for(;;)if(lt(v,_,k,r)){lt(v,y,g,r)?(Po(P,f,v,r),++f,--v):(xr(P,v,r),--v);break}else{if(--v<P)break;continue}Pr(e,f-1,y,g,r),Pr(t,v+1,_,k,r),f-2-e<=yt?_t(e,f-2,r):kt(e,f-2,r),t-(v+2)<=yt?_t(v+2,t,r):kt(v+2,t,r),v-f<=yt?_t(f,v,r):kt(f,v,r)}var Gn={init:Ao,sweepBipartite:Ro,sweepComplete:Oo,scanBipartite:So,scanComplete:Do},N=B,Io=q,Ot=xo,re=1<<28,Pe=1024,K=N.mallocInt32(Pe),ye=N.mallocInt32(Pe),_e=N.mallocInt32(Pe),xe=N.mallocInt32(Pe),ze=N.mallocInt32(Pe),tt=N.mallocInt32(Pe),O=N.mallocDouble(Pe*8);function Ao(e){var t=Io.nextPow2(e);K.length<t&&(N.free(K),K=N.mallocInt32(t)),ye.length<t&&(N.free(ye),ye=N.mallocInt32(t)),_e.length<t&&(N.free(_e),_e=N.mallocInt32(t)),xe.length<t&&(N.free(xe),xe=N.mallocInt32(t)),ze.length<t&&(N.free(ze),ze=N.mallocInt32(t)),tt.length<t&&(N.free(tt),tt=N.mallocInt32(t));var r=8*t;O.length<r&&(N.free(O),O=N.mallocDouble(r))}function qe(e,t,r,n){var i=t[n],s=e[r-1];e[i]=s,t[s]=i}function Ne(e,t,r,n){e[r]=n,t[n]=r}function Ro(e,t,r,n,i,s,a,o,c,u){for(var l=0,d=2*e,p=e-1,m=d-1,f=r;f<n;++f){var v=s[f],h=d*f;O[l++]=i[h+p],O[l++]=-(v+1),O[l++]=i[h+m],O[l++]=v}for(var f=a;f<o;++f){var v=u[f]+re,y=d*f;O[l++]=c[y+p],O[l++]=-v,O[l++]=c[y+m],O[l++]=v}var g=l>>>1;Ot(O,g);for(var _=0,k=0,f=0;f<g;++f){var M=O[2*f+1]|0;if(M>=re)M=M-re|0,qe(_e,xe,k--,M);else if(M>=0)qe(K,ye,_--,M);else if(M<=-re){M=-M-re|0;for(var L=0;L<_;++L){var b=t(K[L],M);if(b!==void 0)return b}Ne(_e,xe,k++,M)}else{M=-M-1|0;for(var L=0;L<k;++L){var b=t(M,_e[L]);if(b!==void 0)return b}Ne(K,ye,_++,M)}}}function Oo(e,t,r,n,i,s,a,o,c,u){for(var l=0,d=2*e,p=e-1,m=d-1,f=r;f<n;++f){var v=s[f]+1<<1,h=d*f;O[l++]=i[h+p],O[l++]=-v,O[l++]=i[h+m],O[l++]=v}for(var f=a;f<o;++f){var v=u[f]+1<<1,y=d*f;O[l++]=c[y+p],O[l++]=-v|1,O[l++]=c[y+m],O[l++]=v|1}var g=l>>>1;Ot(O,g);for(var _=0,k=0,M=0,f=0;f<g;++f){var L=O[2*f+1]|0,b=L&1;if(f<g-1&&L>>1===O[2*f+3]>>1&&(b=2,f+=1),L<0){for(var T=-(L>>1)-1,x=0;x<M;++x){var C=t(ze[x],T);if(C!==void 0)return C}if(b!==0)for(var x=0;x<_;++x){var C=t(K[x],T);if(C!==void 0)return C}if(b!==1)for(var x=0;x<k;++x){var C=t(_e[x],T);if(C!==void 0)return C}b===0?Ne(K,ye,_++,T):b===1?Ne(_e,xe,k++,T):b===2&&Ne(ze,tt,M++,T)}else{var T=(L>>1)-1;b===0?qe(K,ye,_--,T):b===1?qe(_e,xe,k--,T):b===2&&qe(ze,tt,M--,T)}}}function So(e,t,r,n,i,s,a,o,c,u,l,d){var p=0,m=2*e,f=t,v=t+e,h=1,y=1;n?y=re:h=re;for(var g=i;g<s;++g){var _=g+h,k=m*g;O[p++]=a[k+f],O[p++]=-_,O[p++]=a[k+v],O[p++]=_}for(var g=c;g<u;++g){var _=g+y,M=m*g;O[p++]=l[M+f],O[p++]=-_}var L=p>>>1;Ot(O,L);for(var b=0,g=0;g<L;++g){var T=O[2*g+1]|0;if(T<0){var _=-T,x=!1;if(_>=re?(x=!n,_-=re):(x=!!n,_-=1),x)Ne(K,ye,b++,_);else{var C=d[_],E=m*_,A=l[E+t+1],S=l[E+t+1+e];e:for(var F=0;F<b;++F){var P=K[F],U=m*P;if(!(S<a[U+t+1]||a[U+t+1+e]<A)){for(var R=t+2;R<e;++R)if(l[E+R+e]<a[U+R]||a[U+R+e]<l[E+R])continue e;var I=o[P],D;if(n?D=r(C,I):D=r(I,C),D!==void 0)return D}}}}else qe(K,ye,b--,T-h)}}function Do(e,t,r,n,i,s,a,o,c,u,l){for(var d=0,p=2*e,m=t,f=t+e,v=n;v<i;++v){var h=v+re,y=p*v;O[d++]=s[y+m],O[d++]=-h,O[d++]=s[y+f],O[d++]=h}for(var v=o;v<c;++v){var h=v+1,g=p*v;O[d++]=u[g+m],O[d++]=-h}var _=d>>>1;Ot(O,_);for(var k=0,v=0;v<_;++v){var M=O[2*v+1]|0;if(M<0){var h=-M;if(h>=re)K[k++]=h-re;else{h-=1;var L=l[h],b=p*h,T=u[b+t+1],x=u[b+t+1+e];e:for(var C=0;C<k;++C){var E=K[C],A=a[E];if(A===L)break;var S=p*E;if(!(x<s[S+t+1]||s[S+t+1+e]<T)){for(var F=t+2;F<e;++F)if(u[b+F+e]<s[S+F]||s[S+F+e]<u[b+F])continue e;var P=r(A,L);if(P!==void 0)return P}}}}else{for(var h=M-re,C=k-1;C>=0;--C)if(K[C]===h){for(var F=C+1;F<k;++F)K[F-1]=K[F];break}--k}}}var lr={},be="d",De="ax",Kn="vv",zt="fp",Xe="es",Lt="rs",fr="re",Je="rb",Wn="ri",Re="rp",Tt="bs",hr="be",et="bb",Yn="bi",Oe="bp",qt="rv",Nt="Q",ir=[be,De,Kn,Lt,fr,Je,Wn,Tt,hr,et,Yn];function Bo(e,t,r){var n="bruteForce"+(e?"Red":"Blue")+(t?"Flip":"")+(r?"Full":""),i=["function ",n,"(",ir.join(),"){","var ",Xe,"=2*",be,";"],s="for(var i="+Lt+","+Re+"="+Xe+"*"+Lt+";i<"+fr+";++i,"+Re+"+="+Xe+"){var x0="+Je+"["+De+"+"+Re+"],x1="+Je+"["+De+"+"+Re+"+"+be+"],xi="+Wn+"[i];",a="for(var j="+Tt+","+Oe+"="+Xe+"*"+Tt+";j<"+hr+";++j,"+Oe+"+="+Xe+"){var y0="+et+"["+De+"+"+Oe+"],"+(r?"y1="+et+"["+De+"+"+Oe+"+"+be+"],":"")+"yi="+Yn+"[j];";return e?i.push(s,Nt,":",a):i.push(a,Nt,":",s),r?i.push("if(y1<x0||x1<y0)continue;"):t?i.push("if(y0<=x0||x1<y0)continue;"):i.push("if(y0<x0||x1<y0)continue;"),i.push("for(var k="+De+"+1;k<"+be+";++k){var r0="+Je+"[k+"+Re+"],r1="+Je+"[k+"+be+"+"+Re+"],b0="+et+"[k+"+Oe+"],b1="+et+"[k+"+be+"+"+Oe+"];if(r1<b0||b1<r0)continue "+Nt+";}var "+qt+"="+Kn+"("),t?i.push("yi,xi"):i.push("xi,yi"),i.push(");if("+qt+"!==void 0)return "+qt+";}}}"),{name:n,code:i.join("")}}function Zn(e){var t="bruteForce"+(e?"Full":"Partial"),r=[],n=ir.slice();e||n.splice(3,0,zt);var i=["function "+t+"("+n.join()+"){"];function s(c,u){var l=Bo(c,u,e);r.push(l.code),i.push("return "+l.name+"("+ir.join()+");")}i.push("if("+fr+"-"+Lt+">"+hr+"-"+Tt+"){"),e?(s(!0,!1),i.push("}else{"),s(!1,!1)):(i.push("if("+zt+"){"),s(!0,!0),i.push("}else{"),s(!0,!1),i.push("}}else{if("+zt+"){"),s(!1,!0),i.push("}else{"),s(!1,!1),i.push("}")),i.push("}}return "+t);var a=r.join("")+i.join(""),o=new Function(a);return o()}lr.partial=Zn(!1);lr.full=Zn(!0);var Xn=$o,Uo="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function $o(e,t){var r="abcdef".split("").concat(t),n=[];return e.indexOf("lo")>=0&&n.push("lo=e[k+n]"),e.indexOf("hi")>=0&&n.push("hi=e[k+o]"),r.push(Uo.replace("_",n.join()).replace("$",e)),Function.apply(void 0,r)}var zo=Vo,qo=Xn,Ir=qo("lo<p0",["p0"]),No=8;function Ho(e,t,r,n,i,s){for(var a=2*e,o=a*(r+1)+t,c=r+1;c<n;++c,o+=a)for(var u=i[o],l=c,d=a*(c-1);l>r&&i[d+t]>u;--l,d-=a){for(var p=d,m=d+a,f=0;f<a;++f,++p,++m){var v=i[p];i[p]=i[m],i[m]=v}var h=s[l];s[l]=s[l-1],s[l-1]=h}}function Vo(e,t,r,n,i,s){if(n<=r+1)return r;for(var a=r,o=n,c=n+r>>>1,u=2*e,l=c,d=i[u*c+t];a<o;){if(o-a<No){Ho(e,t,a,o,i,s),d=i[u*c+t];break}var p=o-a,m=Math.random()*p+a|0,f=i[u*m+t],v=Math.random()*p+a|0,h=i[u*v+t],y=Math.random()*p+a|0,g=i[u*y+t];f<=h?g>=h?(l=v,d=h):f>=g?(l=m,d=f):(l=y,d=g):h>=g?(l=v,d=h):g>=f?(l=m,d=f):(l=y,d=g);for(var M=u*(o-1),L=u*l,_=0;_<u;++_,++M,++L){var k=i[M];i[M]=i[L],i[L]=k}var b=s[o-1];s[o-1]=s[l],s[l]=b,l=Ir(e,t,a,o-1,i,s,d);for(var M=u*(o-1),L=u*l,_=0;_<u;++_,++M,++L){var k=i[M];i[M]=i[L],i[L]=k}var b=s[o-1];if(s[o-1]=s[l],s[l]=b,c<l){for(o=l-1;a<o&&i[u*(o-1)+t]===d;)o-=1;o+=1}else if(l<c)for(a=l+1;a<o&&i[u*a+t]===d;)a+=1;else break}return Ir(e,t,r,c,i,s,i[u*c+t])}var jo=iu,Be=B,Ht=q,Qn=lr,Go=Qn.partial,Ko=Qn.full,Me=Gn,Wo=zo,Ge=Xn,Ar=128,Yo=1<<22,Zo=1<<22,Xo=Ge("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),Rr=Ge("lo===p0",["p0"]),Qo=Ge("lo<p0",["p0"]),Jo=Ge("hi<=p0",["p0"]),Or=Ge("lo<=p0&&p0<=hi",["p0"]),eu=Ge("lo<p0&&p0<=hi",["p0"]),vr=6,dr=2,Jn=1024,X=Be.mallocInt32(Jn),Fe=Be.mallocDouble(Jn);function tu(e,t){var r=8*Ht.log2(t+1)*(e+1)|0,n=Ht.nextPow2(vr*r);X.length<n&&(Be.free(X),X=Be.mallocInt32(n));var i=Ht.nextPow2(dr*r);Fe.length<i&&(Be.free(Fe),Fe=Be.mallocDouble(i))}function ae(e,t,r,n,i,s,a,o,c){var u=vr*e;X[u]=t,X[u+1]=r,X[u+2]=n,X[u+3]=i,X[u+4]=s,X[u+5]=a;var l=dr*e;Fe[l]=o,Fe[l+1]=c}function ru(e,t,r,n,i,s,a,o,c,u,l){var d=2*e,p=c*d,m=u[p+t];e:for(var f=i,v=i*d;f<s;++f,v+=d){var h=a[v+t],y=a[v+t+e];if(!(m<h||y<m)&&!(n&&m===h)){for(var g=o[f],_=t+1;_<e;++_){var h=a[v+_],y=a[v+_+e],k=u[p+_],M=u[p+_+e];if(y<k||M<h)continue e}var L;if(n?L=r(l,g):L=r(g,l),L!==void 0)return L}}}function nu(e,t,r,n,i,s,a,o,c,u){var l=2*e,d=o*l,p=c[d+t];e:for(var m=n,f=n*l;m<i;++m,f+=l){var v=a[m];if(v!==u){var h=s[f+t],y=s[f+t+e];if(!(p<h||y<p)){for(var g=t+1;g<e;++g){var h=s[f+g],y=s[f+g+e],_=c[d+g],k=c[d+g+e];if(y<_||k<h)continue e}var M=r(v,u);if(M!==void 0)return M}}}}function iu(e,t,r,n,i,s,a,o,c){tu(e,n+a);var u=0,l=2*e,d;for(ae(u++,0,0,n,0,a,r?16:0,-1/0,1/0),r||ae(u++,0,0,a,0,n,1,-1/0,1/0);u>0;){u-=1;var p=u*vr,m=X[p],f=X[p+1],v=X[p+2],h=X[p+3],y=X[p+4],g=X[p+5],_=u*dr,k=Fe[_],M=Fe[_+1],L=g&1,b=!!(g&16),T=i,x=s,C=o,E=c;if(L&&(T=o,x=c,C=i,E=s),!(g&2&&(v=Qo(e,m,f,v,T,x,M),f>=v))&&!(g&4&&(f=Jo(e,m,f,v,T,x,k),f>=v))){var A=v-f,S=y-h;if(b){if(e*A*(A+S)<Zo){if(d=Me.scanComplete(e,m,t,f,v,T,x,h,y,C,E),d!==void 0)return d;continue}}else if(e*Math.min(A,S)<Ar){if(d=Go(e,m,t,L,f,v,T,x,h,y,C,E),d!==void 0)return d;continue}else if(e*A*S<Yo){if(d=Me.scanBipartite(e,m,t,L,f,v,T,x,h,y,C,E),d!==void 0)return d;continue}var F=Xo(e,m,f,v,T,x,k,M);if(f<F)if(e*(F-f)<Ar){if(d=Ko(e,m+1,t,f,F,T,x,h,y,C,E),d!==void 0)return d}else if(m===e-2){if(L?d=Me.sweepBipartite(e,t,h,y,C,E,f,F,T,x):d=Me.sweepBipartite(e,t,f,F,T,x,h,y,C,E),d!==void 0)return d}else ae(u++,m+1,f,F,h,y,L,-1/0,1/0),ae(u++,m+1,h,y,f,F,L^1,-1/0,1/0);if(F<v){var P=Wo(e,m,h,y,C,E),U=C[l*P+m],R=Rr(e,m,P,y,C,E,U);if(R<y&&ae(u++,m,F,v,R,y,(L|4)+(b?16:0),U,M),h<P&&ae(u++,m,F,v,h,P,(L|2)+(b?16:0),k,U),P+1===R){if(b?d=nu(e,m,t,F,v,T,x,P,C,E[P]):d=ru(e,m,t,L,F,v,T,x,P,C,E[P]),d!==void 0)return d}else if(P<R){var I;if(b){if(I=Or(e,m,F,v,T,x,U),F<I){var D=Rr(e,m,F,I,T,x,U);if(m===e-2){if(F<D&&(d=Me.sweepComplete(e,t,F,D,T,x,P,R,C,E),d!==void 0)||D<I&&(d=Me.sweepBipartite(e,t,D,I,T,x,P,R,C,E),d!==void 0))return d}else F<D&&ae(u++,m+1,F,D,P,R,16,-1/0,1/0),D<I&&(ae(u++,m+1,D,I,P,R,0,-1/0,1/0),ae(u++,m+1,P,R,D,I,1,-1/0,1/0))}}else L?I=eu(e,m,F,v,T,x,U):I=Or(e,m,F,v,T,x,U),F<I&&(m===e-2?L?d=Me.sweepBipartite(e,t,P,R,C,E,F,I,T,x):d=Me.sweepBipartite(e,t,F,I,T,x,P,R,C,E):(ae(u++,m+1,F,I,P,R,L,-1/0,1/0),ae(u++,m+1,P,R,F,I,L^1,-1/0,1/0)))}}}}}var su=lu,Ce=B,ft=Gn,au=jo;function ou(e,t){for(var r=0;r<e;++r)if(!(t[r]<=t[r+e]))return!0;return!1}function Sr(e,t,r,n){for(var i=0,s=0,a=0,o=e.length;a<o;++a){var c=e[a];if(!ou(t,c)){for(var u=0;u<2*t;++u)r[i++]=c[u];n[s++]=a}}return s}function Et(e,t,r,n){var i=e.length,s=t.length;if(!(i<=0||s<=0)){var a=e[0].length>>>1;if(!(a<=0)){var o,c=Ce.mallocDouble(2*a*i),u=Ce.mallocInt32(i);if(i=Sr(e,a,c,u),i>0){if(a===1&&n)ft.init(i),o=ft.sweepComplete(a,r,0,i,c,u,0,i,c,u);else{var l=Ce.mallocDouble(2*a*s),d=Ce.mallocInt32(s);s=Sr(t,a,l,d),s>0&&(ft.init(i+s),a===1?o=ft.sweepBipartite(a,r,0,i,c,u,0,s,l,d):o=au(a,r,n,i,c,u,s,l,d),Ce.free(l),Ce.free(d))}Ce.free(c),Ce.free(u)}return o}}}var st;function ei(e,t){st.push([e,t])}function uu(e){return st=[],Et(e,e,ei,!0),st}function cu(e,t){return st=[],Et(e,t,ei,!1),st}function lu(e,t,r){switch(arguments.length){case 1:return uu(e);case 2:return typeof t=="function"?Et(e,e,t,!0):cu(e,t);case 3:return Et(e,t,r,!1);default:throw new Error("box-intersect: Invalid arguments")}}function fu(e){var t=[];return{name:"collideEntities",order:70,state:{cylinder:!1,collideBits:1,collideMask:1,callback:null},onAdd:null,onRemove:null,system:function(c,u){for(var l=e.ents,d=0;d<u.length;d++){var p=u[d].__id,m=l.getPositionData(p);t[d]=m._extents}t.length=u.length,su(t,function(f,v){var h=u[f],y=u[v];if(!(!h||!y)){var g=t[f],_=t[v];n(h,y,g,_)&&r(e,h,y)}})}};function r(o,c,u){var l=c.__id,d=u.__id;c.collideMask&u.collideBits&&c.callback&&c.callback(d),u.collideMask&c.collideBits&&u.callback&&u.callback(l),o.ents.onPairwiseEntityCollision(l,d)}function n(o,c,u,l){return o.cylinder?c.cylinder?i(u,l):s(u,l):c.cylinder?s(l,u):!0}function i(o,c){var u=(o[3]-o[0])/2,l=(c[3]-c[0])/2,d=o[0]+u-(c[0]+l),p=o[2]+u-(c[2]+l),m=d*d+p*p,f=u+l;return m<=f*f}function s(o,c){var u=(o[3]-o[0])/2,l=o[0]+u,d=o[2]+u,p=a(l,c[0],c[3]),m=a(d,c[2],c[5]),f=p-l,v=m-d,h=f*f+v*v;return h<=u*u}function a(o,c,u){return o<c?c:o>u?u:o}}function hu(e){return{name:"collideTerrain",order:0,state:{callback:null},onAdd:function(t,r){var n=e.entities;if(n.hasPhysics(t)){var i=n.getPhysics(t).body;i.onCollide=function(a){var o=e.ents.getCollideTerrain(t).callback;o&&o(a,t)}}},onRemove:function(t,r){var n=e.entities;n.hasPhysics(t)&&(n.getPhysics(t).body.onCollide=null)}}}function vu(e){return{name:"fadeOnZoom",order:99,state:{cutoff:1.5},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.camera.currentZoom,s=e.entities,a=0;a<n.length;a++)du(n[a],i,s)}}}function du(e,t,r){if(!!r.hasMesh(e.__id)){var n=t>e.cutoff;r.getMeshData(e.__id).mesh.setEnabled(n)}}function pu(e){return{name:"followsEntity",order:50,state:{entity:0,offset:null,onTargetMissing:null},onAdd:function(n,i){var s=w.create();i.offset=i.offset?w.copy(s,i.offset):s,t(i),r(i)},onRemove:null,system:function(i,s){for(var a=0;a<s.length;a++)t(s[a])},renderSystem:function(i,s){for(var a=0;a<s.length;a++)r(s[a])}};function t(n){var i=n.__id,s=e.ents.getPositionData(i),a=e.ents.getPositionData(n.entity);a?w.add(s._localPosition,a._localPosition,n.offset):(n.onTargetMissing&&n.onTargetMissing(i),e.ents.removeComponent(i,e.ents.names.followsEntity))}function r(n){var i=n.__id,s=e.ents.getPositionData(i),a=e.ents.getPositionData(n.entity);a&&w.add(s._renderPosition,a._renderPosition,n.offset)}}function mu(e){return{name:"mesh",order:100,state:{mesh:null,offset:null},onAdd:function(t,r){var n=e.ents.getPositionData(t);if(r.mesh)e.rendering.addMeshToScene(r.mesh,!1,n.position);else throw new Error("Mesh component added without a mesh - probably a bug!");r.offset||(r.offset=w.create());var i=n._renderPosition;r.mesh.position.copyFromFloats(i[0]+r.offset[0],i[1]+r.offset[1],i[2]+r.offset[2])},onRemove:function(t,r){r.mesh.dispose()},renderSystem:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],s=i.__id,a=e.ents.getPositionData(s)._renderPosition;i.mesh.position.copyFromFloats(a[0]+i.offset[0],a[1]+i.offset[1],a[2]+i.offset[2])}}}}function gu(){this.heading=0,this.running=!1,this.jumping=!1,this.maxSpeed=10,this.moveForce=30,this.responsiveness=15,this.runningFriction=0,this.standingFriction=2,this.airMoveMult=.5,this.jumpImpulse=10,this.jumpForce=12,this.jumpTime=500,this.airJumps=1,this._jumpCount=0,this._currjumptime=0,this._isJumping=!1}function yu(e){return{name:"movement",order:30,state:new gu,onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,s=0;s<n.length;s++){var a=n[s],o=i.getPhysics(a.__id);o&&Cu(r,a,o.body)}}}}var _u=w.create(),ku=w.create(),Mu=w.create();function Cu(e,t,r){var n=r.atRestY()<0,i=n||t._jumpCount<t.airJumps;if(n&&(t._isJumping=!1,t._jumpCount=0),t.jumping)if(t._isJumping){if(t._currjumptime>0){var s=t.jumpForce;t._currjumptime<e&&(s*=t._currjumptime/e),r.applyForce([0,s,0]),t._currjumptime-=e}}else i&&(t._isJumping=!0,n||t._jumpCount++,t._currjumptime=t.jumpTime,r.applyImpulse([0,t.jumpImpulse,0]),!n&&r.velocity[1]<0&&(r.velocity[1]=0));else t._isJumping=!1;var a=_u,o=ku;if(t.running){var c=t.maxSpeed;w.set(a,0,0,c),w.rotateY(a,a,Mu,t.heading),w.subtract(o,a,r.velocity),o[1]=0;var u=w.length(o);if(w.normalize(o,o),u>0){var l=t.moveForce;n||(l*=t.airMoveMult);var d=t.responsiveness*u;l>d&&(l=d),w.scale(o,o,l),r.applyForce(o)}r.friction=t.runningFriction}else r.friction=t.standingFriction}function wu(e){return{name:"receivesInputs",order:20,state:{},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,s=e.inputs.state,a=e.camera.heading,o=0;o<n.length;o++){var c=n[o],u=i.getMovement(c.__id);Lu(u,s,a)}}}}function Lu(e,t,r){e.jumping=!!t.jump;var n=t.forward?t.backward?0:1:t.backward?-1:0,i=t.right?t.left?0:1:t.left?-1:0;(n|i)===0?e.running=!1:(e.running=!0,n?(n==-1&&(r+=Math.PI),i&&(r+=Math.PI/4*n*i)):r+=i*Math.PI/2,e.heading=r)}function Tu(e,t){var r=t,n=e.rendering.getScene(),i=vi("shadow",{radius:.75,tessellation:30},n);i.rotation.x=Math.PI/2;var s=e.rendering.makeStandardMaterial("shadowMat");return s.diffuseColor=rt.Black(),s.ambientColor=rt.Black(),s.alpha=.5,i.material=s,i.setEnabled(!1),s.freeze(),n.removeMesh(i),{name:"shadow",order:80,state:{size:.5,_mesh:null},onAdd:function(a,o){var c=i.createInstance("shadow_instance");e.rendering.addMeshToScene(c),c.setEnabled(!1),o._mesh=c},onRemove:function(a,o){o._mesh.dispose()},system:function(o,c){for(var u=e.camera._localGetPosition(),l=r,d=0;d<c.length;d++){var p=c[d],m=e.ents.getPositionData(p.__id),f=e.ents.getPhysics(p.__id);bu(e,m,f,p._mesh,p.size,l,u)}},renderSystem:function(a,o){for(var c=0;c<o.length;c++){var u=o[c],l=e.ents.getPositionData(u.__id)._renderPosition,d=u._mesh.position;d.x=l[0],d.z=l[2]}}}}var Vt=w.fromValues(0,0,0),Eu=w.fromValues(0,-1,0);function bu(e,t,r,n,i,s,a){var o;if(r&&r.body.resting[1]<0)o=t._localPosition[1];else{var c=e._localPick(t._localPosition,Eu,s);if(!c){n.setEnabled(!1);return}o=c.position[1]-e.worldOriginOffset[1]}o=Math.round(o),w.copy(Vt,t._localPosition),Vt[1]=o;var u=w.squaredDistance(a,Vt),l=.01+.1*(u/1600);l>.1&&(l=.1),n.position.y=o+l;var d=t._localPosition[1]-o,p=i*.7*(1-d/s);n.scaling.copyFromFloats(p,p,p),n.setEnabled(!0)}function xu(e){var t="smoothCamera";return{name:t,order:99,state:{time:100.1},onAdd:null,onRemove:null,system:function(r,n){for(var i=0;i<n.length;i++){var s=n[i];s.time-=r,s.time<0&&e.ents.removeComponent(s.__id,t)}}}}var Fu={shadowDistance:10};class Pu extends vo{constructor(t,r){super(),r=Object.assign({},Fu,r);var n={shadow:r.shadowDistance};this.noa=t,this.names={};var i={collideEntities:fu,collideTerrain:hu,fadeOnZoom:vu,followsEntity:pu,mesh:mu,movement:yu,physics:ko,position:yo,receivesInputs:wu,shadow:Tu,smoothCamera:xu};Object.keys(i).forEach(s=>{var a=n[s]||void 0,o=i[s],c=o(t,a);this.names[s]=this.createComponent(c)}),this.cameraSmoothed=this.getComponentAccessor(this.names.smoothCamera),this.hasPhysics=this.getComponentAccessor(this.names.physics),this.hasPosition=this.getComponentAccessor(this.names.position),this.getPositionData=this.getStateAccessor(this.names.position),this.getPosition=s=>{var a=this.getPositionData(s);return a?a.position:null},this.getPhysics=this.getStateAccessor(this.names.physics),this.getPhysicsBody=s=>{var a=this.getPhysics(s);return a?a.body:null},this.hasMesh=this.getComponentAccessor(this.names.mesh),this.getMeshData=this.getStateAccessor(this.names.mesh),this.getMovement=this.getStateAccessor(this.names.movement),this.getCollideTerrain=this.getStateAccessor(this.names.collideTerrain),this.getCollideEntities=this.getStateAccessor(this.names.collideEntities),this.onPairwiseEntityCollision=function(s,a){}}setPosition(t,r,n=0,i=0){typeof r=="number"&&(r=[r,n,i]);var s=this.noa.globalToLocal(r,null,[]);this._localSetPosition(t,s)}setEntitySize(t,r,n,i){var s=this.getPositionData(t);s.width=(r+i)/2,s.height=n,this._updateDerivedPositionData(t,s)}_rebaseOrigin(t){for(var r of this.getStatesList(this.names.position)){var n=r._localPosition,i=r.width/2;jt(n,0,-i,i,r.__id),jt(n,1,0,r.height,r.__id),jt(n,2,-i,i,r.__id),w.subtract(n,n,t),this._updateDerivedPositionData(r.__id,r)}}_localGetPosition(t){return this.getPositionData(t)._localPosition}_localSetPosition(t,r){var n=this.getPositionData(t);w.copy(n._localPosition,r),this._updateDerivedPositionData(t,n)}_updateDerivedPositionData(t,r){w.copy(r._renderPosition,r._localPosition);var n=this.noa.worldOriginOffset;w.add(r.position,r._localPosition,n),nr(r);var i=this.getPhysics(t);i&&Rn(i,r)}addComponentAgain(t,r,n){this.hasComponent(t,r)&&this.removeComponent(t,r),this.addComponent(t,r,n)}isTerrainBlocked(t,r,n){for(var i=this.noa.worldOriginOffset,s=Math.floor(t-i[0]),a=Math.floor(r-i[1]),o=Math.floor(n-i[2]),c=[s+.001,a+.001,o+.001,s+.999,a+.999,o+.999],u=this.getStatesList(this.names.collideTerrain),l=0;l<u.length;l++){var d=u[l].__id,p=this.getPositionData(d)._extents;if(Dr(c,p))return!0}return!1}getEntitiesInAABB(t,r){var n=this.noa.worldOriginOffset,i=[t.base[0]-n[0],t.base[1]-n[1],t.base[2]-n[2],t.max[0]-n[0],t.max[1]-n[1],t.max[2]-n[2]],s;if(r){s=[];for(var a of this.getStatesList(r)){var o=this.getPositionData(a.__id);o&&s.push(o)}}else s=this.getStatesList(this.names.position);for(var c=[],u=0;u<s.length;u++){var l=s[u];Dr(i,l._extents)&&c.push(l.__id)}return c}add(t=null,r=1,n=1,i=null,s=null,a=!1,o=!1){var c=this,u=this.createEntity();if(this.addComponent(u,this.names.position,{position:t||w.create(),width:r,height:n}),a){this.addComponent(u,this.names.physics);var l=this.getPhysics(u).body,d=this.names.smoothCamera;l.onStep=function(){c.addComponentAgain(u,d)}}return i&&(s||(s=w.create()),this.addComponent(u,this.names.mesh,{mesh:i,offset:s})),o&&this.addComponent(u,this.names.shadow,{size:r}),u}}function jt(e,t,r,n,i){var s=e[t]+r,a=e[t]+n;Math.abs(s-Math.round(s))<.002&&(e[t]+=.002),Math.abs(a-Math.round(a))<.001&&(e[t]-=.001)}function Dr(e,t){return!(e[0]>t[3]||e[1]>t[4]||e[2]>t[5]||e[3]<t[0]||e[4]<t[1]||e[5]<t[2])}function Gt(e,t){var r=e.indexOf(t);r<0||(r===e.length-1?e.pop():e[r]=e.pop())}function ti(e,t,r){var n=r||performance.now(),i=t();if(!i){var s=performance.now(),a=s-r,o=n+e-a/2;if(!(s>o)){for(var c=1e3,u=0;u<c;u++)if(t()||performance.now()>o)return}}}function fe(e,t,r){return e&1023|(t&1023)<<10|(r&1023)<<20}function Iu(){var e={};this.getChunkByIndexes=(t,r,n)=>e[fe(t,r,n)]||null,this.storeChunkByIndexes=(t,r,n,i)=>{e[fe(t,r,n)]=i},this.removeChunkByIndexes=(t,r,n)=>{delete e[fe(t,r,n)]}}class ge{constructor(){this.arr=[],this.hash={}}forEach(t,r){this.arr.forEach(t,r)}includes(t,r,n){var i=fe(t,r,n);return!!this.hash[i]}add(t,r,n,i=!1){var s=fe(t,r,n);this.hash[s]||(i?this.arr.unshift([t,r,n,s]):this.arr.push([t,r,n,s]),this.hash[s]=!0)}removeByIndex(t){var r=this.arr[t];delete this.hash[r[3]],this.arr.splice(t,1)}remove(t,r,n){var i=fe(t,r,n);if(!!this.hash[i]){delete this.hash[i];for(var s=0;s<this.arr.length;s++)if(i===this.arr[s][3]){this.arr.splice(s,1);return}throw"internal bug with location queue - hash value overlapped"}}count(){return this.arr.length}isEmpty(){return this.arr.length===0}empty(){this.arr=[],this.hash={}}pop(){var t=this.arr.pop();return delete this.hash[t[3]],t}copyFrom(t){this.arr=t.arr.slice(),this.hash={};for(var r in t.hash)this.hash[r]=!0}sortByDistance(t,r=!1){Au(this.arr,t,r)}}function Au(e,t,r){var n={};for(var i of e)n[i[3]]=t(i[0],i[1],i[2]);r?e.sort((s,a)=>n[s[3]]-n[a[3]]):e.sort((s,a)=>n[a[3]]-n[s[3]]),n=null}function Ru(e,t="",r){if(!(e>0))return()=>{};var n={},i=0,s=0,a=0,o=0,c=()=>{i=s=performance.now(),a++},u=d=>{var p=performance.now();n[d]=(n[d]||0)+(p-s),s=p},l=()=>{if(o+=performance.now()-i,!(a<e)){var d=`${t}: ${(o/e).toFixed(2)}ms  --  `;d+=Object.keys(n).map(p=>r&&n[p]/o<.05?"":`${p}: ${(n[p]/a).toFixed(2)}ms`).join("  "),console.log(d+`    (avg over ${e} runs)`),n={},a=o=0}};return d=>{d==="start"?c():d==="end"?l():u(d)}}function Ou(e){this.rootNode=new Jt("objectMeshRoot",e.rendering._scene);var t=[0,0,0],r=!1,n=new Jt(""),i={},s=a=>{if(i[a])return i[a];var o=e.registry._blockMeshLookup[a];for(var c in i){var u=i[c].mesh;if(u===o||u.geometry===o.geometry)return i[a]=i[c]}return i[a]=new Ke(e,o)};this.initChunk=function(a){a._objectBlocks={}},this.setObjectBlock=function(a,o,c,u,l){var d=a.x+c,p=a.y+u,m=a.z+l,f=`${d}:${p}:${m}`,v=a._objectBlocks[f]||0;if(v!==o){if(v>0){var h=s(v);h.removeInstance(a,f)}if(o>0){var y=e.registry._blockHandlerLookup[o],g=y&&y.onCustomMeshCreate;g&&(n.position.copyFromFloats(.5,0,.5),n.scaling.setAll(1),n.rotation.setAll(0),g(n,d,p,m));var _=s(o),k=g?n:null;_.addInstance(a,f,c,u,l,k,t)}v>0&&!o&&delete a._objectBlocks[f],o>0&&(a._objectBlocks[f]=o)}},this.buildObjectMeshes=function(){for(var a in i){var o=i[a];o.updateMatrix(),o.count===0&&o.dispose(),o.disposed&&delete i[a]}},this.disposeChunk=function(a){for(var o in a._objectBlocks){var c=a._objectBlocks[o];if(c>0){var u=s(c);u.removeInstance(a,o)}}a._objectBlocks=null,r=!0},this.tick=function(){r&&(this.buildObjectMeshes(),r=!1)},this._rebaseOrigin=function(a){t[0]+=a[0],t[1]+=a[1],t[2]+=a[2];for(var o in i)i[o].rebased=!1;for(var c in i){var u=i[c];if(!u.rebased){for(var l=0;l<u.count;l++){var d=l<<4;u.buffer[d+12]-=a[0],u.buffer[d+13]-=a[1],u.buffer[d+14]-=a[2]}u.rebased=!0,u.dirty=!0}}r=!0}}function Ke(e,t){this.mesh=t,this.buffer=null,this.capacity=0,this.count=0,this.dirty=!1,this.rebased=!0,this.disposed=!1,this.keyToIndex={},this.locToKey=[],this.mesh.position.setAll(0),this.mesh.parent=e._objectMesher.rootNode,this.mesh.isVisible=!0,e.rendering.addMeshToScene(this.mesh,!1),this.mesh.doNotSyncBoundingInfo=!0,this.mesh.alwaysSelectAsActiveMesh=!0}Ke.prototype.dispose=function(){this.disposed||(this.mesh.thinInstanceCount=0,this.setCapacity(0),this.mesh.isVisible=!1,this.mesh=null,this.keyToIndex=null,this.locToKey=null,this.disposed=!0)};Ke.prototype.addInstance=function(e,t,r,n,i,s,a){Su(this);var o=this.count<<4;if(this.locToKey[this.count]=t,this.keyToIndex[t]=o,s){s.position.x+=e.x-a[0]+r,s.position.y+=e.y-a[1]+n,s.position.z+=e.z-a[2]+i,s.computeWorldMatrix(!0);var c=s._localMatrix._m;sr(c,0,this.buffer,o)}else{var u=Bu;u[12]=e.x-a[0]+r+.5,u[13]=e.y-a[1]+n,u[14]=e.z-a[2]+i+.5,sr(u,0,this.buffer,o)}this.count++,this.dirty=!0};Ke.prototype.removeInstance=function(e,t){var r=this.keyToIndex[t];if(!(r>=0))throw"tried to remove object instance not in storage";delete this.keyToIndex[t];var n=r>>4,i=this.count-1;if(n!==i){var s=i<<4;sr(this.buffer,s,this.buffer,r);var a=this.locToKey[i];this.keyToIndex[a]=r,this.locToKey[n]=a}this.count--,this.dirty=!0,Du(this)};Ke.prototype.updateMatrix=function(){!this.dirty||(this.mesh.thinInstanceCount=this.count,this.mesh.thinInstanceBufferUpdated("matrix"),this.mesh.isVisible=this.count>0,this.dirty=!1)};Ke.prototype.setCapacity=function(e=4){if(this.capacity=e,e===0)this.buffer=null;else{var t=new Float32Array(this.capacity*16);if(this.buffer)for(var r=Math.min(this.buffer.length,t.length),n=0;n<r;n++)t[n]=this.buffer[n];this.buffer=t}this.mesh.thinInstanceSetBuffer("matrix",this.buffer),this.updateMatrix()};function Su(e){if(!(e.count<e.capacity)){var t=Math.max(8,e.capacity*2);e.setCapacity(t)}}function Du(e){e.count>e.capacity*.4||e.capacity<100||(e.setCapacity(Math.round(e.capacity/2)),e.locToKey.length=Math.min(e.locToKey.length,e.capacity))}var Bu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function sr(e,t,r,n){for(var i=0;i<16;i++)r[n+i]=e[t+i]}class Uu{constructor(t){this._defaultMat=t.rendering.makeStandardMaterial("base-terrain"),this._defaultMat.freeze(),this.noa=t,this._idCounter=1e3,this._blockMatIDtoTerrainID={},this._terrainIDtoMatObject={},this._texURLtoTerrainID={},this._renderMatToTerrainID=new Map}getTerrainMatId(t){if(t in this._blockMatIDtoTerrainID)return this._blockMatIDtoTerrainID[t];var r=$u(this,t);if(!(r in this._terrainIDtoMatObject)){var n=zu(this,t);this._terrainIDtoMatObject[r]=n}return this._blockMatIDtoTerrainID[t]=r,r}getMaterial(t=1){return this._terrainIDtoMatObject[t]}}function $u(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat){var n=r.renderMat;return e._renderMatToTerrainID.has(n)||e._renderMatToTerrainID.set(n,e._idCounter++),e._renderMatToTerrainID.get(n)}if(r.texture){var i=r.texture;return i in e._texURLtoTerrainID||(e._texURLtoTerrainID[i]=e._idCounter++),e._texURLtoTerrainID[i]}var s=r.alpha;return s>0&&s<1?10+Math.round(s*100):1}function zu(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat)return r.renderMat;if(!r.texture){var n=r.alpha>0&&r.alpha<1;if(!n)return e._defaultMat;var i="terrain-alpha-"+t,s=e.noa.rendering.makeStandardMaterial(i);return s.alpha=r.alpha,s.freeze(),s}var a=e.noa.rendering.getScene(),o=e.noa.rendering.makeStandardMaterial("terrain-textured-"+t),c=r.texture,u=er.NEAREST_SAMPLINGMODE,l=new er(c,a,!0,!1,u);return r.texHasAlpha&&(l.hasAlpha=!0),o.diffuseTexture=l,r.atlasIndex>=0&&(new qu(o,l),e.noa.registry._textureNeedsAlpha(r.texture)&&(l.hasAlpha=!0)),o.freeze(),o}class qu extends di{constructor(t,r){var n=200,i={NOA_TWOD_ARRAY_TEXTURE:!1};super(t,"TestPlugin",n,i),this._enable(!0),this._atlasTextureArray=null,r.onLoadObservable.add(s=>{this.setTextureArrayData(s)})}setTextureArrayData(t){var{width:r,height:n}=t.getSize(),i=Math.round(n/r);n=r;var s=t._readPixelsSync(),a=Gr.TEXTUREFORMAT_RGBA,o=!0,c=!1,u=er.NEAREST_SAMPLINGMODE,l=t.getScene();this._atlasTextureArray=new pi(s,r,n,i,a,l,o,c,u)}prepareDefines(t,r,n){t.NOA_TWOD_ARRAY_TEXTURE=!0}getClassName(){return"TerrainMaterialPluginName"}getSamplers(t){t.push("atlasTexture")}getAttributes(t){t.push("texAtlasIndices")}getUniforms(){return{ubo:[]}}bindForSubMesh(t,r,n,i){this._atlasTextureArray&&t.setTexture("atlasTexture",this._atlasTextureArray)}getCustomCode(t){return t==="vertex"?{CUSTOM_VERTEX_MAIN_BEGIN:`
                texAtlasIndex = texAtlasIndices;
            `,CUSTOM_VERTEX_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                attribute float texAtlasIndices;
                varying float texAtlasIndex;
            `}:t==="fragment"?{"!baseColor\\=texture2D\\(diffuseSampler,vDiffuseUV\\+uvOffset\\);":"baseColor = texture(atlasTexture, vec3(vDiffuseUV, texAtlasIndex));",CUSTOM_FRAGMENT_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                varying float texAtlasIndex;
            `}:null}}function Nu(e){var t=new Uu(e);this._defaultMaterial=t._defaultMat;var r=new Vu(e,t),n=new ju(e,t);this.initChunk=function(i){i._terrainMeshes.length=0},this.disposeChunk=function(i){i._terrainMeshes.forEach(s=>s.dispose()),i._terrainMeshes.length=0},this.meshChunk=function(i,s=!1){i._terrainMeshes.forEach(c=>c.dispose()),i._terrainMeshes.length=0;var a=r.mesh(i,s),o=n.buildMesh(i,a,s);o.forEach(c=>{e.rendering.addMeshToScene(c,!0,i.pos,this),c.cullingStrategy=Kr.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,i._terrainMeshes.push(c)})}}function Hu(){this.terrainID=0,this.numFaces=0,this.matIDs=[],this.dirs=[],this.is=[],this.js=[],this.ks=[],this.wids=[],this.hts=[],this.packedAO=[]}function Vu(e,t){var r=new Int16Array(16),n=new Int16Array(16),i=t.getTerrainMatId.bind(t),s=_=>1,a=i;this.mesh=function(_,k){var M=_.size;a=k?s:i;var L=_._isEmpty||_._isFull,b={};Br.reset();for(var T=0;T<3;++T){var x=T===2?0:2,C=T===1?0:1,E=_._neighbors.data.map(j=>j&&j.voxels?j.voxels.transpose(T,x,C):null),A=nt(E,[3,3,3]).lo(1,1,1).transpose(T,x,C);r.length<M*M&&(r=new Int16Array(M*M),n=new Int16Array(M*M)),o(A,M);var S=A.get(-1,0,0),F=A.get(0,0,0);if(S){var P=S.lo(M,0,0),U=v(T,P,-1,F,0);U>0&&h(0,T,x,C,M,M,U,b)}if(!L)for(var R=0;R<M-1;R++){if(T===1){var I=_._wholeLayerVoxel[R];if(I>=0&&I===_._wholeLayerVoxel[R+1])continue}var D=T===1?null:_._wholeLayerVoxel,H=v(T,F,R,F,R+1,D);H>0&&h(R+1,T,x,C,M,M,H,b)}}return b};function o(_,k){if(p=_.get(0,0,0),m=_,d=e.registry._solidityLookup,c.length!==k+1){c=[],u=[],l=[];for(var M=-1;M<k+1;M++){var L=M<0?0:M<k?1:2;c[M]=[-1,0,1][L]|0,u[M]=[k-1,M,0][L]|0,l[M]=[0,M,k-1][L]|0}}}var c=[],u=[],l=[],d,p,m;function f(_,k,M){var L=c[_]|0,b=c[k]|0,T=c[M]|0;if((L|b|T)===0)return d[p.get(_,k,M)];var x=m.get(L,b,T);if(x){var C=u[_]|0,E=u[k]|0,A=u[M]|0;return d[x.get(C,E,A)]}else{var S=l[_]|0,F=l[k]|0,P=l[M]|0;return d[p.get(S,F,P)]}}function v(_,k,M,L,b,T=null){for(var x=k.shape[1],C=r,E=n,A=e.rendering.useAO,S=e.rendering.revAoVal===e.rendering.aoVals[0],F=e.registry._opacityLookup,P=e.registry.getBlockFaceMaterial,U=_*2,R=0,I=k.index(M,0,0),D=k.stride[1],H=k.stride[2],j=L.index(b,0,0),ee=L.stride[1],we=L.stride[2],oe=0,ue=0;ue<x;++ue){var ce=I,ie=j;if(I+=H,j+=we,T&&T[ue]>=0){R+=x;continue}for(var se=0;se<x;se++,R++,ce+=D,ie+=ee){var W=k.data[ce],Y=L.data[ie];if(W!==Y){var ve=F[W],de=F[Y];if(!(ve&&de)){var Ie=P(W,U),We=P(Y,U+1);Ie!==We&&(ve||We===0?(C[R]=Ie,A&&(E[R]=Ur(f,b,M,se,ue,S)),oe++):(de||Ie===0)&&(C[R]=-We,A&&(E[R]=Ur(f,M,b,se,ue,S)),oe++))}}}}return oe}function h(_,k,M,L,b,T,x,C){var E=e.rendering.useAO,A=r,S=n,F=0,P=k*2,U=[0,0,0];U[k]=_;for(var R=E?y:g,I=0;I<T;++I)for(var D=1,H=1,j=0;j<b;j+=D,F+=D){var ee=A[F]|0;if(!ee){D=1;continue}var we=S[F]|0;for(D=1;D<b-j&&R(F+D,A,ee,S,we);++D);e:for(H=1;H<T-I;++H)for(var oe=0;oe<D;++oe){var ue=F+oe+H*b;if(!R(ue,A,ee,S,we))break e}var ce=Math.abs(ee),ie=a(ce);if(!(ie in C)){var se=Br.get();se.numFaces=0,se.terrainID=ie,C[ie]=se}var W=C[ie],Y=W.numFaces;W.numFaces++,W.matIDs[Y]=ce,U[M]=j,U[L]=I,W.is[Y]=U[0],W.js[Y]=U[1],W.ks[Y]=U[2],W.wids[Y]=D,W.hts[Y]=H,W.packedAO[Y]=we,W.dirs[Y]=ee>0?P:P+1;for(var ve=0;ve<H;++ve)for(var de=0;de<D;++de)A[F+de+ve*b]=0;if(x-=D*H,x===0)return}}function y(_,k,M,L,b){return!(M!==k[_]||b!==L[_])}function g(_,k,M,L,b){return M===k[_]}}var Br=(()=>{var e=[],t=0,r=()=>(t>=e.length&&e.push(new Hu),t++,e[t-1]),n=()=>{t=0};return{get:r,reset:n}})();function ju(e,t){this.buildMesh=function(p,m,f){var v=e.rendering.getScene(),h=e.rendering.useAO,y=e.rendering.aoVals,g=e.rendering.revAoVal,_=e.registry._matAtlasIndexLookup,k=e.registry._materialColorLookup,M=[1,1,1],L=[];for(var b in m){var T=m[b],x=T.terrainID,C=!1;if(!f){var E=_[T.matIDs[0]];C=E>=0}for(var A=[],S=[],F=[],P=[],U=[],R=[],I=0;I<T.numFaces;I++){var D=T.matIDs[I],H=T.dirs[I],j=T.is[I],ee=T.js[I],we=T.ks[I],oe=T.wids[I],ue=T.hts[I],ce=H/2|0,ie=H%2?-1:1;r(A,I,j,ee,we,ce,oe,ue),n(U,I,ce,oe,ue,ie);var se=[0,0,0];se[ce]=ie,i(F,I,se);var W=T.packedAO[I],[Y,ve,de,Ie]=Gu(W),We=c(Y,ve,de,Ie);if(s(S,I,ce,ie,We),C){var fi=_[D];o(R,I,fi)}var mr=k[D]||M;h?l(P,I,mr,y,g,Y,ve,de,Ie):u(P,I,mr)}var hi=`chunk_${p.requestID}_${x}`,ot=new Kr(hi,v),Ae=new mi;Ae.positions=A,Ae.indices=S,Ae.normals=F,Ae.colors=P,Ae.uvs=U,Ae.applyToMesh(ot),C&&ot.setVerticesData("texAtlasIndices",R,!1,1),f||(ot.material=t.getMaterial(x)),L.push(ot)}return L};function r(p,m,f,v,h,y,g,_){var k=m*12,M=[f,v,h],L=[0,0,0],b=[0,0,0];L[y===2?0:2]=g,b[y===1?0:1]=_;for(var T=0;T<3;T++)p[k+T]=M[T],p[k+3+T]=M[T]+L[T],p[k+6+T]=M[T]+L[T]+b[T],p[k+9+T]=M[T]+b[T]}function n(p,m,f,v,h,y){for(var g=m*8,_=0,k=0;k<8;k++)p[g+k]=_;f===0?(p[g+1]=p[g+3]=h-_,p[g+2]=p[g+4]=y*v):f===1?(p[g+1]=p[g+7]=v-_,p[g+4]=p[g+6]=y*h):(p[g+1]=p[g+3]=h-_,p[g+2]=p[g+4]=-y*v)}function i(p,m,f){for(var v=m*12,h=0;h<12;h++)p[v+h]=f[h%3]}function s(p,m,f,v,h){var y=m*6,g=m*4;f===0&&(v=-v);var _=v<0?0:1;h||(_+=2);for(var k=a[_],M=0;M<6;M++)p[y+M]=g+k[M]}var a=[[0,1,2,0,2,3],[0,2,1,0,3,2],[1,2,3,1,3,0],[1,3,2,1,0,3]];function o(p,m,f){for(var v=m*4,h=0;h<4;h++)p[v+h]=f}function c(p,m,f,v){return p===f?v===m?v===2:!0:v===m?!1:p+f>v+m}function u(p,m,f){for(var v=m*16,h=0;h<16;h+=4)p[v+h]=f[0],p[v+h+1]=f[1],p[v+h+2]=f[2],p[v+h+3]=1}function l(p,m,f,v,h,y,g,_,k){var M=m*16;d(p,M,f,y,v,h),d(p,M+4,f,k,v,h),d(p,M+8,f,_,v,h),d(p,M+12,f,g,v,h)}function d(p,m,f,v,h,y){var g=v===0?y:h[v-1];p[m]=f[0]*g,p[m+1]=f[1]*g,p[m+2]=f[2]*g,p[m+3]=1}}function Ur(e,t,r,n,i,s=!1){var a=1,o=1,c=1,u=1;e(t,n+1,i)&&(++c,++u),e(t,n-1,i)&&(++a,++o),e(t,n,i+1)&&(++o,++u),e(t,n,i-1)&&(++a,++c);var l=e(t,n,i);return l?(u=u===3||e(t,n+1,i+1)?3:2,o=o===3||e(t,n-1,i+1)?3:2,c=c===3||e(t,n+1,i-1)?3:2,a=a===3||e(t,n-1,i-1)?3:2,u<<6|c<<4|o<<2|a):s?(u===1&&e(t,n+1,i+1)&&(u=2),o===1&&e(t,n-1,i+1)&&(o=2),c===1&&e(t,n+1,i-1)&&(c=2),a===1&&e(t,n-1,i-1)&&(a=2),u<<6|c<<4|o<<2|a):(u===1&&(e(t,n+1,i+1)?u=2:(!e(r,n,i+1)||!e(r,n+1,i)||!e(r,n+1,i+1))&&(u=0)),c===1&&(e(t,n+1,i-1)?c=2:(!e(r,n,i-1)||!e(r,n+1,i)||!e(r,n+1,i-1))&&(c=0)),o===1&&(e(t,n-1,i+1)?o=2:(!e(r,n,i+1)||!e(r,n-1,i)||!e(r,n-1,i+1))&&(o=0)),a===1&&(e(t,n-1,i-1)?a=2:(!e(r,n,i-1)||!e(r,n-1,i)||!e(r,n-1,i-1))&&(a=0)),u<<6|c<<4|o<<2|a)}function Gu(e){var t=e&3,r=e>>2&3,n=e>>4&3,i=e>>6&3;return[t,r,i,n]}var Ku={texturePath:""},Wu=(1<<16)-1;class Yu{constructor(t,r){r=Object.assign({},Ku,r),this.noa=t,this._texturePath=r.texturePath;var n={},i=[!1],s=[!1],a=[!1],o=[!1],c=[null],u=[null],l=[null],d=[!1],p=[0,0,0,0,0,0],m=[null],f=[-1],v=[];this.registerBlock=function(h=1,y=null){var g=new Qu(y&&y.fluid),_=Object.assign({},g,y||{});if(h<1||h>Wu)throw"Block id out of range: "+h;for(;h>i.length;)this.registerBlock(i.length,{});i[h]=!!_.solid,s[h]=!!_.opaque,a[h]=!!_.fluid,o[h]=!!_.blockMesh,u[h]=_.blockMesh||null;var k=_.material||null,M;if(!k)M=[null,null,null,null,null,null];else if(typeof k=="string")M=[k,k,k,k,k,k];else if(k.length&&k.length==2)M=[k[1],k[1],k[0],k[0],k[1],k[1]];else if(k.length&&k.length==3)M=[k[2],k[2],k[0],k[1],k[2],k[2]];else if(k.length&&k.length==6)M=k;else throw"Invalid material parameter: "+k;for(var L=0;L<6;++L)p[h*6+L]=Zu(this,n,M[L],!0);c[h]={},a[h]&&(c[h].fluidDensity=_.fluidDensity,c[h].viscosity=_.viscosity);var b=_.onLoad||_.onUnload||_.onSet||_.onUnset||_.onCustomMeshCreate;l[h]=b?new Xu(_):null;var T=i[h]&&s[h]&&!b&&!a[h]&&!o[h];return d[h]=T,h},this.registerMaterial=function(h="?",y=null){if(Array.isArray(y)||arguments[2])throw'This API changed signatures in v0.33, please use: `noa.registry.registerMaterial("name", optionsObj)`';var g=Object.assign(new Ju,y||{}),_=n[h]||v.length;n[h]=_;var k=g.textureURL?this._texturePath+g.textureURL:"",M=1,L=g.color||[1,1,1];return L.length===4&&(M=L.pop()),k&&(L=null),m[_]=L,f[_]=g.atlasIndex,v[_]={color:L,alpha:M,texture:k,texHasAlpha:!!g.texHasAlpha,atlasIndex:g.atlasIndex,renderMat:g.renderMaterial},_},this.getBlockSolidity=function(h){return i[h]},this.getBlockOpacity=function(h){return s[h]},this.getBlockFluidity=function(h){return a[h]},this.getBlockProps=function(h){return c[h]},this.getBlockFaceMaterial=function(h,y){return p[h*6+y]},this.getMaterialData=function(h){return v[h]},this._textureNeedsAlpha=function(h=""){return v.some(y=>y.texture!==h?!1:y.texHasAlpha)},this._solidityLookup=i,this._opacityLookup=s,this._fluidityLookup=a,this._objectLookup=o,this._blockMeshLookup=u,this._blockHandlerLookup=l,this._blockIsPlainLookup=d,this._materialColorLookup=m,this._matAtlasIndexLookup=f,this.registerMaterial("dirt",{color:[.4,.3,0]}),this.registerBlock(1,{material:"dirt"})}}function Zu(e,t,r,n){if(!r)return 0;var i=t[r];return i===void 0&&n&&(i=e.registerMaterial(r)),i}function Xu(e){this.onLoad=e.onLoad||null,this.onUnload=e.onUnload||null,this.onSet=e.onSet||null,this.onUnset=e.onUnset||null,this.onCustomMeshCreate=e.onCustomMeshCreate||null}function Qu(e=!1){this.solid=!e,this.opaque=!e,this.fluid=!1,this.material=null,this.blockMesh=null,this.fluidDensity=1,this.viscosity=.5,this.onLoad=null,this.onUnload=null,this.onSet=null,this.onUnset=null,this.onCustomMeshCreate=null}function Ju(){this.color=null,this.textureURL=null,this.texHasAlpha=!1,this.atlasIndex=-1,this.renderMaterial=null}class ec{constructor(t,r){var n=t._scene;n._addComponent(new gi(n));var i=new yi(a);n._selectionOctree=i,i.blocks=[];var s={};this.rebase=l=>{c(i,l)},this.includesMesh=l=>l._noaContainingBlock||l._noaIsDynamicContent,this.addMesh=(l,d,p,m)=>{if(!d){l._noaIsDynamicContent=!0,i.dynamicContent.push(l);return}var f=Math.floor(p[0]/o),v=Math.floor(p[1]/o),h=Math.floor(p[2]/o),y=fe(f,v,h),g=s[y];if(!g){var _=[f*o,v*o,h*o],k=[0,0,0];t.noa.globalToLocal(_,null,k),g=u(k,o),i.blocks.push(g),s[y]=g,g._noaMapKey=y}g.entries.push(l),l._noaContainingBlock=g,l.alwaysSelectAsActiveMesh=!0},this.removeMesh=l=>{if(l._noaIsDynamicContent&&(l._noaIsDynamicContent=null,Gt(i.dynamicContent,l)),l._noaContainingBlock){l._noaContainingChunk=null;var d=l._noaContainingBlock;Gt(d.entries,l),d.entries.length===0&&(delete s[d._noaMapKey],Gt(i.blocks,d))}};var a=()=>{},o=r*t.noa.world._chunkSize,c=(l,d)=>{l.blocks.forEach(p=>{p.minPoint.subtractInPlace(d),p.maxPoint.subtractInPlace(d),p._boundingVectors.forEach(m=>m.subtractInPlace(d)),p.blocks&&c(p,d)})},u=(l,d)=>{var p=new le(l[0],l[1],l[2]),m=new le(l[0]+d,l[1]+d,l[2]+d);return new _i(p,m,void 0,void 0,void 0,a)}}}var tc={showFPS:!1,antiAlias:!0,clearColor:[.8,.9,1],ambientColor:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],groundLightColor:[.5,.5,.5],useAO:!0,AOmultipliers:[.93,.8,.5],reverseAOmultiplier:1,preserveDrawingBuffer:!0,octreeBlockSize:2,renderOnResize:!0};class J{constructor(t,r,n){r=Object.assign({},tc,r),this.noa=t,this.renderOnResize=!!r.renderOnResize,this.useAO=!!r.useAO,this.aoVals=r.AOmultipliers,this.revAoVal=r.reverseAOmultiplier,this.meshingCutoffTime=6,this._scene=null,this._engine=null,this._octreeManager=null,this.initScene(n,r),r.showFPS&&sc()}initScene(t,r){this._engine=new Gr(t,r.antiAlias,{preserveDrawingBuffer:r.preserveDrawingBuffer}),this._scene=new ki(this._engine);var n=this._scene;n.detachControl();var i=Math.round(r.octreeBlockSize);this._octreeManager=new ec(this,i),this._cameraHolder=new Jt("camHolder",n),this._camera=new Mi("camera",new le(0,0,0),n),this._camera.parent=this._cameraHolder,this._camera.minZ=.01,this._camScreen=Wr("camScreen",{size:10},n),this.addMeshToScene(this._camScreen),this._camScreen.position.z=.1,this._camScreen.parent=this._camera,this._camScreenMat=this.makeStandardMaterial("camscreenmat"),this._camScreen.material=this._camScreenMat,this._camScreen.setEnabled(!1),this._camScreenMat.freeze(),this._camLocBlock=0;var s=new le(.1,1,.3);this._light=new Ci("light",s,n);function a(o){return new rt(o[0],o[1],o[2])}n.clearColor=wi.FromColor3(a(r.clearColor)),n.ambientColor=a(r.ambientColor),this._light.diffuse=a(r.lightDiffuse),this._light.specular=a(r.lightSpecular),this._light.groundColor=a(r.groundLightColor),n.skipPointerMovePicking=!0}}J.prototype.getScene=function(){return this._scene};J.prototype.tick=function(e){};J.prototype.render=function(){rc(this),this._engine.beginFrame(),this._scene.render(),ri(),this._engine.endFrame()};J.prototype.postRender=function(){};J.prototype.resize=function(){this._engine.resize(),this.noa._paused&&this.renderOnResize&&this._scene.render()};J.prototype.highlightBlockFace=function(e,t,r){var n=ic(this);if(e){this.noa.globalToLocal(t,null,Le);for(var i=w.dist(this.noa.camera._localGetPosition(),Le),s=.001+.001*i,a=0;a<3;a++)r[a]===0?Le[a]+=.5:Le[a]+=r[a]>0?1+s:-s;n.position.copyFromFloats(Le[0],Le[1],Le[2]),n.rotation.x=r[1]?Math.PI/2:0,n.rotation.y=r[0]?Math.PI/2:0}n.setEnabled(e)};var Le=[];J.prototype.addMeshToScene=function(e,t=!1,r=null,n=null){if(!this._octreeManager.includesMesh(e)){if(!e.parent){r||(r=[e.position.x,e.position.y,e.position.z]);var i=[];this.noa.globalToLocal(r,null,i),e.position.copyFromFloats(i[0],i[1],i[2])}t&&(e.freezeWorldMatrix(),e.freezeNormals&&e.freezeNormals(),e.doNotSyncBoundingInfo=!0),this._octreeManager.addMesh(e,t,r,n),e.onDisposeObservable.add(()=>{this._octreeManager.removeMesh(e)})}};J.prototype.makeStandardMaterial=function(e){var t=new Li(e,this._scene);return t.specularColor.copyFromFloats(0,0,0),t.ambientColor.copyFromFloats(1,1,1),t.diffuseColor.copyFromFloats(1,1,1),this.postMaterialCreationHook(t),t};J.prototype.postMaterialCreationHook=function(e){};J.prototype.prepareChunkForRendering=function(e){};J.prototype.disposeChunkForRendering=function(e){};J.prototype._rebaseOrigin=function(e){var t=new le(e[0],e[1],e[2]);this._scene.meshes.forEach(r=>{r.parent||(r.position.subtractInPlace(t),r.isWorldMatrixFrozen&&r.freezeWorldMatrix())}),this._octreeManager.rebase(t)};function rc(e){var t=e.noa.camera,r=t._localGetTargetPosition();e._cameraHolder.position.copyFromFloats(r[0],r[1],r[2]),e._cameraHolder.rotation.x=t.pitch,e._cameraHolder.rotation.y=t.heading,e._camera.position.z=-t.currentZoom;var n=t._localGetPosition(),i=e.noa.worldOriginOffset,s=Math.floor(n[0]+i[0]),a=Math.floor(n[1]+i[1]),o=Math.floor(n[2]+i[2]),c=e.noa.getBlock(s,a,o);nc(e,c)}function nc(e,t){if(t!==e._camLocBlock){if(t===0)e._camScreen.setEnabled(!1);else{var r=e.noa.registry.getBlockFaceMaterial(t,0);if(r){var n=e.noa.registry.getMaterialData(r),i=n.color,s=n.alpha;i&&s&&s<1&&(e._camScreenMat.diffuseColor.set(0,0,0),e._camScreenMat.ambientColor.set(i[0],i[1],i[2]),e._camScreenMat.alpha=s,e._camScreen.setEnabled(!0))}}e._camLocBlock=t}}function ic(e){var t=e._highlightMesh;if(!t){t=Wr("highlight",{size:1},e._scene);var r=e.makeStandardMaterial("highlightMat");r.backFaceCulling=!1,r.emissiveColor=new rt(1,1,1),r.alpha=.2,r.freeze(),t.material=r;var n=.5,i=Ti("hightlightLines",{points:[new le(n,n,0),new le(n,-n,0),new le(-n,-n,0),new le(-n,n,0),new le(n,n,0)]},e._scene);i.color=new rt(1,1,1),i.parent=t,e.addMeshToScene(t),e.addMeshToScene(i),e._highlightMesh=t}return t}J.prototype.debug_SceneCheck=function(){var e=this._scene.meshes,t=this._scene._selectionOctree,r=t.dynamicContent,n=[],i=0,s=0,a=this._scene.materials,o=[];a.forEach(m=>{m.subMaterials?m.subMaterials.forEach(f=>o.push(f)):o.push(m)}),t.blocks.forEach(function(m){i++,m.entries.forEach(f=>n.push(f))}),e.forEach(function(m){if(m.isDisposed&&l(m,"disposed mesh in scene"),!d(m)){if(p(m,r,n)&&l(m,"non-empty mesh missing from octree"),!m.material){l(m,"non-empty scene mesh with no material");return}s+=m.subMeshes?m.subMeshes.length:1;var f=m.material.subMaterials||[m.material];f.forEach(function(v){p(v,f)&&l(v,"mesh material not in scene")})}});var c=[];o.forEach(m=>{var f=!1;e.forEach(v=>{if(v.material===m&&(f=!0),!!v.material){var h=v.material.subMaterials||[v.material];h.includes(m)&&(f=!0)}}),f||c.push(m.name)}),c.length&&console.warn("Materials unused by any mesh: ",c.join(", ")),r.forEach(function(m){p(m,e)&&l(m,"octree/dynamic mesh not in scene")}),n.forEach(function(m){p(m,e)&&l(m,"octree block mesh not in scene")});var u=Math.round(10*n.length/i)/10;console.log("meshes - octree:",n.length,"  dynamic:",r.length,"   subMeshes:",s,"   avg meshes/octreeBlock:",u);function l(m,f){console.warn(m.name+" --- "+f)}function d(m){return m.getIndices().length===0}function p(m,f,v){return!(!m||f.includes(m)||v&&v.includes(m))}return"done."};J.prototype.debug_MeshCount=function(){var e={};this._scene.meshes.forEach(r=>{var n=r.name||"";n=n.replace(/-\d+.*/,"#"),n=n.replace(/\d+.*/,"#"),n=n.replace(/(rotHolder|camHolder|camScreen)/,"rendering use"),n=n.replace(/atlas sprite .*/,"atlas sprites"),e[n]=e[n]||0,e[n]++});for(var t in e)console.log("   "+(e[t]+"       ").substr(0,7)+t)};var ri=function(){};function sc(){var e=document.createElement("div");e.id="noa_fps",e.style.position="absolute",e.style.top="0",e.style.right="0",e.style.zIndex="0",e.style.color="white",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.font="14px monospace",e.style.textAlign="center",e.style.minWidth="2em",e.style.margin="4px",document.body.appendChild(e);var t=1e3,r=0,n=0,i=performance.now(),s=i;ri=function(){r++;var a=performance.now();if(a-s>n&&(n=a-s),s=a,!(a-i<t)){var o=Math.round(r/(a-i)*1e3),c=Math.round(1/n*1e3);e.innerHTML=o+"<br>"+c,r=0,n=0,i=a}}}class ac{constructor(t,r,n,i,s,a,o){this.aabb=new At(t.base,t.vec),this.mass=r,this.friction=n,this.restitution=i,this.gravityMultiplier=s,this.onCollide=a,this.autoStep=!!o,this.airDrag=-1,this.fluidDrag=-1,this.onStep=null,this.velocity=w.create(),this.resting=[0,0,0],this.inFluid=!1,this._ratioInFluid=0,this._forces=w.create(),this._impulses=w.create(),this._sleepFrameCount=10}setPosition(t){w.subtract(t,t,this.aabb.base),this.aabb.translate(t),this._markActive()}getPosition(){return w.clone(this.aabb.base)}applyForce(t){w.add(this._forces,this._forces,t),this._markActive()}applyImpulse(t){w.add(this._impulses,this._impulses,t),this._markActive()}_markActive(){this._sleepFrameCount=10}atRestX(){return this.resting[0]}atRestY(){return this.resting[1]}atRestZ(){return this.resting[2]}}function oc(){this.airDrag=.1,this.fluidDrag=.4,this.fluidDensity=2,this.gravity=[0,-10,0],this.minBounceImpulse=.5}function St(e,t,r){e=Object.assign(new oc,e),this.gravity=e.gravity||[0,-10,0],this.airDrag=e.airDrag||.1,this.fluidDensity=e.fluidDensity||2,this.fluidDrag=e.fluidDrag||.4,this.minBounceImpulse=e.minBounceImpulse,this.bodies=[],this.testSolid=t,this.testFluid=r}St.prototype.addBody=function(e,t,r,n,i,s){e=e||new At([0,0,0],[1,1,1]),typeof t>"u"&&(t=1),typeof r>"u"&&(r=1),typeof n>"u"&&(n=0),typeof i>"u"&&(i=1);var a=new ac(e,t,r,n,i,s);return this.bodies.push(a),a};St.prototype.removeBody=function(e){var t=this.bodies.indexOf(e);t<0||(this.bodies.splice(t,1),e.aabb=e.onCollide=null)};var ht=w.create(),Te=w.create(),Kt=w.create(),me=w.create(),$r=w.create();St.prototype.tick=function(e){e=e/1e3;var t=bt(0,w.squaredLength(this.gravity));this.bodies.forEach(r=>uc(this,r,e,t))};function uc(e,t,r,n){if(w.copy($r,t.resting),t.mass<=0){w.set(t.velocity,0,0,0),w.set(t._forces,0,0,0),w.set(t._impulses,0,0,0);return}var i=n||t.gravityMultiplier===0;if(!hc(e,t,r,i)){t._sleepFrameCount--,cc(e,t),dt(t._forces),dt(t._impulses),dt(t.velocity),dt(t.resting),w.scale(ht,t._forces,1/t.mass),w.scaleAndAdd(ht,ht,e.gravity,t.gravityMultiplier),w.scale(Te,t._impulses,1/t.mass),w.scaleAndAdd(Te,Te,ht,r),w.add(t.velocity,t.velocity,Te),t.friction&&(Wt(0,t,Te),Wt(1,t,Te),Wt(2,t,Te));var s=t.airDrag>=0?t.airDrag:e.airDrag;t.inFluid&&(s=t.fluidDrag>=0?t.fluidDrag:e.fluidDrag,s*=1-(1-t.ratioInFluid)**2);var a=Math.max(1-s*r/t.mass,0);w.scale(t.velocity,t.velocity,a),w.scale(Kt,t.velocity,r),w.set(t._forces,0,0,0),w.set(t._impulses,0,0,0),t.autoStep&&ii(zr,t.aabb),ni(e,t.aabb,Kt,t.resting),t.autoStep&&fc(e,t,zr,Kt);for(var o=0;o<3;++o)me[o]=0,t.resting[o]&&($r[o]||(me[o]=-t.velocity[o]),t.velocity[o]=0);var c=w.length(me);c>.001&&(w.scale(me,me,t.mass),t.onCollide&&t.onCollide(me),t.restitution>0&&c>e.minBounceImpulse&&(w.scale(me,me,t.restitution),t.applyImpulse(me)));var u=w.squaredLength(t.velocity);u>1e-5&&t._markActive()}}function cc(e,t){var r=t.aabb,n=Math.floor(r.base[0]),i=Math.floor(r.base[2]),s=Math.floor(r.base[1]),a=Math.floor(r.max[1]);if(!e.testFluid(n,s,i)){t.inFluid=!1,t.ratioInFluid=0;return}for(var o=1,c=s+1;c<=a&&e.testFluid(n,c,i);)o++,c++;var u=s+o,l=u-r.base[1],d=l/r.vec[1];d>1&&(d=1);var p=r.vec[0]*r.vec[1]*r.vec[2],m=p*d,f=lc;w.scale(f,e.gravity,-e.fluidDensity*m),t.applyForce(f),t.inFluid=!0,t.ratioInFluid=d}var lc=w.create();function Wt(e,t,r){var n=t.resting[e],i=r[e];if(n!==0&&!(n*i<=0)){w.copy(Yt,t.velocity),Yt[e]=0;var s=w.length(Yt);if(!bt(s,0)){var a=Math.abs(t.friction*i),o=s>a?(s-a)/s:0;t.velocity[(e+1)%3]*=o,t.velocity[(e+2)%3]*=o}}}var Yt=w.create();function ni(e,t,r,n){return w.set(n,0,0,0),it(e.testSolid,t,r,function(i,s,a,o){n[s]=a,o[s]=0})}var zr=new At([],[]),Zt=w.create(),vt=w.create(),qr=w.create(),Xt=w.create();function fc(e,t,r,n){if(!(t.resting[1]>=0&&!t.inFluid)){var i=t.resting[0]!==0,s=t.resting[2]!==0;if(!!(i||s)){var a=Math.abs(n[0]/n[2]),o=4;if(!(!i&&a>o)&&!(!s&&a<1/o)){w.add(vt,r.base,n);var c=e.testSolid;it(c,r,n,function(p,m,f,v){if(m===1)v[m]=0;else return!0});var u=t.aabb.base[1],l=Math.floor(u+1.001)-u;w.set(qr,0,l,0);var d=!1;it(c,r,qr,function(p,m,f,v){return d=!0,!0}),!d&&(w.subtract(Xt,vt,r.base),Xt[1]=0,ni(e,r,Xt,Zt),!(i&&!bt(r.base[0],vt[0]))&&(s&&!bt(r.base[2],vt[2])||(ii(t.aabb,r),t.resting[0]=Zt[0],t.resting[2]=Zt[2],t.onStep&&t.onStep())))}}}}function hc(e,t,r,n){if(t._sleepFrameCount>0)return!1;if(n)return!0;var i=!1,s=.5*r*r*t.gravityMultiplier;return w.scale(Nr,e.gravity,s),it(e.testSolid,t.aabb,Nr,function(){return i=!0,!0},!0),i}var Nr=w.create();function bt(e,t){return Math.abs(e-t)<1e-5}function ii(e,t){for(var r=0;r<3;r++)e.base[r]=t.base[r],e.max[r]=t.max[r],e.vec[r]=t.vec[r]}var dt=function(e){},vc={gravity:[0,-10,0],airDrag:.1};class dc extends St{constructor(t,r){r=Object.assign({},vc,r);var n=t.world,i=t.registry._solidityLookup,s=t.registry._fluidityLookup,a=t.worldOriginOffset,o=(u,l,d)=>{var p=n.getBlockID(u+a[0],l+a[1],d+a[2]);return i[p]},c=(u,l,d)=>{var p=n.getBlockID(u+a[0],l+a[1],d+a[2]);return s[p]};super(r,o,c)}}function he(e,t,r,n,i,s,a,o=-1){this.noa=e,this.isDisposed=!1,this.requestID=t,this.voxels=a,this.i=r,this.j=n,this.k=i,this.size=s,this.x=r*s,this.y=n*s,this.z=i*s,this.pos=[this.x,this.y,this.z],this._terrainDirty=!1,this._objectsDirty=!1,this._terrainMeshes=[],e._terrainMesher.initChunk(this),e._objectMesher.initChunk(this),this._isFull=!1,this._isEmpty=!1,this._wholeLayerVoxel=Array(s).fill(-1),o>=0&&(this.voxels.data.fill(o,0,this.voxels.size),this._wholeLayerVoxel.fill(o));var c=Array.from(Array(27),()=>null);this._neighbors=nt(c,[3,3,3]).lo(1,1,1),this._neighbors.set(0,0,0,this),this._neighborCount=0,this._timesMeshed=0,this._blockHandlerLocs=new ge,si(this)}he._createVoxelArray=function(e){var t=new Uint16Array(e*e*e);return nt(t,[e,e,e])};he.prototype._updateVoxelArray=function(e,t=-1){ai(this,"onUnload"),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels=e,this._terrainDirty=!1,this._objectsDirty=!1,this._blockHandlerLocs.empty(),this.noa._objectMesher.initChunk(this),this.noa._terrainMesher.initChunk(this),t>=0?this._wholeLayerVoxel.fill(t):this._wholeLayerVoxel.fill(-1),si(this)};he.prototype.get=function(e,t,r){return this.voxels.get(e,t,r)};he.prototype.getSolidityAt=function(e,t,r){var n=this.noa.registry._solidityLookup;return n[this.voxels.get(e,t,r)]};he.prototype.set=function(e,t,r,n){var i=this.voxels.get(e,t,r);if(n!==i){this.voxels.set(e,t,r,n);var s=this.noa.registry._solidityLookup,a=this.noa.registry._objectLookup,o=this.noa.registry._opacityLookup,c=this.noa.registry._blockHandlerLookup;o[n]||(this._isFull=!1),n!==0&&(this._isEmpty=!1),this._wholeLayerVoxel[t]!==n&&(this._wholeLayerVoxel[t]=-1);var u=c[i],l=c[n];u&&xt(this,u,"onUnset",e,t,r),l?(xt(this,l,"onSet",e,t,r),this._blockHandlerLocs.add(e,t,r)):this._blockHandlerLocs.remove(e,t,r);var d=this.noa._objectMesher,p=a[i],m=a[n];p&&d.setObjectBlock(this,0,e,t,r),m&&d.setObjectBlock(this,n,e,t,r);var f=s[i]!==s[n],v=o[i]!==o[n],h=!p&&i!==0,y=!m&&n!==0;if((p||m)&&(this._objectsDirty=!0),(f||v||h||y)&&(this._terrainDirty=!0),(this._terrainDirty||this._objectsDirty)&&this.noa.world._queueChunkForRemesh(this),f||v){for(var g=this.size-1,_=e===0?-1:0,k=t===0?-1:0,M=r===0?-1:0,L=e===g?1:0,b=t===g?1:0,T=r===g?1:0,x=_;x<=L;x++)for(var C=k;C<=b;C++)for(var E=M;E<=T;E++)if((x|C|E)!==0){var A=this._neighbors.get(x,C,E);!A||(A._terrainDirty=!0,this.noa.world._queueChunkForRemesh(A))}}}};function xt(e,t,r,n,i,s){var a=t[r];!a||a(e.x+n,e.y+i,e.z+s)}he.prototype.updateMeshes=function(){this._terrainDirty&&(this.noa._terrainMesher.meshChunk(this),this._timesMeshed++,this._terrainDirty=!1),this._objectsDirty&&(this.noa._objectMesher.buildObjectMeshes(),this._objectsDirty=!1)};function si(e){for(var t=e.voxels,r=t.data,n=t.shape[0],i=e.noa.registry._opacityLookup,s=e.noa.registry._blockHandlerLookup,a=e.noa.registry._objectLookup,o=e.noa.registry._blockIsPlainLookup,c=e.noa._objectMesher,u=!0,l=!0,d=0;d<n;++d){var p=e._wholeLayerVoxel[d];if(p>=0&&!c[p]&&!s[p]){i[p]||(u=!1),p!==0&&(l=!1);continue}for(var m=t.get(0,d,0),f=0;f<n;++f)for(var v=t.index(f,d,0),h=0;h<n;++h,++v){var y=r[v];if(m>=0&&y!==m&&(m=-1),y===0){u=!1;continue}if(o[y]){l=!1;continue}u=u&&i[y],l=!1,a[y]&&(c.setObjectBlock(e,y,f,d,h),e._objectsDirty=!0);var g=s[y];g&&(e._blockHandlerLocs.add(f,d,h),xt(e,g,"onLoad",f,d,h))}m>=0&&(e._wholeLayerVoxel[d]=m)}e._isFull=u,e._isEmpty=l,e._terrainDirty=!e._isEmpty}he.prototype.dispose=function(){ai(this,"onUnload"),this._blockHandlerLocs.empty(),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels.data=null,this.voxels=null,this._neighbors.data=null,this._neighbors=null,this.isDisposed=!0};function ai(e,t){var r=e.voxels,n=e.noa.registry._blockHandlerLookup;e._blockHandlerLocs.arr.forEach(([i,s,a])=>{var o=r.get(i,s,a);xt(e,n[o],t,i,s,a)})}var pc=0,mc=0,gc={chunkSize:24,chunkAddDistance:[2,2],chunkRemoveDistance:[3,3],worldGenWhilePaused:!1,manuallyControlChunkLoading:!1};class V extends at.exports{constructor(t,r){super(),r=Object.assign({},gc,r),this.noa=t,this.playerChunkLoaded=!1,this.Chunk=he,this.manuallyControlChunkLoading=!!r.manuallyControlChunkLoading,this.chunkSortingDistFn=pr,this.minNeighborsToMesh=6,this.worldGenWhilePaused=!!r.worldGenWhilePaused,this.maxChunksPendingCreation=50,this.maxChunksPendingMeshing=50,this.maxProcessingPerTick=9,this.maxProcessingPerRender=5,this._chunkSize=r.chunkSize,this._chunkAddDistance=[2,2],this._chunkRemoveDistance=[3,3],this._addDistanceFn=null,this._remDistanceFn=null,this._prevWorldName="",this._prevPlayerChunkHash=0,this._chunkAddSearchFrom=0,this._prevSortingFn=null,this._chunksKnown=new ge,this._chunksToRequest=new ge,this._chunksInvalidated=new ge,this._chunksToRemove=new ge,this._chunksPending=new ge,this._chunksToMesh=new ge,this._chunksToMeshFirst=new ge,this._chunksSortedLocs=new ge,this.setAddRemoveDistance(r.chunkAddDistance,r.chunkRemoveDistance),this._storage=new Iu;var n=this._chunkSize;this._coordsToChunkIndexes=xc,this._coordsToChunkLocals=Fc;var i=(n&n-1)===0;i&&(this._coordShiftBits=Math.log2(n)|0,this._coordMask=n-1|0,this._coordsToChunkIndexes=Pc,this._coordsToChunkLocals=Ic)}}V.prototype.getBlockID=function(e=0,t=0,r=0){var[n,i,s]=this._coordsToChunkIndexes(e,t,r),a=this._storage.getChunkByIndexes(n,i,s);if(!a)return 0;var[o,c,u]=this._coordsToChunkLocals(e,t,r);return a.voxels.get(o,c,u)};V.prototype.getBlockSolidity=function(e=0,t=0,r=0){var[n,i,s]=this._coordsToChunkIndexes(e,t,r),a=this._storage.getChunkByIndexes(n,i,s);if(!a)return!1;var[o,c,u]=this._coordsToChunkLocals(e,t,r);return!!a.getSolidityAt(o,c,u)};V.prototype.getBlockOpacity=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockOpacity(n)};V.prototype.getBlockFluidity=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockFluidity(n)};V.prototype.getBlockProperties=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockProps(n)};V.prototype.setBlockID=function(e=0,t=0,r=0,n=0){var[i,s,a]=this._coordsToChunkIndexes(t,r,n),o=this._storage.getChunkByIndexes(i,s,a);if(!!o){var[c,u,l]=this._coordsToChunkLocals(t,r,n);return o.set(c,u,l,e,t,r,n)}};V.prototype.isBoxUnobstructed=function(e){for(var t=e.base,r=e.max,n=Math.floor(t[0]);n<r[0]+1;n++)for(var i=Math.floor(t[1]);i<r[1]+1;i++)for(var s=Math.floor(t[2]);s<r[2]+1;s++)if(this.getBlockSolidity(n,i,s))return!1;return!0};V.prototype.setChunkData=function(e,t,r=null,n=-1){Tc(this,e,t,r,n)};V.prototype.setAddRemoveDistance=function(e=2,t=3){var r=Array.isArray(e)?e:[e,e],n=Array.isArray(t)?t:[t,t],i=1;n[0]<r[0]+i&&(n[0]=r[0]+i),n[1]<r[1]+i&&(n[1]=r[1]+i),this._chunkAddDistance=r,this._chunkRemoveDistance=n,this._addDistanceFn=jr(r[0],r[1]),this._remDistanceFn=jr(n[0],n[1]),this._chunksSortedLocs.empty();for(var s=0;s<=r[0];s++)for(var a=0;a<=s;a++)for(var o=0;o<=r[1];o++)!this._addDistanceFn(s,o,a)||this._chunksSortedLocs.add(s,o,a);this._prevSortingFn=null,this._chunkAddSearchFrom=0};V.prototype.invalidateVoxelsInAABB=function(e){Mc(this,e)};V.prototype.manuallyLoadChunk=function(e=0,t=0,r=0){if(!this.manuallyControlChunkLoading)throw oi;var[n,i,s]=this._coordsToChunkIndexes(e,t,r);this._chunksKnown.add(n,i,s),this._chunksToRequest.add(n,i,s)};V.prototype.manuallyUnloadChunk=function(e=0,t=0,r=0){if(!this.manuallyControlChunkLoading)throw oi;var[n,i,s]=this._coordsToChunkIndexes(e,t,r);this._chunksToRemove.add(n,i,s),this._chunksToMesh.remove(n,i,s),this._chunksToRequest.remove(n,i,s),this._chunksToMeshFirst.remove(n,i,s)};var oi="Set `noa.world.manuallyControlChunkLoading` if you need this API";V.prototype.tick=function(){var e=performance.now(),[t,r,n]=ui(this),i=fe(t,r,n),s=i!==this._prevPlayerChunkHash;s&&(this.emit("playerEnteredChunk",t,r,n),this._prevPlayerChunkHash=i,this._chunkAddSearchFrom=0),this._prevWorldName!==this.noa.worldName&&(this.manuallyControlChunkLoading||(Cc(this),this._chunkAddSearchFrom=0,pt(this)),this._prevWorldName=this.noa.worldName),Ee("start"),je("start"),this.manuallyControlChunkLoading||(_c(this,t,r,n),Ee("remQueue"),yc(this,t,r,n),Ee("addQueue")),kc(this);var a=Math.max(1,this.maxProcessingPerTick||0),o=!1,c=!1,u=!1;ti(a,()=>(o||(o=wc(this)),Ee("requests"),c||(c=ci(this,!1)),Ee("meshes"),u||(u=pt(this)||pt(this)||pt(this),Ee("removes")),o&&c&&u),e);var l=this._storage.getChunkByIndexes(t,r,n);this.playerChunkLoaded=!!l,je("end",this),Ee("end")};V.prototype.render=function(){var e=this.maxProcessingPerRender;e>0&&ti(e,()=>ci(this,!0))};V.prototype._getChunkByCoords=function(e=0,t=0,r=0){var[n,i,s]=this._coordsToChunkIndexes(e,t,r);return this._storage.getChunkByIndexes(n,i,s)};V.prototype._queueChunkForRemesh=function(e){Dt(this,e)};function ui(e){var[t,r,n]=e.noa.entities.getPosition(e.noa.playerEntity);return e._coordsToChunkIndexes(t,r,n)}function yc(e,t,r,n){var i=e._chunksToRequest,s=i.count(),a=50;if(!(s>=a)){var o=e.chunkSortingDistFn||pr;o!==e._prevSortingFn&&(Ft(e,e._chunksSortedLocs,0,0,0,!0),e._prevSortingFn=o);for(var c=e._chunksSortedLocs.arr,u=e._chunkAddSearchFrom,l=Math.min(20,c.length/10),d=0;d<l;d++){var[p,m,f]=c[u++%c.length];if(Mt(e,t,r,n,p,m,f),i.count()>=a)break}e._chunksInvalidated.isEmpty()&&(e._chunkAddSearchFrom=u%c.length),Ft(e,i,t,r,n,!1)}}var Mt=(e,t,r,n,i,s,a)=>{Hr(e,t+i,r+s,n+a),i!==a&&Hr(e,t+a,r+s,n+i),i>0&&Mt(e,t,r,n,-i,s,a),s>0&&Mt(e,t,r,n,i,-s,a),a>0&&Mt(e,t,r,n,i,s,-a)},Hr=(e,t,r,n)=>{e._chunksKnown.includes(t,r,n)||(e._chunksKnown.add(t,r,n),e._chunksToRequest.add(t,r,n,!0))};function _c(e,t,r,n){var i=e._remDistanceFn,s=e._chunksToRemove,a=s.count()+e._chunksInvalidated.count(),o=50;if(!(a>=o)){var c=e._chunksKnown.arr;if(c.length!==0){for(var u=Math.min(100,c.length/10),l=!1,d=0;d<u;d++){var[p,m,f]=c[Qt++%c.length];if(!s.includes(p,m,f)&&!i(p-t,m-r,f-n)&&(e._chunksToRemove.add(p,m,f),e._chunksToRequest.remove(p,m,f),e._chunksToMesh.remove(p,m,f),e._chunksToMeshFirst.remove(p,m,f),l=!0,a++,a>o))break}Qt=Qt%c.length,l&&Ft(e,s,t,r,n)}}}var Qt=0;function kc(e){var t=10,r=e._chunksToMesh.count()+e._chunksToMeshFirst.count();if(!(r>t)){for(var n=e._chunksKnown.arr,i=Math.min(50,n.length/10),s=0;s<i;s++){var[a,o,c]=n[Vr++%n.length],u=e._storage.getChunkByIndexes(a,o,c);if(!!u){var l=Dt(e,u);if(l&&r++,r>t)break}}Vr%=n.length}}var Vr=0;function Mc(e,t){for(var r=e._coordsToChunkIndexes(t.base[0],t.base[1],t.base[2]),n=e._coordsToChunkIndexes(t.max[0],t.max[1],t.max[2]),i=0;i<3;i++)Number.isFinite(t.base[i])||(r[i]=t.base[i]),Number.isFinite(t.max[i])||(n[i]=t.max[i]);e._chunksKnown.forEach(s=>{var[a,o,c]=s;a<r[0]||a>=n[0]||o<r[1]||o>=n[1]||c<r[2]||c>=n[2]||(e._chunksInvalidated.add(a,o,c),e._chunksToRemove.remove(a,o,c),e._chunksToRequest.remove(a,o,c),e._chunksToMesh.remove(a,o,c),e._chunksToMeshFirst.remove(a,o,c))})}function Cc(e){e._chunksInvalidated.copyFrom(e._chunksKnown),e._chunksToRemove.empty(),e._chunksToRequest.empty(),e._chunksToMesh.empty(),e._chunksToMeshFirst.empty();var[t,r,n]=ui(e);Ft(e,e._chunksInvalidated,t,r,n)}function wc(e){var t=e._chunksToRequest;if(t.isEmpty())return!0;var r=e._chunksPending.count(),n=e._chunksToMesh.count();if(r>=e.maxChunksPendingCreation||n>=e.maxChunksPendingMeshing)return!0;var[i,s,a]=t.pop();return Lc(e,i,s,a),t.isEmpty()}function pt(e){var t=e._chunksInvalidated;if(t.isEmpty()&&(t=e._chunksToRemove),t.isEmpty())return!0;var[r,n,i]=t.pop();return Ec(e,r,n,i),t.isEmpty()}function ci(e,t){var r=e._chunksToMeshFirst;if(r.isEmpty()&&!t&&(r=e._chunksToMesh),r.isEmpty())return!0;var[n,i,s]=r.pop();if(!e._chunksToRemove.includes(n,i,s)){var a=e._storage.getChunkByIndexes(n,i,s);a&&bc(e,a)}}function Dt(e,t){if(!(t._terrainDirty||t._objectsDirty)||t._neighborCount<t.minNeighborsToMesh||e._chunksToMesh.includes(t.i,t.j,t.k)||e._chunksToMeshFirst.includes(t.i,t.j,t.k))return!1;var r=t._neighborCount===26?e._chunksToMeshFirst:e._chunksToMesh;return r.add(t.i,t.j,t.k),!0}function Lc(e,t,r,n){var i=e._chunkSize,s=he._createVoxelArray(e._chunkSize),a=e.noa.worldName,o=[t,r,n,a].join("|"),c=t*i,u=r*i,l=n*i;e._chunksPending.add(t,r,n),e.emit("worldDataNeeded",o,s,c,u,l,a),je("request")}function Tc(e,t,r,n,i){var s=t.split("|"),a=parseInt(s.shift()),o=parseInt(s.shift()),c=parseInt(s.shift()),u=s.join("|");if(e._chunksPending.remove(a,o,c),u===e.noa.worldName&&!!e._chunksKnown.includes(a,o,c)&&!e._chunksToRemove.includes(a,o,c)){var l=e._storage.getChunkByIndexes(a,o,c);if(l)l._updateVoxelArray(r,i);else{var d=e._chunkSize;l=new he(e.noa,t,a,o,c,d,r,i),e._storage.storeChunkByIndexes(a,o,c,l),l.userData=n,e.noa.rendering.prepareChunkForRendering(l),e.emit("chunkAdded",l)}Dt(e,l),li(e,a,o,c,l),je("receive")}}function Ec(e,t,r,n){var i=e._storage.getChunkByIndexes(t,r,n);i&&(e.emit("chunkBeingRemoved",i.requestID,i.voxels,i.userData),e.noa.rendering.disposeChunkForRendering(i),i.dispose(),je("dispose"),li(e,t,r,n,null)),e._storage.removeChunkByIndexes(t,r,n),e._chunksKnown.remove(t,r,n),e._chunksToMesh.remove(t,r,n),e._chunksToRemove.remove(t,r,n),e._chunksToMeshFirst.remove(t,r,n)}function bc(e,t){e._chunksToMesh.remove(t.i,t.j,t.k),e._chunksToMeshFirst.remove(t.i,t.j,t.k),t.updateMeshes(),je("mesh")}function xc(e,t,r){var n=this._chunkSize;return[Math.floor(e/n)|0,Math.floor(t/n)|0,Math.floor(r/n)|0]}function Fc(e,t,r){var n=this._chunkSize,i=e%n|0;i<0&&(i+=n);var s=t%n|0;s<0&&(s+=n);var a=r%n|0;return a<0&&(a+=n),[i,s,a]}function Pc(e,t,r){var n=this._coordShiftBits;return[e>>n|0,t>>n|0,r>>n|0]}function Ic(e,t,r){var n=this._coordMask;return[e&n|0,t&n|0,r&n|0]}function Ft(e,t,r,n,i,s=!1){var a=e.chunkSortingDistFn||pr,o=(c,u,l)=>a(r-c,n-u,i-l);t.sortByDistance(o,s)}var pr=(e,t,r)=>e*e+t*t+r*r;function li(e,t,r,n,i){for(var s=!i||i&&!i.isEmpty,a=-1;a<=1;a++)for(var o=-1;o<=1;o++)for(var c=-1;c<=1;c++)if((a|o|c)!==0){var u=e._storage.getChunkByIndexes(t+a,r+o,n+c);if(!!u){s&&(u._terrainDirty=!0),i&&!i._neighbors.get(a,o,c)&&(i._neighborCount++,i._neighbors.set(a,o,c,u));var l=u._neighbors.get(-a,-o,-c);i&&!l&&(u._neighborCount++,u._neighbors.set(-a,-o,-c,i),u._neighborCount===26&&Dt(e,u)),!i&&l&&(u._neighborCount--,u._neighbors.set(-a,-o,-c,null))}}}function jr(e,t){var r=e*e,n=t*t;return e===t?(i,s,a)=>i*i+s*s+a*a<=r:e>t?(i,s,a)=>Math.abs(s)>t?!1:i*i+s*s+a*a<=r:(i,s,a)=>{var o=i*i+a*a;return o>r?!1:o+s*s<=n}}V.prototype.report=function(){console.log("World report - playerChunkLoaded: ",this.playerChunkLoaded),Se(this,"  known:     ",this._chunksKnown.arr,!0),Se(this,"  to request:",this._chunksToRequest.arr,0),Se(this,"  to remove: ",this._chunksToRemove.arr,0),Se(this,"  invalid:   ",this._chunksInvalidated.arr,0),Se(this,"  creating:  ",this._chunksPending.arr,0),Se(this,"  to mesh:   ",this._chunksToMesh.arr.concat(this._chunksToMeshFirst.arr),0)};function Se(e,t,r,n){var i=0,s=0,a=0,o=0,c=[];r.forEach(m=>{var f=e._storage.getChunkByIndexes(m[0],m[1],m[2]);!f||(a++,c.push(f._timesMeshed),f._isFull&&i++,f._isEmpty&&s++,f._neighborCount===26&&o++)});var u=r.length.toString().padEnd(8);if(u+=("exist: "+a).padEnd(12),u+=("full: "+i).padEnd(12),u+=("empty: "+s).padEnd(12),u+=("surr: "+o).padEnd(12),n){var l=c.reduce((m,f)=>m+f,0),d=c.reduce((m,f)=>Math.max(m,f),0),p=c.reduce((m,f)=>Math.min(m,f),0);u+="times meshed: avg "+(l/a).toFixed(2),u+="  max "+d,u+="  min "+p}console.log(t,u)}var Ee=Ru(pc,"world ticks:",1),je=(e=>{if(!(e>0))return()=>{};var t=0,r={},n={},i=performance.now();return function(a,o){if(a!=="start"){if(a!=="end")return r[a]=(r[a]||0)+1;if(n.toreq=(n.toreq||0)+o._chunksToRequest.count(),n.toget=(n.toget||0)+o._chunksPending.count(),n.tomesh=(n.tomesh||0)+o._chunksToMesh.count()+o._chunksToMeshFirst.count(),n.tomesh1=(n.tomesh1||0)+o._chunksToMeshFirst.count(),n.torem=(n.torem||0)+o._chunksToRemove.count(),!(++t<e)){var c=performance.now(),u=c-i,l={};Object.keys(n).forEach(d=>{var p=Math.round((n[d]||0)/t);l[d]=`[${p}]`.padStart(5)}),Object.keys(r).forEach(d=>{var p=Math.round((r[d]||0)*1e3/u);l[d]=(""+p).padStart(3)}),console.log("chunk flow: ",`${l.toreq}-> ${l.request||0} req/s  `,`${l.toget}-> ${l.receive||0} got/s  `,`${l.tomesh}-> ${l.mesh||0} mesh/s  `,`${l.torem}-> ${l.dispose||0} rem/s  `,`(meshFirst: ${l.tomesh1.trim()})`),t=0,r={},n={},i=performance.now()}}}})(mc);const Ac="noa-engine",Rc="0.33.0",Oc="Experimental voxel game engine",Sc="src/index.js",Dc="dist/src/index.d.ts",Bc=["/src","/dist"],Uc={build:"npm run types; npm run docs",types:"tsc",docs:"typedoc"},$c="Andy Hall (https://fenomas.com)",zc="MIT",qc={type:"git",url:"https://github.com/fenomas/noa.git"},Nc={url:"https://github.com/fenomas/noa/issues"},Hc={"aabb-3d":"fenomas/aabb-3d","box-intersect":"fenomas/box-intersect","ent-comp":"^0.11.0",events:"^3.3.0","fast-voxel-raycast":"^0.1.1","game-inputs":"^0.7.0","gl-vec3":"^1.1.3","micro-game-shell":"^0.9.0",ndarray:"^1.0.19","voxel-aabb-sweep":"^0.5.0","voxel-physics-engine":"^0.13.0"},Vc={"@babylonjs/core":"^5.11.0"},jc={eslint:"^8.3.0","js-beautify":"^1.14.0",typedoc:"^0.22.15",typescript:"^4.6.4"},Gc=["voxel","voxels","game","engine","game-engine"],Kc={name:Ac,version:Rc,description:Oc,main:Sc,typings:Dc,files:Bc,scripts:Uc,author:$c,license:zc,repository:qc,bugs:Nc,dependencies:Hc,peerDependencies:Vc,devDependencies:jc,keywords:Gc};var Wc=Kc.version,Yc={debug:!1,silent:!1,silentBabylon:!1,playerHeight:1.8,playerWidth:.6,playerStart:[0,10,0],playerAutoStep:!1,tickRate:30,maxRenderRate:0,blockTestDistance:10,stickyPointerLock:!0,dragCameraOutsidePointerLock:!0,stickyFullscreen:!1,skipDefaultHighlighting:!1,originRebaseDistance:25};class tl extends at.exports.EventEmitter{constructor(t={}){if(super(),t=Object.assign({},Yc,t),this.version=Wc,!t.silent){var r=t.debug?" (debug)":"";console.log(`noa-engine v${this.version}${r}`)}this._paused=!1,this._originRebaseDistance=t.originRebaseDistance,this.worldOriginOffset=[0,0,0],this.positionInCurrentTick=0,this.worldName="default",this.timeScale=1,this.container=new za(this,t),this.tickRate=this.container._shell.tickRate,Object.defineProperty(this,"tickRate",{get:()=>this.container._shell.tickRate}),this.maxRenderRate=this.container._shell.maxRenderRate,Object.defineProperty(this,"maxRenderRate",{get:()=>this.container._shell.maxRenderRate,set:o=>{this.container._shell.maxRenderRate=o||0}}),this.inputs=new Aa(this,t,this.container.element),this.registry=new Yu(this,t),this.world=new V(this,t);var n=console.log;t.silentBabylon&&(console.log=()=>{}),this.rendering=new J(this,t,this.container.canvas),t.silentBabylon&&(console.log=n),this.physics=new dc(this,t),this.entities=new Pu(this,t),this.ents=this.entities;var i=this.entities;this.playerEntity=i.add(t.playerStart,t.playerWidth,t.playerHeight,null,null,!0,!0),i.addComponent(this.playerEntity,i.names.collideTerrain),i.addComponent(this.playerEntity,i.names.collideEntities);var s=i.getPhysics(this.playerEntity).body;if(s.gravityMultiplier=2,s.autoStep=t.playerAutoStep,i.addComponent(this.playerEntity,i.names.receivesInputs),i.addComponent(this.playerEntity,i.names.fadeOnZoom),i.addComponent(this.playerEntity,i.names.movement,{airJumps:1}),this.camera=new uo(this,t),this.blockTestDistance=t.blockTestDistance,this.blockTargetIdCheck=this.registry.getBlockSolidity,this.targetedBlock=null,t.skipDefaultHighlighting||(this.defaultBlockHighlightFunction=o=>{o?this.rendering.highlightBlockFace(!0,o.position,o.normal):this.rendering.highlightBlockFace(!1)},this.on("targetBlockChanged",this.defaultBlockHighlightFunction)),this._terrainMesher=new Nu(this),this._objectMesher=new Ou(this),this._targetedBlockDat={blockID:0,position:w.create(),normal:w.create(),adjacent:w.create()},this._prevTargetHash=0,this._pickPos=w.create(),this._pickResult={_localPosition:w.create(),position:[0,0,0],normal:[0,0,0]},t.debug){this.vec3=w,this.ndarray=nt,i.getMovement(1).airJumps=999;var a=window;a.noa=this,a.vec3=w,a.ndarray=nt,a.scene=this.rendering._scene}Qc(this)}tick(t){if(t*=this.timeScale||1,this._paused){this.world.worldGenWhilePaused&&this.world.tick();return}if(Zc(this),this.world.tick(),!this.world.playerChunkLoaded){this.rendering.tick(t);return}this.physics.tick(t),this._objectMesher.tick(),this.rendering.tick(t),Xc(this),this.entities.tick(t),this.emit("tick",t);var r=this.inputs.pointerState;r.scrollx=r.scrolly=r.scrollz=0}render(t,r){if(t*=this.timeScale||1,this.positionInCurrentTick=r,this._paused){this.world.worldGenWhilePaused&&this.world.render();return}this.camera.applyInputsToCamera(),this.world.render(),this.camera.updateBeforeEntityRenderSystems(),this.entities.render(t),this.camera.updateAfterEntityRenderSystems(),this.emit("beforeRender",t),this.rendering.render(),this.rendering.postRender(),this.emit("afterRender",t),this.inputs.pointerState.dx=this.inputs.pointerState.dy=0}setPaused(t=!1){this._paused=!!t,t||(this.inputs.pointerState.dx=this.inputs.pointerState.dy=0)}getBlock(t,r=0,n=0){return t.length?this.world.getBlockID(t[0],t[1],t[2]):this.world.getBlockID(t,r,n)}setBlock(t,r,n=0,i=0){return r.length?this.world.setBlockID(t,r[0],r[1],r[2]):this.world.setBlockID(t,r,n,i)}addBlock(t,r,n=0,i=0){return r.length?this.entities.isTerrainBlocked(r[0],r[1],r[2])?void 0:(this.world.setBlockID(t,r[0],r[1],r[2]),t):this.entities.isTerrainBlocked(r,n,i)?void 0:(this.world.setBlockID(t,r,n,i),t)}globalToLocal(t,r,n){var i=this.worldOriginOffset;if(r){for(var s=0;s<3;s++){var a=t[s]-i[s];a+=r[s],n[s]=a}return n}else return w.subtract(n,t,i)}localToGlobal(t,r,n=null){var i=this.worldOriginOffset;if(n){for(var s=0;s<3;s++){var a=Math.floor(t[s]);r[s]=a+i[s],n[s]=t[s]-a}return r}else return w.add(r,t,i)}pick(t=null,r=null,n=-1,i=null){if(n===0)return null;var s=this._pickPos;return t&&(this.globalToLocal(t,null,s),t=s),this._localPick(t,r,n,i)}_localPick(t=null,r=null,n=-1,i=null){if(n===0)return null;var s=i||this.registry.getBlockSolidity,a=this.world,o=this.worldOriginOffset,c=function(m,f,v){var h=a.getBlockID(m+o[0],f+o[1],v+o[2]);return s(h)};t||(t=this.camera._localGetTargetPosition()),r=r||this.camera.getDirection(),n=n||-1,n<0&&(n=this.blockTestDistance);var u=this._pickResult,l=u._localPosition,d=u.normal,p=ra(c,t,r,n,l,d);return p?(w.scaleAndAdd(l,l,d,.01),this.localToGlobal(l,u.position),u):null}}function Zc(e){var t=e.ents.getPositionData(e.playerEntity)._localPosition,r=e._originRebaseDistance;if(!(w.sqrLen(t)<r*r)){for(var n=[],i=0;i<3;i++)n[i]=Math.floor(t[i]),e.worldOriginOffset[i]+=n[i];e.rendering._rebaseOrigin(n),e.entities._rebaseOrigin(n),e._objectMesher._rebaseOrigin(n)}}function Xc(e){var t=0,r=e.blockTargetIdCheck||e.registry.getBlockSolidity,n=e._localPick(null,null,null,r);if(n){var i=e._targetedBlockDat;w.floor(i.adjacent,n.position),w.copy(i.normal,n.normal),w.subtract(i.position,i.adjacent,i.normal),i.blockID=e.world.getBlockID(i.position[0],i.position[1],i.position[2]),e.targetedBlock=i;var s=i.position,a=i.normal,o=fe(s[0]+i.blockID,s[1],s[2]);o^=fe(a[0],a[1]+i.blockID,a[2]),t=o}else e.targetedBlock=null;t!=e._prevTargetHash&&(e.emit("targetBlockChanged",e.targetedBlock),e._prevTargetHash=t)}function Qc(e){var t="0.27",r=(n,i,s)=>{var a=()=>{throw`This property changed in ${t} - ${s}`};Object.defineProperty(n,i,{get:a,set:a})};r(e,"getPlayerEyePosition","to get the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"setPlayerEyePosition","to set the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"getPlayerPosition","use `noa.ents.getPosition(noa.playerEntity)` or similar"),r(e,"getCameraVector","use `noa.camera.getDirection`"),r(e,"getPlayerMesh","use `noa.ents.getMeshData(noa.playerEntity).mesh` or similar"),r(e,"playerBody","use `noa.ents.getPhysicsBody(noa.playerEntity)`"),r(e.rendering,"zoomDistance","use `noa.camera.zoomDistance`"),r(e.rendering,"_currentZoom","use `noa.camera.currentZoom`"),r(e.rendering,"_cameraZoomSpeed","use `noa.camera.zoomSpeed`"),r(e.rendering,"getCameraVector","use `noa.camera.getDirection`"),r(e.rendering,"getCameraPosition","use `noa.camera.getLocalPosition`"),r(e.rendering,"getCameraRotation","use `noa.camera.heading` and `noa.camera.pitch`"),r(e.rendering,"setCameraRotation","to customize camera behavior see API docs for `noa.camera`"),t="0.28",r(e.rendering,"makeMeshInstance","removed, use Babylon's `mesh.createInstance`"),r(e.world,"_maxChunksPendingCreation",'use `maxChunksPendingCreation` (no "_")'),r(e.world,"_maxChunksPendingMeshing",'use `maxChunksPendingMeshing` (no "_")'),r(e.world,"_maxProcessingPerTick",'use `maxProcessingPerTick` (no "_")'),r(e.world,"_maxProcessingPerRender",'use `maxProcessingPerRender` (no "_")'),t="0.29",r(e,"_constants","removed, voxel IDs are no longer packed with bit flags"),t="0.30",r(e,"_tickRate","tickRate is now at `noa.tickRate`"),r(e.container,"_tickRate","tickRate is now at `noa.tickRate`"),t="0.31",r(e.world,"chunkSize","effectively an internal, so changed to `_chunkSize`"),r(e.world,"chunkAddDistance","set this with `noa.world.setAddRemoveDistance`"),r(e.world,"chunkRemoveDistance","set this with `noa.world.setAddRemoveDistance`")}export{tl as E};
